var MessageWidget=function(){function e(){h.paging=Config.Paging,a(),s(),t()}function s(){var e=f.GetInputParameters("message");$.isEmptyObject(e)||(h=f.UpdateSettings1(h,e),e.defaultCount&&(h.paging.itemsPerPage=e.defaultCount)),Config.Message=h}function t(){"messages"==Routing.route?f.BaseLoad.Login(!1,!1,!1,function(e){e.err?(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("login","Авторизация пользователя",{}),f.WidgetLoader(!0)):f.BaseLoad.Tmpl(h.tmpl,function(){n(),o()})}):f.WidgetLoader(!0)}function o(){f.WidgetLoader(!1);var e=Routing.params;e.block||(e.block="topic"),"topic"==e.block?(u(),f.currentPage=Routing.GetCurrentPage()):"list"==e.block&&e.id&&g(e.id)}function n(){f.BaseLoad.Script(PokupoWidgets.model.menu,function(){f.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){f.AddEvent("w.change.route",function(){t()}),f.AddEvent("Message.check.login",function(e){f.BaseLoad.UniqueUser("?username="+encodeURIComponent(e.dstUser()),function(s){e.dstUserError("on"!=s.check_username&&"off"!=s.check_username?h.error.username.notFound:"")})}),f.AddEvent("Message.search",function(e){u(e)}),f.AddEvent("Message.add",function(e){var s=e.modalForm();f.BaseLoad.UniqueUser("?username="+encodeURIComponent(s.dstUser()),function(t){"on"!=t.check_username&&"off"!=t.check_username?s.dstUserError(h.error.username.notFound):(s.dstUserError(""),f.BaseLoad.MessageAdd($("form#"+s.cssFormMessage),function(s){s.err?f.QueryError(s,function(){f.DispatchEvent("Message.add",e)}):u()}))})}),f.AddEvent("Message.read.topic",function(e){for(var s=0;s<=e.length-1;s++)f.BaseLoad.TopicRead(e[s].idTopic(),function(s){"ok"!=s.result?f.QueryError(s,function(){f.DispatchEvent("Message.read.topic",e)}):f.DispatchEvent("w.change.count.mess")})}),f.AddEvent("Message.delete.topic",function(e){for(var s=0;s<=e.length-1;s++)f.BaseLoad.TopicDelete(e[s].idTopic(),function(e){"ok"!=e.result?f.ShowMessage(h.message.error,function(){Routing.SetHash("messages","Сообщения",{})},!1):f.DispatchEvent("w.change.count.mess")})}),f.AddEvent("Message.delete.oneTopic",function(e){f.Confirm(h.message.confirmDeleteTopic,function(){f.BaseLoad.TopicDelete(e,function(e){"ok"!=e.result?f.ShowMessage(h.message.error,function(){},!1):(f.DispatchEvent("w.change.count.mess"),Routing.SetHash("messages","Сообщения",{}))})})}),f.AddEvent("Message.read.message",function(e,s){f.BaseLoad.MessageSetRead(e.id(),function(e){"ok"!=e.result?f.ShowMessage(h.message.error,function(){Routing.SetHash("messages",s.nameTopic(),{block:"list",id:s.topicId()})},!1):f.DispatchEvent("w.change.count.mess")})}),f.AddEvent("Message.unread.message",function(e,s){f.BaseLoad.MessageSetUnread(e.id(),function(e){"ok"!=e.result?f.ShowMessage(h.message.error,function(){Routing.SetHash("messages",s.nameTopic(),{block:"list",id:s.topicId()})},!1):f.DispatchEvent("w.change.count.mess")})}),f.AddEvent("Message.reply",function(e){f.BaseLoad.MessageAdd($("form#"+e.cssFormMessage),function(s){if(s.err)f.QueryError(s,function(){f.DispatchEvent("Message.reply",e)},function(){e.ClearForm()});else{var t=new MessageViewModel(s,e.topic,h);e.topic.messages.push(t),t.ClickExpand(),e.ClickCancel()}})}),f.AddEvent("Message.empty",function(){u()})}function i(){f.ClearContainer(h)}function r(){f.InsertContainer(h,"topic")}function c(){f.InsertContainer(h,"list")}function l(){f.InsertContainer(h,"empty")}function u(e){var s=(Routing.GetCurrentPage()-1)*h.paging.itemsPerPage,t=s+"/"+h.paging.itemsPerPage;e&&(t=t+"/"+encodeURIComponent(e)),f.BaseLoad.TopicList(t,function(s){TopicMessageViewModel.prototype=new Widget;var t=new TopicMessageViewModel(f,h);if(s.err){var o=h.message.noResult;s.msg&&(o=s.msg),t.SetErrorMessage(o),e&&t.searchMessage(e),l(),p(t)}else t.AddContent(s),e&&t.searchMessage(e),r(),d(t)})}function g(e){var s="unread";Routing.params.info&&(s=Routing.params.info),f.BaseLoad.TopicInfo(e,s,function(e){var s=new ListMessageViewModel(h);s.AddContent(e),c(),m(s)})}function d(e){f.RenderTemplate(e,h,null,function(e){r(),d(e)},function(){i()},"topic")}function m(e){f.RenderTemplate(e,h,function(){var s=e.messages(),t=[];$.each(s,function(e){s[e].IsNew()&&!s[e].IsMy()&&(s[e].ClickExpand(),t.push(s[e]))}),s.length==t.length&&($("."+s.cssExpandAll).hide(),$("."+s.cssCollapseAll).show());var o=0;$.each(t,function(e){setTimeout(function(){t[e].InitTimer()},o),o+=t[e].timeout})},function(e){c(),m(e)},function(){i()},"list")}function p(e){f.RenderTemplate(e,h,null,function(e){l(),p(e)},function(){i()},"empty")}var f=this;f.widgetName="MessageWidget",f.version=1,f.minWidgetVersion=1,f.maxWidgetVersion=2,f.minTmplVersion=1,f.maxTmplVersion=2,f.InitWidget=e;var h={container:{widget:"content",def:"defaultMessageWidgetId"},tmpl:{path:"messageTmpl.html",id:{topic:"messageTopicTmpl",list:"messageListTmpl",empty:"messageEmptyListTmpl"}},error:{username:{empty:"Поле обязательно для заполнения",notFound:"Получатель не найден."},topic:{empty:"Поле обязательно для заполнения"},text:{empty:"Поле обязательно для заполнения"}},message:{noResult:"Писем нет :(",messageDelete:"Сообщение удалено.",topicDelete:"Тема Удалена.",severalTopicDelete:"Выбранные темы успешно удалены.",confirmDeleteMessage:"Вы уверены, что хотите удалить сообщение?",confirmDeleteTopic:"Вы уверены, что хотите удалить тему?",confirmDeleteSeveralTopic:"Вы уверены, что хотите удалить выбранные темы?",error:"Ошибка выполнения."},timer:10,animate:"function"==typeof AnimateMessage?AnimateMessage:null,paging:null}},TopicMessageViewModel=function(e,s){function t(e,s){EventDispatcher.DispatchEvent(e,s)}var o=this;o.messageError=ko.observable(),o.messages=ko.observableArray(),o.paging=null,o.countAll=ko.observable(),o.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this),o.modalForm=ko.observable(new FormMessageViewModel(o,s)),o.cssSelectAll="messagesSelectAll",o.isSelectedAll=ko.observable(!1),o.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(o.messages(),function(s){$("#"+s.cssCheckboxMessage())[0].checked=e,s.isSelected(e)})}),o.searchMessage=ko.observable(),o.SetErrorMessage=function(e){o.messageError(e)},o.GetSelected=function(){var e=[];return ko.utils.arrayForEach(o.messages(),function(s){s.isSelected()&&e.push(s)}),e},o.ClickSearch=function(){t("Message.search",o.searchMessage())},o.ClickRead=function(){var e=o.GetSelected(),s=[];$.each(e,function(t){!e[t].IsMy()&&e[t].IsNew()&&(e[t].SetStatus("read"),s[t]=e[t]),e[t].isSelected(!1)}),s.length>0&&t("Message.read.topic",s)},o.ClickDelete=function(){o.Confirm(s.message.confirmDeleteSeveralTopic,function(){var e=o.GetSelected();$.each(e,function(s){o.messages.remove(e[s])}),EventDispatcher.DispatchEvent("Message.delete.topic",e),0==o.messages().length&&t("Message.empty")})},o.AddContent=function(e){var s=e.shift();o.countAll(s.count_topic),$.each(e,function(s){o.messages.push(o.NewTopic(e[s]))}),o.AddPages()},o.AddNewInContent=function(e){o.messages.unshift(o.NewTopic(e))},o.NewTopic=function(e){return TopicViewModel.prototype=new Widget,new TopicViewModel(e,o,s)},o.AddPages=function(){var e=function(){Loader.Indicator("Message",!1),Routing.UpdateHash({page:this.pageId})};o.paging=Paging.GetPaging(o.countAll(),s,e)},o.ClickSelectAll=function(){var e,s=$("#"+o.cssSelectAll),t=s.is(":checked");t?(s[0].checked=!1,e=!1):(s[0].checked=!0,e=!0),ko.utils.arrayForEach(o.messages(),function(s){$("#"+s.cssCheckboxMessage())[0].checked=e,s.isSelected(e)})}},TopicViewModel=function(e,s,t){var o=this;o.id=e.id,o.dateMessage=ko.observable(e.date_message),o.nameTopic=ko.observable(e.name_topic),o.idTopic=ko.observable(e.id_topic),o.srcUser=ko.observable(e.src_user),o.dstUser=ko.observable(e.dst_user),o.logoSrcUser=ko.observable(e.logo_src_user),o.logoDstUser=ko.observable(e.logo_dst_user),o.textMessage=ko.observable(e.text_message),o.status=ko.observable(e.status),o.countMessage=ko.observable(e.count_message),o.copyMail=ko.observable(e.copyMail),o.cssCheckboxMessage=ko.observable("message_item_"+o.id),o.isSelected=ko.observable(!1),o.isSelected.subscribe(function(e){for(var t=s.messages().length,n=[],a=0;t-1>=a;a++)s.messages()[a].isSelected()&&n.push(s.messages()[a].id);$("#"+s.cssSelectAll)[0].checked=n.length<t?!1:!0,$("#"+o.cssCheckboxMessage())[0].checked=e}),o.IsMy=ko.computed(function(){var e=Parameters.cache.userInformation;return e.login==o.srcUser()?!0:!1},this),o.IsNew=ko.computed(function(){return"send"!=o.status()||o.IsMy()?!1:!0},this),o.SetStatus=function(e){o.status(e)},o.ClickTopic=function(){Routing.SetHash("messages",o.nameTopic(),{block:"list",id:o.idTopic()})},o.ClickCheckboxMessage=function(e){var s=$("#"+e.cssCheckboxMessage()),t=s.is(":checked");0==t?(s[0].checked=!0,o.isSelected(!0)):(s[0].checked=!1,o.isSelected(!1))},o.ClickDelete=function(){o.Confirm(t.message.confirmDeleteSeveralTopic,function(){EventDispatcher.DispatchEvent("Message.delete.topic",[o]),s.messages.remove(o),0==s.messages().length&&EventDispatcher.DispatchEvent("Message.empty")})},o.FormatDateMessage=function(){var e=o.dateMessage().split(" "),s=e[0].split("-"),t=e[1].split(":"),n=new Date(s[2],s[1].replace(/^0+/,"")-1,s[0].replace(/^0+/,""),t[0].replace(/^0+/,""),t[1].replace(/^0+/,""),t[2].replace(/^0+/,"")),a=new Date,i=(a-n)/1e3/3600;return 24>i&&n.getDay()==a.getDay()?n.getHours()+":"+o.PadPithZeroes(n.getMinutes(),2):n.getDate()+" "+Config.Base.toStringMonth[n.getMonth()]},o.PadPithZeroes=function(e,s){for(var t=""+e;t.length<s;)t="0"+t;return t}},FormMessageViewModel=function(e,s){function t(){a.dstUser(""),a.dstUserError(""),a.topicName(""),a.topicNameError(""),a.text(""),a.textError(""),a.copyMail("")}function o(){return a.dstUser()?a.dstUserError():a.dstUserError(s.error.username.empty),a.topicNameError(a.topicName()?"":s.error.topic.empty),a.text()?a.textError():a.textError(s.error.text.empty),a.dstUserError()||a.topicNameError()||a.textError()?!1:!0}function n(e,s){EventDispatcher.DispatchEvent(e,s)}var a=this;a.dstUser=ko.observable(),a.dstUserError=ko.observable(),a.topicName=ko.observable(),a.topicNameError=ko.observable(),a.text=ko.observable(),a.textError=ko.observable(),a.copyMail=ko.observable(),a.cssFormMessage="simple_form_message",a.ClickSend=function(){o()&&n("Message.add",e)},a.ClickCancel=function(){t()},a.OnBlurEvent=function(){n("Message.check.login",a)}},SimpleFormMessageViewModel=function(e,s){function t(){return o.text()?o.textError():o.textError(s.error.text.empty),o.textError()?!1:!0}var o=this;o.text=ko.observable(),o.textError=ko.observable(),o.topic=e,o.copyMail=ko.observable(!1),o.cssFormMessage="simple_form_message",o.ClickSend=function(){t()&&EventDispatcher.DispatchEvent("Message.reply",o)},o.ClickCancel=function(){$("#"+o.cssFormMessage).hide(200),o.ClearForm()},o.ClearForm=function(){o.text(""),o.textError(""),o.copyMail(!1)}},ListMessageViewModel=function(e){var s=this;s.topicId=ko.observable(),s.nameTopic=ko.observable(),s.messages=ko.observableArray(),s.simpleForm=new SimpleFormMessageViewModel(s,e),s.cssExpandAll="expand",s.cssCollapseAll="collapse",s.AddContent=function(t){s.topicId(t.id_topic),s.nameTopic(t.name_topic),$.each(t.messages,function(o){s.messages.push(new MessageViewModel(t.messages[o],s,e))})},s.ClickBack=function(){Routing.SetHash("messages","Сообщения",{block:"topic",page:Routing.GetLastPageNumber()})},s.ClickDelete=function(){EventDispatcher.DispatchEvent("Message.delete.oneTopic",s.topicId())},s.ClickExpand=function(){var e=[],t=$("."+s.cssExpandAll),o=$("."+s.cssCollapseAll);t&&t.hide(),o&&o.show(),$.each(s.messages(),function(t){s.messages()[t].ClickExpand(),"send"!=s.messages()[t].status()||s.messages()[t].IsMy()||e.push(s.messages()[t])});var n=0;$.each(e,function(s){setTimeout(function(){e[s].InitTimer()},n),n+=e[s].timeout})},s.ClickCollapse=function(){$("."+s.cssExpandAll).show(),$("."+s.cssCollapseAll).hide(),$.each(s.messages(),function(e){s.messages()[e].ClickCollapse(),"send"!=s.messages()[e].status()||s.messages()[e].IsMy()||(s.messages()[e].stopTime=!0)})}},MessageViewModel=function(e,s,t){function o(){return setTimeout(function(){if(!i.stopTime){if(i.time=i.time+1,i.time>=i.timeout)return i.ClickRead(),!0;o()}},1e3),!1}function n(e,s){EventDispatcher.DispatchEvent(e,s)}function a(e){i.status(e)}var i=this;i.id=ko.observable(e.id),i.copyMail=ko.observable(e.copy_mail),i.dateMessage=ko.observable(e.date_message),i.dstUser=ko.observable(e.dst_user),i.logoDstUser=ko.observable(e.logo_dst_user),i.srcUser=ko.observable(e.src_user),i.logoSrcUser=ko.observable(e.logo_src_user),i.status=ko.observable(e.status),i.textMessage=ko.observable(e.text_message),i.time=0,i.timeout=e.text_message.length/250*t.timer,i.stopTime=!1,i.IsNew=ko.computed(function(){return"send"==i.status()?!0:!1},this),i.IsMy=ko.computed(function(){var e=Parameters.cache.userInformation;return e.login==i.srcUser()?!0:!1},this),i.cssPrevieClear="previe_message_"+i.id(),i.cssPrevie=ko.computed(function(){var e=i.cssPrevieClear;return i.IsNew()&&(e+=" new"),e},this),i.cssFull="full_message_"+i.id(),i.isExpand=ko.observable(!1),i.FormatDateMessage=function(){var e=i.dateMessage().split(" "),s=e[0].split("-"),t=e[1].split(":"),o=new Date(s[2],s[1].replace(/^0+/,"")-1,s[0].replace(/^0+/,""),t[0].replace(/^0+/,""),t[1].replace(/^0+/,""),t[2].replace(/^0+/,"")),n=new Date,a=(n-o)/1e3/3600;return 24>a&&o.getDay()==n.getDay()?o.getHours()+":"+i.PadPithZeroes(o.getMinutes(),2):o.getDate()+" "+Config.Base.toStringMonth[o.getMonth()]},i.PadPithZeroes=function(e,s){for(var t=""+e;t.length<s;)t="0"+t;return t},i.ClickReply=function(){var e=s.simpleForm.cssFormMessage;$("#"+e).show(200),$("#"+e)[0].scrollIntoView(250)},i.ClickRead=function(){i.IsMy()||(n("Message.read.message",i,s),a("read"))},i.ClickUnread=function(){n("Message.unread.message",i,s),a("send")},i.ClickExpand=function(){i.isExpand(!0),$("."+i.cssPrevieClear).hide(),$("."+i.cssFull).show(),"send"==i.status()&&(i.time=0,i.stopTime=!1,o())},i.ClickCollapse=function(){i.isExpand(!1),$("."+i.cssPrevieClear).show(),$("."+i.cssFull).hide(),i.stopTime=!0}},TestMessage={Init:function(){if("function"==typeof Widget){MessageWidget.prototype=new Widget;var e=new MessageWidget;e.Init(e)}else setTimeout(function(){TestMessage.Init()},100)}};TestMessage.Init();