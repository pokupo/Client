var MessageWidget=function(){var p=this;p.widgetName="MessageWidget";p.version=1;p.minWidgetVersion=1;p.maxWidgetVersion=2;p.minTmplVersion=1;p.maxTmplVersion=2;p.InitWidget=h;var d={container:{widget:"content",def:"defaultMessageWidgetId"},tmpl:{path:"messageTmpl.html",id:{topic:"messageTopicTmpl",list:"messageListTmpl",empty:"messageEmptyListTmpl"}},error:{username:{empty:"Поле обязательно для заполнения",notFound:"Получатель не найден."},topic:{empty:"Поле обязательно для заполнения"},text:{empty:"Поле обязательно для заполнения"}},message:{noResult:"Писем нет :(",messageDelete:"Сообщение удалено.",topicDelete:"Тема Удалена.",severalTopicDelete:"Выбранные темы успешно удалены.",confirmDeleteMessage:"Вы уверены, что хотите удалить сообщение?",confirmDeleteTopic:"Вы уверены, что хотите удалить тему?",confirmDeleteSeveralTopic:"Вы уверены, что хотите удалить выбранные темы?",error:"Ошибка выполнения."},timer:10,animate:typeof AnimateMessage=="function"?AnimateMessage:null,paging:null};function h(){d.paging=Config.Paging;m();c();p.CheckRouteMessage()}function c(){var q=p.GetInputParameters("message");if(!$.isEmptyObject(q)){d=p.UpdateSettings1(d,q);if(q.defaultCount){d.paging.itemsPerPage=q.defaultCount}}Config.Containers.message=d.container}p.CheckRouteMessage=function(){if(Routing.route=="messages"){p.BaseLoad.Login(false,false,false,function(q){if(!q.err){p.BaseLoad.Tmpl(d.tmpl,function(){e();l()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});p.WidgetLoader(true)}})}else{p.WidgetLoader(true)}};function l(){p.WidgetLoader(false);var q=Routing.params;if(!q.block){q.block="topic"}if(q.block=="topic"){g();p.currentPage=Routing.GetCurrentPage()}else{if(q.block=="list"&&q.id){a(q.id)}}}function e(){p.BaseLoad.Script(PokupoWidgets.model.menu,function(){p.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function m(){p.AddEvent("w.change.route",function(){p.CheckRouteMessage()});p.AddEvent("Message.check.login",function(q){p.BaseLoad.UniqueUser("?username="+encodeURIComponent(q.dstUser()),function(r){if(r.check_username!="on"&&r.check_username!="off"){q.dstUserError(d.error.username.notFound)}else{q.dstUserError("")}})});p.AddEvent("Message.search",function(q){g(q)});p.AddEvent("Message.add",function(q){var r=q.modalForm();p.BaseLoad.UniqueUser("?username="+encodeURIComponent(r.dstUser()),function(s){if(s.check_username!="on"&&s.check_username!="off"){r.dstUserError(d.error.username.notFound)}else{r.dstUserError("");p.BaseLoad.MessageAdd($("form#"+r.cssFormMessage),function(t){if(!t.err){g()}else{p.QueryError(t,function(){p.DispatchEvent("Message.add",q)})}})}})});p.AddEvent("Message.read.topic",function(r){for(var q=0;q<=r.length-1;q++){p.BaseLoad.TopicRead(r[q].idTopic(),function(s){if(s.result!="ok"){p.QueryError(s,function(){p.DispatchEvent("Message.read.topic",r)})}else{p.DispatchEvent("w.change.count.mess")}})}});p.AddEvent("Message.delete.topic",function(r){for(var q=0;q<=r.length-1;q++){p.BaseLoad.TopicDelete(r[q].idTopic(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages","Сообщения",{})},false)}else{p.DispatchEvent("w.change.count.mess")}})}});p.AddEvent("Message.delete.oneTopic",function(q){p.Confirm(d.message.confirmDeleteTopic,function(){p.BaseLoad.TopicDelete(q,function(r){if(r.result!="ok"){p.ShowMessage(d.message.error,function(){},false)}else{p.DispatchEvent("w.change.count.mess");Routing.SetHash("messages","Сообщения",{})}})})});p.AddEvent("Message.read.message",function(r,q){p.BaseLoad.MessageSetRead(r.id(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages",q.nameTopic(),{block:"list",id:q.topicId()})},false)}else{p.DispatchEvent("w.change.count.mess")}})});p.AddEvent("Message.unread.message",function(r,q){p.BaseLoad.MessageSetUnread(r.id(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages",q.nameTopic(),{block:"list",id:q.topicId()})},false)}else{p.DispatchEvent("w.change.count.mess")}})});p.AddEvent("Message.reply",function(q){p.BaseLoad.MessageAdd($("form#"+q.cssFormMessage),function(s){if(!s.err){var r=new MessageViewModel(s,q.topic,d);q.topic.messages.push(r);r.ClickExpand();q.ClickCancel()}else{p.QueryError(s,function(){p.DispatchEvent("Message.reply",q)},function(){q.ClearForm()})}})});p.AddEvent("Message.empty",function(){g()})}function b(){p.ClearContainer(d)}function f(){p.InsertContainer(d,"topic")}function j(){p.InsertContainer(d,"list")}function i(){p.InsertContainer(d,"empty")}function g(r){var s=(Routing.GetCurrentPage()-1)*d.paging.itemsPerPage;var q=s+"/"+d.paging.itemsPerPage;if(r){q=q+"/"+encodeURIComponent(r)}p.BaseLoad.TopicList(q,function(u){TopicMessageViewModel.prototype=new Widget();var t=new TopicMessageViewModel(p,d);if(!u.err){t.AddContent(u);if(r){t.searchMessage(r)}f();k(t)}else{var v=d.message.noResult;if(u.msg){v=u.msg}t.SetErrorMessage(v);if(r){t.searchMessage(r)}i();n(t)}})}function a(r){var q="unread";if(Routing.params.info){q=Routing.params.info}p.BaseLoad.TopicInfo(r,q,function(t){var s=new ListMessageViewModel(d);s.AddContent(t);j();o(s)})}function k(q){p.RenderTemplate(q,d,null,function(r){f();k(r)},function(){b()},"topic")}function o(q){p.RenderTemplate(q,d,function(){var s=q.messages();var r=[];$.each(s,function(u){if(s[u].IsNew()&&!s[u].IsMy()){s[u].ClickExpand();r.push(s[u])}});if(s.length==r.length){$("."+s.cssExpandAll).hide();$("."+s.cssCollapseAll).show()}var t=0;$.each(r,function(u){setTimeout(function(){r[u].InitTimer()},t);t=t+r[u].timeout})},function(r){j();o(r)},function(){b()},"list")}function n(q){p.RenderTemplate(q,d,null,function(r){i();n(r)},function(){b()},"empty")}};var TopicMessageViewModel=function(d,c){var a=this;a.messageError=ko.observable();a.messages=ko.observableArray();a.paging=null;a.countAll=ko.observable();a.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);a.modalForm=ko.observable(new FormMessageViewModel(a,c));a.cssSelectAll="messagesSelectAll";a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.messages(),function(f){$("#"+f.cssCheckboxMessage())[0].checked=e;f.isSelected(e)})});a.searchMessage=ko.observable();a.SetErrorMessage=function(e){a.messageError(e)};a.GetSelected=function(){var e=[];ko.utils.arrayForEach(a.messages(),function(f){if(f.isSelected()){e.push(f)}});return e};a.ClickSearch=function(){b("Message.search",a.searchMessage())};a.ClickRead=function(){var e=a.GetSelected();var f=[];$.each(e,function(g){if(!e[g].IsMy()&&e[g].IsNew()){e[g].SetStatus("read");f[g]=e[g]}e[g].isSelected(false)});if(f.length>0){b("Message.read.topic",f)}};a.ClickDelete=function(){a.Confirm(c.message.confirmDeleteSeveralTopic,function(){var e=a.GetSelected();$.each(e,function(f){a.messages.remove(e[f])});EventDispatcher.DispatchEvent("Message.delete.topic",e);if(a.messages().length==0){b("Message.empty")}})};a.AddContent=function(f){var e=f.shift();a.countAll(e.count_topic);$.each(f,function(g){a.messages.push(a.NewTopic(f[g]))});a.AddPages()};a.AddNewInContent=function(e){a.messages.unshift(a.NewTopic(e))};a.NewTopic=function(e){TopicViewModel.prototype=new Widget();return new TopicViewModel(e,a,c)};a.AddPages=function(){var e=function(){Loader.Indicator("Message",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countAll(),c,e)};a.ClickSelectAll=function(){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.messages(),function(h){$("#"+h.cssCheckboxMessage())[0].checked=g;h.isSelected(g)})};function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var TopicViewModel=function(d,c,b){var a=this;a.id=d.id;a.dateMessage=ko.observable(d.date_message);a.nameTopic=ko.observable(d.name_topic);a.idTopic=ko.observable(d.id_topic);a.srcUser=ko.observable(d.src_user);a.dstUser=ko.observable(d.dst_user);a.logoSrcUser=ko.observable(d.logo_src_user);a.logoDstUser=ko.observable(d.logo_dst_user);a.textMessage=ko.observable(d.text_message);a.status=ko.observable(d.status);a.countMessage=ko.observable(d.count_message);a.copyMail=ko.observable(d.copyMail);a.cssCheckboxMessage=ko.observable("message_item_"+a.id);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(e){var h=c.messages().length;var g=[];for(var f=0;f<=h-1;f++){if(c.messages()[f].isSelected()){g.push(c.messages()[f].id)}}if(g.length<h){$("#"+c.cssSelectAll)[0].checked=false}else{$("#"+c.cssSelectAll)[0].checked=true}$("#"+a.cssCheckboxMessage())[0].checked=e});a.IsMy=ko.computed(function(){var e=Parameters.cache.userInformation;if(e.login==a.srcUser()){return true}return false},this);a.IsNew=ko.computed(function(){if(a.status()=="send"&&!a.IsMy()){return true}return false},this);a.SetStatus=function(e){a.status(e)};a.ClickTopic=function(){Routing.SetHash("messages",a.nameTopic(),{block:"list",id:a.idTopic()})};a.ClickCheckboxMessage=function(g,f){var e=$("#"+g.cssCheckboxMessage());var h=e.is(":checked");if(h==false){e[0].checked=true;a.isSelected(true)}else{e[0].checked=false;a.isSelected(false)}};a.ClickDelete=function(){a.Confirm(b.message.confirmDeleteSeveralTopic,function(){EventDispatcher.DispatchEvent("Message.delete.topic",[a]);c.messages.remove(a);if(c.messages().length==0){EventDispatcher.DispatchEvent("Message.empty")}})};a.FormatDateMessage=function(){var j=a.dateMessage().split(" ");var e=j[0].split("-");var g=j[1].split(":");var f=new Date(e[2],e[1].replace(/^0+/,"")-1,e[0].replace(/^0+/,""),g[0].replace(/^0+/,""),g[1].replace(/^0+/,""),g[2].replace(/^0+/,""));var h=new Date();var i=(h-f)/1000/3600;if(i<24&&f.getDay()==h.getDay()){return f.getHours()+":"+a.PadPithZeroes(f.getMinutes(),2)}return f.getDate()+" "+Config.Base.toStringMonth[f.getMonth()]};a.PadPithZeroes=function(f,e){var g=""+f;while(g.length<e){g="0"+g}return g}};var FormMessageViewModel=function(c,d){var a=this;a.dstUser=ko.observable();a.dstUserError=ko.observable();a.topicName=ko.observable();a.topicNameError=ko.observable();a.text=ko.observable();a.textError=ko.observable();a.copyMail=ko.observable();a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(e()){b("Message.add",c)}};a.ClickCancel=function(){f()};a.OnBlurEvent=function(){b("Message.check.login",a)};function f(){a.dstUser("");a.dstUserError("");a.topicName("");a.topicNameError("");a.text("");a.textError("");a.copyMail("")}function e(){if(!a.dstUser()){a.dstUserError(d.error.username.empty)}else{a.dstUserError()}if(!a.topicName()){a.topicNameError(d.error.topic.empty)}else{a.topicNameError("")}if(!a.text()){a.textError(d.error.text.empty)}else{a.textError()}if(a.dstUserError()||a.topicNameError()||a.textError()){return false}return true}function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var SimpleFormMessageViewModel=function(c,b){var a=this;a.text=ko.observable();a.textError=ko.observable();a.topic=c;a.copyMail=ko.observable(false);a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(d()){EventDispatcher.DispatchEvent("Message.reply",a)}};a.ClickCancel=function(){$("#"+a.cssFormMessage).hide(200);a.ClearForm()};a.ClearForm=function(){a.text("");a.textError("");a.copyMail(false)};function d(){if(!a.text()){a.textError(b.error.text.empty)}else{a.textError()}if(a.textError()){return false}return true}};var ListMessageViewModel=function(b){var a=this;a.topicId=ko.observable();a.nameTopic=ko.observable();a.messages=ko.observableArray();a.simpleForm=new SimpleFormMessageViewModel(a,b);a.cssExpandAll="expand";a.cssCollapseAll="collapse";a.AddContent=function(c){a.topicId(c.id_topic);a.nameTopic(c.name_topic);$.each(c.messages,function(d){a.messages.push(new MessageViewModel(c.messages[d],a,b))})};a.ClickBack=function(){Routing.SetHash("messages","Сообщения",{block:"topic",page:Routing.GetLastPageNumber()})};a.ClickDelete=function(){EventDispatcher.DispatchEvent("Message.delete.oneTopic",a.topicId())};a.ClickExpand=function(){var c=[];var d=$("."+a.cssExpandAll),e=$("."+a.cssCollapseAll);if(d){d.hide()}if(e){e.show()}$.each(a.messages(),function(g){a.messages()[g].ClickExpand();if(a.messages()[g].status()=="send"&&!a.messages()[g].IsMy()){c.push(a.messages()[g])}});var f=0;$.each(c,function(g){setTimeout(function(){c[g].InitTimer()},f);f=f+c[g].timeout})};a.ClickCollapse=function(){$("."+a.cssExpandAll).show();$("."+a.cssCollapseAll).hide();$.each(a.messages(),function(c){a.messages()[c].ClickCollapse();if(a.messages()[c].status()=="send"&&!a.messages()[c].IsMy()){a.messages()[c].stopTime=true}})}};var MessageViewModel=function(f,d,e){var b=this;b.id=ko.observable(f.id);b.copyMail=ko.observable(f.copy_mail);b.dateMessage=ko.observable(f.date_message);b.dstUser=ko.observable(f.dst_user);b.logoDstUser=ko.observable(f.logo_dst_user);b.srcUser=ko.observable(f.src_user);b.logoSrcUser=ko.observable(f.logo_src_user);b.status=ko.observable(f.status);b.textMessage=ko.observable(f.text_message);b.time=0;b.timeout=f.text_message.length/250*e.timer;b.stopTime=false;b.IsNew=ko.computed(function(){if(b.status()=="send"){return true}return false},this);b.IsMy=ko.computed(function(){var h=Parameters.cache.userInformation;if(h.login==b.srcUser()){return true}return false},this);b.cssPrevieClear="previe_message_"+b.id();b.cssPrevie=ko.computed(function(){var h=b.cssPrevieClear;if(b.IsNew()){h=h+" new"}return h},this);b.cssFull="full_message_"+b.id();b.isExpand=ko.observable(false);b.FormatDateMessage=function(){var n=b.dateMessage().split(" ");var h=n[0].split("-");var j=n[1].split(":");var i=new Date(h[2],h[1].replace(/^0+/,"")-1,h[0].replace(/^0+/,""),j[0].replace(/^0+/,""),j[1].replace(/^0+/,""),j[2].replace(/^0+/,""));var k=new Date();var l=(k-i)/1000/3600;if(l<24&&i.getDay()==k.getDay()){return i.getHours()+":"+b.PadPithZeroes(i.getMinutes(),2)}return i.getDate()+" "+Config.Base.toStringMonth[i.getMonth()]};b.PadPithZeroes=function(i,h){var j=""+i;while(j.length<h){j="0"+j}return j};b.ClickReply=function(){var h=d.simpleForm.cssFormMessage;$("#"+h).show(200);$("#"+h)[0].scrollIntoView(250)};b.ClickRead=function(){if(!b.IsMy()){c("Message.read.message",b,d);a("read")}};b.ClickUnread=function(){c("Message.unread.message",b,d);a("send")};b.ClickExpand=function(){b.isExpand(true);$("."+b.cssPrevieClear).hide();$("."+b.cssFull).show();if(b.status()=="send"){b.time=0;b.stopTime=false;g()}};b.ClickCollapse=function(){b.isExpand(false);$("."+b.cssPrevieClear).show();$("."+b.cssFull).hide();b.stopTime=true};function g(){setTimeout(function(){if(!b.stopTime){b.time=b.time+1;if(b.time>=b.timeout){b.ClickRead();return true}else{g()}}},1000);return false}function c(h,i){EventDispatcher.DispatchEvent(h,i)}function a(h){b.status(h)}};var TestMessage={Init:function(){if(typeof Widget=="function"){MessageWidget.prototype=new Widget();var a=new MessageWidget();a.Init(a)}else{setTimeout(function(){TestMessage.Init()},100)}}};TestMessage.Init();