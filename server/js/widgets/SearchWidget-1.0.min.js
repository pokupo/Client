var SearchWidget=function(){var k=this;k.widgetName="SearchWidget";k.version=1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=h;var f={container:{widget:"searchWidgetId",def:"defaultSearchWidgetId"},showCatalog:true,tmpl:{path:"searchTmpl.html",id:"searchTmpl"},message:{empty:"Введите название товара для его поиска."},animate:typeof AnimateSearch=="function"?AnimateSearch:null};function h(){i();b();j()}function b(){var l=k.GetInputParameters("search");if(!$.isEmptyObject(l)){f=k.UpdateSettings1(f,l)}Config.Containers.search=f.container}function a(){k.ClearContainer(f)}function d(){k.InsertContainer(f)}function j(){if(Routing.IsDefault()&&k.HasDefaultContent()){k.WidgetLoader(true,f.container.widget)}else{c()}}function c(){k.BaseLoad.Tmpl(f.tmpl,function(){k.BaseLoad.Roots(function(){k.BaseLoad.Section(Routing.GetActiveCategory(),function(l){k.BaseLoad.Info(Routing.GetActiveCategory(),function(m){e(m)})})})})}function i(){k.AddEvent("Search.fill.categories",function(l){d();g(l)});k.AddEvent("w.change.route",function(l){j()})}function e(m){SearchViewModel.prototype=new Widget();var l=new SearchViewModel(f);l.AddListCategory(m)}function g(l){k.RenderTemplate(l,f,null,function(m){d();g(m)},function(){a()})}};var SearchCategoryItem=function(c,d,a){var b=this;b.id=c.id;b.title=Array(d).join(" - ")+c.name_category;b.typeCategory=c.type_category;b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchCategoryItemForTree=function(c,d,a){var b=this;b.id=c.id;b.title=c.name_category;b.typeCategory=c.type_category;b.children=ko.observableArray();b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){a.selectedCatigory(b.title);return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchViewModel=function(b){var a=this;a.text=ko.observable();if(Routing.route=="search"){a.text(Parameters.filter.keyWords)}a.cssSelectList="searchSelectList";a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.selectedCatigoriesId=ko.observable();if(Routing.route=="search"&&Parameters.filter.idSelectCategories&&Parameters.filter.idSelectCategories.length==1){a.selectedCatigoriesId(Parameters.filter.idSelectCategories[0])}a.selectedCatigory=ko.observable();a.idCategories=Parameters.filter.idCategories;a.typeCategories=[];a.cachData={};a.showCatalog=b.showCatalog;a.ClickAdvancedSearch=function(){a.DispatchEvent("SearchR.show.form")};a.AddListCategory=function(h){if(Parameters.cache.childrenCategory[h.id]){var l=Parameters.cache.childrenCategory[h.id];a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.childrenCategories=ko.observableArray();a.typeCategories=[];a.cachData=[{id:h.id,type_category:h.type_category,children:l}];a.typeCategories[h.id]=h.type_category;a.categories.push(new SearchCategoryItem(h,0,a));for(var g=0;g<=l.length-1;g++){a.categories.push(new SearchCategoryItem(l[g],1,a));a.typeCategories[l[g].id]=l[g].type_category;var k=new SearchCategoryItemForTree(l[g],g+1,a);var f=ko.observableArray();if(l[g].children){for(var e=0;e<=l[g].children.length-1;e++){a.categories.push(new SearchCategoryItem(l[g].children[e],2,a));a.typeCategories[l[g].id]=l[g].type_category;f.push(new SearchCategoryItemForTree(l[g].children[e],2,a))}k.children=f}a.childrenCategories.push(k)}var h=new SearchCategoryItemForTree(h,0,a);h.children=a.childrenCategories;a.categoriesTree.push(h)}a.DispatchEvent("Search.fill.categories",a)};a.SubmitSearchForm=function(f){a.idCategories=[];var e=a.selectedCatigoriesId(),g=$(f.text).val();if(g){if(a.typeCategories[e]!="category"){c(a.cachData,e)}else{a.idCategories.push(e)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[e];Parameters.filter.keyWords=g;if(a.idCategories.length==0){a.idCategories=[e]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);a.DispatchEvent("w.change.breadCrumb",e)}else{a.ShowMessage(b.message.empty,false,false)}};a.ClickSearchForm=function(){a.idCategories=[];var e=a.selectedCatigoriesId();var f=a.text();if(f){if(a.typeCategories[e]!="category"){c(a.cachData,e)}else{a.idCategories.push(e)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[e];Parameters.filter.keyWords=f;if(a.idCategories.length==0){a.idCategories=[e]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);a.DispatchEvent("w.change.breadCrumb",e)}else{a.ShowMessage(Config.Search.message.empty,false,false)}};function c(g,f){for(var e=0;e<=g.length-1;e++){if(g[e].id==f&&g[e].children){d(g[e].children);break}else{if(g[e].children){c(g[e].children,f)}}}}function d(f){for(var e=0;e<=f.length-1;e++){if(f[e].type_category=="category"){a.idCategories.push(f[e].id)}if(f[e].children){d(f[e].children)}}}};var TestSearch={Init:function(){if(typeof Widget=="function"){SearchWidget.prototype=new Widget();var a=new SearchWidget();a.Init(a)}else{setTimeout(function(){TestSearch.Init()},100)}}};TestSearch.Init();