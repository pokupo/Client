var CartWidget=function(){function t(){o(),a(),r()}function o(){var t=d.GetInputParameters("cart");if(!$.isEmptyObject(t)&&(l=d.UpdateSettings1(l,t),t.show))for(var o in t.show)l.showBlocks[o]=t.show[o];Config.Cart=l}function e(){d.ClearContainer(l)}function n(){d.InsertContainer(l)}function s(){Routing.IsDefault()&&d.HasDefaultContent()?d.WidgetLoader(!0):d.BaseLoad.CartInfo("",function(t){l.showBlocks.fullInfo?d.BaseLoad.CartGoods("",function(o){n(),i({info:t,goods:o})}):(n(),i({info:t}))})}function r(){d.BaseLoad.Tmpl(l.tmpl,function(){s()})}function a(){d.AddEvent("w.auth.ok",function(){r()}),d.AddEvent("w.change.route",function(){r()}),d.AddEvent("widgets.cart.infoUpdate",function(){r()}),d.AddEvent("widgets.cart.clear",function(t){var o=t.goodsId?t.goodsId:!1;d.BaseLoad.ClearCart(t.sellerId,o,function(){d.DispatchEvent("CartGoods.clear.cartInfo."+t.sellerId+"."+o)})}),d.AddEvent("Cart.change.count",function(t){d.BaseLoad.AddGoodsToCart(t.id,t.sellerId,t.ordered(),function(o){t.sellCost(o.sell_cost),t.sellEndCost(o.sell_end_cost),d.DispatchEvent("CartGoods.change.cartInfo."+t.sellerId+"."+t.id,t.ordered())})})}function i(t){var o=new CartViewModel(l);o.AddContent(t),c(o)}function c(t){d.RenderTemplate(t,l,null,function(t){n(),c(t)},function(){e()})}var d=this;d.widgetName="CartWidget",d.version=1,d.minWidgetVersion=1,d.maxWidgetVersion=2,d.minTmplVersion=1,d.maxTmplVersion=2,d.InitWidget=t;var l={container:{widget:"cartInfoWidgetId",def:"defaultCartInfoWidgetId"},cartId:"cart",tmpl:{path:"cartShopTmpl.html",id:"cartTmpl"},message:{title:"Корзина",cartGoodsTitle:"Моя корзина",maxIsReached:"Достигнут максимум"},showBlocks:{title:"always",count:!0,baseCost:!1,finalCost:!1,fullInfo:!1},animate:"function"==typeof AnimateCart?AnimateCart:null}},CartViewModel=function(t){var o=this;o.title=t.message.title,o.goods=ko.observableArray(),o.isAuthorized=ko.computed(function(){return Parameters.cache.userInformation&&!Parameters.cache.userInformation.err?!0:!1},this),o.ShowTitle=ko.computed(function(){return"never"==t.showBlocks.title?!1:"always"==t.showBlocks.title?!0:"empty"==t.showBlocks.title?!0:!1},this),o.count=ko.observable(0),o.ShowCount=ko.computed(function(){return t.showBlocks.count&&o.count()>0?!0:!1},this),o.baseCost=ko.observable(0),o.ShowBaseCost=ko.computed(function(){return t.showBlocks.baseCost&&o.baseCost()>0&&o.baseCost()>o.finalCost()?!0:!1},this),o.finalCost=ko.observable(0),o.ShowFinalCost=ko.computed(function(){return t.showBlocks.finalCost&&o.finalCost()>0?!0:!1},this),o.ShowFullInfo=ko.computed(function(){return t.showBlocks.fullInfo&&o.goods().length>0?!0:!1},this),o.AddContent=function(e){var n=e.info,s=e.goods;n.err||(o.count(n.count),o.baseCost(n.base_cost),o.finalCost(n.final_cost)),s&&!s.err&&(ShortBlockCartGoodsSellersViewModel.prototype=new Widget,$.each(s,function(e){$.each(s[e].goods,function(n){o.goods.push(new ShortBlockCartGoodsSellersViewModel(s[e].goods[n],s[e].seller.id,o,t))})}))},o.ClickCart=function(){o.count()>0&&(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("cart",t.message.cartGoodsTitle,{}))},o.ClickIssueOrder=function(){o.count()>0&&Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:o.sellerInfo.shop.id})}},ShortBlockCartGoodsSellersViewModel=function(t,o,e,n){function s(t,o){EventDispatcher.DispatchEvent(t,o)}var r=this;r.id=t.id,r.fullName=t.full_name,r.countReserv=t.count_reserv,r.count=t.count,r.sellCost=ko.observable(t.sell_cost),r.sellEndCost=ko.observable(t.sell_end_cost),r.routeImages=t.route_image,r.routeBigImages=t.route_big_image,r.ordered=ko.observable(r.count),r.sellerId=o,r.sum=ko.computed(function(){return(r.ordered()*r.sellCost()).toFixed(2)},this),r.endSum=ko.computed(function(){return(r.ordered()*r.sellEndCost()).toFixed(2)},this),r.CartItog=ko.computed(function(){var t=0;return $.each(e.goods(),function(o){t+=parseInt(e.goods()[o].endSum(),10)}),e.finalCost(t),t},this),r.ClickPlus=function(){r.ordered()<r.countReserv?(r.ordered(r.ordered()+1),r.CartItog(),e.count(e.count()+1),s("Cart.change.count",r)):r.ShowMessage(n.message.maxIsReached,!1,!1)},r.ClickMinus=function(){r.ordered()>0&&(r.ordered(r.ordered()-1),r.CartItog(),e.count(e.count()-1),s("Cart.change.count",r))},r.ClickGoods=function(){Routing.SetHash("goods",r.fullName,{id:r.id})},r.ClickRemove=function(){s("widgets.cart.clear",{goodsId:r.id,sellerId:o}),e.goods.remove(r),e.count(e.count()-r.ordered())}},TestCart={Init:function(){if("function"==typeof Widget){CartWidget.prototype=new Widget;var t=new CartWidget;t.Init(t)}else setTimeout(function(){TestCart.Init()},100)}};TestCart.Init();