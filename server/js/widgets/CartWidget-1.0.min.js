var CartWidget=function(){function o(){t(),i(),r()}function t(){var o=c.GetInputParameters("cart");if(!$.isEmptyObject(o)&&(l=c.UpdateSettings1(l,o),o.show))for(var t in o.show)l.showBlocks[t]=o.show[t];Config.Containers.cart=l.container}function e(){c.ClearContainer(l)}function n(){c.InsertContainer(l)}function s(){Routing.IsDefault()&&c.HasDefaultContent()?c.WidgetLoader(!0):c.BaseLoad.CartInfo("",function(o){l.showBlocks.fullInfo?c.BaseLoad.CartGoods("",function(t){n(),a({info:o,goods:t})}):(n(),a({info:o}))})}function r(){c.BaseLoad.Tmpl(l.tmpl,function(){s()})}function i(){c.AddEvent("w.auth.ok",function(){r()}),c.AddEvent("w.change.route",function(){r()}),c.AddEvent("widgets.cart.infoUpdate",function(){r()}),c.AddEvent("widgets.cart.clear",function(o){var t=o.goodsId?o.goodsId:!1;c.BaseLoad.ClearCart(o.sellerId,t,function(){c.DispatchEvent("CartGoods.clear.cartInfo."+o.sellerId+"."+t)})}),c.AddEvent("Cart.change.count",function(o){c.BaseLoad.AddGoodsToCart(o.id,o.sellerId,o.ordered(),function(t){o.sellCost(t.sell_cost),o.sellEndCost(t.sell_end_cost),c.DispatchEvent("CartGoods.change.cartInfo."+o.sellerId+"."+o.id,o.ordered())})})}function a(o){var t=new CartViewModel(l);t.AddContent(o),o.goods.hasOwnProperty("err")||$.each(o.goods,function(e){$.each(o.goods[e].goods,function(n){c.BaseLoad.GoodsInfo(o.goods[e].goods[n].id,1001e3,function(o){t.AddGoods(o)})})}),d(t)}function d(o){c.RenderTemplate(o,l,null,function(o){n(),d(o)},function(){e()})}var c=this;c.widgetName="CartWidget",c.version=1,c.minWidgetVersion=1,c.maxWidgetVersion=2,c.minTmplVersion=1,c.maxTmplVersion=2,c.InitWidget=o;var l={container:{widget:"cartInfoWidgetId",def:"defaultCartInfoWidgetId"},cartId:"cart",tmpl:{path:"cartShopTmpl.html",id:"cartTmpl"},message:{title:"Корзина",cartGoodsTitle:"Моя корзина",maxIsReached:"Достигнут максимум"},showBlocks:{title:"always",count:!0,baseCost:!1,finalCost:!1,fullInfo:!1},animate:"function"==typeof AnimateCart?AnimateCart:null}},CartViewModel=function(o){var t=this;t.title=o.message.title,t.goods=ko.observableArray(),t.isAuthorized=ko.computed(function(){return Parameters.cache.userInformation&&!Parameters.cache.userInformation.err?!0:!1},this),t.ShowTitle=ko.computed(function(){return"never"==o.showBlocks.title?!1:"always"==o.showBlocks.title?!0:"empty"==o.showBlocks.title?!0:!1},this),t.count=ko.observable(0),t.ShowCount=ko.computed(function(){return o.showBlocks.count&&t.count()>0?!0:!1},this),t.baseCost=ko.observable(0),t.ShowBaseCost=ko.computed(function(){return o.showBlocks.baseCost&&t.baseCost()>0&&t.baseCost()>t.finalCost()?!0:!1},this),t.finalCost=ko.observable(0),t.ShowFinalCost=ko.computed(function(){return o.showBlocks.finalCost&&t.finalCost()>0?!0:!1},this),t.ShowFullInfo=ko.computed(function(){return o.showBlocks.fullInfo&&t.goods().length>0?!0:!1},this),t.AddContent=function(o){var e=o.info;e.err||(t.count(e.count),t.baseCost(e.base_cost),t.finalCost(e.final_cost))},t.AddGoods=function(e){e&&!e.err&&(ShortBlockCartGoodsSellersViewModel.prototype=new Widget,t.goods.push(new ShortBlockCartGoodsSellersViewModel(e.main,e.seller.id,t,o)))},t.ClickCart=function(){t.count()>0&&(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("cart",o.message.cartGoodsTitle,{}))},t.ClickIssueOrder=function(){t.count()>0&&Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:t.sellerInfo.shop.id})}},ShortBlockCartGoodsSellersViewModel=function(o,t,e,n){function s(o,t){EventDispatcher.DispatchEvent(o,t)}var r=this;r.id=o.id,r.fullName=o.full_name,r.countReserv=o.count_reserv,r.count=o.count,r.sellCost=ko.observable(o.sell_cost),r.sellEndCost=ko.observable(o.sell_end_cost),r.routeImages=o.route_image,r.routeBigImages=o.route_big_image,r.ordered=ko.observable(r.count),r.sellerId=t,r.sum=ko.computed(function(){return(r.ordered()*r.sellCost()).toFixed(2)},this),r.endSum=ko.computed(function(){return(r.ordered()*r.sellEndCost()).toFixed(2)},this),r.isEgoods=ko.computed(function(){return"yes"==o.is_egoods?!0:!1},this),r.isEgoods()&&!r.count&&r.ordered(1),r.showSelectionCount=ko.computed(function(){return o.count&&0!=o.count?!0:!1},this),r.CartItog=ko.computed(function(){var o=0;return $.each(e.goods(),function(t){o+=parseInt(e.goods()[t].endSum(),10)}),e.finalCost(o),o},this),r.ClickPlus=function(){r.ordered()<r.countReserv?(r.ordered(r.ordered()+1),r.CartItog(),e.count(e.count()+1),s("Cart.change.count",r)):r.ShowMessage(n.message.maxIsReached,!1,!1)},r.ClickMinus=function(){r.ordered()>0&&(r.ordered(r.ordered()-1),r.CartItog(),e.count(e.count()-1),s("Cart.change.count",r))},r.ClickGoods=function(){Routing.SetHash("goods",r.fullName,{id:r.id})},r.ClickRemove=function(){s("widgets.cart.clear",{goodsId:r.id,sellerId:t}),e.goods.remove(r),e.count(e.count()-r.ordered())}},TestCart={Init:function(){if("function"==typeof Widget){CartWidget.prototype=new Widget;var o=new CartWidget;o.Init(o)}else setTimeout(function(){TestCart.Init()},100)}};TestCart.Init();