var CartWidget=function(){var k=this;k.widgetName="CartWidget";k.version=1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=f;var d={container:{widget:"cartInfoWidgetId",def:"defaultCartInfoWidgetId"},cartId:"cart",tmpl:{path:"cartShopTmpl.html",id:"cartTmpl"},message:{title:"Корзина",cartGoodsTitle:"Моя корзина",maxIsReached:"Достигнут максимум"},showBlocks:{title:"always",count:true,baseCost:false,finalCost:false,fullInfo:false},animate:typeof AnimateCart=="function"?AnimateCart:null};function f(){b();j();i()}function b(){var l=k.GetInputParameters("cart");if(!$.isEmptyObject(l)){d=k.UpdateSettings1(d,l);if(l.show){for(var m in l.show){d.showBlocks[m]=l.show[m]}}}Config.Containers.cart=d.container}function a(){k.ClearContainer(d)}function h(){k.InsertContainer(d)}function g(){if(Routing.IsDefault()&&k.HasDefaultContent()){k.WidgetLoader(true)}else{k.BaseLoad.CartInfo("",function(l){if(d.showBlocks.fullInfo){k.BaseLoad.CartGoods("",function(m){h();c({info:l,goods:m})})}else{h();c({info:l})}})}}function i(){k.BaseLoad.Tmpl(d.tmpl,function(){g()})}function j(){k.AddEvent("w.auth.ok",function(){i()});k.AddEvent("w.change.route",function(l){i()});k.AddEvent("widgets.cart.infoUpdate",function(l){i()});k.AddEvent("widgets.cart.clear",function(m){var l=m.goodsId?m.goodsId:false;k.BaseLoad.ClearCart(m.sellerId,l,function(){k.DispatchEvent("CartGoods.clear.cartInfo."+m.sellerId+"."+l)})});k.AddEvent("Cart.change.count",function(l){k.BaseLoad.AddGoodsToCart(l.id,l.sellerId,l.ordered(),function(m){l.sellCost(m.sell_cost);l.sellEndCost(m.sell_end_cost);k.DispatchEvent("CartGoods.change.cartInfo."+l.sellerId+"."+l.id,l.ordered())})})}function c(l){var m=new CartViewModel(d);m.AddContent(l);e(m)}function e(l){k.RenderTemplate(l,d,null,function(m){h();e(m)},function(){a()})}};var CartViewModel=function(b){var a=this;a.title=b.message.title;a.goods=ko.observableArray();a.isAuthorized=ko.computed(function(){if(Parameters.cache.userInformation&&!Parameters.cache.userInformation.err){return true}return false},this);a.ShowTitle=ko.computed(function(){if(b.showBlocks.title=="never"){return false}if(b.showBlocks.title=="always"){return true}if(b.showBlocks.title=="empty"){return true}return false},this);a.count=ko.observable(0);a.ShowCount=ko.computed(function(){if(b.showBlocks.count&&a.count()>0){return true}return false},this);a.baseCost=ko.observable(0);a.ShowBaseCost=ko.computed(function(){if(b.showBlocks.baseCost&&a.baseCost()>0&&a.baseCost()>a.finalCost()){return true}return false},this);a.finalCost=ko.observable(0);a.ShowFinalCost=ko.computed(function(){if(b.showBlocks.finalCost&&a.finalCost()>0){return true}return false},this);a.ShowFullInfo=ko.computed(function(){if(b.showBlocks.fullInfo&&a.goods().length>0){return true}return false},this);a.AddContent=function(d){var e=d.info;var c=d.goods;if(!e.err){a.count(e.count);a.baseCost(e.base_cost);a.finalCost(e.final_cost)}if(c&&!c.err){ShortBlockCartGoodsSellersViewModel.prototype=new Widget();$.each(c,function(f){$.each(c[f].goods,function(g){a.goods.push(new ShortBlockCartGoodsSellersViewModel(c[f].goods[g],c[f].seller.id,a,b))})})}};a.ClickCart=function(){if(a.count()>0){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("cart",b.message.cartGoodsTitle,{})}};a.ClickIssueOrder=function(){if(a.count()>0){Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}}};var ShortBlockCartGoodsSellersViewModel=function(e,c,f,d){var a=this;a.id=e.id;a.fullName=e.full_name;a.countReserv=e.count_reserv;a.count=e.count;a.sellCost=ko.observable(e.sell_cost);a.sellEndCost=ko.observable(e.sell_end_cost);a.routeImages=e.route_image;a.routeBigImages=e.route_big_image;a.ordered=ko.observable(a.count);a.sellerId=c;a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(e.is_egoods=="yes"){return true}return false},this);a.CartItog=ko.computed(function(){var g=0;$.each(f.goods(),function(h){g=g+parseInt(f.goods()[h].endSum(),10)});f.finalCost(g);return g},this);a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);a.CartItog();f.count(f.count()+1);b("Cart.change.count",a)}else{a.ShowMessage(d.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);a.CartItog();f.count(f.count()-1);b("Cart.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){b("widgets.cart.clear",{goodsId:a.id,sellerId:c});f.goods.remove(a);f.count(f.count()-a.ordered())};function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var TestCart={Init:function(){if(typeof Widget=="function"){CartWidget.prototype=new Widget();var a=new CartWidget();a.Init(a)}else{setTimeout(function(){TestCart.Init()},100)}}};TestCart.Init();