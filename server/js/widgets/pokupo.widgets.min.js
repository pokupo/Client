var ShopInfoWidget=function(){var i=this;i.widgetName="ShopInfoWidget";i.version=1;i.minWidgetVersion=1;i.maxWidgetVersion=2;i.minTmplVersion=1;i.maxTmplVersion=2;i.InitWidget=g;var d={container:{widget:"shopInfoWidgetId",def:"defaultShopInfoWidgetId"},defaultLogo:"//seller.pokupo.ru/images/logos/shop/1.png",show:{logo:true,title:true},tmpl:{path:"shopInfoTmpl.html",id:"shopInfoTmpl"},animate:typeof AnimateShopInfo=="function"?AnimateShopInfo:null};function g(){b();h();e()}function b(){var j=i.GetInputParameters("shopInfo");if(!$.isEmptyObject(j)){d=i.UpdateSettings1(d,j);if(j.show){if(j.show.hasOwnProperty("logo")){d.show.logo=j.show.logo}if(j.show.hasOwnProperty("title")){d.show.title=j.show.title}}}Config.Containers.shopInfo=d.container}function h(){i.AddEvent("w.change.route",function(j){e()})}function a(){i.ClearContainer(d)}function c(){i.InsertContainer(d)}function e(){i.BaseLoad.Tmpl(d.tmpl,function(){i.BaseLoad.ShopInfo(function(j){c();var k=new ShopInfoViewModel(j,d);f(k)})})}function f(j){i.RenderTemplate(j,d,null,function(k){c();f(k)},function(){a()})}};var ShopInfoViewModel=function(c,b){var a=this;a.logo=b.defaultLogo;if(c.id_logo_shop){a.logo=c.id_logo_shop}a.name=c.name_shop;a.link=c.site_shop;a.showLogo=b.show.logo;a.showTitle=b.show.title};var TestShopInfo={Init:function(){if(typeof Widget=="function"){ShopInfoWidget.prototype=new Widget();var a=new ShopInfoWidget();a.Init(a)}else{setTimeout(function(){TestShopInfo.Init()},100)}}};TestShopInfo.Init();
var AuthenticationWidget=function(){var k=this;k.widgetName="AuthenticationWidget";k.version=1.1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=i;var g={container:{widget:"authenticationWidgetId",def:"defaultAuthenticationWidgetId"},animate:typeof AnimateAuthentication=="function"?AnimateAuthentication:null,https:"login",tmpl:{path:"authenticationTmpl.html",id:"authenticationFormTmpl"},message:{pleaseLogIn:"Необходимо авторизоваться.",confirmLogOut:"Вы действительно хотите выйти?"}};function i(){b();j();d()}function b(){var l=k.GetInputParameters("authentication");if(!$.isEmptyObject(l)){g=k.UpdateSettings1(g,l);if(l.https){Parameters.cache.https=l.https}}Config.Containers.authentication=g.container}function d(){if(Routing.route=="login"){k.BaseLoad.Tmpl(g.tmpl,function(){c()})}else{k.WidgetLoader(true)}}function j(){k.AddEvent("w.change.route",function(){d()});k.AddEvent("AuthW.submit",function(l){k.BaseLoad.Login(l.username,l.password,l.rememberMe,function(m){k.DispatchEvent("w.auth.test",{data:l,request:m})})});k.AddEvent("w.auth.test",function(l){if(l.request.err){l.data.error="Ошибка в логине или пароле";h(l.data)}else{k.DispatchEvent("w.auth.ok",l)}});k.AddEvent("w.auth.ok",function(){if(Routing.route!="registration"){var l=Parameters.cache.lastPage;if(l.route=="login"||!l.route){Routing.SetHash("default","Домашняя",{})}else{Routing.SetHash(l.route,l.title,l.data)}}});k.AddEvent("w.auth.close",function(){a()})}function c(){if(Routing.route=="login"){e();f()}}function a(){k.ClearContainer(g)}function e(){k.InsertContainer(g)}function f(){k.BaseLoad.Script(PokupoWidgets.model.auth,function(){AuthenticationViewModel.prototype.ClickRegistration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-2];Routing.SetHash("registration","Регистрация пользователя",{step:1})};var l=new AuthenticationViewModel();l.subminEvent("AuthW.submit");h(l)})}function h(l){k.RenderTemplate(l,g,null,function(m){e();h(m)},function(){a()})}};var TestAuthentication={Init:function(){if(typeof Widget=="function"){AuthenticationWidget.prototype=new Widget();var a=new AuthenticationWidget();a.Init(a)}else{setTimeout(function(){TestAuthentication.Init()},100)}}};TestAuthentication.Init();
var RegistrationWidget=function(){var p=this;p.widgetName="RegistrationWidget";p.version=1;p.minWidgetVersion=1;p.maxWidgetVersion=2;p.minTmplVersion=1;p.maxTmplVersion=2;p.InitWidget=c;var z={container:{widget:"content",def:"defaultRegistrationWidgetId"},tmpl:{path:"registrationTmpl.html",id:{step1:"registrationFromStep1Tmpl",step2:"registrationFromStep2Tmpl",step3:"registrationFromStep3Tmpl",step4:"registrationFromStep4Tmpl"}},regular:{username:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,gender:/^[mw]$/,postIndex:/^[0-9]+$/},message:{registrationSuccessful:"Вы успешно зарегистрировались в магазине"},error:{username:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},phone:{regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},isChecked:{empty:"Вам необходимо прочитать и принять условия соглашения"},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},confirmLater:{empty:"Для активации аккаунта требуется подтвердить хотя бы один из способов связи"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},gender:{empty:"Поле обязательно для заполнения"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"}},animate:typeof AnimateRegistration=="function"?AnimateRegistration:null,geoShop:0},q="registration",D="Регистрация пользователя";function c(){B();f();r()}function B(){var E=p.GetInputParameters(q);if(!$.isEmptyObject(E)){z=p.UpdateSettings1(z,E)}Config.Containers.registration=z.container}function r(){if(Routing.route==q){var E=Routing.params;p.BaseLoad.Tmpl(z.tmpl,function(){p.BaseLoad.Script(PokupoWidgets.model.registration,function(){if(E.step==1){o();y()}if(E.step==2){m();x()}if(E.step==3){k();w()}if(E.step==4){h();t()}})})}else{p.WidgetLoader(true)}}function f(){p.AddEvent("w.change.route",function(){r()});p.AddEvent("RegistrationWidget.step1.checking",function(E){p.WidgetLoader(false);var G=[];if(E.username()){G.push("username="+encodeURIComponent(E.username()))}if(E.phone()){G.push("phone="+E.phone().replace(/\s/g,""))}if(E.email()){G.push("email="+E.email())}if(G.length>0){var F="?"+G.join("&")}p.BaseLoad.UniqueUser(F,function(H){var K=true;if(p.QueryError(H,function(){p.DispatchEvent("RegistrationWidget.step1.checking",E)})){if(!d(H,E)){K=false}if(!C(H,E)){K=false}if(!s(H,E)){K=false}}else{K=false}if(K){var J=[];if(E.username()){J.push("username="+encodeURIComponent(E.username()))}if(E.phone()){J.push("phone="+E.phone().replace(/\s/g,""))}if(E.email()){J.push("email="+$.trim(E.email()))}if(E.firstPassword()){J.push("password="+encodeURIComponent(E.firstPassword()))}if(J.length>0){var I="?"+J.join("&")}p.BaseLoad.Registration(I,function(L){p.BaseLoad.LoginForProxy(E.username(),E.firstPassword(),"no",function(M){Parameters.cache.reg.step1=E;A(q,D,{step:2})})})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step1.view",function(){A(q,D,{step:1})});p.AddEvent("RegistrationWidget.step2.checking",function(E){p.WidgetLoader(false);var G=[];G.push("username="+encodeURIComponent(E.username));if(!E.mailConfirmLater()){G.push("mail_token="+E.mailToken())}if(!E.phoneConfirmLater()){G.push("sms_token="+E.phoneToken())}var F="?"+G.join("&");p.BaseLoad.ActivateUser(F,function(H){var I=true;if(p.QueryError(H,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",E)})){if(!i(H,E)){I=false}if(!u(H,E)){I=false}}else{I=false}if(I){Parameters.cache.reg.step2=E;p.BaseLoad.Login(false,false,false,function(J){p.DispatchEvent("w.auth.ok",{request:J});if(!J.err){A(q,D,{step:3})}})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step2.view",function(){A(q,D,{step:2})});p.AddEvent("RegistrationWidget.step3.later",function(){A(q,D,{step:4})});p.AddEvent("RegistrationWidget.step3.checking",function(E){p.WidgetLoader(false);var G=E.birthDay().split(".");var F=G[2]+"-"+G[1]+"-"+G[0];E.birthDayHiddenField(F);p.BaseLoad.EditProfile($("form#"+E.cssRegistrationDataForm),function(H){var I=true;if(!p.QueryError(H,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.checking",E)})){I=false}if(I){Parameters.cache.reg.step3=E;A(q,D,{step:4})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step3.view",function(){A(q,D,{step:3})});p.AddEvent("RegistrationWidget.step4.later",function(E){p.ShowMessage(z.message.registrationSuccessful,function(){Parameters.cache.reg={step1:{},step2:{},step3:{},step4:{}};var F=Parameters.cache.lastPage;if(!$.isEmptyObject(F)){A(F.route,F.title,F.data,true)}else{A("default","Домашняя",{})}})});p.AddEvent("RegistrationWidget.step4.checking",function(F){p.WidgetLoader(false);var E="?id_country="+encodeURIComponent($.trim(F.idCountry()));if(F.region()&&F.region().regioncode){E=E+"&code_region="+encodeURIComponent($.trim(F.region().regioncode))}else{E=E+"&name_region="+encodeURIComponent($.trim(F.customRegion()))}if(F.city()&&F.city().aoguid){E=E+"&code_city="+encodeURIComponent($.trim(F.city().aoguid))}else{E=E+"&name_city="+encodeURIComponent($.trim(F.customCity()))}E=E+"&address="+encodeURIComponent($.trim(F.customAddress()))+"&post_code="+encodeURIComponent($.trim(F.postIndex()));p.BaseLoad.EditAddress(E,function(G){var H=true;if(!p.QueryError(G,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",F)})){H=false}if(H){Parameters.cache.reg.step4=F;EventDispatcher.DispatchEvent("RegistrationWidget.step4.later")}else{p.WidgetLoader(true,z.container.widget)}})})}function d(F,E){var G=false;if(F.check_username){if(F.check_username=="on"||F.check_username=="ban"||F.check_username=="off"){E.errorUsername(z.error.username.uniq)}if(F.check_username=="yes"){G=true}}return G}function s(F,E){var G=false;if(F.check_phone){if(F.check_phone=="on"||F.check_phone=="ban"||F.check_phone=="off"){E.errorPhone(z.error.phone.uniq)}if(F.check_phone=="yes"){G=true}}else{G=true}return G}function C(F,E){var G=false;if(F.check_email){if(F.check_email=="on"||F.check_email=="ban"||F.check_email=="off"){E.errorEmail(z.error.email.uniq)}if(F.check_email=="yes"){G=true}}return G}function i(F,E){if(F.confirm_email){if(F.confirm_email=="no"){E.errorEmailConfirm(z.error.emailToken.confirm);return false}}return true}function u(F,E){if(F.confirm_phone){if(F.confirm_phone=="no"){E.errorPhoneConfirm(z.error.phoneToken.confirm);return false}}return true}function b(F,E){if(F.err){E.errorAddress(F.err);return false}return true}function e(E,F){if(E.err){F.errorAddress(E.err);return false}return true}function v(){p.ClearContainer(z)}function o(){p.InsertContainer(z,"step1")}function m(){p.InsertContainer(z,"step2")}function k(){p.InsertContainer(z,"step3")}function h(){p.InsertContainer(z,"step4")}function y(){var E=Parameters.cache.reg.step1;if($.isEmptyObject(E)){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var F=Parameters.cache.history.pop();if(F){A(F.route,F.title,F.data,true)}else{A("default","Домашняя",{})}};E=new RegistrationFormViewModel(z);E.submitEvent("RegistrationWidget.step1.checking")}n(E)}function x(){var G=Routing.params;if(G.username&&G.mail_token){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var H=Parameters.cache.history.pop();if(H){A(H.route,H.title,H.data,true)}else{A("default","Домашняя",{})}};var E=new RegistrationFormViewModel(z);E.username(G.username);E.submitEvent("RegistrationWidget.step1.checking");Parameters.cache.reg.step1=E}RegistrationConfirmFormViewModel.prototype.Back=function(){p.DispatchEvent("RegistrationWidget.step1.view")};var F=new RegistrationConfirmFormViewModel(Parameters.cache.reg.step1,z);F.submitEvent("RegistrationWidget.step2.checking");if(G.username&&G.mail_token){F.mailToken(G.mail_token);p.DispatchEvent("RegistrationWidget.step2.checking",F)}l(F)}function w(){var E=Parameters.cache.reg.step3;if($.isEmptyObject(E)){RegistrationProfileFormViewModel.prototype.Back=function(){p.DispatchEvent("RegistrationWidget.step2.view")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){p.DispatchEvent("RegistrationWidget.step3.later")};E=new RegistrationProfileFormViewModel(z);E.submitEvent("RegistrationWidget.step3.checking")}j(E)}function t(){var E=Parameters.shopId;if(z.geoShop==0){E=0}p.BaseLoad.Country(E,function(G){var F=new RegistrationFormStep4ViewModel(z);F.AddCountryList(G);g(F)})}function n(E){p.RenderTemplate(E,z,null,function(F){o();n(F)},function(){v()},"step1")}function l(E){p.RenderTemplate(E,z,null,function(F){m();l(F)},function(){v()},"step2")}function j(E){p.RenderTemplate(E,z,null,function(F){k();j(F)},function(){v()},"step3")}function g(E){p.RenderTemplate(E,z,function(F){a(F)},function(F){h();g(F)},function(){v()},"step4")}function a(E){$("#"+E.cssRegionList).autocomplete({source:function(G,F){p.BaseLoad.Region(E.idCountry()+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.formalname+" "+I.shortname),region:I}}))}else{$("#"+E.cssRegionList).autocomplete("close");return false}})},select:function(F,G){E.region(G.item.region);E.customRegion(G.item.value);if(G.item.region&&G.item.region.postalcode!=0){E.postIndex(G.item.region.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssCityList).autocomplete({source:function(G,F){if(E.region()){p.BaseLoad.City(E.idCountry()+"/"+encodeURIComponent(E.region().regioncode)+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.shortname+". "+I.formalname),city:I}}))}else{$("#"+E.cssCityList).autocomplete("close");return false}})}},select:function(F,G){E.city(G.item.city);E.customCity(G.item.value);if(G.item.city&&G.item.city.postalcode!=0){E.postIndex(G.item.city.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssAddress).autocomplete({source:function(G,F){if(E.region()){p.BaseLoad.Street(E.idCountry()+"/"+encodeURIComponent(E.region().regioncode)+"/"+encodeURIComponent(E.city().aoguid)+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.shortname+". "+I.formalname),street:I}}))}else{$("#"+E.cssAddress).autocomplete("close");return false}})}},select:function(F,G){E.address(G.item.street);E.customAddress(G.item.value);if(G.item.street&&G.item.street.postalcode!=0){E.postIndex(G.item.street.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssCountryList).change(function(){if(E.idCountry()){E.errorCountry("");E.errorRegion("");E.errorCity("");E.errorAddress("");E.errorPostIndex("")}$.grep(E.countryList(),function(F){if(F.id==E.idCountry()){E.customRegion(null);E.region(null);E.customCity(null);E.city(null);E.customAddress(null);E.address(null);E.postIndex(null)}})});$("#"+E.cssRegionList).bind("textchange",function(G,F){E.errorRegion("");E.errorCity("");E.errorAddress("");E.errorPostIndex("");E.customRegion($(this).val());E.customCity(null);E.city(null);E.customAddress(null);E.address(null);E.postIndex(null)});$("#"+E.cssCityList).bind("textchange",function(G,F){E.errorCity("");E.errorAddress("");E.errorPostIndex("");E.customCity($(this).val());E.customAddress(null);E.address(null);E.postIndex(null)});$("#"+E.cssAddress).bind("textchange",function(G,F){E.errorAddress("");E.errorPostIndex("")});$("#"+E.cssPostIndex).bind("textchange",function(G,F){E.errorPostIndex("")})}function A(E,G,F){Routing.SetHash(E,G,F)}};var RegistrationFormStep4ViewModel=function(e){var i=this;i.idCountry=ko.observable();i.cssCountryList="country_list";i.errorCountry=ko.observable(null);i.region=ko.observable();i.customRegion=ko.observable();i.cssRegionList="region_list";i.errorRegion=ko.observable(null);i.showRegion=ko.computed(function(){if(i.idCountry()){return false}return true},this);i.city=ko.observable();i.customCity=ko.observable();i.cssCityList="city_list";i.errorCity=ko.observable(null);i.showCity=ko.computed(function(){if(i.customRegion()){return false}return true},this);i.address=ko.observable();i.customAddress=ko.observable();i.cssAddress="address";i.errorAddress=ko.observable(null);i.showAddress=ko.computed(function(){if(i.customCity()){return false}return true},this);i.postIndex=ko.observable();i.cssPostIndex="post_index";i.errorPostIndex=ko.observable(null);i.showPostIndex=ko.computed(function(){if(i.customAddress()){return false}return true},this);i.countryList=ko.observableArray();i.AddCountryList=function(k){if(k.length>0){for(var j=0;j<=k.length-1;j++){i.countryList.push(new CountryListViewModel(k[j]))}}};i.SpecifyLater=function(){h("RegistrationWidget.step4.later",i)};i.SubmitForm=function(){if(d()){h("RegistrationWidget.step4.checking",i)}};i.Back=function(){h("RegistrationWidget.step3.view")};function h(j,k){EventDispatcher.DispatchEvent(j,k)}function d(){var j=true;if(!g()){j=false}if(!c()){j=false}if(!b()){j=false}if(!f()){j=false}if(!a()){j=false}return j}function g(){if(!i.idCountry()){i.errorCountry(e.error.country.empty);return false}i.errorCountry(null);return true}function c(){if(!i.customRegion()){i.errorRegion(e.error.region.empty);return false}i.errorRegion(null);return true}function b(){if(!i.customCity()){i.errorCity(e.error.city.empty);return false}i.errorCity(null);return true}function f(){if(!i.customAddress()){i.errorAddress(e.error.address.empty);return false}i.errorAddress(null);return true}function a(){var j=e.error.postIndex;if(!i.postIndex()){i.errorPostIndex(j.empty);return false}if(5>i.postIndex().length||i.postIndex().length>6){i.errorPostIndex(j.length);return false}if(!e.regular.postIndex.test(i.postIndex())){i.errorPostIndex(j.regular);return false}i.errorPostIndex(null);return true}};var TestRegistration={Init:function(){if(typeof Widget=="function"){RegistrationWidget.prototype=new Widget();var a=new RegistrationWidget();a.Init(a)}else{setTimeout(function(){TestRegistration.Init()},100)}}};TestRegistration.Init();
var RegistrationSellerWidget=function(){var k=this;k.widgetName="RegistrationSellerWidget";k.version=1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=a;var s={container:{widget:"content",def:"defaultRegistrationSellerWidgetId"},tmpl:{path:"registrationSellerTmpl.html",id:{step1:"registrationSellerFromStep1Tmpl",step2:"registrationSellerFromStep2Tmpl",step3:"registrationSellerFromStep3Tmpl",step4:"registrationSellerFromStep4Tmpl"}},regular:{nameSeller:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/},error:{nameSeller:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},phone:{regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},isChecked:{empty:"Вам необходимо прочитать и принять условия соглашения"},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},confirmLater:{empty:"Для активации аккаунта требуется подтвердить хотя бы один из способов связи"},typeSeller:{empty:"Поле обязательно для заполнения",minLength:"Минимум 5 символов",maxLength:"Максимум 40 символов"}},animate:typeof AnimateRegistrationSeller=="function"?AnimateRegistrationSeller:null},l="registration_seller",w="Регистрация продавца";function a(){v();b();t()}function v(){var x=k.GetInputParameters("registrationSeller");if(!$.isEmptyObject(x)){s=k.UpdateSettings1(s,x)}Config.Containers.registrationSeller=s.container}function t(){if(Routing.route==l){Loader.HideDefaultContent();var x=Routing.params;if(!x.step){x.step=1}k.BaseLoad.Tmpl(s.tmpl,function(){if(x.step==1){j();q()}if(x.step==2){h();p()}if(x.step==3){f();o()}if(x.step==4){d();m()}})}else{k.WidgetLoader(true)}}function b(){k.AddEvent("w.change.route",function(){t()});k.AddEvent("RSeller.step1.register",function(x){k.WidgetLoader(false);var z=[];if(x.nameSeller()){z.push("name_seller="+encodeURIComponent(x.nameSeller()))}if(x.phone()){z.push("phone_seller="+x.phone().replace(/\s/g,""))}if(x.email()){z.push("email_seller="+$.trim(x.email()))}if(z.length>0){var y="?"+z.join("&")}k.BaseLoad.RegistrationSeller(y,function(A){if(k.QueryError(A,function(){k.DispatchEvent("RSeller.step1.register",x)})){Parameters.cache.regSeller.step1=x;u(l,w,{step:2})}else{k.WidgetLoader(true,s.container.widget)}})});k.AddEvent("RSeller.step2.checking",function(x){Parameters.cache.regSeller.step2=x;u(l,w,{step:3})});k.AddEvent("RSeller.step3.checking",function(x){k.WidgetLoader(false);var z=Parameters.cache.regSeller.step1;var y=Parameters.cache.regSeller.step2;Parameters.cache.regSeller.step3=x;var B=[];if(z.nameSeller()){B.push("name_seller="+encodeURIComponent(z.nameSeller()))}B.push("mail_token="+encodeURIComponent(y.mailToken()?y.mailToken():1));B.push("sms_token="+encodeURIComponent(y.phoneToken()?y.phoneToken():1));if(x.typeSeller()){B.push("type_seller="+x.typeSeller())}if(x.invite()){B.push("invite="+encodeURIComponent(x.invite()))}if(x.site()){B.push("site="+encodeURIComponent(x.site()))}var A="?"+B.join("&");k.BaseLoad.ActivateSeller(A,function(C){if(k.QueryError(C,function(){k.DispatchEvent("RSeller.step3.checking",x)})){u(l,w,{step:4})}else{k.WidgetLoader(true,s.container.widget)}})})}function n(){k.ClearContainer(s)}function j(){k.InsertContainer(s,"step1")}function h(){k.InsertContainer(s,"step2")}function f(){k.InsertContainer(s,"step3")}function d(){k.InsertContainer(s,"step4")}function r(){RegistrationSellerFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var x=Parameters.cache.history.pop();if(x){u(x.route,x.title,x.data,true)}else{u("default","Домашняя",{})}};return new RegistrationSellerFormViewModel(s)}function q(){var x=Parameters.cache.regSeller.step1;if($.isEmptyObject(x)){x=r()}i(x)}function p(){var A=Routing.params;if(A.username&&A.mail_token){var y=r();y.nameSeller(A.username);Parameters.cache.regSeller.step1=y}var x=Parameters.cache.regSeller.step1;if(!x.nameSeller){u(l,w,{});return true}var z=new RegistrationSellerConfirmFormViewModel(x,s);if(A.username&&A.mail_token){z.mailToken(A.mail_token);k.DispatchEvent("RSeller.step2.checking",z);return true}g(z)}function o(){var x=Parameters.cache.regSeller.step3;if($.isEmptyObject(x)){x=new RegistrationSellerFinishFormViewModel(s)}if(!Parameters.cache.regSeller.step1.nameSeller){u(l,w,{});return true}e(x)}function m(){if(!Parameters.cache.regSeller.step1.nameSeller){u(l,w,{});return true}Parameters.cache.regSeller={step1:{},step2:{},step3:{}};c()}function i(x){k.RenderTemplate(x,s,null,function(y){j();i(y)},function(y){n()})}function g(x){k.RenderTemplate(x,s,null,function(y){h();g(y)},function(y){n()})}function e(x){k.RenderTemplate(x,s,null,function(y){f();e(y)},function(y){n()})}function c(){k.WidgetLoader(true,s.container.widget);if(s.animate){s.animate()}}function u(x,z,y){Routing.SetHash(x,z,y)}};var RegistrationSellerFormViewModel=function(b){var a=this;a.nameSeller=ko.observable(null);a.errorNameSeller=ko.observable(null);a.email=ko.observable(null);a.errorEmail=ko.observable(null);a.cssPhone="phone";a.phone=ko.observable(null);a.errorPhone=ko.observable(null);a.isChecked=ko.observable(false);a.errorIsChecked=ko.observable(null);a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RSeller.step1.register",a)}};a.ValidationForm=function(){var c=true;if(!a.NameValidation()){c=false}if(!a.EmailValidation()){c=false}if(!a.PhoneValidation()){c=false}if(!a.IsCheckedValidation()){c=false}return c};a.NameValidation=function(){var c=b.error.nameSeller;if(!a.nameSeller()){a.errorNameSeller(c.empty);return false}if(a.nameSeller().length<3){a.errorNameSeller(c.minLength);return false}if(a.nameSeller().length>40){a.errorNameSeller(c.maxLength);return false}if(!b.regular.nameSeller.test(a.nameSeller())){a.errorNameSeller(c.regular);return false}a.errorNameSeller(null);return true};a.EmailValidation=function(){var c=b.error.email;if(!a.email()){a.errorEmail(c.empty);return false}if(a.email().length>64){a.errorEmail(c.maxLength);return false}if(!b.regular.email.test(a.email())){a.errorEmail(c.regular);return false}a.errorEmail(null);return true};a.PhoneValidation=function(){if(a.phone()){if(!b.regular.phone.test($.trim(a.phone()))){a.errorPhone(b.error.phone.regular);return false}}a.errorPhone(null);return true};a.IsCheckedValidation=function(){if(!a.isChecked()){a.errorIsChecked(b.error.isChecked.empty);return false}a.errorIsChecked(null);return true};a.RestoreAccess=function(){};a.agreement="http://"+window.location.hostname+"/rules";a.police="http://"+window.location.hostname+"/police";a.refund="http://"+window.location.hostname+"/refund"};var RegistrationSellerConfirmFormViewModel=function(b,c){var a=this;a.nameSeller=b.nameSeller();a.cssMailToken="mail_token_block";a.mailToken=ko.observable();a.mailIsConfirm=ko.observable(false);a.errorEmailConfirm=ko.observable(null);a.mailConfirmLater=ko.observable(false);a.cssPhoneToken="phone_token_block";a.phoneToken=ko.observable();a.phoneIsConfirm=ko.observable(false);a.errorPhoneConfirm=ko.observable(null);a.phoneConfirmLater=ko.observable(false);a.errorConfirmLater=ko.observable(null);a.isEmptyPhone=ko.computed(function(){if(!$.isEmptyObject(b)&&b.phone()){return false}a.phoneConfirmLater(true);return true},this);a.submitEvent=ko.observable();a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RSeller.step2.checking",a)}};a.ValidationForm=function(){var d=true;if(!a.EmailTokenValidation()){d=false}if(!a.PhoneTokenValidation()){d=false}if(!a.EmptyConfirm()){d=false}return d};a.EmailTokenValidation=function(){if(!a.mailConfirmLater()){if(!a.mailToken()){a.errorEmailConfirm(c.error.emailToken.empty);return false}}a.errorEmailConfirm(null);return true};a.PhoneTokenValidation=function(){if(!a.phoneConfirmLater()){if(!a.phoneToken()){a.errorPhoneConfirm(c.error.phoneToken.empty);return false}}a.errorPhoneConfirm(null);return true};a.EmptyConfirm=function(){if(a.phoneConfirmLater()&&a.mailConfirmLater()){a.errorConfirmLater(c.error.confirmLater.empty);a.errorEmailConfirm(null);a.errorPhoneConfirm(null);return false}else{a.errorConfirmLater(null)}return true};a.Back=function(){Parameters.cache.regSeller.step3=a;Routing.SetHash("registration_seller","Регистрация продавца",{step:1})}};var RegistrationSellerFinishFormViewModel=function(b){var a=this;a.typeSeller=ko.observable();a.errorTypeSeller=ko.observable();a.invite=ko.observable();a.errorInvite=ko.observable();a.site=ko.observable("http://");a.errorSite=ko.observable();a.confirmLater=ko.observable(false);a.confirmLater.subscribe(function(c){if(!c){a.invite("");a.site("http://")}});a.errorConfirmLater=ko.observable(null);a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RSeller.step3.checking",a)}};a.ValidationForm=function(){var c=true;if(!a.TypeSellerValidation()){c=false}if(!a.InviteValidation()){c=false}if(!a.SiteValidation()){c=false}return c};a.Back=function(){Routing.SetHash("registration_seller","Регистрация пользователя",{step:2})};a.TypeSellerValidation=function(){if(!a.typeSeller()){a.errorTypeSeller(b.error.typeSeller.empty);return false}a.errorTypeSeller(null);return true};a.InviteValidation=function(){if(a.invite()){if(a.invite().length<5){a.errorInvite(b.error.invite.minLength);return false}if(a.invite().length>40){a.errorInvite(b.error.invite.maxLength);return false}}a.errorInvite(null);return true};a.SiteValidation=function(){if(a.site()){if(a.site()=="http://"){a.site("")}}a.errorSite(null);return true}};var TestRegistrationSeller={Init:function(){if(typeof Widget=="function"){RegistrationSellerWidget.prototype=new Widget();var a=new RegistrationSellerWidget();a.Init(a)}else{setTimeout(function(){TestRegistrationSeller.Init()},100)}}};TestRegistrationSeller.Init();
var CatalogWidget=function(){var j=this;j.widgetName="CatalogWidget";j.version=1;j.minWidgetVersion=1;j.maxWidgetVersion=2;j.minTmplVersion=1;j.maxTmplVersion=2;j.InitWidget=f;var d={container:{widget:"catalogWidgetId",def:"defaultCatalogWidgetId"},tmpl:{path:"catalogTmpl.html",id:"catalogTmpl"},animate:typeof AnimateCatalog=="function"?AnimateCatalog:null};function f(){i();b();j.CheckRouteCatalog()}function b(){var k=j.GetInputParameters("catalog");if(!$.isEmptyObject(k)){d=j.UpdateSettings1(d,k)}Config.Containers.catalog=d.container}j.CheckRouteCatalog=function(){if(Routing.route=="catalog"||Routing.route=="goods"||(Routing.IsDefault()&&!j.HasDefaultContent())){j.BaseLoad.Tmpl(d.tmpl,function(){j.BaseLoad.Roots(function(){h()})})}else{j.WidgetLoader(true)}};function i(){j.AddEvent("catalogWidget.fill.section",function(k){e(k)});j.AddEvent("w.change.route",function(){j.CheckRouteCatalog()})}function a(){j.ClearContainer(d)}function g(){j.InsertContainer(d)}function h(){if(!Parameters.cache.catalogs[Routing.GetActiveCategory()]){g();j.BaseLoad.Section(Routing.GetActiveCategory(),function(k){j.BaseLoad.Path(Routing.GetActiveCategory(),function(m){if(m[m.length-1]){var l=[];l[0]={id:m[m.length-1].id,name_category:m[m.length-1].name_category,type_category:"section",back:"return",children:Parameters.cache.childrenCategory[Routing.GetActiveCategory()]};c(l)}else{c(k)}})})}else{if(Parameters.cache.catalogs[Routing.GetActiveCategory()]){g();j.BaseLoad.Roots(function(k){c(k)})}else{j.WidgetLoader(true)}}}function c(m){var k=new CatalogViewModel();for(var l=0;l<=m.length-1;l++){k.AddItem(m[l])}j.DispatchEvent("catalogWidget.fill.section",k)}function e(k){j.RenderTemplate(k,d,null,function(l){g();e(l)},function(){a()})}};var CatalogViewModel=function(){var a=this;a.tab=ko.observableArray();a.AddItem=function(f){var g=new SectionViewModel(f,a.tab());if(f.children){for(var e=0;e<=f.children.length-1;e++){var c=new ItemViewModel(f.children[e],f.id);if(f.children[e].children){for(var d=0;d<=f.children[e].children.length-1;d++){var b=new ItemViewModel(f.children[e].children[d],f.children[e].id);c.children.push(b)}}g.children.push(c)}}a.tab.push(g)}};var SectionViewModel=function(c,b){var a=this;a.id=c.id;a.title=ko.computed(function(){if(c.back){return"Вверх"}return c.name_category},this);a.type_category=c.type_category;a.listClass="catalogCategories_"+c.id;a.tabClass=ko.computed(function(){var d="listCategories_"+c.id;if(b.length==1){d=d+" single"}if(Routing.GetActiveCategory()==c.id){if(c.back){return d+" return active"}else{return d+" active"}}else{return d}},this);a.countGoods=c.count_goods;a.children=ko.observableArray();a.titleWithCount=ko.computed(function(){if(c.back){return"Вверх"}else{var d=c.name_category;if(c.count_goods&&c.count_goods>0){d=d+" <span>"+c.count_goods+"</span>"}return d}},this);a.isActive=ko.computed(function(){if(Routing.GetActiveCategory()==a.id){return true}return false},this);a.ClickTab=function(){if(Parameters.cache.catalogs[a.id]){var e=$(".listCategories_"+a.id)[0].tagName;$(e+"[class^=listCategories]").removeClass("active");$(".listCategories_"+a.id).addClass("active");var d=$(".catalogCategories_"+c.id)[0].tagName;$(d+"[class*=catalogCategories]").hide();$(".catalogCategories_"+c.id).show();params={section:c.id};Routing.SetHash("catalog",c.name_category,params)}else{var f=Parameters.cache.path[a.id].path;params={section:f[f.length-2].id};Routing.SetHash("catalog",f[f.length-2].name_category,params)}}};var ItemViewModel=function(c,b){var a=this;a.id=c.id;a.title=c.name_category;a.countGoods=c.count_goods;a.children=ko.observableArray();a.titleWithCount=ko.computed(function(){var d=c.name_category;if(c.count_goods&&c.count_goods>0){d=d+" <span>"+c.count_goods+"</span>"}return d},this);a.hasChildren=ko.computed(function(){if(a.children().length>0){return true}return false},this);a.liClass=ko.computed(function(){if(a.hasChildren()){return"menuparent"}return""},this);a.ClickItem=function(){var d;if(c.type_category=="category"){d={section:b,category:c.id}}else{d={section:c.id}}Routing.SetHash("catalog",a.title,d)}};var TestCatalog={Init:function(){if(typeof Widget=="function"){CatalogWidget.prototype=new Widget();var a=new CatalogWidget();a.Init(a)}else{setTimeout(function(){TestCatalog.Init()},100)}}};TestCatalog.Init();
var BreadCrumbWidget=function(){var j=this;j.widgetName="BreadCrumbWidget";j.version=1;j.minWidgetVersion=1;j.maxWidgetVersion=2;j.minTmplVersion=1;j.maxTmplVersion=2;j.InitWidget=f;var d={container:{widget:["breadCrumbsWidgetId_1"],def:["defaultBreadCrumbsWidgetId_1"]},tmpl:{path:"breadCrumbTmpl.html",id:"breadCrumbTmpl"},animate:typeof AnimateBreadCrumb=="function"?AnimateBreadCrumb:null};function f(){i();b();g(Routing.GetActiveCategory())}function b(){var k=j.GetInputParameters("breadCrumb");if(!$.isEmptyObject(k)){d=j.UpdateSettings1(d,k)}Config.Containers.breadCrumb=d.container}function a(k){$("#"+d.container.widget[k]).empty().html("")}function h(){var k=d.container.widget;for(var l=0;l<=k.length-1;l++){if($("#"+k[l]).length>0){a(l);$("#"+k[l]).append($("script#"+j.GetTmplName1(d)).html()).children().hide()}}}function g(k){if(Routing.IsDefault()&&j.HasDefaultContent()){j.WidgetLoader(true)}else{j.WidgetLoader(false);j.BaseLoad.Tmpl(d.tmpl,function(){if(k){j.BaseLoad.Path(k,function(l){c(l)})}else{j.WidgetLoader(true)}})}}function i(){j.AddEvent("w.change.route",function(k){g(Routing.GetActiveCategory())});j.AddEvent("w.change.breadCrumb",function(k){g(k)});j.AddEvent("breadCrumb.fill.item",function(k){e(k)});j.AddEvent("breadCrumb.click.item",function(k){j.BaseLoad.Path(k.id,function(l){Routing.SetHash("catalog",l[l.length-1].name_category,Routing.GetPath(l))})})}function c(l){var k=new BreadCrumbViewModel();k.AddCrumbs(l)}function e(m){h();var k=d.container.widget;for(var l=0;l<=k.length-1;l++){if($("#"+k[l]).length>0){try{ko.cleanNode($("#"+k[l])[0]);ko.applyBindings(m,$("#"+k[l])[0]);j.ShowContainer(k[l]);j.WidgetLoader(true);if(d.animate){d.animate()}}catch(n){j.Exception("Ошибка шаблона ["+j.GetTmplName1(d)+"]",n);if(d.tmpl.custom){delete d.tmpl.custom;j.BaseLoad.Tmpl(d.tmpl,function(){e(m)})}else{a(l);j.WidgetLoader(true)}}}else{j.Exception("Ошибка. Не найден контейнер ["+k[l]+"]");j.WidgetLoader(true)}delete m}}};var BreadCrumbItem=function(b){var a=this;a.id=b.id;a.title=b.name_category;a.typeCategory=b.type_category;a.selectList=ko.observableArray();a.showSelectList=ko.computed(function(){if(a.selectList()>0){return true}else{false}},this);a.ClickItem=function(){if(!a.showSelectList()){EventDispatcher.DispatchEvent("breadCrumb.click.item",{id:a.id})}};a.AddSelectList=function(d){for(var c=0;c<=d.length-1;c++){a.selectList.push(new SelectListBreadCrumbItem(d[c]))}}};var BreadCrumbViewModel=function(){var a=this;a.lastItem=ko.observable();a.title="";a.crumbs=ko.observableArray();a.ToHomepage=function(){Routing.SetHash("default","Домашняя",{})};a.showReturn=ko.computed(function(){if(Parameters.cache.history.length>1){return true}return false},this);a.Return=function(){Parameters.cache.history.pop();var b=Parameters.cache.history.pop();if(b.route=="order"&&b.data.create){b=Parameters.cache.history.pop()}Routing.SetHash(b.route,b.title,b.data,true)};a.AddCrumbs=function(e){if(e){for(var b=0;b<=e.length-1;b++){var c=new BreadCrumbItem(e[b]);if(e[b].children){c.AddSelectList(e[b].children)}a.crumbs.push(c)}if(Routing.route=="default"){a.crumbs=ko.observableArray();a.lastItem(Routing.defaultTitle)}if(Routing.route=="goods"){a.lastItem("Карточка товара")}if(Routing.route=="cart"){a.crumbs=ko.observableArray();a.lastItem("Моя корзина")}if(Routing.route=="payment"){a.crumbs=ko.observableArray();a.lastItem("Оплата заказа")}if(Routing.route=="registration"){a.crumbs=ko.observableArray();a.crumbs.push(new BreadCrumbItem({id:0,name_category:"Регистрация покупателя"}));if(Routing.params.step==1){a.lastItem("Шаг 1")}if(Routing.params.step==2){a.lastItem("Шаг 2")}if(Routing.params.step==3){a.lastItem("Шаг 3")}if(Routing.params.step==4){a.lastItem("Шаг 4")}}if(Routing.route=="order"){a.crumbs=ko.observableArray();a.crumbs.push(new BreadCrumbItem({id:0,name_category:"Оформление заказа"}));if(Routing.params.step==1){a.lastItem("Шаг 1")}if(Routing.params.step==2){a.lastItem("Шаг 2")}if(Routing.params.step==3){a.lastItem("Шаг 3")}if(Routing.params.step==4){a.lastItem("Шаг 4")}if(Routing.params.step==5){a.lastItem("Шаг 5")}}if(Routing.route=="profile"||Routing.route=="favorites"||Routing.route=="purchases"||Routing.route=="cabinet_cart"){a.crumbs=ko.observableArray();a.lastItem("Личный кабинет")}if(!a.lastItem()){var d=a.crumbs().pop();a.lastItem(d.title)}EventDispatcher.DispatchEvent("breadCrumb.fill.item",a)}}};var SelectListBreadCrumbItem=function(b){var a=this;a.id=b.id;a.title=b.name_category;a.cssActiveItem=ko.computed(function(){if(Routing.route=="catalog"&&a.id==Routing.GetActiveCategory()){return"active"}return""},this);a.ClickItem=function(){EventDispatcher.DispatchEvent("breadCrumb.click.item",{id:a.id})}};var TestBreadCrumb={Init:function(){if(typeof Widget=="function"){BreadCrumbWidget.prototype=new Widget();var a=new BreadCrumbWidget();a.Init(a)}else{setTimeout(function(){TestBreadCrumb.Init()},100)}}};TestBreadCrumb.Init();
var ContentWidget=function(){var h=this;h.widgetName="ContentWidget";h.version=1;h.minWidgetVersion=1;h.maxWidgetVersion=2;h.minTmplVersion=1;h.maxTmplVersion=2;h.InitWidget=d;var n={message:{noGoods:"В этом разделе товаров не найдено...",filter:'Товаров по ключу "%%filterName%%" не найдено',categoriesNotCreated:"Извините, но в магазине пока нет товаров для продажи."},container:{content:{widget:"content",def:"defaultContentWidgetId"},block:{slider:{widget:"sliderBlockId",def:"defaultSliderBlockId"},carousel:{widget:"carouselBlockId",def:"defaultSliderBlockId"},tile:{widget:"tileBlockId",def:"defaultTileBlockId"},empty:{widget:"emptyBlockId",def:"defaultEmptyBlockId"}}},tmpl:{content:{path:"contentTmpl.html",id:{table:"contentTableTmpl",list:"contentListTmpl",tile:"contentTileTmpl",empty:"contentNoResultsTmpl"}},block:{path:"blockTmpl.html",id:{slider:"blockSliderTmpl",carousel:"blockCaruselTmpl",tile:"blockTileTmpl",empty:"blockNoResultsTmpl"}}},countGoodsInBlock:6,listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],orderBy:"name",showCart:true,showBlocks:true,animate:{content:typeof AnimateContent=="function"?AnimateContent:null,block:typeof AnimateContent=="function"?AnimateContent:null},filterName:"",slider:[],paging:Config.Paging};h.testBlock={count:0,ready:0,IsReady:function(){if(h.testBlock.count==h.testBlock.ready){return true}return false}};function d(){s();f();g()}function s(){var v=h.GetInputParameters("content");if(!$.isEmptyObject(v)){n=h.UpdateSettings1(n,v);if(v.hasOwnProperty("showCart")){n.showCart=v.showCart}if(v.block){var y=v.block;if(y.hasOwnProperty("showBlocks")){n.showBlocks=y.showBlocks}if(y.count){n.countGoodsInBlock=y.count}if(y.animate){n.animate.block=y.animate}if(y.tmpl){if(y.tmpl.path){n.tmpl.block.path=y.tmpl.path}if(y.tmpl.id){for(var w in y.tmpl.id){n.tmpl.block.id[w]=y.tmpl.id[w]}}}if(y.container){for(var w in y.container){n.container.block[w]=y.container[w]}}}if(v.content){var x=v.content;if(x.defaultCount){n.paging.itemsPerPage=x.defaultCount}if(x.list){n.listPerPage=x.list}if(x.animate){n.animate.content=x.animate}}}Config.Containers.content=n.container}function g(){if(Routing.route=="catalog"||Routing.IsDefault()){h.BaseLoad.Roots(function(){c()})}else{h.WidgetLoader(true)}}function c(){if(Routing.IsCategory()){if(!h.HasDefaultContent("content","content")||!Routing.IsDefault()){e()}else{h.WidgetLoader(true)}}else{if(Routing.IsDefault()){var v=Parameters.cache.roots[0];Config.Base.defaultSection=v.id;if(v.type_category!="section"){e()}else{if(n.showBlocks){p()}else{if(!n.showBlocks){var w=v.children;var x=null;$.each(w,function(y){if(w[y].type_category=="category"){x=w[y];return false}});if(x){Routing.SetHash("catalog",x.name_category,{section:v.id,category:x.id})}else{h.WidgetLoader(true)}}else{h.WidgetLoader(true)}}}}else{if(n.showBlocks){if(!h.HasDefaultContent("content","block")||!Routing.IsDefault()){p()}else{h.WidgetLoader(true)}}else{h.WidgetLoader(true)}}}}function e(){h.BaseLoad.Tmpl(n.tmpl.content,function(){EventDispatcher.DispatchEvent("onload.content.tmpl")})}function p(){h.BaseLoad.Tmpl(n.tmpl.block,function(){EventDispatcher.DispatchEvent("onload.blockContent.tmpl")})}function f(){h.AddEvent("onload.blockContent.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Blocks(Routing.GetActiveCategory(),function(v){h.CheckData(v)})})});h.AddEvent("onload.content.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Info(Routing.GetActiveCategory(),function(v){b();h.DispatchEvent("contentWidget.load.categoryInfo")})})});h.AddEvent("contentWidget.load.categoryInfo",function(){var x=(Routing.GetCurrentPage()-1)*n.paging.itemsPerPage;var w=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):n.orderBy;var v=x+"/"+n.paging.itemsPerPage+"/"+w+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));h.BaseLoad.Content(Routing.params.category,v,function(y){r(y)})});h.AddEvent("contentWidget.fill.block",function(v){j(v)});h.AddEvent("contentWidget.fill.listContent",function(v){q(v.typeView);o(v)});h.AddEvent("w.change.route",function(v){g()});h.AddEvent("contentWidget.click.category",function(v){if($("script#contentTileTmpl").length<0){h.BaseLoad.Tmpl(n.tmplForContent,function(){h.DispatchEvent("onload.content.tmpl")})}else{h.DispatchEvent("onload.content.tmpl")}})}h.CheckData=function(y){b();if(y.err||y==false){if(y.err=="categoriesNotCreated"){var z=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"categoriesNotCreated"});k(0,z.typeView);a(z)}else{var z=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"no_results"});k(0,z.typeView);a(z)}}else{h.testBlock.count=0;h.testBlock.ready=0;m.block=ko.observableArray();for(var w=0;w<=y.length-1;w++){if(y[w].count_goods>0){++h.testBlock.count;Parameters.cache.contentBlock[y[w].id]={sort:w,block:y[w]};k(w,y[w].type_view);var x="0/"+n.countGoodsInBlock+"/name/";var v=y[w].id+EventDispatcher.HashCode(x);h.AddEvent("contentWidget.onload.content%%"+v,function(A){u(Parameters.cache.contentBlock[A.categoryId])});h.BaseLoad.Content(y[w].id,x,function(A){h.DispatchEvent("contentWidget.onload.content%%"+v,A)})}}}};function i(w,v){$("#"+n.container.block[w].widget+" .promoBlocks:last").attr("id","block_sort_"+v)}function b(){$("#"+n.container.block.slider.widget).html("");$("#"+n.container.block.carousel.widget).html("");$("#"+n.container.block.tile.widget).html("");$("#"+n.container.content.widget).html("")}function k(v,w){if(w=="slider"){h.AppendContainer(n,"slider","block",n.container.block.slider.widget);i("slider",v)}if(w=="carousel"){h.AppendContainer(n,"carousel","block",n.container.block.carousel.widget);i("carousel",v)}if(w=="tile"){h.AppendContainer(n,"tile","block",n.container.block.tile.widget);i("tile",v)}if(w=="no_results"){h.AppendContainer(n,"empty","block",n.container.block.empty.widget)}if(w=="categoriesNotCreated"){$("#"+n.container.block.empty.widget).html('<p style="margin-top: 40px">'+n.message.categoriesNotCreated+"</p>").children().hide()}}function l(){$("#"+n.container.content.widget).html("")}function q(v){l();if(v=="table"){h.AppendContainer(n,"table","content",n.container.content.widget)}if(v=="list"){h.AppendContainer(n,"list","content",n.container.content.widget)}if(v=="tile"){h.AppendContainer(n,"tile","content",n.container.content.widget)}if(v=="no_results"){h.AppendContainer(n,"empty","content",n.container.content.widget)}}function u(v){var w=new BlockViewModel(v,n);w.AddContent()}function r(w){if(w.content[0].count_goods!=0){var v=new ListContentViewModel(n);v.AddCategoryInfo(w.categoryId);v.AddContent(w.content)}else{var v=new ListContentViewModel(n);v.AddCategoryInfo(w.categoryId);if(v.filters.filterName()!=""){v.SetType("no_results");v.SetMessage(n.message.filter.replace(/%%filterName%%/g,v.filters.filterName()))}else{v.SetType("no_results");v.SetMessage(n.message.noGoods)}h.DispatchEvent("contentWidget.fill.listContent",v)}}var m={block:ko.observableArray(),Do:function(){if(Loader.IsReady()){var v=m.block();$.each(v,function(w){if(n.animate.block){n.animate.block()}})}else{setTimeout(function(){m.Do()},100)}}};function o(v){h.RenderTemplate(v,n,null,function(w){q(w.typeView);o(w)},function(){l()},v.typeView,null,"content")}function j(v){if($("#"+v.cssBlock).length>0){try{ko.cleanNode($("#"+v.cssBlock)[0]);ko.applyBindings(v,$("#"+v.cssBlock)[0]);m.block.push({type:v.typeView,data:v});h.testBlock.ready=h.testBlock.ready+1;if(h.testBlock.IsReady()){$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)});m.Do()}}catch(w){h.Exception("Ошибка шаблона ["+h.GetTmplName1(n,v.typeView,"block")+"]",w);if(n.tmpl.custom){delete n.tmpl.custom;h.BaseLoad.Tmpl(n.tmpl,function(){k(v.typeView);j(v)})}else{l();$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)})}}}else{h.Exception("Ошибка. Не найден контейнер ["+v.cssBlock+"]");$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)})}delete v}function a(v){h.RenderTemplate(v,n,function(){$("#"+n.container.block.empty.widget).children().show();$.each(n.container.block,function(w){h.WidgetLoader(true,n.container.block[w].widget)})},function(w){k(w.typeView);j(w)},function(){$.each(n.container.block,function(w){h.WidgetLoader(true,n.container.block[w].widget)})},"empty",null,"block")}function t(v){h.RenderTemplate(v,n,null,function(w){q(w.typeView);t(w)},function(){b()},"empty",null,"content")}};var EmptyViewBlock=function(b){var a=this;a.titleBlock=b.titleBlock;a.typeView=b.typeView};var BlockViewModel=function(c,b){var a=this;a.countGoodsInContent=b.countGoodsInBlock;a.id=c.block.id;a.sort=c.sort;a.titleBlock=c.block.name_category;a.typeView=c.block.type_view;a.countGoods=c.block.count_goods?c.block.count_goods:0;a.showCart=b.showCart;a.cssBlock="block_sort_"+c.sort;a.cssBlockContainer="sliderContainer_"+a.id;a.imageHref="#";a.contentBlock=ko.observableArray();a.AddContent=function(){var m="0/"+a.countGoodsInContent+"/name/";var e=a.id+EventDispatcher.HashCode(m);var k=Parameters.cache.content[e].content;if(k&&k.length>1){var h=k.shift();a.countGoods=h.count_goods;if(k.length<a.countGoodsInContent){a.countGoodsInContent=k.length}var l=0;for(var g=0;g<=a.countGoodsInContent-1;g++){if(a.typeView=="tile"){var n=new BlockTrForTableViewModel();for(var d=0;d<=2;d++){if(k[l]){n.AddStr(new ContentViewModel(k[l],l));l++}else{break}}if(n.str().length>0){a.contentBlock.push(n)}delete n}else{a.contentBlock.push(new ContentViewModel(k[g],g))}}k.unshift(h);EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}else{EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}};a.ClickCategory=function(){Routing.SetHash("catalog",a.titleBlock,{category:c.block.id})}};var ListContentViewModel=function(b){var a=this;a.id=0;a.titleBlock="";a.typeView="tile";a.countGoods=0;a.message="";a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortContentListViewModel();c.AddContent(b.sortList);c.SetDefault(Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderBy);return c};a.filters={typeView:a.typeView,filterName:ko.observable(Routing.GetMoreParameter("filterName")?Routing.GetMoreParameter("filterName"):b.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),sort:a.GetSort(),FilterNameGoods:function(c){b.filterName=a.filters.filterName($(c.text).val());Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ClickFilterNameGoods:function(){b.filterName=a.filters.filterName();Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("ContentWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}}};a.SetType=function(c){a.typeView=c};a.SetMessage=function(c){a.message=c};a.AddCategoryInfo=function(e){var d=Parameters.cache.infoCategory[e];a.id=d.id;a.titleBlock=d.name_category;if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}else{if(d.type_view){var c=d.type_view;if(d.type_view=="carousel"||d.type_view=="slider"){var c="tile"}a.typeView=c;a.filters.typeView=c}}};a.AddContent=function(h){a.content=ko.observableArray();if(h&&h.length>1){var e=h.shift();a.countGoods=e.count_goods;var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e);a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}};a.GetQueryHash=function(){var e=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var d=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderBy;var c=e+"/"+b.paging.itemsPerPage+"/"+d+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));return Routing.GetActiveCategory()+EventDispatcher.HashCode(c)};a.AddPages=function(){var c=function(){Loader.Indicator("ContentWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortContentItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortContentListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortContentItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestContent={Init:function(){if(typeof Widget=="function"){ContentWidget.prototype=new Widget();var a=new ContentWidget();a.Init(a)}else{setTimeout(function(){TestContent.Init()},100)}}};TestContent.Init();
var SearchWidget=function(){var k=this;k.widgetName="SearchWidget";k.version=1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=h;var f={container:{widget:"searchWidgetId",def:"defaultSearchWidgetId"},showCatalog:true,tmpl:{path:"searchTmpl.html",id:"searchTmpl"},message:{empty:"Введите название товара для его поиска."},animate:typeof AnimateSearch=="function"?AnimateSearch:null};function h(){i();b();j()}function b(){var l=k.GetInputParameters("search");if(!$.isEmptyObject(l)){f=k.UpdateSettings1(f,l)}Config.Containers.search=f.container}function a(){k.ClearContainer(f)}function d(){k.InsertContainer(f)}function j(){if(Routing.IsDefault()&&k.HasDefaultContent()){k.WidgetLoader(true,f.container.widget)}else{c()}}function c(){k.BaseLoad.Tmpl(f.tmpl,function(){k.BaseLoad.Roots(function(){k.BaseLoad.Section(Routing.GetActiveCategory(),function(l){k.BaseLoad.Info(Routing.GetActiveCategory(),function(m){e(m)})})})})}function i(){k.AddEvent("Search.fill.categories",function(l){d();g(l)});k.AddEvent("w.change.route",function(l){j()})}function e(m){SearchViewModel.prototype=new Widget();var l=new SearchViewModel(f);l.AddListCategory(m)}function g(l){k.RenderTemplate(l,f,null,function(m){d();g(m)},function(){a()})}};var SearchCategoryItem=function(c,d,a){var b=this;b.id=c.id;b.title=Array(d).join(" - ")+c.name_category;b.typeCategory=c.type_category;b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchCategoryItemForTree=function(c,d,a){var b=this;b.id=c.id;b.title=c.name_category;b.typeCategory=c.type_category;b.children=ko.observableArray();b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){a.selectedCatigory(b.title);return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchViewModel=function(b){var a=this;a.text=ko.observable();if(Routing.route=="search"){a.text(Parameters.filter.keyWords)}a.cssSelectList="searchSelectList";a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.selectedCatigoriesId=ko.observable();if(Routing.route=="search"&&Parameters.filter.idSelectCategories&&Parameters.filter.idSelectCategories.length==1){a.selectedCatigoriesId(Parameters.filter.idSelectCategories[0])}a.selectedCatigory=ko.observable();a.idCategories=Parameters.filter.idCategories;a.typeCategories=[];a.cachData={};a.showCatalog=b.showCatalog;a.ClickAdvancedSearch=function(){a.DispatchEvent("SearchR.show.form")};a.AddListCategory=function(h){if(Parameters.cache.childrenCategory[h.id]){var l=Parameters.cache.childrenCategory[h.id];a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.childrenCategories=ko.observableArray();a.typeCategories=[];a.cachData=[{id:h.id,type_category:h.type_category,children:l}];a.typeCategories[h.id]=h.type_category;a.categories.push(new SearchCategoryItem(h,0,a));for(var g=0;g<=l.length-1;g++){a.categories.push(new SearchCategoryItem(l[g],1,a));a.typeCategories[l[g].id]=l[g].type_category;var k=new SearchCategoryItemForTree(l[g],g+1,a);var f=ko.observableArray();if(l[g].children){for(var e=0;e<=l[g].children.length-1;e++){a.categories.push(new SearchCategoryItem(l[g].children[e],2,a));a.typeCategories[l[g].id]=l[g].type_category;f.push(new SearchCategoryItemForTree(l[g].children[e],2,a))}k.children=f}a.childrenCategories.push(k)}var h=new SearchCategoryItemForTree(h,0,a);h.children=a.childrenCategories;a.categoriesTree.push(h)}a.DispatchEvent("Search.fill.categories",a)};a.SubmitSearchForm=function(f){a.idCategories=[];var e=a.selectedCatigoriesId(),g=$(f.text).val();if(g){if(a.typeCategories[e]!="category"){c(a.cachData,e)}else{a.idCategories.push(e)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[e];Parameters.filter.keyWords=g;if(a.idCategories.length==0){a.idCategories=[e]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);a.DispatchEvent("w.change.breadCrumb",e)}else{a.ShowMessage(b.message.empty,false,false)}};a.ClickSearchForm=function(){a.idCategories=[];var e=a.selectedCatigoriesId();var f=a.text();if(f){if(a.typeCategories[e]!="category"){c(a.cachData,e)}else{a.idCategories.push(e)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[e];Parameters.filter.keyWords=f;if(a.idCategories.length==0){a.idCategories=[e]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);a.DispatchEvent("w.change.breadCrumb",e)}else{a.ShowMessage(Config.Search.message.empty,false,false)}};function c(g,f){for(var e=0;e<=g.length-1;e++){if(g[e].id==f&&g[e].children){d(g[e].children);break}else{if(g[e].children){c(g[e].children,f)}}}}function d(f){for(var e=0;e<=f.length-1;e++){if(f[e].type_category=="category"){a.idCategories.push(f[e].id)}if(f[e].children){d(f[e].children)}}}};var TestSearch={Init:function(){if(typeof Widget=="function"){SearchWidget.prototype=new Widget();var a=new SearchWidget();a.Init(a)}else{setTimeout(function(){TestSearch.Init()},100)}}};TestSearch.Init();
var SearchResultWidget=function(){var m=this;m.widgetName="SearchResultWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.InitWidget=h;var g={container:{form:{widget:"advancedSearchFormWidgetId",def:"defaultAdvancedSearchFormWidgetId"},content:{widget:"content",def:"defaultAdvancedSearchResultWidgetId"}},tmpl:{content:{path:"searchResultTmpl.html",id:{table:"searchResultTableTmpl",list:"searchResultListTmpl",tile:"searchResultTileTmpl",empty:"searchResultErrorTmpl"}},form:{path:"advancedSearchFormTmpl.html",id:"advancedSearchFormTmpl"}},showCatalog:true,showForm:true,showCart:true,idAdvancedSearchForm:"advancedSearch",listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],listTypeSearch:{any:"Любое из слов",all:"Все слова"},listTypeSeller:{"":"Все продавцы",person:"Частное лицо",company:"Компания"},animate:{content:typeof AnimateSearchResult=="function"?AnimateSearchResult:null,form:typeof AnimateSearchResult=="function"?AnimateSearchResult:null},idTreeCategoriesForAdvancedSearchForm:"tree_categories_for_advanced_search",paging:Config.Paging};function h(){k();c();i()}function c(){var o=m.GetInputParameters("searchResult");if(!$.isEmptyObject(o)){g=m.UpdateSettings1(g,o);if(o.content){if(o.content.hasOwnProperty("showCart")){g.showCart=o.content.showCart}if(o.content.hasOwnProperty("defaultCount")){g.paging.itemsPerPage=o.content.defaultCount}if(o.content.list){g.listPerPage=o.content.list}}if(o.form){if(o.form.hasOwnProperty("showForm")){g.showForm=o.form.showForm}if(o.form.hasOwnProperty("showCatalog")){g.showCatalog=o.form.showCatalog}}}Config.Containers.searchResult=g.container}function i(){if(Routing.route=="search"){var t=Routing.params;for(var r in t){if(r=="idSelectCategories"){var o=[];var s=decodeURIComponent(t[r]).split(",");if(t[r]){var p=0;for(var q in s){var u=parseInt(s[q]);if(u&&!isNaN(u)){o[p++]=u}}Parameters.filter[r]=o;Parameters.filter.idCategories=o}}else{Parameters.filter[r]=decodeURIComponent(t[r])}}m.DispatchEvent("w.change.route")}m.DispatchEvent("SearchR.show.form")}function k(){m.AddEvent("SearchR.show.form",function(){if(g.showForm){$("#"+g.container.form.widget).html("");m.BaseLoad.Roots(function(){m.DispatchEvent("SearchR.onload.roots.show.form")})}else{m.WidgetLoader(true,g.container.form.widget)}});m.AddEvent("SearchR.onload.roots.show.form",function(o){m.BaseLoad.Tmpl(g.tmpl.form,function(){l();if(Routing.route!="search"){Parameters.SetDefaultFilterParameters()}j();m.WidgetLoader(true,g.container.form.widget)})});m.AddEvent("SearchR.submit.form",function(s){var o=g.paging;var u=(Routing.GetCurrentPage()-1)*o.itemsPerPage;var r=u+"/"+o.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var q=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var t=[];for(var p=0;p<=q.length-1;p++){if(Parameters.filter[q[p]]){t[p]=q[p]+"="+encodeURIComponent(Parameters.filter[q[p]])}}r=r+t.join("&");m.BaseLoad.SearchContent(Parameters.shopId,r,function(v){m.DispatchEvent("SearchR.onload.searchResult",v)})});m.AddEvent("SearchR.onload.searchResult",function(o){m.DispatchEvent("onload.breadCrumb.tmpl");e(o)});m.AddEvent("SearchR.fill.searchResult",function(o){n(o.typeView);f(o)});m.AddEvent("SearchR.fill.categories",function(o){b(o)});m.AddEvent("w.change.route",function(o){if(Routing.route=="search"){m.BaseLoad.Tmpl(g.tmpl.content,function(){m.DispatchEvent("SearchR.submit.form")})}m.DispatchEvent("SearchR.show.form")})}function d(){$("#"+g.container.form.widget).empty().html("")}function l(){d();m.AppendContainer(g,false,"form",g.container.form.widget)}function a(){$("#"+g.container.content.widget).empty().html("")}function n(p){a();var o=g.container.content.widget;if(p=="table"){m.AppendContainer(g,"table","content",o)}if(p=="list"){m.AppendContainer(g,"list","content",o)}if(p=="tile"){m.AppendContainer(g,"tile","content",o)}if(p=="error"){m.AppendContainer(g,"empty","content",o)}}function j(){var o=new AdvancedSearchFormViewModel(g);m.BaseLoad.Roots(function(p){o.AddCategories(p)})}function e(o){m.BaseLoad.Script(PokupoWidgets.model.content,function(){var p=new ListSearchResultViewModel(g);p.AddContent(o)})}function b(o){if(ko.global){ko.global.route=Routing.route}else{ko.global={route:Routing.route}}m.RenderTemplate(o,g,null,function(p){l();b(p)},function(){d()},null,null,"form")}function f(o){m.RenderTemplate(o,g,null,function(p){n(p.typeView);f(p)},function(){a()},o.typeView,null,"content")}};var AdvancedSearchFormViewModel=function(e){var a=this,d=Parameters.filter;a.keyWords=d.keyWords;a.idCategories=d.idCategories;a.typeSearch=ko.observable();a.typeSearch(d.typeSearch);a.startCost=d.startCost;a.endCost=d.endCost;a.exceptWords=d.exceptWords;a.typeSeller=ko.observable();a.typeSeller(d.typeSeller);a.showCatalog=e.showCatalog;a.categories=[];a.typesSearch=ko.observableArray();a.typesSellers=ko.observableArray();a.typeCategories=[];a.cssTypeSearch="advancedSearchTypeSearch";a.cssTypeSeller="advancedSearchTypeSeller";a.cachData={};a.AddCategories=function(i){a.cachData=i;if(a.idCategories&&a.idCategories.length==1){f(i,a.idCategories)}a.categories=c(i).children;Parameters.cache.categories=a.categories;EventDispatcher.DispatchEvent("SearchR.fill.categories",a)};a.SubmitAdvancedSearchForm=function(i){Loader.Indicator("SearchResultWidget",false);a.keyWords=$(i.keyWords).val();a.startCost=$(i.startCost).val();a.endCost=$(i.endCost).val();a.exceptWords=$(i.exceptWords).val();Parameters.filter.idCategories=a.idCategories=[];f(a.cachData,Parameters.filter.idSelectCategories);if(a.idCategories.length>0){Parameters.filter.idCategories=a.idCategories.join(",")}Parameters.filter.keyWords=a.keyWords;Parameters.filter.typeSearch=a.typeSearch();Parameters.filter.startCost=a.startCost;Parameters.filter.endCost=a.endCost;Parameters.filter.exceptWords=a.exceptWords;Parameters.filter.typeSeller=a.typeSeller();Parameters.filter.page=1;Routing.SetHash("search","Расширенный поиск",Parameters.filter)};b(e.listTypeSearch,a.typesSearch);h(e.listTypeSeller,a.typesSellers);function c(o,i){var l=[];var p=false;for(var k=0;k<=o.length-1;k++){var n={};n.select=false;if($.inArray(o[k].id,Parameters.filter.idSelectCategories)>=0||i==true){n.select=true;p=true}if(o[k].children){var m=c(o[k].children,n.select);n.children=m.children;n.expand=m.active;n.isFolder=true}n.key=o[k].id;n.title=o[k].name_category;l.push(n);a.typeCategories[o[k].id]=o[k].type_category}return{children:l,active:p}}function b(i,k){for(var j in i){k.push(new AdvancedSearchFormTypeSearchViewModel({key:j,title:i[j]},a))}}function h(i,k){for(var j in i){k.push(new AdvancedSearchFormTypeSellerViewModel({key:j,title:i[j]},a))}}function f(n,m){for(var l=0;l<=n.length-1;l++){if(m){for(var k=0;k<=m.length;k++){if(n[l].id==m[k]&&n[l].children){g(n[l].children);break}else{if(n[l].children){f(n[l].children,m)}else{if(n[l].id==m[k]){if($.inArray(n[l].id,a.idCategories)<0){a.idCategories.push(n[l].id)}}}}}}}}function g(k){for(var j=0;j<=k.length-1;j++){if(k[j].type_category=="category"){if($.inArray(k[j].id,a.idCategories)<0){a.idCategories.push(k[j].id)}}if(k[j].children){g(k[j].children)}}}};var AdvancedSearchFormTypeSearchViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSearch(a.key)}};var AdvancedSearchFormTypeSellerViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSeller(a.key)}};var ListSearchResultViewModel=function(b){var a=this;a.id=0;a.titleBlock="Расширенный поиск";a.typeView="tile";a.countGoods=0;a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortSearchResultListViewModel();c.AddContent(b.sortList);c.SetDefault(Parameters.filter.orderBy);return c};a.filters={typeView:a.typeView,sort:a.GetSort(),filterName:ko.observable(Parameters.filter.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),FilterNameGoods:function(c){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=$(c.text).val();Routing.UpdateHash({page:1,filterName:$(c.text).val()})},ClickFilterNameGoods:function(){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=a.filters.filterName();Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("SearchResultWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)}}};a.AddContent=function(h){a.content=ko.observableArray();if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}if(h&&h.length>1){var e=h.shift();a.countGoods=parseInt(e.count_goods);var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e)}if(a.countGoods==0){a.typeView="error"}a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)};a.GetQueryHash=function(){var g=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var e=g+"/"+b.paging.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var d=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var f=[];for(var c=0;c<=d.length-1;c++){if(Parameters.filter[d[c]]){f[c]=d[c]+"="+encodeURIComponent(Parameters.filter[d[c]])}}e=e+f.join("&");return Parameters.shopId+EventDispatcher.HashCode(e)};a.AddPages=function(){var c=function(){Loader.Indicator("SearchResultWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortSearchResultItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("SearchResultWidget",false);Parameters.filter.orderBy=a.name;Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortSearchResultListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_search_result_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortSearchResultItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestSearchResult={Init:function(){if(typeof Widget=="function"){SearchResultWidget.prototype=new Widget();var a=new SearchResultWidget();a.Init(a)}else{setTimeout(function(){TestSearchResult.Init()},100)}}};TestSearchResult.Init();
var GoodsWidget=function(){var l=this;l.widgetName="GoodsWidget";l.version=1.2;l.minWidgetVersion=1;l.maxWidgetVersion=2;l.minTmplVersion=1;l.maxTmplVersion=2;l.goods=null;l.hasButton=false;l.InitWidget=f;var e={container:{widget:"content",def:"defaultGoodsWidgetId"},tmpl:{path:"goodsTmpl.html",id:"goodsTmpl"},animate:typeof AnimateGoods=="function"?AnimateGoods:null,showBlocks:["main","description"],infoBlock:1111111,moreBlocks:{description:"Описание",shipping:"Условия доставки",opinion:"Отзывы покупателей"},message:{maxIsReached:"Достигнут максимум"},share:{element:"share",elementStyle:{quickServices:["vkontakte","odnoklassniki","facebook","twitter","gplus"]}},galleryId:"jcarousel"};function f(){c();j();b()}function c(){var m=l.GetInputParameters("goods");if(!$.isEmptyObject(m)){e=l.UpdateSettings1(e,m);if(m.show){for(var n=0;n<=m.show.length-1;n++){if($.inArray(m.show[n],e.showBlocks)<0){e.showBlocks.push(m.show[n])}}}}Config.Containers.goods=e.container}function b(){if(Routing.route=="goods"){l.BaseLoad.Tmpl(e.tmpl,function(){l.BaseLoad.Script(PokupoWidgets.model.goods,function(){g()})})}else{l.WidgetLoader(true)}}function j(){l.AddEvent("w.change.route",function(){b()});l.AddEvent("G.info",function(m){k.Content(m)})}function g(){l.BaseLoad.InfoFavorite("no",function(m){Parameters.cache.favorite=m;l.BaseLoad.GoodsInfo(Routing.params.id,e.infoBlock,function(n){l.DispatchEvent("G.info",n)})})}function a(){l.ClearContainer(e)}function d(){l.InsertContainer(e)}var k={Content:function(n){l.goods=new GoodsViewModel(e);for(var m in n){if(typeof k[m.charAt(0).toUpperCase()+m.substr(1).toLowerCase()]=="function"){k[m.charAt(0).toUpperCase()+m.substr(1).toLowerCase()](n[m])}else{k.Block(m,n[m])}}l.goods.blocks.main.sellerId=n.seller.id;l.goods.blocks.main.shopId=n.shop.id;l.goods.SetListMoreBlock();i(l.goods)},Main:function(n){GoodsMainBlockViewModel.prototype=new Widget();l.goods.AddBlock("main",new GoodsMainBlockViewModel(n,e));var m="description";l.goods.AddBlock(m,n.description);if(n.description&&n.description.match(/data-bind/)){l.hasButton=m}},Gallery:function(o){var m=[];for(var n=0;n<=o.length-1;n++){m[n]=new GalleryBlockViewModel(o[n])}l.goods.AddBlock("gallery",m)},Seller:function(m){l.goods.sellerInfo.seller=m},Shop:function(m){l.goods.sellerInfo.shop=m},Operator:function(m){l.goods.sellerInfo.operator=m},Block:function(n,p){var q=new MoreBlockViewModel(n);if(n=="shipping"){var m=[];for(var o in p){m.push(new ShippingBlockViewModel(p[o]))}p=m}q.AddParams(p);l.goods.AddBlock(n,q)}};function i(m){d();l.RenderTemplate(m,e,function(n){if(l.hasButton){$.each(n.moreBlock,function(p){if(n.moreBlock[p].key==l.hasButton){var o=$("#"+n.moreBlock[p].idBlock+" [data-bind^=click]");$.each(o,function(q){if(n.blocks.main.showAddToCart()){if($(o[q]).attr("data-bind").match(/AddToCart/)){var s=new AddToCartButtonViewModel(n.blocks.main);ko.applyBindings(s,o[q])}}else{$(o[q]).hide()}if(n.blocks.main.showBuy()){if($(o[q]).attr("data-bind").match(/Buy/)){var r=new BuyButtonViewModel(n.blocks.main);ko.applyBindings(r,o[q])}}else{$(o[q]).hide()}})}})}h(n)},function(n){d();i(n)},function(){a()})}function h(o){var m=$.cookie(Config.Base.cookie.previously_viewed);if(!m){$.cookie(Config.Base.cookie.previously_viewed,o.id)}else{var n=m.split(",");var p=$.inArray(o.id,n);if(p>=0){n.splice(p,1);n.unshift(o.id)}else{n.unshift(o.id)}if(n.length>20){n.splice(20,1)}$.cookie(Config.Base.cookie.previously_viewed,n.join(","))}}};var TestGoods={Init:function(){if(typeof Widget=="function"){GoodsWidget.prototype=new Widget();var a=new GoodsWidget();a.Init(a)}else{setTimeout(function(){TestGoods.Init()},100)}}};TestGoods.Init();
var UserInformationWidget=function(){var n=this;n.widgetName="UserInformationWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=h;var g={container:{widget:"userInformationWidgetId",def:"defaultUserInformationWidgetId"},tmpl:{path:"userInformationTmpl.html",id:{info:"userInformationTmpl",auth:"authorizationLinkTmpl"}},message:{confirmLogOut:"Вы действительно хотите выйти?"},showBlocks:["login"],animate:typeof AnimateUserInformation=="function"?AnimateUserInformation:null};function h(){m();c();j()}function c(){var o=n.GetInputParameters("userInformation");if(!$.isEmptyObject(o)){g=n.UpdateSettings1(g,o);if(o.show){for(var p=0;p<=o.show.length-1;p++){if($.inArray(o.show[p],g.showBlocks)<0){g.showBlocks.push(o.show[p])}}}}Config.Containers.userInformation=g.container}function j(){n.BaseLoad.Tmpl(g.tmpl,function(){n.DispatchEvent("UInfo.tmpl")})}function m(){n.AddEvent("UInfo.tmpl",function(){n.BaseLoad.Login(false,false,false,function(o){i(o)})});n.AddEvent("w.auth.ok",function(o){i(o.request)});n.AddEvent("UInfo.logout",function(){n.BaseLoad.Logout(function(o){if(o.result=="ok"||o.result=="fail"){n.BaseLoad.LogoutForProxy();Routing.SetHash("default","Домашняя",{})}})});n.AddEvent("w.change.route",function(o){n.BaseLoad.Tmpl(g.tmpl,function(){n.DispatchEvent("UInfo.tmpl")})})}function i(o){if(Routing.IsDefault()&&n.HasDefaultContent()){n.WidgetLoader(true)}else{if(!o.err){b();f(o)}else{k();e()}}}function a(){n.ClearContainer(g)}function k(){n.InsertContainer(g,"auth")}function b(){n.InsertContainer(g,"info")}function e(){var o=new UserAuthorizationBlockViewModel();l(o)}function f(o){n.BaseLoad.MessageCountUnread(function(p){Parameters.cache.message.countNewMessage(parseInt(p.count_unread_topic));UserInformationBlockViewModel.prototype=new Widget();var q=new UserInformationBlockViewModel(o,g);d(q)})}function l(o){n.RenderTemplate(o,g,null,function(p){k();l(p)},function(){a()})}function d(o){n.RenderTemplate(o,g,null,function(p){b();d(p)},function(){a()})}};var UserAuthorizationBlockViewModel=function(){var a=this;a.ClickLogin=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{})};a.ClickRegistration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("registration","Регистрация пользователя",{step:1})}};var UserInformationBlockViewModel=function(d,c){var b=this;b.email=d.email;b.login=d.login;b.phone=d.phone;b.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);b.showIcon=function(){if(!d.route_icon_user||$.inArray("icon",c.showBlocks)<0){return false}return true};b.iconUser="";if(d.route_icon_user){b.iconUser=d.route_icon_user+"?"+EventDispatcher.HashCode(EventDispatcher.GetUUID())}b.background="";b.backgroundImage="";if(b.iconUser){b.background="background: url('"+b.iconUser+"')";b.backgroundImage="background-image: url('"+b.iconUser+"')"}b.showRaiting=function(){if($.inArray("raiting",c.showBlocks)<0){return false}return true};b.ratingUser=d.rating_user;b.showProfile=function(){if($.inArray("profile",c.showBlocks)<0){return false}return true};b.ClickLogout=function(){b.Confirm(c.message.confirmLogOut,function(){Loader.Indicator("UserInformationWidget",false);EventDispatcher.DispatchEvent("UInfo.logout")},false)};b.ClickPrivateOffice=function(){a("profile","Личный кабинет",{})};b.ClickMessages=function(){a("messages","Сообщения",{})};b.ClickFavorites=function(){a("favorites","Избранное",{})};b.ClickPurchases=function(){a("purchases","Мои покупки",{block:"list"})};b.ClickProfile=function(){a("profile","Личный кабинет",{})};function a(e,g,f){Routing.SetHash(e,g,f)}};var TestUserInformation={Init:function(){if(typeof Widget=="function"){UserInformationWidget.prototype=new Widget();var a=new UserInformationWidget();a.Init(a)}else{setTimeout(function(){TestUserInformation.Init()},100)}}};TestUserInformation.Init();
var CartWidget=function(){var k=this;k.widgetName="CartWidget";k.version=1;k.minWidgetVersion=1;k.maxWidgetVersion=2;k.minTmplVersion=1;k.maxTmplVersion=2;k.InitWidget=f;var d={container:{widget:"cartInfoWidgetId",def:"defaultCartInfoWidgetId"},cartId:"cart",tmpl:{path:"cartShopTmpl.html",id:"cartTmpl"},message:{title:"Корзина",cartGoodsTitle:"Моя корзина",maxIsReached:"Достигнут максимум"},showBlocks:{title:"always",count:true,baseCost:false,finalCost:false,fullInfo:false},animate:typeof AnimateCart=="function"?AnimateCart:null};function f(){b();j();i()}function b(){var l=k.GetInputParameters("cart");if(!$.isEmptyObject(l)){d=k.UpdateSettings1(d,l);if(l.show){for(var m in l.show){d.showBlocks[m]=l.show[m]}}}Config.Containers.cart=d.container}function a(){k.ClearContainer(d)}function h(){k.InsertContainer(d)}function g(){if(Routing.IsDefault()&&k.HasDefaultContent()){k.WidgetLoader(true)}else{k.BaseLoad.CartInfo("",function(l){if(d.showBlocks.fullInfo){k.BaseLoad.CartGoods("",function(m){h();c({info:l,goods:m})})}else{h();c({info:l})}})}}function i(){k.BaseLoad.Tmpl(d.tmpl,function(){g()})}function j(){k.AddEvent("w.auth.ok",function(){i()});k.AddEvent("w.change.route",function(l){i()});k.AddEvent("widgets.cart.infoUpdate",function(l){i()});k.AddEvent("widgets.cart.clear",function(m){var l=m.goodsId?m.goodsId:false;k.BaseLoad.ClearCart(m.sellerId,l,function(){k.DispatchEvent("CartGoods.clear.cartInfo."+m.sellerId+"."+l)})});k.AddEvent("Cart.change.count",function(l){k.BaseLoad.AddGoodsToCart(l.id,l.sellerId,l.ordered(),function(m){l.sellCost(m.sell_cost);l.sellEndCost(m.sell_end_cost);k.DispatchEvent("CartGoods.change.cartInfo."+l.sellerId+"."+l.id,l.ordered())})})}function c(l){var m=new CartViewModel(d);m.AddContent(l);e(m)}function e(l){k.RenderTemplate(l,d,null,function(m){h();e(m)},function(){a()})}};var CartViewModel=function(b){var a=this;a.title=b.message.title;a.goods=ko.observableArray();a.isAuthorized=ko.computed(function(){if(Parameters.cache.userInformation&&!Parameters.cache.userInformation.err){return true}return false},this);a.ShowTitle=ko.computed(function(){if(b.showBlocks.title=="never"){return false}if(b.showBlocks.title=="always"){return true}if(b.showBlocks.title=="empty"){return true}return false},this);a.count=ko.observable(0);a.ShowCount=ko.computed(function(){if(b.showBlocks.count&&a.count()>0){return true}return false},this);a.baseCost=ko.observable(0);a.ShowBaseCost=ko.computed(function(){if(b.showBlocks.baseCost&&a.baseCost()>0&&a.baseCost()>a.finalCost()){return true}return false},this);a.finalCost=ko.observable(0);a.ShowFinalCost=ko.computed(function(){if(b.showBlocks.finalCost&&a.finalCost()>0){return true}return false},this);a.ShowFullInfo=ko.computed(function(){if(b.showBlocks.fullInfo&&a.goods().length>0){return true}return false},this);a.AddContent=function(d){var e=d.info;var c=d.goods;if(!e.err){a.count(e.count);a.baseCost(e.base_cost);a.finalCost(e.final_cost)}if(c&&!c.err){ShortBlockCartGoodsSellersViewModel.prototype=new Widget();$.each(c,function(f){$.each(c[f].goods,function(g){a.goods.push(new ShortBlockCartGoodsSellersViewModel(c[f].goods[g],c[f].seller.id,a,b))})})}};a.ClickCart=function(){if(a.count()>0){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("cart",b.message.cartGoodsTitle,{})}};a.ClickIssueOrder=function(){if(a.count()>0){Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}}};var ShortBlockCartGoodsSellersViewModel=function(e,c,f,d){var a=this;a.id=e.id;a.fullName=e.full_name;a.countReserv=e.count_reserv;a.count=e.count;a.sellCost=ko.observable(e.sell_cost);a.sellEndCost=ko.observable(e.sell_end_cost);a.routeImages=e.route_image;a.routeBigImages=e.route_big_image;a.ordered=ko.observable(a.count);a.sellerId=c;a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(e.is_egoods=="yes"){return true}return false},this);a.CartItog=ko.computed(function(){var g=0;$.each(f.goods(),function(h){g=g+parseInt(f.goods()[h].endSum(),10)});f.finalCost(g);return g},this);a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);a.CartItog();f.count(f.count()+1);b("Cart.change.count",a)}else{a.ShowMessage(d.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);a.CartItog();f.count(f.count()-1);b("Cart.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){b("widgets.cart.clear",{goodsId:a.id,sellerId:c});f.goods.remove(a);f.count(f.count()-a.ordered())};function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var TestCart={Init:function(){if(typeof Widget=="function"){CartWidget.prototype=new Widget();var a=new CartWidget();a.Init(a)}else{setTimeout(function(){TestCart.Init()},100)}}};TestCart.Init();
var CartGoodsWidget=function(){var m=this;m.widgetName="CartGoodsWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.cart=null;m.InitWidget=e;var d={container:{widget:"content",def:"defaultCartGoodsWidgetId"},tmpl:{path:"cartGoodsTmpl.html",id:{content:"cartGoodsTmpl",empty:"emptyCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},showBlocks:[],animate:typeof AnimateCartGoods=="function"?AnimateCartGoods:null};function e(){k();b();i()}function b(){var n=m.GetInputParameters("cartGoods");if(!$.isEmptyObject(n)){d=m.UpdateSettings1(d,n)}Config.Containers.cartGoods=d.container}function i(){if(Routing.route=="cart"){m.BaseLoad.Tmpl(d.tmpl,function(){h()})}else{m.WidgetLoader(true)}}function k(){m.AddEvent("w.change.route",function(){i()});m.AddEvent("CartGoods.onload.info",function(n){if(!n.err){c();l.Content(n)}else{g();j()}});m.AddEvent("CartGoods.change.count",function(n){m.BaseLoad.AddGoodsToCart(n.id,n.sellerId,n.ordered(),function(o){m.DispatchEvent("widgets.cart.infoUpdate",o);n.sellCost(o.sell_cost);n.sellEndCost(o.sell_end_cost)})});m.AddEvent("CartGoods.clear",function(o){var n=o.goodsId?o.goodsId:false;m.BaseLoad.ClearCart(o.sellerId,n,function(p){m.DispatchEvent("widgets.cart.infoUpdate",p)})});m.AddEvent("CartGoods.empty.cart",function(){g();j()})}function h(){m.WidgetLoader(false);m.BaseLoad.InfoFavorite("no",function(n){Parameters.cache.favorite=n;m.BaseLoad.CartGoods("",function(o){m.DispatchEvent("CartGoods.onload.info",o)})})}function a(){m.ClearContainer(d)}function c(){m.InsertContainer(d,"content")}function g(){m.InsertContainer(d,"empty")}var l={Content:function(q){var p=new CartGoodsViewModel(d);for(var n in q){BlockGoodsForSellerViewModel.prototype=new Widget();m.cart=new BlockGoodsForSellerViewModel(p,d);for(var o in q[n]){if(typeof l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()]=="function"){l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()](q[n][o])}}p.AddContent(m.cart)}f(p)},Goods:function(n){m.cart.AddContent(n)},Seller:function(n){m.cart.sellerInfo.seller=n},Shop:function(n){m.cart.sellerInfo.shop=n},Operator:function(n){m.cart.sellerInfo.operator=n},Final_cost:function(n){m.cart.finalCost=n}};function f(n){m.RenderTemplate(n,d,null,function(o){c();f(o)},function(){a()},"content")}function j(){m.WidgetLoader(true);if(d.animate){d.animate()}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockGoodsForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].endSum())}}return f.toFixed(2)},this);a.totalSum=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].sum())}}return f.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.AddContent=function(f){for(var e=0;e<=f.length-1;e++){BlockCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCartGoodsSellersViewModel(f[e],a,d,c))}a.finalCost=f.final_cost};a.comment=ko.observable();a.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(a.goods(),function(f){if(f.isSelected()){e.push(f.id);f.IsFavorite(true)}});a.AddCommentForm(e)};a.AddCommentForm=function(e){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){var f=[];$.each(e,function(g){f[g]=e[g].id});b("w.fav.add",{goodsId:f.join(","),comment:a.comment(),data:e});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}for(var g in f){a.goods.remove(f[g])}b("CartGoods.clear",{goodsId:e.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){d.sellerBlock.remove(a)}if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){var e=Parameters.cache.lastPage;if(e.route!="cart"){Routing.SetHash(e.route,e.title,e.data)}else{Routing.SetHash("default","Домашняя",{})}};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation==null||(Parameters.cache.userInformation!=null&&Parameters.cache.userInformation.err)){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(c.message.confirmClearCart,function(){var g=a.goods().length-1;var e=[];for(var f=0;f<=g;f++){e.push(a.goods()[f])}for(var f in e){a.goods.remove(e[f])}d.sellerBlock.remove(a);b("CartGoods.clear",{sellerId:a.sellerInfo.shop.id});if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}})};a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods())[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(h){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(i){$("#"+i.cssCheckboxGoods())[0].checked=g;i.isSelected(g)})};a.isDisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return false}return true},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockCartGoodsSellersViewModel=function(f,h,d,c){var a=this;a.sellerId=h.sellerInfo.seller.id;a.id=f.id;a.fullName=f.full_name;a.countReserv=f.count_reserv;a.count=f.count;a.sellCost=ko.observable(f.sell_cost);a.sellEndCost=ko.observable(f.sell_end_cost);a.routeImages=f.route_image;a.routeBigImages=f.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(f.is_egoods=="yes"){return true}return false},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(k){var j=h.goods().length;var m=[];for(var l=0;l<=j-1;l++){if(h.goods()[l].isSelected()){m.push(h.goods()[l].id)}}if(m.length<j){$("#"+h.cssSelectAll)[0].checked=false}else{$("#"+h.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(i,k){var j=$("#"+i.cssCheckboxGoods());var l=j.is(":checked");if(l==false){j[0].checked=true;a.isSelected(true)}else{j[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var i=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(i>0){return i+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);b("CartGoods.change.count",a)}else{a.ShowMessage(c.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);b("CartGoods.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(c.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){b("CartGoods.clear",{goodsId:a.id,sellerId:a.sellerId});g()};a.AddCommentForm=function(){h.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){b("w.fav.add",{goodsId:a.id,comment:h.comment(),data:a});a.IsFavorite(true);$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}function g(){h.goods.remove(a);if(h.goods().length==0){d.sellerBlock.remove(h);if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}}}e("CartGoods.clear.cartInfo."+a.sellerId+"."+a.id,function(){g()});e("CartGoods.change.cartInfo."+a.sellerId+"."+a.id,function(i){a.ordered(i)});function e(i,j){EventDispatcher.AddEventListener(i,j)}function b(i,j){EventDispatcher.DispatchEvent(i,j)}};var TestCartGoods={Init:function(){if(typeof Widget=="function"){CartGoodsWidget.prototype=new Widget();var a=new CartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCartGoods.Init()},100)}}};TestCartGoods.Init();
var ProfileWidget=function(){var n=this;n.widgetName="ProfileWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=i;var w={container:{widget:"content",def:"defaultProfileWidgetId"},tmpl:{path:"profileTmpl.html",id:{personal:"personalInformationTmpl",delivery:"deliveryAddressTmpl",deliveryForm:"deliveryAddressFormTmpl",security:"securityTmpl"}},menu:{personalInformation:{title:"Персональные данные",prefix:"personal"},deliveryAddress:{title:"Адреса доставки",prefix:"delivery"},security:{title:"Безопасность",prefix:"security"}},regular:{email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,addressee:/^[a-zа-яёА-ЯЁA-Z\s]+$/,postIndex:/^[0-9]+$/},message:{sendToken:"Код активации успешно выслан по указанным данным.",failSendToken:"Код не был отправлен. Попробуйте повторить запрос позднее.",contactsEdit:"Данные успешно обновлены",failContactsEdit:"Данные не обновлены. Попробуйте повторить запрос позднее.",editProfile:"Данные успешно обновлены",failEditProfile:"Данные не обновлены. Попробуйте повторить запрос позднее.",changePassword:"Пароль успешно изменен.",failChangePassord:"Пароль не изменен.",addAddressDelivery:"Данные успешно сохранены.",failAddAddressDelivery:"Данные не сохранены. Попробуйте повторить запрос позднее.",deleteAddressDelivery:"Адрес доставки успешно удален.",confirmDeleteAddressDelivery:"Вы уверены, что хотите удалить адрес?",failDeleteAddressDelivery:"Адрес доставки не удален. Попробуйте повторить запрос позднее.",setDefaultDelivery:"Данные успешно обновлены.",failSetDefaultDelivery:"Данные не обновлены."},error:{iconUser:{extension:"Раширение фала должно быть jpeg, png или gif"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},phone:{empty:"Поле обязательно для заполнения",regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},addressee:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"}},animate:typeof AnimateProfile=="function"?AnimateProfile:null,geoShop:0};function i(){A();j();n.CheckRouteProfile()}function A(){var C=n.GetInputParameters("profile");if(!$.isEmptyObject(C)){w=n.UpdateSettings1(w,C)}Config.Containers.profile=w.container}n.CheckRouteProfile=function(){if(Routing.route=="profile"){n.WidgetLoader(false);n.BaseLoad.Login(false,false,false,function(C){if(!C.err){Loader.Indicator("MenuPersonalCabinetWidget",false);n.BaseLoad.Tmpl(w.tmpl,function(){var D=Routing.params,E=w.menu;if(!D.info||D.info==E.personalInformation.prefix){k()}if(D.info==E.deliveryAddress.prefix&&!D.form){d()}if(D.info==E.deliveryAddress.prefix&&D.form=="add"){x()}if(D.info==E.security.prefix){e()}o()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});n.WidgetLoader(true)}})}else{n.WidgetLoader(true)}};function j(){n.AddEvent("w.change.route",function(){n.CheckRouteProfile()});n.AddEvent("Profile.personal.checking",function(E){var D=E.birthDayField().split(".");var C=D[2]+"-"+D[1]+"-"+D[0];E.birthDayHiddenField(C);n.BaseLoad.EditProfile($("form#"+E.cssRegistrationDataForm),function(F){if(F.result=="ok"){n.ShowMessage(w.message.editProfile,function(){Parameters.cache.profile.personal={};Parameters.cache.userInformation=null;Parameters.cache.profile.info={};window.location.reload(true)},false)}else{if(!F.err){F.err=w.message.failEditProfile}n.QueryError(F,function(){n.DispatchEvent("Profile.personal.checking",E)})}})});n.AddEvent("Profile.postalAddress.checking",function(C){var D="?id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+PrepareDatam(C.postIndex());n.BaseLoad.EditAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.editProfile,function(){Parameters.cache.profile.personal={};C.countryText(C.country().name);C.regionText(C.customRegion());C.cityText(C.customCity());C.addressText(C.customAddress());C.postIndexText(C.postIndex());C.isEditBlock(0)},false)}else{if(!E.err){E.err=w.message.failEditProfile}n.QueryError(E,function(){n.DispatchEvent("Profile.postalAddress.checking",C)})}})});n.AddEvent("Profile.send.token",function(C){n.BaseLoad.SendToken(C,function(D){if(D.result=="ok"){n.ShowMessage(w.message.sendToken,false,false)}else{if(!D.err){D.err=w.message.failSendToken}n.QueryError(D,function(){n.DispatchEvent("Profile.send.token",C)})}})});n.AddEvent("Profile.submit.token",function(D){var C=Parameters.cache.userInformation;var F=[];F.push("username="+b(C.login));if(D.type=="mail"){F.push("mail_token="+D.value.emailToken())}if(D.type=="sms"){F.push("sms_token="+D.value.phoneToken())}var E="?"+F.join("&");n.BaseLoad.ActivateUser(E,function(G){Parameters.cache.profile.info={};if(n.QueryError(G,function(){n.DispatchEvent("Profile.submit.token",D)})){if(l(G,D.value)){D.value.emailIsConfirm(true)}if(t(G,D.value)){D.value.phoneIsConfirm(true)}}})});n.AddEvent("Profile.contacts.checking",function(C){var D="?";if(C.email()&&!C.emailIsConfirm()){D=D+"email="+b(C.email())}if(C.phone()){D=D+"&phone="+b(C.phone())}n.BaseLoad.EditContacts(D,function(E){if(E.result=="ok"){C.sentCode(true);setTimeout(function(){C.isExistPhone(true)},60000);C.sentEmailCode(true);setTimeout(function(){C.isExistMail(true)},60000);n.ShowMessage(w.message.contactsEdit,false,false)}else{if(!E.err){E.err=w.message.failContactsEdit}n.QueryError(E,function(){n.DispatchEvent("Profile.contacts.checking",C)})}})});n.AddEvent("Profile.password.change",function(C){n.BaseLoad.ChangePassword($("form#"+C.cssSequrityForm),function(D){if(D.result=="ok"){C.oldPassword(null);C.newPassword(null);C.confirmPassword(null);n.ShowMessage(w.message.changePassword,false,false)}else{if(!D.err){D.err=w.message.failChangePassord}n.QueryError(D,function(){n.DispatchEvent("Profile.password.change",C)},function(){C.oldPassword(null);C.newPassword(null);C.confirmPassword(null)})}})});n.AddEvent("Profile.delivery.add",function(C){var D="?id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+b(C.postIndex())+"&addressee="+b(C.addressee())+"&contact_phone="+b(C.contactPhone())+"&is_default="+encodeURIComponent(C.isDefault()?"yes":"no");n.BaseLoad.AddDelivaryAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!E.err){E.err=w.message.failAddAddressDelivery}n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.add",C)})}})});n.AddEvent("Profile.delivery.saveEdit",function(C){var D="?id_address="+C.id()+"&id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+b(C.postIndex())+"&addressee="+b(C.addressee())+"&contact_phone="+b(C.contactPhone())+"&is_default="+encodeURIComponent(C.isDefault()?"yes":"no");n.BaseLoad.EditDelivaryAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!E.err){E.err=w.message.failAddAddressDelivery}n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.add",C)})}})});n.AddEvent("Profile.delivery.delete",function(C){n.BaseLoad.DeleteDeliveryAddress(C.address.id,function(D){if(D.result=="ok"){n.ShowMessage(w.message.deleteAddressDelivery,function(){Parameters.cache.delivery=null;C.list.addressList.remove(C.address)},false)}else{if(!D.err){D.err=w.message.failDeleteAddressDelivery}n.QueryError(D,function(){n.DispatchEvent("Profile.delivery.delete",C)})}})});n.AddEvent("Profile.delivery.edit",function(C){n.BaseLoad.Script(PokupoWidgets.model.content,function(){var D=new DeliveryAddressFormViewModel();D.AddContent(C);p(D)})});n.AddEvent("Profile.delivery.sedDefault",function(C){var D="?id_address="+C.id+"&is_default=yes";n.BaseLoad.SetDefaultDelivaryAddress(D,function(E){if(E.result=="ok"){}else{n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.sedDefault",C)})}})})}function b(C){return encodeURIComponent($.trim(C))}function l(D,C){if(D.confirm_email){if(D.confirm_email=="no"){C.errorEmailConfirm(w.error.emailToken.confirm);return false}return true}return false}function t(D,C){if(D.confirm_phone){if(D.confirm_phone=="no"){C.errorPhoneConfirm(w.error.phoneToken.confirm);return false}return true}return false}function o(){n.BaseLoad.Script(PokupoWidgets.model.menu,function(){if(!Routing.params.info){Routing.params.info=w.menu.personalInformation.prefix}n.DispatchEvent("w.onload.menu",{menu:w.menu,active:Routing.params.info})})}function k(){c();n.BaseLoad.Script(PokupoWidgets.model.content,function(){n.BaseLoad.Profile(function(C){n.BaseLoad.ProfileInfo(function(D){a(C,D)})})})}function d(){n.BaseLoad.DeliveryAddressList(function(C){u();r(C)})}function x(){n.BaseLoad.Script(PokupoWidgets.model.content,function(){var C=new DeliveryAddressFormViewModel(w);p(C)})}function e(){g();q()}function v(){n.ClearContainer(w)}function c(){n.InsertContainer(w,"personal")}function u(){n.InsertContainer(w,"delivery")}function h(){n.InsertContainer(w,"deliveryForm")}function g(){n.InsertContainer(w,"security")}function a(F,D){var C=new ProfilePersonalInformationViewModel(w);var E=Parameters.shopId;if(w.geoShop==0){E=0}n.BaseLoad.Country(E,function(G){C.AddContent(F,D,G);y(C)})}function r(C){var D=new ProfileDeliveryAddressViewModel(w);D.AddContent(C);s(D)}function p(D){var C=Parameters.shopId;if(w.geoShop==0){C=0}n.BaseLoad.Country(C,function(E){D.AddCountryList(E);h();B(D)})}function q(){var C=new ProfileSecurityViewModel(w);m(C)}function y(C){n.RenderTemplate(C,w,function(D){z(D);if(w.animate){w.animate(D.postalAddress.country)}},function(D){c();y(D)},function(){v()},"delivery")}function s(C){n.RenderTemplate(C,w,null,function(D){u();s(D)},function(){v()},"delivery")}function B(C){n.RenderTemplate(C,w,function(D){f(D);if(w.animate){w.animate(D.country)}},function(D){h();B(D)},function(){v()},"deliveryForm")}function m(C){n.RenderTemplate(C,w,null,function(D){g();m(D)},function(){v()},"security")}function z(D){var C=D.postalAddress;$("#"+C.cssCountryList).change(function(){var E=$("#"+C.cssCountryList+" option:selected").val();$.grep(C.countryList(),function(F){if(F.id==E){C.country(F);C.customRegion(null);C.region(null);C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)}})});$("#"+C.cssRegionList).autocomplete({source:function(F,E){n.BaseLoad.Region(C.country().id+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.formalname+" "+H.shortname),region:H}}))}else{$("#"+C.cssRegionList).autocomplete("close");return false}})},select:function(E,F){C.region(F.item.region);C.customRegion(F.item.value);if(F.item.region&&F.item.region.postalcode!=0){C.postIndex(F.item.region.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCityList).autocomplete({source:function(F,E){if(C.region()){n.BaseLoad.City(C.country().id+"/"+b(C.region().regioncode)+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.shortname+". "+H.formalname),city:H}}))}else{$("#"+C.cssCityList).autocomplete("close");return false}})}},select:function(E,F){C.city(F.item.city);C.customCity(F.item.value);if(F.item.city&&F.item.city.postalcode!=0){C.postIndex(F.item.city.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssAddress).autocomplete({source:function(F,E){if(C.region()){n.BaseLoad.Street(C.country().id+"/"+b(C.region().regioncode)+"/"+b(C.city().aoguid)+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.shortname+". "+H.formalname),street:H}}))}else{$("#"+C.cssAddress).autocomplete("close");return false}})}},select:function(E,F){C.address(F.item.street);C.customAddress(F.item.value);if(F.item.street&&F.item.street.postalcode!=0){C.postIndex(F.item.street.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssRegionList).bind("textchange",function(F,E){C.customRegion($(this).val());C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)});$("#"+C.cssCityList).bind("textchange",function(F,E){C.customCity($(this).val());C.customAddress(null);C.address(null);C.postIndex(null)});if(Routing.params.edit=="postal_address"){n.ScrollTop(C.cssPostAddressForm,700)}}function f(C){$("#"+C.cssRegionList).autocomplete({source:function(E,D){n.BaseLoad.Region(C.country().id+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.formalname+" "+G.shortname),region:G}}))}else{$("#"+C.cssRegionList).autocomplete("close");return false}})},select:function(D,E){C.region(E.item.region);C.customRegion(E.item.value);if(E.item.region&&E.item.region.postalcode!=0){C.postIndex(E.item.region.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCityList).autocomplete({source:function(E,D){if(C.region()){n.BaseLoad.City(C.country().id+"/"+b(C.region().regioncode)+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.shortname+". "+G.formalname),city:G}}))}else{$("#"+C.cssCityList).autocomplete("close");return false}})}},select:function(D,E){C.city(E.item.city);C.customCity(E.item.value);if(E.item.city&&E.item.city.postalcode!=0){C.postIndex(E.item.city.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssAddress).autocomplete({source:function(E,D){if(C.region()){n.BaseLoad.Street(C.country().id+"/"+b(C.region().regioncode)+"/"+b(C.city().aoguid)+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.shortname+". "+G.formalname),street:G}}))}else{$("#"+C.cssAddress).autocomplete("close");return false}})}},select:function(D,E){C.address(E.item.street);C.customAddress(E.item.value);if(E.item.street&&E.item.street.postalcode!=0){C.postIndex(E.item.street.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCountryList).change(function(){var D=$("#"+C.cssCountryList+" option:selected").val();$.grep(C.countryList(),function(E){if(E.id==D){C.country(E);C.customRegion(null);C.region(null);C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)}})});$("#"+C.cssRegionList).bind("textchange",function(E,D){C.customRegion($(this).val());C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)});$("#"+C.cssCityList).bind("textchange",function(E,D){C.customCity($(this).val());C.customAddress(null);C.address(null);C.postIndex(null)})}};var ProfilePersonalInformationViewModel=function(b){var a=this;a.registrationData=null;a.postalAddress=null;a.contacts=null;a.AddContent=function(g,d,h){var f=new ProfileDataRegistrationViewModel(b);if(!g.err){f.AddContent(g)}f.dateRegistration(d.date_reg);a.registrationData=f;var e=new ProfilePostalAddressViewModel(b);e.AddCountryList(h);if(!g.err){e.AddContent(g)}a.postalAddress=e;a.contacts=new ProfileContactsViewModel(b);a.contacts.AddContent()}};var ProfileDataRegistrationViewModel=function(e){var c=this;c.data=null;c.username=ko.observable();c.dateRegistration=ko.observable();c.gender=ko.observable();c.genderText=ko.computed(function(){if(c.gender()=="m"){return"мужской"}else{return"женский"}},this);c.errorGender=ko.observable(null);c.lastName=ko.observable();c.firstName=ko.observable();c.middleName=ko.observable();c.fullName=ko.computed(function(){var i="";if(c.lastName()){i=i+c.lastName()}if(c.firstName()){i=i+" "+c.firstName()}if(c.middleName()){i=i+" "+c.middleName()}return i},this);c.birthDay=ko.observable();c.cssBirthDay="birthDay";c.rating=ko.observable();c.checkInfo=ko.observable();c.lastNameField=ko.observable();c.firstNameField=ko.observable();c.middleNameField=ko.observable();c.birthDayField=ko.observable();c.birthDayHiddenField=ko.observable();c.errorLastName=ko.observable(null);c.errorFirstName=ko.observable(null);c.errorMiddleName=ko.observable(null);c.errorBirthDay=ko.observable(null);c.isEditBlock=ko.observable(0);c.iconUser=ko.observable();c.cssIconUser="avatar_file";c.errorIconUser=ko.observable(null);c.cssRegistrationDataForm="profile_registration_data_form";function h(){var i=true;if(!g()){i=false}if(!d()){i=false}if(!a()){i=false}if(!b()){i=false}if(!f()){i=false}return i}function g(){var j=$("#"+c.cssIconUser).val();if(j){var i=j.split(".");var k=i[i.length-1];k=k.toLowerCase();if($.inArray(k,["jpeg","jpg","png","gif"])<0){c.errorIconUser(e.error.iconUser.extension);return false}}c.errorIconUser(null);return true}function d(){var i=e.error.firstName;if(!c.firstNameField()){c.errorFirstName(i.empty);return false}if(c.firstNameField().length<2){c.errorFirstName(i.minLength);return false}if(c.firstNameField().length>20){c.errorFirstName(i.maxLength);return false}if(!e.regular.firstName.test(c.firstNameField())){c.errorFirstName(i.regular);return false}c.errorFirstName(null);return true}function a(){var i=e.error.lastName;if(!c.lastNameField()){c.errorLastName(i.empty);return false}if(c.lastNameField().length<2){c.errorLastName(i.minLength);return false}if(c.lastNameField().length>20){c.errorLastName(i.maxLength);return false}if(!e.regular.lastName.test(c.lastNameField())){c.errorLastName(i.regular);return false}c.errorLastName(null);return true}function b(){var i=e.error.middleName;if(c.middleNameField()){if(c.middleNameField().length<2){c.errorMiddleName(i.minLength);return false}if(c.middleNameField().length>20){c.errorMiddleName(i.maxLength);return false}if(!e.regular.middleName.test(c.middleNameField())){c.errorMiddleName(i.regular);return false}}c.errorMiddleName(null);return true}function f(){var k=e.error.birthDay;if(!c.birthDayField()){c.errorBirthDay(k.empty);return false}if(!e.regular.birthDay.test(c.birthDayField())){c.errorBirthDay(k.regular);return false}var m=c.birthDayField().split(".");var j=new Date(m[2],m[1]-1,m[0]);var i=new Date();var l=new Date(i.getYear()-18,i.getMonth(),i.getDate());if(l<j){c.errorBirthDay(k.minDate);return false}var i=new Date();var n=new Date(i.getYear()-101,i.getMonth(),i.getDate());if(n>j){c.errorBirthDay(k.maxDate);return false}c.errorBirthDay(null);return true}c.AddContent=function(j){c.data=j;var i=Parameters.cache.profile.info;if(i.route_icon_user){c.iconUser(i.route_icon_user+"?"+EventDispatcher.HashCode(EventDispatcher.GetUUID()))}c.username(i.login);c.gender(j.gender);c.lastName(j.f_name);c.firstName(j.s_name);c.middleName(j.m_name);c.birthDay(j.birth_day);c.rating(i.rating_user);c.lastNameField(c.data.s_name);c.firstNameField(c.data.f_name);c.middleNameField(c.data.m_name);c.birthDayField(c.data.birth_day);c.checkInfo(j.check_info)};c.isNew=function(){if(data){return false}return true};c.Edit=function(){c.isEditBlock(1)};c.Back=function(){c.lastNameField(c.data.f_name);c.firstNameField(c.data.s_name);c.middleNameField(c.data.m_name);c.birthDayField(c.data.birth_day);c.isEditBlock(0)};c.Submit=function(){if(h()){EventDispatcher.DispatchEvent("Profile.personal.checking",c)}};c.ClickItem=function(j,i){c.gender(j)}};var ProfilePostalAddressViewModel=function(e){var a=this;a.data=null;a.cssPostAddressForm="profile_postal_address_form";a.countryText=ko.observable();a.idCountry=ko.observable();a.country=ko.observable();a.cssCountryList="country_list_profile";a.errorCountry=ko.observable(null);a.regionText=ko.observable();a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="region_list";a.errorRegion=ko.observable(null);a.showRegion=ko.computed(function(){if(a.country()){return false}return true},this);a.cityText=ko.observable();a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="city_list";a.errorCity=ko.observable(null);a.showCity=ko.computed(function(){if(a.customRegion()){return false}return true},this);a.addressText=ko.observable();a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="address";a.errorAddress=ko.observable(null);a.showAddress=ko.computed(function(){if(a.customCity()){return false}return true},this);a.postIndexText=ko.observable();a.postIndex=ko.observable();a.cssPostIndex="post_index";a.errorPostIndex=ko.observable(null);a.showPostIndex=ko.computed(function(){if(a.customAddress()){return false}return true},this);a.checkInfo=ko.observable();a.countryList=ko.observableArray();a.isEditBlock=ko.observable(0);a.AddContent=function(i){a.data=i;a.idCountry(i.id_country);a.countryText(i.country);$.grep(a.countryList(),function(j){if(i.id_country==j.id){a.country(j)}});a.regionText(i.region);a.region({regioncode:i.code_region});a.customRegion(i.region);a.cityText(i.city);a.city({aoguid:i.code_city});a.customCity(i.city);a.addressText(i.address);a.address(i.address);a.customAddress(i.address);a.postIndexText(i.post_code);a.postIndex(i.post_code);a.checkInfo(i.check_info);if(Routing.params.edit=="postal_address"){a.isEditBlock(1)}};a.AddCountryList=function(k){if(k.length>0){for(var j=0;j<=k.length-1;j++){a.countryList.push(new CountryListViewModel(k[j]))}}};a.Edit=function(){a.isEditBlock(1)};a.Back=function(){a.idCountry(a.data.id_country);a.region({regioncode:a.data.code_region});a.customRegion(a.data.region);a.city({aoguid:a.data.code_city});a.customCity(a.data.city);a.address(a.data.address);a.customAddress(a.data.address);a.postIndexText(a.data.post_code);a.postIndex(a.data.post_code);a.checkInfo(a.data.check_info);a.isEditBlock(0)};a.Submit=function(){if(h()){EventDispatcher.DispatchEvent("Profile.postalAddress.checking",a)}};function h(){var i=true;if(!g()){i=false}if(!f()){i=false}if(!d()){i=false}if(!c()){i=false}if(!b()){i=false}return i}function g(){if(!a.country()){a.errorCountry(e.error.country.empty);return false}a.errorCountry(null);return true}function f(){if(!a.customRegion()){a.errorRegion(e.error.region.empty);return false}a.errorRegion(null);return true}function d(){if(!a.customCity()){a.errorCity(e.error.city.empty);return false}a.errorCity(null);return true}function c(){if(!a.customAddress()){a.errorAddress(e.error.address.empty);return false}a.errorAddress(null);return true}function b(){var i=e.error.postIndex;if(!a.postIndex()){a.errorPostIndex(i.empty);return false}if(5>a.postIndex().length||a.postIndex().length>6){a.errorPostIndex(i.length);return false}if(!e.regular.postIndex.test(a.postIndex())){a.errorPostIndex(i.regular);return false}a.errorPostIndex(null);return true}};var ProfileContactsViewModel=function(f){var d=this;d.email=ko.observable();d.isExistEmail=ko.observable();d.sentEmailCode=ko.observable();d.emailToken=ko.observable();d.errorEmail=ko.observable(null);d.errorEmailToken=ko.observable(null);d.emailIsConfirm=ko.observable(false);d.phone=ko.observable();d.cssPhone="phone_profile";d.isExistPhone=ko.observable();d.sentCode=ko.observable();d.phoneToken=ko.observable();d.errorPhone=ko.observable(null);d.errorPhoneToken=ko.observable(null);d.phoneIsConfirm=ko.observable(false);d.AddContent=function(){var i=Parameters.cache.profile.info;if(i.confirm_phone=="yes"){d.phoneIsConfirm(true)}if(i.confirm_email=="yes"){d.emailIsConfirm(true)}if(i.phone){d.phone(i.phone);d.isExistPhone(true)}if(i.email){d.email(i.email);d.isExistEmail(true)}};function g(){var i=true;if(!a()){i=false}if(!h()){i=false}return i}function a(){var i=f.error.email;if(!d.email()){d.errorEmail(i.empty);return false}if(d.email().length>64){d.errorEmail(i.maxLength);return false}if(!f.regular.email.test(d.email())){d.errorEmail(i.regular);return false}d.errorEmail(null);return true}function h(){var i=f.error.phone;if(d.emailIsConfirm()){if(!d.phone()){d.errorPhone(i.empty);return false}}if(d.phone()){if(!f.regular.phone.test($.trim(d.phone()))){d.errorPhone(i.regular);return false}}d.errorPhone(null);return true}function c(){var i=$.trim(d.emailToken());d.emailToken(i);if(!d.emailToken()){d.errorEmailToken(f.error.emailToken.empty);return false}d.errorEmailToken(null);return true}function b(){var i=$.trim(d.phoneToken());d.phoneToken(i);if(!d.phoneToken()){d.errorPhoneToken(f.error.phoneToken.empty);return false}d.errorPhoneToken(null);return true}d.SendMailToken=function(){d.sentEmailCode(true);d.isExistEmail(false);setTimeout(function(){d.isExistEmail(true)},60000);e("Profile.send.token","mail")};d.SendPhoneToken=function(){d.sentCode(true);d.isExistPhone(false);setTimeout(function(){d.isExistPhone(true)},60000);e("Profile.send.token","sms")};d.SubmitMailToken=function(){if(c()){e("Profile.submit.token",{type:"mail",value:d})}};d.SubmitPhoneToken=function(){if(b()){e("Profile.submit.token",{type:"sms",value:d})}};d.SubmitForm=function(){if(g()){e("Profile.contacts.checking",d)}};function e(i,j){EventDispatcher.DispatchEvent(i,j)}};var ProfileDeliveryAddressViewModel=function(b){var a=this;a.addressList=ko.observableArray();a.cssAddressList="delivary_address_list";a.checked=ko.observable();a.ClickAddAddress=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery",form:"add"})};a.AddContent=function(d){for(var c in d){DeliveryAddressViewModel.prototype=new Widget();a.addressList.push(new DeliveryAddressViewModel(d[c],a,b))}}};var DeliveryAddressViewModel=function(e,d,c){var a=this;a.id=e.id;a.idCountry=e.id_country;a.country=e.country;a.codeRegion=e.code_region;a.region=e.region;a.codeCity=e.code_city;a.city=e.city;a.postIndex=e.post_code;a.address=e.address;a.addressee=e.addressee;a.list=d.addressList();if(e.is_default=="yes"){a.isDefault=ko.observable(true);a.cssIsDefault=ko.observable("delivery_address_is_default active");d.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.contactPhone=e.contact_phone;a.Edit=function(){if(a.id){b("Profile.delivery.edit",a)}else{Routing.SetHash("profile","Личный кабинет",{info:"personal",edit:"postal_address"})}};a.Delete=function(){a.Confirm(c.message.confirmDeleteAddressDelivery,function(){b("Profile.delivery.delete",{address:a,list:d})},false)};a.ClickItem=function(){$.each(a.list,function(f){a.list[f].cssIsDefault("delivery_address_is_default");a.list[f].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);d.checked(a.id);b("Profile.delivery.sedDefault",a)};function b(f,g){EventDispatcher.DispatchEvent(f,g)}};var DeliveryAddressFormViewModel=function(e){var j=this;j.id=ko.observable();j.idCountry=ko.observable();j.country=ko.observable();j.cssCountryList="delivery_country_list";j.errorCountry=ko.observable(null);j.codeRegion=ko.observable();j.region=ko.observable();j.customRegion=ko.observable();j.cssRegionList="delivery_region";j.errorRegion=ko.observable(null);j.showRegion=ko.computed(function(){if(j.country()){return false}return true},this);j.codeCity=ko.observable();j.city=ko.observable();j.customCity=ko.observable();j.cssCityList="delivery_city";j.errorCity=ko.observable(null);j.showCity=ko.computed(function(){if(j.customRegion()){return false}return true},this);j.address=ko.observable();j.customAddress=ko.observable();j.cssAddress="delivery_cssAddress";j.errorAddress=ko.observable(null);j.showAddress=ko.computed(function(){if(j.customCity()){return false}return true},this);j.postIndex=ko.observable();j.cssPostCode="delivery_post_index";j.errorPostCode=ko.observable(null);j.showPostIndex=ko.computed(function(){if(j.customAddress()){return false}return true},this);j.addressee=ko.observable();j.errorAddressee=ko.observable(null);j.contactPhone=ko.observable();j.cssContactPhone="delivery_contact_phone";j.errorContactPhone=ko.observable(null);j.isDefault=ko.observable();j.countryList=ko.observableArray();j.AddCountryList=function(l){if(l.length>0){for(var k=0;k<=l.length-1;k++){j.countryList.push(new CountryListViewModel(l[k]));if(l[k].id==j.idCountry()){j.country(l[k])}}}};j.AddContent=function(k){j.id(k.id);j.idCountry=ko.observable(k.idCountry);j.region({regioncode:k.codeRegion});j.customRegion(k.region);j.city({aoguid:k.codeCity});j.customCity(k.city);j.postIndex(k.postIndex);j.customAddress(k.address);j.addressee(k.addressee);j.isDefault(k.isDefault());j.contactPhone(k.contactPhone)};j.Submit=function(){if(d()){EventDispatcher.DispatchEvent("Profile.delivery.add",j)}};j.Edit=function(){if(d()){EventDispatcher.DispatchEvent("Profile.delivery.saveEdit",j)}};function d(){var k=true;if(!i()){k=false}if(!h()){k=false}if(!g()){k=false}if(!c()){k=false}if(!a()){k=false}if(!f()){k=false}if(!b()){k=false}return k}function g(){if(!j.country()){j.errorCountry(e.error.country.empty);return false}j.errorCountry(null);return true}function c(){if(!j.customRegion()){j.errorRegion(e.error.region.empty);return false}j.errorRegion(null);return true}function a(){if(!j.customCity()){j.errorCity(e.error.city.empty);return false}j.errorCity(null);return true}function f(){if(!j.customAddress()){j.errorAddress(e.error.address.empty);return false}j.errorAddress(null);return true}function b(){var k=e.error.postIndex;if(!j.postIndex()){j.errorPostCode(k.empty);return false}if(5>j.postIndex().length||j.postIndex().length>6){j.errorPostCode(k.length);return false}if(!e.regular.postIndex.test(j.postIndex())){j.errorPostCode(k.regular);return false}j.errorPostCode(null);return true}function h(){var k=e.error.addressee;if(!j.addressee()){j.errorAddressee(k.empty);return false}if(j.addressee().length<3){j.errorAddressee(k.minLength);return false}if(j.addressee().length>40){j.errorAddressee(k.maxLength);return false}if(!e.regular.addressee.test(j.addressee())){j.errorAddressee(k.regular);return false}j.errorAddressee(null);return true}function i(){var k=e.error.phone;if(!j.contactPhone()){j.errorContactPhone(k.empty);return false}if(!e.regular.phone.test($.trim(j.contactPhone()))){j.errorContactPhone(k.regular);return false}j.errorContactPhone(null);return true}j.Back=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery"})}};var ProfileSecurityViewModel=function(d){var b=this;b.cssSequrityForm="profile_sequrity_form";b.oldPassword=ko.observable();b.cssOldPassword="profile_old_password";b.errorOldPassword=ko.observable(null);b.newPassword=ko.observable();b.cssNewPassword="profile_new_password";b.errorNewPassword=ko.observable(null);b.confirmPassword=ko.observable();b.cssConfirmPassword="profile_confirm_password";b.errorConfirmPassword=ko.observable(null);b.Submit=function(){if(e()){EventDispatcher.DispatchEvent("Profile.password.change",b)}};function e(){var g=true;if(!f()){g=false}if(!a()){g=false}if(!c()){g=false}return g}function f(){var g=d.error.password;b.oldPassword($("input#"+b.cssOldPassword).val());if(!b.oldPassword()){b.errorOldPassword(g.empty);return false}if(b.oldPassword().length<6){b.errorOldPassword(g.minLength);return false}if(b.oldPassword().length>64){b.errorOldPassword(g.maxLength);return false}b.errorOldPassword(null);return true}function a(){var g=d.error.password;b.newPassword($("input#"+b.cssNewPassword).val());if(!b.newPassword()){b.errorNewPassword(g.empty);return false}if(b.newPassword().length<6){b.errorNewPassword(g.minLength);return false}if(b.newPassword().length>64){b.errorNewPassword(g.maxLength);return false}b.errorNewPassword(null);return true}function c(){var g=d.error.password;b.confirmPassword($("input#"+b.cssConfirmPassword).val());if(!b.confirmPassword()){b.errorConfirmPassword(g.empty);return false}if(b.newPassword()!=b.confirmPassword()){b.errorConfirmPassword(g.equal);return false}b.errorConfirmPassword(null);return true}};var TestProfile={Init:function(){if(typeof Widget=="function"){ProfileWidget.prototype=new Widget();var a=new ProfileWidget();a.Init(a)}else{setTimeout(function(){TestProfile.Init()},100)}}};TestProfile.Init();
var FavoritesWidget=function(){var m=this;m.widgetName="FavoritesWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.favorites=null;m.InitWidget=f;var d={container:{widget:"content",def:"defaultFavoritesWidgetId"},title:"Избранное",tmpl:{path:"favoritesTmpl.html",id:{content:"favoritesTmpl",empty:"emptyFavoritesTmpl"}},showBlocks:["infoShop","addToCart","buy"],message:{clearGoods:"Выбранные товары удалены из избранного.",failClearGoods:"Произошла ошибка при удалении товара из избранного. Попробуйте еще раз.",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из избранного?",confirmRemove:"Вы уверены что хотите удалить товар из избранного?",confirmClearFavorites:"Вы уверены, что хотите очистить избранное от товаров?"},animate:typeof AnimateFavorite=="function"?AnimateFavorite:null};function f(){k();b();m.CheckRouteFavorites()}function b(){var n=m.GetInputParameters("favorites");if(!$.isEmptyObject(n)){d=m.UpdateSettings1(d,n);if(n.show){for(var o=0;o<=d.showBlocks.length-1;o++){if($.inArray(d.showBlocks[o],n.show)<0){d.showBlocks.splice(d.showBlocks.indexOf(d.showBlocks[o]),1)}}}}Config.Containers.favorites=d.container}m.CheckRouteFavorites=function(){if(Routing.route=="favorites"){m.BaseLoad.Login(false,false,false,function(n){if(!n.err){m.BaseLoad.Tmpl(d.tmpl,function(){e();j()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});m.WidgetLoader(true)}})}else{m.WidgetLoader(true)}};function k(){m.AddEvent("w.change.route",function(){m.CheckRouteFavorites()});m.AddEvent("Favorites.empty",function(){h();i()});m.AddEvent("Favorites.clear.one",function(n){var o="?idGoods="+n.goods.id;m.BaseLoad.ClearFavorite(o,function(p){if(p.result=="ok"){m.ShowMessage(d.message.clearGoods,function(){n.block.goods.remove(n.goods);if(n.block.goods().length==0){n.content.content.remove(n.block);if(n.content.content().length==0){m.DispatchEvent("Favorites.empty")}}},false)}else{if(!p.err){p.err=d.message.failClearGoods}m.QueryError(p,function(){m.DispatchEvent("Favorites.clear.one",n)})}})});m.AddEvent("Favorites.clear.all",function(n){var o="?idGoods="+n.ids;m.BaseLoad.ClearFavorite(o,function(p){if(p.result=="ok"){m.ShowMessage(d.message.clearGoods,function(){for(var q in n.goods){n.block.goods.remove(n.goods[q])}if(n.block.goods().length==0){n.content.content.remove(n.block)}if(n.content.content().length==0){m.DispatchEvent("Favorites.empty")}},false)}else{if(!p.err){p.err=d.message.failClearGoods}m.QueryError(p,function(){m.DispatchEvent("Favorites.clear.all",n)})}})})}function j(){m.WidgetLoader(false);m.BaseLoad.InfoFavorite("yes",function(n){if(!n.err){c();l.Content(n)}else{h();i()}})}function e(){m.BaseLoad.Script(PokupoWidgets.model.menu,function(){m.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){m.ClearContainer(d)}function c(){m.InsertContainer(d,"content")}function h(){m.InsertContainer(d,"empty")}var l={Content:function(q){var p=new FavoritesViewModel();for(var n in q){BlockFavoritesForSellerViewModel.prototype=new Widget();m.favorites=new BlockFavoritesForSellerViewModel(p,d);for(var o in q[n]){if(typeof l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()]=="function"){l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()](q[n][o])}}p.AddContent(m.favorites)}g(p)},Goods:function(n){m.favorites.AddContent(n)},Seller:function(n){m.favorites.sellerInfo.seller=n},Shop:function(n){m.favorites.sellerInfo.shop=n},Operator:function(n){m.favorites.sellerInfo.operator=n},Final_cost:function(n){m.favorites.finalCost=n}};function g(n){m.RenderTemplate(n,d,null,function(o){c();g(o)},function(){a()})}function i(){m.WidgetLoader(true,d.container.widget);if(d.animate){d.animate()}}};var FavoritesViewModel=function(){var a=this;a.content=ko.observableArray();a.AddContent=function(b){a.content.push(b)}};var BlockFavoritesForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.showSellerInfo=ko.computed(function(){if($.inArray("infoShop",c.showBlocks)>=0){return true}return false},this);a.goods=ko.observableArray();a.uniq=EventDispatcher.GetUUID();a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods)[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(h){$("#"+h.cssCheckboxGoods)[0].checked=g;h.isSelected(g)})};a.AddContent=function(f){for(var e=0;e<=f.length-1;e++){BlockFavoritesGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockFavoritesGoodsSellersViewModel(f[e],a,d,c))}a.finalCost=f.final_cost};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}b("Favorites.clear.all",{ids:e,goods:f,content:d,block:a})})};a.ClickClearFavorites=function(){a.Confirm(c.message.confirmClearFavorites,function(){var j=a.goods().length-1;var f=[];var e=[];for(var g=0;g<=j;g++){f.push(a.goods()[g]);e.push(a.goods()[g].id)}var h=e.join(",");b("Favorites.clear.all",{ids:h,goods:f,content:d,block:a})})};a.DisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return true}return false},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockFavoritesGoodsSellersViewModel=function(e,f,d,c){var a=this;a.sellerId=f.sellerInfo.seller.id;a.uniq=EventDispatcher.HashCode(new Date().getTime().toString()+"-"+a.id);a.cssToCart="goodsToCart_"+a.uniq;a.cssTitleToCart="goodsTilteToCart_"+a.uniq;a.id=e.id;a.fullName=e.full_name;a.sellCost=ko.observable(e.sell_cost);a.sellEndCost=ko.observable(e.sell_end_cost);a.routeImages=e.route_image;a.routeBigImages=e.route_big_image;a.isSelected=ko.observable(false);a.isSelected.subscribe(function(h){var g=f.goods().length;var k=[];for(var j=0;j<=g-1;j++){if(f.goods()[j].isSelected()){k.push(f.goods()[j].id)}}if(k.length<g){$("#"+f.cssSelectAll)[0].checked=false}else{$("#"+f.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods="goods_"+a.id;a.ClickOrder=function(){var g=$("#"+a.cssCheckboxGoods);var h=g.is(":checked");if(h==false){g[0].checked=true;a.isSelected(true)}else{g[0].checked=false;a.isSelected(false)}};a.showAddToCart=ko.computed(function(){if($.inArray("addToCart",c.showBlocks)>=0){return true}return false},this);a.AddToCart=function(){b("w.cart.add",{goodsId:a.id,hash:a.uniq})};a.showBuy=ko.computed(function(){if($.inArray("buy",c.showBlocks)>=0){return true}return false},this);a.Buy=function(){Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:a.sellerId,goodsId:a.id,count:1})};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){b("Favorites.clear.one",{goods:a,block:f,content:d})})};function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var TestFavorites={Init:function(){if(typeof Widget=="function"){FavoritesWidget.prototype=new Widget();var a=new FavoritesWidget();a.Init(a)}else{setTimeout(function(){TestFavorites.Init()},100)}}};TestFavorites.Init();
var CabinetCartGoodsWidget=function(){var n=this;n.widgetName="CabinetCartGoodsWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.cart=null;n.InitWidget=g;var d={container:{widget:"content",def:"defaultCartGoodsCabinetWidgetId"},tmpl:{path:"cabinetCartGoodsTmpl.html",id:{content:"cabinetCartGoodsTmpl",empty:"emptyCabinetCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},animate:typeof AnimateCabinetCartGoods=="function"?AnimateCabinetCartGoods:null};function g(){l();b();e()}function b(){var o=n.GetInputParameters("cabinetCartGoods");if(!$.isEmptyObject(o)){d=n.UpdateSettings1(d,o)}Config.Containers.cabinetCartGoods=d.container}function e(){if(Routing.route=="cabinet_cart"){n.BaseLoad.Tmpl(d.tmpl,function(){j()})}else{n.WidgetLoader(true)}}function l(){n.AddEvent("w.change.route",function(){e()});n.AddEvent("CartCG.onload.info",function(o){if(!o.err){c();m.Content(o)}else{i();k()}});n.AddEvent("CartCG.change.count",function(o){n.BaseLoad.AddGoodsToCart(o.id,o.sellerId,o.ordered(),function(p){n.DispatchEvent("widgets.cart.infoUpdate",p);o.sellCost(p.sell_cost);o.sellEndCost(p.sell_end_cost)})});n.AddEvent("CartCG.clear",function(p){var o=p.goodsId?p.goodsId:false;n.BaseLoad.ClearCart(p.sellerId,o,function(q){n.DispatchEvent("widgets.cart.infoUpdate",q)})});n.AddEvent("CartCG.empty.cart",function(){i();k()})}function j(){n.WidgetLoader(false);n.BaseLoad.Login(false,false,false,function(o){if(!o.err){Loader.Indicator("MenuPersonalCabinetWidget",false);n.BaseLoad.InfoFavorite("no",function(p){Parameters.cache.favorite=p;n.BaseLoad.CartGoods("",function(q){n.DispatchEvent("CartCG.onload.info",q)})});f()}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});n.WidgetLoader(true)}})}function f(){n.BaseLoad.Script(PokupoWidgets.model.menu,function(){n.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){n.ClearContainer(d)}function c(){n.InsertContainer(d,"content")}function i(){n.InsertContainer(d,"empty")}var m={Content:function(r){var q=new CartGoodsViewModel();for(var o in r){BlockCabinetGoodsForSellerViewModel.prototype=new Widget();n.cart=new BlockCabinetGoodsForSellerViewModel(q,d);for(var p in r[o]){if(typeof m[p.charAt(0).toUpperCase()+p.substr(1).toLowerCase()]=="function"){m[p.charAt(0).toUpperCase()+p.substr(1).toLowerCase()](r[o][p])}}q.AddContent(n.cart)}h(q)},Goods:function(o){n.cart.AddContent(o)},Seller:function(o){n.cart.sellerInfo.seller=o},Shop:function(o){n.cart.sellerInfo.shop=o},Operator:function(o){n.cart.sellerInfo.operator=o},Final_cost:function(o){n.cart.finalCost=o}};function h(o){n.RenderTemplate(o,d,null,function(p){c();h(p)},function(){a()},"content")}function k(){n.WidgetLoader(true,d.container.widget);if(d.animate){d.animate()}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockCabinetGoodsForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].endSum())}}return f.toFixed(2)},this);a.totalSum=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].sum())}}return f.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.AddContent=function(f){for(var e=0;e<=f.length-1;e++){BlockCabinetCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCabinetCartGoodsSellersViewModel(f[e],a,d,c))}a.finalCost=f.final_cost};a.comment=ko.observable();a.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(a.goods(),function(f){if(f.isSelected()){e.push(f.id);f.IsFavorite(true)}});a.AddCommentForm(e)};a.AddCommentForm=function(e){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){var f=[];$.each(e,function(g){f[g]=e[g].id});b("w.fav.add",{goodsId:f.join(","),comment:a.comment(),data:e});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}for(var g in f){a.goods.remove(f[g])}b("CartCG.clear",{goodsId:e.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){d.content.remove(a)}if(d.content().length==0){b("CartCG.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){var e=Parameters.cache.lastPage;if(e.route!="cart"){Routing.SetHash(e.route,e.title,e.data)}else{Routing.SetHash("default","Домашняя",{})}};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation==null||(Parameters.cache.userInformation!=null&&Parameters.cache.userInformation.err)){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(c.message.confirmClearCart,function(){var g=a.goods().length-1;var e=[];for(var f=0;f<=g;f++){e.push(a.goods()[f])}for(var f in e){a.goods.remove(e[f])}d.sellerBlock.remove(a);b("CartCG.clear",{sellerId:a.sellerInfo.shop.id});if(d.sellerBlock().length==0){b("CartCG.empty.cart")}})};a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods())[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(h){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(i){$("#"+i.cssCheckboxGoods())[0].checked=g;i.isSelected(g)})};a.isDisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return false}return true},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockCabinetCartGoodsSellersViewModel=function(f,h,d,c){var a=this;a.sellerId=h.sellerInfo.seller.id;a.id=f.id;a.fullName=f.full_name;a.countReserv=f.count_reserv;a.count=f.count;a.sellCost=ko.observable(f.sell_cost);a.sellEndCost=ko.observable(f.sell_end_cost);a.routeImages=f.route_image;a.routeBigImages=f.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(f.is_egoods=="yes"){return true}return false},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(k){var j=h.goods().length;var m=[];for(var l=0;l<=j-1;l++){if(h.goods()[l].isSelected()){m.push(h.goods()[l].id)}}if(m.length<j){$("#"+h.cssSelectAll)[0].checked=false}else{$("#"+h.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(i,k){var j=$("#"+i.cssCheckboxGoods());var l=j.is(":checked");if(l==false){j[0].checked=true;a.isSelected(true)}else{j[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var i=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(i>0){return i+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);b("CartCG.change.count",a)}else{a.ShowMessage(c.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);b("CartCG.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(c.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){b("CartCG.clear",{goodsId:a.id,sellerId:a.sellerId});g()};a.AddCommentForm=function(){h.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){b("w.fav.add",{goodsId:a.id,comment:h.comment(),data:a});a.IsFavorite(true);$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}function g(){h.goods.remove(a);if(h.goods().length==0){d.sellerBlock.remove(h);if(d.sellerBlock().length==0){b("CartCG.empty.cart")}}}e("CartGoods.clear.cartInfo."+a.sellerId+"."+a.id,function(){g()});e("CartGoods.change.cartInfo."+a.sellerId+"."+a.id,function(i){a.ordered(i)});function e(i,j){EventDispatcher.AddEventListener(i,j)}function b(i,j){EventDispatcher.DispatchEvent(i,j)}};var TestCabinetCartGoods={Init:function(){if(typeof Widget=="function"){CabinetCartGoodsWidget.prototype=new Widget();var a=new CabinetCartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCabinetCartGoods.Init()},100)}}};TestCabinetCartGoods.Init();
var OrderWidget=function(){var v=this;v.widgetName="OrderWidget";v.version=1.1;v.minWidgetVersion=1;v.maxWidgetVersion=2;v.minTmplVersion=1;v.maxTmplVersion=2;var Y={container:{widget:"content",def:"defaultOrderWidgetId"},tmpl:{path:"orderTmpl.html",id:{step1:"orderFormStep1Tmpl",step1Confirm:"orderConfirmFormStep1Tmpl",step1Profile:"orderProfileFormStep1Tmpl",step2:"orderFormStep2Tmpl",step2Form:"orderDeliveryFormStep2Tmpl",step3:"orderFormStep3Tmpl",step4:"orderFormStep4Tmpl",step5:"orderFormStep5Tmpl"}},regular:{username:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,gender:/^[mw]$/,addressee:/^[a-zа-яёА-ЯЁA-Z\s]+$/,postIndex:/^[0-9]+$/},message:{addAddressDelivery:"Данные успешно сохранены.",failAddAddressDelivery:"Данные не сохранены. Попробуйте повторить запрос позднее.",deleteAddressDelivery:"Адрес доставки успешно удален.",confirmDeleteAddressDelivery:"Вы уверены, что хотите удалить адрес?",failDeleteAddressDelivery:"Адрес доставки не удален. Попробуйте повторить запрос позднее.",setDefaultDelivery:"Данные успешно обновлены.",failSetDefaultDelivery:"Данные не обновлены.",orderConfirm:"Ваш заказ подтвержден.",selectMethodPayment:"Необходимо выбрать способ оплаты.",selectAddress:"Необходимо выбрать метод доставки.",selectMethodShipping:"Необходимо выбрать метод доставки.",confirmDeleteOrder:"Вы уверны, что хотите удалить заказ?",deleteOrderConfirm:"Ваш заказ удален.",sendToken:"Код активации успешно выслан по указанным данным.",failSendToken:"Код не был отправлен. Попробуйте повторить запрос позднее."},error:{username:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},isChecked:{empty:"Вам необходимо прочитать и принять условия соглашения"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},gender:{empty:"Поле обязательно для заполнения"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"},addressee:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},phone:{empty:"Поле обязательно для заполнения",regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},confirmLater:{empty:"Для активации аккаунта требуется подтвердить хотя бы один из способов связи"}},animate:typeof AnimateOrder=="function"?AnimateOrder:null},O={type:null,id:null,sellerId:null,goodsId:null,count:null,content:null,delivery:{},shipping:{},payment:{}},V="order",J="Оформление заказа";v.InitWidget=M;function M(){U();B();c()}function U(){var ae=v.GetInputParameters(O);if(!$.isEmptyObject(ae)){Y=v.UpdateSettings1(Y,ae)}Config.Containers.order=Y.container}function c(){var af=Routing.params,ae=Parameters.cache;if(Routing.route==V){v.WidgetLoader(false);if(af.sellerId){O.sellerId=af.sellerId}if(af.create){v.BaseLoad.Login(false,false,false,function(ag){if(af.create=="fromCart"){if(ag.err){O.type="cart";O.goodsId=null;O.count=null;setTimeout(function(){ae.history.pop();var ah=ae.history.pop();if(ah.route==V&&ah.data.create){ah=ae.history.pop()}if(ah.route=="login"){ah=ae.history.pop()}w(ah.route,ah.title,ah.data,true)},1000)}else{F({create:"fromCart",sellerId:O.sellerId},function(){O.type="cart";z(function(){w(V,J,{step:2})})})}}else{if(af.create=="directly"){if(ag.err){O.type="directly";O.goodsId=af.goodsId;O.count=af.count;setTimeout(function(){ae.history.pop();var ah=ae.history.pop();if(ah.route==V&&ah.data.create){ah=ae.history.pop()}if(ah.route=="login"){ah=ae.history.pop()}w(ah.route,ah.title,ah.data,true)},1000)}else{F({create:"directly",sellerId:O.sellerId,goodsId:af.goodsId,count:af.count},function(){O.type="directly";O.goodsId=af.goodsId;O.count=af.count;ad(function(){w(V,J,{step:2})})})}}else{w("default","Домашняя",{})}}})}if(af.step){v.BaseLoad.Login(false,false,false,function(ag){v.BaseLoad.Tmpl(Y.tmpl,function(){if(af.id){O.id=af.id}if(af.step==1&&!af.block){if(ag.err){o()}else{w(V,J,{step:2})}}else{if(af.step==1&&af.block=="confirm"){K()}else{if(!ag.err&&af.step==1&&af.block=="profile"&&O.id){ac()}else{if(!ag.err&&af.step==2&&!af.block&&O.id){m()}else{if(!ag.err&&af.step==2&&af.block=="add"&&O.id){A()}else{if(!ag.err&&af.step==3&&O.id){k()}else{if(!ag.err&&af.step==4&&O.id){i()}else{if(af.step==5){g()}else{w("default","Домашняя",{})}}}}}}}}})})}}else{v.WidgetLoader(true)}}function B(){v.AddEvent("w.change.route",function(){c()});v.AddEvent("UInfo.logout",function(){Parameters.cache.order.step1.login={};Parameters.cache.order.step1.reg={};Parameters.cache.order.step1.confirm={};Parameters.cache.order.step1.profile={};Parameters.cache.order.step2={};Parameters.cache.order.step3={};Parameters.cache.order.step4={};Parameters.cache.order.step5={};Parameters.cache.payment=null;Parameters.cache.shipping=null;Parameters.cache.delivery=null;Parameters.cache.profile.personal={};O.type=null;O.id=null;O.sellerId=null;O.goodsId=null;O.count=null;O.content=null;O.delivery={};O.shipping={};O.payment={}});v.AddEvent("Order.step1.authentication",function(ae){v.BaseLoad.Login(ae.username,ae.password,ae.rememberMe,function(af){if(af.err){Parameters.cache.order.step1.reg.loginForm.error("Ошибка в логине или пароле");Parameters.cache.order.step1.reg.loginForm.password=null;S(Parameters.cache.order.step1.reg)}else{if(O.type=="directly"){F({create:"directly",sellerId:O.sellerId,goodsId:O.goodsId,count:O.count},function(){ad(function(){w(V,J,{step:2})})})}if(O.type=="cart"){F({create:"directly",sellerId:O.sellerId},function(){z(function(){w(V,J,{step:2})})})}}})});v.AddEvent("Order.step1.registration",function(ae){v.WidgetLoader(false);var ag=[];if(ae.username()){ag.push("username="+encodeURIComponent(ae.username()))}if(ae.phone()){ag.push("phone="+ae.phone().replace(/\s/g,""))}if(ae.email()){ag.push("email="+ae.email())}if(ag.length>0){var af="?"+ag.join("&")}v.BaseLoad.UniqueUser(af,function(ah){var ak=true;if(v.QueryError(ah,function(){EventDispatcher.DispatchEvent("Order.step1.registration",ae)})){if(!X(ah,ae)){ak=false}if(!y(ah,ae)){ak=false}if(!e(ah,ae)){ak=false}}else{ak=false}if(ak){var aj=[];if(ae.username()){aj.push("username="+encodeURIComponent(ae.username()))}if(ae.phone()){aj.push("phone="+ae.phone().replace(/\s/g,""))}if(ae.email()){aj.push("email="+ae.email())}if(ae.firstPassword()){aj.push("password="+encodeURIComponent(ae.firstPassword()))}if(aj.length>0){var ai="?"+aj.join("&")}v.BaseLoad.Registration(ai,function(al){Parameters.cache.order.step1.reg=ae;w(V,J,{step:1,block:"confirm"})})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step1.confirm",function(ae){v.WidgetLoader(false);var ag=[];ag.push("username="+encodeURIComponent(ae.username));if(!ae.mailConfirmLater()){ag.push("mail_token="+ae.mailToken())}if(!ae.phoneConfirmLater()){ag.push("sms_token="+ae.phoneToken())}var af="?"+ag.join("&");v.BaseLoad.ActivateUser(af,function(ah){var ai=true;if(v.QueryError(ah,function(){EventDispatcher.DispatchEvent("Order.step1.confirm",ae)})){if(!f(ah,ae)){ai=false}if(!T(ah,ae)){ai=false}}else{ai=false}if(ai){v.BaseLoad.Login(false,false,false,function(aj){Parameters.cache.order.step1.confirm=ae;if(!aj.err){if(O.type=="directly"){F({create:"directly",sellerId:O.sellerId,goodsId:O.goodsId,count:O.count},function(){ad(function(){w(V,J,{step:1,block:"profile"})})})}if(O.type=="fromCart"){F({create:"directly",sellerId:O.sellerId},function(){z(function(){w(V,J,{step:1,block:"profile"})})})}}})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step1.view1",function(){w(V,J,{step:1})});v.AddEvent("Order.step1.later",function(){w(V,J,{step:2})});v.AddEvent("Order.step1.profile",function(ag){v.WidgetLoader(false);var af=ag.birthDay().split(".");var ae=af[2]+"-"+af[1]+"-"+af[0];ag.birthDayHiddenField(ae);v.BaseLoad.EditProfile($("form#"+ag.cssRegistrationDataForm),function(ah){var ai=true;if(!v.QueryError(ah,function(){v.DispatchEvent("Order.step1.profile",ag)})){ai=false}if(ai){Parameters.cache.profile.personal={};Parameters.cache.order.step1.profile=ag;w(V,J,{step:2})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step3.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_method_shipping="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step3.change",ae)})){O.shipping=ae.selected;ae.fn()}})});v.AddEvent("Order.step3.message",function(){v.ShowError(Y.message.selectMethodShipping,false,false)});v.AddEvent("Order.step2.add",function(ae){var af="?id_country="+encodeURIComponent($.trim(ae.country().id));if(ae.region()){af=af+"&code_region="+encodeURIComponent($.trim(ae.region().regioncode))}else{af=af+"&name_region="+encodeURIComponent($.trim(ae.customRegion()))}if(ae.city()){af=af+"&code_city="+encodeURIComponent($.trim(ae.city().aoguid))}else{af=af+"&name_city="+encodeURIComponent($.trim(ae.customCity()))}af=af+"&address="+encodeURIComponent($.trim(ae.customAddress()))+"&post_code="+encodeURIComponent($.trim(ae.postCode()))+"&addressee="+encodeURIComponent($.trim(ae.addressee()))+"&contact_phone="+encodeURIComponent($.trim(ae.contactPhone()))+"&is_default="+encodeURIComponent(ae.isDefault()?"yes":"no");v.BaseLoad.AddDelivaryAddress(af,function(ag){if(ag.result=="ok"){v.ShowMessage(Y.message.addAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;w(V,J,{step:2})},false)}else{if(!ag.err){ag.err=Y.message.failAddAddressDelivery}v.QueryError(ag,function(){v.DispatchEvent("Order.step2.add",ae)})}})});v.AddEvent("Order.step2.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_shipping_address="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step2.change",ae)})){Parameters.cache.delivery=null;O.delivery=ae.selected;ae.fn()}})});v.AddEvent("Order.step2.delete",function(ae){v.BaseLoad.DeleteDeliveryAddress(ae.address.id,function(af){if(af.result=="ok"){v.ShowMessage(Y.message.deleteAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;ae.list.remove(ae.address)},false)}else{if(!af.err){af.err=Y.message.failDeleteAddressDelivery}v.QueryError(af,function(){v.DispatchEvent("Order.step2.delete",ae)})}})});v.AddEvent("Order.step2.message",function(){v.ShowError(Y.message.selectAddress,false,false)});v.AddEvent("Order.step4.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_method_payment="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step4.change",ae)})){O.payment=ae.selected;ae.fn()}})});v.AddEvent("Order.step4.message",function(){v.ShowError(Y.message.selectMethodPayment,false,false)});v.AddEvent("Order.step5.confirm",function(af){var ae=O.id;if(af.comment){ae=ae+"?comment_buyer="+encodeURIComponent(af.comment)}v.BaseLoad.ConfirmOrder(ae,function(ag){if(v.QueryError(ag,function(){v.DispatchEvent("Order.step5.confirm",af)})){v.ShowMessage(Y.message.orderConfirm,function(){w("purchases","Мои покупки",{block:"detail",id:O.id})},false)}})});v.AddEvent("Order.step5.delete",function(){v.Confirm(Y.message.confirmDeleteOrder,function(){v.BaseLoad.DeleteOrder(O.id+"/yes",function(ae){if(v.QueryError(ae,function(){v.DispatchEvent("Order.step5.delete")})){v.ShowMessage(Y.message.deleteOrderConfirm,function(){w("default","Домашняя",{})},false)}})})});v.AddEvent("Order.send.token",function(ae){v.BaseLoad.SendToken(ae,function(af){if(af.result=="ok"){v.ShowMessage(Y.message.sendToken,false,false)}else{if(!af.err){af.err=Y.message.failSendToken}v.QueryError(af,function(){v.DispatchEvent("Order.send.token",ae)})}})})}function X(af,ae){var ag=false;if(af.check_username){if(af.check_username=="on"||af.check_username=="ban"||af.check_username=="off"){ae.errorUsername(Y.error.username.uniq)}if(af.check_username=="yes"){ag=true}}return ag}function e(af,ae){var ag=false;if(af.check_phone){if(af.check_phone=="on"||af.check_phone=="ban"||af.check_phone=="off"){ae.errorPhone(Y.error.phone.uniq)}if(af.check_phone=="yes"){ag=true}}else{ag=true}return ag}function y(af,ae){var ag=false;if(af.check_email){if(af.check_email=="on"||af.check_email=="ban"||af.check_email=="off"){ae.errorEmail(Y.error.email.uniq)}if(af.check_email=="yes"){ag=true}}return ag}function f(af,ae){if(af.confirm_email){if(af.confirm_email=="no"){ae.errorEmailConfirm(Y.error.emailToken.confirm);return false}}return true}function T(af,ae){if(af.confirm_phone){if(af.confirm_phone=="no"){ae.errorPhoneConfirm(Y.error.phoneToken.confirm);return false}}return true}function W(af,ae){if(af.err){ae.errorAddress(af.err);return false}return true}function E(ae,af){if(ae.err){af.errorAddress(ae.err);return false}return true}function F(af,ag){var ae=af.sellerId;if(af.goodsId){ae=ae+"/"+af.goodsId+"/"+af.count}v.BaseLoad.NewOrder(ae,function(ah){if(v.QueryError(ah,function(){w(V,J,af)},function(){var ai=Parameters.cache.lastPage;w(ai.route,ai.title,ai.data)})){if(ah.msg){v.ShowMessage(ah.msg,function(){var ai=Parameters.cache.lastPage;w(ai.route,ai.title,ai.data)},false)}else{O.id=ah.id;if(ag){ag()}}}})}function z(ae){v.BaseLoad.CartGoods(O.sellerId,function(af){O.content=af;O.content.main=af[0].goods;if(ae){ae()}})}function ad(ae){v.BaseLoad.GoodsInfo(O.goodsId,"1000000",function(af){O.content=af;O.content.main=[af.main];if(ae){ae()}})}function D(){var af=false;var ae=[];if(O.type=="cart"){ae=O.content[0].goods}else{if(!$.isArray(O.content.main)){ae[0]=O.content.main}else{ae=O.content.main}}$.each(ae,function(ag){if(ae[ag].is_egoods!="yes"){af=true;return false}});return af}function o(){q();u()}function K(){L();I()}function ac(){v.BaseLoad.Profile(function(ae){b();Z(ae)})}function m(){if(Routing.params.id){v.BaseLoad.OrderInfo(O.id+"/yes",function(ae){if(v.QueryError(ae,function(){w(V,J,Routing.params)},function(){var af=Parameters.cache.lastPage;w(af.route,af.title,af.data)})){if(ae.msg){v.ShowMessage(ae.msg,function(){var af=Parameters.cache.lastPage;if(af){w(af.route,af.title,af.data)}else{w("default",Routing.defaultTitle,{})}},false)}else{O.content={};O.content.main=ae.goods;C()}}})}else{C()}}function C(){if(D()){v.BaseLoad.DeliveryAddressList(function(ae){n();t(ae)})}else{w(V,J,{step:4})}}function A(){if(D()){var af=new OrderDeliveryFormStep2ViewModel(Y);var ae=Parameters.shopId;v.BaseLoad.Country(ae,function(ag){a();H(af,ag)})}else{w(V,J,{step:4})}}function k(){if(D()){v.BaseLoad.GoodsInfo(O.content.main[0].id,"1010000",function(ae){O.sellerId=ae.shop.id;v.BaseLoad.Shipping(O.sellerId+"/"+O.id+"/",function(af){l();s(af)})})}else{w(V,J,{step:4})}}function i(){v.BaseLoad.GoodsInfo(O.content.main[0].id,"1010000",function(ae){O.sellerId=ae.shop.id;v.BaseLoad.Payment(O.sellerId+"/"+O.id,function(af){j();r(af)})})}function g(){v.BaseLoad.Script(PokupoWidgets.model.order,function(){v.BaseLoad.OrderInfo(O.id+"/yes",function(ae){h();p(ae)})})}function x(){v.ClearContainer(Y)}function q(){v.InsertContainer(Y,"step1")}function L(){v.InsertContainer(Y,"step1Confirm")}function b(){v.InsertContainer(Y,"step1Profile")}function n(){v.InsertContainer(Y,"step2")}function a(){v.InsertContainer(Y,"step2Form")}function l(){v.InsertContainer(Y,"step3")}function j(){v.InsertContainer(Y,"step4")}function h(){v.InsertContainer(Y,"step5")}function u(){var ae=Parameters.cache.order.step1.reg;if($.isEmptyObject(ae)){v.BaseLoad.Script(PokupoWidgets.model.registration,function(){v.BaseLoad.Script(PokupoWidgets.model.auth,function(){ae=new OrderFormStep1ViewModel(Y);Parameters.cache.order.step1.reg=ae})})}S(ae)}function I(){var ag=Routing.params,ae=Parameters.cache.order.step1;if(ag.username&&ag.mail_token){ae.reg.username(ag.username)}RegistrationConfirmFormViewModel.prototype.Back=function(){v.DispatchEvent("Order.step1.view1")};var af=new RegistrationConfirmFormViewModel(ae.reg,Y);af.submitEvent("Order.step1.confirm");af.ShowButtonSendToken();if(ag.username&&ag.mail_token){af.mailToken(ag.mail_token);v.DispatchEvent("Order.step1.confirm",af)}G(af)}function Z(af){RegistrationProfileFormViewModel.prototype.Back=function(){v.DispatchEvent("Order.step1.view2")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){v.DispatchEvent("Order.step1.later")};var ae=new RegistrationProfileFormViewModel(Y);ae.submitEvent("Order.step1.profile");ae.AddContent(af);ab(ae)}function t(af){if(!af.err){var ae=Parameters.cache.order.step2;if($.isEmptyObject(ae)){ae=new OrderFormStep2ViewModel(Y)}ae.AddContent(af,O);R(ae);Parameters.cache.order.step2=ae}else{w(V,J,{step:2,block:"add"})}}function H(ae,af){ae.AddCountryList(af);if(ae.idCountry()){$.grep(ae.countryList(),function(ag){if(ag.id==ae.idCountry()){ae.country(ag)}})}aa(ae)}function s(af){var ae=Parameters.cache.order.step3;if($.isEmptyObject(ae)){ae=new OrderFormStep3ViewModel()}ae.AddShipping(af);Parameters.cache.order.step3=ae;Q(ae)}function r(af){var ae=Parameters.cache.order.step4;if($.isEmptyObject(ae)){ae=new OrderFormStep4ViewModel()}ae.AddPayment(af);Parameters.cache.order.step4=ae;P(ae)}function p(af){var ae=Parameters.cache.order.step5;if($.isEmptyObject(ae)){OrderViewModel.prototype.Back=function(){w(V,J,{step:4})};OrderViewModel.prototype.ClickDelete=function(){v.DispatchEvent("Order.step5.delete")};OrderViewModel.prototype.ClickStep1=function(){w(V,J,{step:1,block:"profile"})};OrderViewModel.prototype.ClickStep2=function(){w(V,J,{step:2})};OrderViewModel.prototype.ClickStep3=function(){w(V,J,{step:3})};OrderViewModel.prototype.ClickStep4=function(){w(V,J,{step:4})};OrderViewModel.prototype.ClickAddAddress=function(){w(V,J,{step:1,block:"add"})};ae=new OrderViewModel();Parameters.cache.order.step5=ae}ae.AddContent(af);N(ae)}function S(ae){v.RenderTemplate(ae,Y,null,function(af){q();S(af)},function(){x()},"step1")}function G(ae){v.RenderTemplate(ae,Y,null,function(af){L();G(af)},function(){x()},"step1Confirm")}function ab(ae){v.RenderTemplate(ae,Y,null,function(af){b();ab(af)},function(){x()},"step1Profile")}function R(ae){v.RenderTemplate(ae,Y,null,function(af){n();R(af)},function(){x()},"step2")}function aa(ae){v.RenderTemplate(ae,Y,function(){d(ae)},function(af){a();aa(af)},function(){x()},"step2Form")}function Q(ae){v.RenderTemplate(ae,Y,null,function(af){l();Q(af)},function(){x()},"step3")}function P(ae){v.RenderTemplate(ae,Y,null,function(af){j();P(af)},function(){x()},"step4")}function N(ae){v.RenderTemplate(ae,Y,null,function(af){h();N(af)},function(){x()},"step5")}function d(ae){$("#"+ae.cssRegionList).autocomplete({source:function(ag,af){v.BaseLoad.Region(ae.country().id+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.formalname+" "+ai.shortname),region:ai}}))}else{$("#"+ae.cssRegionList).autocomplete("close");return false}})},select:function(af,ag){ae.region(ag.item.region);ae.customRegion(ag.item.value);if(ag.item.region&&ag.item.region.postalcode!=0){ae.postCode(ag.item.region.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssCityList).autocomplete({source:function(ag,af){if(ae.region()){v.BaseLoad.City(ae.country().id+"/"+encodeURIComponent(ae.region().regioncode)+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.shortname+". "+ai.formalname),city:ai}}))}else{$("#"+ae.cssCityList).autocomplete("close");return false}})}},select:function(af,ag){ae.city(ag.item.city);ae.customCity(ag.item.value);if(ag.item.city&&ag.item.city.postalcode!=0){ae.postCode(ag.item.city.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssAddress).autocomplete({source:function(ag,af){if(ae.region()){v.BaseLoad.Street(ae.country().id+"/"+encodeURIComponent(ae.region().regioncode)+"/"+encodeURIComponent(ae.city().aoguid)+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.shortname+". "+ai.formalname),street:ai}}))}else{$("#"+ae.cssAddress).autocomplete("close");return false}})}},select:function(af,ag){ae.address(ag.item.street);ae.customAddress(ag.item.value);if(ag.item.street&&ag.item.street.postalcode!=0){ae.postCode(ag.item.street.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssCountryList).change(function(){var af=$("#"+ae.cssCountryList+" option:selected").val();if(af){ae.errorCountry("");ae.errorRegion("");ae.errorCity("");ae.errorAddress("");ae.errorPostCode("")}$.grep(ae.countryList(),function(ag){if(ag.id==af){ae.country(ag);ae.customRegion(null);ae.region(null);ae.customCity(null);ae.city(null);ae.customAddress(null);ae.address(null);ae.postCode(null)}})});$("#"+ae.cssRegionList).bind("textchange",function(ag,af){ae.errorRegion("");ae.errorCity("");ae.errorAddress("");ae.errorPostCode("");ae.customRegion($(this).val());ae.customCity(null);ae.city(null);ae.customAddress(null);ae.address(null);ae.postCode(null)});$("#"+ae.cssCityList).bind("textchange",function(ag,af){ae.errorCity("");ae.errorAddress("");ae.errorPostCode("");ae.customCity($(this).val());ae.customAddress(null);ae.address(null);ae.postCode(null)});$("#"+ae.cssAddressList).bind("textchange",function(ag,af){ae.errorAddress("");ae.errorPostCode("")});$("#"+ae.cssPostCode).bind("textchange",function(ag,af){ae.errorPostCode("")});$("#"+ae.cssAddressee).bind("textchange",function(ag,af){ae.errorAddressee("")});$("#"+ae.cssContactPhone).bind("textchange",function(ag,af){ae.errorContactPhone("")})}function w(ae,ag,af){Routing.SetHash(ae,ag,af)}};var OrderFormStep1ViewModel=function(b){var a=this;var c=new AuthenticationViewModel();c.subminEvent("Order.step1.authentication");a.loginForm=c;a.registrationForm=new RegistrationFormViewModel(b);a.registrationForm.submitEvent("Order.step1.registration")};var OrderFormStep2ViewModel=function(e){var b=this,f="Оформление заказа",d="order";b.addressList=ko.observableArray();b.cssAddressList="delivary_address_list";b.checked=ko.observable();b.selectedItem=ko.observable();b.ClickAddAddress=function(){a(d,f,{step:2,block:"add"})};b.AddContent=function(j,g){if(!j.err){b.addressList=ko.observableArray()}for(var i in j){OrderItemFormStep2ViewModel.prototype=new Widget();var h=new OrderItemFormStep2ViewModel(j[i],b,e);b.addressList.push(h);if(j[i].is_default=="yes"){g.delivery=h}if(j.length==1){h.ClickItem()}}};b.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var h=Parameters.cache.history;for(var g=0;g<=h.length-1;g++){var j=h.pop();if(j.route!="order"){a(j.route,j.title,j.data,true);return false}}}else{a(d,f,{step:1,block:"profile"})}};b.Submit=function(){if(c()){EventDispatcher.DispatchEvent("Order.step2.change",{id:b.checked(),selected:b.selectedItem(),fn:function(){a(d,f,{step:3})}})}else{EventDispatcher.DispatchEvent("Order.step2.message")}};b.ClickStep1=function(){a(d,f,{step:1,block:"profile"})};function c(){var g=false;$.each(b.addressList(),function(h){if(b.addressList()[h].isDefault()){g=true;return false}});return g}function a(g,i,h){Routing.SetHash(g,i,h)}};var OrderItemFormStep2ViewModel=function(d,c,b){var a=this;if(d.id){a.id=d.id}else{a.id=""}a.idCountry=d.id_country;a.country=d.country;a.codeRegion=d.code_region;a.region=d.region;a.codeCity=d.code_city;a.city=d.city;a.postCode=d.post_code;a.address=d.address;a.addressee=d.addressee;a.contactPhone=d.contact_phone;a.list=c.addressList();a.isDefault=ko.observable(true);if(d.is_default=="yes"){a.cssIsDefault=ko.observable("delivery_address_is_default active");Parameters.cache.order.delivery=a;c.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.Delete=function(){a.Confirm(b.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("Order.step2.delete",{address:a,list:c.addressList})},false)};a.ClickItem=function(){$.each(a.list,function(e){a.list[e].cssIsDefault("delivery_address_is_default");a.list[e].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);c.checked(a.id);c.selectedItem(a);Parameters.cache.order.delivery=a}};var OrderDeliveryFormStep2ViewModel=function(e){var m=this,k="Оформление заказа",g="order";m.id=ko.observable();m.idCountry=ko.observable();m.country=ko.observable();m.cssCountryList="delivery_country_list";m.errorCountry=ko.observable(null);m.codeRegion=ko.observable();m.region=ko.observable();m.customRegion=ko.observable();m.cssRegionList="delivery_region";m.errorRegion=ko.observable(null);m.showRegion=ko.computed(function(){if(m.country()){return false}return true},this);m.codeCity=ko.observable();m.city=ko.observable();m.customCity=ko.observable();m.cssCityList="delivery_city";m.errorCity=ko.observable(null);m.showCity=ko.computed(function(){if(m.customRegion()){return false}return true},this);m.address=ko.observable();m.customAddress=ko.observable();m.cssAddress="delivery_cssAddress";m.errorAddress=ko.observable(null);m.showAddress=ko.computed(function(){if(m.customCity()){return false}return true},this);m.postCode=ko.observable();m.cssPostCode="delivery_post_index";m.errorPostCode=ko.observable(null);m.showPostIndex=ko.computed(function(){if(m.customAddress()){return false}return true},this);m.addressee=ko.observable();m.cssAddressee="delivery_addressee";m.errorAddressee=ko.observable(null);m.contactPhone=ko.observable();m.cssContactPhone="delivery_contact_phone";m.errorContactPhone=ko.observable(null);m.isDefault=ko.observable();m.countryList=ko.observableArray();m.AddCountryList=function(o){if(o.length>0){for(var n=0;n<=o.length-1;n++){m.countryList.push(new CountryListViewModel(o[n]))}}};m.AddContent=function(n){m.id(n.id);m.idCountry(n.idCountry);m.region({regioncode:n.codeRegion});m.customRegion(n.region);m.city({aoguid:n.codeCity});m.customCity(n.city);m.postCode(n.postCode);m.customAddress(n.address);m.addressee(n.addressee);m.isDefault(n.isDefault());m.contactPhone(n.contactPhone)};m.Submit=function(){if(d()){EventDispatcher.DispatchEvent("Order.step2.add",m)}};m.Back=function(){j(g,k,{step:2})};m.ClickStep1=function(){j(k,g,{step:1,block:"profile"})};m.ClickStep2=function(){j(k,g,{step:2})};function j(n,p,o){Routing.SetHash(n,p,o)}function d(){var n=true;if(!l()){n=false}if(!i()){n=false}if(!h()){n=false}if(!c()){n=false}if(!b()){n=false}if(!f()){n=false}if(!a()){n=false}return n}function h(){if(!m.country()){m.errorCountry(e.error.country.empty);return false}m.errorCountry(null);return true}function c(){if(!m.customRegion()){m.errorRegion(e.error.region.empty);return false}m.errorRegion(null);return true}function b(){if(!m.customCity()){m.errorCity(e.error.city.empty);return false}m.errorCity(null);return true}function f(){if(!m.customAddress()){m.errorAddress(e.error.address.empty);return false}m.errorAddress(null);return true}function a(){var n=e.error.postIndex;if(!m.postCode()){m.errorPostCode(n.empty);return false}if(5>m.postCode().length||m.postCode().length>6){m.errorPostCode(n.length);return false}if(!e.regular.postIndex.test(m.postCode())){m.errorPostCode(n.regular);return false}m.errorPostCode(null);return true}function i(){var n=e.error.addressee;if(!m.addressee()){m.errorAddressee(n.empty);return false}if(m.addressee().length<3){m.errorAddressee(n.minLength);return false}if(m.addressee().length>40){m.errorAddressee(n.maxLength);return false}if(!e.regular.addressee.test(m.addressee())){m.errorAddressee(n.regular);return false}m.errorAddressee(null);return true}function l(){var n=e.error.phone;if(!m.contactPhone()){m.errorContactPhone(n.empty);return false}if(!e.regular.phone.test($.trim(m.contactPhone()))){m.errorContactPhone(n.regular);return false}m.errorContactPhone(null);return true}};var OrderFormStep3ViewModel=function(){var c=this,e="Оформление заказа",d="order";c.shipping=ko.observableArray();c.checked=ko.observable();c.selectedItem=ko.observable();c.AddShipping=function(h){c.shipping=ko.observableArray();for(var f=0;f<=h.length-1;f++){var g=new OrderItemFormStep3ViewModel(c);g.AddContent(h[f]);c.shipping.push(g);if(h.length==1){g.ClickItem()}}};c.Back=function(){a(d,e,{step:2})};c.Submit=function(){if(b()){EventDispatcher.DispatchEvent("Order.step3.change",{id:c.checked(),selected:c.selectedItem(),fn:function(){a(d,e,{step:4})}})}else{EventDispatcher.DispatchEvent("Order.step3.message")}};c.ClickStep1=function(){a(d,e,{step:1,block:"profile"})};c.ClickStep2=function(){a(d,e,{step:2})};c.ClickAddAddress=function(){a(d,e,{step:2,block:"add"})};function b(){var f=false;$.each(c.shipping(),function(g){if(c.shipping()[g].isActive()){f=true;return false}});return f}function a(f,h,g){Routing.SetHash(f,h,g)}};var OrderItemFormStep3ViewModel=function(b){var a=this;a.nameShippingCompany=ko.observable();a.siteShippingCompany=ko.observable();a.logoShippingCompany=ko.observable();a.id=ko.observable();a.nameMethodShipping=ko.observable();a.descMethodShipping=ko.observable();a.costShipping=ko.observable();a.cssActive=ko.observable("shipping_row");a.isActive=ko.observable(false);a.AddContent=function(c){if(c.hasOwnProperty("name_shipping_company")){a.nameShippingCompany(c.name_shipping_company)}if(c.hasOwnProperty("site_shipping_company")){a.siteShippingCompany(c.site_shipping_company)}if(c.hasOwnProperty("logo_shipping_company")){a.logoShippingCompany(c.logo_shipping_company)}if(c.hasOwnProperty("id")){a.id(c.id)}if(c.hasOwnProperty("name_method_shipping")){a.nameMethodShipping(c.name_method_shipping)}if(c.hasOwnProperty("desc_method_shipping")){a.descMethodShipping(c.desc_method_shipping)}if(c.hasOwnProperty("cost_shipping")){a.costShipping(c.cost_shipping)}};a.ClickItem=function(){$.each(b.shipping(),function(c){b.shipping()[c].cssActive("shipping_row");b.shipping()[c].isActive(false)});a.cssActive("shipping_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var OrderFormStep4ViewModel=function(){var c=this,e="Оформление заказа",d="order";c.payment=ko.observableArray();c.checked=ko.observable();c.selectedItem=ko.observable();c.AddPayment=function(h){c.payment=ko.observableArray();for(var f=0;f<=h.length-1;f++){var g=new OrderItemFormStep4ViewModel(c);g.AddContent(h[f]);c.payment.push(g);if(h.length==1){g.ClickItem()}}};c.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var g=Parameters.cache.history;for(var f=0;f<=g.length-1;f++){var h=g.pop();if(h.route!="order"){a(h.route,h.title,h.data,true);return false}else{a(d,e,{step:3})}}}else{a(d,e,{step:3})}};c.Submit=function(){if(b()){EventDispatcher.DispatchEvent("Order.step4.change",{id:c.checked(),selected:c.selectedItem(),fn:function(){a(d,e,{step:5})}})}else{EventDispatcher.DispatchEvent("Order.step4.message")}};c.ClickStep1=function(){a(d,e,{step:1,block:"profile"})};c.ClickStep2=function(){a(d,e,{step:2})};c.ClickStep3=function(){a(d,e,{step:3})};c.ClickAddAddress=function(){a(d,e,{step:2,block:"add"})};function b(){var f=false;$.each(c.payment(),function(g){if(c.payment()[g].isActive()){f=true;return false}});return f}function a(f,h,g){Routing.SetHash(f,h,g)}};var OrderItemFormStep4ViewModel=function(b){var a=this;a.id=ko.observable();a.logoPayment=ko.observable();a.descPayment=ko.observable();a.instrPayment=ko.observable();a.namePayment=ko.observable();a.costPayment=ko.observable();a.cssActive=ko.observable("payment_row");a.isActive=ko.observable(false);a.AddContent=function(d,c){a.id(d.id);if(d.hasOwnProperty("logo_payment")){a.logoPayment(d.logo_payment)}if(d.hasOwnProperty("desc_payment")){a.descPayment(d.desc_payment)}if(d.hasOwnProperty("instr_payment")){a.instrPayment(d.instr_payment)}if(d.hasOwnProperty("name_payment")){a.namePayment(d.name_payment)}if(d.hasOwnProperty("cost_payment")){a.costPayment(d.cost_payment)}};a.ClickItem=function(){$.each(b.payment(),function(c){b.payment()[c].cssActive("payment_row");b.payment()[c].isActive(false)});a.cssActive("payment_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var TestOrder={Init:function(){if(typeof Widget=="function"){OrderWidget.prototype=new Widget();var a=new OrderWidget();a.Init(a)}else{setTimeout(function(){TestOrder.Init()},100)}}};TestOrder.Init();
var OrderListWidget=function(){var i=this;i.widgetName="OrderListWidget";i.version=1;i.minWidgetVersion=1;i.maxWidgetVersion=2;i.minTmplVersion=1;i.maxTmplVersion=2;i.currentPage=1;i.InitWidget=f;var n={container:{widget:"content",def:"defaultOrderListWidgetId"},tmpl:{path:"orderListTmpl.html",id:{list:"orderListTmpl",empty:"orderEmptyListTmpl",detail:"orderDetailTmpl"}},message:{orderConfirm:"Ваш заказ подтвержден.",orderRepeat:"Ваш заказ повторен.",orderReturn:"Ваш заказ скопирован в корзину.",orderDelete:"Ваш заказ удален.",orderCancel:"Ваш заказ отменен.",confirmCancelOrder:"Вы уверены, что хотите отменить заказ?",confirmDeleteOrder:"Вы уверены, что хотите удалить заказ?"},show:{menu:true},animate:typeof AnimateOrderList=="function"?AnimateOrderList:null},j="order",t="Оформление заказа";function f(){r();h();a()}function r(){var u=i.GetInputParameters("orderList");if(!$.isEmptyObject(u)){n=i.UpdateSettings1(n,u);if(u.show){if(u.show.hasOwnProperty("menu")){n.show.menu=u.show.menu}}}Config.Containers.orderList=n.container}function a(){if(Routing.route=="purchases"){i.WidgetLoader(false);i.BaseLoad.Login(false,false,false,function(u){if(!u.err){i.BaseLoad.Tmpl(n.tmpl,function(){if(n.show.menu){l()}e()})}else{Parameters.cache.lastPage={route:"default"};p("login","Авторизация пользователя",{});i.WidgetLoader(true)}})}else{i.WidgetLoader(true)}}function h(){i.AddEvent("w.change.route",function(){a()});i.AddEvent("LOrder.repeat",function(u){i.BaseLoad.RepeatOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.repeat",u)})){i.ShowMessage(n.message.orderRepeat,function(){Parameters.cache.orderList={};i.DispatchEvent("LOrder.edit",{id:v.id})},false)}})});i.AddEvent("LOrder.return",function(u){i.BaseLoad.ReturnOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.return",u)})){i.ShowMessage(n.message.orderReturn,function(){Parameters.cache.orderList={};p("cart","Моя корзина")},false)}})});i.AddEvent("LOrder.cancel",function(u){i.Confirm(n.message.confirmCancelOrder,function(){i.BaseLoad.CancelOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.cancel",u)})){i.ShowMessage(n.message.orderCancel,function(){Parameters.cache.orderList={};u.fn()},false)}})})});i.AddEvent("LOrder.check",function(u){i.BaseLoad.ConfirmOrder(u.id,function(v){if(v.err){i.ShowMessage(v.msg,function(){if(v.err=="Not defined Payment Method"){p(j,t,{step:2,id:u.id})}else{p(j,t,{step:4,id:u.id})}})}else{i.ShowMessage(n.message.orderConfirm,function(){Parameters.cache.orderList={};u.fn()})}})});i.AddEvent("LOrder.delete",function(u){i.Confirm(n.confirmDeleteOrder,function(){i.BaseLoad.DeleteOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.delete",u)})){i.ShowMessage(n.message.orderDelete,function(){Parameters.cache.orderList={};u.fn()},false)}})})});i.AddEvent("LOrder.edit",function(u){p(j,t,{step:2,id:u.id})});i.AddEvent("LOrder.pay",function(u){})}function e(){i.WidgetLoader(false);if(Routing.params.block=="list"){i.currentPage=Routing.GetCurrentPage();c()}else{if(Routing.params.block=="detail"&&Routing.params.id){i.BaseLoad.Script(PokupoWidgets.model.order,function(){s(Routing.params.id)})}}}function l(){i.BaseLoad.Script(PokupoWidgets.model.menu,function(){i.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function m(){i.ClearContainer(n)}function q(){i.InsertContainer(n,"list")}function b(){i.InsertContainer(n,"detail")}function g(){i.InsertContainer(n,"empty")}function c(){var v=Routing.GetCurrentPage()*Config.Paging.itemsPerPage-Config.Paging.itemsPerPage;var u="/"+v+"/"+Config.Paging.itemsPerPage;i.BaseLoad.OrderList(u,function(x){if(!x.err){q();var w=new OrderListViewModel();w.AddContent(x);o(w)}else{g();d()}})}function s(u){i.BaseLoad.OrderInfo(u+"/yes",function(x){if(!x.err){if(x.goods.length>0){b();var v=Parameters.cache.order.info,y="purchases",w="Мои покупки";if($.isEmptyObject(v)){OrderViewModel.prototype.Back=function(){p(y,w,{block:"list",page:Routing.GetLastPageNumber()})};OrderViewModel.prototype.ClickEdit=function(){i.DispatchEvent("LOrder.edit",{id:u})};OrderViewModel.prototype.ClickDelete=function(){i.DispatchEvent("LOrder.delete",{id:u,fn:function(){p(y,w,{block:"list",page:1})}})};OrderViewModel.prototype.ClickCancel=function(){i.DispatchEvent("LOrder.cancel",{id:u,fn:function(){p(y,w,{block:"list",page:1})}})};OrderViewModel.prototype.ClickPay=function(){i.DispatchEvent("LOrder.pay",{id:u,fn:function(){}})};OrderViewModel.prototype.ClickCheck=function(){i.DispatchEvent("LOrder.check",{id:u,fn:function(){p(y,w,{block:"detail",id:Routing.params.id})}})};OrderViewModel.prototype.ClickRepeat=function(){i.DispatchEvent("LOrder.repeat",{id:u})};OrderViewModel.prototype.ClickReturn=function(){i.DispatchEvent("LOrder.return",{id:u})};v=new OrderViewModel(n);Parameters.cache.order.info=v}v.AddContent(x);k(v)}}else{i.WidgetLoader(true,n.container.widget);i.ShowMessage(x.msg,function(){p("purchases","Мои покупки",{block:"list",page:1})})}})}function o(u){i.RenderTemplate(u,n,null,function(v){q();o(v)},function(){m()},"list")}function d(){i.WidgetLoader(true,n.container.widget);if(n.animate){n.animate()}}function k(u){i.RenderTemplate(u,n,null,function(v){b();k(v)},function(){m()},"detail")}function p(u,w,v){Routing.SetHash(u,w,v)}};var OrderListViewModel=function(){var a=this;a.list=ko.observableArray();a.paging=ko.observableArray();a.count=0;a.AddContent=function(b){a.list=ko.observableArray();$.each(b,function(c){if(c=="count_order"){a.count=b[c]}else{a.list.push(new OrderListDetailViewModel(b[c]))}});a.AddPages()};a.AddPages=function(){var b=function(){Loader.Indicator("OrderListWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.count,{paging:Config.Paging},b)};a.ClickRefresh=function(){Parameters.cache.orderList={};Routing.SetHash("purchases","Мои покупки",{block:"list"})}};var OrderListDetailViewModel=function(f){var c=this,e="purchases",g="Мои покупки";c.id=f.id;c.cssFloatPopup="order_item";c.dateCreate=f.date_create;c.commentBuyer=f.comment_buyer;c.commentOperator=f.comment_operator;c.nameShop=f.name_shop;c.costShipping=f.cost_shipping;c.costPayment=f.cost_payment;c.sellCost=f.sell_cost;c.finalCost=f.final_cost;c.GetNamePay=function(h){if(h=="wait_check"){return"На проверке"}if(h=="wait_pay"){return"Ожидает оплаты"}if(h=="paid"){return"Оплачен"}if(h=="cancel"){return"Отменена"}if(h=="back"){return"Возвращена"}return false};c.GetNameOrder=function(h){if(h=="init"){return"Формируется"}if(h=="new"){return"Новый"}if(h=="process"){return"В просессе обработки"}if(h=="send"){return"Отправлен"}if(h=="delivered"){return"Получен покупателем"}if(h=="cancel"){return"Отменен"}return false};c.statusPay=f.status_pay;c.statusPayName=c.GetNamePay(f.status_pay);c.statusOrder=f.status_order;c.statusOrderName=c.GetNameOrder(f.status_order);c.viewShow=ko.computed(function(){return true},this);c.ClickShow=function(){a(e,g,{block:"detail",id:c.id})};c.viewEdit=ko.computed(function(){var h=f.status_order;if(h=="init"){return true}return false},this);c.ClickEdit=function(){d("LOrder.edit",{id:c.id})};c.viewRepeat=ko.computed(function(){var h=f.status_order;if(h=="delivered"||h=="send"||h=="cancel"){return true}return false},this);c.ClickRepeat=function(){d("LOrder.repeat",{id:c.id})};c.viewReturn=ko.computed(function(){var h=f.status_order;if(h=="delivered"||h=="send"||h=="cancel"){return true}return false},this);c.ClickReturn=function(){d("LOrder.return",{id:c.id,fn:function(){a(e,g,{id:c.id})}})};c.viewCanсel=ko.computed(function(){var h=f.status_order;if((h=="init"||h=="new")&&f.status_pay!="paid"){return true}return false},this);c.ClickCancel=function(){d("LOrder.cancel",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewDelete=ko.computed(function(){var h=f.status_order;if(h=="init"||h=="cancel"){return true}return false},this);c.ClickDelete=function(){d("LOrder.delete",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewCheck=ko.computed(function(){var h=f.status_order;if(h=="init"){return true}return false},this);c.ClickCheck=function(){d("LOrder.check",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewPay=ko.computed(function(){var h=f.status_order;if(h=="new"){return true}return false},this);c.ClickPay=function(){d("LOrder.pay",{id:c.id,fn:function(){}})};c.emptyTd=ko.observableArray();function b(){var j=0;if(c.viewShow()){j++}if(c.viewEdit()){j++}if(c.viewRepeat()){j++}if(c.viewReturn()){j++}if(c.viewCanсel()){j++}if(c.viewDelete()){j++}for(var h=1;h<=5-j;h++){c.emptyTd.push({id:h})}}function d(h,i){EventDispatcher.DispatchEvent(h,i)}function a(h,j,i){Routing.SetHash(h,j,i)}b()};var TestOrderList={Init:function(){if(typeof Widget=="function"){OrderListWidget.prototype=new Widget();var a=new OrderListWidget();a.Init(a)}else{setTimeout(function(){TestOrderList.Init()},100)}}};TestOrderList.Init();
var MessageWidget=function(){var p=this;p.widgetName="MessageWidget";p.version=1;p.minWidgetVersion=1;p.maxWidgetVersion=2;p.minTmplVersion=1;p.maxTmplVersion=2;p.InitWidget=h;var d={container:{widget:"content",def:"defaultMessageWidgetId"},tmpl:{path:"messageTmpl.html",id:{topic:"messageTopicTmpl",list:"messageListTmpl",empty:"messageEmptyListTmpl"}},error:{username:{empty:"Поле обязательно для заполнения",notFound:"Получатель не найден."},topic:{empty:"Поле обязательно для заполнения"},text:{empty:"Поле обязательно для заполнения"}},message:{noResult:"Писем нет :(",messageDelete:"Сообщение удалено.",topicDelete:"Тема Удалена.",severalTopicDelete:"Выбранные темы успешно удалены.",confirmDeleteMessage:"Вы уверены, что хотите удалить сообщение?",confirmDeleteTopic:"Вы уверены, что хотите удалить тему?",confirmDeleteSeveralTopic:"Вы уверены, что хотите удалить выбранные темы?",error:"Ошибка выполнения."},timer:10,animate:typeof AnimateMessage=="function"?AnimateMessage:null,paging:null};function h(){d.paging=Config.Paging;m();c();p.CheckRouteMessage()}function c(){var q=p.GetInputParameters("message");if(!$.isEmptyObject(q)){d=p.UpdateSettings1(d,q);if(q.defaultCount){d.paging.itemsPerPage=q.defaultCount}}Config.Containers.message=d.container}p.CheckRouteMessage=function(){if(Routing.route=="messages"){p.BaseLoad.Login(false,false,false,function(q){if(!q.err){p.BaseLoad.Tmpl(d.tmpl,function(){e();l()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});p.WidgetLoader(true)}})}else{p.WidgetLoader(true)}};function l(){p.WidgetLoader(false);var q=Routing.params;if(!q.block){q.block="topic"}if(q.block=="topic"){g();p.currentPage=Routing.GetCurrentPage()}else{if(q.block=="list"&&q.id){a(q.id)}}}function e(){p.BaseLoad.Script(PokupoWidgets.model.menu,function(){p.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function m(){p.AddEvent("w.change.route",function(){p.CheckRouteMessage()});p.AddEvent("Message.check.login",function(q){p.BaseLoad.UniqueUser("?username="+encodeURIComponent(q.dstUser()),function(r){if(r.check_username!="on"&&r.check_username!="off"){q.dstUserError(d.error.username.notFound)}else{q.dstUserError("")}})});p.AddEvent("Message.search",function(q){g(q)});p.AddEvent("Message.add",function(q){var r=q.modalForm();p.BaseLoad.UniqueUser("?username="+encodeURIComponent(r.dstUser()),function(s){if(s.check_username!="on"&&s.check_username!="off"){r.dstUserError(d.error.username.notFound)}else{r.dstUserError("");p.BaseLoad.MessageAdd($("form#"+r.cssFormMessage),function(t){if(!t.err){g()}else{p.QueryError(t,function(){p.DispatchEvent("Message.add",q)})}})}})});p.AddEvent("Message.read.topic",function(r){for(var q=0;q<=r.length-1;q++){p.BaseLoad.TopicRead(r[q].idTopic(),function(s){if(s.result!="ok"){p.QueryError(s,function(){p.DispatchEvent("Message.read.topic",r)})}else{p.DispatchEvent("w.change.count.mess")}})}});p.AddEvent("Message.delete.topic",function(r){for(var q=0;q<=r.length-1;q++){p.BaseLoad.TopicDelete(r[q].idTopic(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages","Сообщения",{})},false)}else{p.DispatchEvent("w.change.count.mess")}})}});p.AddEvent("Message.delete.oneTopic",function(q){p.Confirm(d.message.confirmDeleteTopic,function(){p.BaseLoad.TopicDelete(q,function(r){if(r.result!="ok"){p.ShowMessage(d.message.error,function(){},false)}else{p.DispatchEvent("w.change.count.mess");Routing.SetHash("messages","Сообщения",{})}})})});p.AddEvent("Message.read.message",function(r,q){p.BaseLoad.MessageSetRead(r.id(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages",q.nameTopic(),{block:"list",id:q.topicId()})},false)}else{p.DispatchEvent("w.change.count.mess")}})});p.AddEvent("Message.unread.message",function(r,q){p.BaseLoad.MessageSetUnread(r.id(),function(s){if(s.result!="ok"){p.ShowMessage(d.message.error,function(){Routing.SetHash("messages",q.nameTopic(),{block:"list",id:q.topicId()})},false)}else{p.DispatchEvent("w.change.count.mess")}})});p.AddEvent("Message.reply",function(q){p.BaseLoad.MessageAdd($("form#"+q.cssFormMessage),function(s){if(!s.err){var r=new MessageViewModel(s,q.topic,d);q.topic.messages.push(r);r.ClickExpand();q.ClickCancel()}else{p.QueryError(s,function(){p.DispatchEvent("Message.reply",q)},function(){q.ClearForm()})}})});p.AddEvent("Message.empty",function(){g()})}function b(){p.ClearContainer(d)}function f(){p.InsertContainer(d,"topic")}function j(){p.InsertContainer(d,"list")}function i(){p.InsertContainer(d,"empty")}function g(r){var s=(Routing.GetCurrentPage()-1)*d.paging.itemsPerPage;var q=s+"/"+d.paging.itemsPerPage;if(r){q=q+"/"+encodeURIComponent(r)}p.BaseLoad.TopicList(q,function(u){TopicMessageViewModel.prototype=new Widget();var t=new TopicMessageViewModel(p,d);if(!u.err){t.AddContent(u);if(r){t.searchMessage(r)}f();k(t)}else{var v=d.message.noResult;if(u.msg){v=u.msg}t.SetErrorMessage(v);if(r){t.searchMessage(r)}i();n(t)}})}function a(r){var q="unread";if(Routing.params.info){q=Routing.params.info}p.BaseLoad.TopicInfo(r,q,function(t){var s=new ListMessageViewModel(d);s.AddContent(t);j();o(s)})}function k(q){p.RenderTemplate(q,d,null,function(r){f();k(r)},function(){b()},"topic")}function o(q){p.RenderTemplate(q,d,function(){var s=q.messages();var r=[];$.each(s,function(u){if(s[u].IsNew()&&!s[u].IsMy()){s[u].ClickExpand();r.push(s[u])}});if(s.length==r.length){$("."+s.cssExpandAll).hide();$("."+s.cssCollapseAll).show()}var t=0;$.each(r,function(u){setTimeout(function(){r[u].InitTimer()},t);t=t+r[u].timeout})},function(r){j();o(r)},function(){b()},"list")}function n(q){p.RenderTemplate(q,d,null,function(r){i();n(r)},function(){b()},"empty")}};var TopicMessageViewModel=function(d,c){var a=this;a.messageError=ko.observable();a.messages=ko.observableArray();a.paging=null;a.countAll=ko.observable();a.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);a.modalForm=ko.observable(new FormMessageViewModel(a,c));a.cssSelectAll="messagesSelectAll";a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.messages(),function(f){$("#"+f.cssCheckboxMessage())[0].checked=e;f.isSelected(e)})});a.searchMessage=ko.observable();a.SetErrorMessage=function(e){a.messageError(e)};a.GetSelected=function(){var e=[];ko.utils.arrayForEach(a.messages(),function(f){if(f.isSelected()){e.push(f)}});return e};a.ClickSearch=function(){b("Message.search",a.searchMessage())};a.ClickRead=function(){var e=a.GetSelected();var f=[];$.each(e,function(g){if(!e[g].IsMy()&&e[g].IsNew()){e[g].SetStatus("read");f[g]=e[g]}e[g].isSelected(false)});if(f.length>0){b("Message.read.topic",f)}};a.ClickDelete=function(){a.Confirm(c.message.confirmDeleteSeveralTopic,function(){var e=a.GetSelected();$.each(e,function(f){a.messages.remove(e[f])});EventDispatcher.DispatchEvent("Message.delete.topic",e);if(a.messages().length==0){b("Message.empty")}})};a.AddContent=function(f){var e=f.shift();a.countAll(e.count_topic);$.each(f,function(g){a.messages.push(a.NewTopic(f[g]))});a.AddPages()};a.AddNewInContent=function(e){a.messages.unshift(a.NewTopic(e))};a.NewTopic=function(e){TopicViewModel.prototype=new Widget();return new TopicViewModel(e,a,c)};a.AddPages=function(){var e=function(){Loader.Indicator("Message",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countAll(),c,e)};a.ClickSelectAll=function(){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.messages(),function(h){$("#"+h.cssCheckboxMessage())[0].checked=g;h.isSelected(g)})};function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var TopicViewModel=function(d,c,b){var a=this;a.id=d.id;a.dateMessage=ko.observable(d.date_message);a.nameTopic=ko.observable(d.name_topic);a.idTopic=ko.observable(d.id_topic);a.srcUser=ko.observable(d.src_user);a.dstUser=ko.observable(d.dst_user);a.logoSrcUser=ko.observable(d.logo_src_user);a.logoDstUser=ko.observable(d.logo_dst_user);a.textMessage=ko.observable(d.text_message);a.status=ko.observable(d.status);a.countMessage=ko.observable(d.count_message);a.copyMail=ko.observable(d.copyMail);a.cssCheckboxMessage=ko.observable("message_item_"+a.id);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(e){var h=c.messages().length;var g=[];for(var f=0;f<=h-1;f++){if(c.messages()[f].isSelected()){g.push(c.messages()[f].id)}}if(g.length<h){$("#"+c.cssSelectAll)[0].checked=false}else{$("#"+c.cssSelectAll)[0].checked=true}$("#"+a.cssCheckboxMessage())[0].checked=e});a.IsMy=ko.computed(function(){var e=Parameters.cache.userInformation;if(e.login==a.srcUser()){return true}return false},this);a.IsNew=ko.computed(function(){if(a.status()=="send"&&!a.IsMy()){return true}return false},this);a.SetStatus=function(e){a.status(e)};a.ClickTopic=function(){Routing.SetHash("messages",a.nameTopic(),{block:"list",id:a.idTopic()})};a.ClickCheckboxMessage=function(g,f){var e=$("#"+g.cssCheckboxMessage());var h=e.is(":checked");if(h==false){e[0].checked=true;a.isSelected(true)}else{e[0].checked=false;a.isSelected(false)}};a.ClickDelete=function(){a.Confirm(b.message.confirmDeleteSeveralTopic,function(){EventDispatcher.DispatchEvent("Message.delete.topic",[a]);c.messages.remove(a);if(c.messages().length==0){EventDispatcher.DispatchEvent("Message.empty")}})};a.FormatDateMessage=function(){var j=a.dateMessage().split(" ");var e=j[0].split("-");var g=j[1].split(":");var f=new Date(e[2],e[1].replace(/^0+/,"")-1,e[0].replace(/^0+/,""),g[0].replace(/^0+/,""),g[1].replace(/^0+/,""),g[2].replace(/^0+/,""));var h=new Date();var i=(h-f)/1000/3600;if(i<24&&f.getDay()==h.getDay()){return f.getHours()+":"+a.PadPithZeroes(f.getMinutes(),2)}return f.getDate()+" "+Config.Base.toStringMonth[f.getMonth()]};a.PadPithZeroes=function(f,e){var g=""+f;while(g.length<e){g="0"+g}return g}};var FormMessageViewModel=function(c,d){var a=this;a.dstUser=ko.observable();a.dstUserError=ko.observable();a.topicName=ko.observable();a.topicNameError=ko.observable();a.text=ko.observable();a.textError=ko.observable();a.copyMail=ko.observable();a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(e()){b("Message.add",c)}};a.ClickCancel=function(){f()};a.OnBlurEvent=function(){b("Message.check.login",a)};function f(){a.dstUser("");a.dstUserError("");a.topicName("");a.topicNameError("");a.text("");a.textError("");a.copyMail("")}function e(){if(!a.dstUser()){a.dstUserError(d.error.username.empty)}else{a.dstUserError()}if(!a.topicName()){a.topicNameError(d.error.topic.empty)}else{a.topicNameError("")}if(!a.text()){a.textError(d.error.text.empty)}else{a.textError()}if(a.dstUserError()||a.topicNameError()||a.textError()){return false}return true}function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var SimpleFormMessageViewModel=function(c,b){var a=this;a.text=ko.observable();a.textError=ko.observable();a.topic=c;a.copyMail=ko.observable(false);a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(d()){EventDispatcher.DispatchEvent("Message.reply",a)}};a.ClickCancel=function(){$("#"+a.cssFormMessage).hide(200);a.ClearForm()};a.ClearForm=function(){a.text("");a.textError("");a.copyMail(false)};function d(){if(!a.text()){a.textError(b.error.text.empty)}else{a.textError()}if(a.textError()){return false}return true}};var ListMessageViewModel=function(b){var a=this;a.topicId=ko.observable();a.nameTopic=ko.observable();a.messages=ko.observableArray();a.simpleForm=new SimpleFormMessageViewModel(a,b);a.cssExpandAll="expand";a.cssCollapseAll="collapse";a.AddContent=function(c){a.topicId(c.id_topic);a.nameTopic(c.name_topic);$.each(c.messages,function(d){a.messages.push(new MessageViewModel(c.messages[d],a,b))})};a.ClickBack=function(){Routing.SetHash("messages","Сообщения",{block:"topic",page:Routing.GetLastPageNumber()})};a.ClickDelete=function(){EventDispatcher.DispatchEvent("Message.delete.oneTopic",a.topicId())};a.ClickExpand=function(){var c=[];var d=$("."+a.cssExpandAll),e=$("."+a.cssCollapseAll);if(d){d.hide()}if(e){e.show()}$.each(a.messages(),function(g){a.messages()[g].ClickExpand();if(a.messages()[g].status()=="send"&&!a.messages()[g].IsMy()){c.push(a.messages()[g])}});var f=0;$.each(c,function(g){setTimeout(function(){c[g].InitTimer()},f);f=f+c[g].timeout})};a.ClickCollapse=function(){$("."+a.cssExpandAll).show();$("."+a.cssCollapseAll).hide();$.each(a.messages(),function(c){a.messages()[c].ClickCollapse();if(a.messages()[c].status()=="send"&&!a.messages()[c].IsMy()){a.messages()[c].stopTime=true}})}};var MessageViewModel=function(f,d,e){var b=this;b.id=ko.observable(f.id);b.copyMail=ko.observable(f.copy_mail);b.dateMessage=ko.observable(f.date_message);b.dstUser=ko.observable(f.dst_user);b.logoDstUser=ko.observable(f.logo_dst_user);b.srcUser=ko.observable(f.src_user);b.logoSrcUser=ko.observable(f.logo_src_user);b.status=ko.observable(f.status);b.textMessage=ko.observable(f.text_message);b.time=0;b.timeout=f.text_message.length/250*e.timer;b.stopTime=false;b.IsNew=ko.computed(function(){if(b.status()=="send"){return true}return false},this);b.IsMy=ko.computed(function(){var h=Parameters.cache.userInformation;if(h.login==b.srcUser()){return true}return false},this);b.cssPrevieClear="previe_message_"+b.id();b.cssPrevie=ko.computed(function(){var h=b.cssPrevieClear;if(b.IsNew()){h=h+" new"}return h},this);b.cssFull="full_message_"+b.id();b.isExpand=ko.observable(false);b.FormatDateMessage=function(){var n=b.dateMessage().split(" ");var h=n[0].split("-");var j=n[1].split(":");var i=new Date(h[2],h[1].replace(/^0+/,"")-1,h[0].replace(/^0+/,""),j[0].replace(/^0+/,""),j[1].replace(/^0+/,""),j[2].replace(/^0+/,""));var k=new Date();var l=(k-i)/1000/3600;if(l<24&&i.getDay()==k.getDay()){return i.getHours()+":"+b.PadPithZeroes(i.getMinutes(),2)}return i.getDate()+" "+Config.Base.toStringMonth[i.getMonth()]};b.PadPithZeroes=function(i,h){var j=""+i;while(j.length<h){j="0"+j}return j};b.ClickReply=function(){var h=d.simpleForm.cssFormMessage;$("#"+h).show(200);$("#"+h)[0].scrollIntoView(250)};b.ClickRead=function(){if(!b.IsMy()){c("Message.read.message",b,d);a("read")}};b.ClickUnread=function(){c("Message.unread.message",b,d);a("send")};b.ClickExpand=function(){b.isExpand(true);$("."+b.cssPrevieClear).hide();$("."+b.cssFull).show();if(b.status()=="send"){b.time=0;b.stopTime=false;g()}};b.ClickCollapse=function(){b.isExpand(false);$("."+b.cssPrevieClear).show();$("."+b.cssFull).hide();b.stopTime=true};function g(){setTimeout(function(){if(!b.stopTime){b.time=b.time+1;if(b.time>=b.timeout){b.ClickRead();return true}else{g()}}},1000);return false}function c(h,i){EventDispatcher.DispatchEvent(h,i)}function a(h){b.status(h)}};var TestMessage={Init:function(){if(typeof Widget=="function"){MessageWidget.prototype=new Widget();var a=new MessageWidget();a.Init(a)}else{setTimeout(function(){TestMessage.Init()},100)}}};TestMessage.Init();
window.ButtonPaymentWidget=function(){var n=this;n.widgetName="ButtonPaymentWidget";n.version=1.1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=f;var e={container:{widget:"content",def:"defaultPaymentWidgetId"},containerButton:null,tmpl:{path:"buttonPaymentTmpl.html",id:{content:"paymentPageTmpl",skin:"buttonPaymentImpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов."},animate:typeof AnimateButtonPayment=="function"?AnimateButtonPayment:null,title:"Оплатить",skinFromMemory:false,uniq:null,source:null,sourceVal:null};function f(){b();l();h()}function b(){var q=n.GetInputParameters("buttonPayment");if(!$.isEmptyObject(q)){e=n.UpdateSettings1(e,q)}Config.Containers.buttonPayment=e.container}n.SetParameters=function(t){e.containerButton=t.element;var q=n.GetInputParameters("buttonPayment");if(!$.isEmptyObject(q)){if(q.tmpl&&q.tmpl.id&&q.tmpl.id.skin){e.skinFromMemory=true}e=n.UpdateSettings1(e,q)}var r=t.options.params;for(var s in r){switch(s){case"tmpl":if(r.tmpl){if(r.tmpl.path){e.tmpl.path=r.tmpl.path}if(r.tmpl.id){for(var s in r.tmpl.id){e.tmpl.id[s]=r.tmpl.id[s]}}}break;case"title":e.title=r.title;break;case"uniq":e.uniq=r.uniq;break;case"orderId":e.source="order";e.sourceVal=r.orderId;break;case"goodsId":e.source="goods";e.sourceVal=r.goodsId;break;case"amount":e.source="amount";e.sourceVal=r.amount;break}}Config.ButtonPayment=e};function h(){if(Routing.route=="payment"){n.BaseLoad.Tmpl(e.tmpl,function(){c();var q=Routing.params;if(q.orderId){i(q.orderId)}if(q.goodsId){m(q.goodsId)}if(q.amount){j(q.amount)}})}else{n.WidgetLoader(true)}}function l(){n.AddEvent("BPayment.tmpl_"+e.uniq,function(q){k();p()});n.AddEvent("w.change.route",function(){h()});n.AddEvent("w.ready",function(){if(e.containerButton!=null){Loader.InsertContainer(e.containerButton);n.BaseLoad.Tmpl(e.tmpl,function(){n.DispatchEvent("BPayment.tmpl_"+e.uniq)})}});n.AddEvent("BPayment.submit",function(r){c();var q=[];$.each(r.inData(),function(u){if(r.inData()[u].name()=="MOBILE_PHONE"){q.push(r.inData()[u].name()+"="+encodeURIComponent(r.inData()[u].value().replace(/\s/g,"").replace(/-/g,"")))}else{q.push(r.inData()[u].name()+"="+encodeURIComponent(r.inData()[u].value()))}});var t=q.join("&");var s=Routing.params;if(s.orderId){t=s.orderId+"?"+t;i(t)}if(s.goodsId){t=s.goodsId+"?"+t;m(t)}if(s.amount){t=s.amount+"/"+Parameters.shopId+"?"+t;j(t)}})}function i(q){n.BaseLoad.InvoicesOrder(q,function(r){if(n.QueryError(r,function(){i(q)},function(){Routing.SetHash("default","Домашняя",{})})){d(r)}})}function m(q){n.BaseLoad.InvoicesGoods(q,function(r){d(r)})}function j(q){n.BaseLoad.InvoicesAmount(q+"/"+Parameters.shopId,function(r){d(r)})}function a(){n.ClearContainer(e)}function k(){$(e.containerButton).html($("script#"+n.GetTmplName1(e,"skin")).html())}function c(){n.InsertContainer(e,"content")}function p(){var q=new ButtonPaymentViewModel(e);o(q)}function d(s){var r=new PaymentViewModel(e);var t=[];var q=s.pay_form.hidden_field;$.each(q,function(u){t.push(q[u].name+"="+encodeURIComponent(q[u].value))});if(t){$.cookie(Config.Base.cookie.orderId,t.join("&"))}r.AddContent(s);g(r)}function o(r){var q=$(e.containerButton);try{ko.cleanNode(q.children()[0]);ko.applyBindings(r,q.children()[0]);if(e.animate){e.animate()}}catch(s){n.Exception("Ошибка шаблона ["+n.GetTmplName1(e,"skin")+"]",s);if(e.tmpl.custom){delete e.tmpl.custom;n.BaseLoad.Tmpl(e.tmpl,function(){k();o(r)})}else{q.html("");n.WidgetLoader(true)}}}function g(q){n.RenderTemplate(q,e,function(r){$.each(r.inData(),function(s){if(r.inData()[s].mask()){$("#"+r.inData()[s].cssField()).mask(r.inData()[s].mask(),{placeholder:"_"})}})},function(r){c();g(r)},function(){a()},"content")}};var ButtonPaymentViewModel=function(d){var b=this,c="payment",e="Оплата заказа";b.title=d.title;b.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];if(d.source=="order"){a({orderId:d.sourceVal})}if(d.source=="goods"){a({goodsId:d.sourceVal})}if(d.source=="amount"){a({amount:d.sourceVal})}};function a(f){Routing.SetHash(c,e,f)}};var PaymentViewModel=function(c){var b=this;b.title=c.title;b.instruction=ko.observable();b.cssInstruction="instructtion_print_block";b.outData=ko.observableArray();b.inData=ko.observableArray();b.isInData=ko.observable(false);b.cssInDataForm="in_data_block";b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm=ko.observable(false);b.urlInvoice=ko.observable();b.cssInvoice="invoice_print_block";b.Print=function(e){var d=window.open();d.document.write($("#"+e).html());d.print();d.close()};b.ClickPrintInstruction=function(){b.Print(b.cssInstruction)};b.ClickPrintInvoice=function(){b.Print(b.cssInvoice)};b.Back=function(){var d=Parameters.cache.lastPage;if(d.route=="payment"||!d.route){Routing.SetHash("purchases","Заказ № "+Routing.params.orderId,{block:"detail",id:697})}else{Routing.SetHash(d.route,d.title,d.data)}};b.ClickPay=function(){$("#"+b.payForm.cssPayForm).submit()};b.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};b.ClickSubmit=function(){if(a()){EventDispatcher.DispatchEvent("BPayment.submit",b)}};function a(){var d=true;$.each(b.inData(),function(e){if(!b.inData()[e].ValidateField()){d=false;return false}});return d}b.AddContent=function(d){b.instruction(null);if(d.hasOwnProperty("instruction")){b.instruction(d.instruction)}b.outData=ko.observableArray();if(d.hasOwnProperty("out_data")){$.each(d.out_data,function(e){b.outData.push(d.out_data[e])})}b.isPayForm(false);b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm(false);if(d.hasOwnProperty("pay_form")){b.isPayForm(true);b.payForm.action(d.pay_form.action);b.payForm.method(d.pay_form.method);if(d.pay_form.hasOwnProperty("new_window")&&d.pay_form.new_window=="yes"){b.payForm.target("_blank")}$.each(d.pay_form.hidden_field,function(e){var f=d.pay_form.hidden_field[e];if(!d.pay_form.hidden_field[e].hasOwnProperty("value")){f.value=""}b.payForm.field.push(d.pay_form.hidden_field[e])})}b.isInData(false);b.inData=ko.observableArray();if(d.hasOwnProperty("in_data")){b.isInData(true);$.each(d.in_data,function(e){var f=new PaymentFieldViewModel();f.AddContent(d.in_data[e]);b.inData.push(f)})}b.urlInvoice(null);if(d.hasOwnProperty("url_invoice")){b.urlInvoice(d.url_invoice)}}};var PaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var TestButtonPayment={Init:function(){if(typeof Widget=="function"){window.ButtonPaymentWidget.prototype=new Widget();var a=new window.ButtonPaymentWidget();a.settings.uniq=EventDispatcher.GetUUID();a.Init(a)}else{setTimeout(function(){TestButtonPayment.Init()},100)}}};TestButtonPayment.Init();
var StandalonePaymentWidget=function(){var o=this;o.widgetName="StandalonePaymentWidget";o.version=1;o.minWidgetVersion=1;o.maxWidgetVersion=2;o.minTmplVersion=1;o.maxTmplVersion=2;o.InitWidget=m;var u={container:{content:{widget:"content",def:"defaultStandalonePaymentWidgetId"},button:{widget:"standalonePaymentWidgetId",def:"defaultStandalonePaymentWidgetId"}},showButton:false,title:"Оплатить",tmpl:{path:"standalonePaymentTmpl.html",id:{content:"standalonePaymentPageTmpl",paymentList:"standalonePaymentListTmpl",button:"standalonePaymentButtonImpl",error:"standalonePaymentErrorTmpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов.",email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},count:{empty:"Поле обязательно для заполнения",count:"Введите количество товара"},coast:{empty:"Поле обязательно для заполнения",count:"Введите стоимость услуги",integer:"Недопустимое значение"}},regular:{email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/},animate:typeof AnimateStandalonePayment=="function"?AnimateStandalonePayment:null,containerButton:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:false,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",userParams:{},backUrl:""};function m(){g()}function w(){var z=o.GetInputParameters("standalonePayment");if(!$.isEmptyObject(z)){u=o.UpdateSettings1(u,z);var y=Routing.params;if(z.title){u.title=z.title}if(z.idGoods){u.idGoods=z.idGoods;u.showAmount=false}else{if(y.idGoods){u.idGoods=y.idGoods;u.showAmount=false}else{u.idShop=JSSettings.shopId}}if(z.count){u.count=z.count;u.showCount=false}else{if(y.count){u.count=y.count;u.showCount=false}}if(z.amount){u.amount=z.amount;u.showAmount=false}else{if(y.amount){u.amount=y.amount;u.showAmount=false}else{if(!u.idGoods){u.showAmount=true}}}if(z.uid){u.uid=z.uid}if(y.uid){u.uid=y.uid}if(z.idShopPartner){u.idShopPartner=z.idShopPartner}if(y.idShopPartner){u.idShopPartner=y.idShopPartner}if(z.mailUser){u.mailUser=z.mailUser}else{if(y.mailUser){u.mailUser=y.mailUser}}if(z.idMethodPayment){u.idMethodPayment=z.idMethodPayment}if(y.idMethodPayment){u.idMethodPayment=y.idMethodPayment}if(z.description){u.description=z.description}if(y.description){u.description=y.description}if(z.backUrl){u.backUrl=z.backUrl}else{if(y.backUrl){u.backUrl=y.backUrl}}if(y.userParams){var A=decodeURIComponent(y.userParams);u.userParams=A.replace(/(^\?)/,"").split("&").map(function(B){return B=B.split("="),this[B[0]]=B[1],this}.bind({}))[0]}if(z.userParams){$.each(z.userParams,function(C,B){u.userParams[C]=B})}}Config.Containers.standalonePayment=u.container}function g(){w();n();o.BaseLoad.Tmpl(u.tmpl,function(){if(Routing.route=="standalone_payment"){if(u.idGoods!=null){o.BaseLoad.GoodsInfo(u.idGoods,"1000000",function(y){u.goodsInfo=y;if(u.idShopPartner==null){r()}if(u.idShopPartner!=null){q()}})}if(u.idShop!=null&&u.idGoods==null){j()}}else{if(u.showButton&&Routing.route!="status_payment"){o.InsertContainer.Button();c()}else{o.WidgetLoader(true)}}})}function n(){o.AddEvent("SPayment.payment.select",function(y){u.idMethodPayment=y.idMethodPayment();u.paymentInfo=y.paymentInfo;u.mailUser=y.mailUser();if(u.idGoods!=null){u.count=y.count();if(u.idShopPartner==null){r()}if(u.idShopPartner!=null){q()}}if(u.idShop!=null){u.amount=y.amount();j()}});o.AddEvent("SPayment.back",function(){u.idMethodPayment=null;u.mailUser=null;g()});o.AddEvent("w.change.route",function(){g()});o.AddEvent("SPayment.payment.clear",function(){u.idMethodPayment=null;u.mailUser=null;g()});o.AddEvent("SPayment.form.submit",function(z){o.InsertContainer.Content();var y=[];$.each(z.inData(),function(B){if(z.inData()[B].name()=="MOBILE_PHONE"){y.push(z.inData()[B].name()+"="+encodeURIComponent(z.inData()[B].value().replace(/\s/g,"").replace(/-/g,"")))}else{y.push(z.inData()[B].name()+"="+encodeURIComponent(z.inData()[B].value()))}});var A=y.join("&");if(Routing.params.orderId){A=Routing.params.orderId+"?"+A;GetDataOrder(A)}if(Routing.params.goodsId){A=Routing.params.goodsId+"?"+A;r(A)}if(Routing.params.amount){A=Routing.params.amount+"/"+Parameters.shopId+"?"+A;o.GetData.Amount(A)}})}function p(){var y="";var z=[];$.each(u.userParams,function(B,A){z.push(B+"="+A)});y=encodeURIComponent(encodeURIComponent(z.join("&")));return y}function h(){var z=u.idShop+"/";if(u.idShopPartner){z=z+u.idShopPartner+"/"}var y=[];if(u.amount){y.push("amount="+u.amount)}if(u.uid){y.push("uid="+u.uid)}if(u.idMethodPayment){y.push("idMethodPayment="+u.idMethodPayment)}y.push("description="+u.description);if(y.length>0){z=z+"?"+y.join("&")}o.BaseLoad.InvoicesService(z,function(A){a(A)})}function r(){var z=u.idGoods+"/";if(u.count){z=z+u.count+"/"}var y=[];if(u.mailUser){y.push("mailUser="+u.mailUser)}if(u.idMethodPayment){y.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams){y.push("userParams="+p())}if(y.length>0){z=z+"?"+y.join("&")}o.BaseLoad.InvoicesGoods(z,function(A){a(A)})}function q(){var z=u.idGoods+"/";if(u.count){z=z+u.count+"/"}if(u.idShopPartner){z=z+u.idShopPartner+"/"}var y=[];if(u.mailUser){y.push("mailUser="+u.mailUser)}if(u.idMethodPayment){y.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams){y.push("userParams="+p())}if(y.length>0){z=z+"?"+y.join("&")}o.BaseLoad.InvoicesPartnerGoods(z,function(A){a(A)})}function j(){var z=u.idShop+"/";if(u.idShopPartner){z=z+u.idShopPartner+"/"}var y=[];if(u.amount){y.push("amount="+u.amount)}if(u.uid){y.push("uid="+u.uid)}if(u.mailUser){y.push("mailUser="+u.mailUser)}if(u.idMethodPayment){y.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams){y.push("userParams="+p())}y.push("description="+u.description);if(y.length>0){z=z+"?"+y.join("&")}o.BaseLoad.InvoicesService(z,function(A){a(A)})}function s(y){$(y).empty().html("")}function i(){o.InsertContainer(u,"button",u.container.button.widget)}function x(){o.InsertContainer(u,"paymentList",u.container.content.widget)}function e(){o.InsertContainer(u,"content",u.container.content.widget)}function d(){o.InsertContainer(u,"error",u.container.content.widget)}function c(){var y=new StandaloneButtonPaymentViewModel(u);t(y)}function a(z){if(z.hasOwnProperty("err")){d();l(z)}else{if(!z.hasOwnProperty("pay_form")){var y=new StandalonePaymentListViewModel(u);y.error.base("");y.show.errorBase(false);if(z){$.each(z,function(A){u.paymentList=true;y.payments.push(new StandalonePaymentItemViewModel(z[A],y))})}x();k(y)}else{e();v(z)}}}function v(B){var A=new StandalonePaymentViewModel(u);var C=[];var z={};if(B.pay_form){z=B.pay_form.hidden_field}var y=null;$.each(z,function(D){C.push(z[D].name+"="+encodeURIComponent(z[D].value));if(z[D].name=="PKP_ID_ORDER"){y=z[D].value}});if(y){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+y)}else{if(C){$.cookie(Config.Base.cookie.orderId,C.join("&"))}}A.paymentInfo=u.paymentInfo;A.AddContent(B);f(A)}function l(z){var y=new StandalonePaymentErrorViewModel(z,u);b(y)}function t(y){o.RenderTemplate(y,u,null,function(z){i();t(z)},function(){s("#"+u.container.button.widget)},"button",null,"button")}function k(y){o.RenderTemplate(y,u,function(z){if(u.showAmount){$("#"+z.cssAmount).bind("textchange",function(B,A){var C=$(this).val();z.amount(C);u.amount=C;setTimeout(function(){if(C==u.amount){h()}},500)});$("#"+z.cssAmount).focus()}$("#"+z.cssCount).bind("textchange",function(B,A){z.count($(this).val())})},function(z){x()();k(z)},function(){s("#"+u.container.content.widget)},"paymentList",null,"content")}function f(y){o.RenderTemplate(y,u,null,function(z){e();f(z)},function(){s("#"+u.container.content.widget)},"content",null,"content")}function b(y){o.RenderTemplate(y,u,null,function(z){e();f(z)},function(){s("#"+u.container.content.widget)},"error",null,"content")}};var StandaloneButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{})}};var StandalonePaymentListViewModel=function(e){var d=this;d.isGoodsId=ko.observable();d.title=ko.observable();d.count=ko.observable();d.amount=ko.observable();d.formatAmount=ko.observable();d.cssAmount="pokupo_amount";d.cssCount="pokupo_count";if(e.idGoods){d.title(e.goodsInfo.main.chort_name);d.count(e.count);var g=e.count*parseFloat(e.goodsInfo.main.sell_end_cost);d.amount(g);d.isGoodsId(true)}if(e.idShop&&!e.idGoods){d.title(e.description);if(e.amount){d.amount(parseFloat(e.amount))}d.isGoodsId(false)}if(d.amount()){d.formatAmount=d.amount().toFixed(2)}d.mailUser=ko.observable();d.idMethodPayment=ko.observable(e.idMethodPayment);d.payments=ko.observableArray();d.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};d.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(e.showCount),showAmount:ko.observable(e.showAmount)};d.Cookie={Set:{UserEmail:function(h){$.cookie(Config.Base.cookie.userEmail,h)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var c="";if(e.mailUser){c=e.mailUser}else{if(d.Cookie.Get.UserEmail()){c=d.Cookie.Get.UserEmail()}}d.mailUser(c);function b(){if(!d.count()){d.error.count(e.Error.count.empty);d.show.errorCount(true);return false}if(parseInt(d.count())!=d.count()){d.error.count(e.Error.count.integer);d.show.errorCount(true);return false}d.error.count(null);d.show.errorCount(false);return true}function f(){var h=e.Error.coast;if(!d.amount()){d.error.amount(h.empty);d.show.errorAmount(true);return false}if(isNaN(d.amount())){d.error.amount(h.integer);d.show.errorAmount(true);return false}if(parseFloat(d.amount())!=d.amount()){d.error.amount(h.integer);d.show.errorAmount(true);return false}if(d.amount()<0.01){d.error.amount(h.integer);d.show.errorAmount(true);return false}d.error.amount(null);d.show.errorAmount(false);return true}function a(){var h=e.Error.email;if(!d.mailUser()){d.error.email(h.empty);d.show.errorEmail(true);return false}if(d.mailUser().length>64){d.error.email(h.maxLength);d.show.errorEmail(true);return false}if(!e.regular.email.test(d.mailUser())){d.error.email(h.regular);d.show.errorEmail(true);return false}d.error.email(null);d.show.errorEmail(false);return true}EventDispatcher.AddEventListener("SPayment.payment.validate",function(h){var i=true;if(!a()){i=false}if(!b()&&d.isGoodsId()){i=false}if(!f()&&!d.isGoodsId()){i=false}if(i){d.Cookie.Set.UserEmail(d.mailUser());h.callback()}});d.Back=function(){window.location.href=e.backUrl};d.AmountValidation=f};var StandalonePaymentItemViewModel=function(c,b){var a=this;a.id=c.id;a.namePayment=c.name_payment;a.costPayment=c.cost_payment;a.descPayment=c.desc_payment;a.instrPayment=c.instr_payment;a.logoPayment=c.logo_payment;a.timePayment=c.time_payment;a.itog=ko.computed(function(){if(b.amount()&&!b.AmountValidation()){return 0}var d=(b.amount()?parseFloat(b.amount()):0)+(a.costPayment?parseFloat(a.costPayment):0);if(d==0||isNaN(d)){return 0}else{d=d.toFixed(2);return d}},this);a.errorEmail=ko.observable();a.Click={SelectPayment:function(){b.idMethodPayment(a.id);b.paymentInfo=a;EventDispatcher.DispatchEvent("SPayment.payment.validate",{data:b,callback:function(){EventDispatcher.DispatchEvent("SPayment.payment.select",b)}})}}};var StandalonePaymentViewModel=function(c){var b=this;b.paymentInfo={};b.showPaymentInfo=false;b.instruction=ko.observable();b.cssInstruction="instructtion_print_block";b.idMethodPayment=c.idMethodPayment;b.outData=ko.observableArray();b.inData=ko.observableArray();b.isInData=ko.observable(false);b.cssInDataForm="in_data_block";b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm=ko.observable(false);b.urlInvoice=ko.observable();b.cssInvoice="invoice_print_block";b.Print=function(e){var d=window.open();d.document.write($("#"+e).html());d.print();d.close()};b.ClickPrintInstruction=function(){b.Print(b.cssInstruction)};b.ClickPrintInvoice=function(){b.Print(b.cssInvoice)};b.Back=function(){EventDispatcher.DispatchEvent("SPayment.back")};b.ClickPay=function(){$("#"+b.payForm.cssPayForm).submit()};b.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};b.ClickSubmit=function(){if(a()){EventDispatcher.DispatchEvent("SPayment.form.submit",b)}};b.AddContent=function(d){b.instruction(null);if(d.hasOwnProperty("instruction")){b.instruction(d.instruction)}b.outData=ko.observableArray();if(d.hasOwnProperty("out_data")){$.each(d.out_data,function(e){b.outData.push(d.out_data[e])})}b.isPayForm(false);b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm(false);if(d.hasOwnProperty("pay_form")){b.isPayForm(true);b.payForm.action(d.pay_form.action);b.payForm.method(d.pay_form.method);if(d.pay_form.hasOwnProperty("new_window")&&d.pay_form.new_window=="yes"){b.payForm.target("_blank")}$.each(d.pay_form.hidden_field,function(e){var f={name:"",value:""};if(d.pay_form.hidden_field[e].name){f.name=d.pay_form.hidden_field[e].name}if(d.pay_form.hidden_field[e].value){f.value=d.pay_form.hidden_field[e].value}b.payForm.field.push(f)})}b.isInData(false);b.inData=ko.observableArray();if(d.hasOwnProperty("in_data")){b.isInData(true);$.each(d.in_data,function(e){var f=new StandalonePaymentFieldViewModel(c);f.AddContent(d.in_data[e]);b.inData.push(f)})}b.urlInvoice(null);if(d.hasOwnProperty("url_invoice")){b.urlInvoice(d.url_invoice)}if(!$.isEmptyObject(b.paymentInfo)){b.showPaymentInfo=true}};function a(){var d=true;$.each(b.inData(),function(e){if(!b.inData()[e].ValidateField()){d=false;return false}});return d}};var StandalonePaymentFieldViewModel=function(b){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(c){if(c.hasOwnProperty("label")){a.label(c.label)}if(c.hasOwnProperty("help")){a.help(c.help)}if(c.hasOwnProperty("error")){a.error(c.error)}if(c.hasOwnProperty("name")){a.name(c.name);a.cssField("field_"+c.name)}if(c.hasOwnProperty("value")){a.value(c.value)}if(c.hasOwnProperty("required")){if(c.required=="yes"){a.required(true)}}if(c.hasOwnProperty("type_field")){a.typeField(c.type_field)}if(c.hasOwnProperty("list_select")){$.each(c.list_select,function(d){a.listSelect.push(c.list_select[d])})}if(c.hasOwnProperty("reg_exp")){a.regExp(c.reg_exp)}if(c.hasOwnProperty("mask")){a.mask(c.mask)}if(c.hasOwnProperty("maxlength")){a.maxlength(c.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(b.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(b.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var StandalonePaymentErrorViewModel=function(c,b){var a=this;a.code=c.err;a.message=c.msg;a.hasPaymentList=b.paymentList;a.ClickClearPayment=function(){EventDispatcher.DispatchEvent("SPayment.payment.clear")};a.ClickBack=function(){}};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var a=new StandalonePaymentWidget();a.Init(a)}else{setTimeout(function(){TestStandalonePayment.Init()},100)}}};TestStandalonePayment.Init();
var StatusPaymentWidget=function(){var j=this;j.widgetName="StatusPaymentWidget";j.version=1;j.minWidgetVersion=1;j.maxWidgetVersion=2;j.minTmplVersion=1;j.maxTmplVersion=2;j.InitWidget=h;var e={container:{widget:"content",def:"defaultStatusPaymentWidgetId"},tmpl:{path:"statusPaymentTmpl.html",id:"statusPaymentPageTmpl"},animate:typeof AnimateStatusPayment=="function"?AnimateStatusPayment:null,status:null,backUrl:""};function h(){b();i();f()}function b(){var k=j.GetInputParameters("statusPayment");if(!$.isEmptyObject(k)){e=j.UpdateSettings1(e,k)}Config.Containers.statusPayment=e.container}function a(){j.ClearContainer(e)}function c(){j.InsertContainer(e)}function f(){if(Routing.route=="status_payment"){var k=$.cookie(Config.Base.cookie.orderId);var m=$.cookie(Config.Base.cookie.userEmail);if(k){var n=Routing.GetParameter("name");var l=Routing.GetParameter("status");if(l){n=n+"/"+l}var o=n+"/?"+k+"&mailUser="+m;j.BaseLoad.Tmpl(e.tmpl,function(){j.BaseLoad.StatusPayment(o,function(p){j.BaseLoad.ShopInfo(function(q){d(p,q)})})})}else{j.WidgetLoader(true,e.container.widget);alert("Нет параметров инициализации!")}}else{j.WidgetLoader(true,e.container.widget)}}function i(){j.AddEvent("w.change.route",function(k){f()});j.AddEvent("StatusPaymentWidget.update",function(k){f()})}function d(k,m){var l=new StatusPaymentViewModel(k,m,e);c();g(l)}function g(k){j.RenderTemplate(k,e,null,function(l){c();g(l)},function(){a()})}};var StatusPaymentViewModel=function(d,e,c){var b=this;b.orderId=d.id_order;b.instruction=d.instruction;b.cssOrder="order_print_block";b.status=d.status;b.isPaid=ko.observable(false);if(b.status=="paid"){b.isPaid(true)}b.isWait=ko.observable(false);if(b.status=="wait_pay"){b.isWait(true)}b.isCancel=ko.observable(false);if(b.status=="cancel"){b.isCancel(true)}b.isBack=ko.observable(false);if(b.status=="back"){b.isBack(true)}b.outData=ko.observableArray();$.each(d.out_data,function(f){b.outData.push(new a(d.out_data[f]))});b.egoods=[];if(d.egoods){$.each(d.egoods,function(f){if(!d.egoods[f]["max_upload"]){d.egoods[f]["max_upload"]=false}if(!d.egoods[f]["expiration"]){d.egoods[f]["expiration"]=false}});b.egoods=d.egoods}b.Print=function(g){var f=window.open();f.document.write($("#"+g).html());f.print();f.close()};b.ClickPrintOrder=function(){b.Print(b.cssOrder)};b.ClickBack=function(){var f=e.site_shop;if(c.backUrl){f=c.backUrl}window.location.href=f};b.ClickRefresh=function(){EventDispatcher.DispatchEvent("StatusPaymentWidget.update")};b.showRefresh=false;if(Routing.GetParameter("status")=="success"&&b.status=="wait_pay"){b.showRefresh=true}function a(g){var f=this;f.label=ko.observable(g.label);f.value=ko.observable(g.value);f.help=ko.observable(g.help)}};var TestStatusPayment={Init:function(){if(typeof Widget=="function"){StatusPaymentWidget.prototype=new Widget();var a=new StatusPaymentWidget();a.Init(a)}else{setTimeout(function(){TestStatusPayment.Init()},100)}}};TestStatusPayment.Init();