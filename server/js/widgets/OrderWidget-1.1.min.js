var OrderWidget=function(){var v=this;v.widgetName="OrderWidget";v.version=1.1;v.minWidgetVersion=1;v.maxWidgetVersion=2;v.minTmplVersion=1;v.maxTmplVersion=2;var Y={container:{widget:"content",def:"defaultOrderWidgetId"},tmpl:{path:"orderTmpl.html",id:{step1:"orderFormStep1Tmpl",step1Confirm:"orderConfirmFormStep1Tmpl",step1Profile:"orderProfileFormStep1Tmpl",step2:"orderFormStep2Tmpl",step2Form:"orderDeliveryFormStep2Tmpl",step3:"orderFormStep3Tmpl",step4:"orderFormStep4Tmpl",step5:"orderFormStep5Tmpl"}},regular:{username:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,gender:/^[mw]$/,addressee:/^[a-zа-яёА-ЯЁA-Z\s]+$/,postIndex:/^[0-9]+$/},message:{addAddressDelivery:"Данные успешно сохранены.",failAddAddressDelivery:"Данные не сохранены. Попробуйте повторить запрос позднее.",deleteAddressDelivery:"Адрес доставки успешно удален.",confirmDeleteAddressDelivery:"Вы уверены, что хотите удалить адрес?",failDeleteAddressDelivery:"Адрес доставки не удален. Попробуйте повторить запрос позднее.",setDefaultDelivery:"Данные успешно обновлены.",failSetDefaultDelivery:"Данные не обновлены.",orderConfirm:"Ваш заказ подтвержден.",selectMethodPayment:"Необходимо выбрать способ оплаты.",selectAddress:"Необходимо выбрать метод доставки.",selectMethodShipping:"Необходимо выбрать метод доставки.",confirmDeleteOrder:"Вы уверны, что хотите удалить заказ?",deleteOrderConfirm:"Ваш заказ удален.",sendToken:"Код активации успешно выслан по указанным данным.",failSendToken:"Код не был отправлен. Попробуйте повторить запрос позднее."},error:{username:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},isChecked:{empty:"Вам необходимо прочитать и принять условия соглашения"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},gender:{empty:"Поле обязательно для заполнения"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"},addressee:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},phone:{empty:"Поле обязательно для заполнения",regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},confirmLater:{empty:"Для активации аккаунта требуется подтвердить хотя бы один из способов связи"}},animate:typeof AnimateOrder=="function"?AnimateOrder:null},O={type:null,id:null,sellerId:null,goodsId:null,count:null,content:null,delivery:{},shipping:{},payment:{}},V="order",J="Оформление заказа";v.InitWidget=M;function M(){U();B();c()}function U(){var ae=v.GetInputParameters(O);if(!$.isEmptyObject(ae)){Y=v.UpdateSettings1(Y,ae)}Config.Containers.order=Y.container}function c(){var af=Routing.params,ae=Parameters.cache;if(Routing.route==V){v.WidgetLoader(false);if(af.sellerId){O.sellerId=af.sellerId}if(af.create){v.BaseLoad.Login(false,false,false,function(ag){if(af.create=="fromCart"){if(ag.err){O.type="cart";O.goodsId=null;O.count=null;setTimeout(function(){ae.history.pop();var ah=ae.history.pop();if(ah.route==V&&ah.data.create){ah=ae.history.pop()}if(ah.route=="login"){ah=ae.history.pop()}w(ah.route,ah.title,ah.data,true)},1000)}else{F({create:"fromCart",sellerId:O.sellerId},function(){O.type="cart";z(function(){w(V,J,{step:2})})})}}else{if(af.create=="directly"){if(ag.err){O.type="directly";O.goodsId=af.goodsId;O.count=af.count;setTimeout(function(){ae.history.pop();var ah=ae.history.pop();if(ah.route==V&&ah.data.create){ah=ae.history.pop()}if(ah.route=="login"){ah=ae.history.pop()}w(ah.route,ah.title,ah.data,true)},1000)}else{F({create:"directly",sellerId:O.sellerId,goodsId:af.goodsId,count:af.count},function(){O.type="directly";O.goodsId=af.goodsId;O.count=af.count;ad(function(){w(V,J,{step:2})})})}}else{w("default","Домашняя",{})}}})}if(af.step){v.BaseLoad.Login(false,false,false,function(ag){v.BaseLoad.Tmpl(Y.tmpl,function(){if(af.id){O.id=af.id}if(af.step==1&&!af.block){if(ag.err){o()}else{w(V,J,{step:2})}}else{if(af.step==1&&af.block=="confirm"){K()}else{if(!ag.err&&af.step==1&&af.block=="profile"&&O.id){ac()}else{if(!ag.err&&af.step==2&&!af.block&&O.id){m()}else{if(!ag.err&&af.step==2&&af.block=="add"&&O.id){A()}else{if(!ag.err&&af.step==3&&O.id){k()}else{if(!ag.err&&af.step==4&&O.id){i()}else{if(af.step==5){g()}else{w("default","Домашняя",{})}}}}}}}}})})}}else{v.WidgetLoader(true)}}function B(){v.AddEvent("w.change.route",function(){c()});v.AddEvent("UInfo.logout",function(){Parameters.cache.order.step1.login={};Parameters.cache.order.step1.reg={};Parameters.cache.order.step1.confirm={};Parameters.cache.order.step1.profile={};Parameters.cache.order.step2={};Parameters.cache.order.step3={};Parameters.cache.order.step4={};Parameters.cache.order.step5={};Parameters.cache.payment=null;Parameters.cache.shipping=null;Parameters.cache.delivery=null;Parameters.cache.profile.personal={};O.type=null;O.id=null;O.sellerId=null;O.goodsId=null;O.count=null;O.content=null;O.delivery={};O.shipping={};O.payment={}});v.AddEvent("Order.step1.authentication",function(ae){v.BaseLoad.Login(ae.username,ae.password,ae.rememberMe,function(af){if(af.err){Parameters.cache.order.step1.reg.loginForm.error("Ошибка в логине или пароле");Parameters.cache.order.step1.reg.loginForm.password=null;S(Parameters.cache.order.step1.reg)}else{if(O.type=="directly"){F({create:"directly",sellerId:O.sellerId,goodsId:O.goodsId,count:O.count},function(){ad(function(){w(V,J,{step:2})})})}if(O.type=="cart"){F({create:"directly",sellerId:O.sellerId},function(){z(function(){w(V,J,{step:2})})})}}})});v.AddEvent("Order.step1.registration",function(ae){v.WidgetLoader(false);var ag=[];if(ae.username()){ag.push("username="+encodeURIComponent(ae.username()))}if(ae.phone()){ag.push("phone="+ae.phone().replace(/\s/g,""))}if(ae.email()){ag.push("email="+ae.email())}if(ag.length>0){var af="?"+ag.join("&")}v.BaseLoad.UniqueUser(af,function(ah){var ak=true;if(v.QueryError(ah,function(){EventDispatcher.DispatchEvent("Order.step1.registration",ae)})){if(!X(ah,ae)){ak=false}if(!y(ah,ae)){ak=false}if(!e(ah,ae)){ak=false}}else{ak=false}if(ak){var aj=[];if(ae.username()){aj.push("username="+encodeURIComponent(ae.username()))}if(ae.phone()){aj.push("phone="+ae.phone().replace(/\s/g,""))}if(ae.email()){aj.push("email="+ae.email())}if(ae.firstPassword()){aj.push("password="+encodeURIComponent(ae.firstPassword()))}if(aj.length>0){var ai="?"+aj.join("&")}v.BaseLoad.Registration(ai,function(al){Parameters.cache.order.step1.reg=ae;w(V,J,{step:1,block:"confirm"})})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step1.confirm",function(ae){v.WidgetLoader(false);var ag=[];ag.push("username="+encodeURIComponent(ae.username));if(!ae.mailConfirmLater()){ag.push("mail_token="+ae.mailToken())}if(!ae.phoneConfirmLater()){ag.push("sms_token="+ae.phoneToken())}var af="?"+ag.join("&");v.BaseLoad.ActivateUser(af,function(ah){var ai=true;if(v.QueryError(ah,function(){EventDispatcher.DispatchEvent("Order.step1.confirm",ae)})){if(!f(ah,ae)){ai=false}if(!T(ah,ae)){ai=false}}else{ai=false}if(ai){v.BaseLoad.Login(false,false,false,function(aj){Parameters.cache.order.step1.confirm=ae;if(!aj.err){if(O.type=="directly"){F({create:"directly",sellerId:O.sellerId,goodsId:O.goodsId,count:O.count},function(){ad(function(){w(V,J,{step:1,block:"profile"})})})}if(O.type=="fromCart"){F({create:"directly",sellerId:O.sellerId},function(){z(function(){w(V,J,{step:1,block:"profile"})})})}}})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step1.view1",function(){w(V,J,{step:1})});v.AddEvent("Order.step1.later",function(){w(V,J,{step:2})});v.AddEvent("Order.step1.profile",function(ag){v.WidgetLoader(false);var af=ag.birthDay().split(".");var ae=af[2]+"-"+af[1]+"-"+af[0];ag.birthDayHiddenField(ae);v.BaseLoad.EditProfile($("form#"+ag.cssRegistrationDataForm),function(ah){var ai=true;if(!v.QueryError(ah,function(){v.DispatchEvent("Order.step1.profile",ag)})){ai=false}if(ai){Parameters.cache.profile.personal={};Parameters.cache.order.step1.profile=ag;w(V,J,{step:2})}else{v.WidgetLoader(true,Y.container.widget)}})});v.AddEvent("Order.step3.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_method_shipping="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step3.change",ae)})){O.shipping=ae.selected;ae.fn()}})});v.AddEvent("Order.step3.message",function(){v.ShowError(Y.message.selectMethodShipping,false,false)});v.AddEvent("Order.step2.add",function(ae){var af="?id_country="+encodeURIComponent($.trim(ae.country().id));if(ae.region()){af=af+"&code_region="+encodeURIComponent($.trim(ae.region().regioncode))}else{af=af+"&name_region="+encodeURIComponent($.trim(ae.customRegion()))}if(ae.city()){af=af+"&code_city="+encodeURIComponent($.trim(ae.city().aoguid))}else{af=af+"&name_city="+encodeURIComponent($.trim(ae.customCity()))}af=af+"&address="+encodeURIComponent($.trim(ae.customAddress()))+"&post_code="+encodeURIComponent($.trim(ae.postCode()))+"&addressee="+encodeURIComponent($.trim(ae.addressee()))+"&contact_phone="+encodeURIComponent($.trim(ae.contactPhone()))+"&is_default="+encodeURIComponent(ae.isDefault()?"yes":"no");v.BaseLoad.AddDelivaryAddress(af,function(ag){if(ag.result=="ok"){v.ShowMessage(Y.message.addAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;w(V,J,{step:2})},false)}else{if(!ag.err){ag.err=Y.message.failAddAddressDelivery}v.QueryError(ag,function(){v.DispatchEvent("Order.step2.add",ae)})}})});v.AddEvent("Order.step2.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_shipping_address="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step2.change",ae)})){Parameters.cache.delivery=null;O.delivery=ae.selected;ae.fn()}})});v.AddEvent("Order.step2.delete",function(ae){v.BaseLoad.DeleteDeliveryAddress(ae.address.id,function(af){if(af.result=="ok"){v.ShowMessage(Y.message.deleteAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;ae.list.remove(ae.address)},false)}else{if(!af.err){af.err=Y.message.failDeleteAddressDelivery}v.QueryError(af,function(){v.DispatchEvent("Order.step2.delete",ae)})}})});v.AddEvent("Order.step2.message",function(){v.ShowError(Y.message.selectAddress,false,false)});v.AddEvent("Order.step4.change",function(ae){v.BaseLoad.EditOrder(O.id+"/?id_method_payment="+ae.id,function(af){if(v.QueryError(af,function(){v.DispatchEvent("Order.step4.change",ae)})){O.payment=ae.selected;ae.fn()}})});v.AddEvent("Order.step4.message",function(){v.ShowError(Y.message.selectMethodPayment,false,false)});v.AddEvent("Order.step5.confirm",function(af){var ae=O.id;if(af.comment){ae=ae+"?comment_buyer="+encodeURIComponent(af.comment)}v.BaseLoad.ConfirmOrder(ae,function(ag){if(v.QueryError(ag,function(){v.DispatchEvent("Order.step5.confirm",af)})){v.ShowMessage(Y.message.orderConfirm,function(){w("purchases","Мои покупки",{block:"detail",id:O.id})},false)}})});v.AddEvent("Order.step5.delete",function(){v.Confirm(Y.message.confirmDeleteOrder,function(){v.BaseLoad.DeleteOrder(O.id+"/yes",function(ae){if(v.QueryError(ae,function(){v.DispatchEvent("Order.step5.delete")})){v.ShowMessage(Y.message.deleteOrderConfirm,function(){w("default","Домашняя",{})},false)}})})});v.AddEvent("Order.send.token",function(ae){v.BaseLoad.SendToken(ae,function(af){if(af.result=="ok"){v.ShowMessage(Y.message.sendToken,false,false)}else{if(!af.err){af.err=Y.message.failSendToken}v.QueryError(af,function(){v.DispatchEvent("Order.send.token",ae)})}})})}function X(af,ae){var ag=false;if(af.check_username){if(af.check_username=="on"||af.check_username=="ban"||af.check_username=="off"){ae.errorUsername(Y.error.username.uniq)}if(af.check_username=="yes"){ag=true}}return ag}function e(af,ae){var ag=false;if(af.check_phone){if(af.check_phone=="on"||af.check_phone=="ban"||af.check_phone=="off"){ae.errorPhone(Y.error.phone.uniq)}if(af.check_phone=="yes"){ag=true}}else{ag=true}return ag}function y(af,ae){var ag=false;if(af.check_email){if(af.check_email=="on"||af.check_email=="ban"||af.check_email=="off"){ae.errorEmail(Y.error.email.uniq)}if(af.check_email=="yes"){ag=true}}return ag}function f(af,ae){if(af.confirm_email){if(af.confirm_email=="no"){ae.errorEmailConfirm(Y.error.emailToken.confirm);return false}}return true}function T(af,ae){if(af.confirm_phone){if(af.confirm_phone=="no"){ae.errorPhoneConfirm(Y.error.phoneToken.confirm);return false}}return true}function W(af,ae){if(af.err){ae.errorAddress(af.err);return false}return true}function E(ae,af){if(ae.err){af.errorAddress(ae.err);return false}return true}function F(af,ag){var ae=af.sellerId;if(af.goodsId){ae=ae+"/"+af.goodsId+"/"+af.count}v.BaseLoad.NewOrder(ae,function(ah){if(v.QueryError(ah,function(){w(V,J,af)},function(){var ai=Parameters.cache.lastPage;w(ai.route,ai.title,ai.data)})){if(ah.msg){v.ShowMessage(ah.msg,function(){var ai=Parameters.cache.lastPage;w(ai.route,ai.title,ai.data)},false)}else{O.id=ah.id;if(ag){ag()}}}})}function z(ae){v.BaseLoad.CartGoods(O.sellerId,function(af){O.content=af;O.content.main=af[0].goods;if(ae){ae()}})}function ad(ae){v.BaseLoad.GoodsInfo(O.goodsId,"1000000",function(af){O.content=af;O.content.main=[af.main];if(ae){ae()}})}function D(){var af=false;var ae=[];if(O.type=="cart"){ae=O.content[0].goods}else{if(!$.isArray(O.content.main)){ae[0]=O.content.main}else{ae=O.content.main}}$.each(ae,function(ag){if(ae[ag].is_egoods!="yes"){af=true;return false}});return af}function o(){q();u()}function K(){L();I()}function ac(){v.BaseLoad.Profile(function(ae){b();Z(ae)})}function m(){if(Routing.params.id){v.BaseLoad.OrderInfo(O.id+"/yes",function(ae){if(v.QueryError(ae,function(){w(V,J,Routing.params)},function(){var af=Parameters.cache.lastPage;w(af.route,af.title,af.data)})){if(ae.msg){v.ShowMessage(ae.msg,function(){var af=Parameters.cache.lastPage;if(af){w(af.route,af.title,af.data)}else{w("default",Routing.defaultTitle,{})}},false)}else{O.content={};O.content.main=ae.goods;C()}}})}else{C()}}function C(){if(D()){v.BaseLoad.DeliveryAddressList(function(ae){n();t(ae)})}else{w(V,J,{step:4})}}function A(){if(D()){var af=new OrderDeliveryFormStep2ViewModel(Y);var ae=Parameters.shopId;v.BaseLoad.Country(ae,function(ag){a();H(af,ag)})}else{w(V,J,{step:4})}}function k(){if(D()){v.BaseLoad.GoodsInfo(O.content.main[0].id,"1010000",function(ae){O.sellerId=ae.shop.id;v.BaseLoad.Shipping(O.sellerId+"/"+O.id+"/",function(af){l();s(af)})})}else{w(V,J,{step:4})}}function i(){v.BaseLoad.GoodsInfo(O.content.main[0].id,"1010000",function(ae){O.sellerId=ae.shop.id;v.BaseLoad.Payment(O.sellerId+"/"+O.id,function(af){j();r(af)})})}function g(){v.BaseLoad.Script(PokupoWidgets.model.order,function(){v.BaseLoad.OrderInfo(O.id+"/yes",function(ae){h();p(ae)})})}function x(){v.ClearContainer(Y)}function q(){v.InsertContainer(Y,"step1")}function L(){v.InsertContainer(Y,"step1Confirm")}function b(){v.InsertContainer(Y,"step1Profile")}function n(){v.InsertContainer(Y,"step2")}function a(){v.InsertContainer(Y,"step2Form")}function l(){v.InsertContainer(Y,"step3")}function j(){v.InsertContainer(Y,"step4")}function h(){v.InsertContainer(Y,"step5")}function u(){var ae=Parameters.cache.order.step1.reg;if($.isEmptyObject(ae)){v.BaseLoad.Script(PokupoWidgets.model.registration,function(){v.BaseLoad.Script(PokupoWidgets.model.auth,function(){ae=new OrderFormStep1ViewModel(Y);Parameters.cache.order.step1.reg=ae})})}S(ae)}function I(){var ag=Routing.params,ae=Parameters.cache.order.step1;if(ag.username&&ag.mail_token){ae.reg.username(ag.username)}RegistrationConfirmFormViewModel.prototype.Back=function(){v.DispatchEvent("Order.step1.view1")};var af=new RegistrationConfirmFormViewModel(ae.reg,Y);af.submitEvent("Order.step1.confirm");af.ShowButtonSendToken();if(ag.username&&ag.mail_token){af.mailToken(ag.mail_token);v.DispatchEvent("Order.step1.confirm",af)}G(af)}function Z(af){RegistrationProfileFormViewModel.prototype.Back=function(){v.DispatchEvent("Order.step1.view2")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){v.DispatchEvent("Order.step1.later")};var ae=new RegistrationProfileFormViewModel(Y);ae.submitEvent("Order.step1.profile");ae.AddContent(af);ab(ae)}function t(af){if(!af.err){var ae=Parameters.cache.order.step2;if($.isEmptyObject(ae)){ae=new OrderFormStep2ViewModel(Y)}ae.AddContent(af,O);R(ae);Parameters.cache.order.step2=ae}else{w(V,J,{step:2,block:"add"})}}function H(ae,af){ae.AddCountryList(af);if(ae.idCountry()){$.grep(ae.countryList(),function(ag){if(ag.id==ae.idCountry()){ae.country(ag)}})}aa(ae)}function s(af){var ae=Parameters.cache.order.step3;if($.isEmptyObject(ae)){ae=new OrderFormStep3ViewModel()}ae.AddShipping(af);Parameters.cache.order.step3=ae;Q(ae)}function r(af){var ae=Parameters.cache.order.step4;if($.isEmptyObject(ae)){ae=new OrderFormStep4ViewModel()}ae.AddPayment(af);Parameters.cache.order.step4=ae;P(ae)}function p(af){var ae=Parameters.cache.order.step5;if($.isEmptyObject(ae)){OrderViewModel.prototype.Back=function(){w(V,J,{step:4})};OrderViewModel.prototype.ClickDelete=function(){v.DispatchEvent("Order.step5.delete")};OrderViewModel.prototype.ClickStep1=function(){w(V,J,{step:1,block:"profile"})};OrderViewModel.prototype.ClickStep2=function(){w(V,J,{step:2})};OrderViewModel.prototype.ClickStep3=function(){w(V,J,{step:3})};OrderViewModel.prototype.ClickStep4=function(){w(V,J,{step:4})};OrderViewModel.prototype.ClickAddAddress=function(){w(V,J,{step:1,block:"add"})};ae=new OrderViewModel();Parameters.cache.order.step5=ae}ae.AddContent(af);N(ae)}function S(ae){v.RenderTemplate(ae,Y,null,function(af){q();S(af)},function(){x()},"step1")}function G(ae){v.RenderTemplate(ae,Y,null,function(af){L();G(af)},function(){x()},"step1Confirm")}function ab(ae){v.RenderTemplate(ae,Y,null,function(af){b();ab(af)},function(){x()},"step1Profile")}function R(ae){v.RenderTemplate(ae,Y,null,function(af){n();R(af)},function(){x()},"step2")}function aa(ae){v.RenderTemplate(ae,Y,function(){d(ae)},function(af){a();aa(af)},function(){x()},"step2Form")}function Q(ae){v.RenderTemplate(ae,Y,null,function(af){l();Q(af)},function(){x()},"step3")}function P(ae){v.RenderTemplate(ae,Y,null,function(af){j();P(af)},function(){x()},"step4")}function N(ae){v.RenderTemplate(ae,Y,null,function(af){h();N(af)},function(){x()},"step5")}function d(ae){$("#"+ae.cssRegionList).autocomplete({source:function(ag,af){v.BaseLoad.Region(ae.country().id+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.formalname+" "+ai.shortname),region:ai}}))}else{$("#"+ae.cssRegionList).autocomplete("close");return false}})},select:function(af,ag){ae.region(ag.item.region);ae.customRegion(ag.item.value);if(ag.item.region&&ag.item.region.postalcode!=0){ae.postCode(ag.item.region.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssCityList).autocomplete({source:function(ag,af){if(ae.region()){v.BaseLoad.City(ae.country().id+"/"+encodeURIComponent(ae.region().regioncode)+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.shortname+". "+ai.formalname),city:ai}}))}else{$("#"+ae.cssCityList).autocomplete("close");return false}})}},select:function(af,ag){ae.city(ag.item.city);ae.customCity(ag.item.value);if(ag.item.city&&ag.item.city.postalcode!=0){ae.postCode(ag.item.city.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssAddress).autocomplete({source:function(ag,af){if(ae.region()){v.BaseLoad.Street(ae.country().id+"/"+encodeURIComponent(ae.region().regioncode)+"/"+encodeURIComponent(ae.city().aoguid)+"/"+encodeURIComponent(ag.term),function(ah){if(!ah.err){af($.map(ah,function(ai){return{value:$.trim(ai.shortname+". "+ai.formalname),street:ai}}))}else{$("#"+ae.cssAddress).autocomplete("close");return false}})}},select:function(af,ag){ae.address(ag.item.street);ae.customAddress(ag.item.value);if(ag.item.street&&ag.item.street.postalcode!=0){ae.postCode(ag.item.street.postalcode)}else{ae.postCode(null)}}});$("#"+ae.cssCountryList).change(function(){var af=$("#"+ae.cssCountryList+" option:selected").val();if(af){ae.errorCountry("");ae.errorRegion("");ae.errorCity("");ae.errorAddress("");ae.errorPostCode("")}$.grep(ae.countryList(),function(ag){if(ag.id==af){ae.country(ag);ae.customRegion(null);ae.region(null);ae.customCity(null);ae.city(null);ae.customAddress(null);ae.address(null);ae.postCode(null)}})});$("#"+ae.cssRegionList).bind("textchange",function(ag,af){ae.errorRegion("");ae.errorCity("");ae.errorAddress("");ae.errorPostCode("");ae.customRegion($(this).val());ae.customCity(null);ae.city(null);ae.customAddress(null);ae.address(null);ae.postCode(null)});$("#"+ae.cssCityList).bind("textchange",function(ag,af){ae.errorCity("");ae.errorAddress("");ae.errorPostCode("");ae.customCity($(this).val());ae.customAddress(null);ae.address(null);ae.postCode(null)});$("#"+ae.cssAddressList).bind("textchange",function(ag,af){ae.errorAddress("");ae.errorPostCode("")});$("#"+ae.cssPostCode).bind("textchange",function(ag,af){ae.errorPostCode("")});$("#"+ae.cssAddressee).bind("textchange",function(ag,af){ae.errorAddressee("")});$("#"+ae.cssContactPhone).bind("textchange",function(ag,af){ae.errorContactPhone("")})}function w(ae,ag,af){Routing.SetHash(ae,ag,af)}};var OrderFormStep1ViewModel=function(b){var a=this;var c=new AuthenticationViewModel();c.subminEvent("Order.step1.authentication");a.loginForm=c;a.registrationForm=new RegistrationFormViewModel(b);a.registrationForm.submitEvent("Order.step1.registration")};var OrderFormStep2ViewModel=function(e){var b=this,f="Оформление заказа",d="order";b.addressList=ko.observableArray();b.cssAddressList="delivary_address_list";b.checked=ko.observable();b.selectedItem=ko.observable();b.ClickAddAddress=function(){a(d,f,{step:2,block:"add"})};b.AddContent=function(j,g){if(!j.err){b.addressList=ko.observableArray()}for(var i in j){OrderItemFormStep2ViewModel.prototype=new Widget();var h=new OrderItemFormStep2ViewModel(j[i],b,e);b.addressList.push(h);if(j[i].is_default=="yes"){g.delivery=h}if(j.length==1){h.ClickItem()}}};b.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var h=Parameters.cache.history;for(var g=0;g<=h.length-1;g++){var j=h.pop();if(j.route!="order"){a(j.route,j.title,j.data,true);return false}}}else{a(d,f,{step:1,block:"profile"})}};b.Submit=function(){if(c()){EventDispatcher.DispatchEvent("Order.step2.change",{id:b.checked(),selected:b.selectedItem(),fn:function(){a(d,f,{step:3})}})}else{EventDispatcher.DispatchEvent("Order.step2.message")}};b.ClickStep1=function(){a(d,f,{step:1,block:"profile"})};function c(){var g=false;$.each(b.addressList(),function(h){if(b.addressList()[h].isDefault()){g=true;return false}});return g}function a(g,i,h){Routing.SetHash(g,i,h)}};var OrderItemFormStep2ViewModel=function(d,c,b){var a=this;if(d.id){a.id=d.id}else{a.id=""}a.idCountry=d.id_country;a.country=d.country;a.codeRegion=d.code_region;a.region=d.region;a.codeCity=d.code_city;a.city=d.city;a.postCode=d.post_code;a.address=d.address;a.addressee=d.addressee;a.contactPhone=d.contact_phone;a.list=c.addressList();a.isDefault=ko.observable(true);if(d.is_default=="yes"){a.cssIsDefault=ko.observable("delivery_address_is_default active");Parameters.cache.order.delivery=a;c.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.Delete=function(){a.Confirm(b.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("Order.step2.delete",{address:a,list:c.addressList})},false)};a.ClickItem=function(){$.each(a.list,function(e){a.list[e].cssIsDefault("delivery_address_is_default");a.list[e].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);c.checked(a.id);c.selectedItem(a);Parameters.cache.order.delivery=a}};var OrderDeliveryFormStep2ViewModel=function(e){var m=this,k="Оформление заказа",g="order";m.id=ko.observable();m.idCountry=ko.observable();m.country=ko.observable();m.cssCountryList="delivery_country_list";m.errorCountry=ko.observable(null);m.codeRegion=ko.observable();m.region=ko.observable();m.customRegion=ko.observable();m.cssRegionList="delivery_region";m.errorRegion=ko.observable(null);m.showRegion=ko.computed(function(){if(m.country()){return false}return true},this);m.codeCity=ko.observable();m.city=ko.observable();m.customCity=ko.observable();m.cssCityList="delivery_city";m.errorCity=ko.observable(null);m.showCity=ko.computed(function(){if(m.customRegion()){return false}return true},this);m.address=ko.observable();m.customAddress=ko.observable();m.cssAddress="delivery_cssAddress";m.errorAddress=ko.observable(null);m.showAddress=ko.computed(function(){if(m.customCity()){return false}return true},this);m.postCode=ko.observable();m.cssPostCode="delivery_post_index";m.errorPostCode=ko.observable(null);m.showPostIndex=ko.computed(function(){if(m.customAddress()){return false}return true},this);m.addressee=ko.observable();m.cssAddressee="delivery_addressee";m.errorAddressee=ko.observable(null);m.contactPhone=ko.observable();m.cssContactPhone="delivery_contact_phone";m.errorContactPhone=ko.observable(null);m.isDefault=ko.observable();m.countryList=ko.observableArray();m.AddCountryList=function(o){if(o.length>0){for(var n=0;n<=o.length-1;n++){m.countryList.push(new CountryListViewModel(o[n]))}}};m.AddContent=function(n){m.id(n.id);m.idCountry(n.idCountry);m.region({regioncode:n.codeRegion});m.customRegion(n.region);m.city({aoguid:n.codeCity});m.customCity(n.city);m.postCode(n.postCode);m.customAddress(n.address);m.addressee(n.addressee);m.isDefault(n.isDefault());m.contactPhone(n.contactPhone)};m.Submit=function(){if(d()){EventDispatcher.DispatchEvent("Order.step2.add",m)}};m.Back=function(){j(g,k,{step:2})};m.ClickStep1=function(){j(k,g,{step:1,block:"profile"})};m.ClickStep2=function(){j(k,g,{step:2})};function j(n,p,o){Routing.SetHash(n,p,o)}function d(){var n=true;if(!l()){n=false}if(!i()){n=false}if(!h()){n=false}if(!c()){n=false}if(!b()){n=false}if(!f()){n=false}if(!a()){n=false}return n}function h(){if(!m.country()){m.errorCountry(e.error.country.empty);return false}m.errorCountry(null);return true}function c(){if(!m.customRegion()){m.errorRegion(e.error.region.empty);return false}m.errorRegion(null);return true}function b(){if(!m.customCity()){m.errorCity(e.error.city.empty);return false}m.errorCity(null);return true}function f(){if(!m.customAddress()){m.errorAddress(e.error.address.empty);return false}m.errorAddress(null);return true}function a(){var n=e.error.postIndex;if(!m.postCode()){m.errorPostCode(n.empty);return false}if(5>m.postCode().length||m.postCode().length>6){m.errorPostCode(n.length);return false}if(!e.regular.postIndex.test(m.postCode())){m.errorPostCode(n.regular);return false}m.errorPostCode(null);return true}function i(){var n=e.error.addressee;if(!m.addressee()){m.errorAddressee(n.empty);return false}if(m.addressee().length<3){m.errorAddressee(n.minLength);return false}if(m.addressee().length>40){m.errorAddressee(n.maxLength);return false}if(!e.regular.addressee.test(m.addressee())){m.errorAddressee(n.regular);return false}m.errorAddressee(null);return true}function l(){var n=e.error.phone;if(!m.contactPhone()){m.errorContactPhone(n.empty);return false}if(!e.regular.phone.test($.trim(m.contactPhone()))){m.errorContactPhone(n.regular);return false}m.errorContactPhone(null);return true}};var OrderFormStep3ViewModel=function(){var c=this,e="Оформление заказа",d="order";c.shipping=ko.observableArray();c.checked=ko.observable();c.selectedItem=ko.observable();c.AddShipping=function(h){c.shipping=ko.observableArray();for(var f=0;f<=h.length-1;f++){var g=new OrderItemFormStep3ViewModel(c);g.AddContent(h[f]);c.shipping.push(g);if(h.length==1){g.ClickItem()}}};c.Back=function(){a(d,e,{step:2})};c.Submit=function(){if(b()){EventDispatcher.DispatchEvent("Order.step3.change",{id:c.checked(),selected:c.selectedItem(),fn:function(){a(d,e,{step:4})}})}else{EventDispatcher.DispatchEvent("Order.step3.message")}};c.ClickStep1=function(){a(d,e,{step:1,block:"profile"})};c.ClickStep2=function(){a(d,e,{step:2})};c.ClickAddAddress=function(){a(d,e,{step:2,block:"add"})};function b(){var f=false;$.each(c.shipping(),function(g){if(c.shipping()[g].isActive()){f=true;return false}});return f}function a(f,h,g){Routing.SetHash(f,h,g)}};var OrderItemFormStep3ViewModel=function(b){var a=this;a.nameShippingCompany=ko.observable();a.siteShippingCompany=ko.observable();a.logoShippingCompany=ko.observable();a.id=ko.observable();a.nameMethodShipping=ko.observable();a.descMethodShipping=ko.observable();a.costShipping=ko.observable();a.cssActive=ko.observable("shipping_row");a.isActive=ko.observable(false);a.AddContent=function(c){if(c.hasOwnProperty("name_shipping_company")){a.nameShippingCompany(c.name_shipping_company)}if(c.hasOwnProperty("site_shipping_company")){a.siteShippingCompany(c.site_shipping_company)}if(c.hasOwnProperty("logo_shipping_company")){a.logoShippingCompany(c.logo_shipping_company)}if(c.hasOwnProperty("id")){a.id(c.id)}if(c.hasOwnProperty("name_method_shipping")){a.nameMethodShipping(c.name_method_shipping)}if(c.hasOwnProperty("desc_method_shipping")){a.descMethodShipping(c.desc_method_shipping)}if(c.hasOwnProperty("cost_shipping")){a.costShipping(c.cost_shipping)}};a.ClickItem=function(){$.each(b.shipping(),function(c){b.shipping()[c].cssActive("shipping_row");b.shipping()[c].isActive(false)});a.cssActive("shipping_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var OrderFormStep4ViewModel=function(){var c=this,e="Оформление заказа",d="order";c.payment=ko.observableArray();c.checked=ko.observable();c.selectedItem=ko.observable();c.AddPayment=function(h){c.payment=ko.observableArray();for(var f=0;f<=h.length-1;f++){var g=new OrderItemFormStep4ViewModel(c);g.AddContent(h[f]);c.payment.push(g);if(h.length==1){g.ClickItem()}}};c.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var g=Parameters.cache.history;for(var f=0;f<=g.length-1;f++){var h=g.pop();if(h.route!="order"){a(h.route,h.title,h.data,true);return false}else{a(d,e,{step:3})}}}else{a(d,e,{step:3})}};c.Submit=function(){if(b()){EventDispatcher.DispatchEvent("Order.step4.change",{id:c.checked(),selected:c.selectedItem(),fn:function(){a(d,e,{step:5})}})}else{EventDispatcher.DispatchEvent("Order.step4.message")}};c.ClickStep1=function(){a(d,e,{step:1,block:"profile"})};c.ClickStep2=function(){a(d,e,{step:2})};c.ClickStep3=function(){a(d,e,{step:3})};c.ClickAddAddress=function(){a(d,e,{step:2,block:"add"})};function b(){var f=false;$.each(c.payment(),function(g){if(c.payment()[g].isActive()){f=true;return false}});return f}function a(f,h,g){Routing.SetHash(f,h,g)}};var OrderItemFormStep4ViewModel=function(b){var a=this;a.id=ko.observable();a.logoPayment=ko.observable();a.descPayment=ko.observable();a.instrPayment=ko.observable();a.namePayment=ko.observable();a.costPayment=ko.observable();a.cssActive=ko.observable("payment_row");a.isActive=ko.observable(false);a.AddContent=function(d,c){a.id(d.id);if(d.hasOwnProperty("logo_payment")){a.logoPayment(d.logo_payment)}if(d.hasOwnProperty("desc_payment")){a.descPayment(d.desc_payment)}if(d.hasOwnProperty("instr_payment")){a.instrPayment(d.instr_payment)}if(d.hasOwnProperty("name_payment")){a.namePayment(d.name_payment)}if(d.hasOwnProperty("cost_payment")){a.costPayment(d.cost_payment)}};a.ClickItem=function(){$.each(b.payment(),function(c){b.payment()[c].cssActive("payment_row");b.payment()[c].isActive(false)});a.cssActive("payment_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var TestOrder={Init:function(){if(typeof Widget=="function"){OrderWidget.prototype=new Widget();var a=new OrderWidget();a.Init(a)}else{setTimeout(function(){TestOrder.Init()},100)}}};TestOrder.Init();