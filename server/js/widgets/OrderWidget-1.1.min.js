var OrderWidget=function(){function e(){t(),o(),r()}function t(){var e=J.GetInputParameters(X);$.isEmptyObject(e)||(K=J.UpdateSettings1(K,e)),Config.Order=K}function r(){var e=Routing.params,t=Parameters.cache;Routing.route==Y?(J.WidgetLoader(!1),e.sellerId&&(X.sellerId=e.sellerId),e.create&&J.BaseLoad.Login(!1,!1,!1,function(r){"fromCart"==e.create?r.err?(X.type="cart",X.goodsId=null,X.count=null,setTimeout(function(){t.history.pop();var e=t.history.pop();e.route==Y&&e.data.create&&(e=t.history.pop()),"login"==e.route&&(e=t.history.pop()),N(e.route,e.title,e.data,!0)},1e3)):c({create:"fromCart",sellerId:X.sellerId},function(){X.type="cart",l(function(){N(Y,et,{step:2})})}):"directly"==e.create?r.err?(X.type="directly",X.goodsId=e.goodsId,X.count=e.count,setTimeout(function(){t.history.pop();var e=t.history.pop();e.route==Y&&e.data.create&&(e=t.history.pop()),"login"==e.route&&(e=t.history.pop()),N(e.route,e.title,e.data,!0)},1e3)):c({create:"directly",sellerId:X.sellerId,goodsId:e.goodsId,count:e.count},function(){X.type="directly",X.goodsId=e.goodsId,X.count=e.count,p(function(){N(Y,et,{step:2})})}):N("default","Домашняя",{})}),e.step&&J.BaseLoad.Login(!1,!1,!1,function(t){J.BaseLoad.Tmpl(K.tmpl,function(){e.id&&(X.id=e.id),1!=e.step||e.block?1==e.step&&"confirm"==e.block?f():!t.err&&1==e.step&&"profile"==e.block&&X.id?h():t.err||2!=e.step||e.block||!X.id?!t.err&&2==e.step&&"add"==e.block&&X.id?v():!t.err&&3==e.step&&X.id?C():!t.err&&4==e.step&&X.id?b():5==e.step?k():N("default","Домашняя",{}):g():t.err?m():N(Y,et,{step:2})})})):J.WidgetLoader(!0)}function o(){J.AddEvent("w.change.route",function(){r()}),J.AddEvent("UInfo.logout",function(){Parameters.cache.order.step1.login={},Parameters.cache.order.step1.reg={},Parameters.cache.order.step1.confirm={},Parameters.cache.order.step1.profile={},Parameters.cache.order.step2={},Parameters.cache.order.step3={},Parameters.cache.order.step4={},Parameters.cache.order.step5={},Parameters.cache.payment=null,Parameters.cache.shipping=null,Parameters.cache.delivery=null,Parameters.cache.profile.personal={},X.type=null,X.id=null,X.sellerId=null,X.goodsId=null,X.count=null,X.content=null,X.delivery={},X.shipping={},X.payment={}}),J.AddEvent("Order.step1.authentication",function(e){J.BaseLoad.Login(e.username,e.password,e.rememberMe,function(e){e.err?(Parameters.cache.order.step1.reg.loginForm.error("Ошибка в логине или пароле"),Parameters.cache.order.step1.reg.loginForm.password=null,W(Parameters.cache.order.step1.reg)):("directly"==X.type&&c({create:"directly",sellerId:X.sellerId,goodsId:X.goodsId,count:X.count},function(){p(function(){N(Y,et,{step:2})})}),"cart"==X.type&&c({create:"directly",sellerId:X.sellerId},function(){l(function(){N(Y,et,{step:2})})}))})}),J.AddEvent("Order.step1.registration",function(e){J.WidgetLoader(!1);var t=[];if(e.username()&&t.push("username="+encodeURIComponent(e.username())),e.phone()&&t.push("phone="+e.phone().replace(/\s/g,"")),e.email()&&t.push("email="+e.email()),t.length>0)var r="?"+t.join("&");J.BaseLoad.UniqueUser(r,function(t){var r=!0;if(J.QueryError(t,function(){EventDispatcher.DispatchEvent("Order.step1.registration",e)})?(n(t,e)||(r=!1),s(t,e)||(r=!1),i(t,e)||(r=!1)):r=!1,r){var o=[];if(e.username()&&o.push("username="+encodeURIComponent(e.username())),e.phone()&&o.push("phone="+e.phone().replace(/\s/g,"")),e.email()&&o.push("email="+e.email()),e.firstPassword()&&o.push("password="+encodeURIComponent(e.firstPassword())),o.length>0)var d="?"+o.join("&");J.BaseLoad.Registration(d,function(){Parameters.cache.order.step1.reg=e,N(Y,et,{step:1,block:"confirm"})})}else J.WidgetLoader(!0,K.container.widget)})}),J.AddEvent("Order.step1.confirm",function(e){J.WidgetLoader(!1);var t=[];t.push("username="+encodeURIComponent(e.username)),e.mailConfirmLater()||t.push("mail_token="+e.mailToken()),e.phoneConfirmLater()||t.push("sms_token="+e.phoneToken());var r="?"+t.join("&");J.BaseLoad.ActivateUser(r,function(t){var r=!0;J.QueryError(t,function(){EventDispatcher.DispatchEvent("Order.step1.confirm",e)})?(d(t,e)||(r=!1),a(t,e)||(r=!1)):r=!1,r?J.BaseLoad.Login(!1,!1,!1,function(t){Parameters.cache.order.step1.confirm=e,t.err||("directly"==X.type&&c({create:"directly",sellerId:X.sellerId,goodsId:X.goodsId,count:X.count},function(){p(function(){N(Y,et,{step:1,block:"profile"})})}),"fromCart"==X.type&&c({create:"directly",sellerId:X.sellerId},function(){l(function(){N(Y,et,{step:1,block:"profile"})})}))}):J.WidgetLoader(!0,K.container.widget)})}),J.AddEvent("Order.step1.view1",function(){N(Y,et,{step:1})}),J.AddEvent("Order.step1.later",function(){N(Y,et,{step:2})}),J.AddEvent("Order.step1.profile",function(e){J.WidgetLoader(!1);var t=e.birthDay().split("."),r=t[2]+"-"+t[1]+"-"+t[0];e.birthDayHiddenField(r),J.BaseLoad.EditProfile($("form#"+e.cssRegistrationDataForm),function(t){var r=!0;J.QueryError(t,function(){J.DispatchEvent("Order.step1.profile",e)})||(r=!1),r?(Parameters.cache.profile.personal={},Parameters.cache.order.step1.profile=e,N(Y,et,{step:2})):J.WidgetLoader(!0,K.container.widget)})}),J.AddEvent("Order.step3.change",function(e){J.BaseLoad.EditOrder(X.id+"/?id_method_shipping="+e.id,function(t){J.QueryError(t,function(){J.DispatchEvent("Order.step3.change",e)})&&(X.shipping=e.selected,e.fn())})}),J.AddEvent("Order.step3.message",function(){J.ShowError(K.message.selectMethodShipping,!1,!1)}),J.AddEvent("Order.step2.add",function(e){var t="?id_country="+encodeURIComponent($.trim(e.country().id));t=e.region()?t+"&code_region="+encodeURIComponent($.trim(e.region().regioncode)):t+"&name_region="+encodeURIComponent($.trim(e.customRegion())),t=e.city()?t+"&code_city="+encodeURIComponent($.trim(e.city().aoguid)):t+"&name_city="+encodeURIComponent($.trim(e.customCity())),t=t+"&address="+encodeURIComponent($.trim(e.customAddress()))+"&post_code="+encodeURIComponent($.trim(e.postCode()))+"&addressee="+encodeURIComponent($.trim(e.addressee()))+"&contact_phone="+encodeURIComponent($.trim(e.contactPhone()))+"&is_default="+encodeURIComponent(e.isDefault()?"yes":"no"),J.BaseLoad.AddDelivaryAddress(t,function(t){"ok"==t.result?J.ShowMessage(K.message.addAddressDelivery,function(){Parameters.cache.order.step2={},Parameters.cache.delivery=null,N(Y,et,{step:2})},!1):(t.err||(t.err=K.message.failAddAddressDelivery),J.QueryError(t,function(){J.DispatchEvent("Order.step2.add",e)}))})}),J.AddEvent("Order.step2.change",function(e){J.BaseLoad.EditOrder(X.id+"/?id_shipping_address="+e.id,function(t){J.QueryError(t,function(){J.DispatchEvent("Order.step2.change",e)})&&(Parameters.cache.delivery=null,X.delivery=e.selected,e.fn())})}),J.AddEvent("Order.step2.delete",function(e){J.BaseLoad.DeleteDeliveryAddress(e.address.id,function(t){"ok"==t.result?J.ShowMessage(K.message.deleteAddressDelivery,function(){Parameters.cache.order.step2={},Parameters.cache.delivery=null,e.list.remove(e.address)},!1):(t.err||(t.err=K.message.failDeleteAddressDelivery),J.QueryError(t,function(){J.DispatchEvent("Order.step2.delete",e)}))})}),J.AddEvent("Order.step2.message",function(){J.ShowError(K.message.selectAddress,!1,!1)}),J.AddEvent("Order.step4.change",function(e){J.BaseLoad.EditOrder(X.id+"/?id_method_payment="+e.id,function(t){J.QueryError(t,function(){J.DispatchEvent("Order.step4.change",e)})&&(X.payment=e.selected,e.fn())})}),J.AddEvent("Order.step4.message",function(){J.ShowError(K.message.selectMethodPayment,!1,!1)}),J.AddEvent("Order.step5.confirm",function(e){var t=X.id;e.comment&&(t=t+"?comment_buyer="+encodeURIComponent(e.comment)),J.BaseLoad.ConfirmOrder(t,function(t){J.QueryError(t,function(){J.DispatchEvent("Order.step5.confirm",e)})&&J.ShowMessage(K.message.orderConfirm,function(){N("purchases","Мои покупки",{block:"detail",id:X.id})},!1)})}),J.AddEvent("Order.step5.delete",function(){J.Confirm(K.message.confirmDeleteOrder,function(){J.BaseLoad.DeleteOrder(X.id+"/yes",function(e){J.QueryError(e,function(){J.DispatchEvent("Order.step5.delete")})&&J.ShowMessage(K.message.deleteOrderConfirm,function(){N("default","Домашняя",{})},!1)})})}),J.AddEvent("Order.send.token",function(e){J.BaseLoad.SendToken(e,function(t){"ok"==t.result?J.ShowMessage(K.message.sendToken,!1,!1):(t.err||(t.err=K.message.failSendToken),J.QueryError(t,function(){J.DispatchEvent("Order.send.token",e)}))})})}function n(e,t){var r=!1;return e.check_username&&(("on"==e.check_username||"ban"==e.check_username||"off"==e.check_username)&&t.errorUsername(K.error.username.uniq),"yes"==e.check_username&&(r=!0)),r}function i(e,t){var r=!1;return e.check_phone?(("on"==e.check_phone||"ban"==e.check_phone||"off"==e.check_phone)&&t.errorPhone(K.error.phone.uniq),"yes"==e.check_phone&&(r=!0)):r=!0,r}function s(e,t){var r=!1;return e.check_email&&(("on"==e.check_email||"ban"==e.check_email||"off"==e.check_email)&&t.errorEmail(K.error.email.uniq),"yes"==e.check_email&&(r=!0)),r}function d(e,t){return e.confirm_email&&"no"==e.confirm_email?(t.errorEmailConfirm(K.error.emailToken.confirm),!1):!0}function a(e,t){return e.confirm_phone&&"no"==e.confirm_phone?(t.errorPhoneConfirm(K.error.phoneToken.confirm),!1):!0}function c(e,t){var r=e.sellerId;e.goodsId&&(r=r+"/"+e.goodsId+"/"+e.count),J.BaseLoad.NewOrder(r,function(r){J.QueryError(r,function(){N(Y,et,e)},function(){var e=Parameters.cache.lastPage;N(e.route,e.title,e.data)})&&(r.msg?J.ShowMessage(r.msg,function(){var e=Parameters.cache.lastPage;N(e.route,e.title,e.data)},!1):(X.id=r.id,t&&t()))})}function l(e){J.BaseLoad.CartGoods(X.sellerId,function(t){X.content=t,X.content.main=t[0].goods,e&&e()})}function p(e){J.BaseLoad.GoodsInfo(X.goodsId,"1000000",function(t){X.content=t,X.content.main=[t.main],e&&e()})}function u(){var e=!1,t=[];return"cart"==X.type?t=X.content[0].goods:$.isArray(X.content.main)?t=X.content.main:t[0]=X.content.main,$.each(t,function(r){return"yes"!=t[r].is_egoods?(e=!0,!1):void 0}),e}function m(){P(),D()}function f(){I(),R()}function h(){J.BaseLoad.Profile(function(e){O(),M(e)})}function g(){Routing.params.id?J.BaseLoad.OrderInfo(X.id+"/yes",function(e){J.QueryError(e,function(){N(Y,et,Routing.params)},function(){var e=Parameters.cache.lastPage;N(e.route,e.title,e.data)})&&(e.msg?J.ShowMessage(e.msg,function(){var e=Parameters.cache.lastPage;e?N(e.route,e.title,e.data):N("default",Routing.defaultTitle,{})},!1):(X.content={},X.content.main=e.goods,y()))}):y()}function y(){u()?J.BaseLoad.DeliveryAddressList(function(e){_(),B(e)}):N(Y,et,{step:4})}function v(){if(u()){var e=new OrderDeliveryFormStep2ViewModel(K),t=Parameters.shopId;J.BaseLoad.Country(t,function(t){w(),F(e,t)})}else N(Y,et,{step:4})}function C(){u()?J.BaseLoad.GoodsInfo(X.content.main[0].id,"1010000",function(e){X.sellerId=e.shop.id,J.BaseLoad.Shipping(X.sellerId+"/"+X.id+"/",function(e){E(),T(e)})}):N(Y,et,{step:4})}function b(){J.BaseLoad.GoodsInfo(X.content.main[0].id,"1010000",function(e){X.sellerId=e.shop.id,J.BaseLoad.Payment(X.sellerId+"/"+X.id,function(e){L(),V(e)})})}function k(){J.BaseLoad.Script(PokupoWidgets.model.order,function(){J.BaseLoad.OrderInfo(X.id+"/yes",function(e){S(),U(e)})})}function A(){J.ClearContainer(K)}function P(){J.InsertContainer(K,"step1")}function I(){J.InsertContainer(K,"step1Confirm")}function O(){J.InsertContainer(K,"step1Profile")}function _(){J.InsertContainer(K,"step2")}function w(){J.InsertContainer(K,"step2Form")}function E(){J.InsertContainer(K,"step3")}function L(){J.InsertContainer(K,"step4")}function S(){J.InsertContainer(K,"step5")}function D(){var e=Parameters.cache.order.step1.reg;$.isEmptyObject(e)&&J.BaseLoad.Script(PokupoWidgets.model.registration,function(){J.BaseLoad.Script(PokupoWidgets.model.auth,function(){e=new OrderFormStep1ViewModel,Parameters.cache.order.step1.reg=e})}),W(e)}function R(){var e=Routing.params,t=Parameters.cache.order.step1;e.username&&e.mail_token&&t.reg.username(e.username),RegistrationConfirmFormViewModel.prototype.Back=function(){J.DispatchEvent("Order.step1.view1")};var r=new RegistrationConfirmFormViewModel(t.reg);r.submitEvent("Order.step1.confirm"),r.ShowButtonSendToken(),e.username&&e.mail_token&&(r.mailToken(e.mail_token),J.DispatchEvent("Order.step1.confirm",r)),x(r)}function M(e){RegistrationProfileFormViewModel.prototype.Back=function(){J.DispatchEvent("Order.step1.view2")},RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){J.DispatchEvent("Order.step1.later")};var t=new RegistrationProfileFormViewModel;t.submitEvent("Order.step1.profile"),t.AddContent(e),Q(t)}function B(e){if(e.err)N(Y,et,{step:2,block:"add"});else{var t=Parameters.cache.order.step2;$.isEmptyObject(t)&&(t=new OrderFormStep2ViewModel(K)),t.AddContent(e,X),j(t),Parameters.cache.order.step2=t}}function F(e,t){e.AddCountryList(t),e.idCountry()&&$.grep(e.countryList(),function(t){t.id==e.idCountry()&&e.country(t)}),z(e)}function T(e){var t=Parameters.cache.order.step3;$.isEmptyObject(t)&&(t=new OrderFormStep3ViewModel),t.AddShipping(e),Parameters.cache.order.step3=t,q(t)}function V(e){var t=Parameters.cache.order.step4;$.isEmptyObject(t)&&(t=new OrderFormStep4ViewModel),t.AddPayment(e),Parameters.cache.order.step4=t,H(t)}function U(e){var t=Parameters.cache.order.step5;$.isEmptyObject(t)&&(OrderViewModel.prototype.Back=function(){N(Y,et,{step:4})},OrderViewModel.prototype.ClickDelete=function(){J.DispatchEvent("Order.step5.delete")},OrderViewModel.prototype.ClickStep1=function(){N(Y,et,{step:1,block:"profile"})},OrderViewModel.prototype.ClickStep2=function(){N(Y,et,{step:2})},OrderViewModel.prototype.ClickStep3=function(){N(Y,et,{step:3})},OrderViewModel.prototype.ClickStep4=function(){N(Y,et,{step:4})},OrderViewModel.prototype.ClickAddAddress=function(){N(Y,et,{step:1,block:"add"})},t=new OrderViewModel,Parameters.cache.order.step5=t),t.AddContent(e),Z(t)}function W(e){J.RenderTemplate(e,K,null,function(e){P(),W(e)},function(){A()},"step1")}function x(e){J.RenderTemplate(e,K,null,function(e){I(),x(e)},function(){A()},"step1Confirm")}function Q(e){J.RenderTemplate(e,K,null,function(e){O(),Q(e)},function(){A()},"step1Profile")}function j(e){J.RenderTemplate(e,K,null,function(e){_(),j(e)},function(){A()},"step2")}function z(e){J.RenderTemplate(e,K,function(){G(e)},function(e){w(),z(e)},function(){A()},"step2Form")}function q(e){J.RenderTemplate(e,K,null,function(e){E(),q(e)},function(){A()},"step3")}function H(e){J.RenderTemplate(e,K,null,function(e){L(),H(e)},function(){A()},"step4")}function Z(e){J.RenderTemplate(e,K,null,function(e){S(),Z(e)},function(){A()},"step5")}function G(e){$("#"+e.cssRegionList).autocomplete({source:function(t,r){J.BaseLoad.Region(e.country().id+"/"+encodeURIComponent(t.term),function(t){return t.err?($("#"+e.cssRegionList).autocomplete("close"),!1):void r($.map(t,function(e){return{value:$.trim(e.formalname+" "+e.shortname),region:e}}))})},select:function(t,r){e.region(r.item.region),e.customRegion(r.item.value),e.postCode(r.item.region&&0!=r.item.region.postalcode?r.item.region.postalcode:null)}}),$("#"+e.cssCityList).autocomplete({source:function(t,r){e.region()&&J.BaseLoad.City(e.country().id+"/"+encodeURIComponent(e.region().regioncode)+"/"+encodeURIComponent(t.term),function(t){return t.err?($("#"+e.cssCityList).autocomplete("close"),!1):void r($.map(t,function(e){return{value:$.trim(e.shortname+". "+e.formalname),city:e}}))})},select:function(t,r){e.city(r.item.city),e.customCity(r.item.value),e.postCode(r.item.city&&0!=r.item.city.postalcode?r.item.city.postalcode:null)}}),$("#"+e.cssAddress).autocomplete({source:function(t,r){e.region()&&J.BaseLoad.Street(e.country().id+"/"+encodeURIComponent(e.region().regioncode)+"/"+encodeURIComponent(e.city().aoguid)+"/"+encodeURIComponent(t.term),function(t){return t.err?($("#"+e.cssAddress).autocomplete("close"),!1):void r($.map(t,function(e){return{value:$.trim(e.shortname+". "+e.formalname),street:e}}))})},select:function(t,r){e.address(r.item.street),e.customAddress(r.item.value),e.postCode(r.item.street&&0!=r.item.street.postalcode?r.item.street.postalcode:null)}}),$("#"+e.cssCountryList).change(function(){var t=$("#"+e.cssCountryList+" option:selected").val();t&&(e.errorCountry(""),e.errorRegion(""),e.errorCity(""),e.errorAddress(""),e.errorPostCode("")),$.grep(e.countryList(),function(r){r.id==t&&(e.country(r),e.customRegion(null),e.region(null),e.customCity(null),e.city(null),e.customAddress(null),e.address(null),e.postCode(null))})}),$("#"+e.cssRegionList).bind("textchange",function(){e.errorRegion(""),e.errorCity(""),e.errorAddress(""),e.errorPostCode(""),e.customRegion($(this).val()),e.customCity(null),e.city(null),e.customAddress(null),e.address(null),e.postCode(null)}),$("#"+e.cssCityList).bind("textchange",function(){e.errorCity(""),e.errorAddress(""),e.errorPostCode(""),e.customCity($(this).val()),e.customAddress(null),e.address(null),e.postCode(null)}),$("#"+e.cssAddressList).bind("textchange",function(){e.errorAddress(""),e.errorPostCode("")}),$("#"+e.cssPostCode).bind("textchange",function(){e.errorPostCode("")}),$("#"+e.cssAddressee).bind("textchange",function(){e.errorAddressee("")}),$("#"+e.cssContactPhone).bind("textchange",function(){e.errorContactPhone("")})}function N(e,t,r){Routing.SetHash(e,t,r)}var J=this;J.widgetName="OrderWidget",J.version=1.1,J.minWidgetVersion=1,J.maxWidgetVersion=2,J.minTmplVersion=1,J.maxTmplVersion=2;var K={container:{widget:"content",def:"defaultOrderWidgetId"},tmpl:{path:"orderTmpl.html",id:{step1:"orderFormStep1Tmpl",step1Confirm:"orderConfirmFormStep1Tmpl",step1Profile:"orderProfileFormStep1Tmpl",step2:"orderFormStep2Tmpl",step2Form:"orderDeliveryFormStep2Tmpl",step3:"orderFormStep3Tmpl",step4:"orderFormStep4Tmpl",step5:"orderFormStep5Tmpl"}},regular:{username:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,gender:/^[mw]$/,addressee:/^[a-zа-яёА-ЯЁA-Z\s]+$/,postIndex:/^[0-9]+$/},message:{addAddressDelivery:"Данные успешно сохранены.",failAddAddressDelivery:"Данные не сохранены. Попробуйте повторить запрос позднее.",deleteAddressDelivery:"Адрес доставки успешно удален.",confirmDeleteAddressDelivery:"Вы уверены, что хотите удалить адрес?",failDeleteAddressDelivery:"Адрес доставки не удален. Попробуйте повторить запрос позднее.",setDefaultDelivery:"Данные успешно обновлены.",failSetDefaultDelivery:"Данные не обновлены.",orderConfirm:"Ваш заказ подтвержден.",selectMethodPayment:"Необходимо выбрать способ оплаты.",selectAddress:"Необходимо выбрать метод доставки.",selectMethodShipping:"Необходимо выбрать метод доставки.",confirmDeleteOrder:"Вы уверны, что хотите удалить заказ?",deleteOrderConfirm:"Ваш заказ удален.",sendToken:"Код активации успешно выслан по указанным данным.",failSendToken:"Код не был отправлен. Попробуйте повторить запрос позднее."},error:{username:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"},addressee:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},phone:{empty:"Поле обязательно для заполнения",regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"}},animate:"function"==typeof AnimateOrder?AnimateOrder:null},X={type:null,id:null,sellerId:null,goodsId:null,count:null,content:null,delivery:{},shipping:{},payment:{}},Y="order",et="Оформление заказа";J.InitWidget=e},OrderFormStep1ViewModel=function(){var e=this,t=new AuthenticationViewModel;t.subminEvent("Order.step1.authentication"),e.loginForm=t,e.registrationForm=new RegistrationFormViewModel,e.registrationForm.submitEvent("Order.step1.registration")},OrderFormStep2ViewModel=function(e){function t(){var e=!1;return $.each(o.addressList(),function(t){return o.addressList()[t].isDefault()?(e=!0,!1):void 0}),e}function r(e,t,r){Routing.SetHash(e,t,r)}var o=this,n="Оформление заказа",i="order";o.addressList=ko.observableArray(),o.cssAddressList="delivary_address_list",o.checked=ko.observable(),o.selectedItem=ko.observable(),o.ClickAddAddress=function(){r(i,n,{step:2,block:"add"})},o.AddContent=function(t,r){t.err||(o.addressList=ko.observableArray());for(var n in t){OrderItemFormStep2ViewModel.prototype=new Widget;var i=new OrderItemFormStep2ViewModel(t[n],o,e);o.addressList.push(i),"yes"==t[n].is_default&&(r.delivery=i),1==t.length&&i.ClickItem()}},o.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile))for(var e=Parameters.cache.history,t=0;t<=e.length-1;t++){var o=e.pop();if("order"!=o.route)return r(o.route,o.title,o.data,!0),!1}else r(i,n,{step:1,block:"profile"})},o.Submit=function(){t()?EventDispatcher.DispatchEvent("Order.step2.change",{id:o.checked(),selected:o.selectedItem(),fn:function(){r(i,n,{step:3})}}):EventDispatcher.DispatchEvent("Order.step2.message")},o.ClickStep1=function(){r(i,n,{step:1,block:"profile"})}},OrderItemFormStep2ViewModel=function(e,t,r){var o=this;o.id=e.id?e.id:"",o.idCountry=e.id_country,o.country=e.country,o.codeRegion=e.code_region,o.region=e.region,o.codeCity=e.code_city,o.city=e.city,o.postCode=e.post_code,o.address=e.address,o.addressee=e.addressee,o.contactPhone=e.contact_phone,o.list=t.addressList(),o.isDefault=ko.observable(!0),"yes"==e.is_default?(o.cssIsDefault=ko.observable("delivery_address_is_default active"),Parameters.cache.order.delivery=o,t.checked(o.id)):(o.isDefault=ko.observable(!1),o.cssIsDefault=ko.observable("delivery_address_is_default")),o.Delete=function(){o.Confirm(r.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("Order.step2.delete",{address:o,list:t.addressList})},!1)},o.ClickItem=function(){$.each(o.list,function(e){o.list[e].cssIsDefault("delivery_address_is_default"),o.list[e].isDefault(!1)}),o.cssIsDefault("delivery_address_is_default active"),o.isDefault(!0),t.checked(o.id),t.selectedItem(o),Parameters.cache.order.delivery=o}},OrderDeliveryFormStep2ViewModel=function(e){function t(e,t,r){Routing.SetHash(e,t,r)}function r(){var e=!0;return c()||(e=!1),a()||(e=!1),o()||(e=!1),n()||(e=!1),i()||(e=!1),s()||(e=!1),d()||(e=!1),e}function o(){return l.country()?(l.errorCountry(null),!0):(l.errorCountry(e.error.country.empty),!1)}function n(){return l.customRegion()?(l.errorRegion(null),!0):(l.errorRegion(e.error.region.empty),!1)}function i(){return l.customCity()?(l.errorCity(null),!0):(l.errorCity(e.error.city.empty),!1)}function s(){return l.customAddress()?(l.errorAddress(null),!0):(l.errorAddress(e.error.address.empty),!1)}function d(){var t=e.error.postIndex;return l.postCode()?5>l.postCode().length||l.postCode().length>6?(l.errorPostCode(t.length),!1):e.regular.postIndex.test(l.postCode())?(l.errorPostCode(null),!0):(l.errorPostCode(t.regular),!1):(l.errorPostCode(t.empty),!1)}function a(){var t=e.error.addressee;return l.addressee()?l.addressee().length<3?(l.errorAddressee(t.minLength),!1):l.addressee().length>40?(l.errorAddressee(t.maxLength),!1):e.regular.addressee.test(l.addressee())?(l.errorAddressee(null),!0):(l.errorAddressee(t.regular),!1):(l.errorAddressee(t.empty),!1)}function c(){var t=e.error.phone;return l.contactPhone()?e.regular.phone.test($.trim(l.contactPhone()))?(l.errorContactPhone(null),!0):(l.errorContactPhone(t.regular),!1):(l.errorContactPhone(t.empty),!1)}var l=this,p="Оформление заказа",u="order";l.id=ko.observable(),l.idCountry=ko.observable(),l.country=ko.observable(),l.cssCountryList="delivery_country_list",l.errorCountry=ko.observable(null),l.codeRegion=ko.observable(),l.region=ko.observable(),l.customRegion=ko.observable(),l.cssRegionList="delivery_region",l.errorRegion=ko.observable(null),l.showRegion=ko.computed(function(){return l.country()?!1:!0},this),l.codeCity=ko.observable(),l.city=ko.observable(),l.customCity=ko.observable(),l.cssCityList="delivery_city",l.errorCity=ko.observable(null),l.showCity=ko.computed(function(){return l.customRegion()?!1:!0},this),l.address=ko.observable(),l.customAddress=ko.observable(),l.cssAddress="delivery_cssAddress",l.errorAddress=ko.observable(null),l.showAddress=ko.computed(function(){return l.customCity()?!1:!0},this),l.postCode=ko.observable(),l.cssPostCode="delivery_post_index",l.errorPostCode=ko.observable(null),l.showPostIndex=ko.computed(function(){return l.customAddress()?!1:!0},this),l.addressee=ko.observable(),l.cssAddressee="delivery_addressee",l.errorAddressee=ko.observable(null),l.contactPhone=ko.observable(),l.cssContactPhone="delivery_contact_phone",l.errorContactPhone=ko.observable(null),l.isDefault=ko.observable(),l.countryList=ko.observableArray(),l.AddCountryList=function(e){if(e.length>0)for(var t=0;t<=e.length-1;t++)l.countryList.push(new CountryListViewModel(e[t]))},l.AddContent=function(e){l.id(e.id),l.idCountry(e.idCountry),l.region({regioncode:e.codeRegion}),l.customRegion(e.region),l.city({aoguid:e.codeCity}),l.customCity(e.city),l.postCode(e.postCode),l.customAddress(e.address),l.addressee(e.addressee),l.isDefault(e.isDefault()),l.contactPhone(e.contactPhone)},l.Submit=function(){r()&&EventDispatcher.DispatchEvent("Order.step2.add",l)},l.Back=function(){t(u,p,{step:2})},l.ClickStep1=function(){t(p,u,{step:1,block:"profile"})},l.ClickStep2=function(){t(p,u,{step:2})}},OrderFormStep3ViewModel=function(){function e(){var e=!1;return $.each(r.shipping(),function(t){return r.shipping()[t].isActive()?(e=!0,!1):void 0}),e}function t(e,t,r){Routing.SetHash(e,t,r)}var r=this,o="Оформление заказа",n="order";r.shipping=ko.observableArray(),r.checked=ko.observable(),r.selectedItem=ko.observable(),r.AddShipping=function(e){r.shipping=ko.observableArray();for(var t=0;t<=e.length-1;t++){var o=new OrderItemFormStep3ViewModel(r);o.AddContent(e[t]),r.shipping.push(o),1==e.length&&o.ClickItem()}},r.Back=function(){t(n,o,{step:2})},r.Submit=function(){e()?EventDispatcher.DispatchEvent("Order.step3.change",{id:r.checked(),selected:r.selectedItem(),fn:function(){t(n,o,{step:4})}}):EventDispatcher.DispatchEvent("Order.step3.message")},r.ClickStep1=function(){t(n,o,{step:1,block:"profile"})},r.ClickStep2=function(){t(n,o,{step:2})},r.ClickAddAddress=function(){t(n,o,{step:2,block:"add"})}},OrderItemFormStep3ViewModel=function(e){var t=this;t.nameShippingCompany=ko.observable(),t.siteShippingCompany=ko.observable(),t.logoShippingCompany=ko.observable(),t.id=ko.observable(),t.nameMethodShipping=ko.observable(),t.descMethodShipping=ko.observable(),t.costShipping=ko.observable(),t.cssActive=ko.observable("shipping_row"),t.isActive=ko.observable(!1),t.AddContent=function(e){e.hasOwnProperty("name_shipping_company")&&t.nameShippingCompany(e.name_shipping_company),e.hasOwnProperty("site_shipping_company")&&t.siteShippingCompany(e.site_shipping_company),e.hasOwnProperty("logo_shipping_company")&&t.logoShippingCompany(e.logo_shipping_company),e.hasOwnProperty("id")&&t.id(e.id),e.hasOwnProperty("name_method_shipping")&&t.nameMethodShipping(e.name_method_shipping),e.hasOwnProperty("desc_method_shipping")&&t.descMethodShipping(e.desc_method_shipping),e.hasOwnProperty("cost_shipping")&&t.costShipping(e.cost_shipping)},t.ClickItem=function(){$.each(e.shipping(),function(t){e.shipping()[t].cssActive("shipping_row"),e.shipping()[t].isActive(!1)}),t.cssActive("shipping_row active"),t.isActive(!0),e.checked(t.id()),e.selectedItem(t)}},OrderFormStep4ViewModel=function(){function e(){var e=!1;return $.each(r.payment(),function(t){return r.payment()[t].isActive()?(e=!0,!1):void 0}),e}function t(e,t,r){Routing.SetHash(e,t,r)}var r=this,o="Оформление заказа",n="order";r.payment=ko.observableArray(),r.checked=ko.observable(),r.selectedItem=ko.observable(),r.AddPayment=function(e){r.payment=ko.observableArray();for(var t=0;t<=e.length-1;t++){var o=new OrderItemFormStep4ViewModel(r);o.AddContent(e[t]),r.payment.push(o),1==e.length&&o.ClickItem()}},r.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile))for(var e=Parameters.cache.history,r=0;r<=e.length-1;r++){var i=e.pop();if("order"!=i.route)return t(i.route,i.title,i.data,!0),!1;t(n,o,{step:3})}else t(n,o,{step:3})},r.Submit=function(){e()?EventDispatcher.DispatchEvent("Order.step4.change",{id:r.checked(),selected:r.selectedItem(),fn:function(){t(n,o,{step:5})}}):EventDispatcher.DispatchEvent("Order.step4.message")},r.ClickStep1=function(){t(n,o,{step:1,block:"profile"})},r.ClickStep2=function(){t(n,o,{step:2})},r.ClickStep3=function(){t(n,o,{step:3})},r.ClickAddAddress=function(){t(n,o,{step:2,block:"add"})}},OrderItemFormStep4ViewModel=function(e){var t=this;t.id=ko.observable(),t.logoPayment=ko.observable(),t.descPayment=ko.observable(),t.instrPayment=ko.observable(),t.namePayment=ko.observable(),t.costPayment=ko.observable(),t.cssActive=ko.observable("payment_row"),t.isActive=ko.observable(!1),t.AddContent=function(e){t.id(e.id),e.hasOwnProperty("logo_payment")&&t.logoPayment(e.logo_payment),e.hasOwnProperty("desc_payment")&&t.descPayment(e.desc_payment),e.hasOwnProperty("instr_payment")&&t.instrPayment(e.instr_payment),e.hasOwnProperty("name_payment")&&t.namePayment(e.name_payment),e.hasOwnProperty("cost_payment")&&t.costPayment(e.cost_payment)},t.ClickItem=function(){$.each(e.payment(),function(t){e.payment()[t].cssActive("payment_row"),e.payment()[t].isActive(!1)}),t.cssActive("payment_row active"),t.isActive(!0),e.checked(t.id()),e.selectedItem(t)}},TestOrder={Init:function(){if("function"==typeof Widget){OrderWidget.prototype=new Widget;var e=new OrderWidget;e.Init(e)}else setTimeout(function(){TestOrder.Init()},100)}};TestOrder.Init();