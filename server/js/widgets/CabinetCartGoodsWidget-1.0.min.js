var CabinetCartGoodsWidget=function(){function e(){n(),o(),t()}function o(){var e=u.GetInputParameters("cabinetCartGoods");$.isEmptyObject(e)||(f=u.UpdateSettings1(f,e)),Config.CabinetCartGoods=f}function t(){"cabinet_cart"==Routing.route?u.BaseLoad.Tmpl(f.tmpl,function(){r()}):u.WidgetLoader(!0)}function n(){u.AddEvent("w.change.route",function(){t()}),u.AddEvent("CartCG.onload.info",function(e){e.err?(c(),l()):(s(),m.Content(e))}),u.AddEvent("CartCG.change.count",function(e){u.BaseLoad.AddGoodsToCart(e.id,e.sellerId,e.ordered(),function(o){u.DispatchEvent("widgets.cart.infoUpdate",o),e.sellCost(o.sell_cost),e.sellEndCost(o.sell_end_cost)})}),u.AddEvent("CartCG.clear",function(e){var o=e.goodsId?e.goodsId:!1;u.BaseLoad.ClearCart(e.sellerId,o,function(e){u.DispatchEvent("widgets.cart.infoUpdate",e)})}),u.AddEvent("CartCG.empty.cart",function(){c(),l()})}function r(){u.WidgetLoader(!1),u.BaseLoad.Login(!1,!1,!1,function(e){e.err?(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("login","Авторизация пользователя",{}),u.WidgetLoader(!0)):(Loader.Indicator("MenuPersonalCabinetWidget",!1),u.BaseLoad.InfoFavorite("no",function(e){Parameters.cache.favorite=e,u.BaseLoad.CartGoods("",function(e){u.DispatchEvent("CartCG.onload.info",e)})}),a())})}function a(){u.BaseLoad.Script(PokupoWidgets.model.menu,function(){u.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function i(){u.ClearContainer(f)}function s(){u.InsertContainer(f,"content")}function c(){u.InsertContainer(f,"empty")}function d(e){u.RenderTemplate(e,f,null,function(e){s(),d(e)},function(){i()},"content")}function l(){u.WidgetLoader(!0,f.container.widget),f.animate&&f.animate()}var u=this;u.widgetName="CabinetCartGoodsWidget",u.version=1,u.minWidgetVersion=1,u.maxWidgetVersion=2,u.minTmplVersion=1,u.maxTmplVersion=2,u.cart=null,u.InitWidget=e;var f={container:{widget:"content",def:"defaultCartGoodsCabinetWidgetId"},tmpl:{path:"cabinetCartGoodsTmpl.html",id:{content:"cabinetCartGoodsTmpl",empty:"emptyCabinetCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},animate:"function"==typeof AnimateCabinetCartGoods?AnimateCabinetCartGoods:null},m={Content:function(e){var o=new CartGoodsViewModel;for(var t in e){BlockCabinetGoodsForSellerViewModel.prototype=new Widget,u.cart=new BlockCabinetGoodsForSellerViewModel(o,f);for(var n in e[t])"function"==typeof m[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()]&&m[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()](e[t][n]);o.AddContent(u.cart)}d(o)},Goods:function(e){u.cart.AddContent(e)},Seller:function(e){u.cart.sellerInfo.seller=e},Shop:function(e){u.cart.sellerInfo.shop=e},Operator:function(e){u.cart.sellerInfo.operator=e},Final_cost:function(e){u.cart.finalCost=e}}},CartGoodsViewModel=function(){var e=this;e.sellerBlock=ko.observableArray(),e.AddContent=function(o){e.sellerBlock.push(o)}},BlockCabinetGoodsForSellerViewModel=function(e,o){function t(e,o){EventDispatcher.DispatchEvent(e,o)}var n=this;n.sellerInfo={},n.goods=ko.observableArray(),n.finalCost=0,n.tatalForPayment=ko.computed(function(){var e=0;if(n.goods().length>0)for(var o=0;o<=n.goods().length-1;o++)e+=parseFloat(n.goods()[o].endSum());return e.toFixed(2)},this),n.totalSum=ko.computed(function(){var e=0;if(n.goods().length>0)for(var o=0;o<=n.goods().length-1;o++)e+=parseFloat(n.goods()[o].sum());return e.toFixed(2)},this),n.tatalDiscount=ko.computed(function(){return(n.totalSum()-n.tatalForPayment()).toFixed(2)},this),n.uniq=EventDispatcher.HashCode((new Date).getTime().toString()),n.AddContent=function(t){for(var r=0;r<=t.length-1;r++)BlockCabinetCartGoodsSellersViewModel.prototype=new Widget,n.goods.push(new BlockCabinetCartGoodsSellersViewModel(t[r],n,e,o));n.finalCost=t.final_cost},n.comment=ko.observable(),n.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(n.goods(),function(o){o.isSelected()&&(e.push(o.id),o.IsFavorite(!0))}),n.AddCommentForm(e)},n.AddCommentForm=function(e){n.comment(" "),$("#dialog-form-batch").dialog({height:300,width:396,modal:!0,buttons:{"Сохранить":function(){var o=[];$.each(e,function(t){o[t]=e[t].id}),t("w.fav.add",{goodsId:o.join(","),comment:n.comment(),data:e}),$(this).dialog("close")}}})},n.ClickButchRemove=function(){n.Confirm(o.message.confirmButchRemove,function(){n.Remove()})},n.Remove=function(){for(var o=[],r=[],a=n.goods().length-1,i=0;a>=i;i++)n.goods()[i].isSelected()&&(o.push(n.goods()[i].id),r.push(n.goods()[i]));for(var i in r)n.goods.remove(r[i]);t("CartCG.clear",{goodsId:o.join(","),sellerId:n.sellerInfo.shop.id}),0==n.goods().length&&e.content.remove(n),0==e.content().length&&t("CartCG.empty.cart")},n.IsFavorite=function(){},n.ClickProceed=function(){var e=Parameters.cache.lastPage;"cart"!=e.route?Routing.SetHash(e.route,e.title,e.data):Routing.SetHash("default","Домашняя",{})},n.ClickIssueOrder=function(){null==Parameters.cache.userInformation||null!=Parameters.cache.userInformation&&Parameters.cache.userInformation.err?(Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:n.sellerInfo.shop.id}},Routing.SetHash("login","Авторизация пользователя",{})):Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:n.sellerInfo.shop.id})},n.ClickClearCurt=function(){n.Confirm(o.message.confirmClearCart,function(){for(var o=n.goods().length-1,r=[],a=0;o>=a;a++)r.push(n.goods()[a]);for(var a in r)n.goods.remove(r[a]);e.sellerBlock.remove(n),t("CartCG.clear",{sellerId:n.sellerInfo.shop.id}),0==e.sellerBlock().length&&t("CartCG.empty.cart")})},n.cssSelectAll="cartGoodsSelectAll_"+n.uniq,n.isSelectedAll=ko.observable(!1),n.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods())[0].checked=e,o.isSelected(e)})}),n.ClickSelectAll=function(){var e,o=$("#"+n.cssSelectAll),t=o.is(":checked");t?(o[0].checked=!1,e=!1):(o[0].checked=!0,e=!0),ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods())[0].checked=e,o.isSelected(e)})},n.isDisabledButton=ko.computed(function(){for(var e=n.goods().length,o=[],t=0;e-1>=t;t++)n.goods()[t].isSelected()&&o.push(n.goods()[t].id);return o.length>0?!1:!0},this)},BlockCabinetCartGoodsSellersViewModel=function(e,o,t,n){function r(){o.goods.remove(s),0==o.goods().length&&(t.sellerBlock.remove(o),0==t.sellerBlock().length&&i("CartCG.empty.cart"))}function a(e,o){EventDispatcher.AddEventListener(e,o)}function i(e,o){EventDispatcher.DispatchEvent(e,o)}var s=this;s.sellerId=o.sellerInfo.seller.id,s.id=e.id,s.fullName=e.full_name,s.countReserv=e.count_reserv,s.count=e.count,s.sellCost=ko.observable(e.sell_cost),s.sellEndCost=ko.observable(e.sell_end_cost),s.routeImages=e.route_image,s.routeBigImages=e.route_big_image,s.ordered=ko.observable(s.count),s.sum=ko.computed(function(){return(s.ordered()*s.sellCost()).toFixed(2)},this),s.endSum=ko.computed(function(){return(s.ordered()*s.sellEndCost()).toFixed(2)},this),s.isSelected=ko.observable(!1),s.isSelected.subscribe(function(){for(var e=o.goods().length,t=[],n=0;e-1>=n;n++)o.goods()[n].isSelected()&&t.push(o.goods()[n].id);$("#"+o.cssSelectAll)[0].checked=t.length<e?!1:!0}),s.cssCheckboxGoods=ko.observable("goods_"+s.id),s.ClickOrder=function(e){var o=$("#"+e.cssCheckboxGoods()),t=o.is(":checked");0==t?(o[0].checked=!0,s.isSelected(!0)):(o[0].checked=!1,s.isSelected(!1))},s.discount=ko.computed(function(){var e=100-Math.floor(100*s.sellEndCost()/s.sellCost());return e>0?e+"%":0},this),s.comment=ko.observable(),s.ClickPlus=function(){s.ordered()<s.countReserv?(s.ordered(s.ordered()+1),i("CartCG.change.count",s)):s.ShowMessage(n.message.maxIsReached,!1,!1)},s.ClickMinus=function(){s.ordered()>0&&(s.ordered(s.ordered()-1),i("CartCG.change.count",s))},s.ClickGoods=function(){Routing.SetHash("goods",s.fullName,{id:s.id})},s.AddFavorites=function(){null==Parameters.cache.userInformation||Parameters.cache.userInformation.err?s.ShowMessage(n.message.pleaseLogIn,!1,!1):s.AddCommentForm()},s.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})},s.ClickRemove=function(){s.Confirm(n.message.confirmRemove,function(){s.Remove()})},s.Remove=function(){i("CartCG.clear",{goodsId:s.id,sellerId:s.sellerId}),r()},s.AddCommentForm=function(){o.comment(" "),$("#dialog-form-batch").dialog({height:300,width:396,modal:!0,buttons:{"Сохранить":function(){i("w.fav.add",{goodsId:s.id,comment:o.comment(),data:s}),s.IsFavorite(!0),$(this).dialog("close")}}})},s.IsFavorite=ko.observable(),s.IsFavorite($.inArray(s.id,Parameters.cache.favorite)>=0?!0:!1),a("CartGoods.clear.cartInfo."+s.sellerId+"."+s.id,function(){r()}),a("CartGoods.change.cartInfo."+s.sellerId+"."+s.id,function(e){s.ordered(e)})},TestCabinetCartGoods={Init:function(){if("function"==typeof Widget){CabinetCartGoodsWidget.prototype=new Widget;var e=new CabinetCartGoodsWidget;e.Init(e)}else setTimeout(function(){TestCabinetCartGoods.Init()},100)}};TestCabinetCartGoods.Init();