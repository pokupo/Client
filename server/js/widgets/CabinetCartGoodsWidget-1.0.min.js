var CabinetCartGoodsWidget=function(){var n=this;n.widgetName="CabinetCartGoodsWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.cart=null;n.InitWidget=g;var d={container:{widget:"content",def:"defaultCartGoodsCabinetWidgetId"},tmpl:{path:"cabinetCartGoodsTmpl.html",id:{content:"cabinetCartGoodsTmpl",empty:"emptyCabinetCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},animate:typeof AnimateCabinetCartGoods=="function"?AnimateCabinetCartGoods:null};function g(){l();b();e()}function b(){var o=n.GetInputParameters("cabinetCartGoods");if(!$.isEmptyObject(o)){d=n.UpdateSettings1(d,o)}Config.Containers.cabinetCartGoods=d.container}function e(){if(Routing.route=="cabinet_cart"){n.BaseLoad.Tmpl(d.tmpl,function(){j()})}else{n.WidgetLoader(true)}}function l(){n.AddEvent("w.change.route",function(){e()});n.AddEvent("CartCG.onload.info",function(o){if(!o.err){c();m.Content(o)}else{i();k()}});n.AddEvent("CartCG.change.count",function(o){n.BaseLoad.AddGoodsToCart(o.id,o.sellerId,o.ordered(),function(p){n.DispatchEvent("widgets.cart.infoUpdate",p);o.sellCost(p.sell_cost);o.sellEndCost(p.sell_end_cost)})});n.AddEvent("CartCG.clear",function(p){var o=p.goodsId?p.goodsId:false;n.BaseLoad.ClearCart(p.sellerId,o,function(q){n.DispatchEvent("widgets.cart.infoUpdate",q)})});n.AddEvent("CartCG.empty.cart",function(){i();k()})}function j(){n.WidgetLoader(false);n.BaseLoad.Login(false,false,false,function(o){if(!o.err){Loader.Indicator("MenuPersonalCabinetWidget",false);n.BaseLoad.InfoFavorite("no",function(p){Parameters.cache.favorite=p;n.BaseLoad.CartGoods("",function(q){n.DispatchEvent("CartCG.onload.info",q)})});f()}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});n.WidgetLoader(true)}})}function f(){n.BaseLoad.Script(PokupoWidgets.model.menu,function(){n.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){n.ClearContainer(d)}function c(){n.InsertContainer(d,"content")}function i(){n.InsertContainer(d,"empty")}var m={Content:function(r){var q=new CartGoodsViewModel();for(var o in r){BlockCabinetGoodsForSellerViewModel.prototype=new Widget();n.cart=new BlockCabinetGoodsForSellerViewModel(q,d);for(var p in r[o]){if(typeof m[p.charAt(0).toUpperCase()+p.substr(1).toLowerCase()]=="function"){m[p.charAt(0).toUpperCase()+p.substr(1).toLowerCase()](r[o][p])}}q.AddContent(n.cart)}h(q)},Goods:function(p){n.cart.AddContent(p);for(var o=0;o<=p.length-1;o++){n.BaseLoad.GoodsInfo(p[o].id,1001000,function(q){n.cart.AddGoods(q)})}},Seller:function(o){n.cart.sellerInfo.seller=o},Shop:function(o){n.cart.sellerInfo.shop=o},Operator:function(o){n.cart.sellerInfo.operator=o},Final_cost:function(o){n.cart.finalCost=o}};function h(o){n.RenderTemplate(o,d,null,function(p){c();h(p)},function(){a()},"content")}function k(){n.WidgetLoader(true,d.container.widget);if(d.animate){d.animate()}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockCabinetGoodsForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].endSum())}}return f.toFixed(2)},this);a.totalSum=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].sum())}}return f.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.AddContent=function(e){a.finalCost=e.final_cost};a.AddGoods=function(e){BlockCabinetCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCabinetCartGoodsSellersViewModel(e.main,a,d,c))};a.comment=ko.observable();a.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(a.goods(),function(f){if(f.isSelected()){e.push(f.id);f.IsFavorite(true)}});a.AddCommentForm(e)};a.AddCommentForm=function(e){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){var f=[];$.each(e,function(g){f[g]=e[g].id});b("w.fav.add",{goodsId:f.join(","),comment:a.comment(),data:e});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}for(var g in f){a.goods.remove(f[g])}b("CartCG.clear",{goodsId:e.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){d.content.remove(a)}if(d.content().length==0){b("CartCG.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){var e=Parameters.cache.lastPage;if(e.route!="cart"){Routing.SetHash(e.route,e.title,e.data)}else{Routing.SetHash("default","Домашняя",{})}};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation==null||(Parameters.cache.userInformation!=null&&Parameters.cache.userInformation.err)){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(c.message.confirmClearCart,function(){var g=a.goods().length-1;var e=[];for(var f=0;f<=g;f++){e.push(a.goods()[f])}for(var f in e){a.goods.remove(e[f])}d.sellerBlock.remove(a);b("CartCG.clear",{sellerId:a.sellerInfo.shop.id});if(d.sellerBlock().length==0){b("CartCG.empty.cart")}})};a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods())[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(h){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(i){$("#"+i.cssCheckboxGoods())[0].checked=g;i.isSelected(g)})};a.isDisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return false}return true},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockCabinetCartGoodsSellersViewModel=function(f,h,d,c){var a=this;a.sellerId=h.sellerInfo.seller.id;a.id=f.id;a.fullName=f.full_name;a.countReserv=f.count_reserv;a.count=f.count;a.sellCost=ko.observable(f.sell_cost);a.sellEndCost=ko.observable(f.sell_end_cost);a.routeImages=f.route_image;a.routeBigImages=f.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(f.is_egoods=="yes"){return true}return false},this);if(a.isEgoods()&&!a.count){a.ordered(1)}a.showSelectionCount=ko.computed(function(){if(f.count&&f.count!=0){return true}return false},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(k){var j=h.goods().length;var m=[];for(var l=0;l<=j-1;l++){if(h.goods()[l].isSelected()){m.push(h.goods()[l].id)}}if(m.length<j){$("#"+h.cssSelectAll)[0].checked=false}else{$("#"+h.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(i,k){var j=$("#"+i.cssCheckboxGoods());var l=j.is(":checked");if(l==false){j[0].checked=true;a.isSelected(true)}else{j[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var i=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(i>0){return i+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);b("CartCG.change.count",a)}else{a.ShowMessage(c.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);b("CartCG.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(c.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){b("CartCG.clear",{goodsId:a.id,sellerId:a.sellerId});g()};a.AddCommentForm=function(){h.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){b("w.fav.add",{goodsId:a.id,comment:h.comment(),data:a});a.IsFavorite(true);$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}function g(){h.goods.remove(a);if(h.goods().length==0){d.sellerBlock.remove(h);if(d.sellerBlock().length==0){b("CartCG.empty.cart")}}}e("CartGoods.clear.cartInfo."+a.sellerId+"."+a.id,function(){g()});e("CartGoods.change.cartInfo."+a.sellerId+"."+a.id,function(i){a.ordered(i)});function e(i,j){EventDispatcher.AddEventListener(i,j)}function b(i,j){EventDispatcher.DispatchEvent(i,j)}};var TestCabinetCartGoods={Init:function(){if(typeof Widget=="function"){CabinetCartGoodsWidget.prototype=new Widget();var a=new CabinetCartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCabinetCartGoods.Init()},100)}}};TestCabinetCartGoods.Init();