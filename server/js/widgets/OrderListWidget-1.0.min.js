var OrderListWidget=function(){function e(){t(),r(),n()}function t(){var e=h.GetInputParameters("orderList");$.isEmptyObject(e)||(L=h.UpdateSettings1(L,e),e.show&&e.show.hasOwnProperty("menu")&&(L.show.menu=e.show.menu)),Config.OrderList=L}function n(){"purchases"==Routing.route?(h.WidgetLoader(!1),h.BaseLoad.Login(!1,!1,!1,function(e){e.err?(Parameters.cache.lastPage={route:"default"},m("login","Авторизация пользователя",{}),h.WidgetLoader(!0)):h.BaseLoad.Tmpl(L.tmpl,function(){L.show.menu&&o(),i()})})):h.WidgetLoader(!0)}function r(){h.AddEvent("w.change.route",function(){n()}),h.AddEvent("LOrder.repeat",function(e){h.BaseLoad.RepeatOrder(e.id,function(t){h.QueryError(t,function(){h.DispatchEvent("LOrder.repeat",e)})&&h.ShowMessage(L.message.orderRepeat,function(){Parameters.cache.orderList={},h.DispatchEvent("LOrder.edit",{id:t.id})},!1)})}),h.AddEvent("LOrder.return",function(e){h.BaseLoad.ReturnOrder(e.id,function(t){h.QueryError(t,function(){h.DispatchEvent("LOrder.return",e)})&&h.ShowMessage(L.message.orderReturn,function(){Parameters.cache.orderList={},m("cart","Моя корзина")},!1)})}),h.AddEvent("LOrder.cancel",function(e){h.Confirm(L.message.confirmCancelOrder,function(){h.BaseLoad.CancelOrder(e.id,function(t){h.QueryError(t,function(){h.DispatchEvent("LOrder.cancel",e)})&&h.ShowMessage(L.message.orderCancel,function(){Parameters.cache.orderList={},e.fn()},!1)})})}),h.AddEvent("LOrder.check",function(e){h.BaseLoad.ConfirmOrder(e.id,function(t){t.err?h.ShowMessage(t.msg,function(){"Not defined Payment Method"==t.err?m(O,v,{step:4,id:e.id}):m(O,v,{step:2,id:e.id})}):h.ShowMessage(L.message.orderConfirm,function(){Parameters.cache.orderList={},e.fn()})})}),h.AddEvent("LOrder.delete",function(e){h.Confirm(L.confirmDeleteOrder,function(){h.BaseLoad.DeleteOrder(e.id,function(t){h.QueryError(t,function(){h.DispatchEvent("LOrder.delete",e)})&&h.ShowMessage(L.message.orderDelete,function(){Parameters.cache.orderList={},e.fn()},!1)})})}),h.AddEvent("LOrder.edit",function(e){m(O,v,{step:2,id:e.id})}),h.AddEvent("LOrder.pay",function(){})}function i(){h.WidgetLoader(!1),"list"==Routing.params.block?(h.currentPage=Routing.GetCurrentPage(),u()):"detail"==Routing.params.block&&Routing.params.id&&h.BaseLoad.Script(PokupoWidgets.model.order,function(){f(Routing.params.id)})}function o(){h.BaseLoad.Script(PokupoWidgets.model.menu,function(){h.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){h.ClearContainer(L)}function d(){h.InsertContainer(L,"list")}function c(){h.InsertContainer(L,"detail")}function s(){h.InsertContainer(L,"empty")}function u(){var e=Routing.GetCurrentPage()*Config.Paging.itemsPerPage-Config.Paging.itemsPerPage,t="/"+e+"/"+Config.Paging.itemsPerPage;h.BaseLoad.OrderList(t,function(e){if(e.err)s(),p();else{d();var t=new OrderListViewModel;t.AddContent(e),l(t)}})}function f(e){h.BaseLoad.OrderInfo(e+"/yes",function(t){if(t.err)h.WidgetLoader(!0,L.container.widget),h.ShowMessage(t.msg,function(){m("purchases","Мои покупки",{block:"list",page:1})});else if(t.goods.length>0){c();var n=Parameters.cache.order.info,r="purchases",i="Мои покупки";$.isEmptyObject(n)&&(OrderViewModel.prototype.Back=function(){m(r,i,{block:"list",page:Routing.GetLastPageNumber()})},OrderViewModel.prototype.ClickEdit=function(){h.DispatchEvent("LOrder.edit",{id:e})},OrderViewModel.prototype.ClickDelete=function(){h.DispatchEvent("LOrder.delete",{id:e,fn:function(){m(r,i,{block:"list",page:1})}})},OrderViewModel.prototype.ClickCancel=function(){h.DispatchEvent("LOrder.cancel",{id:e,fn:function(){m(r,i,{block:"list",page:1})}})},OrderViewModel.prototype.ClickPay=function(){h.DispatchEvent("LOrder.pay",{id:e,fn:function(){}})},OrderViewModel.prototype.ClickCheck=function(){h.DispatchEvent("LOrder.check",{id:e,fn:function(){m(r,i,{block:"detail",id:Routing.params.id})}})},OrderViewModel.prototype.ClickRepeat=function(){h.DispatchEvent("LOrder.repeat",{id:e})},OrderViewModel.prototype.ClickReturn=function(){h.DispatchEvent("LOrder.return",{id:e})},n=new OrderViewModel(L),Parameters.cache.order.info=n),n.AddContent(t),g(n)}})}function l(e){h.RenderTemplate(e,L,null,function(e){d(),l(e)},function(){a()},"list")}function p(){h.WidgetLoader(!0,L.container.widget),L.animate&&L.animate()}function g(e){h.RenderTemplate(e,L,null,function(e){c(),g(e)},function(){a()},"detail")}function m(e,t,n){Routing.SetHash(e,t,n)}var h=this;h.widgetName="OrderListWidget",h.version=1,h.minWidgetVersion=1,h.maxWidgetVersion=2,h.minTmplVersion=1,h.maxTmplVersion=2,h.currentPage=1,h.InitWidget=e;var L={container:{widget:"content",def:"defaultOrderListWidgetId"},tmpl:{path:"orderListTmpl.html",id:{list:"orderListTmpl",empty:"orderEmptyListTmpl",detail:"orderDetailTmpl"}},message:{orderConfirm:"Ваш заказ подтвержден.",orderRepeat:"Ваш заказ повторен.",orderReturn:"Ваш заказ скопирован в корзину.",orderDelete:"Ваш заказ удален.",orderCancel:"Ваш заказ отменен.",confirmCancelOrder:"Вы уверены, что хотите отменить заказ?",confirmDeleteOrder:"Вы уверены, что хотите удалить заказ?"},show:{menu:!0},animate:"function"==typeof AnimateOrderList?AnimateOrderList:null},O="order",v="Оформление заказа"},OrderListViewModel=function(){var e=this;e.list=ko.observableArray(),e.paging=ko.observableArray(),e.count=0,e.AddContent=function(t){e.list=ko.observableArray(),$.each(t,function(n){"count_order"==n?e.count=t[n]:e.list.push(new OrderListDetailViewModel(t[n]))}),e.AddPages()},e.AddPages=function(){var t=function(){Loader.Indicator("OrderListWidget",!1),Routing.UpdateHash({page:this.pageId})};e.paging=Paging.GetPaging(e.count,{paging:Config.Paging},t)},e.ClickRefresh=function(){Parameters.cache.orderList={},Routing.SetHash("purchases","Мои покупки",{block:"list"})}},OrderListDetailViewModel=function(e){function t(){var e=0;i.viewShow()&&e++,i.viewEdit()&&e++,i.viewRepeat()&&e++,i.viewReturn()&&e++,i.viewCanсel()&&e++,i.viewDelete()&&e++;for(var t=1;5-e>=t;t++)i.emptyTd.push({id:t})}function n(e,t){EventDispatcher.DispatchEvent(e,t)}function r(e,t,n){Routing.SetHash(e,t,n)}var i=this,o="purchases",a="Мои покупки";i.id=e.id,i.cssFloatPopup="order_item",i.dateCreate=e.date_create,i.commentBuyer=e.comment_buyer,i.commentOperator=e.comment_operator,i.nameShop=e.name_shop,i.costShipping=e.cost_shipping,i.costPayment=e.cost_payment,i.sellCost=e.sell_cost,i.finalCost=e.final_cost,i.GetNamePay=function(e){return"wait_check"==e?"На проверке":"wait_pay"==e?"Ожидает оплаты":"paid"==e?"Оплачен":"cancel"==e?"Отменена":"back"==e?"Возвращена":!1},i.GetNameOrder=function(e){return"init"==e?"Формируется":"new"==e?"Новый":"process"==e?"В просессе обработки":"send"==e?"Отправлен":"delivered"==e?"Получен покупателем":"cancel"==e?"Отменен":!1},i.statusPay=e.status_pay,i.statusPayName=i.GetNamePay(e.status_pay),i.statusOrder=e.status_order,i.statusOrderName=i.GetNameOrder(e.status_order),i.viewShow=ko.computed(function(){return!0},this),i.ClickShow=function(){r(o,a,{block:"detail",id:i.id})},i.viewEdit=ko.computed(function(){var t=e.status_order;return"init"==t?!0:!1},this),i.ClickEdit=function(){n("LOrder.edit",{id:i.id})},i.viewRepeat=ko.computed(function(){var t=e.status_order;return"delivered"==t||"send"==t||"cancel"==t?!0:!1},this),i.ClickRepeat=function(){n("LOrder.repeat",{id:i.id})},i.viewReturn=ko.computed(function(){var t=e.status_order;return"delivered"==t||"send"==t||"cancel"==t?!0:!1},this),i.ClickReturn=function(){n("LOrder.return",{id:i.id,fn:function(){r(o,a,{id:i.id})}})},i.viewCanсel=ko.computed(function(){var t=e.status_order;return"init"!=t&&"new"!=t||"paid"==e.status_pay?!1:!0},this),i.ClickCancel=function(){n("LOrder.cancel",{id:i.id,fn:function(){r(o,a,{block:"list",page:Routing.GetCurrentPage()})}})},i.viewDelete=ko.computed(function(){var t=e.status_order;return"init"==t||"cancel"==t?!0:!1},this),i.ClickDelete=function(){n("LOrder.delete",{id:i.id,fn:function(){r(o,a,{block:"list",page:Routing.GetCurrentPage()})}})},i.viewCheck=ko.computed(function(){var t=e.status_order;return"init"==t?!0:!1},this),i.ClickCheck=function(){n("LOrder.check",{id:i.id,fn:function(){r(o,a,{block:"list",page:Routing.GetCurrentPage()})}})},i.viewPay=ko.computed(function(){var t=e.status_order;return"new"==t?!0:!1},this),i.ClickPay=function(){n("LOrder.pay",{id:i.id,fn:function(){}})},i.emptyTd=ko.observableArray(),t()},TestOrderList={Init:function(){if("function"==typeof Widget){OrderListWidget.prototype=new Widget;var e=new OrderListWidget;e.Init(e)}else setTimeout(function(){TestOrderList.Init()},100)}};TestOrderList.Init();