var OrderListWidget=function(){var i=this;i.widgetName="OrderListWidget";i.version=1;i.minWidgetVersion=1;i.maxWidgetVersion=2;i.minTmplVersion=1;i.maxTmplVersion=2;i.currentPage=1;i.InitWidget=f;var n={container:{widget:"content",def:"defaultOrderListWidgetId"},tmpl:{path:"orderListTmpl.html",id:{list:"orderListTmpl",empty:"orderEmptyListTmpl",detail:"orderDetailTmpl"}},message:{orderConfirm:"Ваш заказ подтвержден.",orderRepeat:"Ваш заказ повторен.",orderReturn:"Ваш заказ скопирован в корзину.",orderDelete:"Ваш заказ удален.",orderCancel:"Ваш заказ отменен.",confirmCancelOrder:"Вы уверены, что хотите отменить заказ?",confirmDeleteOrder:"Вы уверены, что хотите удалить заказ?"},show:{menu:true},animate:typeof AnimateOrderList=="function"?AnimateOrderList:null},j="order",t="Оформление заказа";function f(){r();h();a()}function r(){var u=i.GetInputParameters("orderList");if(!$.isEmptyObject(u)){n=i.UpdateSettings1(n,u);if(u.show){if(u.show.hasOwnProperty("menu")){n.show.menu=u.show.menu}}}Config.Containers.orderList=n.container}function a(){if(Routing.route=="purchases"){i.WidgetLoader(false);i.BaseLoad.Login(false,false,false,function(u){if(!u.err){i.BaseLoad.Tmpl(n.tmpl,function(){if(n.show.menu){l()}e()})}else{Parameters.cache.lastPage={route:"default"};p("login","Авторизация пользователя",{});i.WidgetLoader(true)}})}else{i.WidgetLoader(true)}}function h(){i.AddEvent("w.change.route",function(){a()});i.AddEvent("LOrder.repeat",function(u){i.BaseLoad.RepeatOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.repeat",u)})){i.ShowMessage(n.message.orderRepeat,function(){Parameters.cache.orderList={};i.DispatchEvent("LOrder.edit",{id:v.id})},false)}})});i.AddEvent("LOrder.return",function(u){i.BaseLoad.ReturnOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.return",u)})){i.ShowMessage(n.message.orderReturn,function(){Parameters.cache.orderList={};p("cart","Моя корзина")},false)}})});i.AddEvent("LOrder.cancel",function(u){i.Confirm(n.message.confirmCancelOrder,function(){i.BaseLoad.CancelOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.cancel",u)})){i.ShowMessage(n.message.orderCancel,function(){Parameters.cache.orderList={};u.fn()},false)}})})});i.AddEvent("LOrder.check",function(u){i.BaseLoad.ConfirmOrder(u.id,function(v){if(v.err){i.ShowMessage(v.msg,function(){if(v.err=="Not defined Payment Method"){p(j,t,{step:2,id:u.id})}else{p(j,t,{step:4,id:u.id})}})}else{i.ShowMessage(n.message.orderConfirm,function(){Parameters.cache.orderList={};u.fn()})}})});i.AddEvent("LOrder.delete",function(u){i.Confirm(n.confirmDeleteOrder,function(){i.BaseLoad.DeleteOrder(u.id,function(v){if(i.QueryError(v,function(){i.DispatchEvent("LOrder.delete",u)})){i.ShowMessage(n.message.orderDelete,function(){Parameters.cache.orderList={};u.fn()},false)}})})});i.AddEvent("LOrder.edit",function(u){p(j,t,{step:2,id:u.id})});i.AddEvent("LOrder.pay",function(u){})}function e(){i.WidgetLoader(false);if(Routing.params.block=="list"){i.currentPage=Routing.GetCurrentPage();c()}else{if(Routing.params.block=="detail"&&Routing.params.id){i.BaseLoad.Script(PokupoWidgets.model.order,function(){s(Routing.params.id)})}}}function l(){i.BaseLoad.Script(PokupoWidgets.model.menu,function(){i.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function m(){i.ClearContainer(n)}function q(){i.InsertContainer(n,"list")}function b(){i.InsertContainer(n,"detail")}function g(){i.InsertContainer(n,"empty")}function c(){var v=Routing.GetCurrentPage()*Config.Paging.itemsPerPage-Config.Paging.itemsPerPage;var u="/"+v+"/"+Config.Paging.itemsPerPage;i.BaseLoad.OrderList(u,function(x){if(!x.err){q();var w=new OrderListViewModel();w.AddContent(x);o(w)}else{g();d()}})}function s(u){i.BaseLoad.OrderInfo(u+"/yes",function(x){if(!x.err){if(x.goods.length>0){b();var v=Parameters.cache.order.info,y="purchases",w="Мои покупки";if($.isEmptyObject(v)){OrderViewModel.prototype.Back=function(){p(y,w,{block:"list",page:Routing.GetLastPageNumber()})};OrderViewModel.prototype.ClickEdit=function(){i.DispatchEvent("LOrder.edit",{id:u})};OrderViewModel.prototype.ClickDelete=function(){i.DispatchEvent("LOrder.delete",{id:u,fn:function(){p(y,w,{block:"list",page:1})}})};OrderViewModel.prototype.ClickCancel=function(){i.DispatchEvent("LOrder.cancel",{id:u,fn:function(){p(y,w,{block:"list",page:1})}})};OrderViewModel.prototype.ClickPay=function(){i.DispatchEvent("LOrder.pay",{id:u,fn:function(){}})};OrderViewModel.prototype.ClickCheck=function(){i.DispatchEvent("LOrder.check",{id:u,fn:function(){p(y,w,{block:"detail",id:Routing.params.id})}})};OrderViewModel.prototype.ClickRepeat=function(){i.DispatchEvent("LOrder.repeat",{id:u})};OrderViewModel.prototype.ClickReturn=function(){i.DispatchEvent("LOrder.return",{id:u})};v=new OrderViewModel(n);Parameters.cache.order.info=v}v.AddContent(x);k(v)}}else{i.WidgetLoader(true,n.container.widget);i.ShowMessage(x.msg,function(){p("purchases","Мои покупки",{block:"list",page:1})})}})}function o(u){i.RenderTemplate(u,n,null,function(v){q();o(v)},function(){m()},"list")}function d(){i.WidgetLoader(true,n.container.widget);if(n.animate){n.animate()}}function k(u){i.RenderTemplate(u,n,null,function(v){b();k(v)},function(){m()},"detail")}function p(u,w,v){Routing.SetHash(u,w,v)}};var OrderListViewModel=function(){var a=this;a.list=ko.observableArray();a.paging=ko.observableArray();a.count=0;a.AddContent=function(b){a.list=ko.observableArray();$.each(b,function(c){if(c=="count_order"){a.count=b[c]}else{a.list.push(new OrderListDetailViewModel(b[c]))}});a.AddPages()};a.AddPages=function(){var b=function(){Loader.Indicator("OrderListWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.count,{paging:Config.Paging},b)};a.ClickRefresh=function(){Parameters.cache.orderList={};Routing.SetHash("purchases","Мои покупки",{block:"list"})}};var OrderListDetailViewModel=function(f){var c=this,e="purchases",g="Мои покупки";c.id=f.id;c.cssFloatPopup="order_item";c.dateCreate=f.date_create;c.commentBuyer=f.comment_buyer;c.commentOperator=f.comment_operator;c.nameShop=f.name_shop;c.costShipping=f.cost_shipping;c.costPayment=f.cost_payment;c.sellCost=f.sell_cost;c.finalCost=f.final_cost;c.GetNamePay=function(h){if(h=="wait_check"){return"На проверке"}if(h=="wait_pay"){return"Ожидает оплаты"}if(h=="paid"){return"Оплачен"}if(h=="cancel"){return"Отменена"}if(h=="back"){return"Возвращена"}return false};c.GetNameOrder=function(h){if(h=="init"){return"Формируется"}if(h=="new"){return"Новый"}if(h=="process"){return"В просессе обработки"}if(h=="send"){return"Отправлен"}if(h=="delivered"){return"Получен покупателем"}if(h=="cancel"){return"Отменен"}return false};c.statusPay=f.status_pay;c.statusPayName=c.GetNamePay(f.status_pay);c.statusOrder=f.status_order;c.statusOrderName=c.GetNameOrder(f.status_order);c.viewShow=ko.computed(function(){return true},this);c.ClickShow=function(){a(e,g,{block:"detail",id:c.id})};c.viewEdit=ko.computed(function(){var h=f.status_order;if(h=="init"){return true}return false},this);c.ClickEdit=function(){d("LOrder.edit",{id:c.id})};c.viewRepeat=ko.computed(function(){var h=f.status_order;if(h=="delivered"||h=="send"||h=="cancel"){return true}return false},this);c.ClickRepeat=function(){d("LOrder.repeat",{id:c.id})};c.viewReturn=ko.computed(function(){var h=f.status_order;if(h=="delivered"||h=="send"||h=="cancel"){return true}return false},this);c.ClickReturn=function(){d("LOrder.return",{id:c.id,fn:function(){a(e,g,{id:c.id})}})};c.viewCanсel=ko.computed(function(){var h=f.status_order;if((h=="init"||h=="new")&&f.status_pay!="paid"){return true}return false},this);c.ClickCancel=function(){d("LOrder.cancel",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewDelete=ko.computed(function(){var h=f.status_order;if(h=="init"||h=="cancel"){return true}return false},this);c.ClickDelete=function(){d("LOrder.delete",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewCheck=ko.computed(function(){var h=f.status_order;if(h=="init"){return true}return false},this);c.ClickCheck=function(){d("LOrder.check",{id:c.id,fn:function(){a(e,g,{block:"list",page:Routing.GetCurrentPage()})}})};c.viewPay=ko.computed(function(){var h=f.status_order;if(h=="new"){return true}return false},this);c.ClickPay=function(){d("LOrder.pay",{id:c.id,fn:function(){}})};c.emptyTd=ko.observableArray();function b(){var j=0;if(c.viewShow()){j++}if(c.viewEdit()){j++}if(c.viewRepeat()){j++}if(c.viewReturn()){j++}if(c.viewCanсel()){j++}if(c.viewDelete()){j++}for(var h=1;h<=5-j;h++){c.emptyTd.push({id:h})}}function d(h,i){EventDispatcher.DispatchEvent(h,i)}function a(h,j,i){Routing.SetHash(h,j,i)}b()};var TestOrderList={Init:function(){if(typeof Widget=="function"){OrderListWidget.prototype=new Widget();var a=new OrderListWidget();a.Init(a)}else{setTimeout(function(){TestOrderList.Init()},100)}}};TestOrderList.Init();