var CartGoodsWidget=function(){var m=this;m.widgetName="CartGoodsWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.cart=null;m.InitWidget=e;var d={container:{widget:"content",def:"defaultCartGoodsWidgetId"},tmpl:{path:"cartGoodsTmpl.html",id:{content:"cartGoodsTmpl",empty:"emptyCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},showBlocks:[],animate:typeof AnimateCartGoods=="function"?AnimateCartGoods:null};function e(){k();b();i()}function b(){var n=m.GetInputParameters("cartGoods");if(!$.isEmptyObject(n)){d=m.UpdateSettings1(d,n)}Config.Containers.cartGoods=d.container}function i(){if(Routing.route=="cart"){m.BaseLoad.Tmpl(d.tmpl,function(){h()})}else{m.WidgetLoader(true)}}function k(){m.AddEvent("w.change.route",function(){i()});m.AddEvent("CartGoods.onload.info",function(n){if(!n.err){c();l.Content(n)}else{g();j()}});m.AddEvent("CartGoods.change.count",function(n){m.BaseLoad.AddGoodsToCart(n.id,n.sellerId,n.ordered(),function(o){m.DispatchEvent("widgets.cart.infoUpdate",o);n.sellCost(o.sell_cost);n.sellEndCost(o.sell_end_cost)})});m.AddEvent("CartGoods.clear",function(o){var n=o.goodsId?o.goodsId:false;m.BaseLoad.ClearCart(o.sellerId,n,function(p){m.DispatchEvent("widgets.cart.infoUpdate",p)})});m.AddEvent("CartGoods.empty.cart",function(){g();j()})}function h(){m.WidgetLoader(false);m.BaseLoad.InfoFavorite("no",function(n){Parameters.cache.favorite=n;m.BaseLoad.CartGoods("",function(o){m.DispatchEvent("CartGoods.onload.info",o)})})}function a(){m.ClearContainer(d)}function c(){m.InsertContainer(d,"content")}function g(){m.InsertContainer(d,"empty")}var l={Content:function(q){var p=new CartGoodsViewModel(d);for(var n in q){BlockGoodsForSellerViewModel.prototype=new Widget();m.cart=new BlockGoodsForSellerViewModel(p,d);for(var o in q[n]){if(typeof l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()]=="function"){l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()](q[n][o])}}p.AddContent(m.cart)}f(p)},Goods:function(n){m.cart.AddContent(n)},Seller:function(n){m.cart.sellerInfo.seller=n},Shop:function(n){m.cart.sellerInfo.shop=n},Operator:function(n){m.cart.sellerInfo.operator=n},Final_cost:function(n){m.cart.finalCost=n}};function f(n){m.RenderTemplate(n,d,null,function(o){c();f(o)},function(){a()},"content")}function j(){m.WidgetLoader(true);if(d.animate){d.animate()}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockGoodsForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].endSum())}}return f.toFixed(2)},this);a.totalSum=ko.computed(function(){var f=0;if(a.goods().length>0){for(var e=0;e<=a.goods().length-1;e++){f=f+parseFloat(a.goods()[e].sum())}}return f.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.AddContent=function(f){for(var e=0;e<=f.length-1;e++){BlockCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCartGoodsSellersViewModel(f[e],a,d,c))}a.finalCost=f.final_cost};a.comment=ko.observable();a.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(a.goods(),function(f){if(f.isSelected()){e.push(f.id);f.IsFavorite(true)}});a.AddCommentForm(e)};a.AddCommentForm=function(e){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){var f=[];$.each(e,function(g){f[g]=e[g].id});b("w.fav.add",{goodsId:f.join(","),comment:a.comment(),data:e});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}for(var g in f){a.goods.remove(f[g])}b("CartGoods.clear",{goodsId:e.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){d.sellerBlock.remove(a)}if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){var e=Parameters.cache.lastPage;if(e.route!="cart"){Routing.SetHash(e.route,e.title,e.data)}else{Routing.SetHash("default","Домашняя",{})}};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation==null||(Parameters.cache.userInformation!=null&&Parameters.cache.userInformation.err)){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(c.message.confirmClearCart,function(){var g=a.goods().length-1;var e=[];for(var f=0;f<=g;f++){e.push(a.goods()[f])}for(var f in e){a.goods.remove(e[f])}d.sellerBlock.remove(a);b("CartGoods.clear",{sellerId:a.sellerInfo.shop.id});if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}})};a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods())[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(h){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(i){$("#"+i.cssCheckboxGoods())[0].checked=g;i.isSelected(g)})};a.isDisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return false}return true},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockCartGoodsSellersViewModel=function(f,h,d,c){var a=this;a.sellerId=h.sellerInfo.seller.id;a.id=f.id;a.fullName=f.full_name;a.countReserv=f.count_reserv;a.count=f.count;a.sellCost=ko.observable(f.sell_cost);a.sellEndCost=ko.observable(f.sell_end_cost);a.routeImages=f.route_image;a.routeBigImages=f.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isEgoods=ko.computed(function(){if(f.is_egoods=="yes"){return true}return false},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(k){var j=h.goods().length;var m=[];for(var l=0;l<=j-1;l++){if(h.goods()[l].isSelected()){m.push(h.goods()[l].id)}}if(m.length<j){$("#"+h.cssSelectAll)[0].checked=false}else{$("#"+h.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(i,k){var j=$("#"+i.cssCheckboxGoods());var l=j.is(":checked");if(l==false){j[0].checked=true;a.isSelected(true)}else{j[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var i=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(i>0){return i+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);b("CartGoods.change.count",a)}else{a.ShowMessage(c.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);b("CartGoods.change.count",a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(c.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){b("CartGoods.clear",{goodsId:a.id,sellerId:a.sellerId});g()};a.AddCommentForm=function(){h.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){b("w.fav.add",{goodsId:a.id,comment:h.comment(),data:a});a.IsFavorite(true);$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}function g(){h.goods.remove(a);if(h.goods().length==0){d.sellerBlock.remove(h);if(d.sellerBlock().length==0){b("CartGoods.empty.cart")}}}e("CartGoods.clear.cartInfo."+a.sellerId+"."+a.id,function(){g()});e("CartGoods.change.cartInfo."+a.sellerId+"."+a.id,function(i){a.ordered(i)});function e(i,j){EventDispatcher.AddEventListener(i,j)}function b(i,j){EventDispatcher.DispatchEvent(i,j)}};var TestCartGoods={Init:function(){if(typeof Widget=="function"){CartGoodsWidget.prototype=new Widget();var a=new CartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCartGoods.Init()},100)}}};TestCartGoods.Init();