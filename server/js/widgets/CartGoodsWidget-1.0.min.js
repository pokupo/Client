var CartGoodsWidget=function(){function e(){n(),o(),t()}function o(){var e=l.GetInputParameters("cartGoods");$.isEmptyObject(e)||(u=l.UpdateSettings1(u,e)),Config.CartGoods=u}function t(){"cart"==Routing.route?l.BaseLoad.Tmpl(u.tmpl,function(){r()}):l.WidgetLoader(!0)}function n(){l.AddEvent("w.change.route",function(){t()}),l.AddEvent("CartGoods.onload.info",function(e){e.err?(i(),c()):(a(),f.Content(e))}),l.AddEvent("CartGoods.change.count",function(e){l.BaseLoad.AddGoodsToCart(e.id,e.sellerId,e.ordered(),function(o){l.DispatchEvent("widgets.cart.infoUpdate",o),e.sellCost(o.sell_cost),e.sellEndCost(o.sell_end_cost)})}),l.AddEvent("CartGoods.clear",function(e){var o=e.goodsId?e.goodsId:!1;l.BaseLoad.ClearCart(e.sellerId,o,function(e){l.DispatchEvent("widgets.cart.infoUpdate",e)})}),l.AddEvent("CartGoods.empty.cart",function(){i(),c()})}function r(){l.WidgetLoader(!1),l.BaseLoad.InfoFavorite("no",function(e){Parameters.cache.favorite=e,l.BaseLoad.CartGoods("",function(e){l.DispatchEvent("CartGoods.onload.info",e)})})}function s(){l.ClearContainer(u)}function a(){l.InsertContainer(u,"content")}function i(){l.InsertContainer(u,"empty")}function d(e){l.RenderTemplate(e,u,null,function(e){a(),d(e)},function(){s()},"content")}function c(){l.WidgetLoader(!0),u.animate&&u.animate()}var l=this;l.widgetName="CartGoodsWidget",l.version=1,l.minWidgetVersion=1,l.maxWidgetVersion=2,l.minTmplVersion=1,l.maxTmplVersion=2,l.cart=null,l.InitWidget=e;var u={container:{widget:"content",def:"defaultCartGoodsWidgetId"},tmpl:{path:"cartGoodsTmpl.html",id:{content:"cartGoodsTmpl",empty:"emptyCartGoodsTmpl"}},message:{title:"Моя корзина",addFavorites:"Выбранные товары добавлены в избранное.",failAddFavorites:"Произошла ошибка при добавлении товара в избранное. Попробуйте еще раз.",confirmRemove:"Вы уверены, что хотите удалить товар из корзины?",confirmClearCart:"Вы уверены, что хотите очистить корзину?",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из корзины?",maxIsReached:"Достигнут максимум",pleaseLogIn:"Необходимо авторизоваться."},showBlocks:[],animate:"function"==typeof AnimateCartGoods?AnimateCartGoods:null},f={Content:function(e){var o=new CartGoodsViewModel;for(var t in e){BlockGoodsForSellerViewModel.prototype=new Widget,l.cart=new BlockGoodsForSellerViewModel(o,u);for(var n in e[t])"function"==typeof f[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()]&&f[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()](e[t][n]);o.AddContent(l.cart)}d(o)},Goods:function(e){l.cart.AddContent(e)},Seller:function(e){l.cart.sellerInfo.seller=e},Shop:function(e){l.cart.sellerInfo.shop=e},Operator:function(e){l.cart.sellerInfo.operator=e},Final_cost:function(e){l.cart.finalCost=e}}},CartGoodsViewModel=function(){var e=this;e.sellerBlock=ko.observableArray(),e.AddContent=function(o){e.sellerBlock.push(o)}},BlockGoodsForSellerViewModel=function(e,o){function t(e,o){EventDispatcher.DispatchEvent(e,o)}var n=this;n.sellerInfo={},n.goods=ko.observableArray(),n.finalCost=0,n.tatalForPayment=ko.computed(function(){var e=0;if(n.goods().length>0)for(var o=0;o<=n.goods().length-1;o++)e+=parseFloat(n.goods()[o].endSum());return e.toFixed(2)},this),n.totalSum=ko.computed(function(){var e=0;if(n.goods().length>0)for(var o=0;o<=n.goods().length-1;o++)e+=parseFloat(n.goods()[o].sum());return e.toFixed(2)},this),n.tatalDiscount=ko.computed(function(){return(n.totalSum()-n.tatalForPayment()).toFixed(2)},this),n.uniq=EventDispatcher.HashCode((new Date).getTime().toString()),n.AddContent=function(t){for(var r=0;r<=t.length-1;r++)BlockCartGoodsSellersViewModel.prototype=new Widget,n.goods.push(new BlockCartGoodsSellersViewModel(t[r],n,e,o));n.finalCost=t.final_cost},n.comment=ko.observable(),n.ClickButchFavorites=function(){var e=[];ko.utils.arrayForEach(n.goods(),function(o){o.isSelected()&&(e.push(o.id),o.IsFavorite(!0))}),n.AddCommentForm(e)},n.AddCommentForm=function(e){n.comment(" "),$("#dialog-form-batch").dialog({height:300,width:396,modal:!0,buttons:{"Сохранить":function(){var o=[];$.each(e,function(t){o[t]=e[t].id}),t("w.fav.add",{goodsId:o.join(","),comment:n.comment(),data:e}),$(this).dialog("close")}}})},n.ClickButchRemove=function(){n.Confirm(o.message.confirmButchRemove,function(){n.Remove()})},n.Remove=function(){for(var o=[],r=[],s=n.goods().length-1,a=0;s>=a;a++)n.goods()[a].isSelected()&&(o.push(n.goods()[a].id),r.push(n.goods()[a]));for(var a in r)n.goods.remove(r[a]);t("CartGoods.clear",{goodsId:o.join(","),sellerId:n.sellerInfo.shop.id}),0==n.goods().length&&e.sellerBlock.remove(n),0==e.sellerBlock().length&&t("CartGoods.empty.cart")},n.IsFavorite=function(){},n.ClickProceed=function(){var e=Parameters.cache.lastPage;"cart"!=e.route?Routing.SetHash(e.route,e.title,e.data):Routing.SetHash("default","Домашняя",{})},n.ClickIssueOrder=function(){null==Parameters.cache.userInformation||null!=Parameters.cache.userInformation&&Parameters.cache.userInformation.err?(Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:n.sellerInfo.shop.id}},Routing.SetHash("login","Авторизация пользователя",{})):Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:n.sellerInfo.shop.id})},n.ClickClearCurt=function(){n.Confirm(o.message.confirmClearCart,function(){for(var o=n.goods().length-1,r=[],s=0;o>=s;s++)r.push(n.goods()[s]);for(var s in r)n.goods.remove(r[s]);e.sellerBlock.remove(n),t("CartGoods.clear",{sellerId:n.sellerInfo.shop.id}),0==e.sellerBlock().length&&t("CartGoods.empty.cart")})},n.cssSelectAll="cartGoodsSelectAll_"+n.uniq,n.isSelectedAll=ko.observable(!1),n.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods())[0].checked=e,o.isSelected(e)})}),n.ClickSelectAll=function(){var e,o=$("#"+n.cssSelectAll),t=o.is(":checked");t?(o[0].checked=!1,e=!1):(o[0].checked=!0,e=!0),ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods())[0].checked=e,o.isSelected(e)})},n.isDisabledButton=ko.computed(function(){for(var e=n.goods().length,o=[],t=0;e-1>=t;t++)n.goods()[t].isSelected()&&o.push(n.goods()[t].id);return o.length>0?!1:!0},this)},BlockCartGoodsSellersViewModel=function(e,o,t,n){function r(){o.goods.remove(i),0==o.goods().length&&(t.sellerBlock.remove(o),0==t.sellerBlock().length&&a("CartGoods.empty.cart"))}function s(e,o){EventDispatcher.AddEventListener(e,o)}function a(e,o){EventDispatcher.DispatchEvent(e,o)}var i=this;i.sellerId=o.sellerInfo.seller.id,i.id=e.id,i.fullName=e.full_name,i.countReserv=e.count_reserv,i.count=e.count,i.sellCost=ko.observable(e.sell_cost),i.sellEndCost=ko.observable(e.sell_end_cost),i.routeImages=e.route_image,i.routeBigImages=e.route_big_image,i.ordered=ko.observable(i.count),i.sum=ko.computed(function(){return(i.ordered()*i.sellCost()).toFixed(2)},this),i.endSum=ko.computed(function(){return(i.ordered()*i.sellEndCost()).toFixed(2)},this),i.isEgoods=ko.computed(function(){return"yes"==e.is_egoods?!0:!1},this),i.isSelected=ko.observable(!1),i.isSelected.subscribe(function(){for(var e=o.goods().length,t=[],n=0;e-1>=n;n++)o.goods()[n].isSelected()&&t.push(o.goods()[n].id);$("#"+o.cssSelectAll)[0].checked=t.length<e?!1:!0}),i.cssCheckboxGoods=ko.observable("goods_"+i.id),i.ClickOrder=function(e){var o=$("#"+e.cssCheckboxGoods()),t=o.is(":checked");0==t?(o[0].checked=!0,i.isSelected(!0)):(o[0].checked=!1,i.isSelected(!1))},i.discount=ko.computed(function(){var e=100-Math.floor(100*i.sellEndCost()/i.sellCost());return e>0?e+"%":0},this),i.comment=ko.observable(),i.ClickPlus=function(){i.ordered()<i.countReserv?(i.ordered(i.ordered()+1),a("CartGoods.change.count",i)):i.ShowMessage(n.message.maxIsReached,!1,!1)},i.ClickMinus=function(){i.ordered()>0&&(i.ordered(i.ordered()-1),a("CartGoods.change.count",i))},i.ClickGoods=function(){Routing.SetHash("goods",i.fullName,{id:i.id})},i.AddFavorites=function(){null==Parameters.cache.userInformation||Parameters.cache.userInformation.err?i.ShowMessage(n.message.pleaseLogIn,!1,!1):i.AddCommentForm()},i.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})},i.ClickRemove=function(){i.Confirm(n.message.confirmRemove,function(){i.Remove()})},i.Remove=function(){a("CartGoods.clear",{goodsId:i.id,sellerId:i.sellerId}),r()},i.AddCommentForm=function(){o.comment(" "),$("#dialog-form-batch").dialog({height:300,width:396,modal:!0,buttons:{"Сохранить":function(){a("w.fav.add",{goodsId:i.id,comment:o.comment(),data:i}),i.IsFavorite(!0),$(this).dialog("close")}}})},i.IsFavorite=ko.observable(),i.IsFavorite($.inArray(i.id,Parameters.cache.favorite)>=0?!0:!1),s("CartGoods.clear.cartInfo."+i.sellerId+"."+i.id,function(){r()}),s("CartGoods.change.cartInfo."+i.sellerId+"."+i.id,function(e){i.ordered(e)})},TestCartGoods={Init:function(){if("function"==typeof Widget){CartGoodsWidget.prototype=new Widget;var e=new CartGoodsWidget;e.Init(e)}else setTimeout(function(){TestCartGoods.Init()},100)}};TestCartGoods.Init();