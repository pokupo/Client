var StandalonePaymentWidget=function(){var o=this;o.widgetName="StandalonePaymentWidget";o.version=1;o.minWidgetVersion=1;o.maxWidgetVersion=2;o.minTmplVersion=1;o.maxTmplVersion=2;o.InitWidget=m;var u={container:{content:{widget:"content",def:"defaultStandalonePaymentWidgetId"},button:{widget:"standalonePaymentWidgetId",def:"defaultStandalonePaymentWidgetId"}},showButton:false,title:"Оплатить",tmpl:{path:"standalonePaymentTmpl.html",id:{content:"standalonePaymentPageTmpl",paymentList:"standalonePaymentListTmpl",button:"standalonePaymentButtonImpl",error:"standalonePaymentErrorTmpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов.",email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},count:{empty:"Поле обязательно для заполнения",count:"Введите количество товара"},coast:{empty:"Поле обязательно для заполнения",count:"Введите стоимость услуги",integer:"Недопустимое значение"}},regular:{email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/},animate:typeof AnimateStandalonePayment=="function"?AnimateStandalonePayment:null,containerButton:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:false,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",userParams:{},backUrl:""};function m(){g()}function w(){var z=o.GetInputParameters("standalonePayment");if(!$.isEmptyObject(z)){u=o.UpdateSettings1(u,z);var y=Routing.params;if(z.title){u.title=z.title}if(z.idGoods){u.idGoods=z.idGoods;u.showAmount=false}else{if(y.idGoods){u.idGoods=y.idGoods;u.showAmount=false}else{u.idShop=JSSettings.shopId}}if(z.count){u.count=z.count;u.showCount=false}else{if(y.count){u.count=y.count;u.showCount=false}}if(z.amount){u.amount=z.amount;u.showAmount=false}else{if(y.amount){u.amount=y.amount;u.showAmount=false}else{if(!u.idGoods){u.showAmount=true}}}if(z.uid){u.uid=z.uid}if(y.uid){u.uid=y.uid}if(z.idShopPartner){u.idShopPartner=z.idShopPartner}if(y.idShopPartner){u.idShopPartner=y.idShopPartner}if(z.mailUser){u.mailUser=z.mailUser}else{if(y.mailUser){u.mailUser=y.mailUser}}if(z.idMethodPayment){u.idMethodPayment=z.idMethodPayment}if(y.idMethodPayment){u.idMethodPayment=y.idMethodPayment}if(z.description){u.description=z.description}if(y.description){u.description=y.description}if(z.backUrl){u.backUrl=z.backUrl}else{if(y.backUrl){u.backUrl=y.backUrl}}if(y.userParams){var A=decodeURIComponent(y.userParams);u.userParams=A.replace(/(^\?)/,"").split("&").map(function(B){return B=B.split("="),this[B[0]]=B[1],this}.bind({}))[0]}if(z.userParams){$.each(z.userParams,function(C,B){u.userParams[C]=B})}}Config.Containers.standalonePayment=u.container}function g(){w();n();o.BaseLoad.Tmpl(u.tmpl,function(){if(Routing.route=="standalone_payment"){if(u.idGoods!=null){o.BaseLoad.GoodsInfo(u.idGoods,"1000000",function(y){u.goodsInfo=y;if(u.idShopPartner==null){r()}if(u.idShopPartner!=null){q()}})}if(u.idShop!=null&&u.idGoods==null){j()}}else{if(u.showButton&&Routing.route!="status_payment"){i();c()}else{o.WidgetLoader(true)}}})}function n(){o.AddEvent("SPayment.payment.select",function(y){u.idMethodPayment=y.idMethodPayment();u.paymentInfo=y.paymentInfo;u.mailUser=y.mailUser();if(u.idGoods!=null){u.count=y.count();if(u.idShopPartner==null){r()}if(u.idShopPartner!=null){q()}}if(u.idShop!=null){u.amount=y.amount();j()}});o.AddEvent("SPayment.back",function(){u.idMethodPayment=null;u.mailUser=null;g()});o.AddEvent("w.change.route",function(){g()});o.AddEvent("SPayment.payment.clear",function(){u.idMethodPayment=null;u.mailUser=null;g()});o.AddEvent("SPayment.form.submit",function(z){e();var y=[];$.each(z.inData(),function(B){if(z.inData()[B].name()=="MOBILE_PHONE"){y.push(z.inData()[B].name()+"="+encodeURIComponent(z.inData()[B].value().replace(/\s/g,"").replace(/-/g,"")))}else{y.push(z.inData()[B].name()+"="+encodeURIComponent(z.inData()[B].value()))}});var A=y.join("&");if(u.idGoods!=null){if(u.idShopPartner==null){r(A)}if(u.idShopPartner!=null){q(A)}}if(u.idShop!=null){j(A)}})}function p(){var y="";var z=[];$.each(u.userParams,function(B,A){z.push(B+"="+A)});y=encodeURIComponent(encodeURIComponent(z.join("&")));return y}function h(){var z=u.idShop+"/";if(u.idShopPartner){z=z+u.idShopPartner+"/"}var y=[];if(u.amount){y.push("amount="+u.amount)}if(u.uid){y.push("uid="+u.uid)}if(u.idMethodPayment){y.push("idMethodPayment="+u.idMethodPayment)}y.push("description="+u.description);if(y.length>0){z=z+"?"+y.join("&")}o.BaseLoad.InvoicesService(z,function(A){a(A)})}function r(y){var A=u.idGoods+"/";if(u.count){A=A+u.count+"/"}var z=[];if(u.mailUser){z.push("mailUser="+u.mailUser)}if(u.idMethodPayment){z.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams!={}){z.push("userParams="+p())}if(y){z.push(y)}if(z.length>0){A=A+"?"+z.join("&")}o.BaseLoad.InvoicesGoods(A,function(B){a(B)})}function q(y){var A=u.idGoods+"/";if(u.count){A=A+u.count+"/"}if(u.idShopPartner){A=A+u.idShopPartner+"/"}var z=[];if(u.mailUser){z.push("mailUser="+u.mailUser)}if(u.idMethodPayment){z.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams!={}){z.push("userParams="+p())}if(y){z.push(y)}if(z.length>0){A=A+"?"+z.join("&")}o.BaseLoad.InvoicesPartnerGoods(A,function(B){a(B)})}function j(y){var A=u.idShop+"/";if(u.idShopPartner){A=A+u.idShopPartner+"/"}var z=[];if(u.amount){z.push("amount="+u.amount)}if(u.uid){z.push("uid="+u.uid)}if(u.mailUser){z.push("mailUser="+u.mailUser)}if(u.idMethodPayment){z.push("idMethodPayment="+u.idMethodPayment)}if(u.userParams!={}){z.push("userParams="+p())}z.push("description="+u.description);if(y){z.push(y)}if(z.length>0){A=A+"?"+z.join("&")}o.BaseLoad.InvoicesService(A,function(B){a(B)})}function s(y){$(y).empty().html("")}function i(){o.InsertContainer(u,"button",u.container.button.widget)}function x(){o.InsertContainer(u,"paymentList",u.container.content.widget)}function e(){o.InsertContainer(u,"content",u.container.content.widget)}function d(){o.InsertContainer(u,"error",u.container.content.widget)}function c(){var y=new StandaloneButtonPaymentViewModel(u);t(y)}function a(z){if(z.hasOwnProperty("err")){d();l(z)}else{if(!z.hasOwnProperty("pay_form")&&!z.hasOwnProperty("in_data")){var y=new StandalonePaymentListViewModel(u);y.error.base("");y.show.errorBase(false);if(z){$.each(z,function(A){u.paymentList=true;y.payments.push(new StandalonePaymentItemViewModel(z[A],y))})}x();k(y)}else{e();v(z)}}}function v(B){var A=new StandalonePaymentViewModel(u);var C=[];var z={};if(B.pay_form){z=B.pay_form.hidden_field}var y=null;$.each(z,function(D){C.push(z[D].name+"="+encodeURIComponent(z[D].value));if(z[D].name=="PKP_ID_ORDER"){y=z[D].value}});if(y){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+y)}else{if(C){$.cookie(Config.Base.cookie.orderId,C.join("&"))}}A.paymentInfo=u.paymentInfo;A.AddContent(B);f(A)}function l(z){var y=new StandalonePaymentErrorViewModel(z,u);b(y)}function t(y){o.RenderTemplate(y,u,null,function(z){i();t(z)},function(){s("#"+u.container.button.widget)},"button",null,"button")}function k(y){o.RenderTemplate(y,u,function(z){if(u.showAmount){$("#"+z.cssAmount).bind("textchange",function(B,A){var C=$(this).val();z.amount(C);u.amount=C;setTimeout(function(){if(C==u.amount){h()}},500)});$("#"+z.cssAmount).focus()}$("#"+z.cssCount).bind("textchange",function(B,A){z.count($(this).val())})},function(z){x()();k(z)},function(){s("#"+u.container.content.widget)},"paymentList",null,"content")}function f(y){o.RenderTemplate(y,u,function(z){$.each(z.inData(),function(A){if(z.inData()[A].mask()){$("#"+z.inData()[A].cssField()).mask(z.inData()[A].mask(),{placeholder:"_"})}})},function(z){e();f(z)},function(){s("#"+u.container.content.widget)},"content",null,"content")}function b(y){o.RenderTemplate(y,u,null,function(z){e();f(z)},function(){s("#"+u.container.content.widget)},"error",null,"content")}};var StandaloneButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{})}};var StandalonePaymentListViewModel=function(e){var d=this;d.isGoodsId=ko.observable();d.title=ko.observable();d.count=ko.observable();d.amount=ko.observable();d.formatAmount=ko.observable();d.cssAmount="pokupo_amount";d.cssCount="pokupo_count";if(e.idGoods){d.title(e.goodsInfo.main.chort_name);d.count(e.count);var g=e.count*parseFloat(e.goodsInfo.main.sell_end_cost);d.amount(g);d.isGoodsId(true)}if(e.idShop&&!e.idGoods){d.title(e.description);if(e.amount){d.amount(parseFloat(e.amount))}d.isGoodsId(false)}if(d.amount()){d.formatAmount=d.amount().toFixed(2)}d.mailUser=ko.observable();d.idMethodPayment=ko.observable(e.idMethodPayment);d.payments=ko.observableArray();d.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};d.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(e.showCount),showAmount:ko.observable(e.showAmount)};d.Cookie={Set:{UserEmail:function(h){$.cookie(Config.Base.cookie.userEmail,h)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var c="";if(e.mailUser){c=e.mailUser}else{if(d.Cookie.Get.UserEmail()){c=d.Cookie.Get.UserEmail()}}d.mailUser(c);function b(){if(!d.count()){d.error.count(e.Error.count.empty);d.show.errorCount(true);return false}if(parseInt(d.count())!=d.count()){d.error.count(e.Error.count.integer);d.show.errorCount(true);return false}d.error.count(null);d.show.errorCount(false);return true}function f(){var h=e.Error.coast;if(!d.amount()){d.error.amount(h.empty);d.show.errorAmount(true);return false}if(isNaN(d.amount())){d.error.amount(h.integer);d.show.errorAmount(true);return false}if(parseFloat(d.amount())!=d.amount()){d.error.amount(h.integer);d.show.errorAmount(true);return false}if(d.amount()<0.01){d.error.amount(h.integer);d.show.errorAmount(true);return false}d.error.amount(null);d.show.errorAmount(false);return true}function a(){var h=e.Error.email;if(!d.mailUser()){d.error.email(h.empty);d.show.errorEmail(true);return false}if(d.mailUser().length>64){d.error.email(h.maxLength);d.show.errorEmail(true);return false}if(!e.regular.email.test(d.mailUser())){d.error.email(h.regular);d.show.errorEmail(true);return false}d.error.email(null);d.show.errorEmail(false);return true}EventDispatcher.AddEventListener("SPayment.payment.validate",function(h){var i=true;if(!a()){i=false}if(!b()&&d.isGoodsId()){i=false}if(!f()&&!d.isGoodsId()){i=false}if(i){d.Cookie.Set.UserEmail(d.mailUser());h.callback()}});d.Back=function(){window.location.href=e.backUrl};d.AmountValidation=f};var StandalonePaymentItemViewModel=function(c,b){var a=this;a.id=c.id;a.namePayment=c.name_payment;a.costPayment=c.cost_payment;a.descPayment=c.desc_payment;a.instrPayment=c.instr_payment;a.logoPayment=c.logo_payment;a.timePayment=c.time_payment;a.itog=ko.computed(function(){if(b.amount()&&!b.AmountValidation()){return 0}var d=(b.amount()?parseFloat(b.amount()):0)+(a.costPayment?parseFloat(a.costPayment):0);if(d==0||isNaN(d)){return 0}else{d=d.toFixed(2);return d}},this);a.errorEmail=ko.observable();a.Click={SelectPayment:function(){b.idMethodPayment(a.id);b.paymentInfo=a;EventDispatcher.DispatchEvent("SPayment.payment.validate",{data:b,callback:function(){EventDispatcher.DispatchEvent("SPayment.payment.select",b)}})}}};var StandalonePaymentViewModel=function(c){var b=this;b.paymentInfo={};b.showPaymentInfo=false;b.instruction=ko.observable();b.cssInstruction="instructtion_print_block";b.idMethodPayment=c.idMethodPayment;b.outData=ko.observableArray();b.inData=ko.observableArray();b.isInData=ko.observable(false);b.cssInDataForm="in_data_block";b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm=ko.observable(false);b.urlInvoice=ko.observable();b.cssInvoice="invoice_print_block";b.Print=function(e){var d=window.open();d.document.write($("#"+e).html());d.print();d.close()};b.ClickPrintInstruction=function(){b.Print(b.cssInstruction)};b.ClickPrintInvoice=function(){b.Print(b.cssInvoice)};b.Back=function(){EventDispatcher.DispatchEvent("SPayment.back")};b.ClickPay=function(){$("#"+b.payForm.cssPayForm).submit()};b.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};b.ClickSubmit=function(){if(a()){EventDispatcher.DispatchEvent("SPayment.form.submit",b)}};b.AddContent=function(d){b.instruction(null);if(d.hasOwnProperty("instruction")){b.instruction(d.instruction)}b.outData=ko.observableArray();if(d.hasOwnProperty("out_data")){$.each(d.out_data,function(e){b.outData.push(d.out_data[e])})}b.isPayForm(false);b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm(false);if(d.hasOwnProperty("pay_form")){b.isPayForm(true);b.payForm.action(d.pay_form.action);b.payForm.method(d.pay_form.method);if(d.pay_form.hasOwnProperty("new_window")&&d.pay_form.new_window=="yes"){b.payForm.target("_blank")}$.each(d.pay_form.hidden_field,function(e){var f={name:"",value:""};if(d.pay_form.hidden_field[e].name){f.name=d.pay_form.hidden_field[e].name}if(d.pay_form.hidden_field[e].value){f.value=d.pay_form.hidden_field[e].value}b.payForm.field.push(f)})}b.isInData(false);b.inData=ko.observableArray();if(d.hasOwnProperty("in_data")){b.isInData(true);$.each(d.in_data,function(e){var f=new StandalonePaymentFieldViewModel(c);f.AddContent(d.in_data[e]);b.inData.push(f)})}b.urlInvoice(null);if(d.hasOwnProperty("url_invoice")){b.urlInvoice(d.url_invoice)}if(!$.isEmptyObject(b.paymentInfo)){b.showPaymentInfo=true}};function a(){var d=true;$.each(b.inData(),function(e){if(!b.inData()[e].ValidateField()){d=false;return false}});return d}};var StandalonePaymentFieldViewModel=function(b){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(c){if(c.hasOwnProperty("label")){a.label(c.label)}if(c.hasOwnProperty("help")){a.help(c.help)}if(c.hasOwnProperty("error")){a.error(c.error)}if(c.hasOwnProperty("name")){a.name(c.name);a.cssField("field_"+c.name)}if(c.hasOwnProperty("value")){a.value(c.value)}if(c.hasOwnProperty("required")){if(c.required=="yes"){a.required(true)}}if(c.hasOwnProperty("type_field")){a.typeField(c.type_field)}if(c.hasOwnProperty("list_select")){$.each(c.list_select,function(d){a.listSelect.push(c.list_select[d])})}if(c.hasOwnProperty("reg_exp")){a.regExp(c.reg_exp)}if(c.hasOwnProperty("mask")){a.mask(c.mask)}if(c.hasOwnProperty("maxlength")){a.maxlength(c.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(b.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(b.Error.maxlength.replace("%s%",a.maxlength()));return false}}if(a.regExp()){var c=new RegExp(a.regExp(),"i");if(!c.test(a.value())){a.error(b.Error.regExp);return false}}return true}};var StandalonePaymentErrorViewModel=function(c,b){var a=this;a.code=c.err;a.message=c.msg;a.hasPaymentList=b.paymentList;a.ClickClearPayment=function(){EventDispatcher.DispatchEvent("SPayment.payment.clear")};a.ClickBack=function(){}};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var a=new StandalonePaymentWidget();a.Init(a)}else{setTimeout(function(){TestStandalonePayment.Init()},100)}}};TestStandalonePayment.Init();