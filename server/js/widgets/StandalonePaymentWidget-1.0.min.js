var StandalonePaymentWidget=function(){function e(){t()}function n(){var e=w.GetInputParameters("standalonePayment");if(!$.isEmptyObject(e)){I=w.UpdateSettings1(I,e);var n=Routing.params;if(e.title&&(I.title=e.title),e.idGoods?(I.idGoods=e.idGoods,I.showAmount=!1):n.idGoods?(I.idGoods=n.idGoods,I.showAmount=!1):I.idShop=JSSettings.shopId,e.count?(I.count=e.count,I.showCount=!1):n.count&&(I.count=n.count,I.showCount=!1),e.amount?(I.amount=e.amount,I.showAmount=!1):n.amount?(I.amount=n.amount,I.showAmount=!1):I.idGoods||(I.showAmount=!0),e.uid&&(I.uid=e.uid),n.uid&&(I.uid=n.uid),e.idShopPartner&&(I.idShopPartner=e.idShopPartner),n.idShopPartner&&(I.idShopPartner=n.idShopPartner),e.mailUser?I.mailUser=e.mailUser:n.mailUser&&(I.mailUser=n.mailUser),e.idMethodPayment&&(I.idMethodPayment=e.idMethodPayment),n.idMethodPayment&&(I.idMethodPayment=n.idMethodPayment),e.description&&(I.description=e.description),n.description&&(I.description=n.description),e.backUrl?I.backUrl=e.backUrl:n.backUrl&&(I.backUrl=n.backUrl),n.userParams){var t=decodeURIComponent(n.userParams);I.userParams=t.replace(/(^\?)/,"").split("&").map(function(e){return e=e.split("="),this[e[0]]=e[1],this}.bind({}))[0]}e.userParams&&$.each(e.userParams,function(e,n){I.userParams[e]=n})}Config.StandalonePayment=I}function t(){n(),o(),w.BaseLoad.Tmpl(I.tmpl,function(){"standalone_payment"==Routing.route?(null!=I.idGoods&&w.BaseLoad.GoodsInfo(I.idGoods,"1000000",function(e){I.goodsInfo=e,null==I.idShopPartner&&i(),null!=I.idShopPartner&&s()}),null!=I.idShop&&null==I.idGoods&&u()):I.showButton&&"status_payment"!=Routing.route?(w.InsertContainer.Button(),h()):w.WidgetLoader(!0)})}function o(){w.AddEvent("SPayment.payment.select",function(e){I.idMethodPayment=e.idMethodPayment(),I.paymentInfo=e.paymentInfo,I.mailUser=e.mailUser(),null!=I.idGoods&&(I.count=e.count(),null==I.idShopPartner&&i(),null!=I.idShopPartner&&s()),null!=I.idShop&&(I.amount=e.amount(),u())}),w.AddEvent("SPayment.back",function(){I.idMethodPayment=null,I.mailUser=null,t()}),w.AddEvent("w.change.route",function(){t()}),w.AddEvent("SPayment.payment.clear",function(){I.idMethodPayment=null,I.mailUser=null,t()}),w.AddEvent("SPayment.form.submit",function(e){w.InsertContainer.Content();var n=[];$.each(e.inData(),function(t){n.push("MOBILE_PHONE"==e.inData()[t].name()?e.inData()[t].name()+"="+encodeURIComponent(e.inData()[t].value().replace(/\s/g,"").replace(/-/g,"")):e.inData()[t].name()+"="+encodeURIComponent(e.inData()[t].value()))});var t=n.join("&");Routing.params.orderId&&(t=Routing.params.orderId+"?"+t,GetDataOrder(t)),Routing.params.goodsId&&(t=Routing.params.goodsId+"?"+t,i(t)),Routing.params.amount&&(t=Routing.params.amount+"/"+Parameters.shopId+"?"+t,w.GetData.Amount(t))})}function a(){var e="",n=[];return $.each(I.userParams,function(e,t){n.push(e+"="+t)}),e=encodeURIComponent(encodeURIComponent(n.join("&")))}function r(){var e=I.idShop+"/";I.idShopPartner&&(e=e+I.idShopPartner+"/");var n=[];I.amount&&n.push("amount="+I.amount),I.uid&&n.push("uid="+I.uid),I.idMethodPayment&&n.push("idMethodPayment="+I.idMethodPayment),n.push("description="+I.description),n.length>0&&(e=e+"?"+n.join("&")),w.BaseLoad.InvoicesService(e,function(e){y(e)})}function i(){var e=I.idGoods+"/";I.count&&(e=e+I.count+"/");var n=[];I.mailUser&&n.push("mailUser="+I.mailUser),I.idMethodPayment&&n.push("idMethodPayment="+I.idMethodPayment),I.userParams&&n.push("userParams="+a()),n.length>0&&(e=e+"?"+n.join("&")),w.BaseLoad.InvoicesGoods(e,function(e){y(e)})}function s(){var e=I.idGoods+"/";I.count&&(e=e+I.count+"/"),I.idShopPartner&&(e=e+I.idShopPartner+"/");var n=[];I.mailUser&&n.push("mailUser="+I.mailUser),I.idMethodPayment&&n.push("idMethodPayment="+I.idMethodPayment),I.userParams&&n.push("userParams="+a()),n.length>0&&(e=e+"?"+n.join("&")),w.BaseLoad.InvoicesPartnerGoods(e,function(e){y(e)})}function u(){var e=I.idShop+"/";I.idShopPartner&&(e=e+I.idShopPartner+"/");var n=[];I.amount&&n.push("amount="+I.amount),I.uid&&n.push("uid="+I.uid),I.mailUser&&n.push("mailUser="+I.mailUser),I.idMethodPayment&&n.push("idMethodPayment="+I.idMethodPayment),I.userParams&&n.push("userParams="+a()),n.push("description="+I.description),n.length>0&&(e=e+"?"+n.join("&")),w.BaseLoad.InvoicesService(e,function(e){y(e)})}function l(e){$(e).empty().html("")}function m(){w.InsertContainer(I,"button",I.container.button.widget)}function d(){w.InsertContainer(I,"paymentList",I.container.content.widget)}function c(){w.InsertContainer(I,"content",I.container.content.widget)}function p(){w.InsertContainer(I,"error",I.container.content.widget)}function h(){var e=new StandaloneButtonPaymentViewModel(I);v(e)}function y(e){if(e.hasOwnProperty("err"))p(),P(e);else if(e.hasOwnProperty("pay_form"))c(),f(e);else{var n=new StandalonePaymentListViewModel(I);n.error.base(""),n.show.errorBase(!1),e&&$.each(e,function(t){I.paymentList=!0,n.payments.push(new StandalonePaymentItemViewModel(e[t],n))}),d(),b(n)}}function f(e){var n=new StandalonePaymentViewModel(I),t=[],o={};e.pay_form&&(o=e.pay_form.hidden_field);var a=null;$.each(o,function(e){t.push(o[e].name+"="+encodeURIComponent(o[e].value)),"PKP_ID_ORDER"==o[e].name&&(a=o[e].value)}),a?$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+a):t&&$.cookie(Config.Base.cookie.orderId,t.join("&")),n.paymentInfo=I.paymentInfo,n.AddContent(e),g(n)}function P(e){var n=new StandalonePaymentErrorViewModel(e,I);k(n)}function v(e){w.RenderTemplate(e,I,null,function(e){m(),v(e)},function(){l("#"+I.container.button.widget)},"button",null,"button")}function b(e){w.RenderTemplate(e,I,function(e){I.showAmount&&($("#"+e.cssAmount).bind("textchange",function(){var n=$(this).val();e.amount(n),I.amount=n,setTimeout(function(){n==I.amount&&r()},500)}),$("#"+e.cssAmount).focus()),$("#"+e.cssCount).bind("textchange",function(){e.count($(this).val())})},function(e){d()(),b(e)},function(){l("#"+I.container.content.widget)},"paymentList",null,"content")}function g(e){w.RenderTemplate(e,I,null,function(e){c(),g(e)},function(){l("#"+I.container.content.widget)},"content",null,"content")}function k(e){w.RenderTemplate(e,I,null,function(e){c(),g(e)},function(){l("#"+I.container.content.widget)},"error",null,"content")}var w=this;w.widgetName="StandalonePaymentWidget",w.version=1,w.minWidgetVersion=1,w.maxWidgetVersion=2,w.minTmplVersion=1,w.maxTmplVersion=2,w.InitWidget=e;var I={container:{content:{widget:"content",def:"defaultStandalonePaymentWidgetId"},button:{widget:"standalonePaymentWidgetId",def:"defaultStandalonePaymentWidgetId"}},showButton:!1,title:"Оплатить",tmpl:{path:"standalonePaymentTmpl.html",id:{content:"standalonePaymentPageTmpl",paymentList:"standalonePaymentListTmpl",button:"standalonePaymentButtonImpl",error:"standalonePaymentErrorTmpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов.",email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},count:{empty:"Поле обязательно для заполнения",count:"Введите количество товара"},coast:{empty:"Поле обязательно для заполнения",count:"Введите стоимость услуги",integer:"Недопустимое значение"}},regular:{email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/},animate:"function"==typeof AnimateStandalonePayment?AnimateStandalonePayment:null,containerButton:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:!1,idShop:null,amount:null,showAmount:!0,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:!1,description:"",userParams:{},backUrl:""}},StandaloneButtonPaymentViewModel=function(e){var n=this;n.title=e.title,n.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("standalone_payment","Оплата товара",{})}},StandalonePaymentListViewModel=function(e){function n(){return a.count()?parseInt(a.count())!=a.count()?(a.error.count(e.Error.count.integer),a.show.errorCount(!0),!1):(a.error.count(null),a.show.errorCount(!1),!0):(a.error.count(e.Error.count.empty),a.show.errorCount(!0),!1)}function t(){var n=e.Error.coast;return a.amount()?isNaN(a.amount())?(a.error.amount(n.integer),a.show.errorAmount(!0),!1):parseFloat(a.amount())!=a.amount()?(a.error.amount(n.integer),a.show.errorAmount(!0),!1):a.amount()<.01?(a.error.amount(n.integer),a.show.errorAmount(!0),!1):(a.error.amount(null),a.show.errorAmount(!1),!0):(a.error.amount(n.empty),a.show.errorAmount(!0),!1)}function o(){var n=e.Error.email;return a.mailUser()?a.mailUser().length>64?(a.error.email(n.maxLength),a.show.errorEmail(!0),!1):e.regular.email.test(a.mailUser())?(a.error.email(null),a.show.errorEmail(!1),!0):(a.error.email(n.regular),a.show.errorEmail(!0),!1):(a.error.email(n.empty),a.show.errorEmail(!0),!1)}var a=this;if(a.isGoodsId=ko.observable(),a.title=ko.observable(),a.count=ko.observable(),a.amount=ko.observable(),a.formatAmount=ko.observable(),a.cssAmount="pokupo_amount",a.cssCount="pokupo_count",e.idGoods){a.title(e.goodsInfo.main.chort_name),a.count(e.count);var r=e.count*parseFloat(e.goodsInfo.main.sell_end_cost);a.amount(r),a.isGoodsId(!0)}e.idShop&&!e.idGoods&&(a.title(e.description),e.amount&&a.amount(parseFloat(e.amount)),a.isGoodsId(!1)),a.amount()&&(a.formatAmount=a.amount().toFixed(2)),a.mailUser=ko.observable(),a.idMethodPayment=ko.observable(e.idMethodPayment),a.payments=ko.observableArray(),a.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()},a.show={errorBase:ko.observable(!1),errorEmail:ko.observable(!1),errorCount:ko.observable(!1),errorAmount:ko.observable(!1),showCount:ko.observable(e.showCount),showAmount:ko.observable(e.showAmount)},a.Cookie={Set:{UserEmail:function(e){$.cookie(Config.Base.cookie.userEmail,e)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var i="";e.mailUser?i=e.mailUser:a.Cookie.Get.UserEmail()&&(i=a.Cookie.Get.UserEmail()),a.mailUser(i),EventDispatcher.AddEventListener("SPayment.payment.validate",function(e){var r=!0;o()||(r=!1),!n()&&a.isGoodsId()&&(r=!1),t()||a.isGoodsId()||(r=!1),r&&(a.Cookie.Set.UserEmail(a.mailUser()),e.callback())}),a.Back=function(){window.location.href=e.backUrl}},StandalonePaymentItemViewModel=function(e,n){var t=this;t.id=e.id,t.namePayment=e.name_payment,t.costPayment=e.cost_payment,t.descPayment=e.desc_payment,t.instrPayment=e.instr_payment,t.logoPayment=e.logo_payment,t.timePayment=e.time_payment,t.itog=ko.computed(function(){if(n.amount()&&!n.AmountValidation())return 0;var e=(n.amount()?parseFloat(n.amount()):0)+(t.costPayment?parseFloat(t.costPayment):0);return 0==e||isNaN(e)?0:e=e.toFixed(2)},this),t.errorEmail=ko.observable(),t.Click={SelectPayment:function(){n.idMethodPayment(t.id),n.paymentInfo=t,EventDispatcher.DispatchEvent("SPayment.payment.validate",{data:n,callback:function(){EventDispatcher.DispatchEvent("SPayment.payment.select",n)}})}}},StandalonePaymentViewModel=function(e){function n(){var e=!0;return $.each(t.inData(),function(n){return t.inData()[n].ValidateField()?void 0:(e=!1,!1)}),e}var t=this;t.paymentInfo={},t.showPaymentInfo=!1,t.instruction=ko.observable(),t.cssInstruction="instructtion_print_block",t.idMethodPayment=e.idMethodPayment,t.outData=ko.observableArray(),t.inData=ko.observableArray(),t.isInData=ko.observable(!1),t.cssInDataForm="in_data_block",t.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()},t.isPayForm=ko.observable(!1),t.urlInvoice=ko.observable(),t.cssInvoice="invoice_print_block",t.Print=function(e){var n=window.open();n.document.write($("#"+e).html()),n.print(),n.close()},t.ClickPrintInstruction=function(){t.Print(t.cssInstruction)},t.ClickPrintInvoice=function(){t.Print(t.cssInvoice)},t.Back=function(){EventDispatcher.DispatchEvent("SPayment.back")},t.ClickPay=function(){$("#"+t.payForm.cssPayForm).submit()},t.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,!0)},t.ClickSubmit=function(){n()&&EventDispatcher.DispatchEvent("SPayment.form.submit",t)},t.AddContent=function(n){t.instruction(null),n.hasOwnProperty("instruction")&&t.instruction(n.instruction),t.outData=ko.observableArray(),n.hasOwnProperty("out_data")&&$.each(n.out_data,function(e){t.outData.push(n.out_data[e])}),t.isPayForm(!1),t.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()},t.isPayForm(!1),n.hasOwnProperty("pay_form")&&(t.isPayForm(!0),t.payForm.action(n.pay_form.action),t.payForm.method(n.pay_form.method),n.pay_form.hasOwnProperty("new_window")&&"yes"==n.pay_form.new_window&&t.payForm.target("_blank"),$.each(n.pay_form.hidden_field,function(e){var o={name:"",value:""};n.pay_form.hidden_field[e].name&&(o.name=n.pay_form.hidden_field[e].name),n.pay_form.hidden_field[e].value&&(o.value=n.pay_form.hidden_field[e].value),t.payForm.field.push(o)})),t.isInData(!1),t.inData=ko.observableArray(),n.hasOwnProperty("in_data")&&(t.isInData(!0),$.each(n.in_data,function(o){var a=new StandalonePaymentFieldViewModel(e);a.AddContent(n.in_data[o]),t.inData.push(a)})),t.urlInvoice(null),n.hasOwnProperty("url_invoice")&&t.urlInvoice(n.url_invoice),$.isEmptyObject(t.paymentInfo)||(t.showPaymentInfo=!0)}},StandalonePaymentFieldViewModel=function(e){var n=this;n.label=ko.observable(),n.help=ko.observable(),n.error=ko.observable(),n.name=ko.observable(),n.value=ko.observable(),n.required=ko.observable(!1),n.typeField=ko.observable(),n.listSelect=ko.observableArray(),n.regExp=ko.observable(),n.mask=ko.observable(),n.maxlength=ko.observable(),n.cssField=ko.observable(),n.AddContent=function(e){e.hasOwnProperty("label")&&n.label(e.label),e.hasOwnProperty("help")&&n.help(e.help),e.hasOwnProperty("error")&&n.error(e.error),e.hasOwnProperty("name")&&(n.name(e.name),n.cssField("field_"+e.name)),e.hasOwnProperty("value")&&n.value(e.value),e.hasOwnProperty("required")&&"yes"==e.required&&n.required(!0),e.hasOwnProperty("type_field")&&n.typeField(e.type_field),e.hasOwnProperty("list_select")&&$.each(e.list_select,function(t){n.listSelect.push(e.list_select[t])}),e.hasOwnProperty("reg_exp")&&n.regExp(e.reg_exp),e.hasOwnProperty("mask")&&n.mask(e.mask),e.hasOwnProperty("maxlength")&&n.maxlength(e.maxlength)},n.ValidateField=function(){return n.required()&&!n.value()?(n.error(e.Error.required),!1):n.maxlength()&&n.value().length>n.maxlength()?(n.error(e.Error.maxlength.replace("%s%",n.maxlength())),!1):!0}},StandalonePaymentErrorViewModel=function(e,n){var t=this;t.code=e.err,t.message=e.msg,t.hasPaymentList=n.paymentList,t.ClickClearPayment=function(){EventDispatcher.DispatchEvent("SPayment.payment.clear")},t.ClickBack=function(){}},TestStandalonePayment={Init:function(){if("function"==typeof Widget){StandalonePaymentWidget.prototype=new Widget;var e=new StandalonePaymentWidget;e.Init(e)}else setTimeout(function(){TestStandalonePayment.Init()},100)}};TestStandalonePayment.Init();