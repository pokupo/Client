var UserInformationWidget=function(){var n=this;n.widgetName="UserInformationWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=h;var g={container:{widget:"userInformationWidgetId",def:"defaultUserInformationWidgetId"},tmpl:{path:"userInformationTmpl.html",id:{info:"userInformationTmpl",auth:"authorizationLinkTmpl"}},message:{confirmLogOut:"Вы действительно хотите выйти?"},showBlocks:["login"],animate:typeof AnimateUserInformation=="function"?AnimateUserInformation:null};function h(){m();c();j()}function c(){var o=n.GetInputParameters("userInformation");if(!$.isEmptyObject(o)){g=n.UpdateSettings1(g,o);if(o.show){for(var p=0;p<=o.show.length-1;p++){if($.inArray(o.show[p],g.showBlocks)<0){g.showBlocks.push(o.show[p])}}}}Config.Containers.userInformation=g.container}function j(){n.BaseLoad.Tmpl(g.tmpl,function(){n.DispatchEvent("UInfo.tmpl")})}function m(){n.AddEvent("UInfo.tmpl",function(){n.BaseLoad.Login(false,false,false,function(o){i(o)})});n.AddEvent("w.auth.ok",function(o){i(o.request)});n.AddEvent("UInfo.logout",function(){n.BaseLoad.Logout(function(o){if(o.result=="ok"||o.result=="fail"){n.BaseLoad.LogoutForProxy();Routing.SetHash("default","Домашняя",{})}})});n.AddEvent("w.change.route",function(o){n.BaseLoad.Tmpl(g.tmpl,function(){n.DispatchEvent("UInfo.tmpl")})})}function i(o){if(Routing.IsDefault()&&n.HasDefaultContent()){n.WidgetLoader(true)}else{if(!o.err){b();f(o)}else{k();e()}}}function a(){n.ClearContainer(g)}function k(){n.InsertContainer(g,"auth")}function b(){n.InsertContainer(g,"info")}function e(){var o=new UserAuthorizationBlockViewModel();l(o)}function f(o){n.BaseLoad.MessageCountUnread(function(p){Parameters.cache.message.countNewMessage(parseInt(p.count_unread_topic));UserInformationBlockViewModel.prototype=new Widget();var q=new UserInformationBlockViewModel(o,g);d(q)})}function l(o){n.RenderTemplate(o,g,null,function(p){k();l(p)},function(){a()})}function d(o){n.RenderTemplate(o,g,null,function(p){b();d(p)},function(){a()})}};var UserAuthorizationBlockViewModel=function(){var a=this;a.ClickLogin=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{})};a.ClickRegistration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("registration","Регистрация пользователя",{step:1})}};var UserInformationBlockViewModel=function(d,c){var b=this;b.email=d.email;b.login=d.login;b.phone=d.phone;b.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);b.showIcon=function(){if(!d.route_icon_user||$.inArray("icon",c.showBlocks)<0){return false}return true};b.iconUser="";if(d.route_icon_user){b.iconUser=d.route_icon_user+"?"+EventDispatcher.HashCode(EventDispatcher.GetUUID())}b.background="";b.backgroundImage="";if(b.iconUser){b.background="background: url('"+b.iconUser+"')";b.backgroundImage="background-image: url('"+b.iconUser+"')"}b.showRaiting=function(){if($.inArray("raiting",c.showBlocks)<0){return false}return true};b.ratingUser=d.rating_user;b.showProfile=function(){if($.inArray("profile",c.showBlocks)<0){return false}return true};b.ClickLogout=function(){b.Confirm(c.message.confirmLogOut,function(){Loader.Indicator("UserInformationWidget",false);EventDispatcher.DispatchEvent("UInfo.logout")},false)};b.ClickPrivateOffice=function(){a("profile","Личный кабинет",{})};b.ClickMessages=function(){a("messages","Сообщения",{})};b.ClickFavorites=function(){a("favorites","Избранное",{})};b.ClickPurchases=function(){a("purchases","Мои покупки",{block:"list"})};b.ClickProfile=function(){a("profile","Личный кабинет",{})};function a(e,g,f){Routing.SetHash(e,g,f)}};var TestUserInformation={Init:function(){if(typeof Widget=="function"){UserInformationWidget.prototype=new Widget();var a=new UserInformationWidget();a.Init(a)}else{setTimeout(function(){TestUserInformation.Init()},100)}}};TestUserInformation.Init();