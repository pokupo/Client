var RegistrationWidget=function(){var e=this;e.widgetName="RegistrationWidget",e.version=1,e.minWidgetVersion=1,e.maxWidgetVersion=2,e.minTmplVersion=1,e.maxTmplVersion=2,e.settings={containerFormId:null,tmpl:{path:null,id:{step1:null,step2:null,step3:null,step4:null}},animate:null,inputParameters:{},geoShop:0,style:null,customContainer:null},e.InitWidget=function(){e.settings.containerFormId=Config.Containers.registration.widget,e.settings.customContainer=Config.Containers.registration.customClass,e.settings.tmpl=Config.Registration.tmpl,e.settings.style=Config.Registration.style,e.SetInputParameters(),e.RegisterEvents(),e.CheckRouteRegistration(),e.SetPosition()},e.SetInputParameters=function(){var t={};if("string"==Config.Base.sourceParameters){var n=JSCore.ParserInputParameters(/RegistrationWidget/);n.registration&&(t=n.registration)}"object"==Config.Base.sourceParameters&&"undefined"!=typeof WParameters&&WParameters.registration&&(t=WParameters.registration),$.isEmptyObject(t)||(t.geoShop&&(e.settings.geoShop=t.geoShop),t.animate&&(e.settings.animate=t.animate)),e.settings.inputParameters=t},e.CheckRouteRegistration=function(){"registration"==Routing.route?e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.BaseLoad.Script(PokupoWidgets.model.registration,function(){1==Routing.params.step&&e.Step.Step1(),2==Routing.params.step&&e.Step.Step2(),3==Routing.params.step&&e.Step.Step3(),4==Routing.params.step&&e.Step.Step4()})}):e.WidgetLoader(!0)},e.RegisterEvents=function(){EventDispatcher.AddEventListener("w.change.route",function(){e.CheckRouteRegistration()}),EventDispatcher.AddEventListener("RegistrationWidget.step1.checking",function(t){e.WidgetLoader(!1);var n=[];if(t.username()&&n.push("username="+encodeURIComponent(t.username())),t.phone()&&n.push("phone="+t.phone().replace(/\s/g,"")),t.email()&&n.push("email="+t.email()),n.length>0)var i="?"+n.join("&");e.BaseLoad.UniqueUser(i,function(n){var i=!0;if(e.QueryError(n,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step1.checking",t)})?(e.Validate.Username(n,t)||(i=!1),e.Validate.Email(n,t)||(i=!1),e.Validate.Phone(n,t)||(i=!1)):i=!1,i){var o=[];if(t.username()&&o.push("username="+encodeURIComponent(t.username())),t.phone()&&o.push("phone="+t.phone().replace(/\s/g,"")),t.email()&&o.push("email="+$.trim(t.email())),t.firstPassword()&&o.push("password="+encodeURIComponent(t.firstPassword())),o.length>0)var r="?"+o.join("&");e.BaseLoad.Registration(r,function(){e.BaseLoad.LoginForProxy(t.username(),t.firstPassword(),"no",function(){Parameters.cache.reg.step1=t,Routing.SetHash("registration","Регистрация пользователя",{step:2})})})}else e.WidgetLoader(!0,e.settings.containerFormId)})}),EventDispatcher.AddEventListener("RegistrationWidget.step1.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:1})}),EventDispatcher.AddEventListener("RegistrationWidget.step2.checking",function(t){e.WidgetLoader(!1);var n=[];n.push("username="+encodeURIComponent(t.username)),t.mailConfirmLater()||n.push("mail_token="+t.mailToken()),t.phoneConfirmLater()||n.push("sms_token="+t.phoneToken());var i="?"+n.join("&");e.BaseLoad.ActivateUser(i,function(n){var i=!0;e.QueryError(n,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",t)})?(e.Validate.MailToken(n,t)||(i=!1),e.Validate.PhoneToken(n,t)||(i=!1)):i=!1,i?(Parameters.cache.reg.step2=t,e.BaseLoad.Login(!1,!1,!1,function(e){EventDispatcher.DispatchEvent("w.auth.ok",{request:e}),e.err||Routing.SetHash("registration","Регистрация пользователя",{step:3})})):e.WidgetLoader(!0,e.settings.containerFormId)})}),EventDispatcher.AddEventListener("RegistrationWidget.step2.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:2})}),EventDispatcher.AddEventListener("RegistrationWidget.step3.later",function(){Routing.SetHash("registration","Регистрация пользователя",{step:4})}),EventDispatcher.AddEventListener("RegistrationWidget.step3.checking",function(t){e.WidgetLoader(!1);var n=t.birthDay().split("."),i=n[2]+"-"+n[1]+"-"+n[0];t.birthDayHiddenField(i),e.BaseLoad.EditProfile($("form#"+t.cssRegistrationDataForm),function(n){var i=!0;e.QueryError(n,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.checking",t)})||(i=!1),i?(Parameters.cache.reg.step3=t,Routing.SetHash("registration","Регистрация пользователя",{step:4})):e.WidgetLoader(!0,e.settings.containerFormId)})}),EventDispatcher.AddEventListener("RegistrationWidget.step3.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:3})}),EventDispatcher.AddEventListener("RegistrationWidget.step4.later",function(){e.ShowMessage(Config.Registration.message.registrationSuccessful,function(){Parameters.cache.reg={step1:{},step2:{},step3:{},step4:{}};var e=Parameters.cache.lastPage;$.isEmptyObject(e)?Routing.SetHash("default","Домашняя",{}):Routing.SetHash(e.route,e.title,e.data,!0)})}),EventDispatcher.AddEventListener("RegistrationWidget.step4.checking",function(t){e.WidgetLoader(!1);var n="?id_country="+encodeURIComponent($.trim(t.idCountry()));n=t.region()&&t.region().regioncode?n+"&code_region="+encodeURIComponent($.trim(t.region().regioncode)):n+"&name_region="+encodeURIComponent($.trim(t.customRegion())),n=t.city()&&t.city().aoguid?n+"&code_city="+encodeURIComponent($.trim(t.city().aoguid)):n+"&name_city="+encodeURIComponent($.trim(t.customCity())),n=n+"&address="+encodeURIComponent($.trim(t.customAddress()))+"&post_code="+encodeURIComponent($.trim(t.postIndex())),e.BaseLoad.EditAddress(n,function(n){var i=!0;e.QueryError(n,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",t)})||(i=!1),i?(Parameters.cache.reg.step4=t,EventDispatcher.DispatchEvent("RegistrationWidget.step4.later")):e.WidgetLoader(!0,e.settings.containerFormId)})})},e.Validate={Username:function(e,t){var n=!1;return e.check_username&&(("on"==e.check_username||"ban"==e.check_username||"off"==e.check_username)&&t.errorUsername(Config.Registration.error.username.uniq),"yes"==e.check_username&&(n=!0)),n},Phone:function(e,t){var n=!1;return e.check_phone?(("on"==e.check_phone||"ban"==e.check_phone||"off"==e.check_phone)&&t.errorPhone(Config.Registration.error.phone.uniq),"yes"==e.check_phone&&(n=!0)):n=!0,n},Email:function(e,t){var n=!1;return e.check_email&&(("on"==e.check_email||"ban"==e.check_email||"off"==e.check_email)&&t.errorEmail(Config.Registration.error.email.uniq),"yes"==e.check_email&&(n=!0)),n},MailToken:function(e,t){return e.confirm_email&&"no"==e.confirm_email?(t.errorEmailConfirm(Config.Registration.error.emailToken.confirm),!1):!0},PhoneToken:function(e,t){return e.confirm_phone&&"no"==e.confirm_phone?(t.errorPhoneConfirm(Config.Registration.error.phoneToken.confirm),!1):!0},Profile:function(e,t){return e.err?(t.errorAddress(e.err),!1):!0},Address:function(e,t){return e.err?(t.errorAddress(e.err),!1):!0}},e.Step={Step1:function(){e.InsertContainer.Step1(),e.Fill.Step1()},Step2:function(){e.InsertContainer.Step2(),e.Fill.Step2()},Step3:function(){e.InsertContainer.Step3(),e.Fill.Step3()},Step4:function(){e.InsertContainer.Step4(),e.Fill.Step4()}},e.InsertContainer={EmptyWidget:function(){$("#"+e.settings.containerFormId).empty().html("")},Step1:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("step1")).html()).children().hide()},Step2:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("step2")).html()).children().hide()},Step3:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("step3")).html()).children().hide()},Step4:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("step4")).html()).children().hide()}},e.Fill={Step1:function(){var t=Parameters.cache.reg.step1;$.isEmptyObject(t)&&(RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var e=Parameters.cache.history.pop();e?Routing.SetHash(e.route,e.title,e.data,!0):Routing.SetHash("default","Домашняя",{})},t=new RegistrationFormViewModel,t.submitEvent("RegistrationWidget.step1.checking")),e.Render.Step1(t)},Step2:function(){if(Routing.params.username&&Routing.params.mail_token){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var e=Parameters.cache.history.pop();e?Routing.SetHash(e.route,e.title,e.data,!0):Routing.SetHash("default","Домашняя",{})};var t=new RegistrationFormViewModel;t.username(Routing.params.username),t.submitEvent("RegistrationWidget.step1.checking"),Parameters.cache.reg.step1=t}RegistrationConfirmFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step1.view")};var n=new RegistrationConfirmFormViewModel(Parameters.cache.reg.step1);n.submitEvent("RegistrationWidget.step2.checking"),Routing.params.username&&Routing.params.mail_token&&(n.mailToken(Routing.params.mail_token),EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",n)),e.Render.Step2(n)},Step3:function(){var t=Parameters.cache.reg.step3;$.isEmptyObject(t)&&(RegistrationProfileFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.view")},RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.later")},t=new RegistrationProfileFormViewModel,t.submitEvent("RegistrationWidget.step3.checking")),e.Render.Step3(t)},Step4:function(){var t=Parameters.shopId;0==e.settings.geoShop&&(t=0),e.BaseLoad.Country(t,function(t){var n=new RegistrationFormStep4ViewModel;n.AddCountryList(t),e.Render.Step4(n)})}},e.Render={Step1:function(t){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(t,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateRegistration&&new AnimateRegistration,e.settings.animate&&e.settings.animate()}catch(n){e.Exception("Ошибка шаблона ["+e.GetTmplName("step1")+"]",n),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Step1(),e.Render.Step1(t)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},Step2:function(t){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(t,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateRegistration&&new AnimateRegistration,e.settings.animate&&e.settings.animate()}catch(n){e.Exception("Ошибка шаблона ["+e.GetTmplName("step2")+"]",n),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Step2(),e.Render.Step2(t)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},Step3:function(t){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(t,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateRegistration&&new AnimateRegistration,e.settings.animate&&e.settings.animate()}catch(n){e.Exception("Ошибка шаблона ["+e.GetTmplName("step3")+"]",n),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Step3(),e.Render.Step3(t)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},Step4:function(t){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(t,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateRegistration&&new AnimateRegistration,e.settings.animate&&e.settings.animate(),$("#"+t.cssRegionList).autocomplete({source:function(n,i){e.BaseLoad.Region(t.idCountry()+"/"+encodeURIComponent(n.term),function(e){return e.err?($("#"+t.cssRegionList).autocomplete("close"),!1):void i($.map(e,function(e){return{value:$.trim(e.formalname+" "+e.shortname),region:e}}))})},select:function(e,n){t.region(n.item.region),t.customRegion(n.item.value),t.postIndex(n.item.region&&0!=n.item.region.postalcode?n.item.region.postalcode:null)}}),$("#"+t.cssCityList).autocomplete({source:function(n,i){t.region()&&e.BaseLoad.City(t.idCountry()+"/"+encodeURIComponent(t.region().regioncode)+"/"+encodeURIComponent(n.term),function(e){return e.err?($("#"+t.cssCityList).autocomplete("close"),!1):void i($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),city:e}}))})},select:function(e,n){t.city(n.item.city),t.customCity(n.item.value),t.postIndex(n.item.city&&0!=n.item.city.postalcode?n.item.city.postalcode:null)}}),$("#"+t.cssAddress).autocomplete({source:function(n,i){t.region()&&e.BaseLoad.Street(t.idCountry()+"/"+encodeURIComponent(t.region().regioncode)+"/"+encodeURIComponent(t.city().aoguid)+"/"+encodeURIComponent(n.term),function(e){return e.err?($("#"+t.cssAddress).autocomplete("close"),!1):void i($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),street:e}}))})},select:function(e,n){t.address(n.item.street),t.customAddress(n.item.value),t.postIndex(n.item.street&&0!=n.item.street.postalcode?n.item.street.postalcode:null)}}),$("#"+t.cssCountryList).change(function(){t.idCountry()&&(t.errorCountry(""),t.errorRegion(""),t.errorCity(""),t.errorAddress(""),t.errorPostIndex("")),$.grep(t.countryList(),function(e){e.id==t.idCountry()&&(t.customRegion(null),t.region(null),t.customCity(null),t.city(null),t.customAddress(null),t.address(null),t.postIndex(null))})}),$("#"+t.cssRegionList).bind("textchange",function(){t.errorRegion(""),t.errorCity(""),t.errorAddress(""),t.errorPostIndex(""),t.customRegion($(this).val()),t.customCity(null),t.city(null),t.customAddress(null),t.address(null),t.postIndex(null)}),$("#"+t.cssCityList).bind("textchange",function(){t.errorCity(""),t.errorAddress(""),t.errorPostIndex(""),t.customCity($(this).val()),t.customAddress(null),t.address(null),t.postIndex(null)}),$("#"+t.cssAddress).bind("textchange",function(){t.errorAddress(""),t.errorPostIndex("")}),$("#"+t.cssPostIndex).bind("textchange",function(){t.errorPostIndex("")})}catch(n){e.Exception("Ошибка шаблона ["+e.GetTmplName("step4")+"]",n),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Step4(),e.Render.Step4(t)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)}},e.SetPosition=function(){if("absolute"==e.settings.inputParameters.position){for(var t in e.settings.inputParameters)e.settings.style[t]&&(e.settings.style[t]=e.settings.inputParameters[t]);$().ready(function(){for(var t=0;t<=Config.Containers.registration.length-1;t++)$("#"+Config.Containers.registration[t]).css(e.settings.style)})}}},RegistrationFormStep4ViewModel=function(){var e=this;e.idCountry=ko.observable(),e.cssCountryList="country_list",e.errorCountry=ko.observable(null),e.region=ko.observable(),e.customRegion=ko.observable(),e.cssRegionList="region_list",e.errorRegion=ko.observable(null),e.showRegion=ko.computed(function(){return e.idCountry()?!1:!0},this),e.city=ko.observable(),e.customCity=ko.observable(),e.cssCityList="city_list",e.errorCity=ko.observable(null),e.showCity=ko.computed(function(){return e.customRegion()?!1:!0},this),e.address=ko.observable(),e.customAddress=ko.observable(),e.cssAddress="address",e.errorAddress=ko.observable(null),e.showAddress=ko.computed(function(){return e.customCity()?!1:!0},this),e.postIndex=ko.observable(),e.cssPostIndex="post_index",e.errorPostIndex=ko.observable(null),e.showPostIndex=ko.computed(function(){return e.customAddress()?!1:!0},this),e.countryList=ko.observableArray(),e.AddCountryList=function(t){if(t.length>0)for(var n=0;n<=t.length-1;n++)e.countryList.push(new CountryListViewModel(t[n]))},e.SpecifyLater=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.later",e)},e.SubmitForm=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",e)},e.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.view")},e.ValidationForm=function(){var t=!0;return e.CountryValidation()||(t=!1),e.RegionValidation()||(t=!1),e.CityValidation()||(t=!1),e.AddressValidation()||(t=!1),e.PostIndexValidation()||(t=!1),t},e.CountryValidation=function(){return e.idCountry()?(e.errorCountry(null),!0):(e.errorCountry(Config.Registration.error.country.empty),!1)},e.RegionValidation=function(){return e.customRegion()?(e.errorRegion(null),!0):(e.errorRegion(Config.Registration.error.region.empty),!1)},e.CityValidation=function(){return e.customCity()?(e.errorCity(null),!0):(e.errorCity(Config.Registration.error.city.empty),!1)},e.AddressValidation=function(){return e.customAddress()?(e.errorAddress(null),!0):(e.errorAddress(Config.Registration.error.address.empty),!1)},e.PostIndexValidation=function(){return e.postIndex()?5>e.postIndex().length||e.postIndex().length>6?(e.errorPostIndex(Config.Registration.error.postIndex.length),!1):Config.Registration.regular.postIndex.test(e.postIndex())?(e.errorPostIndex(null),!0):(e.errorPostIndex(Config.Registration.error.postIndex.regular),!1):(e.errorPostIndex(Config.Registration.error.postIndex.empty),!1)}},TestRegistration={Init:function(){if("function"==typeof Widget){RegistrationWidget.prototype=new Widget;var e=new RegistrationWidget;e.Init(e)}else setTimeout(function(){TestRegistration.Init()},100)}};TestRegistration.Init();