var RegistrationWidget=function(){var p=this;p.widgetName="RegistrationWidget";p.version=1;p.minWidgetVersion=1;p.maxWidgetVersion=2;p.minTmplVersion=1;p.maxTmplVersion=2;p.InitWidget=c;var z={container:{widget:"content",def:"defaultRegistrationWidgetId"},tmpl:{path:"registrationTmpl.html",id:{step1:"registrationFromStep1Tmpl",step2:"registrationFromStep2Tmpl",step3:"registrationFromStep3Tmpl",step4:"registrationFromStep4Tmpl"}},regular:{username:/^[а-яёa-zА-ЯЁA-Z0-9_\-\.\s]+$/,email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,gender:/^[mw]$/,postIndex:/^[0-9]+$/},message:{registrationSuccessful:"Вы успешно зарегистрировались в магазине"},error:{username:{empty:"Поле обязательно для заполнения",minLength:"Минимум 4 символа",maxLength:"Максимум 40 символов",regular:"Только буквы латинского или русского алфавита",uniq:"К сожалению это имя уже занято, попробуйте указать другой вариант"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},phone:{regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="https://pokupo.ru/resetting/request">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},isChecked:{empty:"Вам необходимо прочитать и принять условия соглашения"},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},confirmLater:{empty:"Для активации аккаунта требуется подтвердить хотя бы один из способов связи"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},gender:{empty:"Поле обязательно для заполнения"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"}},animate:typeof AnimateRegistration=="function"?AnimateRegistration:null,geoShop:0},q="registration",D="Регистрация пользователя";function c(){B();f();r()}function B(){var E=p.GetInputParameters(q);if(!$.isEmptyObject(E)){z=p.UpdateSettings1(z,E)}Config.Containers.registration=z.container}function r(){if(Routing.route==q){var E=Routing.params;p.BaseLoad.Tmpl(z.tmpl,function(){p.BaseLoad.Script(PokupoWidgets.model.registration,function(){if(E.step==1){o();y()}if(E.step==2){m();x()}if(E.step==3){k();w()}if(E.step==4){h();t()}})})}else{p.WidgetLoader(true)}}function f(){p.AddEvent("w.change.route",function(){r()});p.AddEvent("RegistrationWidget.step1.checking",function(E){p.WidgetLoader(false);var G=[];if(E.username()){G.push("username="+encodeURIComponent(E.username()))}if(E.phone()){G.push("phone="+E.phone().replace(/\s/g,""))}if(E.email()){G.push("email="+E.email())}if(G.length>0){var F="?"+G.join("&")}p.BaseLoad.UniqueUser(F,function(H){var K=true;if(p.QueryError(H,function(){p.DispatchEvent("RegistrationWidget.step1.checking",E)})){if(!d(H,E)){K=false}if(!C(H,E)){K=false}if(!s(H,E)){K=false}}else{K=false}if(K){var J=[];if(E.username()){J.push("username="+encodeURIComponent(E.username()))}if(E.phone()){J.push("phone="+E.phone().replace(/\s/g,""))}if(E.email()){J.push("email="+$.trim(E.email()))}if(E.firstPassword()){J.push("password="+encodeURIComponent(E.firstPassword()))}if(J.length>0){var I="?"+J.join("&")}p.BaseLoad.Registration(I,function(L){p.BaseLoad.LoginForProxy(E.username(),E.firstPassword(),"no",function(M){Parameters.cache.reg.step1=E;A(q,D,{step:2})})})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step1.view",function(){A(q,D,{step:1})});p.AddEvent("RegistrationWidget.step2.checking",function(E){p.WidgetLoader(false);var G=[];G.push("username="+encodeURIComponent(E.username));if(!E.mailConfirmLater()){G.push("mail_token="+E.mailToken())}if(!E.phoneConfirmLater()){G.push("sms_token="+E.phoneToken())}var F="?"+G.join("&");p.BaseLoad.ActivateUser(F,function(H){var I=true;if(p.QueryError(H,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",E)})){if(!i(H,E)){I=false}if(!u(H,E)){I=false}}else{I=false}if(I){Parameters.cache.reg.step2=E;p.BaseLoad.Login(false,false,false,function(J){p.DispatchEvent("w.auth.ok",{request:J});if(!J.err){A(q,D,{step:3})}})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step2.view",function(){A(q,D,{step:2})});p.AddEvent("RegistrationWidget.step3.later",function(){A(q,D,{step:4})});p.AddEvent("RegistrationWidget.step3.checking",function(E){p.WidgetLoader(false);var G=E.birthDay().split(".");var F=G[2]+"-"+G[1]+"-"+G[0];E.birthDayHiddenField(F);p.BaseLoad.EditProfile($("form#"+E.cssRegistrationDataForm),function(H){var I=true;if(!p.QueryError(H,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.checking",E)})){I=false}if(I){Parameters.cache.reg.step3=E;A(q,D,{step:4})}else{p.WidgetLoader(true,z.container.widget)}})});p.AddEvent("RegistrationWidget.step3.view",function(){A(q,D,{step:3})});p.AddEvent("RegistrationWidget.step4.later",function(E){p.ShowMessage(z.message.registrationSuccessful,function(){Parameters.cache.reg={step1:{},step2:{},step3:{},step4:{}};var F=Parameters.cache.lastPage;if(!$.isEmptyObject(F)){A(F.route,F.title,F.data,true)}else{A("default","Домашняя",{})}})});p.AddEvent("RegistrationWidget.step4.checking",function(F){p.WidgetLoader(false);var E="?id_country="+encodeURIComponent($.trim(F.idCountry()));if(F.region()&&F.region().regioncode){E=E+"&code_region="+encodeURIComponent($.trim(F.region().regioncode))}else{E=E+"&name_region="+encodeURIComponent($.trim(F.customRegion()))}if(F.city()&&F.city().aoguid){E=E+"&code_city="+encodeURIComponent($.trim(F.city().aoguid))}else{E=E+"&name_city="+encodeURIComponent($.trim(F.customCity()))}E=E+"&address="+encodeURIComponent($.trim(F.customAddress()))+"&post_code="+encodeURIComponent($.trim(F.postIndex()));p.BaseLoad.EditAddress(E,function(G){var H=true;if(!p.QueryError(G,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",F)})){H=false}if(H){Parameters.cache.reg.step4=F;EventDispatcher.DispatchEvent("RegistrationWidget.step4.later")}else{p.WidgetLoader(true,z.container.widget)}})})}function d(F,E){var G=false;if(F.check_username){if(F.check_username=="on"||F.check_username=="ban"||F.check_username=="off"){E.errorUsername(z.error.username.uniq)}if(F.check_username=="yes"){G=true}}return G}function s(F,E){var G=false;if(F.check_phone){if(F.check_phone=="on"||F.check_phone=="ban"||F.check_phone=="off"){E.errorPhone(z.error.phone.uniq)}if(F.check_phone=="yes"){G=true}}else{G=true}return G}function C(F,E){var G=false;if(F.check_email){if(F.check_email=="on"||F.check_email=="ban"||F.check_email=="off"){E.errorEmail(z.error.email.uniq)}if(F.check_email=="yes"){G=true}}return G}function i(F,E){if(F.confirm_email){if(F.confirm_email=="no"){E.errorEmailConfirm(z.error.emailToken.confirm);return false}}return true}function u(F,E){if(F.confirm_phone){if(F.confirm_phone=="no"){E.errorPhoneConfirm(z.error.phoneToken.confirm);return false}}return true}function b(F,E){if(F.err){E.errorAddress(F.err);return false}return true}function e(E,F){if(E.err){F.errorAddress(E.err);return false}return true}function v(){p.ClearContainer(z)}function o(){p.InsertContainer(z,"step1")}function m(){p.InsertContainer(z,"step2")}function k(){p.InsertContainer(z,"step3")}function h(){p.InsertContainer(z,"step4")}function y(){var E=Parameters.cache.reg.step1;if($.isEmptyObject(E)){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var F=Parameters.cache.history.pop();if(F){A(F.route,F.title,F.data,true)}else{A("default","Домашняя",{})}};E=new RegistrationFormViewModel(z);E.submitEvent("RegistrationWidget.step1.checking")}n(E)}function x(){var G=Routing.params;if(G.username&&G.mail_token){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var H=Parameters.cache.history.pop();if(H){A(H.route,H.title,H.data,true)}else{A("default","Домашняя",{})}};var E=new RegistrationFormViewModel(z);E.username(G.username);E.submitEvent("RegistrationWidget.step1.checking");Parameters.cache.reg.step1=E}RegistrationConfirmFormViewModel.prototype.Back=function(){p.DispatchEvent("RegistrationWidget.step1.view")};var F=new RegistrationConfirmFormViewModel(Parameters.cache.reg.step1,z);F.submitEvent("RegistrationWidget.step2.checking");if(G.username&&G.mail_token){F.mailToken(G.mail_token);p.DispatchEvent("RegistrationWidget.step2.checking",F)}l(F)}function w(){var E=Parameters.cache.reg.step3;if($.isEmptyObject(E)){RegistrationProfileFormViewModel.prototype.Back=function(){p.DispatchEvent("RegistrationWidget.step2.view")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){p.DispatchEvent("RegistrationWidget.step3.later")};E=new RegistrationProfileFormViewModel(z);E.submitEvent("RegistrationWidget.step3.checking")}j(E)}function t(){var E=Parameters.shopId;if(z.geoShop==0){E=0}p.BaseLoad.Country(E,function(G){var F=new RegistrationFormStep4ViewModel(z);F.AddCountryList(G);g(F)})}function n(E){p.RenderTemplate(E,z,null,function(F){o();n(F)},function(){v()},"step1")}function l(E){p.RenderTemplate(E,z,null,function(F){m();l(F)},function(){v()},"step2")}function j(E){p.RenderTemplate(E,z,null,function(F){k();j(F)},function(){v()},"step3")}function g(E){p.RenderTemplate(E,z,function(F){a(F)},function(F){h();g(F)},function(){v()},"step4")}function a(E){$("#"+E.cssRegionList).autocomplete({source:function(G,F){p.BaseLoad.Region(E.idCountry()+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.formalname+" "+I.shortname),region:I}}))}else{$("#"+E.cssRegionList).autocomplete("close");return false}})},select:function(F,G){E.region(G.item.region);E.customRegion(G.item.value);if(G.item.region&&G.item.region.postalcode!=0){E.postIndex(G.item.region.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssCityList).autocomplete({source:function(G,F){if(E.region()){p.BaseLoad.City(E.idCountry()+"/"+encodeURIComponent(E.region().regioncode)+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.shortname+". "+I.formalname),city:I}}))}else{$("#"+E.cssCityList).autocomplete("close");return false}})}},select:function(F,G){E.city(G.item.city);E.customCity(G.item.value);if(G.item.city&&G.item.city.postalcode!=0){E.postIndex(G.item.city.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssAddress).autocomplete({source:function(G,F){if(E.region()){p.BaseLoad.Street(E.idCountry()+"/"+encodeURIComponent(E.region().regioncode)+"/"+encodeURIComponent(E.city().aoguid)+"/"+encodeURIComponent(G.term),function(H){if(!H.err){F($.map(H,function(I){return{value:$.trim(I.shortname+". "+I.formalname),street:I}}))}else{$("#"+E.cssAddress).autocomplete("close");return false}})}},select:function(F,G){E.address(G.item.street);E.customAddress(G.item.value);if(G.item.street&&G.item.street.postalcode!=0){E.postIndex(G.item.street.postalcode)}else{E.postIndex(null)}}});$("#"+E.cssCountryList).change(function(){if(E.idCountry()){E.errorCountry("");E.errorRegion("");E.errorCity("");E.errorAddress("");E.errorPostIndex("")}$.grep(E.countryList(),function(F){if(F.id==E.idCountry()){E.customRegion(null);E.region(null);E.customCity(null);E.city(null);E.customAddress(null);E.address(null);E.postIndex(null)}})});$("#"+E.cssRegionList).bind("textchange",function(G,F){E.errorRegion("");E.errorCity("");E.errorAddress("");E.errorPostIndex("");E.customRegion($(this).val());E.customCity(null);E.city(null);E.customAddress(null);E.address(null);E.postIndex(null)});$("#"+E.cssCityList).bind("textchange",function(G,F){E.errorCity("");E.errorAddress("");E.errorPostIndex("");E.customCity($(this).val());E.customAddress(null);E.address(null);E.postIndex(null)});$("#"+E.cssAddress).bind("textchange",function(G,F){E.errorAddress("");E.errorPostIndex("")});$("#"+E.cssPostIndex).bind("textchange",function(G,F){E.errorPostIndex("")})}function A(E,G,F){Routing.SetHash(E,G,F)}};var RegistrationFormStep4ViewModel=function(e){var i=this;i.idCountry=ko.observable();i.cssCountryList="country_list";i.errorCountry=ko.observable(null);i.region=ko.observable();i.customRegion=ko.observable();i.cssRegionList="region_list";i.errorRegion=ko.observable(null);i.showRegion=ko.computed(function(){if(i.idCountry()){return false}return true},this);i.city=ko.observable();i.customCity=ko.observable();i.cssCityList="city_list";i.errorCity=ko.observable(null);i.showCity=ko.computed(function(){if(i.customRegion()){return false}return true},this);i.address=ko.observable();i.customAddress=ko.observable();i.cssAddress="address";i.errorAddress=ko.observable(null);i.showAddress=ko.computed(function(){if(i.customCity()){return false}return true},this);i.postIndex=ko.observable();i.cssPostIndex="post_index";i.errorPostIndex=ko.observable(null);i.showPostIndex=ko.computed(function(){if(i.customAddress()){return false}return true},this);i.countryList=ko.observableArray();i.AddCountryList=function(k){if(k.length>0){for(var j=0;j<=k.length-1;j++){i.countryList.push(new CountryListViewModel(k[j]))}}};i.SpecifyLater=function(){h("RegistrationWidget.step4.later",i)};i.SubmitForm=function(){if(d()){h("RegistrationWidget.step4.checking",i)}};i.Back=function(){h("RegistrationWidget.step3.view")};function h(j,k){EventDispatcher.DispatchEvent(j,k)}function d(){var j=true;if(!g()){j=false}if(!c()){j=false}if(!b()){j=false}if(!f()){j=false}if(!a()){j=false}return j}function g(){if(!i.idCountry()){i.errorCountry(e.error.country.empty);return false}i.errorCountry(null);return true}function c(){if(!i.customRegion()){i.errorRegion(e.error.region.empty);return false}i.errorRegion(null);return true}function b(){if(!i.customCity()){i.errorCity(e.error.city.empty);return false}i.errorCity(null);return true}function f(){if(!i.customAddress()){i.errorAddress(e.error.address.empty);return false}i.errorAddress(null);return true}function a(){var j=e.error.postIndex;if(!i.postIndex()){i.errorPostIndex(j.empty);return false}if(5>i.postIndex().length||i.postIndex().length>6){i.errorPostIndex(j.length);return false}if(!e.regular.postIndex.test(i.postIndex())){i.errorPostIndex(j.regular);return false}i.errorPostIndex(null);return true}};var TestRegistration={Init:function(){if(typeof Widget=="function"){RegistrationWidget.prototype=new Widget();var a=new RegistrationWidget();a.Init(a)}else{setTimeout(function(){TestRegistration.Init()},100)}}};TestRegistration.Init();