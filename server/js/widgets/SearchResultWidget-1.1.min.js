var SearchResultWidget=function(){function e(){a(),t(),r()}function t(){var e=f.GetInputParameters("searchResult");$.isEmptyObject(e)||(u=f.UpdateSettings1(u,e),e.content&&(e.content.hasOwnProperty("showCart")&&(u.showCart=e.content.showCart),e.content.hasOwnProperty("defaultCount")&&(u.paging.itemsPerPage=e.content.defaultCount),e.content.list&&(u.listPerPage=e.content.list)),e.form&&(e.form.hasOwnProperty("showForm")&&(u.showForm=e.form.showForm),e.form.hasOwnProperty("showCatalog")&&(u.showCatalog=e.form.showCatalog))),Config.SearchResult=u}function r(){if("search"==Routing.route){var e=Routing.params;for(var t in e)if("idSelectCategories"==t){var r=[],a=decodeURIComponent(e[t]).split(",");if(e[t]){var i=0;for(var o in a){var n=parseInt(a[o]);n&&!isNaN(n)&&(r[i++]=n)}Parameters.filter[t]=r,Parameters.filter.idCategories=r}}else Parameters.filter[t]=decodeURIComponent(e[t]);f.DispatchEvent("w.change.route")}f.DispatchEvent("SearchR.show.form")}function a(){f.AddEvent("SearchR.show.form",function(){u.showForm?($("#"+u.container.form.widget).html(""),f.BaseLoad.Roots(function(){f.DispatchEvent("SearchR.onload.roots.show.form")})):f.WidgetLoader(!0,u.container.form.widget)}),f.AddEvent("SearchR.onload.roots.show.form",function(){f.BaseLoad.Tmpl(u.tmpl.form,function(){o(),"search"!=Routing.route&&Parameters.SetDefaultFilterParameters(),l(),f.WidgetLoader(!0,u.container.form.widget)})}),f.AddEvent("SearchR.submit.form",function(){for(var e=u.paging,t=(Routing.GetCurrentPage()-1)*e.itemsPerPage,r=t+"/"+e.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?",a=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"],i=[],o=0;o<=a.length-1;o++)Parameters.filter[a[o]]&&(i[o]=a[o]+"="+encodeURIComponent(Parameters.filter[a[o]]));r+=i.join("&"),f.BaseLoad.SearchContent(Parameters.shopId,r,function(e){f.DispatchEvent("SearchR.onload.searchResult",e)})}),f.AddEvent("SearchR.onload.searchResult",function(e){f.DispatchEvent("onload.breadCrumb.tmpl"),c(e)}),f.AddEvent("SearchR.fill.searchResult",function(e){s(e.typeView),h(e)}),f.AddEvent("SearchR.fill.categories",function(e){d(e)}),f.AddEvent("w.change.route",function(){"search"==Routing.route&&f.BaseLoad.Tmpl(u.tmpl.content,function(){f.DispatchEvent("SearchR.submit.form")}),f.DispatchEvent("SearchR.show.form")})}function i(){$("#"+u.container.form.widget).empty().html("")}function o(){i(),f.AppendContainer(u,!1,"form",u.container.form.widget)}function n(){$("#"+u.container.content.widget).empty().html("")}function s(e){n();var t=u.container.content.widget;"table"==e&&f.AppendContainer(u,"table","content",t),"list"==e&&f.AppendContainer(u,"list","content",t),"tile"==e&&f.AppendContainer(u,"tile","content",t),"error"==e&&f.AppendContainer(u,"empty","content",t)}function l(){var e=new AdvancedSearchFormViewModel(u);f.BaseLoad.Roots(function(t){e.AddCategories(t)})}function c(e){f.BaseLoad.Script(PokupoWidgets.model.content,function(){var t=new ListSearchResultViewModel(u);t.AddContent(e)})}function d(e){ko.global?ko.global.route=Routing.route:ko.global={route:Routing.route},f.RenderTemplate(e,u,null,function(e){o(),d(e)},function(){i()},null,null,"form")}function h(e){f.RenderTemplate(e,u,null,function(e){s(e.typeView),h(e)},function(){n()},e.typeView,null,"content")}var f=this;f.widgetName="SearchResultWidget",f.version=1,f.minWidgetVersion=1,f.maxWidgetVersion=2,f.minTmplVersion=1,f.maxTmplVersion=2,f.InitWidget=e;var u={container:{form:{widget:"advancedSearchFormWidgetId",def:"defaultAdvancedSearchFormWidgetId"},content:{widget:"content",def:"defaultAdvancedSearchResultWidgetId"}},tmpl:{content:{path:"searchResultTmpl.html",id:{table:"searchResultTableTmpl",list:"searchResultListTmpl",tile:"searchResultTileTmpl",empty:"searchResultErrorTmpl"}},form:{path:"advancedSearchFormTmpl.html",id:"advancedSearchFormTmpl"}},showCatalog:!0,showForm:!0,showCart:!0,idAdvancedSearchForm:"advancedSearch",listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],listTypeSearch:{any:"Любое из слов",all:"Все слова"},listTypeSeller:{"":"Все продавцы",person:"Частное лицо",company:"Компания"},animate:{content:"function"==typeof AnimateSearchResult?AnimateSearchResult:null,form:"function"==typeof AnimateSearchResult?AnimateSearchResult:null},idTreeCategoriesForAdvancedSearchForm:"tree_categories_for_advanced_search",paging:Config.Paging}},AdvancedSearchFormViewModel=function(e){function t(e,r){for(var a=[],i=!1,o=0;o<=e.length-1;o++){var s={};if(s.select=!1,($.inArray(e[o].id,Parameters.filter.idSelectCategories)>=0||1==r)&&(s.select=!0,i=!0),e[o].children){var l=t(e[o].children,s.select);s.children=l.children,s.expand=l.active,s.isFolder=!0}s.key=e[o].id,s.title=e[o].name_category,a.push(s),n.typeCategories[e[o].id]=e[o].type_category}return{children:a,active:i}}function r(e,t){for(var r in e)t.push(new AdvancedSearchFormTypeSearchViewModel({key:r,title:e[r]},n))}function a(e,t){for(var r in e)t.push(new AdvancedSearchFormTypeSellerViewModel({key:r,title:e[r]},n))}function i(e,t){for(var r=0;r<=e.length-1;r++)if(t)for(var a=0;a<=t.length;a++){if(e[r].id==t[a]&&e[r].children){o(e[r].children);break}e[r].children?i(e[r].children,t):e[r].id==t[a]&&$.inArray(e[r].id,n.idCategories)<0&&n.idCategories.push(e[r].id)}}function o(e){for(var t=0;t<=e.length-1;t++)"category"==e[t].type_category&&$.inArray(e[t].id,n.idCategories)<0&&n.idCategories.push(e[t].id),e[t].children&&o(e[t].children)}var n=this,s=Parameters.filter;n.keyWords=s.keyWords,n.idCategories=s.idCategories,n.typeSearch=ko.observable(),n.typeSearch(s.typeSearch),n.startCost=s.startCost,n.endCost=s.endCost,n.exceptWords=s.exceptWords,n.typeSeller=ko.observable(),n.typeSeller(s.typeSeller),n.showCatalog=e.showCatalog,n.categories=[],n.typesSearch=ko.observableArray(),n.typesSellers=ko.observableArray(),n.typeCategories=[],n.cssTypeSearch="advancedSearchTypeSearch",n.cssTypeSeller="advancedSearchTypeSeller",n.cachData={},n.AddCategories=function(e){n.cachData=e,n.idCategories&&1==n.idCategories.length&&i(e,n.idCategories),n.categories=t(e).children,Parameters.cache.categories=n.categories,EventDispatcher.DispatchEvent("SearchR.fill.categories",n)},n.SubmitAdvancedSearchForm=function(e){Loader.Indicator("SearchResultWidget",!1),n.keyWords=$(e.keyWords).val(),n.startCost=$(e.startCost).val(),n.endCost=$(e.endCost).val(),n.exceptWords=$(e.exceptWords).val(),Parameters.filter.idCategories=n.idCategories=[],i(n.cachData,Parameters.filter.idSelectCategories),n.idCategories.length>0&&(Parameters.filter.idCategories=n.idCategories.join(",")),Parameters.filter.keyWords=n.keyWords,Parameters.filter.typeSearch=n.typeSearch(),Parameters.filter.startCost=n.startCost,Parameters.filter.endCost=n.endCost,Parameters.filter.exceptWords=n.exceptWords,Parameters.filter.typeSeller=n.typeSeller(),Parameters.filter.page=1,Routing.SetHash("search","Расширенный поиск",Parameters.filter)},r(e.listTypeSearch,n.typesSearch),a(e.listTypeSeller,n.typesSellers)},AdvancedSearchFormTypeSearchViewModel=function(e,t){var r=this;r.title=e.title,r.key=e.key,r.ClickItem=function(){t.typeSearch(r.key)}},AdvancedSearchFormTypeSellerViewModel=function(e,t){var r=this;r.title=e.title,r.key=e.key,r.ClickItem=function(){t.typeSeller(r.key)}},ListSearchResultViewModel=function(e){var t=this;t.id=0,t.titleBlock="Расширенный поиск",t.typeView="tile",t.countGoods=0,t.showCart=e.showCart,t.content=ko.observableArray(),t.paging=ko.observableArray(),t.GetSort=function(){var e=new SortSearchResultListViewModel;return e.AddContent(Config.SearchResult.sortList),e.SetDefault(Parameters.filter.orderBy),e},t.filters={typeView:t.typeView,sort:t.GetSort(),filterName:ko.observable(Parameters.filter.filterName),itemsPerPage:e.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(e.listPerPage.length-1),FilterNameGoods:function(e){Loader.Indicator("SearchResultWidget",!1),Parameters.filter.filterName=$(e.text).val(),Routing.UpdateHash({page:1,filterName:$(e.text).val()})},ClickFilterNameGoods:function(){Loader.Indicator("SearchResultWidget",!1),Parameters.filter.filterName=t.filters.filterName(),Routing.UpdateMoreParameters({filterName:t.filters.filterName()}),Routing.UpdateHash({page:1})},ViewSelectCount:function(){t.filters.listPerPage=ko.observableArray();for(var r in e.listPerPage){if(!(e.listPerPage[r]<t.countGoods)){t.filters.listPerPage.push(e.listPerPage[r]);break}t.filters.listPerPage.push(e.listPerPage[r])}1==t.filters.listPerPage().length&&(t.filters.listPerPage=ko.observableArray())},SelectCount:function(r){Loader.Indicator("SearchResultWidget",!1),t.filters.itemsPerPage=e.paging.itemsPerPage=r,Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){t.typeView="tile",t.filters.typeView="tile",Parameters.cache.typeView="tile",t.AddContent(Parameters.cache.searchContent[t.GetQueryHash()]),EventDispatcher.DispatchEvent("SearchR.fill.searchResult",t)},ClickTable:function(){t.typeView="table",t.filters.typeView="table",Parameters.cache.typeView="table",t.AddContent(Parameters.cache.searchContent[t.GetQueryHash()]),EventDispatcher.DispatchEvent("SearchR.fill.searchResult",t)},ClickList:function(){t.typeView="list",t.filters.typeView="list",Parameters.cache.typeView="list",t.AddContent(Parameters.cache.searchContent[t.GetQueryHash()]),EventDispatcher.DispatchEvent("SearchR.fill.searchResult",t)}}},t.AddContent=function(e){if(t.content=ko.observableArray(),Parameters.cache.typeView&&(t.typeView=Parameters.cache.typeView,t.filters.typeView=Parameters.cache.typeView),e&&e.length>1){var r=e.shift();t.countGoods=parseInt(r.count_goods);for(var a=0,i=0;i<=e.length-1;i++)if("tile"==t.typeView){for(var o=new BlockTrForTableViewModel,n=0;3>=n&&e[a];n++)o.AddStr(new ContentViewModel(e[a],a)),a++;o.str().length>0&&t.content.push(o),delete o}else t.content.push(new ContentViewModel(e[i],i));t.AddPages(),e.unshift(r)}0==t.countGoods&&(t.typeView="error"),t.filters.ViewSelectCount(),EventDispatcher.DispatchEvent("SearchR.fill.searchResult",t)},t.GetQueryHash=function(){for(var t=(Routing.GetCurrentPage()-1)*e.paging.itemsPerPage,r=t+"/"+e.paging.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?",a=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"],i=[],o=0;o<=a.length-1;o++)Parameters.filter[a[o]]&&(i[o]=a[o]+"="+encodeURIComponent(Parameters.filter[a[o]]));return r+=i.join("&"),Parameters.shopId+EventDispatcher.HashCode(r)},t.AddPages=function(){var r=function(){Loader.Indicator("SearchResultWidget",!1),Routing.UpdateHash({page:this.pageId})};t.paging=Paging.GetPaging(t.countGoods,e,r)}},SortSearchResultItemViewModel=function(e,t){var r=this;r.name=e.name,r.title=e.title,r.isActive=!1,r.ClickSort=function(){$.each(t.list(),function(e){t.list()[e].isActive=!1}),t.activeItem(r),r.isActive=!0,Loader.Indicator("SearchResultWidget",!1),Parameters.filter.orderBy=r.name,Routing.UpdateMoreParameters({orderBy:r.name}),Routing.UpdateHash({page:1})}},SortSearchResultListViewModel=function(){var e=this;e.activeItem=ko.observable(),e.list=ko.observableArray(),e.cssSortList="sort_search_result_list",e.AddContent=function(t){$.each(t,function(r){e.list.push(new SortSearchResultItemViewModel(t[r],e))})},e.SetDefault=function(t){$.each(e.list(),function(r){e.list()[r].name==t?(e.activeItem(e.list()[r]),e.list()[r].isActive=!0):e.list()[r].isActive=!1})}},TestSearchResult={Init:function(){if("function"==typeof Widget){SearchResultWidget.prototype=new Widget;var e=new SearchResultWidget;e.Init(e)}else setTimeout(function(){TestSearchResult.Init()},100)}};TestSearchResult.Init();