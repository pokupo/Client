var SearchResultWidget=function(){var m=this;m.widgetName="SearchResultWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.InitWidget=h;var g={container:{form:{widget:"advancedSearchFormWidgetId",def:"defaultAdvancedSearchFormWidgetId"},content:{widget:"content",def:"defaultAdvancedSearchResultWidgetId"}},tmpl:{content:{path:"searchResultTmpl.html",id:{table:"searchResultTableTmpl",list:"searchResultListTmpl",tile:"searchResultTileTmpl",empty:"searchResultErrorTmpl"}},form:{path:"advancedSearchFormTmpl.html",id:"advancedSearchFormTmpl"}},showCatalog:true,showForm:true,showCart:true,idAdvancedSearchForm:"advancedSearch",listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],listTypeSearch:{any:"Любое из слов",all:"Все слова"},listTypeSeller:{"":"Все продавцы",person:"Частное лицо",company:"Компания"},animate:{content:typeof AnimateSearchResult=="function"?AnimateSearchResult:null,form:typeof AnimateSearchResult=="function"?AnimateSearchResult:null},idTreeCategoriesForAdvancedSearchForm:"tree_categories_for_advanced_search",paging:Config.Paging};function h(){k();c();i()}function c(){var o=m.GetInputParameters("searchResult");if(!$.isEmptyObject(o)){g=m.UpdateSettings1(g,o);if(o.content){if(o.content.hasOwnProperty("showCart")){g.showCart=o.content.showCart}if(o.content.hasOwnProperty("defaultCount")){g.paging.itemsPerPage=o.content.defaultCount}if(o.content.list){g.listPerPage=o.content.list}}if(o.form){if(o.form.hasOwnProperty("showForm")){g.showForm=o.form.showForm}if(o.form.hasOwnProperty("showCatalog")){g.showCatalog=o.form.showCatalog}}}Config.Containers.searchResult=g.container}function i(){if(Routing.route=="search"){var t=Routing.params;for(var r in t){if(r=="idSelectCategories"){var o=[];var s=decodeURIComponent(t[r]).split(",");if(t[r]){var p=0;for(var q in s){var u=parseInt(s[q]);if(u&&!isNaN(u)){o[p++]=u}}Parameters.filter[r]=o;Parameters.filter.idCategories=o}}else{Parameters.filter[r]=decodeURIComponent(t[r])}}m.DispatchEvent("w.change.route")}m.DispatchEvent("SearchR.show.form")}function k(){m.AddEvent("SearchR.show.form",function(){if(g.showForm){$("#"+g.container.form.widget).html("");m.BaseLoad.Roots(function(){m.DispatchEvent("SearchR.onload.roots.show.form")})}else{m.WidgetLoader(true,g.container.form.widget)}});m.AddEvent("SearchR.onload.roots.show.form",function(o){m.BaseLoad.Tmpl(g.tmpl.form,function(){l();if(Routing.route!="search"){Parameters.SetDefaultFilterParameters()}j();m.WidgetLoader(true,g.container.form.widget)})});m.AddEvent("SearchR.submit.form",function(s){var o=g.paging;var u=(Routing.GetCurrentPage()-1)*o.itemsPerPage;var r=u+"/"+o.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var q=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var t=[];for(var p=0;p<=q.length-1;p++){if(Parameters.filter[q[p]]){t[p]=q[p]+"="+encodeURIComponent(Parameters.filter[q[p]])}}r=r+t.join("&");m.BaseLoad.SearchContent(Parameters.shopId,r,function(v){m.DispatchEvent("SearchR.onload.searchResult",v)})});m.AddEvent("SearchR.onload.searchResult",function(o){m.DispatchEvent("onload.breadCrumb.tmpl");e(o)});m.AddEvent("SearchR.fill.searchResult",function(o){n(o.typeView);f(o)});m.AddEvent("SearchR.fill.categories",function(o){b(o)});m.AddEvent("w.change.route",function(o){if(Routing.route=="search"){m.BaseLoad.Tmpl(g.tmpl.content,function(){m.DispatchEvent("SearchR.submit.form")})}m.DispatchEvent("SearchR.show.form")})}function d(){$("#"+g.container.form.widget).empty().html("")}function l(){d();m.AppendContainer(g,false,"form",g.container.form.widget)}function a(){$("#"+g.container.content.widget).empty().html("")}function n(p){a();var o=g.container.content.widget;if(p=="table"){m.AppendContainer(g,"table","content",o)}if(p=="list"){m.AppendContainer(g,"list","content",o)}if(p=="tile"){m.AppendContainer(g,"tile","content",o)}if(p=="error"){m.AppendContainer(g,"empty","content",o)}}function j(){var o=new AdvancedSearchFormViewModel(g);m.BaseLoad.Roots(function(p){o.AddCategories(p)})}function e(o){m.BaseLoad.Script(PokupoWidgets.model.content,function(){var p=new ListSearchResultViewModel(g);p.AddContent(o)})}function b(o){if(ko.global){ko.global.route=Routing.route}else{ko.global={route:Routing.route}}m.RenderTemplate(o,g,null,function(p){l();b(p)},function(){d()},null,null,"form")}function f(o){m.RenderTemplate(o,g,null,function(p){n(p.typeView);f(p)},function(){a()},o.typeView,null,"content")}};var AdvancedSearchFormViewModel=function(e){var a=this,d=Parameters.filter;a.keyWords=d.keyWords;a.idCategories=d.idCategories;a.typeSearch=ko.observable();a.typeSearch(d.typeSearch);a.startCost=d.startCost;a.endCost=d.endCost;a.exceptWords=d.exceptWords;a.typeSeller=ko.observable();a.typeSeller(d.typeSeller);a.showCatalog=e.showCatalog;a.categories=[];a.typesSearch=ko.observableArray();a.typesSellers=ko.observableArray();a.typeCategories=[];a.cssTypeSearch="advancedSearchTypeSearch";a.cssTypeSeller="advancedSearchTypeSeller";a.cachData={};a.AddCategories=function(i){a.cachData=i;if(a.idCategories&&a.idCategories.length==1){f(i,a.idCategories)}a.categories=c(i).children;Parameters.cache.categories=a.categories;EventDispatcher.DispatchEvent("SearchR.fill.categories",a)};a.SubmitAdvancedSearchForm=function(i){Loader.Indicator("SearchResultWidget",false);a.keyWords=$(i.keyWords).val();a.startCost=$(i.startCost).val();a.endCost=$(i.endCost).val();a.exceptWords=$(i.exceptWords).val();Parameters.filter.idCategories=a.idCategories=[];f(a.cachData,Parameters.filter.idSelectCategories);if(a.idCategories.length>0){Parameters.filter.idCategories=a.idCategories.join(",")}Parameters.filter.keyWords=a.keyWords;Parameters.filter.typeSearch=a.typeSearch();Parameters.filter.startCost=a.startCost;Parameters.filter.endCost=a.endCost;Parameters.filter.exceptWords=a.exceptWords;Parameters.filter.typeSeller=a.typeSeller();Parameters.filter.page=1;Routing.SetHash("search","Расширенный поиск",Parameters.filter)};b(e.listTypeSearch,a.typesSearch);h(e.listTypeSeller,a.typesSellers);function c(o,i){var l=[];var p=false;for(var k=0;k<=o.length-1;k++){var n={};n.select=false;if($.inArray(o[k].id,Parameters.filter.idSelectCategories)>=0||i==true){n.select=true;p=true}if(o[k].children){var m=c(o[k].children,n.select);n.children=m.children;n.expand=m.active;n.isFolder=true}n.key=o[k].id;n.title=o[k].name_category;l.push(n);a.typeCategories[o[k].id]=o[k].type_category}return{children:l,active:p}}function b(i,k){for(var j in i){k.push(new AdvancedSearchFormTypeSearchViewModel({key:j,title:i[j]},a))}}function h(i,k){for(var j in i){k.push(new AdvancedSearchFormTypeSellerViewModel({key:j,title:i[j]},a))}}function f(n,m){for(var l=0;l<=n.length-1;l++){if(m){for(var k=0;k<=m.length;k++){if(n[l].id==m[k]&&n[l].children){g(n[l].children);break}else{if(n[l].children){f(n[l].children,m)}else{if(n[l].id==m[k]){if($.inArray(n[l].id,a.idCategories)<0){a.idCategories.push(n[l].id)}}}}}}}}function g(k){for(var j=0;j<=k.length-1;j++){if(k[j].type_category=="category"){if($.inArray(k[j].id,a.idCategories)<0){a.idCategories.push(k[j].id)}}if(k[j].children){g(k[j].children)}}}};var AdvancedSearchFormTypeSearchViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSearch(a.key)}};var AdvancedSearchFormTypeSellerViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSeller(a.key)}};var ListSearchResultViewModel=function(b){var a=this;a.id=0;a.titleBlock="Расширенный поиск";a.typeView="tile";a.countGoods=0;a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortSearchResultListViewModel();c.AddContent(b.sortList);c.SetDefault(Parameters.filter.orderBy);return c};a.filters={typeView:a.typeView,sort:a.GetSort(),filterName:ko.observable(Parameters.filter.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),FilterNameGoods:function(c){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=$(c.text).val();Routing.UpdateHash({page:1,filterName:$(c.text).val()})},ClickFilterNameGoods:function(){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=a.filters.filterName();Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("SearchResultWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)}}};a.AddContent=function(h){a.content=ko.observableArray();if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}if(h&&h.length>1){var e=h.shift();a.countGoods=parseInt(e.count_goods);var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e)}if(a.countGoods==0){a.typeView="error"}a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("SearchR.fill.searchResult",a)};a.GetQueryHash=function(){var g=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var e=g+"/"+b.paging.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var d=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var f=[];for(var c=0;c<=d.length-1;c++){if(Parameters.filter[d[c]]){f[c]=d[c]+"="+encodeURIComponent(Parameters.filter[d[c]])}}e=e+f.join("&");return Parameters.shopId+EventDispatcher.HashCode(e)};a.AddPages=function(){var c=function(){Loader.Indicator("SearchResultWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortSearchResultItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("SearchResultWidget",false);Parameters.filter.orderBy=a.name;Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortSearchResultListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_search_result_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortSearchResultItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestSearchResult={Init:function(){if(typeof Widget=="function"){SearchResultWidget.prototype=new Widget();var a=new SearchResultWidget();a.Init(a)}else{setTimeout(function(){TestSearchResult.Init()},100)}}};TestSearchResult.Init();