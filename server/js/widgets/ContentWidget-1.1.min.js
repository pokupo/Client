var ContentWidget=function(){function t(){e(),c(),n()}function e(){var t=h.GetInputParameters("content");if(!$.isEmptyObject(t)){if(y=h.UpdateSettings1(y,t),t.hasOwnProperty("showCart")&&(y.showCart=t.showCart),t.block){var e=t.block;if(e.hasOwnProperty("showBlocks")&&(y.showBlocks=e.showBlocks),e.count&&(y.countGoodsInBlock=e.count),e.animate&&(y.animate.block=e.animate),e.tmpl&&(e.tmpl.path&&(y.tmpl.block.path=e.tmpl.path),e.tmpl.id))for(var n in e.tmpl.id)y.tmpl.block.id[n]=e.tmpl.id[n];if(e.container)for(var n in e.container)y.container.block[n]=e.container[n]}if(t.content){var o=t.content;o.defaultCount&&(y.paging.itemsPerPage=o.defaultCount),o.list&&(y.listPerPage=o.list),o.animate&&(y.animate.content=o.animate)}}Config.Content=y}function n(){"catalog"==Routing.route||Routing.IsDefault()?h.BaseLoad.Roots(function(){o()}):h.WidgetLoader(!0)}function o(){if(Routing.IsCategory())h.HasDefaultContent("content","content")&&Routing.IsDefault()?h.WidgetLoader(!0):i();else if(Routing.IsDefault()){var t=Parameters.cache.roots[0];if(Config.Base.defaultSection=t.id,"section"!=t.type_category)i();else if(y.showBlocks)a();else if(y.showBlocks)h.WidgetLoader(!0);else{var e=t.children,n=null;$.each(e,function(t){return"category"==e[t].type_category?(n=e[t],!1):void 0}),n?Routing.SetHash("catalog",n.name_category,{section:t.id,category:n.id}):h.WidgetLoader(!0)}}else y.showBlocks?h.HasDefaultContent("content","block")&&Routing.IsDefault()?h.WidgetLoader(!0):a():h.WidgetLoader(!0)}function i(){h.BaseLoad.Tmpl(y.tmpl.content,function(){EventDispatcher.DispatchEvent("onload.content.tmpl")})}function a(){h.BaseLoad.Tmpl(y.tmpl.block,function(){EventDispatcher.DispatchEvent("onload.blockContent.tmpl")})}function c(){h.AddEvent("onload.blockContent.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Blocks(Routing.GetActiveCategory(),function(t){h.CheckData(t)})})}),h.AddEvent("onload.content.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Info(Routing.GetActiveCategory(),function(){r(),h.DispatchEvent("contentWidget.load.categoryInfo")})})}),h.AddEvent("contentWidget.load.categoryInfo",function(){var t=(Routing.GetCurrentPage()-1)*y.paging.itemsPerPage,e=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):y.orderBy,n=t+"/"+y.paging.itemsPerPage+"/"+e+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));h.BaseLoad.Content(Routing.params.category,n,function(t){p(t)})}),h.AddEvent("contentWidget.fill.block",function(t){m(t)}),h.AddEvent("contentWidget.fill.listContent",function(t){g(t.typeView),f(t)}),h.AddEvent("w.change.route",function(){n()}),h.AddEvent("contentWidget.click.category",function(){$("script#contentTileTmpl").length<0?h.BaseLoad.Tmpl(y.tmplForContent,function(){h.DispatchEvent("onload.content.tmpl")}):h.DispatchEvent("onload.content.tmpl")})}function l(t,e){$("#"+y.container.block[t].widget+" .promoBlocks:last").attr("id","block_sort_"+e)}function r(){$("#"+y.container.block.slider.widget).html(""),$("#"+y.container.block.carousel.widget).html(""),$("#"+y.container.block.tile.widget).html(""),$("#"+y.container.content.widget).html("")}function s(t,e){"slider"==e&&(h.AppendContainer(y,"slider","block",y.container.block.slider.widget),l("slider",t)),"carousel"==e&&(h.AppendContainer(y,"carousel","block",y.container.block.carousel.widget),l("carousel",t)),"tile"==e&&(h.AppendContainer(y,"tile","block",y.container.block.tile.widget),l("tile",t)),"no_results"==e&&h.AppendContainer(y,"empty","block",y.container.block.empty.widget),"categoriesNotCreated"==e&&$("#"+y.container.block.empty.widget).html('<p style="margin-top: 40px">'+y.message.categoriesNotCreated+"</p>").children().hide()}function d(){$("#"+y.container.content.widget).html("")}function g(t){d(),"table"==t&&h.AppendContainer(y,"table","content",y.container.content.widget),"list"==t&&h.AppendContainer(y,"list","content",y.container.content.widget),"tile"==t&&h.AppendContainer(y,"tile","content",y.container.content.widget),"no_results"==t&&h.AppendContainer(y,"empty","content",y.container.content.widget)}function u(t){var e=new BlockViewModel(t,y);e.AddContent()}function p(t){if(0!=t.content[0].count_goods){var e=new ListContentViewModel(y);e.AddCategoryInfo(t.categoryId),e.AddContent(t.content)}else{var e=new ListContentViewModel(y);e.AddCategoryInfo(t.categoryId),""!=e.filters.filterName()?(e.SetType("no_results"),e.SetMessage(y.message.filter.replace(/%%filterName%%/g,e.filters.filterName()))):(e.SetType("no_results"),e.SetMessage(y.message.noGoods)),h.DispatchEvent("contentWidget.fill.listContent",e)}}function f(t){h.RenderTemplate(t,y,null,function(t){g(t.typeView),f(t)},function(){d()},t.typeView,null,"content")}function m(t){if($("#"+t.cssBlock).length>0)try{ko.cleanNode($("#"+t.cssBlock)[0]),ko.applyBindings(t,$("#"+t.cssBlock)[0]),w.block.push({type:t.typeView,data:t}),h.testBlock.ready=h.testBlock.ready+1,h.testBlock.IsReady()&&($.each(y.container.block,function(t){h.WidgetLoader(!0,y.container.block[t].widget)}),w.Do())}catch(e){h.Exception("Ошибка шаблона ["+h.GetTmplName1(y,t.typeView,"block")+"]",e),y.tmpl.custom?(delete y.tmpl.custom,h.BaseLoad.Tmpl(y.tmpl,function(){s(t.typeView),m(t)})):(d(),$.each(y.container.block,function(t){h.WidgetLoader(!0,y.container.block[t].widget)}))}else h.Exception("Ошибка. Не найден контейнер ["+t.cssBlock+"]"),$.each(y.container.block,function(t){h.WidgetLoader(!0,y.container.block[t].widget)});delete t}function k(t){h.RenderTemplate(t,y,function(){$("#"+y.container.block.empty.widget).children().show(),$.each(y.container.block,function(t){h.WidgetLoader(!0,y.container.block[t].widget)})},function(t){s(t.typeView),m(t)},function(){$.each(y.container.block,function(t){h.WidgetLoader(!0,y.container.block[t].widget)})},"empty",null,"block")}var h=this;h.widgetName="ContentWidget",h.version=1,h.minWidgetVersion=1,h.maxWidgetVersion=2,h.minTmplVersion=1,h.maxTmplVersion=2,h.InitWidget=t;var y={message:{noGoods:"В этом разделе товаров не найдено...",filter:'Товаров по ключу "%%filterName%%" не найдено',categoriesNotCreated:"Извините, но в магазине пока нет товаров для продажи."},container:{content:{widget:"content",def:"defaultContentWidgetId"},block:{slider:{widget:"sliderBlockId",def:"defaultSliderBlockId"},carousel:{widget:"carouselBlockId",def:"defaultSliderBlockId"},tile:{widget:"tileBlockId",def:"defaultTileBlockId"},empty:{widget:"emptyBlockId",def:"defaultEmptyBlockId"}}},tmpl:{content:{path:"contentTmpl.html",id:{table:"contentTableTmpl",list:"contentListTmpl",tile:"contentTileTmpl",empty:"contentNoResultsTmpl"}},block:{path:"blockTmpl.html",id:{slider:"blockSliderTmpl",carousel:"blockCaruselTmpl",tile:"blockTileTmpl",empty:"blockNoResultsTmpl"}}},countGoodsInBlock:6,listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],orderBy:"name",showCart:!0,showBlocks:!0,animate:{content:"function"==typeof AnimateContent?AnimateContent:null,block:"function"==typeof AnimateContent?AnimateContent:null},filterName:"",slider:[],paging:Config.Paging};h.testBlock={count:0,ready:0,IsReady:function(){return h.testBlock.count==h.testBlock.ready?!0:!1}},h.CheckData=function(t){if(r(),t.err||0==t)if("categoriesNotCreated"==t.err){var e=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"categoriesNotCreated"});s(0,e.typeView),k(e)}else{var e=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"no_results"});s(0,e.typeView),k(e)}else{h.testBlock.count=0,h.testBlock.ready=0,w.block=ko.observableArray();for(var n=0;n<=t.length-1;n++)if(t[n].count_goods>0){++h.testBlock.count,Parameters.cache.contentBlock[t[n].id]={sort:n,block:t[n]},s(n,t[n].type_view);var o="0/"+y.countGoodsInBlock+"/name/",i=t[n].id+EventDispatcher.HashCode(o);h.AddEvent("contentWidget.onload.content%%"+i,function(t){u(Parameters.cache.contentBlock[t.categoryId])}),h.BaseLoad.Content(t[n].id,o,function(t){h.DispatchEvent("contentWidget.onload.content%%"+i,t)})}}};var w={block:ko.observableArray(),Do:function(){if(Loader.IsReady()){var t=w.block();$.each(t,function(){y.animate.block&&y.animate.block()})}else setTimeout(function(){w.Do()},100)}}},EmptyViewBlock=function(t){var e=this;e.titleBlock=t.titleBlock,e.typeView=t.typeView},BlockViewModel=function(t,e){var n=this;n.countGoodsInContent=e.countGoodsInBlock,n.id=t.block.id,n.sort=t.sort,n.titleBlock=t.block.name_category,n.typeView=t.block.type_view,n.countGoods=t.block.count_goods?t.block.count_goods:0,n.showCart=e.showCart,n.cssBlock="block_sort_"+t.sort,n.cssBlockContainer="sliderContainer_"+n.id,n.imageHref="#",n.contentBlock=ko.observableArray(),n.AddContent=function(){var t="0/"+n.countGoodsInContent+"/name/",e=n.id+EventDispatcher.HashCode(t),o=Parameters.cache.content[e].content;if(o&&o.length>1){var i=o.shift();n.countGoods=i.count_goods,o.length<n.countGoodsInContent&&(n.countGoodsInContent=o.length);for(var a=0,c=0;c<=n.countGoodsInContent-1;c++)if("tile"==n.typeView){for(var l=new BlockTrForTableViewModel,r=0;2>=r&&o[a];r++)l.AddStr(new ContentViewModel(o[a],a)),a++;l.str().length>0&&n.contentBlock.push(l),delete l}else n.contentBlock.push(new ContentViewModel(o[c],c));o.unshift(i),EventDispatcher.DispatchEvent("contentWidget.fill.block",n)}else EventDispatcher.DispatchEvent("contentWidget.fill.block",n)},n.ClickCategory=function(){Routing.SetHash("catalog",n.titleBlock,{category:t.block.id})}},ListContentViewModel=function(t){var e=this;e.id=0,e.titleBlock="",e.typeView="tile",e.countGoods=0,e.message="",e.showCart=t.showCart,e.content=ko.observableArray(),e.paging=ko.observableArray(),e.GetSort=function(){var e=new SortContentListViewModel;return e.AddContent(Config.Content.sortList),e.SetDefault(Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):t.orderBy),e},e.filters={typeView:e.typeView,filterName:ko.observable(Routing.GetMoreParameter("filterName")?Routing.GetMoreParameter("filterName"):t.filterName),itemsPerPage:t.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(t.listPerPage.length-1),sort:e.GetSort(),FilterNameGoods:function(n){t.filterName=e.filters.filterName($(n.text).val()),Loader.Indicator("ContentWidget",!1),Routing.UpdateMoreParameters({filterName:e.filters.filterName()}),Routing.UpdateHash({page:1})},ClickFilterNameGoods:function(){t.filterName=e.filters.filterName(),Loader.Indicator("ContentWidget",!1),Routing.UpdateMoreParameters({filterName:e.filters.filterName()}),Routing.UpdateHash({page:1})},ViewSelectCount:function(){e.filters.listPerPage=ko.observableArray();for(var n in t.listPerPage){if(!(t.listPerPage[n]<e.countGoods)){e.filters.listPerPage.push(t.listPerPage[n]);break}e.filters.listPerPage.push(t.listPerPage[n])}1==e.filters.listPerPage().length&&(e.filters.listPerPage=ko.observableArray())},SelectCount:function(n){Loader.Indicator("ContentWidget",!1),e.filters.itemsPerPage=t.paging.itemsPerPage=n,Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){e.typeView="tile",e.filters.typeView="tile",Parameters.cache.typeView="tile",e.AddContent(Parameters.cache.content[e.GetQueryHash()].content),EventDispatcher.DispatchEvent("contentWidget.fill.listContent",e)},ClickTable:function(){e.typeView="table",e.filters.typeView="table",Parameters.cache.typeView="table",e.AddContent(Parameters.cache.content[e.GetQueryHash()].content),EventDispatcher.DispatchEvent("contentWidget.fill.listContent",e)},ClickList:function(){e.typeView="list",e.filters.typeView="list",Parameters.cache.typeView="list",e.AddContent(Parameters.cache.content[e.GetQueryHash()].content),EventDispatcher.DispatchEvent("contentWidget.fill.listContent",e)}}},e.SetType=function(t){e.typeView=t},e.SetMessage=function(t){e.message=t},e.AddCategoryInfo=function(t){var n=Parameters.cache.infoCategory[t];if(e.id=n.id,e.titleBlock=n.name_category,Parameters.cache.typeView)e.typeView=Parameters.cache.typeView,e.filters.typeView=Parameters.cache.typeView;else if(n.type_view){var o=n.type_view;if("carousel"==n.type_view||"slider"==n.type_view)var o="tile";e.typeView=o,e.filters.typeView=o}},e.AddContent=function(t){if(e.content=ko.observableArray(),t&&t.length>1){var n=t.shift();e.countGoods=n.count_goods;for(var o=0,i=0;i<=t.length-1;i++)if("tile"==e.typeView){for(var a=new BlockTrForTableViewModel,c=0;3>=c&&t[o];c++)a.AddStr(new ContentViewModel(t[o],o)),o++;a.str().length>0&&e.content.push(a),delete a}else e.content.push(new ContentViewModel(t[i],i));e.AddPages(),t.unshift(n),e.filters.ViewSelectCount(),EventDispatcher.DispatchEvent("contentWidget.fill.listContent",e)}},e.GetQueryHash=function(){var e=(Routing.GetCurrentPage()-1)*t.paging.itemsPerPage,n=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):t.orderBy,o=e+"/"+t.paging.itemsPerPage+"/"+n+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));return Routing.GetActiveCategory()+EventDispatcher.HashCode(o)},e.AddPages=function(){var n=function(){Loader.Indicator("ContentWidget",!1),Routing.UpdateHash({page:this.pageId})};e.paging=Paging.GetPaging(e.countGoods,t,n)}},SortContentItemViewModel=function(t,e){var n=this;n.name=t.name,n.title=t.title,n.isActive=!1,n.ClickSort=function(){$.each(e.list(),function(t){e.list()[t].isActive=!1}),e.activeItem(n),n.isActive=!0,Loader.Indicator("ContentWidget",!1),Routing.UpdateMoreParameters({orderBy:n.name}),Routing.UpdateHash({page:1})}},SortContentListViewModel=function(){var t=this;t.activeItem=ko.observable(),t.list=ko.observableArray(),t.cssSortList="sort_list",t.AddContent=function(e){$.each(e,function(n){t.list.push(new SortContentItemViewModel(e[n],t))})},t.SetDefault=function(e){$.each(t.list(),function(n){t.list()[n].name==e?(t.activeItem(t.list()[n]),t.list()[n].isActive=!0):t.list()[n].isActive=!1})}},TestContent={Init:function(){if("function"==typeof Widget){ContentWidget.prototype=new Widget;var t=new ContentWidget;t.Init(t)}else setTimeout(function(){TestContent.Init()},100)}};TestContent.Init();