var ContentWidget=function(){var h=this;h.widgetName="ContentWidget";h.version=1;h.minWidgetVersion=1;h.maxWidgetVersion=2;h.minTmplVersion=1;h.maxTmplVersion=2;h.InitWidget=d;var n={message:{noGoods:"В этом разделе товаров не найдено...",filter:'Товаров по ключу "%%filterName%%" не найдено',categoriesNotCreated:"Извините, но в магазине пока нет товаров для продажи."},container:{content:{widget:"content",def:"defaultContentWidgetId"},block:{slider:{widget:"sliderBlockId",def:"defaultSliderBlockId"},carousel:{widget:"carouselBlockId",def:"defaultSliderBlockId"},tile:{widget:"tileBlockId",def:"defaultTileBlockId"},empty:{widget:"emptyBlockId",def:"defaultEmptyBlockId"}}},tmpl:{content:{path:"contentTmpl.html",id:{table:"contentTableTmpl",list:"contentListTmpl",tile:"contentTileTmpl",empty:"contentNoResultsTmpl"}},block:{path:"blockTmpl.html",id:{slider:"blockSliderTmpl",carousel:"blockCaruselTmpl",tile:"blockTileTmpl",empty:"blockNoResultsTmpl"}}},countGoodsInBlock:6,listPerPage:[10,20,50],sortList:[{name:"rating",title:"рейтингу"},{name:"name",title:"названию"},{name:"cost",title:"цене"}],orderBy:"name",showCart:true,showBlocks:true,animate:{content:typeof AnimateContent=="function"?AnimateContent:null,block:typeof AnimateContent=="function"?AnimateContent:null},filterName:"",slider:[],paging:Config.Paging};h.testBlock={count:0,ready:0,IsReady:function(){if(h.testBlock.count==h.testBlock.ready){return true}return false}};function d(){s();f();g()}function s(){var v=h.GetInputParameters("content");if(!$.isEmptyObject(v)){n=h.UpdateSettings1(n,v);if(v.hasOwnProperty("showCart")){n.showCart=v.showCart}if(v.block){var y=v.block;if(y.hasOwnProperty("showBlocks")){n.showBlocks=y.showBlocks}if(y.count){n.countGoodsInBlock=y.count}if(y.animate){n.animate.block=y.animate}if(y.tmpl){if(y.tmpl.path){n.tmpl.block.path=y.tmpl.path}if(y.tmpl.id){for(var w in y.tmpl.id){n.tmpl.block.id[w]=y.tmpl.id[w]}}}if(y.container){for(var w in y.container){n.container.block[w]=y.container[w]}}}if(v.content){var x=v.content;if(x.defaultCount){n.paging.itemsPerPage=x.defaultCount}if(x.list){n.listPerPage=x.list}if(x.animate){n.animate.content=x.animate}}}Config.Containers.content=n.container}function g(){if(Routing.route=="catalog"||Routing.IsDefault()){h.BaseLoad.Roots(function(){c()})}else{h.WidgetLoader(true)}}function c(){if(Routing.IsCategory()){if(!h.HasDefaultContent("content","content")||!Routing.IsDefault()){e()}else{h.WidgetLoader(true)}}else{if(Routing.IsDefault()){var v=Parameters.cache.roots[0];Config.Base.defaultSection=v.id;if(v.type_category!="section"){e()}else{if(n.showBlocks){p()}else{if(!n.showBlocks){var w=v.children;var x=null;$.each(w,function(y){if(w[y].type_category=="category"){x=w[y];return false}});if(x){Routing.SetHash("catalog",x.name_category,{section:v.id,category:x.id})}else{h.WidgetLoader(true)}}else{h.WidgetLoader(true)}}}}else{if(n.showBlocks){if(!h.HasDefaultContent("content","block")||!Routing.IsDefault()){p()}else{h.WidgetLoader(true)}}else{h.WidgetLoader(true)}}}}function e(){h.BaseLoad.Tmpl(n.tmpl.content,function(){EventDispatcher.DispatchEvent("onload.content.tmpl")})}function p(){h.BaseLoad.Tmpl(n.tmpl.block,function(){EventDispatcher.DispatchEvent("onload.blockContent.tmpl")})}function f(){h.AddEvent("onload.blockContent.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Blocks(Routing.GetActiveCategory(),function(v){h.CheckData(v)})})});h.AddEvent("onload.content.tmpl",function(){h.BaseLoad.Script(PokupoWidgets.model.content,function(){h.BaseLoad.Info(Routing.GetActiveCategory(),function(v){b();h.DispatchEvent("contentWidget.load.categoryInfo")})})});h.AddEvent("contentWidget.load.categoryInfo",function(){var x=(Routing.GetCurrentPage()-1)*n.paging.itemsPerPage;var w=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):n.orderBy;var v=x+"/"+n.paging.itemsPerPage+"/"+w+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));h.BaseLoad.Content(Routing.params.category,v,function(y){r(y)})});h.AddEvent("contentWidget.fill.block",function(v){j(v)});h.AddEvent("contentWidget.fill.listContent",function(v){q(v.typeView);o(v)});h.AddEvent("w.change.route",function(v){g()});h.AddEvent("contentWidget.click.category",function(v){if($("script#contentTileTmpl").length<0){h.BaseLoad.Tmpl(n.tmplForContent,function(){h.DispatchEvent("onload.content.tmpl")})}else{h.DispatchEvent("onload.content.tmpl")}})}h.CheckData=function(y){b();if(y.err||y==false){if(y.err=="categoriesNotCreated"){var z=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"categoriesNotCreated"});k(0,z.typeView);a(z)}else{var z=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"no_results"});k(0,z.typeView);a(z)}}else{h.testBlock.count=0;h.testBlock.ready=0;m.block=ko.observableArray();for(var w=0;w<=y.length-1;w++){if(y[w].count_goods>0){++h.testBlock.count;Parameters.cache.contentBlock[y[w].id]={sort:w,block:y[w]};k(w,y[w].type_view);var x="0/"+n.countGoodsInBlock+"/name/";var v=y[w].id+EventDispatcher.HashCode(x);h.AddEvent("contentWidget.onload.content%%"+v,function(A){u(Parameters.cache.contentBlock[A.categoryId])});h.BaseLoad.Content(y[w].id,x,function(A){h.DispatchEvent("contentWidget.onload.content%%"+v,A)})}}}};function i(w,v){$("#"+n.container.block[w].widget+" .promoBlocks:last").attr("id","block_sort_"+v)}function b(){$("#"+n.container.block.slider.widget).html("");$("#"+n.container.block.carousel.widget).html("");$("#"+n.container.block.tile.widget).html("");$("#"+n.container.content.widget).html("")}function k(v,w){if(w=="slider"){h.AppendContainer(n,"slider","block",n.container.block.slider.widget);i("slider",v)}if(w=="carousel"){h.AppendContainer(n,"carousel","block",n.container.block.carousel.widget);i("carousel",v)}if(w=="tile"){h.AppendContainer(n,"tile","block",n.container.block.tile.widget);i("tile",v)}if(w=="no_results"){h.AppendContainer(n,"empty","block",n.container.block.empty.widget)}if(w=="categoriesNotCreated"){$("#"+n.container.block.empty.widget).html('<p style="margin-top: 40px">'+n.message.categoriesNotCreated+"</p>").children().hide()}}function l(){$("#"+n.container.content.widget).html("")}function q(v){l();if(v=="table"){h.AppendContainer(n,"table","content",n.container.content.widget)}if(v=="list"){h.AppendContainer(n,"list","content",n.container.content.widget)}if(v=="tile"){h.AppendContainer(n,"tile","content",n.container.content.widget)}if(v=="no_results"){h.AppendContainer(n,"empty","content",n.container.content.widget)}}function u(v){var w=new BlockViewModel(v,n);w.AddContent()}function r(w){if(w.content[0].count_goods!=0){var v=new ListContentViewModel(n);v.AddCategoryInfo(w.categoryId);v.AddContent(w.content)}else{var v=new ListContentViewModel(n);v.AddCategoryInfo(w.categoryId);if(v.filters.filterName()!=""){v.SetType("no_results");v.SetMessage(n.message.filter.replace(/%%filterName%%/g,v.filters.filterName()))}else{v.SetType("no_results");v.SetMessage(n.message.noGoods)}h.DispatchEvent("contentWidget.fill.listContent",v)}}var m={block:ko.observableArray(),Do:function(){if(Loader.IsReady()){var v=m.block();$.each(v,function(w){if(n.animate.block){n.animate.block()}})}else{setTimeout(function(){m.Do()},100)}}};function o(v){h.RenderTemplate(v,n,null,function(w){q(w.typeView);o(w)},function(){l()},v.typeView,null,"content")}function j(v){if($("#"+v.cssBlock).length>0){try{ko.cleanNode($("#"+v.cssBlock)[0]);ko.applyBindings(v,$("#"+v.cssBlock)[0]);m.block.push({type:v.typeView,data:v});h.testBlock.ready=h.testBlock.ready+1;if(h.testBlock.IsReady()){$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)});m.Do()}}catch(w){h.Exception("Ошибка шаблона ["+h.GetTmplName1(n,v.typeView,"block")+"]",w);if(n.tmpl.custom){delete n.tmpl.custom;h.BaseLoad.Tmpl(n.tmpl,function(){k(v.typeView);j(v)})}else{l();$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)})}}}else{h.Exception("Ошибка. Не найден контейнер ["+v.cssBlock+"]");$.each(n.container.block,function(x){h.WidgetLoader(true,n.container.block[x].widget)})}delete v}function a(v){h.RenderTemplate(v,n,function(){$("#"+n.container.block.empty.widget).children().show();$.each(n.container.block,function(w){h.WidgetLoader(true,n.container.block[w].widget)})},function(w){k(w.typeView);j(w)},function(){$.each(n.container.block,function(w){h.WidgetLoader(true,n.container.block[w].widget)})},"empty",null,"block")}function t(v){h.RenderTemplate(v,n,null,function(w){q(w.typeView);t(w)},function(){b()},"empty",null,"content")}};var EmptyViewBlock=function(b){var a=this;a.titleBlock=b.titleBlock;a.typeView=b.typeView};var BlockViewModel=function(c,b){var a=this;a.countGoodsInContent=b.countGoodsInBlock;a.id=c.block.id;a.sort=c.sort;a.titleBlock=c.block.name_category;a.typeView=c.block.type_view;a.countGoods=c.block.count_goods?c.block.count_goods:0;a.showCart=b.showCart;a.cssBlock="block_sort_"+c.sort;a.cssBlockContainer="sliderContainer_"+a.id;a.imageHref="#";a.contentBlock=ko.observableArray();a.AddContent=function(){var m="0/"+a.countGoodsInContent+"/name/";var e=a.id+EventDispatcher.HashCode(m);var k=Parameters.cache.content[e].content;if(k&&k.length>1){var h=k.shift();a.countGoods=h.count_goods;if(k.length<a.countGoodsInContent){a.countGoodsInContent=k.length}var l=0;for(var g=0;g<=a.countGoodsInContent-1;g++){if(a.typeView=="tile"){var n=new BlockTrForTableViewModel();for(var d=0;d<=2;d++){if(k[l]){n.AddStr(new ContentViewModel(k[l],l));l++}else{break}}if(n.str().length>0){a.contentBlock.push(n)}delete n}else{a.contentBlock.push(new ContentViewModel(k[g],g))}}k.unshift(h);EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}else{EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}};a.ClickCategory=function(){Routing.SetHash("catalog",a.titleBlock,{category:c.block.id})}};var ListContentViewModel=function(b){var a=this;a.id=0;a.titleBlock="";a.typeView="tile";a.countGoods=0;a.message="";a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortContentListViewModel();c.AddContent(b.sortList);c.SetDefault(Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderBy);return c};a.filters={typeView:a.typeView,filterName:ko.observable(Routing.GetMoreParameter("filterName")?Routing.GetMoreParameter("filterName"):b.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),sort:a.GetSort(),FilterNameGoods:function(c){b.filterName=a.filters.filterName($(c.text).val());Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ClickFilterNameGoods:function(){b.filterName=a.filters.filterName();Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("ContentWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}}};a.SetType=function(c){a.typeView=c};a.SetMessage=function(c){a.message=c};a.AddCategoryInfo=function(e){var d=Parameters.cache.infoCategory[e];a.id=d.id;a.titleBlock=d.name_category;if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}else{if(d.type_view){var c=d.type_view;if(d.type_view=="carousel"||d.type_view=="slider"){var c="tile"}a.typeView=c;a.filters.typeView=c}}};a.AddContent=function(h){a.content=ko.observableArray();if(h&&h.length>1){var e=h.shift();a.countGoods=e.count_goods;var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e);a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}};a.GetQueryHash=function(){var e=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var d=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderBy;var c=e+"/"+b.paging.itemsPerPage+"/"+d+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));return Routing.GetActiveCategory()+EventDispatcher.HashCode(c)};a.AddPages=function(){var c=function(){Loader.Indicator("ContentWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortContentItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortContentListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortContentItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestContent={Init:function(){if(typeof Widget=="function"){ContentWidget.prototype=new Widget();var a=new ContentWidget();a.Init(a)}else{setTimeout(function(){TestContent.Init()},100)}}};TestContent.Init();