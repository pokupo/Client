var JSSettings={shopId:0,protocolHTTP:"https://",protocolHTTPS:"https://",host:"server.pokupo.ru/prod/server/",pathToJS:"js/",pathToTmpl:"pokupo.ru/themes/",theme:"default",pathToData:"prod/server/services/DataProxy.php?query=",pathToPostData:"prod/server/services/DataPostProxy.php",pathToCore:"index.html",pathToPostCore:"postData.html",hostApi:"api.pokupo.ru/",catalogPathApi:"catalog/",goodsPathApi:"goods/",userPathApi:"user/",cartPathApi:"cart/",favPathApi:"fav/",geoPathApi:"geo/",shopPathApi:"shop/",orderPathApi:"order/",paymentPathApi:"payment/",messagePathApi:"message/",dev:false,sourceData:"api",devScripts:["easyXDM.min.js","knockout-3.2.0.js","jquery.cookie.js","jquery.textchange.min.js","widgets/Config-1.1.js","widgets/Routing-1.0.js","widgets/Paging-1.0.js","widgets/Widget-1.1.js"],scripts:["widgets/widgets.lib.min.js"],inputParameters:{}};var EventDispatcher={events:[],AddEventListener:function(a,b){this.events[a]=this.events[a]||[];if(this.events[a]){this.RemoveEventListener(a,b);this.events[a].push(b)}},RemoveEventListener:function(d,e){if(this.events[d]){var c=this.events[d];var a=EventDispatcher.HashCode(e.toString());for(var b=c.length-1;b>=0;--b){if(EventDispatcher.HashCode(c[b].toString())===a){c.splice(b,1);return true}}}return false},DispatchEvent:function(c,d){if(this.events[c]){var b=this.events[c],a=b.length;while(a--){b[a](d)}}},HashCode:function(d){var c=0,a,b;if(d.length==0){return c}for(a=0;a<d.length;a++){b=d.charCodeAt(a);c=((c<<5)-c)+b;c=c&c}return c},GetUUID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)});return a}};var JSLoader={loaded:false,loadedCount:0,pathToJs:null,Init:function(a,b){this.pathToJs=b;JSLoader.Load(a,function(){JSLoader.RegisterLoaded(a)})},RegisterLoaded:function(a){JSLoader.loadedCount=JSLoader.loadedCount+1;if(JSLoader.loadedCount==a.length){JSLoader.OnReady()}},OnReady:function(){if(typeof ko=="object"){JSLoader.loaded=true;EventDispatcher.DispatchEvent("onload.scripts")}else{setTimeout(function(){JSLoader.OnReady()},100)}},Load:function(a,c){for(var b in a){$.getScript(this.pathToJs+a[b],function(){if(c){c()}})}}};var JSCore={version:1.2,isReady:false,shopId:null,dev:false,Init:function(){if(document.location.protocol=="https:"){JSSettings.protocolHTTP=JSSettings.protocolHTTPS}JSCore.SetInputParameters();var a=JSSettings.scripts;if(JSSettings.dev){a=JSSettings.devScripts}JSLoader.Init(a,JSSettings.protocolHTTP+JSSettings.host+JSSettings.pathToJS);JSCore.shopId=JSSettings.shopId;XDMTransport.Init(JSSettings.host+JSSettings.pathToCore);JSCore.isReady=true},ParserInputParameters:function(f){var e={};var a=$("script").filter(function(){return f.test($(this).attr("src"))}).attr("src");if(a){var b=a.split("?");if(b.length>1){var d=b[1].split("&");for(var c=0;c<=d.length-1;c++){var g=d[c].split("=");e[g[0]]=g[1]}}}if(e){return e}return null},SetInputParameters:function(){var a=JSCore.ParserInputParameters(/JSCore/);if($.isEmptyObject(a)){a=JSCore.ParserInputParameters(/pokupo.widgets.[a-z0-9]{32}.min.js/)}if(a){for(var b in a){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=a[b]}}}if(typeof WParameters!=="undefined"&&WParameters.core){for(var b in WParameters.core){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=WParameters.core[b]}}}JSSettings.inputParameters.shopId=JSSettings.shopId}};var XDMTransport={remote:"",event:{},Init:function(a){XDMTransport.remote=a},GetProtocol:function(a){if(a){return JSSettings.protocolHTTPS}else{return JSSettings.protocolHTTP}},EventExecute:function(b,a){$.each(XDMTransport.event[a],function(c){XDMTransport.event[a][c](b)});delete XDMTransport.event[a]},Load:{FromProxy:function(b){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Socket({remote:XDMTransport.GetProtocol(b.protocol)+XDMTransport.remote,onMessage:function(c){if(b.callback){b.callback(c)}}});a.postMessage(JSSettings.pathToData+b.url)}else{setTimeout(function(){XDMTransport.Load.FromProxy(b)},1000)}},FromApi:function(a){$.ajax({type:"GET",async:true,url:decodeURIComponent(a.url),dataType:a.type,success:function(b){if(a.callback){a.callback(b)}}})},Tmpl:function(b,c){var a=XDMTransport.GetProtocol()+JSSettings.pathToTmpl+JSSettings.theme+"/tmpl/"+b;if(/^(https?|ftp)\:\/\/(www\.)?([a-zA-Z0-9\.\-]+\.[a-z]{2,})(\/.+)$/.test(b)){a=b}XDMTransport.Load.FromProxy({url:a,callback:c,protocol:null})},Data:function(a,d,c){c=JSSettings.protocolHTTPS;var b=EventDispatcher.HashCode(a+d.toString());if(XDMTransport.event[b]==undefined){XDMTransport.event[b]=[]}XDMTransport.event[b].push(d);if(XDMTransport.event[b].length==1){if(JSSettings.sourceData=="api"){XDMTransport.Load.FromApi({type:"jsonp",url:decodeURIComponent(a),callback:function(e){XDMTransport.EventExecute(e,b)}})}if(JSSettings.sourceData=="proxy"){XDMTransport.Load.FromProxy({url:a,protocol:c,callback:function(e){XDMTransport.EventExecute(JSON.parse(e),b)}})}}},DataPost:function(b,c){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Rpc({remote:XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostCore,onReady:function(){b.attr("action",XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostData);b.submit()}},{local:{returnUploadResponse:function(d){EventDispatcher.DispatchEvent(EventDispatcher.HashCode(b.toString()),JSON.parse(d.msg))}}})}else{setTimeout(function(){XDMTransport.Load.DataPost(b,c)},1000)}}}};var Logger={Console:{Exception:function(b,d,c){console&&console.log("Exception : "+new Date()+" : "+b+" : "+d);if(c){var a="";if(c.message){a+=c.message}if(c.stack){a+=" | stack: "+c.stack}console&&console.log(a)}},Info:function(a,b){console&&console.log("Info : "+new Date()+" : "+a+" : "+b)},VarDump:function(b,a,c){console&&console.log("Var Dump : "+b+" : "+a);console&&console.log(c)}}};$().ready(function(){JSCore.Init()});
var StandalonePaymentWidget=function(){var a=this;a.widgetName="StandalonePaymentWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:{button:"",content:""},customContainer:null,tmpl:{path:null,id:{button:null,paymentList:null,content:null,error:null}},animate:null,inputParameters:{},containerButton:null,title:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:true,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",showButton:null,userParams:{}};a.InitWidget=function(){a.settings.containerId=Config.Containers.standalonePayment;a.settings.tmpl=Config.StandalonePayment.tmpl;a.settings.title=Config.StandalonePayment.title;a.settings.showButton=Config.StandalonePayment.showButton;a.CheckRouteStandalonePayment()};a.SetParameters=function(f){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/StandalonePaymentWidget/);if(b.standalonePayment){c=b.standalonePayment}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standalonePayment){c=WParameters.standalonePayment}if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Input parameters",c)}if(!$.isEmptyObject(c)){if(c.title){a.settings.title=c.title}else{a.settings.title=null}if(c.idGoods){a.settings.idGoods=c.idGoods;a.settings.showAmount=false}else{if(Routing.params.idGoods){a.settings.idGoods=Routing.params.idGoods;a.settings.showAmount=false}else{a.settings.idGoods=null;a.settings.idShop=JSSettings.shopId;a.settings.showCount=false}}if(c.count){a.settings.count=c.count;a.settings.showCount=false}else{if(Routing.params.count){a.settings.count=Routing.params.count;a.settings.showCount=false}else{a.settings.count=1;a.settings.showCount=false}}if(c.amount){a.settings.amount=c.amount;a.settings.showAmount=false}else{if(Routing.params.amount){a.settings.amount=Routing.params.amount;a.settings.showAmount=false}else{a.settings.amount=null;if(!a.settings.idGoods){a.settings.showAmount=true}}}if(c.uid){a.settings.uid=c.uid}if(Routing.params.uid){a.settings.uid=Routing.params.uid}if(c.idShopPartner){a.settings.idShopPartner=c.idShopPartner}if(Routing.params.idShopPartner){a.settings.idShopPartner=Routing.params.idShopPartner}if(c.mailUser){a.settings.mailUser=c.mailUser}else{if(Routing.params.mailUser){a.settings.mailUser=Routing.params.mailUser}}if(c.idMethodPayment){a.settings.idMethodPayment=c.idMethodPayment}if(Routing.params.idMethodPayment){a.settings.idMethodPayment=Routing.params.idMethodPayment}if(c.description){a.settings.description=c.description}if(Routing.params.description){a.settings.description=Routing.params.description}if(Routing.params.userParams){var e=decodeURIComponent(Routing.params.userParams);a.settings.userParams=e.replace(/(^\?)/,"").split("&").map(function(g){return g=g.split("="),this[g[0]]=g[1],this}.bind({}))[0]}if(c.userParams){$.each(c.userParams,function(h,g){a.settings.userParams[h]=g})}if(c.showButton){a.settings.showButton=c.showButton}if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){for(var d in c.tmpl.id){a.settings.tmpl.id[d]=c.tmpl.id[d]}}}if(c.container){if(c.container){for(var d in c.container){a.settings.containerId[d]=c.container[d]}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c;if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Result settings",a.settings)}};a.CheckRouteStandalonePayment=function(){a.SetParameters();a.RegisterEvents();a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(Routing.route=="standalone_payment"){if(a.settings.idGoods!=null){a.BaseLoad.GoodsInfo(a.settings.idGoods,"1000000",function(b){a.settings.goodsInfo=b;if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}})}if(a.settings.idShop!=null&&a.settings.idGoods==null){a.GetData.Service()}}else{if(a.settings.showButton&&Routing.route!="status_payment"){a.InsertContainer.Button();a.Fill.Button()}else{a.WidgetLoader(true)}}})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.select",function(b){a.settings.idMethodPayment=b.idMethodPayment();a.settings.paymentInfo=b.paymentInfo;a.settings.mailUser=b.mailUser();if(a.settings.idGoods!=null){a.settings.count=b.count();if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}}if(a.settings.idShop!=null){a.settings.amount=b.amount();a.GetData.Service()}});EventDispatcher.AddEventListener("StandalonePaymentWidget.back",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("w.change.route",function(){a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.clear",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.form.submit",function(c){a.InsertContainer.Content();var b=[];$.each(c.inData(),function(e){if(c.inData()[e].name()=="MOBILE_PHONE"){b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value().replace(/\s/g,"").replace(/-/g,"")))}else{b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value()))}});var d=b.join("&");if(Routing.params.orderId){d=Routing.params.orderId+"?"+d;a.GetData.Order(d)}if(Routing.params.goodsId){d=Routing.params.goodsId+"?"+d;a.GetData.Goods(d)}if(Routing.params.amount){d=Routing.params.amount+"/"+Parameters.shopId+"?"+d;a.GetData.Amount(d)}})};a.GetData={UserParametrs:function(){var b="";var c=[];$.each(a.settings.userParams,function(e,d){c.push(e+"="+d)});b=encodeURIComponent(encodeURIComponent(c.join("&")));return b},Price:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})},Goods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesGoods(c,function(d){a.Fill.PaymentList(d)})},PartnerGoods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesPartnerGoods(c,function(d){a.Fill.PaymentList(d)})},Service:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})}};a.InsertContainer={EmptyWidget:function(b){var c=$(b).find(a.SelectCustomContent().join(", ")).clone();$(b).empty().html(c)},Button:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);$("#"+a.settings.containerId.button.widget).html($("script#"+a.GetTmplName("button")).html())},PaymentList:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("paymentList")).html())},Content:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("content")).html()).hide()},Error:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("error")).html()).hide()}};a.Fill={Button:function(){var b=new StandaloneButtonPaymentViewModel(a.settings);a.Render.Button(b)},PaymentList:function(c){if(c.hasOwnProperty("err")){a.InsertContainer.Error();a.Fill.Error(c)}else{if(!c.hasOwnProperty("pay_form")){var b=new StandalonePaymentListViewModel(a.settings);b.error.base("");b.show.errorBase(false);if(c){$.each(c,function(d){a.settings.paymentList=true;b.payments.push(new StandalonePaymentItemViewModel(c[d],b))})}a.InsertContainer.PaymentList();a.Render.PaymentList(b)}else{a.InsertContainer.Content();a.Fill.Content(c)}}},Content:function(e){var d=new StandalonePaymentViewModel(a.settings);var f=[];var c={};if(e.pay_form){c=e.pay_form.hidden_field}var b=null;$.each(c,function(g){f.push(c[g].name+"="+encodeURIComponent(c[g].value));if(c[g].name=="PKP_ID_ORDER"){b=c[g].value}});if(b){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+b)}else{if(f){$.cookie(Config.Base.cookie.orderId,f.join("&"))}}d.paymentInfo=a.settings.paymentInfo;d.AddContent(e);a.Render.Content(d)},Error:function(c){var b=new StandalonePaymentErrorViewModel(c,a.settings);a.Render.Error(b)}};a.Render={Button:function(b){if($("#"+a.settings.containerId.button.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.button.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.button.widget)[0]);a.WidgetLoader(true,a.settings.containerId.button.widget);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("button")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Button();a.Render.Button(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);a.WidgetLoader(true,a.settings.containerId.button.widget)}}}else{a.WidgetLoader(true)}},PaymentList:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}if(a.settings.showAmount){$("#"+b.cssAmount).bind("textchange",function(e,d){var f=$(this).val();b.amount(f);a.settings.amount=f;setTimeout(function(){if(f==a.settings.amount){a.GetData.Price()}},500)});$("#"+b.cssAmount).focus()}$("#"+b.cssCount).bind("textchange",function(e,d){b.count($(this).val())})}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("paymentList")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.PaymentList()();a.Render.PaymentList(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Content:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$.each(b.inData(),function(d){if(b.inData()[d].mask()){$("#"+b.inData()[d].cssField()).mask(b.inData()[d].mask(),{placeholder:"_"})}});$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Error:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("error")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}}}};var StandaloneButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{})}};var StandalonePaymentListViewModel=function(c){var b=this;b.isGoodsId=ko.observable();b.title=ko.observable();b.count=ko.observable();b.amount=ko.observable();b.formatAmount=ko.observable();b.cssAmount="pokupo_amount";b.cssCount="pokupo_count";if(c.idGoods){b.title(c.goodsInfo.main.chort_name);b.count(c.count);var d=c.count*parseFloat(c.goodsInfo.main.sell_end_cost);b.amount(d);b.isGoodsId(true)}if(c.idShop&&!c.idGoods){b.title(c.description);if(c.amount){b.amount(parseFloat(c.amount))}b.isGoodsId(false)}if(b.amount()){b.formatAmount=b.amount().toFixed(2)}b.mailUser=ko.observable();b.idMethodPayment=ko.observable(c.idMethodPayment);b.payments=ko.observableArray();b.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};b.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(c.showCount),showAmount:ko.observable(c.showAmount)};b.Cookie={Set:{UserEmail:function(e){$.cookie(Config.Base.cookie.userEmail,e)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var a="";if(c.mailUser){a=c.mailUser}else{if(b.Cookie.Get.UserEmail()){a=b.Cookie.Get.UserEmail()}}b.mailUser(a);b.CountValidation=function(){if(!b.count()){b.error.count(Config.StandalonePayment.Error.count.empty);b.show.errorCount(true);return false}if(parseInt(b.count())!=b.count()){b.error.count(Config.StandalonePayment.Error.count.integer);b.show.errorCount(true);return false}b.error.count(null);b.show.errorCount(false);return true};b.AmountValidation=function(){if(!b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.empty);b.show.errorAmount(true);return false}if(isNaN(b.amount())){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}if(parseFloat(b.amount())!=b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}if(b.amount()<0.01){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}b.error.amount(null);b.show.errorAmount(false);return true};b.EmailValidation=function(){if(!b.mailUser()){b.error.email(Config.StandalonePayment.Error.email.empty);b.show.errorEmail(true);return false}if(b.mailUser().length>64){b.error.email(Config.StandalonePayment.Error.email.maxLength);b.show.errorEmail(true);return false}if(!Config.StandalonePayment.regular.email.test(b.mailUser())){b.error.email(Config.StandalonePayment.Error.email.regular);b.show.errorEmail(true);return false}b.error.email(null);b.show.errorEmail(false);return true};EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.validate",function(e){var f=true;if(!b.EmailValidation()){f=false}if(!b.CountValidation()&&b.isGoodsId()){f=false}if(!b.AmountValidation()&&!b.isGoodsId()){f=false}if(f){b.Cookie.Set.UserEmail(b.mailUser());e.callback()}})};var StandalonePaymentItemViewModel=function(c,b){var a=this;a.id=c.id;a.namePayment=c.name_payment;a.costPayment=c.cost_payment;a.descPayment=c.desc_payment;a.instrPayment=c.instr_payment;a.logoPayment=c.logo_payment;a.timePayment=c.time_payment;a.itog=ko.computed(function(){if(b.amount()&&!b.AmountValidation()){return 0}var d=(b.amount()?parseFloat(b.amount()):0)+(a.costPayment?parseFloat(a.costPayment):0);if(d==0||isNaN(d)){return 0}else{d=d.toFixed(2);return d}},this);a.errorEmail=ko.observable();a.Click={SelectPayment:function(){b.idMethodPayment(a.id);b.paymentInfo=a;EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.validate",{data:b,callback:function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.select",b)}})}}};var StandalonePaymentViewModel=function(b){var a=this;a.paymentInfo={};a.showPaymentInfo=false;a.instruction=ko.observable();a.cssInstruction="instructtion_print_block";a.idMethodPayment=b.idMethodPayment;a.outData=ko.observableArray();a.inData=ko.observableArray();a.isInData=ko.observable(false);a.cssInDataForm="in_data_block";a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm=ko.observable(false);a.urlInvoice=ko.observable();a.cssInvoice="invoice_print_block";a.Print=function(d){var c=window.open();c.document.write($("#"+d).html());c.print();c.close()};a.ClickPrintInstruction=function(){a.Print(a.cssInstruction)};a.ClickPrintInvoice=function(){a.Print(a.cssInvoice)};a.Back=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.back")};a.ClickPay=function(){$("#"+a.payForm.cssPayForm).submit()};a.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};a.ClickSubmit=function(){if(a.ValidationFrom()){EventDispatcher.DispatchEvent("StandalonePaymentWidget.form.submit",a)}};a.ValidationFrom=function(){var c=true;$.each(a.inData(),function(d){if(!a.inData()[d].ValidateField()){c=false;return false}});return c};a.AddContent=function(c){a.instruction(null);if(c.hasOwnProperty("instruction")){a.instruction(c.instruction)}a.outData=ko.observableArray();if(c.hasOwnProperty("out_data")){$.each(c.out_data,function(d){a.outData.push(c.out_data[d])})}a.isPayForm(false);a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm(false);if(c.hasOwnProperty("pay_form")){a.isPayForm(true);a.payForm.action(c.pay_form.action);a.payForm.method(c.pay_form.method);if(c.pay_form.hasOwnProperty("new_window")&&c.pay_form.new_window=="yes"){a.payForm.target("_blank")}$.each(c.pay_form.hidden_field,function(d){var e={name:"",value:""};if(c.pay_form.hidden_field[d].name){e.name=c.pay_form.hidden_field[d].name}if(c.pay_form.hidden_field[d].value){e.value=c.pay_form.hidden_field[d].value}a.payForm.field.push(e)})}a.isInData(false);a.inData=ko.observableArray();if(c.hasOwnProperty("in_data")){a.isInData(true);$.each(c.in_data,function(d){var e=new StandalonePaymentFieldViewModel();e.AddContent(c.in_data[d]);a.inData.push(e)})}a.urlInvoice(null);if(c.hasOwnProperty("url_invoice")){a.urlInvoice(c.url_invoice)}if(!$.isEmptyObject(a.paymentInfo)){a.showPaymentInfo=true}}};var StandalonePaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var StandalonePaymentErrorViewModel=function(c,b){var a=this;a.code=c.err;a.message=c.msg;a.hasPaymentList=b.paymentList;a.ClickClearPayment=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.clear")}};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var a=new StandalonePaymentWidget();a.Init(a)}else{setTimeout(function(){TestStandalonePayment.Init()},100)}}};TestStandalonePayment.Init();
var StandaloneGoodsWidget=function(){var a=this;a.widgetName="StandaloneGoodsWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.goods=null;a.hasButton=false;a.settings={idGoods:null,count:1,idShopPartner:null,mailUser:null,idMethodPayment:null,containerId:null,tmpl:{path:null,id:null},animate:null,showBlocks:null,button:null,inputParameters:{},styleGoods:null,customContainer:null,infoBlock:1111111};a.InitWidget=function(){a.settings.containerId=Config.Containers.standaloneGoods.widget;a.settings.customContainer=Config.Containers.standaloneGoods.customClass;a.settings.tmpl=Config.StandaloneGoods.tmpl;a.settings.showBlocks=Config.StandaloneGoods.showBlocks;a.settings.styleGoods=Config.StandaloneGoods.style;a.settings.button=Config.StandaloneGoods.button;a.SetInputParameters();a.RegisterEvents();a.CheckRouteGoods();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/StandaloneGoodsWidget/);if(b.goods){c=b.goods}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standaloneGoods){c=WParameters.standaloneGoods}if(Routing.params.id){a.settings.idGoods=Routing.params.id}if(Routing.params.idShopPartner){a.settings.idShopPartner=Routing.params.idShopPartner}if(Routing.params.mailUser){a.settings.mailUser=Routing.params.mailUser}if(Routing.params.idMethodPayment){a.settings.idMethodPayment=Routing.params.idMethodPayment}if(Routing.params.button){a.settings.button.active=Routing.params.button}if(Routing.params.count){a.settings.count=Routing.params.count}if(c.infoBlock){a.settings.infoBlock=c.infoBlock}if(!$.isEmptyObject(c)){if(c.idGoods){a.settings.idGoods=c.idGoods}if(c.show){for(var d=0;d<=c.show.length-1;d++){if($.inArray(c.show[d],a.settings.showBlocks)<0){a.settings.showBlocks.push(c.show[d])}}}if(c.button){a.settings.button.active=c.button}if(c.count){a.settings.count=c.count}if(c.animate){a.settings.animate=c.animate}}if(Routing.params.blockIdGoods&&$.inArray("blockIdGoods",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockIdGoods")}if(Routing.params.blockShortName&&$.inArray("blockShortName",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockShortName")}if(Routing.params.blockFullName&&$.inArray("blockFullName",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockFullName")}if(Routing.params.blockGallery&&$.inArray("blockGallery",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockGallery")}if(Routing.params.blockShop&&$.inArray("blockShop",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockShop")}if(Routing.params.blockInfoSeller&&$.inArray("blockInfoSeller",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockInfoSeller")}if(Routing.params.blockCount&&$.inArray("blockCount",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockCount")}if(Routing.params.editableCount&&$.inArray("editableCount",a.settings.showBlocks)<0){a.settings.showBlocks.push("editableCount")}if(Routing.params.blockShare&&$.inArray("blockShare",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockShare")}if(Routing.params.blockDescription&&$.inArray("blockDescription",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockDescription")}if(Routing.params.blockShipping&&$.inArray("blockShipping",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockShipping")}if(Routing.params.blockOpinion&&$.inArray("blockOpinion",a.settings.showBlocks)<0){a.settings.showBlocks.push("blockOpinion")}if(!$.isEmptyObject(c)){if(c.hide){for(var d=0;d<=c.hide.length-1;d++){var e=$.inArray(c.hide[d],a.settings.showBlocks);if(e>0){a.settings.showBlocks.splice(e,1)}}}}a.settings.inputParameters=c};a.CheckRouteGoods=function(){if(Routing.route=="goods"||Routing.IsDefault()){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.Script("widgets/GoodsViewModel-1.0.min.js",function(){a.Update()})})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("w.change.route",function(){a.CheckRouteGoods()});EventDispatcher.AddEventListener("SGoods.onload.info",function(b){a.Fill.Content(b)})};a.Update=function(){a.BaseLoad.GoodsInfo(a.settings.idGoods,a.settings.infoBlock,function(b){EventDispatcher.DispatchEvent("SGoods.onload.info",b)})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.Fill={Content:function(c){StandaloneGoodsViewModel.prototype=new GoodsViewModel();a.goods=new StandaloneGoodsViewModel(a.settings);for(var b in c){if(b=="opinion"&&$.inArray("blockOpinion",a.settings.showBlocks)<0){continue}if(b=="shipping"&&$.inArray("blockShipping",a.settings.showBlocks)<0){continue}if(typeof a.Fill[b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()]=="function"){a.Fill[b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()](c[b])}else{a.Fill.Block(b,c[b])}}a.goods.CheckShow();a.goods.blocks.main.sellerId=c.seller.id;a.goods.blocks.main.shopId=c.shop.id;a.goods.SetListMoreBlock("standalone");a.Render.Goods(a.goods)},Main:function(c){GoodsMainBlockViewModel.prototype=new Widget();a.goods.AddBlock("main",new GoodsMainBlockViewModel(c));if($.inArray("blockDescription",a.settings.showBlocks)>=0){var b="blockDescription";a.goods.AddBlock(b,c.description);if(c.description&&c.description.match(/data-bind/)){a.hasButton=b}}if(a.settings.count&&a.settings.count<=a.goods.blocks.main.count()){a.goods.blocks.main.ordered(a.settings.count)}else{a.goods.blocks.main.count(0)}},Gallery:function(d){var b=[];for(var c=0;c<=d.length-1;c++){b[c]=new GalleryBlockViewModel(d[c])}a.goods.AddBlock("gallery",b)},Seller:function(b){a.goods.sellerInfo.seller=b},Shop:function(b){a.goods.sellerInfo.shop=b},Operator:function(b){a.goods.sellerInfo.operator=b},Block:function(c,e){var f=new MoreBlockViewModel(c);if(c=="shipping"){var b=[];for(var d in e){b.push(new ShippingBlockViewModel(e[d]))}e=b;c="blockShipping"}if(c=="opinion"){c="blockOpinion"}f.AddParams(e);a.goods.AddBlock(c,f)}};a.Render={Goods:function(b){if($("#"+a.settings.containerId).length>0){try{a.InsertContainer.Content();ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);if(a.hasButton){$.each(b.moreBlock,function(e){if(b.moreBlock[e].key==a.hasButton){var d=$("#"+b.moreBlock[e].idBlock+" [data-bind^=click]");$.each(d,function(f){if(b.blocks.main.showAddToCart()){if($(d[f]).attr("data-bind").match(/AddToCart/)){var h=new AddToCartButtonViewModel(b.blocks.main);ko.applyBindings(h,d[f])}}else{$(d[f]).hide()}if(b.blocks.main.showBuy()){if($(d[f]).attr("data-bind").match(/Buy/)){var g=new BuyButtonViewModel(b.blocks.main);ko.applyBindings(g,d[f])}}else{$(d[f]).hide()}})}})}if(typeof AnimateStandaloneGoods=="function"){new AnimateStandaloneGoods()}if(a.settings.animate){a.settings.animate()}a.AddGoodsInCookie(b);delete b;a.WidgetLoader(true,a.settings.containerId)}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Goods(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}};a.AddGoodsInCookie=function(d){var b=$.cookie(Config.Base.cookie.previously_viewed);if(!b){$.cookie(Config.Base.cookie.previously_viewed,d.id)}else{var c=b.split(",");var e=$.inArray(d.id,c);if(e>=0){c.splice(e,1);c.unshift(d.id)}else{c.unshift(d.id)}if(c.length>20){c.splice(20,1)}$.cookie(Config.Base.cookie.previously_viewed,c.join(","))}var b=$.cookie(Config.Base.cookie.previously_viewed)};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleGoods[b]){a.settings.styleGoods[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.containerId).css(a.settings.styleGoods)})}}};var StandaloneGoodsViewModel=function(b){var a=this;a.activeButton=b.button.active;a.inactiveButton=b.button.inactive;a.show={blockIdGoods:false,blockShortName:false,blockFullName:false,blockGallery:false,blockShop:false,blockInfoSeller:false,blockOperator:false,blockCount:false,editableCount:false,blockShare:false,blockDescription:false,blockShipping:false,blockOpinion:false};a.CheckShow=function(){if($.inArray("blockIdGoods",b.showBlocks)>=0){a.show.blockIdGoods=true}if($.inArray("blockShortName",b.showBlocks)>=0){a.show.blockShortName=true}if($.inArray("blockFullName",b.showBlocks)>=0){a.show.blockFullName=true}if($.inArray("blockGallery",b.showBlocks)>=0){a.show.blockGallery=true}if($.inArray("blockShop",b.showBlocks)>=0){a.show.blockShop=true}if($.inArray("blockInfoSeller",b.showBlocks)>=0){a.show.blockInfoSeller=true}if($.inArray("blockOperator",b.showBlocks)>=0){a.show.blockOperator=true}if($.inArray("blockCount",b.showBlocks)>=0){a.show.blockCount=true}if($.inArray("editableCount",b.showBlocks)>=0){a.show.editableCount=true}if($.inArray("blockShare",b.showBlocks)>=0){a.show.blockShare=true}if($.inArray("blockDescription",b.showBlocks)>=0){a.show.blockDescription=true}if($.inArray("blockShipping",b.showBlocks)>=0){a.show.blockShipping=true}if($.inArray("blockOpinion",b.showBlocks)>=0){a.show.blockOpinion=true}};a.SetListMoreBlock=function(d){for(var c in Config.StandaloneGoods.moreBlocks){if($.inArray(c,b.showBlocks)>=0){StandaloneGoodsListMoreBlockViewModel.prototype=new GoodsListMoreBlockViewModel(c,a.blocks[c],d);a.moreBlock.push(new StandaloneGoodsListMoreBlockViewModel())}}};a.Buy=function(){var c={idGoods:b.idGoods,count:a.blocks.main.ordered()};if(b.idShopPartner){c.idShopPartner=b.idShopPartner}if(b.mailUser){c.mailUser=b.mailUser}if(b.idMethodPayment){c.idMethodPayment=b.idMethodPayment}Routing.SetHash("standalone_payment","Оплатить товар",c)}};var StandaloneGoodsListMoreBlockViewModel=function(){this.title=Config.StandaloneGoods.moreBlocks[this.key];this.templateName=this.prefix+this.key.charAt(0).toUpperCase()+this.key.substr(1)+"BlockTmpl"};var TestStandaloneGoods={Init:function(){if(typeof Widget=="function"){StandaloneGoodsWidget.prototype=new Widget();var a=new StandaloneGoodsWidget();a.Init(a)}else{setTimeout(function(){TestStandaloneGoods.Init()},100)}}};TestStandaloneGoods.Init();