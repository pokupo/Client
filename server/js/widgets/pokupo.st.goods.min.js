var JSSettings={shopId:0,protocolHTTP:"https://",protocolHTTPS:"https://",host:"server.pokupo.ru/prod/server/",pathToJS:"js/",pathToTmpl:"pokupo.ru/themes/",theme:"default",pathToData:"prod/server/services/DataProxy.php?query=",pathToPostData:"prod/server/services/DataPostProxy.php",pathToCore:"index.html",pathToPostCore:"postData.html",hostApi:"api.pokupo.ru/",catalogPathApi:"catalog/",goodsPathApi:"goods/",userPathApi:"user/",cartPathApi:"cart/",favPathApi:"fav/",geoPathApi:"geo/",shopPathApi:"shop/",orderPathApi:"order/",paymentPathApi:"payment/",messagePathApi:"message/",dev:false,sourceData:"api",scripts:["easyXDM.min.js","knockout-3.2.0.js","jquery.cookie.js","jquery.textchange.min.js","widgets/Config-1.1.js","widgets/Routing-1.0.js","widgets/Paging-1.0.js","widgets/Widget-1.1.js"],inputParameters:{}};var EventDispatcher={events:[],AddEventListener:function(event,callback){this.events[event]=this.events[event]||[];if(this.events[event]){this.RemoveEventListener(event,callback);this.events[event].push(callback);}},RemoveEventListener:function(event,callback){if(this.events[event]){var listeners=this.events[event];var callbackHash=EventDispatcher.HashCode(callback.toString());for(var i=listeners.length-1;i>=0;--i){if(EventDispatcher.HashCode(listeners[i].toString())===callbackHash){listeners.splice(i,1);return true;}}}return false;},DispatchEvent:function(event,data){if(this.events[event]){var listeners=this.events[event],len=listeners.length;while(len--){listeners[len](data);}}},HashCode:function(str){var hash=0,i,ch;if(str.length==0){return hash;}for(i=0;i<str.length;i++){ch=str.charCodeAt(i);hash=((hash<<5)-hash)+ch;hash=hash&hash;}return hash;},GetUUID:function(){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16);});return t;}};var JSLoader={loaded:false,loadedCount:0,pathToJs:null,Init:function(scripts,pathToJs){this.pathToJs=pathToJs;JSLoader.Load(scripts,function(){JSLoader.RegisterLoaded(scripts);});},RegisterLoaded:function(scripts){JSLoader.loadedCount=JSLoader.loadedCount+1;if(JSLoader.loadedCount==scripts.length){JSLoader.OnReady();}},OnReady:function(){if(typeof ko=="object"){JSLoader.loaded=true;EventDispatcher.DispatchEvent("onload.scripts");}else{setTimeout(function(){JSLoader.OnReady();},100);}},Load:function(scripts,callback){for(var i in scripts){$.getScript(this.pathToJs+scripts[i],function(){if(callback){callback();}});}}};var JSCore={version:1.2,isReady:false,shopId:null,dev:false,Init:function(){if(document.location.protocol=="https:"){JSSettings.protocolHTTP=JSSettings.protocolHTTPS;}JSCore.SetInputParameters();JSLoader.Init(JSSettings.scripts,JSSettings.protocolHTTP+JSSettings.host+JSSettings.pathToJS);JSCore.shopId=JSSettings.shopId;XDMTransport.Init(JSSettings.host+JSSettings.pathToCore);JSCore.isReady=true;},ParserInputParameters:function(scriptName){var obj={};var attr=$("script").filter(function(){return scriptName.test($(this).attr("src"));}).attr("src");if(attr){var string=attr.split("?");if(string.length>1){var parameters=string[1].split("&");for(var i=0;i<=parameters.length-1;i++){var parameter=parameters[i].split("=");obj[parameter[0]]=parameter[1];}}}if(obj){return obj;}return null;},SetInputParameters:function(){var input=JSCore.ParserInputParameters(/JSCore/);if($.isEmptyObject(input)){input=JSCore.ParserInputParameters(/pokupo.widgets.[a-z0-9]{32}.min.js/);}if(input){for(var key in input){if(JSSettings.hasOwnProperty(key)){JSSettings[key]=input[key];}}}if(typeof WParameters!=="undefined"&&WParameters.core){for(var key in WParameters.core){if(JSSettings.hasOwnProperty(key)){JSSettings[key]=WParameters.core[key];}}}JSSettings.inputParameters.shopId=JSSettings.shopId;}};var XDMTransport={remote:"",event:{},Init:function(url){XDMTransport.remote=url;},GetProtocol:function(data){if(data){return JSSettings.protocolHTTPS;}else{return JSSettings.protocolHTTP;}},EventExecute:function(msg,hash){$.each(XDMTransport.event[hash],function(i){XDMTransport.event[hash][i](msg);});delete XDMTransport.event[hash];},Load:{FromProxy:function(opt){if(typeof easyXDM!=="undefined"){var socket=new easyXDM.Socket({remote:XDMTransport.GetProtocol(opt.protocol)+XDMTransport.remote,onMessage:function(msg){if(opt.callback){opt.callback(msg);}}});socket.postMessage(JSSettings.pathToData+opt.url);}else{setTimeout(function(){XDMTransport.Load.FromProxy(opt);},1000);}},FromApi:function(opt){$.ajax({type:"GET",async:true,url:decodeURIComponent(opt.url),dataType:opt.type,success:function(msg){if(opt.callback){opt.callback(msg);}}});},Tmpl:function(data,callback){var url=XDMTransport.GetProtocol()+JSSettings.pathToTmpl+JSSettings.theme+"/tmpl/"+data;if(/^(https?|ftp)\:\/\/(www\.)?([a-zA-Z0-9\.\-]+\.[a-z]{2,})(\/.+)$/.test(data)){url=data;}XDMTransport.Load.FromProxy({url:url,callback:callback,protocol:null});},Data:function(data,callback,protocol){protocol=JSSettings.protocolHTTPS;var hash=EventDispatcher.HashCode(data+callback.toString());if(XDMTransport.event[hash]==undefined){XDMTransport.event[hash]=[];}XDMTransport.event[hash].push(callback);if(XDMTransport.event[hash].length==1){if(JSSettings.sourceData=="api"){XDMTransport.Load.FromApi({type:"jsonp",url:decodeURIComponent(data),callback:function(msg){XDMTransport.EventExecute(msg,hash);}});}if(JSSettings.sourceData=="proxy"){XDMTransport.Load.FromProxy({url:data,protocol:protocol,callback:function(msg){XDMTransport.EventExecute(JSON.parse(msg),hash);}});}}},DataPost:function(data,protocol){if(typeof easyXDM!=="undefined"){var remote=new easyXDM.Rpc({remote:XDMTransport.GetProtocol(protocol)+JSSettings.host+JSSettings.pathToPostCore,onReady:function(){data.attr("action",XDMTransport.GetProtocol(protocol)+JSSettings.host+JSSettings.pathToPostData);data.submit();}},{local:{returnUploadResponse:function(response){EventDispatcher.DispatchEvent(EventDispatcher.HashCode(data.toString()),JSON.parse(response.msg));}}});}else{setTimeout(function(){XDMTransport.Load.DataPost(data,protocol);},1000);}}}};var Logger={Console:{Exception:function(widget,text,e){console&&console.log("Exception : "+new Date()+" : "+widget+" : "+text);if(e){var exmsg="";if(e.message){exmsg+=e.message;}if(e.stack){exmsg+=" | stack: "+e.stack;}console&&console.log(exmsg);}},Info:function(widget,text){console&&console.log("Info : "+new Date()+" : "+widget+" : "+text);},VarDump:function(widget,name,obj){console&&console.log("Var Dump : "+widget+" : "+name);console&&console.log(obj);}}};$().ready(function(){JSCore.Init();});
var StandaloneGoodsWidget=function(){var self=this;self.widgetName="StandaloneGoodsWidget";self.version=1;self.minWidgetVersion=1;self.maxWidgetVersion=2;self.minTmplVersion=1;self.maxTmplVersion=2;self.goods=null;self.hasButton=false;self.settings={idGoods:null,count:null,containerId:null,tmpl:{path:null,id:null},animate:null,showBlocks:null,button:null,inputParameters:{},styleGoods:null,customContainer:null,infoBlock:1111111};self.InitWidget=function(){self.settings.containerId=Config.Containers.standaloneGoods.widget;self.settings.customContainer=Config.Containers.standaloneGoods.customClass;self.settings.tmpl=Config.StandaloneGoods.tmpl;self.settings.showBlocks=Config.StandaloneGoods.showBlocks;self.settings.styleGoods=Config.StandaloneGoods.style;self.settings.button=Config.StandaloneGoods.button;self.SetInputParameters();self.RegisterEvents();self.CheckRouteGoods();self.SetPosition();};self.SetInputParameters=function(){var input={};if(Config.Base.sourceParameters=="string"){var temp=JSCore.ParserInputParameters(/StandaloneGoodsWidget/);if(temp.goods){input=temp.goods;}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standaloneGoods){input=WParameters.standaloneGoods;}if(Routing.params.id){self.settings.idGoods=Routing.params.id;}if(!$.isEmptyObject(input)){if(input.idGoods){self.settings.idGoods=input.idGoods;}if(input.show){for(var i=0;i<=input.show.length-1;i++){if($.inArray(input.show[i],self.settings.showBlocks)<0){self.settings.showBlocks.push(input.show[i]);}}}if(input.hide){for(var i=0;i<=input.hide.length-1;i++){var test=$.inArray(input.hide[i],self.settings.showBlocks);if(test>0){self.settings.showBlocks.splice(test,1);}}}if(input.button){self.settings.button.active=input.button;}if(input.count){self.settings.count=input.count;}if(input.infoBlock){self.settings.infoBlock=input.infoBlock;}if(input.animate){self.settings.animate=input.animate;}}self.settings.inputParameters=input;};self.CheckRouteGoods=function(){if(Routing.route=="goods"||Routing.IsDefault()){self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.BaseLoad.Script("widgets/GoodsViewModel-1.0.js",function(){self.Update();});});}else{self.WidgetLoader(true);}};self.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){self.CheckRouteGoods();});EventDispatcher.AddEventListener("StandaloneGoodsWidget.onload.info",function(data){self.Fill.Content(data);});};self.Update=function(){self.BaseLoad.GoodsInfo(self.settings.idGoods,self.settings.infoBlock,function(data){EventDispatcher.DispatchEvent("StandaloneGoodsWidget.onload.info",data);});};self.InsertContainer={EmptyWidget:function(){var temp=$("#"+self.settings.containerId).find(self.SelectCustomContent().join(", ")).clone();$("#"+self.settings.containerId).empty().html(temp);},Content:function(){self.InsertContainer.EmptyWidget();$("#"+self.settings.containerId).append($("script#"+self.GetTmplName()).html()).children().hide();}};self.Fill={Content:function(data){StandaloneGoodsViewModel.prototype=new GoodsViewModel();self.goods=new StandaloneGoodsViewModel(self.settings);for(var key in data){if(key=="opinion"&&$.inArray("blockOpinion",self.settings.showBlocks)<0){continue;}if(key=="shipping"&&$.inArray("blockShipping",self.settings.showBlocks)<0){continue;}if(typeof self.Fill[key.charAt(0).toUpperCase()+key.substr(1).toLowerCase()]=="function"){self.Fill[key.charAt(0).toUpperCase()+key.substr(1).toLowerCase()](data[key]);}else{self.Fill.Block(key,data[key]);}}self.goods.CheckShow();self.goods.blocks.main.sellerId=data.seller.id;self.goods.blocks.main.shopId=data.shop.id;self.goods.SetListMoreBlock("standalone");self.Render.Goods(self.goods);},Main:function(data){GoodsMainBlockViewModel.prototype=new Widget();self.goods.AddBlock("main",new GoodsMainBlockViewModel(data));if($.inArray("blockDescription",self.settings.showBlocks)>=0){var key="blockDescription";self.goods.AddBlock(key,data.description);if(data.description&&data.description.match(/data-bind/)){self.hasButton=key;}}if(self.settings.count&&self.settings.count<=self.goods.blocks.main.count()){self.goods.blocks.main.ordered(self.settings.count);}else{self.goods.blocks.main.count(0);}},Gallery:function(data){var gallery=[];for(var i=0;i<=data.length-1;i++){gallery[i]=new GalleryBlockViewModel(data[i]);}self.goods.AddBlock("gallery",gallery);},Seller:function(data){self.goods.sellerInfo.seller=data;},Shop:function(data){self.goods.sellerInfo.shop=data;},Operator:function(data){self.goods.sellerInfo.operator=data;},Block:function(key,data){var block=new MoreBlockViewModel(key);if(key=="shipping"){var shipping=[];for(var r in data){shipping.push(new ShippingBlockViewModel(data[r]));}data=shipping;key="blockShipping";}if(key=="opinion"){key="blockOpinion";}block.AddParams(data);self.goods.AddBlock(key,block);}};self.Render={Goods:function(data){if($("#"+self.settings.containerId).length>0){try{self.InsertContainer.Content();ko.cleanNode($("#"+self.settings.containerId)[0]);ko.applyBindings(data,$("#"+self.settings.containerId)[0]);if(self.hasButton){$.each(data.moreBlock,function(i){if(data.moreBlock[i].key==self.hasButton){var button=$("#"+data.moreBlock[i].idBlock+" [data-bind^=click]");$.each(button,function(i){if(data.blocks.main.showAddToCart()){if($(button[i]).attr("data-bind").match(/AddToCart/)){var addToCart=new AddToCartButtonViewModel(data.blocks.main);ko.applyBindings(addToCart,button[i]);}}else{$(button[i]).hide();}if(data.blocks.main.showBuy()){if($(button[i]).attr("data-bind").match(/Buy/)){var buy=new BuyButtonViewModel(data.blocks.main);ko.applyBindings(buy,button[i]);}}else{$(button[i]).hide();}});}});}if(typeof AnimateStandaloneGoods=="function"){new AnimateStandaloneGoods();}if(self.settings.animate){self.settings.animate();}self.AddGoodsInCookie(data);delete data;self.WidgetLoader(true,self.settings.containerId);}catch(e){self.Exception("Ошибка шаблона ["+self.GetTmplName()+"]",e);if(self.settings.tmpl.custom){delete self.settings.tmpl.custom;self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.InsertContainer.Content();self.Render.Goods(data);});}else{self.InsertContainer.EmptyWidget();self.WidgetLoader(true,self.settings.containerId);}}}else{self.Exception("Ошибка. Не найден контейнер ["+self.settings.containerId+"]");self.WidgetLoader(true,self.settings.containerId);}}};self.AddGoodsInCookie=function(data){var viewed=$.cookie(Config.Base.cookie.previously_viewed);if(!viewed){$.cookie(Config.Base.cookie.previously_viewed,data.id);}else{var viewedArray=viewed.split(",");var pos=$.inArray(data.id,viewedArray);if(pos>=0){viewedArray.splice(pos,1);viewedArray.unshift(data.id);}else{viewedArray.unshift(data.id);}if(viewedArray.length>20){viewedArray.splice(20,1);}$.cookie(Config.Base.cookie.previously_viewed,viewedArray.join(","));}var viewed=$.cookie(Config.Base.cookie.previously_viewed);};self.SetPosition=function(){if(self.settings.inputParameters.position=="absolute"){for(var key in self.settings.inputParameters){if(self.settings.styleGoods[key]){self.settings.styleGoods[key]=self.settings.inputParameters[key];}}$().ready(function(){$("#"+self.settings.containerId).css(self.settings.styleGoods);});}};};var StandaloneGoodsViewModel=function(settings){var self=this;self.activeButton=settings.button.active;self.inactiveButton=settings.button.inactive;self.show={blockIdGoods:false,blockShortName:false,blockFullName:false,blockGallery:false,blockShop:false,blockInfoSeller:false,blockOperator:false,blockCount:false,editableCount:false,blockShare:false,blockDescription:false,blockShipping:false,blockOpinion:false};self.CheckShow=function(){if($.inArray("blockIdGoods",settings.showBlocks)>=0){self.show.blockIdGoods=true;}if($.inArray("blockShortName",settings.showBlocks)>=0){self.show.blockShortName=true;}if($.inArray("blockFullName",settings.showBlocks)>=0){self.show.blockFullName=true;}if($.inArray("blockGallery",settings.showBlocks)>=0){self.show.blockGallery=true;}if($.inArray("blockShop",settings.showBlocks)>=0){self.show.blockShop=true;}if($.inArray("blockInfoSeller",settings.showBlocks)>=0){self.show.blockInfoSeller=true;}if($.inArray("blockOperator",settings.showBlocks)>=0){self.show.blockOperator=true;}if($.inArray("blockCount",settings.showBlocks)>=0){self.show.blockCount=true;}if($.inArray("editableCount",settings.showBlocks)>=0){self.show.editableCount=true;}if($.inArray("blockShare",settings.showBlocks)>=0){self.show.blockShare=true;}if($.inArray("blockDescription",settings.showBlocks)>=0){self.show.blockDescription=true;}if($.inArray("blockShipping",settings.showBlocks)>=0){self.show.blockShipping=true;}if($.inArray("blockOpinion",settings.showBlocks)>=0){self.show.blockOpinion=true;}};self.SetListMoreBlock=function(prefix){for(var key in Config.StandaloneGoods.moreBlocks){if($.inArray(key,settings.showBlocks)>=0){StandaloneGoodsListMoreBlockViewModel.prototype=new GoodsListMoreBlockViewModel(key,self.blocks[key],prefix);self.moreBlock.push(new StandaloneGoodsListMoreBlockViewModel());}}};self.Buy=function(){Routing.SetHash("standalone_payment","Оплатить товар",{idGoods:settings.idGoods,count:self.blocks.main.ordered()});};};var StandaloneGoodsListMoreBlockViewModel=function(){this.title=Config.StandaloneGoods.moreBlocks[this.key];this.templateName=this.prefix+this.key.charAt(0).toUpperCase()+this.key.substr(1)+"BlockTmpl";};var TestStandaloneGoods={Init:function(){if(typeof Widget=="function"){StandaloneGoodsWidget.prototype=new Widget();var goods=new StandaloneGoodsWidget();goods.Init(goods);}else{setTimeout(function(){TestStandaloneGoods.Init();},100);}}};TestStandaloneGoods.Init();
var StandalonePaymentWidget=function(){var self=this;self.widgetName="StandalonePaymentWidget";self.version=1;self.minWidgetVersion=1;self.maxWidgetVersion=2;self.minTmplVersion=1;self.maxTmplVersion=2;self.settings={containerId:{button:"",content:""},customContainer:null,tmpl:{path:null,id:{button:null,paymentList:null,content:null,error:null}},animate:null,inputParameters:{},containerButton:null,title:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:true,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",showButton:null};self.InitWidget=function(){self.settings.containerId=Config.Containers.standalonePayment;self.settings.tmpl=Config.StandalonePayment.tmpl;self.settings.title=Config.StandalonePayment.title;self.settings.showButton=Config.StandalonePayment.showButton;self.CheckRouteStandalonePayment();};self.SetParameters=function(data){var input={};if(Config.Base.sourceParameters=="string"){var temp=JSCore.ParserInputParameters(/StandalonePaymentWidget/);if(temp.standalonePayment){input=temp.standalonePayment;}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standalonePayment){input=WParameters.standalonePayment;}if(JSSettings.dev){Logger.Console.VarDump(self.widgetName,"Input parameters",input);}if(!$.isEmptyObject(input)){if(input.title){self.settings.title=input.title;}else{self.settings.title=null;}if(input.idGoods){self.settings.idGoods=input.idGoods;self.settings.showAmount=false;}else{if(Routing.params.idGoods){self.settings.idGoods=Routing.params.idGoods;self.settings.showAmount=false;}else{self.settings.idGoods=null;self.settings.idShop=JSSettings.shopId;self.settings.showCount=false;}}if(input.count){self.settings.count=input.count;self.settings.showCount=false;}else{if(Routing.params.count){self.settings.count=Routing.params.count;self.settings.showCount=false;}else{self.settings.count=1;self.settings.showCount=false;}}if(input.amount){self.settings.amount=input.amount;self.settings.showAmount=false;}else{if(Routing.params.amount){self.settings.amount=Routing.params.amount;self.settings.showAmount=false;}else{self.settings.amount=null;if(!self.settings.idGoods){self.settings.showAmount=true;}}}if(input.uid){self.settings.uid=input.uid;}if(Routing.params.uid){self.settings.uid=Routing.params.uid;}if(input.idShopPartner){self.settings.idShopPartner=input.idShopPartner;}if(Routing.params.idShopPartner){self.settings.idShopPartner=Routing.params.idShopPartner;}if(input.mailUser){self.settings.mailUser=input.mailUser;}else{if(Routing.params.mailUser){self.settings.mailUser=Routing.params.mailUser;}}if(input.idMethodPayment){self.settings.idMethodPayment=input.idMethodPayment;}if(Routing.params.idMethodPayment){self.settings.idMethodPayment=Routing.params.idMethodPayment;}if(input.description){self.settings.description=input.description;}if(Routing.params.description){self.settings.description=Routing.params.description;}if(input.showButton){self.settings.showButton=input.showButton;}if(input.tmpl){if(input.tmpl.path){self.settings.tmpl.path=input.tmpl.path;}if(input.tmpl.id){for(var key in input.tmpl.id){self.settings.tmpl.id[key]=input.tmpl.id[key];}}}if(input.container){if(input.container){for(var key in input.container){self.settings.containerId[key]=input.container[key];}}}if(input.animate){self.settings.animate=input.animate;}}self.settings.inputParameters=input;if(JSSettings.dev){Logger.Console.VarDump(self.widgetName,"Result settings",self.settings);}};self.CheckRouteStandalonePayment=function(){self.SetParameters();self.RegisterEvents();self.BaseLoad.Tmpl(self.settings.tmpl,function(){if(Routing.route=="standalone_payment"){if(self.settings.idGoods!=null){self.BaseLoad.GoodsInfo(self.settings.idGoods,"1000000",function(data){self.settings.goodsInfo=data;if(self.settings.idShopPartner==null){self.GetData.Goods();}if(self.settings.idShopPartner!=null){self.GetData.PartnerGoods();}});}if(self.settings.idShop!=null&&self.settings.idGoods==null){self.GetData.Service();}}else{if(self.settings.showButton&&Routing.route!="status_payment"){self.InsertContainer.Button();self.Fill.Button();}else{self.WidgetLoader(true);}}});};self.RegisterEvents=function(){EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.select",function(data){self.settings.idMethodPayment=data.idMethodPayment();self.settings.paymentInfo=data.paymentInfo;self.settings.mailUser=data.mailUser();if(self.settings.idGoods!=null){self.settings.count=data.count();if(self.settings.idShopPartner==null){self.GetData.Goods();}if(self.settings.idShopPartner!=null){self.GetData.PartnerGoods();}}if(self.settings.idShop!=null){self.settings.amount=data.amount();self.GetData.Service();}});EventDispatcher.AddEventListener("StandalonePaymentWidget.back",function(){self.settings.idMethodPayment=null;self.settings.mailUser=null;self.CheckRouteStandalonePayment();});EventDispatcher.AddEventListener("widget.change.route",function(){self.CheckRouteStandalonePayment();});EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.clear",function(){self.settings.idMethodPayment=null;self.settings.mailUser=null;self.CheckRouteStandalonePayment();});EventDispatcher.AddEventListener("StandalonePaymentWidget.form.submit",function(form){self.InsertContainer.Content();var dataStr=[];$.each(form.inData(),function(i){if(form.inData()[i].name()=="MOBILE_PHONE"){dataStr.push(form.inData()[i].name()+"="+encodeURIComponent(form.inData()[i].value().replace(/\s/g,"").replace(/-/g,"")));}else{dataStr.push(form.inData()[i].name()+"="+encodeURIComponent(form.inData()[i].value()));}});var str=dataStr.join("&");if(Routing.params.orderId){str=Routing.params.orderId+"?"+str;self.GetData.Order(str);}if(Routing.params.goodsId){str=Routing.params.goodsId+"?"+str;self.GetData.Goods(str);}if(Routing.params.amount){str=Routing.params.amount+"/"+Parameters.shopId+"?"+str;self.GetData.Amount(str);}});};self.GetData={Price:function(){var str=self.settings.idShop+"/";if(self.settings.idShopPartner){str=str+self.settings.idShopPartner+"/";}var parameters=[];if(self.settings.amount){parameters.push("amount="+self.settings.amount);}if(self.settings.uid){parameters.push("uid="+self.settings.uid);}if(self.settings.idMethodPayment){parameters.push("idMethodPayment="+self.settings.idMethodPayment);}parameters.push("description="+self.settings.description);if(parameters.length>0){str=str+"?"+parameters.join("&");}self.BaseLoad.InvoicesService(str,function(data){self.Fill.PaymentList(data);});},Goods:function(){var str=self.settings.idGoods+"/";if(self.settings.count){str=str+self.settings.count+"/";}var parameters=[];if(self.settings.mailUser){parameters.push("mailUser="+self.settings.mailUser);}if(self.settings.idMethodPayment){parameters.push("idMethodPayment="+self.settings.idMethodPayment);}if(parameters.length>0){str=str+"?"+parameters.join("&");}self.BaseLoad.InvoicesGoods(str,function(data){self.Fill.PaymentList(data);});},PartnerGoods:function(){var str=self.settings.idGoods+"/";if(self.settings.count){str=str+self.settings.count+"/";}if(self.settings.idShopPartner){str=str+self.settings.idShopPartner+"/";}var parameters=[];if(self.settings.mailUser){parameters.push("mailUser="+self.settings.mailUser);}if(self.settings.idMethodPayment){parameters.push("idMethodPayment="+self.settings.idMethodPayment);}if(parameters.length>0){str=str+"?"+parameters.join("&");}self.BaseLoad.InvoicesPartnerGoods(str,function(data){self.Fill.PaymentList(data);});},Service:function(){var str=self.settings.idShop+"/";if(self.settings.idShopPartner){str=str+self.settings.idShopPartner+"/";}var parameters=[];if(self.settings.amount){parameters.push("amount="+self.settings.amount);}if(self.settings.uid){parameters.push("uid="+self.settings.uid);}if(self.settings.mailUser){parameters.push("mailUser="+self.settings.mailUser);}if(self.settings.idMethodPayment){parameters.push("idMethodPayment="+self.settings.idMethodPayment);}parameters.push("description="+self.settings.description);if(parameters.length>0){str=str+"?"+parameters.join("&");}self.BaseLoad.InvoicesService(str,function(data){self.Fill.PaymentList(data);});}};self.InsertContainer={EmptyWidget:function(container){var temp=$(container).find(self.SelectCustomContent().join(", ")).clone();$(container).empty().html(temp);},Button:function(){self.InsertContainer.EmptyWidget("#"+self.settings.containerId.button.widget);$("#"+self.settings.containerId.button.widget).html($("script#"+self.GetTmplName("button")).html());},PaymentList:function(){self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);$("#"+self.settings.containerId.content.widget).html($("script#"+self.GetTmplName("paymentList")).html());},Content:function(){self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);$("#"+self.settings.containerId.content.widget).html($("script#"+self.GetTmplName("content")).html()).hide();},Error:function(){self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);$("#"+self.settings.containerId.content.widget).html($("script#"+self.GetTmplName("error")).html()).hide();}};self.Fill={Button:function(){var button=new StandaloneButtonPaymentViewModel(self.settings);self.Render.Button(button);},PaymentList:function(data){if(data.hasOwnProperty("err")){self.InsertContainer.Error();self.Fill.Error(data);}else{if(!data.hasOwnProperty("pay_form")){var list=new StandalonePaymentListViewModel(self.settings);list.error.base("");list.show.errorBase(false);if(data){$.each(data,function(i){self.settings.paymentList=true;list.payments.push(new StandalonePaymentItemViewModel(data[i],list));});}self.InsertContainer.PaymentList();self.Render.PaymentList(list);}else{self.InsertContainer.Content();self.Fill.Content(data);}}},Content:function(data){var content=new StandalonePaymentViewModel(self.settings);var str=[];var fields={};if(data.pay_form){fields=data.pay_form.hidden_field;}var orderId=null;$.each(fields,function(i){str.push(fields[i].name+"="+encodeURIComponent(fields[i].value));if(fields[i].name=="PKP_ID_ORDER"){orderId=fields[i].value;}});if(orderId){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+orderId);}else{if(str){$.cookie(Config.Base.cookie.orderId,str.join("&"));}}content.paymentInfo=self.settings.paymentInfo;content.AddContent(data);self.Render.Content(content);},Error:function(data){var list=new StandalonePaymentErrorViewModel(data,self.settings);self.Render.Error(list);}};self.Render={Button:function(data){if($("#"+self.settings.containerId.button.widget).length>0){try{ko.cleanNode($("#"+self.settings.containerId.button.widget)[0]);ko.applyBindings(data,$("#"+self.settings.containerId.button.widget)[0]);self.WidgetLoader(true,self.settings.containerId.button.widget);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment();}if(self.settings.animate){self.settings.animate();}}catch(e){self.Exception("Ошибка шаблона ["+self.GetTmplName("button")+"]",e);if(self.settings.tmpl.custom){delete self.settings.tmpl.custom;self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.InsertContainer.Button();self.Render.Button(data);});}else{self.InsertContainer.EmptyWidget("#"+self.settings.containerId.button.widget);self.WidgetLoader(true,self.settings.containerId.button.widget);}}}else{self.WidgetLoader(true);}},PaymentList:function(data){if($("#"+self.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+self.settings.containerId.content.widget)[0]);ko.applyBindings(data,$("#"+self.settings.containerId.content.widget)[0]);$("#"+self.settings.containerId.content.widget).show();self.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment();}if(self.settings.animate){self.settings.animate();}if(self.settings.showAmount){$("#"+data.cssAmount).bind("textchange",function(event,previousText){var text=$(this).val();data.amount(text);self.settings.amount=text;setTimeout(function(){if(text==self.settings.amount){self.GetData.Price();}},500);});$("#"+data.cssAmount).focus();}$("#"+data.cssCount).bind("textchange",function(event,previousText){data.count($(this).val());});}catch(e){self.Exception("Ошибка шаблона ["+self.GetTmplName("paymentList")+"]",e);if(self.settings.tmpl.custom){delete self.settings.tmpl.custom;self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.InsertContainer.PaymentList()();self.Render.PaymentList(data);});}else{self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);self.WidgetLoader(true,self.settings.containerId.content.widget);}}}else{self.Exception("Ошибка. Не найден контейнер ["+self.settings.containerId.content.widget+"]");self.WidgetLoader(true);}},Content:function(data){if($("#"+self.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+self.settings.containerId.content.widget)[0]);ko.applyBindings(data,$("#"+self.settings.containerId.content.widget)[0]);$.each(data.inData(),function(i){if(data.inData()[i].mask()){$("#"+data.inData()[i].cssField()).mask(data.inData()[i].mask(),{placeholder:"_"});}});$("#"+self.settings.containerId.content.widget).show();self.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment();}if(self.settings.animate){self.settings.animate();}}catch(e){self.Exception("Ошибка шаблона ["+self.GetTmplName("content")+"]",e);if(self.settings.tmpl.custom){delete self.settings.tmpl.custom;self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.InsertContainer.Content();self.Render.Content(data);});}else{self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);self.WidgetLoader(true,self.settings.containerId.content.widget);}}}else{self.Exception("Ошибка. Не найден контейнер ["+self.settings.containerId.content.widget+"]");self.WidgetLoader(true);}},Error:function(data){if($("#"+self.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+self.settings.containerId.content.widget)[0]);ko.applyBindings(data,$("#"+self.settings.containerId.content.widget)[0]);$("#"+self.settings.containerId.content.widget).show();self.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment();}if(self.settings.animate){self.settings.animate();}}catch(e){self.Exception("Ошибка шаблона ["+self.GetTmplName("error")+"]",e);if(self.settings.tmpl.custom){delete self.settings.tmpl.custom;self.BaseLoad.Tmpl(self.settings.tmpl,function(){self.InsertContainer.Content();self.Render.Content(data);});}else{self.InsertContainer.EmptyWidget("#"+self.settings.containerId.content.widget);self.WidgetLoader(true,self.settings.containerId.content.widget);}}}else{self.Exception("Ошибка. Не найден контейнер ["+self.settings.containerId.content.widget+"]");self.WidgetLoader(true);}}};};var StandaloneButtonPaymentViewModel=function(opt){var self=this;self.title=opt.title;self.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{});};};var StandalonePaymentListViewModel=function(settings){var self=this;self.isGoodsId=ko.observable();self.title=ko.observable();self.count=ko.observable();self.amount=ko.observable();self.formatAmount=ko.observable();self.cssAmount="pokupo_amount";self.cssCount="pokupo_count";if(settings.idGoods){self.title(settings.goodsInfo.main.chort_name);self.count(settings.count);var coast=settings.count*parseFloat(settings.goodsInfo.main.sell_end_cost);self.amount(coast);self.isGoodsId(true);}if(settings.idShop&&!settings.idGoods){self.title(settings.description);if(settings.amount){self.amount(parseFloat(settings.amount));}self.isGoodsId(false);}if(self.amount()){self.formatAmount=self.amount().toFixed(2);}self.mailUser=ko.observable();self.idMethodPayment=ko.observable(settings.idMethodPayment);self.payments=ko.observableArray();self.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};self.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(settings.showCount),showAmount:ko.observable(settings.showAmount)};self.Cookie={Set:{UserEmail:function(email){$.cookie(Config.Base.cookie.userEmail,email);}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail);}}};var mail="";if(settings.mailUser){mail=settings.mailUser;}else{if(self.Cookie.Get.UserEmail()){mail=self.Cookie.Get.UserEmail();}}self.mailUser(mail);self.CountValidation=function(){if(!self.count()){self.error.count(Config.StandalonePayment.Error.count.empty);self.show.errorCount(true);return false;}if(parseInt(self.count())!=self.count()){self.error.count(Config.StandalonePayment.Error.count.integer);self.show.errorCount(true);return false;}self.error.count(null);self.show.errorCount(false);return true;};self.AmountValidation=function(){if(!self.amount()){self.error.amount(Config.StandalonePayment.Error.coast.empty);self.show.errorAmount(true);return false;}if(isNaN(self.amount())){self.error.amount(Config.StandalonePayment.Error.coast.integer);self.show.errorAmount(true);return false;}if(parseFloat(self.amount())!=self.amount()){self.error.amount(Config.StandalonePayment.Error.coast.integer);self.show.errorAmount(true);return false;}if(self.amount()<0.01){self.error.amount(Config.StandalonePayment.Error.coast.integer);self.show.errorAmount(true);return false;}self.error.amount(null);self.show.errorAmount(false);return true;};self.EmailValidation=function(){if(!self.mailUser()){self.error.email(Config.StandalonePayment.Error.email.empty);self.show.errorEmail(true);return false;}if(self.mailUser().length>64){self.error.email(Config.StandalonePayment.Error.email.maxLength);self.show.errorEmail(true);return false;}if(!Config.StandalonePayment.regular.email.test(self.mailUser())){self.error.email(Config.StandalonePayment.Error.email.regular);self.show.errorEmail(true);return false;}self.error.email(null);self.show.errorEmail(false);return true;};EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.validate",function(data){var test=true;if(!self.EmailValidation()){test=false;}if(!self.CountValidation()&&self.isGoodsId()){test=false;}if(!self.AmountValidation()&&!self.isGoodsId()){test=false;}if(test){self.Cookie.Set.UserEmail(self.mailUser());data.callback();}});};var StandalonePaymentItemViewModel=function(obj,data){var self=this;self.id=obj.id;self.namePayment=obj.name_payment;self.costPayment=obj.cost_payment;self.descPayment=obj.desc_payment;self.instrPayment=obj.instr_payment;self.logoPayment=obj.logo_payment;self.timePayment=obj.time_payment;self.itog=ko.computed(function(){if(data.amount()&&!data.AmountValidation()){return 0;}var result=(data.amount()?parseFloat(data.amount()):0)+(self.costPayment?parseFloat(self.costPayment):0);if(result==0||isNaN(result)){return 0;}else{result=result.toFixed(2);return result;}},this);self.errorEmail=ko.observable();self.Click={SelectPayment:function(){data.idMethodPayment(self.id);data.paymentInfo=self;EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.validate",{data:data,callback:function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.select",data);}});}};};var StandalonePaymentViewModel=function(settings){var self=this;self.paymentInfo={};self.showPaymentInfo=false;self.instruction=ko.observable();self.cssInstruction="instructtion_print_block";self.idMethodPayment=settings.idMethodPayment;self.outData=ko.observableArray();self.inData=ko.observableArray();self.isInData=ko.observable(false);self.cssInDataForm="in_data_block";self.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};self.isPayForm=ko.observable(false);self.urlInvoice=ko.observable();self.cssInvoice="invoice_print_block";self.Print=function(id){var w=window.open();w.document.write($("#"+id).html());w.print();w.close();};self.ClickPrintInstruction=function(){self.Print(self.cssInstruction);};self.ClickPrintInvoice=function(){self.Print(self.cssInvoice);};self.Back=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.back");};self.ClickPay=function(){$("#"+self.payForm.cssPayForm).submit();};self.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true);};self.ClickSubmit=function(){if(self.ValidationFrom()){EventDispatcher.DispatchEvent("StandalonePaymentWidget.form.submit",self);}};self.ValidationFrom=function(){var test=true;$.each(self.inData(),function(i){if(!self.inData()[i].ValidateField()){test=false;return false;}});return test;};self.AddContent=function(data){self.instruction(null);if(data.hasOwnProperty("instruction")){self.instruction(data.instruction);}self.outData=ko.observableArray();if(data.hasOwnProperty("out_data")){$.each(data.out_data,function(i){self.outData.push(data.out_data[i]);});}self.isPayForm(false);self.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};self.isPayForm(false);if(data.hasOwnProperty("pay_form")){self.isPayForm(true);self.payForm.action(data.pay_form.action);self.payForm.method(data.pay_form.method);if(data.pay_form.hasOwnProperty("new_window")&&data.pay_form.new_window=="yes"){self.payForm.target("_blank");}$.each(data.pay_form.hidden_field,function(i){var field={name:"",value:""};if(data.pay_form.hidden_field[i].name){field.name=data.pay_form.hidden_field[i].name;}if(data.pay_form.hidden_field[i].value){field.value=data.pay_form.hidden_field[i].value;}self.payForm.field.push(field);});}self.isInData(false);self.inData=ko.observableArray();if(data.hasOwnProperty("in_data")){self.isInData(true);$.each(data.in_data,function(i){var field=new StandalonePaymentFieldViewModel();field.AddContent(data.in_data[i]);self.inData.push(field);});}self.urlInvoice(null);if(data.hasOwnProperty("url_invoice")){self.urlInvoice(data.url_invoice);}if(!$.isEmptyObject(self.paymentInfo)){self.showPaymentInfo=true;}};};var StandalonePaymentFieldViewModel=function(){var self=this;self.label=ko.observable();self.help=ko.observable();self.error=ko.observable();self.name=ko.observable();self.value=ko.observable();self.required=ko.observable(false);self.typeField=ko.observable();self.listSelect=ko.observableArray();self.regExp=ko.observable();self.mask=ko.observable();self.maxlength=ko.observable();self.cssField=ko.observable();self.AddContent=function(data){if(data.hasOwnProperty("label")){self.label(data.label);}if(data.hasOwnProperty("help")){self.help(data.help);}if(data.hasOwnProperty("error")){self.error(data.error);}if(data.hasOwnProperty("name")){self.name(data.name);self.cssField("field_"+data.name);}if(data.hasOwnProperty("value")){self.value(data.value);}if(data.hasOwnProperty("required")){if(data.required=="yes"){self.required(true);}}if(data.hasOwnProperty("type_field")){self.typeField(data.type_field);}if(data.hasOwnProperty("list_select")){$.each(data.list_select,function(i){self.listSelect.push(data.list_select[i]);});}if(data.hasOwnProperty("reg_exp")){self.regExp(data.reg_exp);}if(data.hasOwnProperty("mask")){self.mask(data.mask);}if(data.hasOwnProperty("maxlength")){self.maxlength(data.maxlength);}};self.ValidateField=function(){if(self.required()){if(!self.value()){self.error(Config.ButtonPayment.Error.required);return false;}}if(self.maxlength()){if(self.value().length>self.maxlength()){self.error(Config.ButtonPayment.Error.maxlength.replace("%s%",self.maxlength()));return false;}}return true;};};var StandalonePaymentErrorViewModel=function(data,settings){var self=this;self.code=data.err;self.message=data.msg;self.hasPaymentList=settings.paymentList;self.ClickClearPayment=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.clear");};};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var payment=new StandalonePaymentWidget();payment.Init(payment);}else{setTimeout(function(){TestStandalonePayment.Init();},100);}}};TestStandalonePayment.Init();