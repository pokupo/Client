var JSSettings={shopId:0,protocolHTTP:"https://",protocolHTTPS:"https://",host:"server.pokupo.ru/prod/server/",pathToJS:"js/",pathToTmpl:"pokupo.ru/themes/",theme:"default",pathToData:"prod/server/services/DataProxy.php?query=",pathToPostData:"prod/server/services/DataPostProxy.php",pathToCore:"index.html",pathToPostCore:"postData.html",hostApi:"api.pokupo.ru/",catalogPathApi:"catalog/",goodsPathApi:"goods/",userPathApi:"user/",cartPathApi:"cart/",favPathApi:"fav/",geoPathApi:"geo/",shopPathApi:"shop/",orderPathApi:"order/",paymentPathApi:"payment/",messagePathApi:"message/",dev:false,sourceData:"api",devScripts:["easyXDM.min.js","knockout-3.2.0.js","jquery.cookie.js","jquery.textchange.min.js","widgets/Config-1.1.js","widgets/Routing-1.0.js","widgets/Paging-1.0.js","widgets/Widget-1.1.js"],scripts:["widgets/widgets.lib.min.js"],inputParameters:{}};var EventDispatcher={events:[],AddEventListener:function(a,b){this.events[a]=this.events[a]||[];if(this.events[a]){this.RemoveEventListener(a,b);this.events[a].push(b)}},RemoveEventListener:function(d,e){if(this.events[d]){var c=this.events[d];var a=EventDispatcher.HashCode(e.toString());for(var b=c.length-1;b>=0;--b){if(EventDispatcher.HashCode(c[b].toString())===a){c.splice(b,1);return true}}}return false},DispatchEvent:function(c,d){if(this.events[c]){var b=this.events[c],a=b.length;while(a--){b[a](d)}}},HashCode:function(d){var c=0,a,b;if(d.length==0){return c}for(a=0;a<d.length;a++){b=d.charCodeAt(a);c=((c<<5)-c)+b;c=c&c}return c},GetUUID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)});return a}};var JSLoader={loaded:false,loadedCount:0,pathToJs:null,Init:function(a,b){this.pathToJs=b;JSLoader.Load(a,function(){JSLoader.RegisterLoaded(a)})},RegisterLoaded:function(a){JSLoader.loadedCount=JSLoader.loadedCount+1;if(JSLoader.loadedCount==a.length){JSLoader.OnReady()}},OnReady:function(){if(typeof ko=="object"){JSLoader.loaded=true;EventDispatcher.DispatchEvent("onload.scripts")}else{setTimeout(function(){JSLoader.OnReady()},100)}},Load:function(a,c){for(var b in a){$.getScript(this.pathToJs+a[b],function(){if(c){c()}})}}};var JSCore={version:1.2,isReady:false,shopId:null,dev:false,Init:function(){if(document.location.protocol=="https:"){JSSettings.protocolHTTP=JSSettings.protocolHTTPS}JSCore.SetInputParameters();var a=JSSettings.scripts;if(JSSettings.dev){a=JSSettings.devScripts}JSLoader.Init(a,JSSettings.protocolHTTP+JSSettings.host+JSSettings.pathToJS);JSCore.shopId=JSSettings.shopId;XDMTransport.Init(JSSettings.host+JSSettings.pathToCore);JSCore.isReady=true},ParserInputParameters:function(f){var e={};var a=$("script").filter(function(){return f.test($(this).attr("src"))}).attr("src");if(a){var b=a.split("?");if(b.length>1){var d=b[1].split("&");for(var c=0;c<=d.length-1;c++){var g=d[c].split("=");e[g[0]]=g[1]}}}if(e){return e}return null},SetInputParameters:function(){var a=JSCore.ParserInputParameters(/JSCore/);if($.isEmptyObject(a)){a=JSCore.ParserInputParameters(/pokupo.widgets.[a-z0-9]{32}.min.js/)}if(a){for(var b in a){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=a[b]}}}if(typeof WParameters!=="undefined"&&WParameters.core){for(var b in WParameters.core){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=WParameters.core[b]}}}JSSettings.inputParameters.shopId=JSSettings.shopId}};var XDMTransport={remote:"",event:{},Init:function(a){XDMTransport.remote=a},GetProtocol:function(a){if(a){return JSSettings.protocolHTTPS}else{return JSSettings.protocolHTTP}},EventExecute:function(b,a){$.each(XDMTransport.event[a],function(c){XDMTransport.event[a][c](b)});delete XDMTransport.event[a]},Load:{FromProxy:function(b){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Socket({remote:XDMTransport.GetProtocol(b.protocol)+XDMTransport.remote,onMessage:function(c){if(b.callback){b.callback(c)}}});a.postMessage(JSSettings.pathToData+b.url)}else{setTimeout(function(){XDMTransport.Load.FromProxy(b)},1000)}},FromApi:function(a){$.ajax({type:"GET",async:true,url:decodeURIComponent(a.url),dataType:a.type,success:function(b){if(a.callback){a.callback(b)}}})},Tmpl:function(b,c){var a=XDMTransport.GetProtocol()+JSSettings.pathToTmpl+JSSettings.theme+"/tmpl/"+b;if(/^(https?|ftp)\:\/\/(www\.)?([a-zA-Z0-9\.\-]+\.[a-z]{2,})(\/.+)$/.test(b)){a=b}XDMTransport.Load.FromProxy({url:a,callback:c,protocol:null})},Data:function(a,d,c){c=JSSettings.protocolHTTPS;var b=EventDispatcher.HashCode(a+d.toString());if(XDMTransport.event[b]==undefined){XDMTransport.event[b]=[]}XDMTransport.event[b].push(d);if(XDMTransport.event[b].length==1){if(JSSettings.sourceData=="api"){XDMTransport.Load.FromApi({type:"jsonp",url:decodeURIComponent(a),callback:function(e){XDMTransport.EventExecute(e,b)}})}if(JSSettings.sourceData=="proxy"){XDMTransport.Load.FromProxy({url:a,protocol:c,callback:function(e){XDMTransport.EventExecute(JSON.parse(e),b)}})}}},DataPost:function(b,c){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Rpc({remote:XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostCore,onReady:function(){b.attr("action",XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostData);b.submit()}},{local:{returnUploadResponse:function(d){EventDispatcher.DispatchEvent(EventDispatcher.HashCode(b.toString()),JSON.parse(d.msg))}}})}else{setTimeout(function(){XDMTransport.Load.DataPost(b,c)},1000)}}}};var Logger={Console:{Exception:function(b,d,c){console&&console.log("Exception : "+new Date()+" : "+b+" : "+d);if(c){var a="";if(c.message){a+=c.message}if(c.stack){a+=" | stack: "+c.stack}console&&console.log(a)}},Info:function(a,b){console&&console.log("Info : "+new Date()+" : "+a+" : "+b)},VarDump:function(b,a,c){console&&console.log("Var Dump : "+b+" : "+a);console&&console.log(c)}}};$().ready(function(){JSCore.Init()});
var StandalonePaymentWidget=function(){var a=this;a.widgetName="StandalonePaymentWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:{button:"",content:""},customContainer:null,tmpl:{path:null,id:{button:null,paymentList:null,content:null,error:null}},animate:null,inputParameters:{},containerButton:null,title:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:false,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",showButton:null,userParams:{},backUrl:""};a.InitWidget=function(){a.settings.containerId=Config.Containers.standalonePayment;a.settings.tmpl=Config.StandalonePayment.tmpl;a.settings.title=Config.StandalonePayment.title;a.settings.showButton=Config.StandalonePayment.showButton;a.CheckRouteStandalonePayment()};a.SetParameters=function(h){var d={};if(Config.Base.sourceParameters=="string"){var c=JSCore.ParserInputParameters(/StandalonePaymentWidget/);if(c.standalonePayment){d=c.standalonePayment}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standalonePayment){d=WParameters.standalonePayment}if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Input parameters",d)}if(!$.isEmptyObject(d)){var b=Routing.params,f=a.settings;if(d.title){f.title=d.title}if(d.idGoods){f.idGoods=d.idGoods;f.showAmount=false}else{if(b.idGoods){f.idGoods=b.idGoods;f.showAmount=false}else{f.idShop=JSSettings.shopId}}if(d.count){f.count=d.count;f.showCount=false}else{if(b.count){f.count=b.count;f.showCount=false}}if(d.amount){f.amount=d.amount;f.showAmount=false}else{if(b.amount){f.amount=b.amount;f.showAmount=false}else{if(!f.idGoods){f.showAmount=true}}}if(d.uid){f.uid=d.uid}if(b.uid){f.uid=b.uid}if(d.idShopPartner){f.idShopPartner=d.idShopPartner}if(b.idShopPartner){f.idShopPartner=b.idShopPartner}if(d.mailUser){f.mailUser=d.mailUser}else{if(b.mailUser){f.mailUser=b.mailUser}}if(d.idMethodPayment){f.idMethodPayment=d.idMethodPayment}if(b.idMethodPayment){f.idMethodPayment=b.idMethodPayment}if(d.description){f.description=d.description}if(b.description){f.description=b.description}if(d.backUrl){f.backUrl=d.backUrl}else{if(b.backUrl){f.backUrl=b.backUrl}}if(b.userParams){var g=decodeURIComponent(b.userParams);f.userParams=g.replace(/(^\?)/,"").split("&").map(function(i){return i=i.split("="),this[i[0]]=i[1],this}.bind({}))[0]}if(d.userParams){$.each(d.userParams,function(k,j){f.userParams[k]=j})}if(d.showButton){f.showButton=d.showButton}if(d.tmpl){if(d.tmpl.path){f.tmpl.path=d.tmpl.path}if(d.tmpl.id){for(var e in d.tmpl.id){f.tmpl.id[e]=d.tmpl.id[e]}}}if(d.container){if(d.container){for(var e in d.container){f.containerId[e]=d.container[e]}}}if(d.animate){f.animate=d.animate}}f.inputParameters=d;if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Result settings",f)}a.settings=f};a.CheckRouteStandalonePayment=function(){a.SetParameters();a.RegisterEvents();a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(Routing.route=="standalone_payment"){if(a.settings.idGoods!=null){a.BaseLoad.GoodsInfo(a.settings.idGoods,"1000000",function(b){a.settings.goodsInfo=b;if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}})}if(a.settings.idShop!=null&&a.settings.idGoods==null){a.GetData.Service()}}else{if(a.settings.showButton&&Routing.route!="status_payment"){a.InsertContainer.Button();a.Fill.Button()}else{a.WidgetLoader(true)}}})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.select",function(b){a.settings.idMethodPayment=b.idMethodPayment();a.settings.paymentInfo=b.paymentInfo;a.settings.mailUser=b.mailUser();if(a.settings.idGoods!=null){a.settings.count=b.count();if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}}if(a.settings.idShop!=null){a.settings.amount=b.amount();a.GetData.Service()}});EventDispatcher.AddEventListener("StandalonePaymentWidget.back",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("w.change.route",function(){a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.clear",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.form.submit",function(c){a.InsertContainer.Content();var b=[];$.each(c.inData(),function(e){if(c.inData()[e].name()=="MOBILE_PHONE"){b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value().replace(/\s/g,"").replace(/-/g,"")))}else{b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value()))}});var d=b.join("&");if(Routing.params.orderId){d=Routing.params.orderId+"?"+d;a.GetData.Order(d)}if(Routing.params.goodsId){d=Routing.params.goodsId+"?"+d;a.GetData.Goods(d)}if(Routing.params.amount){d=Routing.params.amount+"/"+Parameters.shopId+"?"+d;a.GetData.Amount(d)}})};a.GetData={UserParametrs:function(){var b="";var c=[];$.each(a.settings.userParams,function(e,d){c.push(e+"="+d)});b=encodeURIComponent(encodeURIComponent(c.join("&")));return b},Price:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})},Goods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesGoods(c,function(d){a.Fill.PaymentList(d)})},PartnerGoods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesPartnerGoods(c,function(d){a.Fill.PaymentList(d)})},Service:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(a.settings.userParams){b.push("userParams="+a.GetData.UserParametrs())}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})}};a.InsertContainer={EmptyWidget:function(b){var c=$(b).find(a.SelectCustomContent().join(", ")).clone();$(b).empty().html(c)},Button:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);$("#"+a.settings.containerId.button.widget).html($("script#"+a.GetTmplName("button")).html())},PaymentList:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("paymentList")).html())},Content:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("content")).html()).hide()},Error:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("error")).html()).hide()}};a.Fill={Button:function(){var b=new StandaloneButtonPaymentViewModel(a.settings);a.Render.Button(b)},PaymentList:function(c){if(c.hasOwnProperty("err")){a.InsertContainer.Error();a.Fill.Error(c)}else{if(!c.hasOwnProperty("pay_form")){var b=new StandalonePaymentListViewModel(a.settings);b.error.base("");b.show.errorBase(false);if(c){$.each(c,function(d){a.settings.paymentList=true;b.payments.push(new StandalonePaymentItemViewModel(c[d],b))})}a.InsertContainer.PaymentList();a.Render.PaymentList(b)}else{a.InsertContainer.Content();a.Fill.Content(c)}}},Content:function(e){var d=new StandalonePaymentViewModel(a.settings);var f=[];var c={};if(e.pay_form){c=e.pay_form.hidden_field}var b=null;$.each(c,function(g){f.push(c[g].name+"="+encodeURIComponent(c[g].value));if(c[g].name=="PKP_ID_ORDER"){b=c[g].value}});if(b){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+b)}else{if(f){$.cookie(Config.Base.cookie.orderId,f.join("&"))}}d.paymentInfo=a.settings.paymentInfo;d.AddContent(e);a.Render.Content(d)},Error:function(c){var b=new StandalonePaymentErrorViewModel(c,a.settings);a.Render.Error(b)}};a.Render={Button:function(b){if($("#"+a.settings.containerId.button.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.button.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.button.widget)[0]);a.WidgetLoader(true,a.settings.containerId.button.widget);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("button")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Button();a.Render.Button(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);a.WidgetLoader(true,a.settings.containerId.button.widget)}}}else{a.WidgetLoader(true)}},PaymentList:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}if(a.settings.showAmount){$("#"+b.cssAmount).bind("textchange",function(e,d){var f=$(this).val();b.amount(f);a.settings.amount=f;setTimeout(function(){if(f==a.settings.amount){a.GetData.Price()}},500)});$("#"+b.cssAmount).focus()}$("#"+b.cssCount).bind("textchange",function(e,d){b.count($(this).val())})}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("paymentList")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.PaymentList()();a.Render.PaymentList(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Content:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$.each(b.inData(),function(d){if(b.inData()[d].mask()){$("#"+b.inData()[d].cssField()).mask(b.inData()[d].mask(),{placeholder:"_"})}});$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Error:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("error")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}}}};var StandaloneButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{})}};var StandalonePaymentListViewModel=function(c){var b=this;b.isGoodsId=ko.observable();b.title=ko.observable();b.count=ko.observable();b.amount=ko.observable();b.formatAmount=ko.observable();b.cssAmount="pokupo_amount";b.cssCount="pokupo_count";if(c.idGoods){b.title(c.goodsInfo.main.chort_name);b.count(c.count);var d=c.count*parseFloat(c.goodsInfo.main.sell_end_cost);b.amount(d);b.isGoodsId(true)}if(c.idShop&&!c.idGoods){b.title(c.description);if(c.amount){b.amount(parseFloat(c.amount))}b.isGoodsId(false)}if(b.amount()){b.formatAmount=b.amount().toFixed(2)}b.mailUser=ko.observable();b.idMethodPayment=ko.observable(c.idMethodPayment);b.payments=ko.observableArray();b.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};b.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(c.showCount),showAmount:ko.observable(c.showAmount)};b.Cookie={Set:{UserEmail:function(e){$.cookie(Config.Base.cookie.userEmail,e)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var a="";if(c.mailUser){a=c.mailUser}else{if(b.Cookie.Get.UserEmail()){a=b.Cookie.Get.UserEmail()}}b.mailUser(a);b.CountValidation=function(){if(!b.count()){b.error.count(Config.StandalonePayment.Error.count.empty);b.show.errorCount(true);return false}if(parseInt(b.count())!=b.count()){b.error.count(Config.StandalonePayment.Error.count.integer);b.show.errorCount(true);return false}b.error.count(null);b.show.errorCount(false);return true};b.AmountValidation=function(){if(!b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.empty);b.show.errorAmount(true);return false}if(isNaN(b.amount())){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}if(parseFloat(b.amount())!=b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}if(b.amount()<0.01){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}b.error.amount(null);b.show.errorAmount(false);return true};b.EmailValidation=function(){if(!b.mailUser()){b.error.email(Config.StandalonePayment.Error.email.empty);b.show.errorEmail(true);return false}if(b.mailUser().length>64){b.error.email(Config.StandalonePayment.Error.email.maxLength);b.show.errorEmail(true);return false}if(!Config.StandalonePayment.regular.email.test(b.mailUser())){b.error.email(Config.StandalonePayment.Error.email.regular);b.show.errorEmail(true);return false}b.error.email(null);b.show.errorEmail(false);return true};EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.validate",function(e){var f=true;if(!b.EmailValidation()){f=false}if(!b.CountValidation()&&b.isGoodsId()){f=false}if(!b.AmountValidation()&&!b.isGoodsId()){f=false}if(f){b.Cookie.Set.UserEmail(b.mailUser());e.callback()}});b.Back=function(){window.location.href=c.backUrl}};var StandalonePaymentItemViewModel=function(c,b){var a=this;a.id=c.id;a.namePayment=c.name_payment;a.costPayment=c.cost_payment;a.descPayment=c.desc_payment;a.instrPayment=c.instr_payment;a.logoPayment=c.logo_payment;a.timePayment=c.time_payment;a.itog=ko.computed(function(){if(b.amount()&&!b.AmountValidation()){return 0}var d=(b.amount()?parseFloat(b.amount()):0)+(a.costPayment?parseFloat(a.costPayment):0);if(d==0||isNaN(d)){return 0}else{d=d.toFixed(2);return d}},this);a.errorEmail=ko.observable();a.Click={SelectPayment:function(){b.idMethodPayment(a.id);b.paymentInfo=a;EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.validate",{data:b,callback:function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.select",b)}})}}};var StandalonePaymentViewModel=function(b){var a=this;a.paymentInfo={};a.showPaymentInfo=false;a.instruction=ko.observable();a.cssInstruction="instructtion_print_block";a.idMethodPayment=b.idMethodPayment;a.outData=ko.observableArray();a.inData=ko.observableArray();a.isInData=ko.observable(false);a.cssInDataForm="in_data_block";a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm=ko.observable(false);a.urlInvoice=ko.observable();a.cssInvoice="invoice_print_block";a.Print=function(d){var c=window.open();c.document.write($("#"+d).html());c.print();c.close()};a.ClickPrintInstruction=function(){a.Print(a.cssInstruction)};a.ClickPrintInvoice=function(){a.Print(a.cssInvoice)};a.Back=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.back")};a.ClickPay=function(){$("#"+a.payForm.cssPayForm).submit()};a.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};a.ClickSubmit=function(){if(a.ValidationFrom()){EventDispatcher.DispatchEvent("StandalonePaymentWidget.form.submit",a)}};a.ValidationFrom=function(){var c=true;$.each(a.inData(),function(d){if(!a.inData()[d].ValidateField()){c=false;return false}});return c};a.AddContent=function(c){a.instruction(null);if(c.hasOwnProperty("instruction")){a.instruction(c.instruction)}a.outData=ko.observableArray();if(c.hasOwnProperty("out_data")){$.each(c.out_data,function(d){a.outData.push(c.out_data[d])})}a.isPayForm(false);a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm(false);if(c.hasOwnProperty("pay_form")){a.isPayForm(true);a.payForm.action(c.pay_form.action);a.payForm.method(c.pay_form.method);if(c.pay_form.hasOwnProperty("new_window")&&c.pay_form.new_window=="yes"){a.payForm.target("_blank")}$.each(c.pay_form.hidden_field,function(d){var e={name:"",value:""};if(c.pay_form.hidden_field[d].name){e.name=c.pay_form.hidden_field[d].name}if(c.pay_form.hidden_field[d].value){e.value=c.pay_form.hidden_field[d].value}a.payForm.field.push(e)})}a.isInData(false);a.inData=ko.observableArray();if(c.hasOwnProperty("in_data")){a.isInData(true);$.each(c.in_data,function(d){var e=new StandalonePaymentFieldViewModel();e.AddContent(c.in_data[d]);a.inData.push(e)})}a.urlInvoice(null);if(c.hasOwnProperty("url_invoice")){a.urlInvoice(c.url_invoice)}if(!$.isEmptyObject(a.paymentInfo)){a.showPaymentInfo=true}}};var StandalonePaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var StandalonePaymentErrorViewModel=function(c,b){var a=this;a.code=c.err;a.message=c.msg;a.hasPaymentList=b.paymentList;a.ClickClearPayment=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.clear")};a.ClickBack=function(){}};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var a=new StandalonePaymentWidget();a.Init(a)}else{setTimeout(function(){TestStandalonePayment.Init()},100)}}};TestStandalonePayment.Init();
var StandaloneGoodsWidget=function(){var j=this;j.widgetName="StandaloneGoodsWidget";j.version=1;j.minWidgetVersion=1;j.maxWidgetVersion=2;j.minTmplVersion=1;j.maxTmplVersion=2;j.goods=null;j.hasButton=false;j.settings={idGoods:null,count:1,idShopPartner:null,mailUser:null,idMethodPayment:null,containerId:null,tmpl:{path:null,id:null},animate:null,showBlocks:null,button:null,inputParameters:{},styleGoods:null,customContainer:null,infoBlock:1111111};j.InitWidget=function(){j.settings.containerId=Config.Containers.standaloneGoods.widget;j.settings.customContainer=Config.Containers.standaloneGoods.customClass;j.settings.tmpl=Config.StandaloneGoods.tmpl;j.settings.showBlocks=Config.StandaloneGoods.showBlocks;j.settings.styleGoods=Config.StandaloneGoods.style;j.settings.button=Config.StandaloneGoods.button;c();i();b();e()};function c(){var m={};if(Config.Base.sourceParameters=="string"){var l=JSCore.ParserInputParameters(/StandaloneGoodsWidget/);if(l.goods){m=l.goods}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standaloneGoods){m=WParameters.standaloneGoods}var k=Routing.params,o=j.settings;if(k.id){o.idGoods=k.id}if(k.idShopPartner){o.idShopPartner=k.idShopPartner}if(k.mailUser){o.mailUser=k.mailUser}if(k.idMethodPayment){o.idMethodPayment=k.idMethodPayment}if(k.button){o.button.active=k.button}if(k.count){o.count=k.count}if(m.infoBlock){o.infoBlock=m.infoBlock}if(!$.isEmptyObject(m)){if(m.idGoods){o.idGoods=m.idGoods}if(m.show){for(var n=0;n<=m.show.length-1;n++){if($.inArray(m.show[n],o.showBlocks)<0){o.showBlocks.push(m.show[n])}}}if(m.button){o.button.active=m.button}if(m.count){o.count=m.count}if(m.animate){o.animate=m.animate}}if(k.blockIdGoods&&$.inArray("blockIdGoods",o.showBlocks)<0){o.showBlocks.push("blockIdGoods")}if(k.blockShortName&&$.inArray("blockShortName",o.showBlocks)<0){o.showBlocks.push("blockShortName")}if(k.blockFullName&&$.inArray("blockFullName",o.showBlocks)<0){o.showBlocks.push("blockFullName")}if(k.blockGallery&&$.inArray("blockGallery",o.showBlocks)<0){o.showBlocks.push("blockGallery")}if(k.blockShop&&$.inArray("blockShop",o.showBlocks)<0){o.showBlocks.push("blockShop")}if(k.blockInfoSeller&&$.inArray("blockInfoSeller",o.showBlocks)<0){o.showBlocks.push("blockInfoSeller")}if(k.blockCount&&$.inArray("blockCount",o.showBlocks)<0){o.showBlocks.push("blockCount")}if(k.editableCount&&$.inArray("editableCount",o.showBlocks)<0){o.showBlocks.push("editableCount")}if(k.blockShare&&$.inArray("blockShare",o.showBlocks)<0){o.showBlocks.push("blockShare")}if(k.blockDescription&&$.inArray("blockDescription",o.showBlocks)<0){o.showBlocks.push("blockDescription")}if(k.blockShipping&&$.inArray("blockShipping",o.showBlocks)<0){o.showBlocks.push("blockShipping")}if(k.blockOpinion&&$.inArray("blockOpinion",o.showBlocks)<0){o.showBlocks.push("blockOpinion")}if(!$.isEmptyObject(m)){if(m.hide){for(var n=0;n<=m.hide.length-1;n++){var p=$.inArray(m.hide[n],o.showBlocks);if(p>0){o.showBlocks.splice(p,1)}}}}o.inputParameters=m;j.settings=o}function b(){if(Routing.route=="goods"||Routing.IsDefault()){j.BaseLoad.Tmpl(j.settings.tmpl,function(){j.BaseLoad.Script("widgets/GoodsViewModel-1.0.min.js",function(){f()})})}else{j.WidgetLoader(true)}}function i(){EventDispatcher.AddEventListener("w.change.route",function(){b()});EventDispatcher.AddEventListener("SGoods.onload.info",function(k){j.Fill.Content(k)})}function f(){j.BaseLoad.GoodsInfo(j.settings.idGoods,j.settings.infoBlock,function(k){EventDispatcher.DispatchEvent("SGoods.onload.info",k)})}function a(){var k=$("#"+j.settings.containerId).find(j.SelectCustomContent().join(", ")).clone();$("#"+j.settings.containerId).empty().html(k)}function d(){a();$("#"+j.settings.containerId).append($("script#"+j.GetTmplName()).html()).children().hide()}j.Fill={Content:function(l){StandaloneGoodsViewModel.prototype=new GoodsViewModel();j.goods=new StandaloneGoodsViewModel(j.settings);for(var k in l){if(k=="opinion"&&$.inArray("blockOpinion",j.settings.showBlocks)<0){continue}if(k=="shipping"&&$.inArray("blockShipping",j.settings.showBlocks)<0){continue}if(typeof j.Fill[k.charAt(0).toUpperCase()+k.substr(1).toLowerCase()]=="function"){j.Fill[k.charAt(0).toUpperCase()+k.substr(1).toLowerCase()](l[k])}else{j.Fill.Block(k,l[k])}}j.goods.CheckShow();j.goods.blocks.main.sellerId=l.seller.id;j.goods.blocks.main.shopId=l.shop.id;j.goods.SetListMoreBlock("standalone");h(j.goods)},Main:function(l){GoodsMainBlockViewModel.prototype=new Widget();j.goods.AddBlock("main",new GoodsMainBlockViewModel(l));if($.inArray("blockDescription",j.settings.showBlocks)>=0){var k="blockDescription";j.goods.AddBlock(k,l.description);if(l.description&&l.description.match(/data-bind/)){j.hasButton=k}}if(j.settings.count&&j.settings.count<=j.goods.blocks.main.count()){j.goods.blocks.main.ordered(j.settings.count)}else{j.goods.blocks.main.count(0)}},Gallery:function(m){var k=[];for(var l=0;l<=m.length-1;l++){k[l]=new GalleryBlockViewModel(m[l])}j.goods.AddBlock("gallery",k)},Seller:function(k){j.goods.sellerInfo.seller=k},Shop:function(k){j.goods.sellerInfo.shop=k},Operator:function(k){j.goods.sellerInfo.operator=k},Block:function(l,n){var o=new MoreBlockViewModel(l);if(l=="shipping"){var k=[];for(var m in n){k.push(new ShippingBlockViewModel(n[m]))}n=k;l="blockShipping"}if(l=="opinion"){l="blockOpinion"}o.AddParams(n);j.goods.AddBlock(l,o)}};function h(k){if($("#"+j.settings.containerId).length>0){try{d();ko.cleanNode($("#"+j.settings.containerId)[0]);ko.applyBindings(k,$("#"+j.settings.containerId)[0]);if(j.hasButton){$.each(k.moreBlock,function(n){if(k.moreBlock[n].key==j.hasButton){var m=$("#"+k.moreBlock[n].idBlock+" [data-bind^=click]");$.each(m,function(o){if(k.blocks.main.showAddToCart()){if($(m[o]).attr("data-bind").match(/AddToCart/)){var q=new AddToCartButtonViewModel(k.blocks.main);ko.applyBindings(q,m[o])}}else{$(m[o]).hide()}if(k.blocks.main.showBuy()){if($(m[o]).attr("data-bind").match(/Buy/)){var p=new BuyButtonViewModel(k.blocks.main);ko.applyBindings(p,m[o])}}else{$(m[o]).hide()}})}})}if(typeof AnimateStandaloneGoods=="function"){new AnimateStandaloneGoods()}if(j.settings.animate){j.settings.animate()}g(k);delete k;j.WidgetLoader(true,j.settings.containerId)}catch(l){j.Exception("Ошибка шаблона ["+j.GetTmplName()+"]",l);if(j.settings.tmpl.custom){delete j.settings.tmpl.custom;j.BaseLoad.Tmpl(j.settings.tmpl,function(){d();h(k)})}else{a();j.WidgetLoader(true,j.settings.containerId)}}}else{j.Exception("Ошибка. Не найден контейнер ["+j.settings.containerId+"]");j.WidgetLoader(true,j.settings.containerId)}}function g(m){var k=$.cookie(Config.Base.cookie.previously_viewed);if(!k){$.cookie(Config.Base.cookie.previously_viewed,m.id)}else{var l=k.split(",");var n=$.inArray(m.id,l);if(n>=0){l.splice(n,1);l.unshift(m.id)}else{l.unshift(m.id)}if(l.length>20){l.splice(20,1)}$.cookie(Config.Base.cookie.previously_viewed,l.join(","))}var k=$.cookie(Config.Base.cookie.previously_viewed)}function e(){if(j.settings.inputParameters.position=="absolute"){for(var k in j.settings.inputParameters){if(j.settings.styleGoods[k]){j.settings.styleGoods[k]=j.settings.inputParameters[k]}}$().ready(function(){$("#"+j.settings.containerId).css(j.settings.styleGoods)})}}};var StandaloneGoodsViewModel=function(b){var a=this;a.activeButton=b.button.active;a.inactiveButton=b.button.inactive;a.show={blockIdGoods:false,blockShortName:false,blockFullName:false,blockGallery:false,blockShop:false,blockInfoSeller:false,blockOperator:false,blockCount:false,editableCount:false,blockShare:false,blockDescription:false,blockShipping:false,blockOpinion:false};a.ShowGallery=function(){if(a.blocks.gallery){return true}return false};a.CheckShow=function(){if($.inArray("blockIdGoods",b.showBlocks)>=0){a.show.blockIdGoods=true}if($.inArray("blockShortName",b.showBlocks)>=0){a.show.blockShortName=true}if($.inArray("blockFullName",b.showBlocks)>=0){a.show.blockFullName=true}if($.inArray("blockGallery",b.showBlocks)>=0){a.show.blockGallery=true}if($.inArray("blockShop",b.showBlocks)>=0){a.show.blockShop=true}if($.inArray("blockInfoSeller",b.showBlocks)>=0){a.show.blockInfoSeller=true}if($.inArray("blockOperator",b.showBlocks)>=0){a.show.blockOperator=true}if($.inArray("blockCount",b.showBlocks)>=0){a.show.blockCount=true}if($.inArray("editableCount",b.showBlocks)>=0){a.show.editableCount=true}if($.inArray("blockShare",b.showBlocks)>=0){a.show.blockShare=true}if($.inArray("blockDescription",b.showBlocks)>=0){a.show.blockDescription=true}if($.inArray("blockShipping",b.showBlocks)>=0){a.show.blockShipping=true}if($.inArray("blockOpinion",b.showBlocks)>=0){a.show.blockOpinion=true}};a.SetListMoreBlock=function(d){for(var c in Config.StandaloneGoods.moreBlocks){if($.inArray(c,b.showBlocks)>=0){StandaloneGoodsListMoreBlockViewModel.prototype=new GoodsListMoreBlockViewModel(c,a.blocks[c],d);a.moreBlock.push(new StandaloneGoodsListMoreBlockViewModel())}}};a.Buy=function(){var c={idGoods:b.idGoods,count:a.blocks.main.ordered()};if(b.idShopPartner){c.idShopPartner=b.idShopPartner}if(b.mailUser){c.mailUser=b.mailUser}if(b.idMethodPayment){c.idMethodPayment=b.idMethodPayment}Routing.SetHash("standalone_payment","Оплатить товар",c)}};var StandaloneGoodsListMoreBlockViewModel=function(){this.title=Config.StandaloneGoods.moreBlocks[this.key];this.templateName=this.prefix+this.key.charAt(0).toUpperCase()+this.key.substr(1)+"BlockTmpl"};var TestStandaloneGoods={Init:function(){if(typeof Widget=="function"){StandaloneGoodsWidget.prototype=new Widget();var a=new StandaloneGoodsWidget();a.Init(a)}else{setTimeout(function(){TestStandaloneGoods.Init()},100)}}};TestStandaloneGoods.Init();