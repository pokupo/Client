var FavoritesWidget=function(){var m=this;m.widgetName="FavoritesWidget";m.version=1;m.minWidgetVersion=1;m.maxWidgetVersion=2;m.minTmplVersion=1;m.maxTmplVersion=2;m.favorites=null;m.InitWidget=f;var d={container:{widget:"content",def:"defaultFavoritesWidgetId"},title:"Избранное",tmpl:{path:"favoritesTmpl.html",id:{content:"favoritesTmpl",empty:"emptyFavoritesTmpl"}},showBlocks:["infoShop","addToCart","buy"],message:{clearGoods:"Выбранные товары удалены из избранного.",failClearGoods:"Произошла ошибка при удалении товара из избранного. Попробуйте еще раз.",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из избранного?",confirmRemove:"Вы уверены что хотите удалить товар из избранного?",confirmClearFavorites:"Вы уверены, что хотите очистить избранное от товаров?"},animate:typeof AnimateFavorite=="function"?AnimateFavorite:null};function f(){k();b();m.CheckRouteFavorites()}function b(){var n=m.GetInputParameters("favorites");if(!$.isEmptyObject(n)){d=m.UpdateSettings1(d,n);if(n.show){for(var o=0;o<=d.showBlocks.length-1;o++){if($.inArray(d.showBlocks[o],n.show)<0){d.showBlocks.splice(d.showBlocks.indexOf(d.showBlocks[o]),1)}}}}Config.Containers.favorites=d.container}m.CheckRouteFavorites=function(){if(Routing.route=="favorites"){m.BaseLoad.Login(false,false,false,function(n){if(!n.err){m.BaseLoad.Tmpl(d.tmpl,function(){e();j()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});m.WidgetLoader(true)}})}else{m.WidgetLoader(true)}};function k(){m.AddEvent("w.change.route",function(){m.CheckRouteFavorites()});m.AddEvent("Favorites.empty",function(){h();i()});m.AddEvent("Favorites.clear.one",function(n){var o="?idGoods="+n.goods.id;m.BaseLoad.ClearFavorite(o,function(p){if(p.result=="ok"){m.ShowMessage(d.message.clearGoods,function(){n.block.goods.remove(n.goods);if(n.block.goods().length==0){n.content.content.remove(n.block);if(n.content.content().length==0){m.DispatchEvent("Favorites.empty")}}},false)}else{if(!p.err){p.err=d.message.failClearGoods}m.QueryError(p,function(){m.DispatchEvent("Favorites.clear.one",n)})}})});m.AddEvent("Favorites.clear.all",function(n){var o="?idGoods="+n.ids;m.BaseLoad.ClearFavorite(o,function(p){if(p.result=="ok"){m.ShowMessage(d.message.clearGoods,function(){for(var q in n.goods){n.block.goods.remove(n.goods[q])}if(n.block.goods().length==0){n.content.content.remove(n.block)}if(n.content.content().length==0){m.DispatchEvent("Favorites.empty")}},false)}else{if(!p.err){p.err=d.message.failClearGoods}m.QueryError(p,function(){m.DispatchEvent("Favorites.clear.all",n)})}})})}function j(){m.WidgetLoader(false);m.BaseLoad.InfoFavorite("yes",function(n){if(!n.err){c();l.Content(n)}else{h();i()}})}function e(){m.BaseLoad.Script(PokupoWidgets.model.menu,function(){m.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function a(){m.ClearContainer(d)}function c(){m.InsertContainer(d,"content")}function h(){m.InsertContainer(d,"empty")}var l={Content:function(q){var p=new FavoritesViewModel();for(var n in q){BlockFavoritesForSellerViewModel.prototype=new Widget();m.favorites=new BlockFavoritesForSellerViewModel(p,d);for(var o in q[n]){if(typeof l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()]=="function"){l[o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()](q[n][o])}}p.AddContent(m.favorites)}g(p)},Goods:function(n){m.favorites.AddContent(n)},Seller:function(n){m.favorites.sellerInfo.seller=n},Shop:function(n){m.favorites.sellerInfo.shop=n},Operator:function(n){m.favorites.sellerInfo.operator=n},Final_cost:function(n){m.favorites.finalCost=n}};function g(n){m.RenderTemplate(n,d,null,function(o){c();g(o)},function(){a()})}function i(){m.WidgetLoader(true,d.container.widget);if(d.animate){d.animate()}}};var FavoritesViewModel=function(){var a=this;a.content=ko.observableArray();a.AddContent=function(b){a.content.push(b)}};var BlockFavoritesForSellerViewModel=function(d,c){var a=this;a.sellerInfo={};a.showSellerInfo=ko.computed(function(){if($.inArray("infoShop",c.showBlocks)>=0){return true}return false},this);a.goods=ko.observableArray();a.uniq=EventDispatcher.GetUUID();a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods)[0].checked=e;f.isSelected(e)})});a.ClickSelectAll=function(){var f=$("#"+a.cssSelectAll);var e=f.is(":checked");var g;if(e){f[0].checked=false;g=false}else{f[0].checked=true;g=true}ko.utils.arrayForEach(a.goods(),function(h){$("#"+h.cssCheckboxGoods)[0].checked=g;h.isSelected(g)})};a.AddContent=function(f){for(var e=0;e<=f.length-1;e++){BlockFavoritesGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockFavoritesGoodsSellersViewModel(f[e],a,d,c))}a.finalCost=f.final_cost};a.ClickButchRemove=function(){a.Confirm(c.message.confirmButchRemove,function(){var e=[];var f=[];var h=a.goods().length-1;for(var g=0;g<=h;g++){if(a.goods()[g].isSelected()){e.push(a.goods()[g].id);f.push(a.goods()[g])}}b("Favorites.clear.all",{ids:e,goods:f,content:d,block:a})})};a.ClickClearFavorites=function(){a.Confirm(c.message.confirmClearFavorites,function(){var j=a.goods().length-1;var f=[];var e=[];for(var g=0;g<=j;g++){f.push(a.goods()[g]);e.push(a.goods()[g].id)}var h=e.join(",");b("Favorites.clear.all",{ids:h,goods:f,content:d,block:a})})};a.DisabledButton=ko.computed(function(){var e=a.goods().length;var g=[];for(var f=0;f<=e-1;f++){if(a.goods()[f].isSelected()){g.push(a.goods()[f].id)}}if(g.length>0){return true}return false},this);function b(e,f){EventDispatcher.DispatchEvent(e,f)}};var BlockFavoritesGoodsSellersViewModel=function(e,f,d,c){var a=this;a.sellerId=f.sellerInfo.seller.id;a.uniq=EventDispatcher.HashCode(new Date().getTime().toString()+"-"+a.id);a.cssToCart="goodsToCart_"+a.uniq;a.cssTitleToCart="goodsTilteToCart_"+a.uniq;a.id=e.id;a.fullName=e.full_name;a.sellCost=ko.observable(e.sell_cost);a.sellEndCost=ko.observable(e.sell_end_cost);a.routeImages=e.route_image;a.routeBigImages=e.route_big_image;a.isSelected=ko.observable(false);a.isSelected.subscribe(function(h){var g=f.goods().length;var k=[];for(var j=0;j<=g-1;j++){if(f.goods()[j].isSelected()){k.push(f.goods()[j].id)}}if(k.length<g){$("#"+f.cssSelectAll)[0].checked=false}else{$("#"+f.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods="goods_"+a.id;a.ClickOrder=function(){var g=$("#"+a.cssCheckboxGoods);var h=g.is(":checked");if(h==false){g[0].checked=true;a.isSelected(true)}else{g[0].checked=false;a.isSelected(false)}};a.showAddToCart=ko.computed(function(){if($.inArray("addToCart",c.showBlocks)>=0){return true}return false},this);a.AddToCart=function(){b("w.cart.add",{goodsId:a.id,hash:a.uniq})};a.showBuy=ko.computed(function(){if($.inArray("buy",c.showBlocks)>=0){return true}return false},this);a.Buy=function(){Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:a.sellerId,goodsId:a.id,count:1})};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){a.Confirm(c.message.confirmRemove,function(){b("Favorites.clear.one",{goods:a,block:f,content:d})})};function b(g,h){EventDispatcher.DispatchEvent(g,h)}};var TestFavorites={Init:function(){if(typeof Widget=="function"){FavoritesWidget.prototype=new Widget();var a=new FavoritesWidget();a.Init(a)}else{setTimeout(function(){TestFavorites.Init()},100)}}};TestFavorites.Init();