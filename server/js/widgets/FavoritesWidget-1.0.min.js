var FavoritesWidget=function(){function e(){n(),o(),t()}function o(){var e=u.GetInputParameters("favorites");if(!$.isEmptyObject(e)&&(f=u.UpdateSettings1(f,e),e.show))for(var o=0;o<=f.showBlocks.length-1;o++)$.inArray(f.showBlocks[o],e.show)<0&&f.showBlocks.splice(f.showBlocks.indexOf(f.showBlocks[o]),1);Config.Favorites=f}function t(){"favorites"==Routing.route?u.BaseLoad.Login(!1,!1,!1,function(e){e.err?(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("login","Авторизация пользователя",{}),u.WidgetLoader(!0)):u.BaseLoad.Tmpl(f.tmpl,function(){s(),i()})}):u.WidgetLoader(!0)}function n(){u.AddEvent("w.change.route",function(){t()}),u.AddEvent("Favorites.empty",function(){c(),d()}),u.AddEvent("Favorites.clear.one",function(e){var o="?idGoods="+e.goods.id;u.BaseLoad.ClearFavorite(o,function(o){"ok"==o.result?u.ShowMessage(f.message.clearGoods,function(){e.block.goods.remove(e.goods),0==e.block.goods().length&&(e.content.content.remove(e.block),0==e.content.content().length&&u.DispatchEvent("Favorites.empty"))},!1):(o.err||(o.err=f.message.failClearGoods),u.QueryError(o,function(){u.DispatchEvent("Favorites.clear.one",e)}))})}),u.AddEvent("Favorites.clear.all",function(e){var o="?idGoods="+e.ids;u.BaseLoad.ClearFavorite(o,function(o){"ok"==o.result?u.ShowMessage(f.message.clearGoods,function(){for(var o in e.goods)e.block.goods.remove(e.goods[o]);0==e.block.goods().length&&e.content.content.remove(e.block),0==e.content.content().length&&u.DispatchEvent("Favorites.empty")},!1):(o.err||(o.err=f.message.failClearGoods),u.QueryError(o,function(){u.DispatchEvent("Favorites.clear.all",e)}))})})}function i(){u.WidgetLoader(!1),u.BaseLoad.InfoFavorite("yes",function(e){e.err?(c(),d()):(a(),v.Content(e))})}function s(){u.BaseLoad.Script(PokupoWidgets.model.menu,function(){u.DispatchEvent("w.onload.menu",{menu:{},active:""})})}function r(){u.ClearContainer(f)}function a(){u.InsertContainer(f,"content")}function c(){u.InsertContainer(f,"empty")}function l(e){u.RenderTemplate(e,f,null,function(e){a(),l(e)},function(){r()})}function d(){u.WidgetLoader(!0,f.container.widget),f.animate&&f.animate()}var u=this;u.widgetName="FavoritesWidget",u.version=1,u.minWidgetVersion=1,u.maxWidgetVersion=2,u.minTmplVersion=1,u.maxTmplVersion=2,u.favorites=null,u.InitWidget=e;var f={container:{widget:"content",def:"defaultFavoritesWidgetId"},title:"Избранное",tmpl:{path:"favoritesTmpl.html",id:{content:"favoritesTmpl",empty:"emptyFavoritesTmpl"}},showBlocks:["infoShop","addToCart","buy"],message:{clearGoods:"Выбранные товары удалены из избранного.",failClearGoods:"Произошла ошибка при удалении товара из избранного. Попробуйте еще раз.",confirmButchRemove:"Вы уверены, что хотите удалить выбранный товар из избранного?",confirmRemove:"Вы уверены что хотите удалить товар из избранного?",confirmClearFavorites:"Вы уверены, что хотите очистить избранное от товаров?"},animate:"function"==typeof AnimateFavorite?AnimateFavorite:null},v={Content:function(e){var o=new FavoritesViewModel;for(var t in e){BlockFavoritesForSellerViewModel.prototype=new Widget,u.favorites=new BlockFavoritesForSellerViewModel(o,f);for(var n in e[t])"function"==typeof v[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()]&&v[n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()](e[t][n]);o.AddContent(u.favorites)}l(o)},Goods:function(e){u.favorites.AddContent(e)},Seller:function(e){u.favorites.sellerInfo.seller=e},Shop:function(e){u.favorites.sellerInfo.shop=e},Operator:function(e){u.favorites.sellerInfo.operator=e},Final_cost:function(e){u.favorites.finalCost=e}}},FavoritesViewModel=function(){var e=this;e.content=ko.observableArray(),e.AddContent=function(o){e.content.push(o)}},BlockFavoritesForSellerViewModel=function(e,o){function t(e,o){EventDispatcher.DispatchEvent(e,o)}var n=this;n.sellerInfo={},n.showSellerInfo=ko.computed(function(){return $.inArray("infoShop",o.showBlocks)>=0?!0:!1},this),n.goods=ko.observableArray(),n.uniq=EventDispatcher.GetUUID(),n.cssSelectAll="cartGoodsSelectAll_"+n.uniq,n.isSelectedAll=ko.observable(!1),n.isSelectedAll.subscribe(function(e){ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods)[0].checked=e,o.isSelected(e)})}),n.ClickSelectAll=function(){var e,o=$("#"+n.cssSelectAll),t=o.is(":checked");t?(o[0].checked=!1,e=!1):(o[0].checked=!0,e=!0),ko.utils.arrayForEach(n.goods(),function(o){$("#"+o.cssCheckboxGoods)[0].checked=e,o.isSelected(e)})},n.AddContent=function(t){for(var i=0;i<=t.length-1;i++)BlockFavoritesGoodsSellersViewModel.prototype=new Widget,n.goods.push(new BlockFavoritesGoodsSellersViewModel(t[i],n,e,o));n.finalCost=t.final_cost},n.ClickButchRemove=function(){n.Confirm(o.message.confirmButchRemove,function(){for(var o=[],i=[],s=n.goods().length-1,r=0;s>=r;r++)n.goods()[r].isSelected()&&(o.push(n.goods()[r].id),i.push(n.goods()[r]));t("Favorites.clear.all",{ids:o,goods:i,content:e,block:n})})},n.ClickClearFavorites=function(){n.Confirm(o.message.confirmClearFavorites,function(){for(var o=n.goods().length-1,i=[],s=[],r=0;o>=r;r++)i.push(n.goods()[r]),s.push(n.goods()[r].id);var a=s.join(",");t("Favorites.clear.all",{ids:a,goods:i,content:e,block:n})})},n.DisabledButton=ko.computed(function(){for(var e=n.goods().length,o=[],t=0;e-1>=t;t++)n.goods()[t].isSelected()&&o.push(n.goods()[t].id);return o.length>0?!0:!1},this)},BlockFavoritesGoodsSellersViewModel=function(e,o,t,n){function i(e,o){EventDispatcher.DispatchEvent(e,o)}var s=this;s.sellerId=o.sellerInfo.seller.id,s.uniq=EventDispatcher.HashCode((new Date).getTime().toString()+"-"+s.id),s.cssToCart="goodsToCart_"+s.uniq,s.cssTitleToCart="goodsTilteToCart_"+s.uniq,s.id=e.id,s.fullName=e.full_name,s.sellCost=ko.observable(e.sell_cost),s.sellEndCost=ko.observable(e.sell_end_cost),s.routeImages=e.route_image,s.routeBigImages=e.route_big_image,s.isSelected=ko.observable(!1),s.isSelected.subscribe(function(){for(var e=o.goods().length,t=[],n=0;e-1>=n;n++)o.goods()[n].isSelected()&&t.push(o.goods()[n].id);$("#"+o.cssSelectAll)[0].checked=t.length<e?!1:!0}),s.cssCheckboxGoods="goods_"+s.id,s.ClickOrder=function(){var e=$("#"+s.cssCheckboxGoods),o=e.is(":checked");0==o?(e[0].checked=!0,s.isSelected(!0)):(e[0].checked=!1,s.isSelected(!1))},s.showAddToCart=ko.computed(function(){return $.inArray("addToCart",n.showBlocks)>=0?!0:!1},this),s.AddToCart=function(){i("w.cart.add",{goodsId:s.id,hash:s.uniq})},s.showBuy=ko.computed(function(){return $.inArray("buy",n.showBlocks)>=0?!0:!1},this),s.Buy=function(){Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:s.sellerId,goodsId:s.id,count:1})},s.ClickGoods=function(){Routing.SetHash("goods",s.fullName,{id:s.id})},s.ClickRemove=function(){s.Confirm(n.message.confirmRemove,function(){i("Favorites.clear.one",{goods:s,block:o,content:t})})}},TestFavorites={Init:function(){if("function"==typeof Widget){FavoritesWidget.prototype=new Widget;var e=new FavoritesWidget;e.Init(e)}else setTimeout(function(){TestFavorites.Init()},100)}};TestFavorites.Init();