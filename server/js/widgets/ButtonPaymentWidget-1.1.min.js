window.ButtonPaymentWidget=function(){function e(){t(),o(),n()}function t(){var e=y.GetInputParameters("buttonPayment");$.isEmptyObject(e)||(f=y.UpdateSettings1(f,e)),Config.ButtonPayment=f}function n(){"payment"==Routing.route?y.BaseLoad.Tmpl(f.tmpl,function(){u();var e=Routing.params;e.orderId&&a(e.orderId),e.goodsId&&r(e.goodsId),e.amount&&i(e.amount)}):y.WidgetLoader(!0)}function o(){y.AddEvent("BPayment.tmpl_"+f.uniq,function(){l(),c()}),y.AddEvent("w.change.route",function(){n()}),y.AddEvent("w.ready",function(){null!=f.containerButton&&(Loader.InsertContainer(f.containerButton),y.BaseLoad.Tmpl(f.tmpl,function(){y.DispatchEvent("BPayment.tmpl_"+f.uniq)}))}),y.AddEvent("BPayment.submit",function(e){u();var t=[];$.each(e.inData(),function(n){t.push("MOBILE_PHONE"==e.inData()[n].name()?e.inData()[n].name()+"="+encodeURIComponent(e.inData()[n].value().replace(/\s/g,"").replace(/-/g,"")):e.inData()[n].name()+"="+encodeURIComponent(e.inData()[n].value()))});var n=t.join("&"),o=Routing.params;o.orderId&&(n=o.orderId+"?"+n,a(n)),o.goodsId&&(n=o.goodsId+"?"+n,r(n)),o.amount&&(n=o.amount+"/"+Parameters.shopId+"?"+n,i(n))})}function a(e){y.BaseLoad.InvoicesOrder(e,function(t){y.QueryError(t,function(){a(e)},function(){Routing.SetHash("default","Домашняя",{})})&&m(t)})}function r(e){y.BaseLoad.InvoicesGoods(e,function(e){m(e)})}function i(e){y.BaseLoad.InvoicesAmount(e+"/"+Parameters.shopId,function(e){m(e)})}function s(){y.ClearContainer(f)}function l(){$(f.containerButton).html($("script#"+y.GetTmplName1(f,"skin")).html())}function u(){y.InsertContainer(f,"content")}function c(){var e=new ButtonPaymentViewModel(f);d(e)}function m(e){var t=new PaymentViewModel(f),n=[],o=e.pay_form.hidden_field;$.each(o,function(e){n.push(o[e].name+"="+encodeURIComponent(o[e].value))}),n&&$.cookie(Config.Base.cookie.orderId,n.join("&")),t.AddContent(e),p(t)}function d(e){var t=$(f.containerButton);try{ko.cleanNode(t.children()[0]),ko.applyBindings(e,t.children()[0]),f.animate&&f.animate()}catch(n){y.Exception("Ошибка шаблона ["+y.GetTmplName1(f,"skin")+"]",n),f.tmpl.custom?(delete f.tmpl.custom,y.BaseLoad.Tmpl(f.tmpl,function(){l(),d(e)})):(t.html(""),y.WidgetLoader(!0))}}function p(e){y.RenderTemplate(e,f,function(e){$.each(e.inData(),function(t){e.inData()[t].mask()&&$("#"+e.inData()[t].cssField()).mask(e.inData()[t].mask(),{placeholder:"_"})})},function(e){u(),p(e)},function(){s()},"content")}var y=this;y.widgetName="ButtonPaymentWidget",y.version=1.1,y.minWidgetVersion=1,y.maxWidgetVersion=2,y.minTmplVersion=1,y.maxTmplVersion=2,y.InitWidget=e;var f={container:{widget:"content",def:"defaultPaymentWidgetId"},containerButton:null,tmpl:{path:"buttonPaymentTmpl.html",id:{content:"paymentPageTmpl",skin:"buttonPaymentImpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов."},animate:"function"==typeof AnimateButtonPayment?AnimateButtonPayment:null,title:"Оплатить",skinFromMemory:!1,uniq:null,source:null,sourceVal:null};y.SetParameters=function(e){f.containerButton=e.element;var t=y.GetInputParameters("buttonPayment");$.isEmptyObject(t)||(t.tmpl&&t.tmpl.id&&t.tmpl.id.skin&&(f.skinFromMemory=!0),f=y.UpdateSettings1(f,t));var n=e.options.params;for(var o in n)switch(o){case"tmpl":if(n.tmpl&&(n.tmpl.path&&(f.tmpl.path=n.tmpl.path),n.tmpl.id))for(var o in n.tmpl.id)f.tmpl.id[o]=n.tmpl.id[o];break;case"title":f.title=n.title;break;case"uniq":f.uniq=n.uniq;break;case"orderId":f.source="order",f.sourceVal=n.orderId;break;case"goodsId":f.source="goods",f.sourceVal=n.goodsId;break;case"amount":f.source="amount",f.sourceVal=n.amount}Config.ButtonPayment=f}};var ButtonPaymentViewModel=function(e){function t(e){Routing.SetHash(o,a,e)}var n=this,o="payment",a="Оплата заказа";n.title=e.title,n.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],"order"==e.source&&t({orderId:e.sourceVal}),"goods"==e.source&&t({goodsId:e.sourceVal}),"amount"==e.source&&t({amount:e.sourceVal})}},PaymentViewModel=function(e){function t(){var e=!0;return $.each(n.inData(),function(t){return n.inData()[t].ValidateField()?void 0:(e=!1,!1)}),e}var n=this;n.title=e.title,n.instruction=ko.observable(),n.cssInstruction="instructtion_print_block",n.outData=ko.observableArray(),n.inData=ko.observableArray(),n.isInData=ko.observable(!1),n.cssInDataForm="in_data_block",n.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()},n.isPayForm=ko.observable(!1),n.urlInvoice=ko.observable(),n.cssInvoice="invoice_print_block",n.Print=function(e){var t=window.open();t.document.write($("#"+e).html()),t.print(),t.close()},n.ClickPrintInstruction=function(){n.Print(n.cssInstruction)},n.ClickPrintInvoice=function(){n.Print(n.cssInvoice)},n.Back=function(){var e=Parameters.cache.lastPage;"payment"!=e.route&&e.route?Routing.SetHash(e.route,e.title,e.data):Routing.SetHash("purchases","Заказ № "+Routing.params.orderId,{block:"detail",id:697})},n.ClickPay=function(){$("#"+n.payForm.cssPayForm).submit()},n.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,!0)},n.ClickSubmit=function(){t()&&EventDispatcher.DispatchEvent("BPayment.submit",n)},n.AddContent=function(e){n.instruction(null),e.hasOwnProperty("instruction")&&n.instruction(e.instruction),n.outData=ko.observableArray(),e.hasOwnProperty("out_data")&&$.each(e.out_data,function(t){n.outData.push(e.out_data[t])}),n.isPayForm(!1),n.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()},n.isPayForm(!1),e.hasOwnProperty("pay_form")&&(n.isPayForm(!0),n.payForm.action(e.pay_form.action),n.payForm.method(e.pay_form.method),e.pay_form.hasOwnProperty("new_window")&&"yes"==e.pay_form.new_window&&n.payForm.target("_blank"),$.each(e.pay_form.hidden_field,function(t){var o=e.pay_form.hidden_field[t];e.pay_form.hidden_field[t].hasOwnProperty("value")||(o.value=""),n.payForm.field.push(e.pay_form.hidden_field[t])})),n.isInData(!1),n.inData=ko.observableArray(),e.hasOwnProperty("in_data")&&(n.isInData(!0),$.each(e.in_data,function(t){var o=new PaymentFieldViewModel;o.AddContent(e.in_data[t]),n.inData.push(o)})),n.urlInvoice(null),e.hasOwnProperty("url_invoice")&&n.urlInvoice(e.url_invoice)}},PaymentFieldViewModel=function(){var e=this;e.label=ko.observable(),e.help=ko.observable(),e.error=ko.observable(),e.name=ko.observable(),e.value=ko.observable(),e.required=ko.observable(!1),e.typeField=ko.observable(),e.listSelect=ko.observableArray(),e.regExp=ko.observable(),e.mask=ko.observable(),e.maxlength=ko.observable(),e.cssField=ko.observable(),e.AddContent=function(t){t.hasOwnProperty("label")&&e.label(t.label),t.hasOwnProperty("help")&&e.help(t.help),t.hasOwnProperty("error")&&e.error(t.error),t.hasOwnProperty("name")&&(e.name(t.name),e.cssField("field_"+t.name)),t.hasOwnProperty("value")&&e.value(t.value),t.hasOwnProperty("required")&&"yes"==t.required&&e.required(!0),t.hasOwnProperty("type_field")&&e.typeField(t.type_field),t.hasOwnProperty("list_select")&&$.each(t.list_select,function(n){e.listSelect.push(t.list_select[n])}),t.hasOwnProperty("reg_exp")&&e.regExp(t.reg_exp),t.hasOwnProperty("mask")&&e.mask(t.mask),t.hasOwnProperty("maxlength")&&e.maxlength(t.maxlength)},e.ValidateField=function(){return e.required()&&!e.value()?(e.error(Config.ButtonPayment.Error.required),!1):e.maxlength()&&e.value().length>e.maxlength()?(e.error(Config.ButtonPayment.Error.maxlength.replace("%s%",e.maxlength())),!1):!0}},TestButtonPayment={Init:function(){if("function"==typeof Widget){window.ButtonPaymentWidget.prototype=new Widget;var e=new window.ButtonPaymentWidget;e.settings.uniq=EventDispatcher.GetUUID(),e.Init(e)}else setTimeout(function(){TestButtonPayment.Init()},100)}};TestButtonPayment.Init();