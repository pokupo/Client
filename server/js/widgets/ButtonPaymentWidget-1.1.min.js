window.ButtonPaymentWidget=function(){var n=this;n.widgetName="ButtonPaymentWidget";n.version=1.1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=f;var e={container:{widget:"content",def:"defaultPaymentWidgetId"},containerButton:null,tmpl:{path:"buttonPaymentTmpl.html",id:{content:"paymentPageTmpl",skin:"buttonPaymentImpl"}},Error:{required:"Поле обязательно для заполнения.",regExp:"Недопустимое значение.",maxlength:"Максимум %s% символов."},animate:typeof AnimateButtonPayment=="function"?AnimateButtonPayment:null,title:"Оплатить",skinFromMemory:false,uniq:null,source:null,sourceVal:null};function f(){b();l();h()}function b(){var q=n.GetInputParameters("buttonPayment");if(!$.isEmptyObject(q)){e=n.UpdateSettings1(e,q)}Config.Containers.buttonPayment=e.container}n.SetParameters=function(t){e.containerButton=t.element;var q=n.GetInputParameters("buttonPayment");if(!$.isEmptyObject(q)){if(q.tmpl&&q.tmpl.id&&q.tmpl.id.skin){e.skinFromMemory=true}e=n.UpdateSettings1(e,q)}var r=t.options.params;for(var s in r){switch(s){case"tmpl":if(r.tmpl){if(r.tmpl.path){e.tmpl.path=r.tmpl.path}if(r.tmpl.id){for(var s in r.tmpl.id){e.tmpl.id[s]=r.tmpl.id[s]}}}break;case"title":e.title=r.title;break;case"uniq":e.uniq=r.uniq;break;case"orderId":e.source="order";e.sourceVal=r.orderId;break;case"goodsId":e.source="goods";e.sourceVal=r.goodsId;break;case"amount":e.source="amount";e.sourceVal=r.amount;break}}Config.ButtonPayment=e};function h(){if(Routing.route=="payment"){n.BaseLoad.Tmpl(e.tmpl,function(){c();var q=Routing.params;if(q.orderId){i(q.orderId)}if(q.goodsId){m(q.goodsId)}if(q.amount){j(q.amount)}})}else{n.WidgetLoader(true)}}function l(){n.AddEvent("BPayment.tmpl_"+e.uniq,function(q){k();p()});n.AddEvent("w.change.route",function(){h()});n.AddEvent("w.ready",function(){if(e.containerButton!=null){Loader.InsertContainer(e.containerButton);n.BaseLoad.Tmpl(e.tmpl,function(){n.DispatchEvent("BPayment.tmpl_"+e.uniq)})}});n.AddEvent("BPayment.submit",function(r){c();var q=[];$.each(r.inData(),function(u){if(r.inData()[u].name()=="MOBILE_PHONE"){q.push(r.inData()[u].name()+"="+encodeURIComponent(r.inData()[u].value().replace(/\s/g,"").replace(/-/g,"")))}else{q.push(r.inData()[u].name()+"="+encodeURIComponent(r.inData()[u].value()))}});var t=q.join("&");var s=Routing.params;if(s.orderId){t=s.orderId+"?"+t;i(t)}if(s.goodsId){t=s.goodsId+"?"+t;m(t)}if(s.amount){t=s.amount+"/"+Parameters.shopId+"?"+t;j(t)}})}function i(q){n.BaseLoad.InvoicesOrder(q,function(r){if(n.QueryError(r,function(){i(q)},function(){Routing.SetHash("default","Домашняя",{})})){d(r)}})}function m(q){n.BaseLoad.InvoicesGoods(q,function(r){d(r)})}function j(q){n.BaseLoad.InvoicesAmount(q+"/"+Parameters.shopId,function(r){d(r)})}function a(){n.ClearContainer(e)}function k(){$(e.containerButton).html($("script#"+n.GetTmplName1(e,"skin")).html())}function c(){n.InsertContainer(e,"content")}function p(){var q=new ButtonPaymentViewModel(e);o(q)}function d(s){var r=new PaymentViewModel(e);var t=[];var q=s.pay_form.hidden_field;$.each(q,function(u){t.push(q[u].name+"="+encodeURIComponent(q[u].value))});if(t){$.cookie(Config.Base.cookie.orderId,t.join("&"))}r.AddContent(s);g(r)}function o(r){var q=$(e.containerButton);try{ko.cleanNode(q.children()[0]);ko.applyBindings(r,q.children()[0]);if(e.animate){e.animate()}}catch(s){n.Exception("Ошибка шаблона ["+n.GetTmplName1(e,"skin")+"]",s);if(e.tmpl.custom){delete e.tmpl.custom;n.BaseLoad.Tmpl(e.tmpl,function(){k();o(r)})}else{q.html("");n.WidgetLoader(true)}}}function g(q){n.RenderTemplate(q,e,function(r){$.each(r.inData(),function(s){if(r.inData()[s].mask()){$("#"+r.inData()[s].cssField()).mask(r.inData()[s].mask(),{placeholder:"_"})}})},function(r){c();g(r)},function(){a()},"content")}};var ButtonPaymentViewModel=function(d){var b=this,c="payment",e="Оплата заказа";b.title=d.title;b.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];if(d.source=="order"){a({orderId:d.sourceVal})}if(d.source=="goods"){a({goodsId:d.sourceVal})}if(d.source=="amount"){a({amount:d.sourceVal})}};function a(f){Routing.SetHash(c,e,f)}};var PaymentViewModel=function(c){var b=this;b.title=c.title;b.instruction=ko.observable();b.cssInstruction="instructtion_print_block";b.outData=ko.observableArray();b.inData=ko.observableArray();b.isInData=ko.observable(false);b.cssInDataForm="in_data_block";b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm=ko.observable(false);b.urlInvoice=ko.observable();b.cssInvoice="invoice_print_block";b.Print=function(e){var d=window.open();d.document.write($("#"+e).html());d.print();d.close()};b.ClickPrintInstruction=function(){b.Print(b.cssInstruction)};b.ClickPrintInvoice=function(){b.Print(b.cssInvoice)};b.Back=function(){var d=Parameters.cache.lastPage;if(d.route=="payment"||!d.route){Routing.SetHash("purchases","Заказ № "+Routing.params.orderId,{block:"detail",id:697})}else{Routing.SetHash(d.route,d.title,d.data)}};b.ClickPay=function(){$("#"+b.payForm.cssPayForm).submit()};b.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};b.ClickSubmit=function(){if(a()){EventDispatcher.DispatchEvent("BPayment.submit",b)}};function a(){var d=true;$.each(b.inData(),function(e){if(!b.inData()[e].ValidateField()){d=false;return false}});return d}b.AddContent=function(d){b.instruction(null);if(d.hasOwnProperty("instruction")){b.instruction(d.instruction)}b.outData=ko.observableArray();if(d.hasOwnProperty("out_data")){$.each(d.out_data,function(e){b.outData.push(d.out_data[e])})}b.isPayForm(false);b.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};b.isPayForm(false);if(d.hasOwnProperty("pay_form")){b.isPayForm(true);b.payForm.action(d.pay_form.action);b.payForm.method(d.pay_form.method);if(d.pay_form.hasOwnProperty("new_window")&&d.pay_form.new_window=="yes"){b.payForm.target("_blank")}$.each(d.pay_form.hidden_field,function(e){var f=d.pay_form.hidden_field[e];if(!d.pay_form.hidden_field[e].hasOwnProperty("value")){f.value=""}b.payForm.field.push(d.pay_form.hidden_field[e])})}b.isInData(false);b.inData=ko.observableArray();if(d.hasOwnProperty("in_data")){b.isInData(true);$.each(d.in_data,function(e){var f=new PaymentFieldViewModel();f.AddContent(d.in_data[e]);b.inData.push(f)})}b.urlInvoice(null);if(d.hasOwnProperty("url_invoice")){b.urlInvoice(d.url_invoice)}}};var PaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var TestButtonPayment={Init:function(){if(typeof Widget=="function"){window.ButtonPaymentWidget.prototype=new Widget();var a=new window.ButtonPaymentWidget();a.settings.uniq=EventDispatcher.GetUUID();a.Init(a)}else{setTimeout(function(){TestButtonPayment.Init()},100)}}};TestButtonPayment.Init();