var ProfileWidget=function(){var e=this;e.widgetName="ProfileWidget",e.version=1,e.minWidgetVersion=1,e.maxWidgetVersion=2,e.minTmplVersion=1,e.maxTmplVersion=2,e.settings={containerFormId:null,tmpl:{path:null,id:{personal:null,delivery:null,deliveryForm:null,security:null}},animate:null,inputParameters:{},geoShop:0,style:null,customContainer:null},e.InitWidget=function(){e.settings.containerFormId=Config.Containers.profile.widget,e.settings.customContainer=Config.Containers.profile.customClass,e.settings.tmpl=Config.Profile.tmpl,e.settings.style=Config.Profile.style,e.SetInputParameters(),e.RegisterEvents(),e.CheckRouteProfile(),e.SetPosition()},e.SetInputParameters=function(){var o={};if("string"==Config.Base.sourceParameters){var r=JSCore.ParserInputParameters(/ProfileWidget/);r.profile&&(o=r.profile)}if("object"==Config.Base.sourceParameters&&"undefined"!=typeof WParameters&&WParameters.profile&&(o=WParameters.profile),!$.isEmptyObject(o)){if(o.geoShop&&(e.settings.geoShop=o.geoShop),o.tmpl&&(o.tmpl.path&&(e.settings.tmpl.path=o.tmpl.path),o.tmpl.id))for(var t in o.tmpl.id)e.settings.tmpl.id[t]=o.tmpl.id[t];o.animate&&(e.settings.animate=o.animate)}e.settings.inputParameters=o},e.CheckRouteProfile=function(){"profile"==Routing.route?(e.WidgetLoader(!1),e.BaseLoad.Login(!1,!1,!1,function(o){o.err?(Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1],Routing.SetHash("login","Авторизация пользователя",{}),e.WidgetLoader(!0)):(Loader.Indicator("MenuPersonalCabinetWidget",!1),e.BaseLoad.Tmpl(e.settings.tmpl,function(){Routing.params.info&&Routing.params.info!=Config.Profile.menu.personalInformation.prefix||e.Info.Personal(),Routing.params.info!=Config.Profile.menu.deliveryAddress.prefix||Routing.params.form||e.Info.Delivery(),Routing.params.info==Config.Profile.menu.deliveryAddress.prefix&&"add"==Routing.params.form&&e.Info.DeliveryForm(),Routing.params.info==Config.Profile.menu.security.prefix&&e.Info.Security(),e.Info.Menu()}))})):e.WidgetLoader(!0)},e.RegisterEvents=function(){EventDispatcher.AddEventListener("w.change.route",function(){e.CheckRouteProfile()}),EventDispatcher.AddEventListener("ProfileWidget.personal.checking",function(o){var r=o.birthDayField().split("."),t=r[2]+"-"+r[1]+"-"+r[0];o.birthDayHiddenField(t),e.BaseLoad.EditProfile($("form#"+o.cssRegistrationDataForm),function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.editProfile,function(){Parameters.cache.profile.personal={},Parameters.cache.userInformation=null,Parameters.cache.profile.info={},window.location.reload(!0)},!1):(r.err||(r.err=Config.Profile.message.failEditProfile),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.personal.checking",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.postalAddress.checking",function(o){var r="?id_country="+encodeURIComponent($.trim(o.country().id));r=o.region()&&o.region().regioncode?r+"&code_region="+encodeURIComponent($.trim(o.region().regioncode)):r+"&name_region="+encodeURIComponent($.trim(o.customRegion())),r=o.city()&&o.city().aoguid?r+"&code_city="+encodeURIComponent($.trim(o.city().aoguid)):r+"&name_city="+encodeURIComponent($.trim(o.customCity())),r=r+"&address="+encodeURIComponent($.trim(o.customAddress()))+"&post_code="+encodeURIComponent($.trim(o.postIndex())),e.BaseLoad.EditAddress(r,function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.editProfile,function(){Parameters.cache.profile.personal={},o.countryText(o.country().name),o.regionText(o.customRegion()),o.cityText(o.customCity()),o.addressText(o.customAddress()),o.postIndexText(o.postIndex()),o.isEditBlock(0)},!1):(r.err||(r.err=Config.Profile.message.failEditProfile),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.postalAddress.checking",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.send.token",function(o){e.BaseLoad.SendToken(o,function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.sendToken,!1,!1):(r.err||(r.err=Config.Profile.message.failSendToken),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.send.token",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.submit.token",function(o){var r=Parameters.cache.userInformation,t=[];t.push("username="+encodeURIComponent(r.login)),"mail"==o.type&&t.push("mail_token="+o.value.emailToken()),"sms"==o.type&&t.push("sms_token="+o.value.phoneToken());var n="?"+t.join("&");e.BaseLoad.ActivateUser(n,function(r){Parameters.cache.profile.info={};e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.submit.token",o)})&&(e.Validate.MailToken(r,o.value)&&o.value.emailIsConfirm(!0),e.Validate.PhoneToken(r,o.value)&&o.value.phoneIsConfirm(!0))})}),EventDispatcher.AddEventListener("ProfileWidget.contacts.checking",function(o){var r="?";o.email()&&!o.emailIsConfirm()&&(r=r+"email="+encodeURIComponent(o.email())),o.phone()&&(r=r+"&phone="+encodeURIComponent(o.phone())),e.BaseLoad.EditContacts(r,function(r){"ok"==r.result?(o.sentCode(!0),setTimeout(function(){o.isExistPhone(!0)},6e4),o.sentEmailCode(!0),setTimeout(function(){o.isExistMail(!0)},6e4),e.ShowMessage(Config.Profile.message.contactsEdit,!1,!1)):(r.err||(r.err=Config.Profile.message.failContactsEdit),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.contacts.checking",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.password.change",function(o){e.BaseLoad.ChangePassword($("form#"+o.cssSequrityForm),function(r){"ok"==r.result?(o.oldPassword(null),o.newPassword(null),o.confirmPassword(null),e.ShowMessage(Config.Profile.message.changePassword,!1,!1)):(r.err||(r.err=Config.Profile.message.failChangePassord),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.password.change",o)},function(){o.oldPassword(null),o.newPassword(null),o.confirmPassword(null)}))})}),EventDispatcher.AddEventListener("ProfileWidget.delivery.add",function(o){var r="?id_country="+encodeURIComponent($.trim(o.country().id));r=o.region()&&o.region().regioncode?r+"&code_region="+encodeURIComponent($.trim(o.region().regioncode)):r+"&name_region="+encodeURIComponent($.trim(o.customRegion())),r=o.city()&&o.city().aoguid?r+"&code_city="+encodeURIComponent($.trim(o.city().aoguid)):r+"&name_city="+encodeURIComponent($.trim(o.customCity())),r=r+"&address="+encodeURIComponent($.trim(o.customAddress()))+"&post_code="+encodeURIComponent($.trim(o.postIndex()))+"&addressee="+encodeURIComponent($.trim(o.addressee()))+"&contact_phone="+encodeURIComponent($.trim(o.contactPhone()))+"&is_default="+encodeURIComponent(o.isDefault()?"yes":"no"),e.BaseLoad.AddDelivaryAddress(r,function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.addAddressDelivery,function(){Parameters.cache.delivery=null,Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},!1):(r.err||(r.err=Config.Profile.message.failAddAddressDelivery),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.delivery.saveEdit",function(o){var r="?id_address="+o.id()+"&id_country="+encodeURIComponent($.trim(o.country().id));r=o.region()&&o.region().regioncode?r+"&code_region="+encodeURIComponent($.trim(o.region().regioncode)):r+"&name_region="+encodeURIComponent($.trim(o.customRegion())),r=o.city()&&o.city().aoguid?r+"&code_city="+encodeURIComponent($.trim(o.city().aoguid)):r+"&name_city="+encodeURIComponent($.trim(o.customCity())),r=r+"&address="+encodeURIComponent($.trim(o.customAddress()))+"&post_code="+encodeURIComponent($.trim(o.postIndex()))+"&addressee="+encodeURIComponent($.trim(o.addressee()))+"&contact_phone="+encodeURIComponent($.trim(o.contactPhone()))+"&is_default="+encodeURIComponent(o.isDefault()?"yes":"no"),e.BaseLoad.EditDelivaryAddress(r,function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.addAddressDelivery,function(){Parameters.cache.delivery=null,Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},!1):(r.err||(r.err=Config.Profile.message.failAddAddressDelivery),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.delivery.delete",function(o){e.BaseLoad.DeleteDeliveryAddress(o.address.id,function(r){"ok"==r.result?e.ShowMessage(Config.Profile.message.deleteAddressDelivery,function(){Parameters.cache.delivery=null,o.list.addressList.remove(o.address)},!1):(r.err||(r.err=Config.Profile.message.failDeleteAddressDelivery),e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.delete",o)}))})}),EventDispatcher.AddEventListener("ProfileWidget.delivery.edit",function(o){e.BaseLoad.Script(PokupoWidgets.model.content,function(){var r=new DeliveryAddressFormViewModel;r.AddContent(o),e.Fill.DeliveryForm(r)})}),EventDispatcher.AddEventListener("ProfileWidget.delivery.sedDefault",function(o){var r="?id_address="+o.id+"&is_default=yes";e.BaseLoad.SetDefaultDelivaryAddress(r,function(r){"ok"==r.result||e.QueryError(r,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.sedDefault",o)})})})},e.Validate={Username:function(e,o){var r=!1;return e.check_username&&(("on"==e.check_username||"ban"==e.check_username||"off"==e.check_username)&&o.errorUsername(Config.Registration.error.username.uniq),"yes"==e.check_username&&(r=!0)),r},Phone:function(e,o){var r=!1;return e.check_phone?(("on"==e.check_phone||"ban"==e.check_phone||"off"==e.check_phone)&&o.errorPhone(Config.Registration.error.phone.uniq),"yes"==e.check_phone&&(r=!0)):r=!0,r},Email:function(e,o){var r=!1;return e.check_email&&(("on"==e.check_email||"ban"==e.check_email||"off"==e.check_email)&&o.errorEmail(Config.Registration.error.email.uniq),"yes"==e.check_email&&(r=!0)),r},MailToken:function(e,o){return e.confirm_email?"no"==e.confirm_email?(o.errorEmailConfirm(Config.Profile.error.emailToken.confirm),!1):!0:!1},PhoneToken:function(e,o){return e.confirm_phone?"no"==e.confirm_phone?(o.errorPhoneConfirm(Config.Profile.error.phoneToken.confirm),!1):!0:!1},Profile:function(e,o){return e.err?(o.errorAddress(e.err),!1):!0},Address:function(e,o){return e.err?(o.errorAddress(e.err),!1):!0}},e.Info={Menu:function(){e.BaseLoad.Script(PokupoWidgets.model.menu,function(){Routing.params.info||(Routing.params.info=Config.Profile.menu.personalInformation.prefix),EventDispatcher.DispatchEvent("w.onload.menu",{menu:Config.Profile.menu,active:Routing.params.info})})},Personal:function(){e.InsertContainer.Personal(),e.BaseLoad.Script(PokupoWidgets.model.content,function(){e.BaseLoad.Profile(function(o){e.BaseLoad.ProfileInfo(function(r){e.Fill.Personal(o,r)})})})},Delivery:function(){e.BaseLoad.DeliveryAddressList(function(o){e.InsertContainer.Delivery(),e.Fill.Delivery(o)})},DeliveryForm:function(){e.BaseLoad.Script(PokupoWidgets.model.content,function(){var o=new DeliveryAddressFormViewModel;e.Fill.DeliveryForm(o)})},Security:function(){e.InsertContainer.Security(),e.Fill.Security()}},e.InsertContainer={EmptyWidget:function(){$("#"+e.settings.containerFormId).empty().html("")},Personal:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("personal")).html()).children().hide()},Delivery:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("delivery")).html()).children().hide()},DeliveryForm:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("deliveryForm")).html()).children().hide()},Security:function(){e.InsertContainer.EmptyWidget(),$("#"+e.settings.containerFormId).append($("script#"+e.GetTmplName("security")).html()).children().hide()}},e.Fill={Personal:function(o,r){var t=new ProfilePersonalInformationViewModel,n=Parameters.shopId;0==e.settings.geoShop&&(n=0),e.BaseLoad.Country(n,function(n){t.AddContent(o,r,n),e.Render.Personal(t)})},Delivery:function(o){var r=new ProfileDeliveryAddressViewModel;r.AddContent(o),e.Render.DeliveryList(r)},DeliveryForm:function(o){var r=Parameters.shopId;0==e.settings.geoShop&&(r=0),e.BaseLoad.Country(r,function(r){o.AddCountryList(r),e.InsertContainer.DeliveryForm(),e.Render.DeliveryForm(o)})},Security:function(){var o=new ProfileSecurityViewModel;e.Render.Security(o)}},e.Render={Personal:function(o){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(o,$("#"+e.settings.containerFormId)[0]),$("#"+o.postalAddress.cssCountryList).change(function(){var e=$("#"+o.postalAddress.cssCountryList+" option:selected").val();$.grep(o.postalAddress.countryList(),function(r){r.id==e&&(o.postalAddress.country(r),o.postalAddress.customRegion(null),o.postalAddress.region(null),o.postalAddress.customCity(null),o.postalAddress.city(null),o.postalAddress.customAddress(null),o.postalAddress.address(null),o.postalAddress.postIndex(null))})}),$("#"+o.postalAddress.cssRegionList).autocomplete({source:function(r,t){e.BaseLoad.Region(o.postalAddress.country().id+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.postalAddress.cssRegionList).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.formalname+" "+e.shortname),region:e}}))})},select:function(e,r){o.postalAddress.region(r.item.region),o.postalAddress.customRegion(r.item.value),o.postalAddress.postIndex(r.item.region&&0!=r.item.region.postalcode?r.item.region.postalcode:null)}}),$("#"+o.postalAddress.cssCityList).autocomplete({source:function(r,t){o.postalAddress.region()&&e.BaseLoad.City(o.postalAddress.country().id+"/"+encodeURIComponent(o.postalAddress.region().regioncode)+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.postalAddress.cssCityList).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),city:e}}))})},select:function(e,r){o.postalAddress.city(r.item.city),o.postalAddress.customCity(r.item.value),o.postalAddress.postIndex(r.item.city&&0!=r.item.city.postalcode?r.item.city.postalcode:null)}}),$("#"+o.postalAddress.cssAddress).autocomplete({source:function(r,t){o.postalAddress.region()&&e.BaseLoad.Street(o.postalAddress.country().id+"/"+encodeURIComponent(o.postalAddress.region().regioncode)+"/"+encodeURIComponent(o.postalAddress.city().aoguid)+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.postalAddress.cssAddress).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),street:e}}))})},select:function(e,r){o.postalAddress.address(r.item.street),o.postalAddress.customAddress(r.item.value),o.postalAddress.postIndex(r.item.street&&0!=r.item.street.postalcode?r.item.street.postalcode:null)}}),$("#"+o.postalAddress.cssRegionList).bind("textchange",function(){o.postalAddress.customRegion($(this).val()),o.postalAddress.customCity(null),o.postalAddress.city(null),o.postalAddress.customAddress(null),o.postalAddress.address(null),o.postalAddress.postIndex(null)}),$("#"+o.postalAddress.cssCityList).bind("textchange",function(){o.postalAddress.customCity($(this).val()),o.postalAddress.customAddress(null),o.postalAddress.address(null),o.postalAddress.postIndex(null)}),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateProfile&&new AnimateProfile(o.postalAddress.country),e.settings.animate&&e.settings.animate(o.postalAddress.country),"postal_address"==Routing.params.edit&&e.ScrollTop(o.postalAddress.cssPostAddressForm,700)}catch(r){e.Exception("Ошибка шаблона ["+e.GetTmplName("personal")+"]",r),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Personal(),e.Render.Personal(o)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},DeliveryList:function(o){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(o,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateProfile&&new AnimateProfile,e.settings.animate&&e.settings.animate()}catch(r){e.Exception("Ошибка шаблона ["+e.GetTmplName("delivery")+"]",r),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Delivery(),e.Render.DeliveryList(o)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},DeliveryForm:function(o){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(o,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),$("#"+o.cssRegionList).autocomplete({source:function(r,t){e.BaseLoad.Region(o.country().id+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.cssRegionList).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.formalname+" "+e.shortname),region:e}}))})},select:function(e,r){o.region(r.item.region),o.customRegion(r.item.value),o.postIndex(r.item.region&&0!=r.item.region.postalcode?r.item.region.postalcode:null)}}),$("#"+o.cssCityList).autocomplete({source:function(r,t){o.region()&&e.BaseLoad.City(o.country().id+"/"+encodeURIComponent(o.region().regioncode)+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.cssCityList).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),city:e}}))})},select:function(e,r){o.city(r.item.city),o.customCity(r.item.value),o.postIndex(r.item.city&&0!=r.item.city.postalcode?r.item.city.postalcode:null)}}),$("#"+o.cssAddress).autocomplete({source:function(r,t){o.region()&&e.BaseLoad.Street(o.country().id+"/"+encodeURIComponent(o.region().regioncode)+"/"+encodeURIComponent(o.city().aoguid)+"/"+encodeURIComponent(r.term),function(e){return e.err?($("#"+o.cssAddress).autocomplete("close"),!1):void t($.map(e,function(e){return{value:$.trim(e.shortname+". "+e.formalname),street:e}}))})},select:function(e,r){o.address(r.item.street),o.customAddress(r.item.value),o.postIndex(r.item.street&&0!=r.item.street.postalcode?r.item.street.postalcode:null)}}),$("#"+o.cssCountryList).change(function(){var e=$("#"+o.cssCountryList+" option:selected").val();$.grep(o.countryList(),function(r){r.id==e&&(o.country(r),o.customRegion(null),o.region(null),o.customCity(null),o.city(null),o.customAddress(null),o.address(null),o.postIndex(null))})}),$("#"+o.cssRegionList).bind("textchange",function(){o.customRegion($(this).val()),o.customCity(null),o.city(null),o.customAddress(null),o.address(null),o.postIndex(null)}),$("#"+o.cssCityList).bind("textchange",function(){o.customCity($(this).val()),o.customAddress(null),o.address(null),o.postIndex(null)}),"function"==typeof AnimateProfile&&new AnimateProfile(o.country),e.settings.animate&&e.settings.animate(o.country)}catch(r){e.Exception("Ошибка шаблона ["+e.GetTmplName("deliveryForm")+"]",r),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.DeliveryForm(),e.Render.DeliveryForm(o)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)},Security:function(o){if($("#"+e.settings.containerFormId).length>0)try{ko.cleanNode($("#"+e.settings.containerFormId)[0]),ko.applyBindings(o,$("#"+e.settings.containerFormId)[0]),e.WidgetLoader(!0,e.settings.containerFormId),"function"==typeof AnimateProfile&&new AnimateProfile,e.settings.animate&&e.settings.animate()}catch(r){e.Exception("Ошибка шаблона ["+e.GetTmplName("security")+"]",r),e.settings.tmpl.custom?(delete e.settings.tmpl.custom,e.BaseLoad.Tmpl(e.settings.tmpl,function(){e.InsertContainer.Security(),e.Render.Security(o)})):(e.InsertContainer.EmptyWidget(),e.WidgetLoader(!0,e.settings.containerFormId))}else e.Exception("Ошибка. Не найден контейнер ["+e.settings.containerFormId+"]"),e.WidgetLoader(!0,e.settings.containerFormId)}},e.SetPosition=function(){if("absolute"==e.settings.inputParameters.position){for(var o in e.settings.inputParameters)e.settings.style[o]&&(e.settings.style[o]=e.settings.inputParameters[o]);$().ready(function(){$("#"+e.settings.containerFormId).length>0&&$("#"+e.settings.containerFormId).css(e.settings.style)})}}},ProfilePersonalInformationViewModel=function(){var e=this;e.registrationData=null,e.postalAddress=null,e.contacts=null,e.AddContent=function(o,r,t){var n=new ProfileDataRegistrationViewModel;o.err||n.AddContent(o),n.dateRegistration(r.date_reg),e.registrationData=n;var i=new ProfilePostalAddressViewModel;i.AddCountryList(t),o.err||i.AddContent(o),e.postalAddress=i,e.contacts=new ProfileContactsViewModel,e.contacts.AddContent()}},ProfileDataRegistrationViewModel=function(){var e=this;e.data=null,e.username=ko.observable(),e.dateRegistration=ko.observable(),e.gender=ko.observable(),e.genderText=ko.computed(function(){return"m"==e.gender()?"мужской":"женский"},this),e.errorGender=ko.observable(null),e.lastName=ko.observable(),e.firstName=ko.observable(),e.middleName=ko.observable(),e.fullName=ko.computed(function(){var o="";return e.lastName()&&(o+=e.lastName()),e.firstName()&&(o=o+" "+e.firstName()),e.middleName()&&(o=o+" "+e.middleName()),o},this),e.birthDay=ko.observable(),e.cssBirthDay="birthDay",e.rating=ko.observable(),e.checkInfo=ko.observable(),e.lastNameField=ko.observable(),e.firstNameField=ko.observable(),e.middleNameField=ko.observable(),e.birthDayField=ko.observable(),e.birthDayHiddenField=ko.observable(),e.errorLastName=ko.observable(null),e.errorFirstName=ko.observable(null),e.errorMiddleName=ko.observable(null),e.errorBirthDay=ko.observable(null),e.isEditBlock=ko.observable(0),e.iconUser=ko.observable(),e.cssIconUser="avatar_file",e.errorIconUser=ko.observable(null),e.cssRegistrationDataForm="profile_registration_data_form",e.ValidationForm=function(){var o=!0;return e.IconUserValidation()||(o=!1),e.FirstNameValidation()||(o=!1),e.LastNameValidation()||(o=!1),e.MiddleNameValidation()||(o=!1),e.BirthDayValidation()||(o=!1),o},e.IconUserValidation=function(){var o=$("#"+e.cssIconUser).val();if(o){var r=o.split("."),t=r[r.length-1];if(t=t.toLowerCase(),$.inArray(t,["jpeg","jpg","png","gif"])<0)return e.errorIconUser(Config.Profile.error.iconUser.extension),!1}return e.errorIconUser(null),!0},e.FirstNameValidation=function(){return e.firstNameField()?e.firstNameField().length<2?(e.errorFirstName(Config.Profile.error.firstName.minLength),!1):e.firstNameField().length>20?(e.errorFirstName(Config.Profile.error.firstName.maxLength),!1):Config.Profile.regular.firstName.test(e.firstNameField())?(e.errorFirstName(null),!0):(e.errorFirstName(Config.Profile.error.firstName.regular),!1):(e.errorFirstName(Config.Profile.error.firstName.empty),!1)},e.LastNameValidation=function(){return e.lastNameField()?e.lastNameField().length<2?(e.errorLastName(Config.Profile.error.lastName.minLength),!1):e.lastNameField().length>20?(e.errorLastName(Config.Profile.error.lastName.maxLength),!1):Config.Profile.regular.lastName.test(e.lastNameField())?(e.errorLastName(null),!0):(e.errorLastName(Config.Profile.error.lastName.regular),!1):(e.errorLastName(Config.Profile.error.lastName.empty),!1)},e.MiddleNameValidation=function(){if(e.middleNameField()){if(e.middleNameField().length<2)return e.errorMiddleName(Config.Profile.error.middleName.minLength),!1;if(e.middleNameField().length>20)return e.errorMiddleName(Config.Profile.error.middleName.maxLength),!1;if(!Config.Profile.regular.middleName.test(e.middleNameField()))return e.errorMiddleName(Config.Profile.error.middleName.regular),!1}return e.errorMiddleName(null),!0},e.BirthDayValidation=function(){if(!e.birthDayField())return e.errorBirthDay(Config.Profile.error.birthDay.empty),!1;if(!Config.Profile.regular.birthDay.test(e.birthDayField()))return e.errorBirthDay(Config.Profile.error.birthDay.regular),!1;var o=e.birthDayField().split("."),r=new Date(o[2],o[1]-1,o[0]),t=new Date,n=new Date(t.getYear()-18,t.getMonth(),t.getDate());if(r>n)return e.errorBirthDay(Config.Profile.error.birthDay.minDate),!1;var t=new Date,i=new Date(t.getYear()-101,t.getMonth(),t.getDate());return i>r?(e.errorBirthDay(Config.Profile.error.birthDay.maxDate),!1):(e.errorBirthDay(null),!0)},e.AddContent=function(o){e.data=o;var r=Parameters.cache.profile.info;r.route_icon_user&&e.iconUser(r.route_icon_user+"?"+EventDispatcher.HashCode(EventDispatcher.GetUUID())),e.username(r.login),e.gender(o.gender),e.lastName(o.f_name),e.firstName(o.s_name),e.middleName(o.m_name),e.birthDay(o.birth_day),e.rating(r.rating_user),e.lastNameField(e.data.s_name),e.firstNameField(e.data.f_name),e.middleNameField(e.data.m_name),e.birthDayField(e.data.birth_day),e.checkInfo(o.check_info)},e.isNew=function(){return data?!1:!0},e.Edit=function(){e.isEditBlock(1)},e.Back=function(){e.lastNameField(e.data.f_name),e.firstNameField(e.data.s_name),e.middleNameField(e.data.m_name),e.birthDayField(e.data.birth_day),e.isEditBlock(0)},e.Submit=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.personal.checking",e)},e.ClickItem=function(o){e.gender(o)}},ProfilePostalAddressViewModel=function(){var e=this;e.data=null,e.cssPostAddressForm="profile_postal_address_form",e.countryText=ko.observable(),e.idCountry=ko.observable(),e.country=ko.observable(),e.cssCountryList="country_list_profile",e.errorCountry=ko.observable(null),e.regionText=ko.observable(),e.region=ko.observable(),e.customRegion=ko.observable(),e.cssRegionList="region_list",e.errorRegion=ko.observable(null),e.showRegion=ko.computed(function(){return e.country()?!1:!0},this),e.cityText=ko.observable(),e.city=ko.observable(),e.customCity=ko.observable(),e.cssCityList="city_list",e.errorCity=ko.observable(null),e.showCity=ko.computed(function(){return e.customRegion()?!1:!0},this),e.addressText=ko.observable(),e.address=ko.observable(),e.customAddress=ko.observable(),e.cssAddress="address",e.errorAddress=ko.observable(null),e.showAddress=ko.computed(function(){return e.customCity()?!1:!0},this),e.postIndexText=ko.observable(),e.postIndex=ko.observable(),e.cssPostIndex="post_index",e.errorPostIndex=ko.observable(null),e.showPostIndex=ko.computed(function(){return e.customAddress()?!1:!0},this),e.checkInfo=ko.observable(),e.countryList=ko.observableArray(),e.isEditBlock=ko.observable(0),e.AddContent=function(o){e.data=o,e.idCountry(o.id_country),e.countryText(o.country),$.grep(e.countryList(),function(r){o.id_country==r.id&&e.country(r)}),e.regionText(o.region),e.region({regioncode:o.code_region}),e.customRegion(o.region),e.cityText(o.city),e.city({aoguid:o.code_city}),e.customCity(o.city),e.addressText(o.address),e.address(o.address),e.customAddress(o.address),e.postIndexText(o.post_code),e.postIndex(o.post_code),e.checkInfo(o.check_info),"postal_address"==Routing.params.edit&&e.isEditBlock(1)},e.AddCountryList=function(o){if(o.length>0)for(var r=0;r<=o.length-1;r++)e.countryList.push(new CountryListViewModel(o[r]))},e.Edit=function(){e.isEditBlock(1)},e.Back=function(){e.idCountry(e.data.id_country),e.region({regioncode:e.data.code_region}),e.customRegion(e.data.region),e.city({aoguid:e.data.code_city}),e.customCity(e.data.city),e.address(e.data.address),e.customAddress(e.data.address),e.postIndexText(e.data.post_code),e.postIndex(e.data.post_code),e.checkInfo(e.data.check_info),e.isEditBlock(0)},e.Submit=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.postalAddress.checking",e)},e.ValidationForm=function(){var o=!0;return e.CountryValidation()||(o=!1),e.RegionValidation()||(o=!1),e.CityValidation()||(o=!1),e.AddressValidation()||(o=!1),e.PostIndexValidation()||(o=!1),o},e.CountryValidation=function(){return e.country()?(e.errorCountry(null),!0):(e.errorCountry(Config.Profile.error.country.empty),!1)},e.RegionValidation=function(){return e.customRegion()?(e.errorRegion(null),!0):(e.errorRegion(Config.Profile.error.region.empty),!1)},e.CityValidation=function(){return e.customCity()?(e.errorCity(null),!0):(e.errorCity(Config.Profile.error.city.empty),!1)},e.AddressValidation=function(){return e.customAddress()?(e.errorAddress(null),!0):(e.errorAddress(Config.Profile.error.address.empty),!1)},e.PostIndexValidation=function(){return e.postIndex()?5>e.postIndex().length||e.postIndex().length>6?(e.errorPostIndex(Config.Profile.error.postIndex.length),!1):Config.Profile.regular.postIndex.test(e.postIndex())?(e.errorPostIndex(null),!0):(e.errorPostIndex(Config.Profile.error.postIndex.regular),!1):(e.errorPostIndex(Config.Profile.error.postIndex.empty),!1)}},ProfileContactsViewModel=function(){var e=this;e.email=ko.observable(),e.isExistEmail=ko.observable(),e.sentEmailCode=ko.observable(),e.emailToken=ko.observable(),e.errorEmail=ko.observable(null),e.errorEmailToken=ko.observable(null),e.emailIsConfirm=ko.observable(!1),e.phone=ko.observable(),e.cssPhone="phone_profile",e.isExistPhone=ko.observable(),e.sentCode=ko.observable(),e.phoneToken=ko.observable(),e.errorPhone=ko.observable(null),e.errorPhoneToken=ko.observable(null),e.phoneIsConfirm=ko.observable(!1),e.AddContent=function(){var o=Parameters.cache.profile.info;"yes"==o.confirm_phone&&e.phoneIsConfirm(!0),"yes"==o.confirm_email&&e.emailIsConfirm(!0),o.phone&&(e.phone(o.phone),e.isExistPhone(!0)),o.email&&(e.email(o.email),e.isExistEmail(!0))},e.ValidationForm=function(){var o=!0;return e.EmailValidation()||(o=!1),e.PhoneValidation()||(o=!1),o},e.EmailValidation=function(){return e.email()?e.email().length>64?(e.errorEmail(Config.Profile.error.email.maxLength),!1):Config.Profile.regular.email.test(e.email())?(e.errorEmail(null),!0):(e.errorEmail(Config.Profile.error.email.regular),!1):(e.errorEmail(Config.Profile.error.email.empty),!1)},e.PhoneValidation=function(){return e.emailIsConfirm()&&!e.phone()?(e.errorPhone(Config.Profile.error.phone.empty),!1):e.phone()&&!Config.Profile.regular.phone.test($.trim(e.phone()))?(e.errorPhone(Config.Profile.error.phone.regular),!1):(e.errorPhone(null),!0)},e.EmailTokenValidation=function(){var o=$.trim(e.emailToken());return e.emailToken(o),e.emailToken()?(e.errorEmailToken(null),!0):(e.errorEmailToken(Config.Profile.error.emailToken.empty),!1)},e.PhoneTokenValidation=function(){var o=$.trim(e.phoneToken());return e.phoneToken(o),e.phoneToken()?(e.errorPhoneToken(null),!0):(e.errorPhoneToken(Config.Profile.error.phoneToken.empty),!1)},e.SendMailToken=function(){e.sentEmailCode(!0),e.isExistEmail(!1),setTimeout(function(){e.isExistEmail(!0)},6e4),EventDispatcher.DispatchEvent("ProfileWidget.send.token","mail")},e.SendPhoneToken=function(){e.sentCode(!0),e.isExistPhone(!1),setTimeout(function(){e.isExistPhone(!0)},6e4),EventDispatcher.DispatchEvent("ProfileWidget.send.token","sms")},e.SubmitMailToken=function(){e.EmailTokenValidation()&&EventDispatcher.DispatchEvent("ProfileWidget.submit.token",{type:"mail",value:e})},e.SubmitPhoneToken=function(){e.PhoneTokenValidation()&&EventDispatcher.DispatchEvent("ProfileWidget.submit.token",{type:"sms",value:e})},e.SubmitForm=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.contacts.checking",e)}},ProfileDeliveryAddressViewModel=function(){var e=this;e.addressList=ko.observableArray(),e.cssAddressList="delivary_address_list",e.checked=ko.observable(),e.ClickAddAddress=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery",form:"add"})},e.AddContent=function(o){for(var r in o)DeliveryAddressViewModel.prototype=new Widget,e.addressList.push(new DeliveryAddressViewModel(o[r],e))}},DeliveryAddressViewModel=function(e,o){var r=this;r.id=e.id,r.idCountry=e.id_country,r.country=e.country,r.codeRegion=e.code_region,r.region=e.region,r.codeCity=e.code_city,r.city=e.city,r.postIndex=e.post_code,r.address=e.address,r.addressee=e.addressee,r.list=o.addressList(),"yes"==e.is_default?(r.isDefault=ko.observable(!0),r.cssIsDefault=ko.observable("delivery_address_is_default active"),o.checked(r.id)):(r.isDefault=ko.observable(!1),r.cssIsDefault=ko.observable("delivery_address_is_default")),r.contactPhone=e.contact_phone,r.Edit=function(){r.id?EventDispatcher.DispatchEvent("ProfileWidget.delivery.edit",r):Routing.SetHash("profile","Личный кабинет",{info:"personal",edit:"postal_address"})},r.Delete=function(){r.Confirm(Config.Profile.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.delete",{address:r,list:o})},!1)},r.ClickItem=function(){$.each(r.list,function(e){r.list[e].cssIsDefault("delivery_address_is_default"),r.list[e].isDefault(!1)}),r.cssIsDefault("delivery_address_is_default active"),r.isDefault(!0),o.checked(r.id),EventDispatcher.DispatchEvent("ProfileWidget.delivery.sedDefault",r)}},DeliveryAddressFormViewModel=function(){var e=this;e.id=ko.observable(),e.idCountry=ko.observable(),e.country=ko.observable(),e.cssCountryList="delivery_country_list",e.errorCountry=ko.observable(null),e.codeRegion=ko.observable(),e.region=ko.observable(),e.customRegion=ko.observable(),e.cssRegionList="delivery_region",e.errorRegion=ko.observable(null),e.showRegion=ko.computed(function(){return e.country()?!1:!0},this),e.codeCity=ko.observable(),e.city=ko.observable(),e.customCity=ko.observable(),e.cssCityList="delivery_city",e.errorCity=ko.observable(null),e.showCity=ko.computed(function(){return e.customRegion()?!1:!0},this),e.address=ko.observable(),e.customAddress=ko.observable(),e.cssAddress="delivery_cssAddress",e.errorAddress=ko.observable(null),e.showAddress=ko.computed(function(){return e.customCity()?!1:!0},this),e.postIndex=ko.observable(),e.cssPostCode="delivery_post_index",e.errorPostCode=ko.observable(null),e.showPostIndex=ko.computed(function(){return e.customAddress()?!1:!0},this),e.addressee=ko.observable(),e.errorAddressee=ko.observable(null),e.contactPhone=ko.observable(),e.cssContactPhone="delivery_contact_phone",e.errorContactPhone=ko.observable(null),e.isDefault=ko.observable(),e.countryList=ko.observableArray(),e.AddCountryList=function(o){if(o.length>0)for(var r=0;r<=o.length-1;r++)e.countryList.push(new CountryListViewModel(o[r])),o[r].id==e.idCountry()&&e.country(o[r])},e.AddContent=function(o){e.id(o.id),e.idCountry=ko.observable(o.idCountry),e.region({regioncode:o.codeRegion}),e.customRegion(o.region),e.city({aoguid:o.codeCity}),e.customCity(o.city),e.postIndex(o.postIndex),e.customAddress(o.address),e.addressee(o.addressee),e.isDefault(o.isDefault()),e.contactPhone(o.contactPhone)},e.Submit=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",e)},e.Edit=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.delivery.saveEdit",e)},e.ValidationForm=function(){var o=!0;return e.PhoneValidation()||(o=!1),e.UsernameValidation()||(o=!1),e.CountryValidation()||(o=!1),e.RegionValidation()||(o=!1),e.CityValidation()||(o=!1),e.AddressValidation()||(o=!1),e.PostIndexValidation()||(o=!1),o},e.CountryValidation=function(){return e.country()?(e.errorCountry(null),!0):(e.errorCountry(Config.Profile.error.country.empty),!1)},e.RegionValidation=function(){return e.customRegion()?(e.errorRegion(null),!0):(e.errorRegion(Config.Profile.error.region.empty),!1)},e.CityValidation=function(){return e.customCity()?(e.errorCity(null),!0):(e.errorCity(Config.Profile.error.city.empty),!1)},e.AddressValidation=function(){return e.customAddress()?(e.errorAddress(null),!0):(e.errorAddress(Config.Profile.error.address.empty),!1)},e.PostIndexValidation=function(){return e.postIndex()?5>e.postIndex().length||e.postIndex().length>6?(e.errorPostCode(Config.Profile.error.postIndex.length),!1):Config.Profile.regular.postIndex.test(e.postIndex())?(e.errorPostCode(null),!0):(e.errorPostCode(Config.Profile.error.postIndex.regular),!1):(e.errorPostCode(Config.Profile.error.postIndex.empty),!1)},e.UsernameValidation=function(){return e.addressee()?e.addressee().length<3?(e.errorAddressee(Config.Profile.error.addressee.minLength),!1):e.addressee().length>40?(e.errorAddressee(Config.Profile.error.addressee.maxLength),!1):Config.Profile.regular.addressee.test(e.addressee())?(e.errorAddressee(null),!0):(e.errorAddressee(Config.Registration.error.addressee.regular),!1):(e.errorAddressee(Config.Profile.error.addressee.empty),!1)},e.PhoneValidation=function(){return e.contactPhone()?Config.Profile.regular.phone.test($.trim(e.contactPhone()))?(e.errorContactPhone(null),!0):(e.errorContactPhone(Config.Profile.error.phone.regular),!1):(e.errorContactPhone(Config.Profile.error.phone.empty),!1)},e.Back=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery"})}},ProfileSecurityViewModel=function(){var e=this;e.cssSequrityForm="profile_sequrity_form",e.oldPassword=ko.observable(),e.cssOldPassword="profile_old_password",e.errorOldPassword=ko.observable(null),e.newPassword=ko.observable(),e.cssNewPassword="profile_new_password",e.errorNewPassword=ko.observable(null),e.confirmPassword=ko.observable(),e.cssConfirmPassword="profile_confirm_password",e.errorConfirmPassword=ko.observable(null),e.Submit=function(){e.ValidationForm()&&EventDispatcher.DispatchEvent("ProfileWidget.password.change",e)},e.ValidationForm=function(){var o=!0;return e.OldPasswordValidation()||(o=!1),e.NewPasswordValidation()||(o=!1),e.ConfirmPasswordValidation()||(o=!1),o},e.OldPasswordValidation=function(){return e.oldPassword($("input#"+e.cssOldPassword).val()),e.oldPassword()?e.oldPassword().length<6?(e.errorOldPassword(Config.Profile.error.password.minLength),!1):e.oldPassword().length>64?(e.errorOldPassword(Config.Profile.error.password.maxLength),!1):(e.errorOldPassword(null),!0):(e.errorOldPassword(Config.Profile.error.password.empty),!1)},e.NewPasswordValidation=function(){return e.newPassword($("input#"+e.cssNewPassword).val()),e.newPassword()?e.newPassword().length<6?(e.errorNewPassword(Config.Profile.error.password.minLength),!1):e.newPassword().length>64?(e.errorNewPassword(Config.Profile.error.password.maxLength),!1):(e.errorNewPassword(null),!0):(e.errorNewPassword(Config.Profile.error.password.empty),!1)},e.ConfirmPasswordValidation=function(){return e.confirmPassword($("input#"+e.cssConfirmPassword).val()),e.confirmPassword()?e.newPassword()!=e.confirmPassword()?(e.errorConfirmPassword(Config.Profile.error.password.equal),!1):(e.errorConfirmPassword(null),!0):(e.errorConfirmPassword(Config.Profile.error.password.empty),!1)}},TestProfile={Init:function(){if("function"==typeof Widget){ProfileWidget.prototype=new Widget;var e=new ProfileWidget;e.Init(e)}else setTimeout(function(){TestProfile.Init()},100)}};TestProfile.Init();