var ProfileWidget=function(){var n=this;n.widgetName="ProfileWidget";n.version=1;n.minWidgetVersion=1;n.maxWidgetVersion=2;n.minTmplVersion=1;n.maxTmplVersion=2;n.InitWidget=i;var w={container:{widget:"content",def:"defaultProfileWidgetId"},tmpl:{path:"profileTmpl.html",id:{personal:"personalInformationTmpl",delivery:"deliveryAddressTmpl",deliveryForm:"deliveryAddressFormTmpl",security:"securityTmpl"}},menu:{personalInformation:{title:"Персональные данные",prefix:"personal"},deliveryAddress:{title:"Адреса доставки",prefix:"delivery"},security:{title:"Безопасность",prefix:"security"}},regular:{email:/^[-._a-zA-Z0-9]+@(?:[a-z0-9][-a-z0-9]+\.)+[a-z]{2,6}$/,phone:/^([\d]{1})\s([\d]{3})\s([\d]{3})\s([\d]{2})\s([\d]{2})(\s([\d]{2}))?$/,firstName:/^[a-zёа-яА-ЯЁA-Z]+$/,lastName:/^[a-zа-яёА-ЯЁA-Z]+$/,middleName:/^[a-zа-яёА-ЯЁA-Z]+$/,birthDay:/^[\d]{2}.[\d]{2}.[\d]{4}$/,addressee:/^[a-zа-яёА-ЯЁA-Z\s]+$/,postIndex:/^[0-9]+$/},message:{sendToken:"Код активации успешно выслан по указанным данным.",failSendToken:"Код не был отправлен. Попробуйте повторить запрос позднее.",contactsEdit:"Данные успешно обновлены",failContactsEdit:"Данные не обновлены. Попробуйте повторить запрос позднее.",editProfile:"Данные успешно обновлены",failEditProfile:"Данные не обновлены. Попробуйте повторить запрос позднее.",changePassword:"Пароль успешно изменен.",failChangePassord:"Пароль не изменен.",addAddressDelivery:"Данные успешно сохранены.",failAddAddressDelivery:"Данные не сохранены. Попробуйте повторить запрос позднее.",deleteAddressDelivery:"Адрес доставки успешно удален.",confirmDeleteAddressDelivery:"Вы уверены, что хотите удалить адрес?",failDeleteAddressDelivery:"Адрес доставки не удален. Попробуйте повторить запрос позднее.",setDefaultDelivery:"Данные успешно обновлены.",failSetDefaultDelivery:"Данные не обновлены."},error:{iconUser:{extension:"Раширение фала должно быть jpeg, png или gif"},email:{empty:"Поле обязательно для заполнения",maxLength:"Максимум 64 символа",regular:"Строка не является адресом электронной почты",uniq:'Аккаунт для этого почтового ящика уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},phone:{empty:"Поле обязательно для заполнения",regular:"Не верный формат телефона",uniq:'Аккаунт для этого номера телефона уже существует, рекомендуем пройти процедуру восстановления доступа. <a href="#">Восстановить доступ</a>'},password:{empty:"Поле обязательно для заполнения",minLength:"Пароль должен быть не менее 6 символов",maxLength:"Пароль должен быть не более 64 символов",equal:"Пароль не совпадает с образцом"},emailToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},phoneToken:{empty:"Поле обязательно для заполнения",confirm:"Указанный код не принят системой"},addressee:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},firstName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},lastName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},middleName:{empty:"Поле обязательно для заполнения",minLength:"Минимум 2 символа",maxLength:"Максимум 20 символов",regular:"Только буквы латинского или русского алфавита"},birthDay:{empty:"Поле обязательно для заполнения",minDate:"Возраст пользователя должен быть не менее 18 лет.",maxDate:"Возраст пользователя может быть не старше 101 года"},country:{empty:"Поле обязательно для заполнения"},region:{empty:"Поле обязательно для заполнения"},city:{empty:"Поле обязательно для заполнения"},address:{empty:"Поле обязательно для заполнения"},postIndex:{empty:"Поле обязательно для заполнения",length:"В почтовом индексе должно быть 5 или 6 цифр",regular:"Только цифры"}},animate:typeof AnimateProfile=="function"?AnimateProfile:null,geoShop:0};function i(){A();j();n.CheckRouteProfile()}function A(){var C=n.GetInputParameters("profile");if(!$.isEmptyObject(C)){w=n.UpdateSettings1(w,C)}Config.Containers.profile=w.container}n.CheckRouteProfile=function(){if(Routing.route=="profile"){n.WidgetLoader(false);n.BaseLoad.Login(false,false,false,function(C){if(!C.err){Loader.Indicator("MenuPersonalCabinetWidget",false);n.BaseLoad.Tmpl(w.tmpl,function(){var D=Routing.params,E=w.menu;if(!D.info||D.info==E.personalInformation.prefix){k()}if(D.info==E.deliveryAddress.prefix&&!D.form){d()}if(D.info==E.deliveryAddress.prefix&&D.form=="add"){x()}if(D.info==E.security.prefix){e()}o()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});n.WidgetLoader(true)}})}else{n.WidgetLoader(true)}};function j(){n.AddEvent("w.change.route",function(){n.CheckRouteProfile()});n.AddEvent("Profile.personal.checking",function(E){var D=E.birthDayField().split(".");var C=D[2]+"-"+D[1]+"-"+D[0];E.birthDayHiddenField(C);n.BaseLoad.EditProfile($("form#"+E.cssRegistrationDataForm),function(F){if(F.result=="ok"){n.ShowMessage(w.message.editProfile,function(){Parameters.cache.profile.personal={};Parameters.cache.userInformation=null;Parameters.cache.profile.info={};window.location.reload(true)},false)}else{if(!F.err){F.err=w.message.failEditProfile}n.QueryError(F,function(){n.DispatchEvent("Profile.personal.checking",E)})}})});n.AddEvent("Profile.postalAddress.checking",function(C){var D="?id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+b(C.postIndex());n.BaseLoad.EditAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.editProfile,function(){Parameters.cache.profile.personal={};C.countryText(C.country().name);C.regionText(C.customRegion());C.cityText(C.customCity());C.addressText(C.customAddress());C.postIndexText(C.postIndex());C.isEditBlock(0)},false)}else{if(!E.err){E.err=w.message.failEditProfile}n.QueryError(E,function(){n.DispatchEvent("Profile.postalAddress.checking",C)})}})});n.AddEvent("Profile.send.token",function(C){n.BaseLoad.SendToken(C,function(D){if(D.result=="ok"){n.ShowMessage(w.message.sendToken,false,false)}else{if(!D.err){D.err=w.message.failSendToken}n.QueryError(D,function(){n.DispatchEvent("Profile.send.token",C)})}})});n.AddEvent("Profile.submit.token",function(D){var C=Parameters.cache.userInformation;var F=[];F.push("username="+b(C.login));if(D.type=="mail"){F.push("mail_token="+D.value.emailToken())}if(D.type=="sms"){F.push("sms_token="+D.value.phoneToken())}var E="?"+F.join("&");n.BaseLoad.ActivateUser(E,function(G){Parameters.cache.profile.info={};if(n.QueryError(G,function(){n.DispatchEvent("Profile.submit.token",D)})){if(l(G,D.value)){D.value.emailIsConfirm(true)}if(t(G,D.value)){D.value.phoneIsConfirm(true)}}})});n.AddEvent("Profile.contacts.checking",function(C){var D="?";if(C.email()&&!C.emailIsConfirm()){D=D+"email="+b(C.email())}if(C.phone()){D=D+"&phone="+b(C.phone())}n.BaseLoad.EditContacts(D,function(E){if(E.result=="ok"){C.sentCode(true);setTimeout(function(){C.isExistPhone(true)},60000);C.sentEmailCode(true);setTimeout(function(){C.isExistMail(true)},60000);n.ShowMessage(w.message.contactsEdit,false,false)}else{if(!E.err){E.err=w.message.failContactsEdit}n.QueryError(E,function(){n.DispatchEvent("Profile.contacts.checking",C)})}})});n.AddEvent("Profile.password.change",function(C){n.BaseLoad.ChangePassword($("form#"+C.cssSequrityForm),function(D){if(D.result=="ok"){C.oldPassword(null);C.newPassword(null);C.confirmPassword(null);n.ShowMessage(w.message.changePassword,false,false)}else{if(!D.err){D.err=w.message.failChangePassord}n.QueryError(D,function(){n.DispatchEvent("Profile.password.change",C)},function(){C.oldPassword(null);C.newPassword(null);C.confirmPassword(null)})}})});n.AddEvent("Profile.delivery.add",function(C){var D="?id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+b(C.postIndex())+"&addressee="+b(C.addressee())+"&contact_phone="+b(C.contactPhone())+"&is_default="+encodeURIComponent(C.isDefault()?"yes":"no");n.BaseLoad.AddDelivaryAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!E.err){E.err=w.message.failAddAddressDelivery}n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.add",C)})}})});n.AddEvent("Profile.delivery.saveEdit",function(C){var D="?id_address="+C.id()+"&id_country="+b(C.country().id);if(C.region()&&C.region().regioncode){D=D+"&code_region="+b(C.region().regioncode)}else{D=D+"&name_region="+b(C.customRegion())}if(C.city()&&C.city().aoguid){D=D+"&code_city="+b(C.city().aoguid)}else{D=D+"&name_city="+b(C.customCity())}D=D+"&address="+b(C.customAddress())+"&post_code="+b(C.postIndex())+"&addressee="+b(C.addressee())+"&contact_phone="+b(C.contactPhone())+"&is_default="+encodeURIComponent(C.isDefault()?"yes":"no");n.BaseLoad.EditDelivaryAddress(D,function(E){if(E.result=="ok"){n.ShowMessage(w.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!E.err){E.err=w.message.failAddAddressDelivery}n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.add",C)})}})});n.AddEvent("Profile.delivery.delete",function(C){n.BaseLoad.DeleteDeliveryAddress(C.address.id,function(D){if(D.result=="ok"){n.ShowMessage(w.message.deleteAddressDelivery,function(){Parameters.cache.delivery=null;C.list.addressList.remove(C.address)},false)}else{if(!D.err){D.err=w.message.failDeleteAddressDelivery}n.QueryError(D,function(){n.DispatchEvent("Profile.delivery.delete",C)})}})});n.AddEvent("Profile.delivery.edit",function(C){n.BaseLoad.Script(PokupoWidgets.model.content,function(){var D=new DeliveryAddressFormViewModel(w);D.AddContent(C);p(D)})});n.AddEvent("Profile.delivery.sedDefault",function(C){var D="?id_address="+C.id+"&is_default=yes";n.BaseLoad.SetDefaultDelivaryAddress(D,function(E){if(E.result=="ok"){}else{n.QueryError(E,function(){n.DispatchEvent("Profile.delivery.sedDefault",C)})}})})}function b(C){return encodeURIComponent($.trim(C))}function l(D,C){if(D.confirm_email){if(D.confirm_email=="no"){C.errorEmailConfirm(w.error.emailToken.confirm);return false}return true}return false}function t(D,C){if(D.confirm_phone){if(D.confirm_phone=="no"){C.errorPhoneConfirm(w.error.phoneToken.confirm);return false}return true}return false}function o(){n.BaseLoad.Script(PokupoWidgets.model.menu,function(){if(!Routing.params.info){Routing.params.info=w.menu.personalInformation.prefix}n.DispatchEvent("w.onload.menu",{menu:w.menu,active:Routing.params.info})})}function k(){c();n.BaseLoad.Script(PokupoWidgets.model.content,function(){n.BaseLoad.Profile(function(C){n.BaseLoad.ProfileInfo(function(D){a(C,D)})})})}function d(){n.BaseLoad.DeliveryAddressList(function(C){u();r(C)})}function x(){n.BaseLoad.Script(PokupoWidgets.model.content,function(){var C=new DeliveryAddressFormViewModel(w);p(C)})}function e(){g();q()}function v(){n.ClearContainer(w)}function c(){n.InsertContainer(w,"personal")}function u(){n.InsertContainer(w,"delivery")}function h(){n.InsertContainer(w,"deliveryForm")}function g(){n.InsertContainer(w,"security")}function a(F,D){var C=new ProfilePersonalInformationViewModel(w);var E=Parameters.shopId;if(w.geoShop==0){E=0}n.BaseLoad.Country(E,function(G){C.AddContent(F,D,G);y(C)})}function r(C){var D=new ProfileDeliveryAddressViewModel(w);D.AddContent(C);s(D)}function p(D){var C=Parameters.shopId;if(w.geoShop==0){C=0}n.BaseLoad.Country(C,function(E){D.AddCountryList(E);h();B(D)})}function q(){var C=new ProfileSecurityViewModel(w);m(C)}function y(C){n.RenderTemplate(C,w,function(D){z(D);if(w.animate){w.animate(D.postalAddress.country)}},function(D){c();y(D)},function(){v()},"delivery")}function s(C){n.RenderTemplate(C,w,null,function(D){u();s(D)},function(){v()},"delivery")}function B(C){n.RenderTemplate(C,w,function(D){f(D);if(w.animate){w.animate(D.country)}},function(D){h();B(D)},function(){v()},"deliveryForm")}function m(C){n.RenderTemplate(C,w,null,function(D){g();m(D)},function(){v()},"security")}function z(D){var C=D.postalAddress;$("#"+C.cssCountryList).change(function(){var E=$("#"+C.cssCountryList+" option:selected").val();$.grep(C.countryList(),function(F){if(F.id==E){C.country(F);C.customRegion(null);C.region(null);C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)}})});$("#"+C.cssRegionList).autocomplete({source:function(F,E){n.BaseLoad.Region(C.country().id+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.formalname+" "+H.shortname),region:H}}))}else{$("#"+C.cssRegionList).autocomplete("close");return false}})},select:function(E,F){C.region(F.item.region);C.customRegion(F.item.value);if(F.item.region&&F.item.region.postalcode!=0){C.postIndex(F.item.region.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCityList).autocomplete({source:function(F,E){if(C.region()){n.BaseLoad.City(C.country().id+"/"+b(C.region().regioncode)+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.shortname+". "+H.formalname),city:H}}))}else{$("#"+C.cssCityList).autocomplete("close");return false}})}},select:function(E,F){C.city(F.item.city);C.customCity(F.item.value);if(F.item.city&&F.item.city.postalcode!=0){C.postIndex(F.item.city.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssAddress).autocomplete({source:function(F,E){if(C.region()){n.BaseLoad.Street(C.country().id+"/"+b(C.region().regioncode)+"/"+b(C.city().aoguid)+"/"+b(F.term),function(G){if(!G.err){E($.map(G,function(H){return{value:$.trim(H.shortname+". "+H.formalname),street:H}}))}else{$("#"+C.cssAddress).autocomplete("close");return false}})}},select:function(E,F){C.address(F.item.street);C.customAddress(F.item.value);if(F.item.street&&F.item.street.postalcode!=0){C.postIndex(F.item.street.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssRegionList).bind("textchange",function(F,E){C.customRegion($(this).val());C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)});$("#"+C.cssCityList).bind("textchange",function(F,E){C.customCity($(this).val());C.customAddress(null);C.address(null);C.postIndex(null)});if(Routing.params.edit=="postal_address"){n.ScrollTop(C.cssPostAddressForm,700)}}function f(C){$("#"+C.cssRegionList).autocomplete({source:function(E,D){n.BaseLoad.Region(C.country().id+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.formalname+" "+G.shortname),region:G}}))}else{$("#"+C.cssRegionList).autocomplete("close");return false}})},select:function(D,E){C.region(E.item.region);C.customRegion(E.item.value);if(E.item.region&&E.item.region.postalcode!=0){C.postIndex(E.item.region.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCityList).autocomplete({source:function(E,D){if(C.region()){n.BaseLoad.City(C.country().id+"/"+b(C.region().regioncode)+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.shortname+". "+G.formalname),city:G}}))}else{$("#"+C.cssCityList).autocomplete("close");return false}})}},select:function(D,E){C.city(E.item.city);C.customCity(E.item.value);if(E.item.city&&E.item.city.postalcode!=0){C.postIndex(E.item.city.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssAddress).autocomplete({source:function(E,D){if(C.region()){n.BaseLoad.Street(C.country().id+"/"+b(C.region().regioncode)+"/"+b(C.city().aoguid)+"/"+b(E.term),function(F){if(!F.err){D($.map(F,function(G){return{value:$.trim(G.shortname+". "+G.formalname),street:G}}))}else{$("#"+C.cssAddress).autocomplete("close");return false}})}},select:function(D,E){C.address(E.item.street);C.customAddress(E.item.value);if(E.item.street&&E.item.street.postalcode!=0){C.postIndex(E.item.street.postalcode)}else{C.postIndex(null)}}});$("#"+C.cssCountryList).change(function(){var D=$("#"+C.cssCountryList+" option:selected").val();$.grep(C.countryList(),function(E){if(E.id==D){C.country(E);C.customRegion(null);C.region(null);C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)}})});$("#"+C.cssRegionList).bind("textchange",function(E,D){C.customRegion($(this).val());C.customCity(null);C.city(null);C.customAddress(null);C.address(null);C.postIndex(null)});$("#"+C.cssCityList).bind("textchange",function(E,D){C.customCity($(this).val());C.customAddress(null);C.address(null);C.postIndex(null)})}};var ProfilePersonalInformationViewModel=function(b){var a=this;a.registrationData=null;a.postalAddress=null;a.contacts=null;a.AddContent=function(g,d,h){var f=new ProfileDataRegistrationViewModel(b);if(!g.err){f.AddContent(g)}f.dateRegistration(d.date_reg);a.registrationData=f;var e=new ProfilePostalAddressViewModel(b);e.AddCountryList(h);if(!g.err){e.AddContent(g)}a.postalAddress=e;a.contacts=new ProfileContactsViewModel(b);a.contacts.AddContent()}};var ProfileDataRegistrationViewModel=function(e){var c=this;c.data=null;c.username=ko.observable();c.dateRegistration=ko.observable();c.gender=ko.observable();c.genderText=ko.computed(function(){if(c.gender()=="m"){return"мужской"}else{return"женский"}},this);c.errorGender=ko.observable(null);c.lastName=ko.observable();c.firstName=ko.observable();c.middleName=ko.observable();c.fullName=ko.computed(function(){var i="";if(c.lastName()){i=i+c.lastName()}if(c.firstName()){i=i+" "+c.firstName()}if(c.middleName()){i=i+" "+c.middleName()}return i},this);c.birthDay=ko.observable();c.cssBirthDay="birthDay";c.rating=ko.observable();c.checkInfo=ko.observable();c.lastNameField=ko.observable();c.firstNameField=ko.observable();c.middleNameField=ko.observable();c.birthDayField=ko.observable();c.birthDayHiddenField=ko.observable();c.errorLastName=ko.observable(null);c.errorFirstName=ko.observable(null);c.errorMiddleName=ko.observable(null);c.errorBirthDay=ko.observable(null);c.isEditBlock=ko.observable(0);c.iconUser=ko.observable();c.cssIconUser="avatar_file";c.errorIconUser=ko.observable(null);c.cssRegistrationDataForm="profile_registration_data_form";function h(){var i=true;if(!g()){i=false}if(!d()){i=false}if(!a()){i=false}if(!b()){i=false}if(!f()){i=false}return i}function g(){var j=$("#"+c.cssIconUser).val();if(j){var i=j.split(".");var k=i[i.length-1];k=k.toLowerCase();if($.inArray(k,["jpeg","jpg","png","gif"])<0){c.errorIconUser(e.error.iconUser.extension);return false}}c.errorIconUser(null);return true}function d(){var i=e.error.firstName;if(!c.firstNameField()){c.errorFirstName(i.empty);return false}if(c.firstNameField().length<2){c.errorFirstName(i.minLength);return false}if(c.firstNameField().length>20){c.errorFirstName(i.maxLength);return false}if(!e.regular.firstName.test(c.firstNameField())){c.errorFirstName(i.regular);return false}c.errorFirstName(null);return true}function a(){var i=e.error.lastName;if(!c.lastNameField()){c.errorLastName(i.empty);return false}if(c.lastNameField().length<2){c.errorLastName(i.minLength);return false}if(c.lastNameField().length>20){c.errorLastName(i.maxLength);return false}if(!e.regular.lastName.test(c.lastNameField())){c.errorLastName(i.regular);return false}c.errorLastName(null);return true}function b(){var i=e.error.middleName;if(c.middleNameField()){if(c.middleNameField().length<2){c.errorMiddleName(i.minLength);return false}if(c.middleNameField().length>20){c.errorMiddleName(i.maxLength);return false}if(!e.regular.middleName.test(c.middleNameField())){c.errorMiddleName(i.regular);return false}}c.errorMiddleName(null);return true}function f(){var k=e.error.birthDay;if(!c.birthDayField()){c.errorBirthDay(k.empty);return false}if(!e.regular.birthDay.test(c.birthDayField())){c.errorBirthDay(k.regular);return false}var m=c.birthDayField().split(".");var j=new Date(m[2],m[1]-1,m[0]);var i=new Date();var l=new Date(i.getYear()-18,i.getMonth(),i.getDate());if(l<j){c.errorBirthDay(k.minDate);return false}var i=new Date();var n=new Date(i.getYear()-101,i.getMonth(),i.getDate());if(n>j){c.errorBirthDay(k.maxDate);return false}c.errorBirthDay(null);return true}c.AddContent=function(j){c.data=j;var i=Parameters.cache.profile.info;if(i.route_icon_user){c.iconUser(i.route_icon_user+"?"+EventDispatcher.HashCode(EventDispatcher.GetUUID()))}c.username(i.login);c.gender(j.gender);c.lastName(j.f_name);c.firstName(j.s_name);c.middleName(j.m_name);c.birthDay(j.birth_day);c.rating(i.rating_user);c.lastNameField(c.data.s_name);c.firstNameField(c.data.f_name);c.middleNameField(c.data.m_name);c.birthDayField(c.data.birth_day);c.checkInfo(j.check_info)};c.isNew=function(){if(data){return false}return true};c.Edit=function(){c.isEditBlock(1)};c.Back=function(){c.lastNameField(c.data.f_name);c.firstNameField(c.data.s_name);c.middleNameField(c.data.m_name);c.birthDayField(c.data.birth_day);c.isEditBlock(0)};c.Submit=function(){if(h()){EventDispatcher.DispatchEvent("Profile.personal.checking",c)}};c.ClickItem=function(j,i){c.gender(j)}};var ProfilePostalAddressViewModel=function(e){var a=this;a.data=null;a.cssPostAddressForm="profile_postal_address_form";a.countryText=ko.observable();a.idCountry=ko.observable();a.country=ko.observable();a.cssCountryList="country_list_profile";a.errorCountry=ko.observable(null);a.regionText=ko.observable();a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="region_list";a.errorRegion=ko.observable(null);a.showRegion=ko.computed(function(){if(a.country()){return false}return true},this);a.cityText=ko.observable();a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="city_list";a.errorCity=ko.observable(null);a.showCity=ko.computed(function(){if(a.customRegion()){return false}return true},this);a.addressText=ko.observable();a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="address";a.errorAddress=ko.observable(null);a.showAddress=ko.computed(function(){if(a.customCity()){return false}return true},this);a.postIndexText=ko.observable();a.postIndex=ko.observable();a.cssPostIndex="post_index";a.errorPostIndex=ko.observable(null);a.showPostIndex=ko.computed(function(){if(a.customAddress()){return false}return true},this);a.checkInfo=ko.observable();a.countryList=ko.observableArray();a.isEditBlock=ko.observable(0);a.AddContent=function(i){a.data=i;a.idCountry(i.id_country);a.countryText(i.country);$.grep(a.countryList(),function(j){if(i.id_country==j.id){a.country(j)}});a.regionText(i.region);a.region({regioncode:i.code_region});a.customRegion(i.region);a.cityText(i.city);a.city({aoguid:i.code_city});a.customCity(i.city);a.addressText(i.address);a.address(i.address);a.customAddress(i.address);a.postIndexText(i.post_code);a.postIndex(i.post_code);a.checkInfo(i.check_info);if(Routing.params.edit=="postal_address"){a.isEditBlock(1)}};a.AddCountryList=function(k){if(k.length>0){for(var j=0;j<=k.length-1;j++){a.countryList.push(new CountryListViewModel(k[j]))}}};a.Edit=function(){a.isEditBlock(1)};a.Back=function(){a.idCountry(a.data.id_country);a.region({regioncode:a.data.code_region});a.customRegion(a.data.region);a.city({aoguid:a.data.code_city});a.customCity(a.data.city);a.address(a.data.address);a.customAddress(a.data.address);a.postIndexText(a.data.post_code);a.postIndex(a.data.post_code);a.checkInfo(a.data.check_info);a.isEditBlock(0)};a.Submit=function(){if(h()){EventDispatcher.DispatchEvent("Profile.postalAddress.checking",a)}};function h(){var i=true;if(!g()){i=false}if(!f()){i=false}if(!d()){i=false}if(!c()){i=false}if(!b()){i=false}return i}function g(){if(!a.country()){a.errorCountry(e.error.country.empty);return false}a.errorCountry(null);return true}function f(){if(!a.customRegion()){a.errorRegion(e.error.region.empty);return false}a.errorRegion(null);return true}function d(){if(!a.customCity()){a.errorCity(e.error.city.empty);return false}a.errorCity(null);return true}function c(){if(!a.customAddress()){a.errorAddress(e.error.address.empty);return false}a.errorAddress(null);return true}function b(){var i=e.error.postIndex;if(!a.postIndex()){a.errorPostIndex(i.empty);return false}if(5>a.postIndex().length||a.postIndex().length>6){a.errorPostIndex(i.length);return false}if(!e.regular.postIndex.test(a.postIndex())){a.errorPostIndex(i.regular);return false}a.errorPostIndex(null);return true}};var ProfileContactsViewModel=function(f){var d=this;d.email=ko.observable();d.isExistEmail=ko.observable();d.sentEmailCode=ko.observable();d.emailToken=ko.observable();d.errorEmail=ko.observable(null);d.errorEmailToken=ko.observable(null);d.emailIsConfirm=ko.observable(false);d.phone=ko.observable();d.cssPhone="phone_profile";d.isExistPhone=ko.observable();d.sentCode=ko.observable();d.phoneToken=ko.observable();d.errorPhone=ko.observable(null);d.errorPhoneToken=ko.observable(null);d.phoneIsConfirm=ko.observable(false);d.AddContent=function(){var i=Parameters.cache.profile.info;if(i.confirm_phone=="yes"){d.phoneIsConfirm(true)}if(i.confirm_email=="yes"){d.emailIsConfirm(true)}if(i.phone){d.phone(i.phone);d.isExistPhone(true)}if(i.email){d.email(i.email);d.isExistEmail(true)}};function g(){var i=true;if(!a()){i=false}if(!h()){i=false}return i}function a(){var i=f.error.email;if(!d.email()){d.errorEmail(i.empty);return false}if(d.email().length>64){d.errorEmail(i.maxLength);return false}if(!f.regular.email.test(d.email())){d.errorEmail(i.regular);return false}d.errorEmail(null);return true}function h(){var i=f.error.phone;if(d.emailIsConfirm()){if(!d.phone()){d.errorPhone(i.empty);return false}}if(d.phone()){if(!f.regular.phone.test($.trim(d.phone()))){d.errorPhone(i.regular);return false}}d.errorPhone(null);return true}function c(){var i=$.trim(d.emailToken());d.emailToken(i);if(!d.emailToken()){d.errorEmailToken(f.error.emailToken.empty);return false}d.errorEmailToken(null);return true}function b(){var i=$.trim(d.phoneToken());d.phoneToken(i);if(!d.phoneToken()){d.errorPhoneToken(f.error.phoneToken.empty);return false}d.errorPhoneToken(null);return true}d.SendMailToken=function(){d.sentEmailCode(true);d.isExistEmail(false);setTimeout(function(){d.isExistEmail(true)},60000);e("Profile.send.token","mail")};d.SendPhoneToken=function(){d.sentCode(true);d.isExistPhone(false);setTimeout(function(){d.isExistPhone(true)},60000);e("Profile.send.token","sms")};d.SubmitMailToken=function(){if(c()){e("Profile.submit.token",{type:"mail",value:d})}};d.SubmitPhoneToken=function(){if(b()){e("Profile.submit.token",{type:"sms",value:d})}};d.SubmitForm=function(){if(g()){e("Profile.contacts.checking",d)}};function e(i,j){EventDispatcher.DispatchEvent(i,j)}};var ProfileDeliveryAddressViewModel=function(b){var a=this;a.addressList=ko.observableArray();a.cssAddressList="delivary_address_list";a.checked=ko.observable();a.ClickAddAddress=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery",form:"add"})};a.AddContent=function(d){for(var c in d){DeliveryAddressViewModel.prototype=new Widget();a.addressList.push(new DeliveryAddressViewModel(d[c],a,b))}}};var DeliveryAddressViewModel=function(e,d,c){var a=this;a.id=e.id;a.idCountry=e.id_country;a.country=e.country;a.codeRegion=e.code_region;a.region=e.region;a.codeCity=e.code_city;a.city=e.city;a.postIndex=e.post_code;a.address=e.address;a.addressee=e.addressee;a.list=d.addressList();if(e.is_default=="yes"){a.isDefault=ko.observable(true);a.cssIsDefault=ko.observable("delivery_address_is_default active");d.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.contactPhone=e.contact_phone;a.Edit=function(){if(a.id){b("Profile.delivery.edit",a)}else{Routing.SetHash("profile","Личный кабинет",{info:"personal",edit:"postal_address"})}};a.Delete=function(){a.Confirm(c.message.confirmDeleteAddressDelivery,function(){b("Profile.delivery.delete",{address:a,list:d})},false)};a.ClickItem=function(){$.each(a.list,function(f){a.list[f].cssIsDefault("delivery_address_is_default");a.list[f].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);d.checked(a.id);b("Profile.delivery.sedDefault",a)};function b(f,g){EventDispatcher.DispatchEvent(f,g)}};var DeliveryAddressFormViewModel=function(e){var j=this;j.id=ko.observable();j.idCountry=ko.observable();j.country=ko.observable();j.cssCountryList="delivery_country_list";j.errorCountry=ko.observable(null);j.codeRegion=ko.observable();j.region=ko.observable();j.customRegion=ko.observable();j.cssRegionList="delivery_region";j.errorRegion=ko.observable(null);j.showRegion=ko.computed(function(){if(j.country()){return false}return true},this);j.codeCity=ko.observable();j.city=ko.observable();j.customCity=ko.observable();j.cssCityList="delivery_city";j.errorCity=ko.observable(null);j.showCity=ko.computed(function(){if(j.customRegion()){return false}return true},this);j.address=ko.observable();j.customAddress=ko.observable();j.cssAddress="delivery_cssAddress";j.errorAddress=ko.observable(null);j.showAddress=ko.computed(function(){if(j.customCity()){return false}return true},this);j.postIndex=ko.observable();j.cssPostCode="delivery_post_index";j.errorPostCode=ko.observable(null);j.showPostIndex=ko.computed(function(){if(j.customAddress()){return false}return true},this);j.addressee=ko.observable();j.errorAddressee=ko.observable(null);j.contactPhone=ko.observable();j.cssContactPhone="delivery_contact_phone";j.errorContactPhone=ko.observable(null);j.isDefault=ko.observable();j.countryList=ko.observableArray();j.AddCountryList=function(l){if(l.length>0){for(var k=0;k<=l.length-1;k++){j.countryList.push(new CountryListViewModel(l[k]));if(l[k].id==j.idCountry()){j.country(l[k])}}}};j.AddContent=function(k){j.id(k.id);j.idCountry=ko.observable(k.idCountry);j.region({regioncode:k.codeRegion});j.customRegion(k.region);j.city({aoguid:k.codeCity});j.customCity(k.city);j.postIndex(k.postIndex);j.customAddress(k.address);j.addressee(k.addressee);j.isDefault(k.isDefault());j.contactPhone(k.contactPhone)};j.Submit=function(){if(d()){EventDispatcher.DispatchEvent("Profile.delivery.add",j)}};j.Edit=function(){if(d()){EventDispatcher.DispatchEvent("Profile.delivery.saveEdit",j)}};function d(){var k=true;if(!i()){k=false}if(!h()){k=false}if(!g()){k=false}if(!c()){k=false}if(!a()){k=false}if(!f()){k=false}if(!b()){k=false}return k}function g(){if(!j.country()){j.errorCountry(e.error.country.empty);return false}j.errorCountry(null);return true}function c(){if(!j.customRegion()){j.errorRegion(e.error.region.empty);return false}j.errorRegion(null);return true}function a(){if(!j.customCity()){j.errorCity(e.error.city.empty);return false}j.errorCity(null);return true}function f(){if(!j.customAddress()){j.errorAddress(e.error.address.empty);return false}j.errorAddress(null);return true}function b(){var k=e.error.postIndex;if(!j.postIndex()){j.errorPostCode(k.empty);return false}if(5>j.postIndex().length||j.postIndex().length>6){j.errorPostCode(k.length);return false}if(!e.regular.postIndex.test(j.postIndex())){j.errorPostCode(k.regular);return false}j.errorPostCode(null);return true}function h(){var k=e.error.addressee;if(!j.addressee()){j.errorAddressee(k.empty);return false}if(j.addressee().length<3){j.errorAddressee(k.minLength);return false}if(j.addressee().length>40){j.errorAddressee(k.maxLength);return false}if(!e.regular.addressee.test(j.addressee())){j.errorAddressee(k.regular);return false}j.errorAddressee(null);return true}function i(){var k=e.error.phone;if(!j.contactPhone()){j.errorContactPhone(k.empty);return false}if(!e.regular.phone.test($.trim(j.contactPhone()))){j.errorContactPhone(k.regular);return false}j.errorContactPhone(null);return true}j.Back=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery"})}};var ProfileSecurityViewModel=function(d){var b=this;b.cssSequrityForm="profile_sequrity_form";b.oldPassword=ko.observable();b.cssOldPassword="profile_old_password";b.errorOldPassword=ko.observable(null);b.newPassword=ko.observable();b.cssNewPassword="profile_new_password";b.errorNewPassword=ko.observable(null);b.confirmPassword=ko.observable();b.cssConfirmPassword="profile_confirm_password";b.errorConfirmPassword=ko.observable(null);b.Submit=function(){if(e()){EventDispatcher.DispatchEvent("Profile.password.change",b)}};function e(){var g=true;if(!f()){g=false}if(!a()){g=false}if(!c()){g=false}return g}function f(){var g=d.error.password;b.oldPassword($("input#"+b.cssOldPassword).val());if(!b.oldPassword()){b.errorOldPassword(g.empty);return false}if(b.oldPassword().length<6){b.errorOldPassword(g.minLength);return false}if(b.oldPassword().length>64){b.errorOldPassword(g.maxLength);return false}b.errorOldPassword(null);return true}function a(){var g=d.error.password;b.newPassword($("input#"+b.cssNewPassword).val());if(!b.newPassword()){b.errorNewPassword(g.empty);return false}if(b.newPassword().length<6){b.errorNewPassword(g.minLength);return false}if(b.newPassword().length>64){b.errorNewPassword(g.maxLength);return false}b.errorNewPassword(null);return true}function c(){var g=d.error.password;b.confirmPassword($("input#"+b.cssConfirmPassword).val());if(!b.confirmPassword()){b.errorConfirmPassword(g.empty);return false}if(b.newPassword()!=b.confirmPassword()){b.errorConfirmPassword(g.equal);return false}b.errorConfirmPassword(null);return true}};var TestProfile={Init:function(){if(typeof Widget=="function"){ProfileWidget.prototype=new Widget();var a=new ProfileWidget();a.Init(a)}else{setTimeout(function(){TestProfile.Init()},100)}}};TestProfile.Init();