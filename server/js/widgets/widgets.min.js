var JSSettings={shopId:0,protocolHTTP:"https://",protocolHTTPS:"https://",host:"server.pokupo.ru/prod/server/",pathToJS:"js/",pathToTmpl:"pokupo.ru/themes/",theme:"default",pathToData:"prod/server/services/DataProxy.php?query=",pathToPostData:"prod/server/services/DataPostProxy.php",pathToCore:"index.html",pathToPostCore:"postData.html",hostApi:"api.pokupo.ru/",catalogPathApi:"catalog/",goodsPathApi:"goods/",userPathApi:"user/",cartPathApi:"cart/",favPathApi:"fav/",geoPathApi:"geo/",shopPathApi:"shop/",orderPathApi:"order/",paymentPathApi:"payment/",messagePathApi:"message/",dev:false,sourceData:"api",scripts:["easyXDM.min.js","knockout-3.2.0.js","jquery.cookie.js","jquery.textchange.min.js","widgets/Config-1.1.js","widgets/Routing-1.0.js","widgets/Paging-1.0.js","widgets/Widget-1.1.js"],inputParameters:{}};var EventDispatcher={events:[],AddEventListener:function(a,b){this.events[a]=this.events[a]||[];if(this.events[a]){this.RemoveEventListener(a,b);this.events[a].push(b)}},RemoveEventListener:function(d,e){if(this.events[d]){var c=this.events[d];var a=EventDispatcher.HashCode(e.toString());for(var b=c.length-1;b>=0;--b){if(EventDispatcher.HashCode(c[b].toString())===a){c.splice(b,1);return true}}}return false},DispatchEvent:function(c,d){if(this.events[c]){var b=this.events[c],a=b.length;while(a--){b[a](d)}}},HashCode:function(d){var c=0,a,b;if(d.length==0){return c}for(a=0;a<d.length;a++){b=d.charCodeAt(a);c=((c<<5)-c)+b;c=c&c}return c},GetUUID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)});return a}};var JSLoader={loaded:false,loadedCount:0,pathToJs:null,Init:function(a,b){this.pathToJs=b;JSLoader.Load(a,function(){JSLoader.RegisterLoaded(a)})},RegisterLoaded:function(a){JSLoader.loadedCount=JSLoader.loadedCount+1;if(JSLoader.loadedCount==a.length){JSLoader.OnReady()}},OnReady:function(){if(typeof ko=="object"){JSLoader.loaded=true;EventDispatcher.DispatchEvent("onload.scripts")}else{setTimeout(function(){JSLoader.OnReady()},100)}},Load:function(a,c){for(var b in a){$.getScript(this.pathToJs+a[b],function(){if(c){c()}})}}};var JSCore={version:1.2,isReady:false,shopId:null,dev:false,Init:function(){if(document.location.protocol=="https:"){JSSettings.protocolHTTP=JSSettings.protocolHTTPS}JSCore.SetInputParameters();JSLoader.Init(JSSettings.scripts,JSSettings.protocolHTTP+JSSettings.host+JSSettings.pathToJS);JSCore.shopId=JSSettings.shopId;XDMTransport.Init(JSSettings.host+JSSettings.pathToCore);JSCore.isReady=true},ParserInputParameters:function(f){var e={};var a=$("script").filter(function(){return f.test($(this).attr("src"))}).attr("src");if(a){var b=a.split("?");if(b.length>1){var d=b[1].split("&");for(var c=0;c<=d.length-1;c++){var g=d[c].split("=");e[g[0]]=g[1]}}}if(e){return e}return null},SetInputParameters:function(){var a=JSCore.ParserInputParameters(/JSCore/);if($.isEmptyObject(a)){a=JSCore.ParserInputParameters(/pokupo.widgets.[a-z0-9]{32}.min.js/)}if(a){for(var b in a){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=a[b]}}}if(typeof WParameters!=="undefined"&&WParameters.core){for(var b in WParameters.core){if(JSSettings.hasOwnProperty(b)){JSSettings[b]=WParameters.core[b]}}}JSSettings.inputParameters.shopId=JSSettings.shopId}};var XDMTransport={remote:"",event:{},Init:function(a){XDMTransport.remote=a},GetProtocol:function(a){if(a){return JSSettings.protocolHTTPS}else{return JSSettings.protocolHTTP}},EventExecute:function(b,a){$.each(XDMTransport.event[a],function(c){XDMTransport.event[a][c](b)});delete XDMTransport.event[a]},Load:{FromProxy:function(b){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Socket({remote:XDMTransport.GetProtocol(b.protocol)+XDMTransport.remote,onMessage:function(c){if(b.callback){b.callback(c)}}});a.postMessage(JSSettings.pathToData+b.url)}else{setTimeout(function(){XDMTransport.Load.FromProxy(b)},1000)}},FromApi:function(a){$.ajax({type:"GET",async:true,url:decodeURIComponent(a.url),dataType:a.type,success:function(b){if(a.callback){a.callback(b)}}})},Tmpl:function(b,c){var a=XDMTransport.GetProtocol()+JSSettings.pathToTmpl+JSSettings.theme+"/tmpl/"+b;if(/^(https?|ftp)\:\/\/(www\.)?([a-zA-Z0-9\.\-]+\.[a-z]{2,})(\/.+)$/.test(b)){a=b}XDMTransport.Load.FromProxy({url:a,callback:c,protocol:null})},Data:function(a,d,c){c=JSSettings.protocolHTTPS;var b=EventDispatcher.HashCode(a+d.toString());if(XDMTransport.event[b]==undefined){XDMTransport.event[b]=[]}XDMTransport.event[b].push(d);if(XDMTransport.event[b].length==1){if(JSSettings.sourceData=="api"){XDMTransport.Load.FromApi({type:"jsonp",url:decodeURIComponent(a),callback:function(e){XDMTransport.EventExecute(e,b)}})}if(JSSettings.sourceData=="proxy"){XDMTransport.Load.FromProxy({url:a,protocol:c,callback:function(e){XDMTransport.EventExecute(JSON.parse(e),b)}})}}},DataPost:function(b,c){if(typeof easyXDM!=="undefined"){var a=new easyXDM.Rpc({remote:XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostCore,onReady:function(){b.attr("action",XDMTransport.GetProtocol(c)+JSSettings.host+JSSettings.pathToPostData);b.submit()}},{local:{returnUploadResponse:function(d){EventDispatcher.DispatchEvent(EventDispatcher.HashCode(b.toString()),JSON.parse(d.msg))}}})}else{setTimeout(function(){XDMTransport.Load.DataPost(b,c)},1000)}}}};var Logger={Console:{Exception:function(b,d,c){console&&console.log("Exception : "+new Date()+" : "+b+" : "+d);if(c){var a="";if(c.message){a+=c.message}if(c.stack){a+=" | stack: "+c.stack}console&&console.log(a)}},Info:function(a,b){console&&console.log("Info : "+new Date()+" : "+a+" : "+b)},VarDump:function(b,a,c){console&&console.log("Var Dump : "+b+" : "+a);console&&console.log(c)}}};$().ready(function(){JSCore.Init()});
var ShopInfoWidget=function(){var a=this;a.widgetName="ShopInfoWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,tmpl:{path:null,id:null},show:{logo:null,title:true},animate:null,inputParameters:{},customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.shopInfo.widget;a.settings.customContainer=Config.Containers.shopInfo.customClass;a.settings.tmpl=Config.ShopInfo.tmpl;a.settings.show=Config.ShopInfo.show;a.SetInputParameters();a.RegisterEvents();a.Fill()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/ShopInfoWidget/);if(b.search){c=b.search}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.shopInfo){c=WParameters.shopInfo}if(!$.isEmptyObject(c)){if(c.show){if(c.show.hasOwnProperty("logo")){a.settings.show.logo=c.show.logo}if(c.show.hasOwnProperty("title")){a.settings.show.title=c.show.title}}if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){a.settings.tmpl.id=c.tmpl.id}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(b){a.Fill()})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.Fill=function(){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.ShopInfo(function(b){a.InsertContainer.Content();var c=new ShopInfoViewModel(b,a.settings);a.Render(c)})})};a.Render=function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateShopInfo=="function"){new AnimateShopInfo()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}};var ShopInfoViewModel=function(c,b){var a=this;a.logo=Config.ShopInfo.defaultLogo;if(c.id_logo_shop){a.logo=c.id_logo_shop}a.name=c.name_shop;a.link=c.site_shop;a.showLogo=b.show.logo;a.showTitle=b.show.title};var TestShopInfo={Init:function(){if(typeof Widget=="function"){ShopInfoWidget.prototype=new Widget();var a=new ShopInfoWidget();a.Init(a)}else{setTimeout(function(){TestShopInfo.Init()},100)}}};TestShopInfo.Init();
var AuthenticationWidget=function(){var a=this;a.widgetName="AuthenticationWidget";a.version=1.1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerFormId:null,tmpl:{path:null,id:null},inputParameters:{},animate:null,https:null,style:null,customContainer:null};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.authentication.widget;a.settings.customContainer=Config.Containers.authentication.customClass;a.settings.tmpl=Config.Authentication.tmpl;a.settings.https=Config.Authentication.https;a.settings.style=Config.Authentication.style;a.SetInputParameters();a.RegisterEvents();a.CheckAuthenticationRoute();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/AuthenticationWidget/);if(b.authentication){c=b.authentication}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.authentication){c=WParameters.authentication}if(!$.isEmptyObject(c)){if(c.https){a.settings.https=c.https;Parameters.cache.https=c.https}if(c.container&&c.container.widget){a.settings.containerFormId=c.container.widget}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckAuthenticationRoute=function(){if(Routing.route=="login"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.SelectTypeContent()})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckAuthenticationRoute()});EventDispatcher.AddEventListener("AuthenticationWidget.authentication.submit",function(b){a.BaseLoad.Login(b.username,b.password,b.rememberMe,function(c){EventDispatcher.DispatchEvent("widget.authentication.test",{data:b,request:c})})});EventDispatcher.AddEventListener("widget.authentication.test",function(b){if(b.request.err){b.data.error="Ошибка в логине или пароле";a.Render.Authentication(b.data)}else{EventDispatcher.DispatchEvent("widget.authentication.ok",b)}});EventDispatcher.AddEventListener("widget.authentication.ok",function(){if(Routing.route!="registration"){var b=Parameters.cache.lastPage;if(b.route=="login"||!b.route){Routing.SetHash("default","Домашняя",{})}else{Routing.SetHash(b.route,b.title,b.data)}}});EventDispatcher.AddEventListener("widget.authentication.close",function(){a.InsertContainer.EmptyWidget()})};a.SelectTypeContent=function(){if(Routing.route=="login"){a.InsertContainer.Authentication();a.Fill.Authentication()}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},Authentication:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.Fill={Authentication:function(){a.BaseLoad.Script("widgets/AuthenticationViewModel-1.1.js",function(){AuthenticationViewModel.prototype.ClickRegistration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-2];Routing.SetHash("registration","Регистрация пользователя",{step:1})};var b=new AuthenticationViewModel();b.subminEvent("AuthenticationWidget.authentication.submit");a.Render.Authentication(b)})}};a.Render={Authentication:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateAuthentication=="function"){new AnimateAuthentication()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Authentication();a.Render.Authentication(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerFormId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=Config.Containers.authentication.length-1;c++){$("#"+Config.Containers.authentication[c]).css(a.settings.style)}})}}};var TestAuthentication={Init:function(){if(typeof Widget=="function"){AuthenticationWidget.prototype=new Widget();var a=new AuthenticationWidget();a.Init(a)}else{setTimeout(function(){TestAuthentication.Init()},100)}}};TestAuthentication.Init();
var RegistrationWidget=function(){var a=this;a.widgetName="RegistrationWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerFormId:null,tmpl:{path:null,id:{step1:null,step2:null,step3:null,step4:null}},animate:null,inputParameters:{},geoShop:0,style:null,customContainer:null};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.registration.widget;a.settings.customContainer=Config.Containers.registration.customClass;a.settings.tmpl=Config.Registration.tmpl;a.settings.style=Config.Registration.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteRegistration();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/RegistrationWidget/);if(b.registration){c=b.registration}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.registration){c=WParameters.registration}if(!$.isEmptyObject(c)){if(c.geoShop){a.settings.geoShop=c.geoShop}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteRegistration=function(){if(Routing.route=="registration"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.Script("widgets/RegistrationViewModel-1.0.js",function(){if(Routing.params.step==1){a.Step.Step1()}if(Routing.params.step==2){a.Step.Step2()}if(Routing.params.step==3){a.Step.Step3()}if(Routing.params.step==4){a.Step.Step4()}})})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteRegistration()});EventDispatcher.AddEventListener("RegistrationWidget.step1.checking",function(b){a.WidgetLoader(false);var d=[];if(b.username()){d.push("username="+encodeURIComponent(b.username()))}if(b.phone()){d.push("phone="+b.phone().replace(/\s/g,""))}if(b.email()){d.push("email="+b.email())}if(d.length>0){var c="?"+d.join("&")}a.BaseLoad.UniqueUser(c,function(e){var h=true;if(a.QueryError(e,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step1.checking",b)})){if(!a.Validate.Username(e,b)){h=false}if(!a.Validate.Email(e,b)){h=false}if(!a.Validate.Phone(e,b)){h=false}}else{h=false}if(h){var g=[];if(b.username()){g.push("username="+encodeURIComponent(b.username()))}if(b.phone()){g.push("phone="+b.phone().replace(/\s/g,""))}if(b.email()){g.push("email="+$.trim(b.email()))}if(b.firstPassword()){g.push("password="+encodeURIComponent(b.firstPassword()))}if(g.length>0){var f="?"+g.join("&")}a.BaseLoad.Registration(f,function(i){a.BaseLoad.LoginForProxy(b.username(),b.firstPassword(),"no",function(j){Parameters.cache.reg.step1=b;Routing.SetHash("registration","Регистрация пользователя",{step:2})})})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("RegistrationWidget.step1.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:1})});EventDispatcher.AddEventListener("RegistrationWidget.step2.checking",function(b){a.WidgetLoader(false);var d=[];d.push("username="+encodeURIComponent(b.username));if(!b.mailConfirmLater()){d.push("mail_token="+b.mailToken())}if(!b.phoneConfirmLater()){d.push("sms_token="+b.phoneToken())}var c="?"+d.join("&");a.BaseLoad.ActivateUser(c,function(e){var f=true;if(a.QueryError(e,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",b)})){if(!a.Validate.MailToken(e,b)){f=false}if(!a.Validate.PhoneToken(e,b)){f=false}}else{f=false}if(f){Parameters.cache.reg.step2=b;a.BaseLoad.Login(false,false,false,function(g){EventDispatcher.DispatchEvent("widget.authentication.ok",{request:g});if(!g.err){Routing.SetHash("registration","Регистрация пользователя",{step:3})}})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("RegistrationWidget.step2.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:2})});EventDispatcher.AddEventListener("RegistrationWidget.step3.later",function(){Routing.SetHash("registration","Регистрация пользователя",{step:4})});EventDispatcher.AddEventListener("RegistrationWidget.step3.checking",function(b){a.WidgetLoader(false);var d=b.birthDay().split(".");var c=d[2]+"-"+d[1]+"-"+d[0];b.birthDayHiddenField(c);a.BaseLoad.EditProfile($("form#"+b.cssRegistrationDataForm),function(e){var f=true;if(!a.QueryError(e,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.checking",b)})){f=false}if(f){Parameters.cache.reg.step3=b;Routing.SetHash("registration","Регистрация пользователя",{step:4})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("RegistrationWidget.step3.view",function(){Routing.SetHash("registration","Регистрация пользователя",{step:3})});EventDispatcher.AddEventListener("RegistrationWidget.step4.later",function(b){a.ShowMessage(Config.Registration.message.registrationSuccessful,function(){Parameters.cache.reg={step1:{},step2:{},step3:{},step4:{}};var c=Parameters.cache.lastPage;if(!$.isEmptyObject(c)){Routing.SetHash(c.route,c.title,c.data,true)}else{Routing.SetHash("default","Домашняя",{})}})});EventDispatcher.AddEventListener("RegistrationWidget.step4.checking",function(c){a.WidgetLoader(false);var b="?id_country="+encodeURIComponent($.trim(c.idCountry()));if(c.region()&&c.region().regioncode){b=b+"&code_region="+encodeURIComponent($.trim(c.region().regioncode))}else{b=b+"&name_region="+encodeURIComponent($.trim(c.customRegion()))}if(c.city()&&c.city().aoguid){b=b+"&code_city="+encodeURIComponent($.trim(c.city().aoguid))}else{b=b+"&name_city="+encodeURIComponent($.trim(c.customCity()))}b=b+"&address="+encodeURIComponent($.trim(c.customAddress()))+"&post_code="+encodeURIComponent($.trim(c.postIndex()));a.BaseLoad.EditAddress(b,function(d){var e=true;if(!a.QueryError(d,function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",c)})){e=false}if(e){Parameters.cache.reg.step4=c;EventDispatcher.DispatchEvent("RegistrationWidget.step4.later")}else{a.WidgetLoader(true,a.settings.containerFormId)}})})};a.Validate={Username:function(c,b){var d=false;if(c.check_username){if(c.check_username=="on"||c.check_username=="ban"||c.check_username=="off"){b.errorUsername(Config.Registration.error.username.uniq)}if(c.check_username=="yes"){d=true}}return d},Phone:function(c,b){var d=false;if(c.check_phone){if(c.check_phone=="on"||c.check_phone=="ban"||c.check_phone=="off"){b.errorPhone(Config.Registration.error.phone.uniq)}if(c.check_phone=="yes"){d=true}}else{d=true}return d},Email:function(c,b){var d=false;if(c.check_email){if(c.check_email=="on"||c.check_email=="ban"||c.check_email=="off"){b.errorEmail(Config.Registration.error.email.uniq)}if(c.check_email=="yes"){d=true}}return d},MailToken:function(c,b){if(c.confirm_email){if(c.confirm_email=="no"){b.errorEmailConfirm(Config.Registration.error.emailToken.confirm);return false}}return true},PhoneToken:function(c,b){if(c.confirm_phone){if(c.confirm_phone=="no"){b.errorPhoneConfirm(Config.Registration.error.phoneToken.confirm);return false}}return true},Profile:function(c,b){if(c.err){b.errorAddress(c.err);return false}return true},Address:function(b,c){if(b.err){c.errorAddress(b.err);return false}return true}};a.Step={Step1:function(){a.InsertContainer.Step1();a.Fill.Step1()},Step2:function(){a.InsertContainer.Step2();a.Fill.Step2()},Step3:function(){a.InsertContainer.Step3();a.Fill.Step3()},Step4:function(){a.InsertContainer.Step4();a.Fill.Step4()}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},Step1:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step1")).html()).children().hide()},Step2:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step2")).html()).children().hide()},Step3:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step3")).html()).children().hide()},Step4:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step4")).html()).children().hide()}};a.Fill={Step1:function(){var b=Parameters.cache.reg.step1;if($.isEmptyObject(b)){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var c=Parameters.cache.history.pop();if(c){Routing.SetHash(c.route,c.title,c.data,true)}else{Routing.SetHash("default","Домашняя",{})}};b=new RegistrationFormViewModel();b.submitEvent("RegistrationWidget.step1.checking")}a.Render.Step1(b)},Step2:function(){if(Routing.params.username&&Routing.params.mail_token){RegistrationFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var d=Parameters.cache.history.pop();if(d){Routing.SetHash(d.route,d.title,d.data,true)}else{Routing.SetHash("default","Домашняя",{})}};var b=new RegistrationFormViewModel();b.username(Routing.params.username);b.submitEvent("RegistrationWidget.step1.checking");Parameters.cache.reg.step1=b}RegistrationConfirmFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step1.view")};var c=new RegistrationConfirmFormViewModel(Parameters.cache.reg.step1);c.submitEvent("RegistrationWidget.step2.checking");if(Routing.params.username&&Routing.params.mail_token){c.mailToken(Routing.params.mail_token);EventDispatcher.DispatchEvent("RegistrationWidget.step2.checking",c)}a.Render.Step2(c)},Step3:function(){var b=Parameters.cache.reg.step3;if($.isEmptyObject(b)){RegistrationProfileFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step2.view")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.later")};b=new RegistrationProfileFormViewModel();b.submitEvent("RegistrationWidget.step3.checking")}a.Render.Step3(b)},Step4:function(){var b=Parameters.shopId;if(a.settings.geoShop==0){b=0}a.BaseLoad.Country(b,function(d){var c=new RegistrationFormStep4ViewModel();c.AddCountryList(d);a.Render.Step4(c)})}};a.Render={Step1:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistration=="function"){new AnimateRegistration()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step1")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step1();a.Render.Step1(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step2:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistration=="function"){new AnimateRegistration()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step2")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step2();a.Render.Step2(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step3:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistration=="function"){new AnimateRegistration()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step3")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step3();a.Render.Step3(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step4:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);$("#"+b.cssCountryList).change(function(){b.customRegion(null);b.region(null);b.customCity(null);b.city(null);b.customAddress(null);b.address(null);b.postIndex(null)});$("#"+b.cssRegionList).autocomplete({source:function(e,d){a.BaseLoad.Region(b.idCountry()+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.formalname+" "+g.shortname),region:g}}))}else{$("#"+b.cssRegionList).autocomplete("close");return false}})},select:function(d,e){b.region(e.item.region);b.customRegion(e.item.value);if(e.item.region&&e.item.region.postalcode!=0){b.postIndex(e.item.region.postalcode)}else{b.postIndex(null)}}});$("#"+b.cssCityList).autocomplete({source:function(e,d){if(b.region()){a.BaseLoad.City(b.idCountry()+"/"+encodeURIComponent(b.region().regioncode)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),city:g}}))}else{$("#"+b.cssCityList).autocomplete("close");return false}})}},select:function(d,e){b.city(e.item.city);b.customCity(e.item.value);if(e.item.city&&e.item.city.postalcode!=0){b.postIndex(e.item.city.postalcode)}else{b.postIndex(null)}}});$("#"+b.cssAddress).autocomplete({source:function(e,d){if(b.region()){a.BaseLoad.Street(b.idCountry()+"/"+encodeURIComponent(b.region().regioncode)+"/"+encodeURIComponent(b.city().aoguid)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),street:g}}))}else{$("#"+b.cssAddress).autocomplete("close");return false}})}},select:function(d,e){b.address(e.item.street);b.customAddress(e.item.value);if(e.item.street&&e.item.street.postalcode!=0){b.postIndex(e.item.street.postalcode)}else{b.postIndex(null)}}});$("#"+b.cssRegionList).bind("textchange",function(e,d){b.customRegion($(this).val());b.customCity(null);b.city(null);b.customAddress(null);b.address(null);b.postIndex(null)});$("#"+b.cssCityList).bind("textchange",function(e,d){b.customCity($(this).val());b.customAddress(null);b.address(null);b.postIndex(null)});a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistration=="function"){new AnimateRegistration()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step4")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step4();a.Render.Step4(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=Config.Containers.registration.length-1;c++){$("#"+Config.Containers.registration[c]).css(a.settings.style)}})}}};var RegistrationFormStep4ViewModel=function(){var a=this;a.idCountry=ko.observable();a.cssCountryList="country_list";a.errorCountry=ko.observable(null);a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="region_list";a.errorRegion=ko.observable(null);a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="city_list";a.errorCity=ko.observable(null);a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="address";a.errorAddress=ko.observable(null);a.postIndex=ko.observable();a.cssPostIndex="post_index";a.errorPostIndex=ko.observable(null);a.countryList=ko.observableArray();a.AddCountryList=function(c){if(c.length>0){for(var b=0;b<=c.length-1;b++){a.countryList.push(new CountryListViewModel(c[b]))}}};a.SpecifyLater=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step4.later",a)};a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RegistrationWidget.step4.checking",a)}};a.Back=function(){EventDispatcher.DispatchEvent("RegistrationWidget.step3.view")};a.ValidationForm=function(){var b=true;if(!a.CountryValidation()){b=false}if(!a.RegionValidation()){b=false}if(!a.CityValidation()){b=false}if(!a.AddressValidation()){b=false}if(!a.PostIndexValidation()){b=false}return b};a.CountryValidation=function(){if(!a.idCountry()){a.errorCountry(Config.Registration.error.country.empty);return false}a.errorCountry(null);return true};a.RegionValidation=function(){if(!a.customRegion()){a.errorRegion(Config.Registration.error.region.empty);return false}a.errorRegion(null);return true};a.CityValidation=function(){if(!a.customCity()){a.errorCity(Config.Registration.error.city.empty);return false}a.errorCity(null);return true};a.AddressValidation=function(){if(!a.customAddress()){a.errorAddress(Config.Registration.error.address.empty);return false}a.errorAddress(null);return true};a.PostIndexValidation=function(){if(!a.postIndex()){a.errorPostIndex(Config.Registration.error.postIndex.empty);return false}a.errorPostIndex(null);return true}};var TestRegistration={Init:function(){if(typeof Widget=="function"){RegistrationWidget.prototype=new Widget();var a=new RegistrationWidget();a.Init(a)}else{setTimeout(function(){TestRegistration.Init()},100)}}};TestRegistration.Init();
var RegistrationSellerWidget=function(){var a=this;a.widgetName="RegistrationSellerWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerFormId:null,tmpl:{path:null,id:{step1:null,step2:null,step3:null,step4:null}},animate:null,inputParameters:{},style:null,customContainer:null};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.registrationSeller.widget;a.settings.customContainer=Config.Containers.registrationSeller.customClass;a.settings.tmpl=Config.RegistrationSeller.tmpl;a.settings.style=Config.RegistrationSeller.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteRegistrationSeller();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/RegistrationSellerWidget/);if(b.registrationSeller){c=b.registrationSeller}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.registrationSeller){c=WParameters.registrationSeller}if(!$.isEmptyObject(c)){if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteRegistrationSeller=function(){if(Routing.route=="registration_seller"){if(!Routing.params.step){Routing.params.step=1}a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(Routing.params.step==1){a.Step.Step1()}if(Routing.params.step==2){a.Step.Step2()}if(Routing.params.step==3){a.Step.Step3()}if(Routing.params.step==4){a.Step.Step4()}})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteRegistrationSeller()});EventDispatcher.AddEventListener("RegistrationSellerWidget.step1.register",function(b){a.WidgetLoader(false);var d=[];if(b.nameSeller()){d.push("name_seller="+encodeURIComponent(b.nameSeller()))}if(b.phone()){d.push("phone_seller="+b.phone().replace(/\s/g,""))}if(b.email()){d.push("email_seller="+$.trim(b.email()))}if(d.length>0){var c="?"+d.join("&")}a.BaseLoad.RegistrationSeller(c,function(e){if(a.QueryError(e,function(){EventDispatcher.DispatchEvent("RegistrationSellerWidget.step1.register",b)})){Parameters.cache.regSeller.step1=b;Routing.SetHash("registration_seller","Регистрация продавца",{step:2})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("RegistrationSellerWidget.step2.checking",function(b){Parameters.cache.regSeller.step2=b;Routing.SetHash("registration_seller","Регистрация продавца",{step:3})});EventDispatcher.AddEventListener("RegistrationSellerWidget.step3.checking",function(b){a.WidgetLoader(false);var d=Parameters.cache.regSeller.step1;var c=Parameters.cache.regSeller.step2;Parameters.cache.regSeller.step3=b;var f=[];if(d.nameSeller()){f.push("name_seller="+encodeURIComponent(d.nameSeller()))}f.push("mail_token="+encodeURIComponent(c.mailToken()?c.mailToken():1));f.push("sms_token="+encodeURIComponent(c.phoneToken()?c.phoneToken():1));if(b.typeSeller()){f.push("type_seller="+b.typeSeller())}if(b.invite()){f.push("invite="+encodeURIComponent(b.invite()))}if(b.site()){f.push("site="+encodeURIComponent(b.site()))}var e="?"+f.join("&");a.BaseLoad.ActivateSeller(e,function(g){if(a.QueryError(g,function(){EventDispatcher.DispatchEvent("RegistrationSellerWidget.step3.checking",b)})){Routing.SetHash("registration_seller","Регистрация продавца",{step:4})}else{a.WidgetLoader(true,a.settings.containerFormId)}})})};a.Step={Step1:function(){a.InsertContainer.Step1();a.Fill.Step1()},Step2:function(){a.InsertContainer.Step2();a.Fill.Step2()},Step3:function(){a.InsertContainer.Step3();a.Fill.Step3()},Step4:function(){a.InsertContainer.Step4();a.Fill.Step4()}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},Step1:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step1")).html()).children().hide()},Step2:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step2")).html()).children().hide()},Step3:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step3")).html()).children().hide()},Step4:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step4")).html()).children().hide()}};a.Fill={Step1:function(){var b=Parameters.cache.regSeller.step1;if($.isEmptyObject(b)){RegistrationSellerFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var c=Parameters.cache.history.pop();if(c){Routing.SetHash(c.route,c.title,c.data,true)}else{Routing.SetHash("default","Домашняя",{})}};b=new RegistrationSellerFormViewModel()}a.Render.Step1(b)},Step2:function(){if(Routing.params.username&&Routing.params.mail_token){RegistrationSellerFormViewModel.prototype.Back=function(){Parameters.cache.history.pop();var d=Parameters.cache.history.pop();if(d){Routing.SetHash(d.route,d.title,d.data,true)}else{Routing.SetHash("default","Домашняя",{})}};var b=new RegistrationSellerFormViewModel();b.nameSeller(Routing.params.username);Parameters.cache.regSeller.step1=b}if(!Parameters.cache.regSeller.step1.nameSeller){Routing.SetHash("registration_seller","Регистрация продавца",{});return true}var c=new RegistrationSellerConfirmFormViewModel(Parameters.cache.regSeller.step1);if(Routing.params.username&&Routing.params.mail_token){c.mailToken(Routing.params.mail_token);EventDispatcher.DispatchEvent("RegistrationSellerWidget.step2.checking",c);return true}a.Render.Step2(c)},Step3:function(){var b=Parameters.cache.regSeller.step3;if($.isEmptyObject(b)){b=new RegistrationSellerFinishFormViewModel()}if(!Parameters.cache.regSeller.step1.nameSeller){Routing.SetHash("registration_seller","Регистрация продавца",{});return true}a.Render.Step3(b)},Step4:function(){if(!Parameters.cache.regSeller.step1.nameSeller){Routing.SetHash("registration_seller","Регистрация продавца",{});return true}Parameters.cache.regSeller={step1:{},step2:{},step3:{}};a.Render.Step4()}};a.Render={Step1:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistrationSeller=="function"){new AnimateRegistrationSeller()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step1")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step1();a.Render.Step1(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step2:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistrationSeller=="function"){new AnimateRegistrationSeller()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step2")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step2();a.Render.Step2(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step3:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistrationSeller=="function"){new AnimateRegistrationSeller()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step3")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step3();a.Render.Step3(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step4:function(){a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateRegistrationSeller=="function"){new AnimateRegistrationSeller()}if(a.settings.animate){a.settings.animate()}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=Config.Containers.registration.length-1;c++){$("#"+Config.Containers.registration[c]).css(a.settings.style)}})}}};var RegistrationSellerFormViewModel=function(){var a=this;a.nameSeller=ko.observable(null);a.errorNameSeller=ko.observable(null);a.email=ko.observable(null);a.errorEmail=ko.observable(null);a.cssPhone="phone";a.phone=ko.observable(null);a.errorPhone=ko.observable(null);a.isChecked=ko.observable(false);a.errorIsChecked=ko.observable(null);a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RegistrationSellerWidget.step1.register",a)}};a.ValidationForm=function(){var b=true;if(!a.NameValidation()){b=false}if(!a.EmailValidation()){b=false}if(!a.PhoneValidation()){b=false}if(!a.IsCheckedValidation()){b=false}return b};a.NameValidation=function(){if(!a.nameSeller()){a.errorNameSeller(Config.RegistrationSeller.error.nameSeller.empty);return false}if(a.nameSeller().length<3){a.errorNameSeller(Config.RegistrationSeller.error.nameSeller.minLength);return false}if(a.nameSeller().length>40){a.errorNameSeller(Config.RegistrationSeller.error.nameSeller.maxLength);return false}if(!Config.RegistrationSeller.regular.nameSeller.test(a.nameSeller())){a.errorNameSeller(Config.RegistrationSeller.error.nameSeller.regular);return false}a.errorNameSeller(null);return true};a.EmailValidation=function(){if(!a.email()){a.errorEmail(Config.Registration.error.email.empty);return false}if(a.email().length>64){a.errorEmail(Config.Registration.error.email.maxLength);return false}if(!Config.Registration.regular.email.test(a.email())){a.errorEmail(Config.Registration.error.email.regular);return false}a.errorEmail(null);return true};a.PhoneValidation=function(){if(a.phone()){if(!Config.Registration.regular.phone.test($.trim(a.phone()))){a.errorPhone(Config.Registration.error.phone.regular);return false}}a.errorPhone(null);return true};a.IsCheckedValidation=function(){if(!a.isChecked()){a.errorIsChecked(Config.Registration.error.isChecked.empty);return false}a.errorIsChecked(null);return true};a.RestoreAccess=function(){};a.agreement="http://"+window.location.hostname+"/rules";a.police="http://"+window.location.hostname+"/police";a.refund="http://"+window.location.hostname+"/refund"};var RegistrationSellerConfirmFormViewModel=function(b){var a=this;a.nameSeller=b.nameSeller();a.cssMailToken="mail_token_block";a.mailToken=ko.observable();a.mailIsConfirm=ko.observable(false);a.errorEmailConfirm=ko.observable(null);a.mailConfirmLater=ko.observable(false);a.cssPhoneToken="phone_token_block";a.phoneToken=ko.observable();a.phoneIsConfirm=ko.observable(false);a.errorPhoneConfirm=ko.observable(null);a.phoneConfirmLater=ko.observable(false);a.errorConfirmLater=ko.observable(null);a.isEmptyPhone=ko.computed(function(){if(!$.isEmptyObject(b)&&b.phone()){return false}a.phoneConfirmLater(true);return true},this);a.submitEvent=ko.observable();a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RegistrationSellerWidget.step2.checking",a)}};a.ValidationForm=function(){var c=true;if(!a.EmailTokenValidation()){c=false}if(!a.PhoneTokenValidation()){c=false}if(!a.EmptyConfirm()){c=false}return c};a.EmailTokenValidation=function(){if(!a.mailConfirmLater()){if(!a.mailToken()){a.errorEmailConfirm(Config.Registration.error.emailToken.empty);return false}}a.errorEmailConfirm(null);return true};a.PhoneTokenValidation=function(){if(!a.phoneConfirmLater()){if(!a.phoneToken()){a.errorPhoneConfirm(Config.Registration.error.phoneToken.empty);return false}}a.errorPhoneConfirm(null);return true};a.EmptyConfirm=function(){if(a.phoneConfirmLater()&&a.mailConfirmLater()){a.errorConfirmLater(Config.Registration.error.confirmLater.empty);a.errorEmailConfirm(null);a.errorPhoneConfirm(null);return false}else{a.errorConfirmLater(null)}return true};a.Back=function(){Parameters.cache.regSeller.step3=a;Routing.SetHash("registration_seller","Регистрация пользователя",{step:1})}};var RegistrationSellerFinishFormViewModel=function(){var a=this;a.typeSeller=ko.observable();a.errorTypeSeller=ko.observable();a.invite=ko.observable();a.errorInvite=ko.observable();a.site=ko.observable("http://");a.errorSite=ko.observable();a.confirmLater=ko.observable(false);a.confirmLater.subscribe(function(b){if(!b){a.invite("");a.site("http://")}});a.errorConfirmLater=ko.observable(null);a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("RegistrationSellerWidget.step3.checking",a)}};a.ValidationForm=function(){var b=true;if(!a.TypeSellerValidation()){b=false}if(!a.InviteValidation()){b=false}if(!a.SiteValidation()){b=false}return b};a.Back=function(){Routing.SetHash("registration_seller","Регистрация пользователя",{step:2})};a.TypeSellerValidation=function(){if(!a.typeSeller()){a.errorTypeSeller(Config.RegistrationSeller.error.typeSeller.empty);return false}a.errorTypeSeller(null);return true};a.InviteValidation=function(){if(a.invite()){if(a.invite().length<5){a.errorInvite(Config.RegistrationSeller.error.invite.minLength);return false}if(a.invite().length>40){a.errorInvite(Config.RegistrationSeller.error.invite.maxLength);return false}}a.errorInvite(null);return true};a.SiteValidation=function(){if(a.site()){if(a.site()=="http://"){a.site("")}}a.errorSite(null);return true}};var TestRegistrationSeller={Init:function(){if(typeof Widget=="function"){RegistrationSellerWidget.prototype=new Widget();var a=new RegistrationSellerWidget();a.Init(a)}else{setTimeout(function(){TestRegistrationSeller.Init()},100)}}};TestRegistrationSeller.Init();
var CatalogWidget=function(){var a=this;a.widgetName="CatalogWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,tmpl:{path:null,id:null},animate:null,inputParameters:{},styleCatalog:null,customContainer:null,catalogContainerId:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.content.content.widget;a.settings.catalogContainerId=Config.Containers.catalog.widget;a.settings.customContainer=Config.Containers.catalog.customClass;a.settings.tmpl=Config.Catalog.tmpl;a.settings.styleCatalog=Config.Catalog.style;a.RegisterEvents();a.SetInputParameters();a.CheckRouteCatalog();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/CatalogWidget/);if(b.catalog){c=b.catalog}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.catalog){c=WParameters.catalog}if(!$.isEmptyObject(c)){if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteCatalog=function(){if(Routing.route=="catalog"||(Routing.IsDefault()&&!a.HasDefaultContent())){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.Roots(function(){a.Update()})})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("catalogWidget.fill.section",function(b){a.Render.Tree(b)});EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteCatalog()})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.catalogContainerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.catalogContainerId).empty().html(b)},Main:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.catalogContainerId).append($("script#"+a.GetTmplName()).html()).children().hide()}},a.Update=function(){if(Routing.IsSection()&&!Parameters.cache.catalogs[Routing.GetActiveCategory()]){a.InsertContainer.Main();a.BaseLoad.Section(Routing.GetActiveCategory(),function(b){a.BaseLoad.Path(Routing.GetActiveCategory(),function(d){if(d[d.length-1]){var c=[];c[0]={id:d[d.length-1].id,name_category:d[d.length-1].name_category,type_category:"section",back:"return",children:Parameters.cache.childrenCategory[Routing.GetActiveCategory()]};a.Fill.Tree(c)}else{a.Fill.Tree(b)}})})}else{if(Routing.IsSection()||Parameters.cache.catalogs[Routing.GetActiveCategory()]){a.InsertContainer.Main();a.BaseLoad.Roots(function(b){a.Fill.Tree(b)})}else{a.WidgetLoader(true)}}};a.Fill={Tree:function(d){var b=new CatalogViewModel();for(var c=0;c<=d.length-1;c++){b.AddItem(d[c])}EventDispatcher.DispatchEvent("catalogWidget.fill.section",b)}};a.Render={Tree:function(b){if($("#"+a.settings.catalogContainerId).length>0){try{ko.cleanNode($("#"+a.settings.catalogContainerId)[0]);ko.applyBindings(b,$("#"+a.settings.catalogContainerId)[0]);a.WidgetLoader(true,a.settings.catalogContainerId);if(typeof AnimateCatalog=="function"){new AnimateCatalog()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Main();a.Render.Tree(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.catalogContainerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.catalogContainerId+"]");a.WidgetLoader(true,a.settings.catalogContainerId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleCatalog[b]){a.settings.styleCatalog[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.catalogContainerId).css(a.settings.styleCatalog)})}}};var CatalogViewModel=function(){var a=this;a.tab=ko.observableArray();a.AddItem=function(f){var g=new SectionViewModel(f,a.tab());if(f.children){for(var e=0;e<=f.children.length-1;e++){var c=new ItemViewModel(f.children[e],f.id);if(f.children[e].children){for(var d=0;d<=f.children[e].children.length-1;d++){var b=new ItemViewModel(f.children[e].children[d],f.children[e].id);c.children.push(b)}}g.children.push(c)}}a.tab.push(g)}};var SectionViewModel=function(c,b){var a=this;a.id=c.id;a.title=ko.computed(function(){if(c.back){return"Вверх"}return c.name_category},this);a.type_category=c.type_category;a.listClass="catalogCategories_"+c.id;a.tabClass=ko.computed(function(){var d="listCategories_"+c.id;if(b.length==1){d=d+" single"}if(Routing.GetActiveCategory()==c.id){if(c.back){return d+" return active"}else{return d+" active"}}else{return d}},this);a.countGoods=c.count_goods;a.children=ko.observableArray();a.titleWithCount=ko.computed(function(){if(c.back){return"Вверх"}else{var d=c.name_category;if(c.count_goods&&c.count_goods>0){d=d+" <span>"+c.count_goods+"</span>"}return d}},this);a.isActive=ko.computed(function(){if(Routing.GetActiveCategory()==a.id){return true}return false},this);a.ClickTab=function(){if(Parameters.cache.catalogs[a.id]){var e=$(".listCategories_"+a.id)[0].tagName;$(e+"[class^=listCategories]").removeClass("active");$(".listCategories_"+a.id).addClass("active");var d=$(".catalogCategories_"+c.id)[0].tagName;$(d+"[class*=catalogCategories]").hide();$(".catalogCategories_"+c.id).show();params={section:c.id};Routing.SetHash("catalog",c.name_category,params)}else{var f=Parameters.cache.path[a.id].path;params={section:f[f.length-2].id};Routing.SetHash("catalog",f[f.length-2].name_category,params)}}};var ItemViewModel=function(c,b){var a=this;a.id=c.id;a.title=c.name_category;a.countGoods=c.count_goods;a.children=ko.observableArray();a.titleWithCount=ko.computed(function(){var d=c.name_category;if(c.count_goods&&c.count_goods>0){d=d+" <span>"+c.count_goods+"</span>"}return d},this);a.hasChildren=ko.computed(function(){if(a.children().length>0){return true}return false},this);a.liClass=ko.computed(function(){if(a.hasChildren()){return"menuparent"}return""},this);a.ClickItem=function(){var d;if(c.type_category=="category"){d={section:b,category:c.id}}else{d={section:c.id}}Routing.SetHash("catalog",a.title,d)}};var TestCatalog={Init:function(){if(typeof Widget=="function"){CatalogWidget.prototype=new Widget();var a=new CatalogWidget();a.Init(a)}else{setTimeout(function(){TestCatalog.Init()},100)}}};TestCatalog.Init();
var BreadCrumbWidget=function(){var a=this;a.widgetName="BreadCrumbWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,tmpl:{path:null,id:null},animate:null,inputParameters:{},styleBreadCrumb:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.breadCrumb.widget;a.settings.customContainer=Config.Containers.breadCrumb.customClass;a.settings.tmpl=Config.BreadCrumb.tmpl;a.settings.styleBreadCrumb=Config.BreadCrumb.style;a.RegisterEvents();a.SetInputParameters();a.CheckRouteBreadCrumb(Routing.GetActiveCategory());a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/BreadCrumbWidget/);if(b.breadCrumb){c=b.breadCrumb}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.breadCrumb){c=WParameters.breadCrumb}if(c.animate){a.settings.animate=c.animate}a.settings.inputParameters=c};a.InsertContainer={EmptyWidget:function(c){var b=$("#"+a.settings.containerId[c]).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId[c]).empty().html(b)},Main:function(){for(var b=0;b<=a.settings.containerId.length-1;b++){if($("#"+a.settings.containerId[b]).length>0){a.InsertContainer.EmptyWidget(b);$("#"+a.settings.containerId[b]).append($("script#"+a.GetTmplName()).html()).children().hide()}}}};a.CheckRouteBreadCrumb=function(b){if(Routing.IsDefault()&&a.HasDefaultContent()){a.WidgetLoader(true)}else{a.WidgetLoader(false);a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(b){a.BaseLoad.Path(b,function(c){a.Fill.BreadCrumb(c)})}else{a.WidgetLoader(true)}})}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(b){a.CheckRouteBreadCrumb(Routing.GetActiveCategory())});EventDispatcher.AddEventListener("widget.route.change.breadCrumb",function(b){a.CheckRouteBreadCrumb(b)});EventDispatcher.AddEventListener("breadCrumbWidget.fill.item",function(b){a.Render.BreadCrumb(b)});EventDispatcher.AddEventListener("breadCrumbWidget.click.item",function(b){a.BaseLoad.Path(b.id,function(c){Routing.SetHash("catalog",c[c.length-1].name_category,Routing.GetPath(c))})})};a.Fill={BreadCrumb:function(c){var b=new BreadCrumbViewModel();b.AddCrumbs(c)}},a.Render={BreadCrumb:function(c){a.InsertContainer.Main();for(var b=0;b<=a.settings.containerId.length-1;b++){if($("#"+a.settings.containerId[b]).length>0){try{ko.cleanNode($("#"+a.settings.containerId[b])[0]);ko.applyBindings(c,$("#"+a.settings.containerId[b])[0]);a.ShowContainer(a.settings.containerId[b]);a.WidgetLoader(true);if(typeof AnimateBreadCrumb=="function"){new AnimateBreadCrumb()}if(a.settings.animate){a.settings.animate()}}catch(d){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",d);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Main();a.Render.BreadCrumb(c)})}else{a.InsertContainer.EmptyWidget(b);a.WidgetLoader(true)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId[b]+"]");a.WidgetLoader(true)}delete c}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleBreadCrumb[b]){a.settings.styleBreadCrumb[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=a.settings.containerId.length-1;c++){$("#"+a.settings.containerId[c]).css(a.settings.styleBreadCrumb)}})}}};var BreadCrumbItem=function(b){var a=this;a.id=b.id;a.title=b.name_category;a.typeCategory=b.type_category;a.selectList=ko.observableArray();a.showSelectList=ko.computed(function(){if(a.selectList()>0){return true}else{false}},this);a.ClickItem=function(){if(!a.showSelectList()){EventDispatcher.DispatchEvent("breadCrumbWidget.click.item",{id:a.id})}};a.AddSelectList=function(d){for(var c=0;c<=d.length-1;c++){a.selectList.push(new SelectListBreadCrumbItem(d[c]))}}};var BreadCrumbViewModel=function(){var a=this;a.lastItem=ko.observable();a.title="";a.crumbs=ko.observableArray();a.ToHomepage=function(){Routing.SetHash("default","Домашняя",{})};a.showReturn=ko.computed(function(){if(Parameters.cache.history.length>1){return true}return false},this);a.Return=function(){Parameters.cache.history.pop();var b=Parameters.cache.history.pop();if(b.route=="order"&&b.data.create){b=Parameters.cache.history.pop()}Routing.SetHash(b.route,b.title,b.data,true)};a.AddCrumbs=function(e){if(e){for(var b=0;b<=e.length-1;b++){var c=new BreadCrumbItem(e[b]);if(e[b].children){c.AddSelectList(e[b].children)}a.crumbs.push(c)}if(Routing.route=="default"){a.crumbs=ko.observableArray();a.lastItem(Routing.defaultTitle)}if(Routing.route=="goods"){a.lastItem("Карточка товара")}if(Routing.route=="cart"){a.crumbs=ko.observableArray();a.lastItem("Моя корзина")}if(Routing.route=="payment"){a.crumbs=ko.observableArray();a.lastItem("Оплата заказа")}if(Routing.route=="registration"){a.crumbs=ko.observableArray();a.crumbs.push(new BreadCrumbItem({id:0,name_category:"Регистрация покупателя"}));if(Routing.params.step==1){a.lastItem("Шаг 1")}if(Routing.params.step==2){a.lastItem("Шаг 2")}if(Routing.params.step==3){a.lastItem("Шаг 3")}if(Routing.params.step==4){a.lastItem("Шаг 4")}}if(Routing.route=="order"){a.crumbs=ko.observableArray();a.crumbs.push(new BreadCrumbItem({id:0,name_category:"Оформление заказа"}));if(Routing.params.step==1){a.lastItem("Шаг 1")}if(Routing.params.step==2){a.lastItem("Шаг 2")}if(Routing.params.step==3){a.lastItem("Шаг 3")}if(Routing.params.step==4){a.lastItem("Шаг 4")}if(Routing.params.step==5){a.lastItem("Шаг 5")}}if(Routing.route=="profile"||Routing.route=="favorites"||Routing.route=="purchases"||Routing.route=="cabinet_cart"){a.crumbs=ko.observableArray();a.lastItem("Личный кабинет")}if(!a.lastItem()){var d=a.crumbs().pop();a.lastItem(d.title)}EventDispatcher.DispatchEvent("breadCrumbWidget.fill.item",a)}}};var SelectListBreadCrumbItem=function(b){var a=this;a.id=b.id;a.title=b.name_category;a.cssActiveItem=ko.computed(function(){if(Routing.route=="catalog"&&a.id==Routing.GetActiveCategory()){return"active"}return""},this);a.ClickItem=function(){EventDispatcher.DispatchEvent("breadCrumbWidget.click.item",{id:a.id})}};var TestBreadCrumb={Init:function(){if(typeof Widget=="function"){BreadCrumbWidget.prototype=new Widget();var a=new BreadCrumbWidget();a.Init(a)}else{setTimeout(function(){TestBreadCrumb.Init()},100)}}};TestBreadCrumb.Init();
var ContentWidget=function(){var a=this;a.widgetName="ContentWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,customContainer:null,blockContainerId:null,customBlock:null,tmpl:{content:{path:{list:null},id:{table:null,list:null,tile:null,empty:null}},block:{path:{block:null},id:{slider:null,carusel:null,tile:null,empty:null}}},animate:{content:null,block:null},inputParameters:{},styleCatalog:{},countGoodsInBlock:null,orderByContent:null,filterName:"",listPerPage:null,showCart:null,showBlocks:null,slider:[],paging:null,styleContent:null};a.testBlock={count:0,ready:0,IsReady:function(){if(a.testBlock.count==a.testBlock.ready){return true}return false}};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/ContentWidget/);if(b.content){c=b.content}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.content){c=WParameters.content}if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Input parameters",c)}if(!$.isEmptyObject(c)){if(c.hasOwnProperty("showCart")){a.settings.showCart=c.showCart}if(c.block){if(c.block.hasOwnProperty("showBlocks")){a.settings.showBlocks=c.block.showBlocks}if(c.block.count){a.settings.countGoodsInBlock=c.block.count}if(c.block.animate){a.settings.animate.block=c.block.animate}if(c.block.tmpl){if(c.block.tmpl.path){a.settings.tmpl.block.path=c.block.tmpl.path}if(c.block.tmpl.id){for(var d in c.block.tmpl.id){a.settings.tmpl.block.id[d]=c.block.tmpl.id[d]}}}if(c.block.container){for(var d in c.block.container){a.settings.blockContainerId[d]=c.block.container[d]}}}if(c.content){if(c.content.defaultCount){a.settings.paging.itemsPerPage=c.content.defaultCount}if(c.content.list){a.settings.listPerPage=c.content.list}if(c.content.animate){a.settings.animate.content=c.content.animate}}}a.settings.inputParameters=c;if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Result settings",a.settings)}};a.InitWidget=function(){a.settings.containerId=Config.Containers.content.content.widget;a.settings.customContainer=Config.Containers.content.content.customClass;a.settings.blockContainerId=Config.Containers.content.block;a.settings.customBlock=Config.Containers.content.block.customClass;a.settings.tmpl=Config.Content.tmpl;a.settings.countGoodsInBlock=Config.Content.countGoodsInBlock;a.settings.orderByContent=Config.Content.orderBy;a.settings.listPerPage=Config.Content.listPerPage;a.settings.showCart=Config.Content.showCart;a.settings.showBlocks=Config.Content.showBlocks;a.settings.paging=Config.Paging;a.settings.styleContent=Config.Content.style;a.SetInputParameters();a.RegisterEvents();a.CheckContentRouting();a.SetPosition()};a.CheckContentRouting=function(){if(Routing.route=="catalog"||Routing.IsDefault()){a.BaseLoad.Roots(function(){a.SelectTypeContent()})}else{a.WidgetLoader(true)}};a.SelectTypeContent=function(){if(Routing.IsCategory()){if(!a.HasDefaultContent("content","content")||!Routing.IsDefault()){a.Get.Content()}else{a.WidgetLoader(true)}}else{if(Routing.IsDefault()){Config.Base.defaultSection=Parameters.cache.roots[0].id;if(Parameters.cache.roots[0].type_category!="section"){a.Get.Content()}else{if(a.settings.showBlocks){a.Get.Blocks()}else{if(!a.settings.showBlocks){var b=Parameters.cache.roots[0].children;var c=null;$.each(b,function(d){if(b[d].type_category=="category"){c=b[d];return false}});if(c){Routing.SetHash("catalog",c.name_category,{section:Parameters.cache.roots[0].id,category:c.id})}else{a.WidgetLoader(true)}}else{a.WidgetLoader(true)}}}}else{if(a.settings.showBlocks){if(!a.HasDefaultContent("content","block")||!Routing.IsDefault()){a.Get.Blocks()}else{a.WidgetLoader(true)}}else{a.WidgetLoader(true)}}}};a.Get={Content:function(){a.BaseLoad.Tmpl(a.settings.tmpl.content,function(){EventDispatcher.DispatchEvent("onload.content.tmpl")})},Blocks:function(){a.BaseLoad.Tmpl(a.settings.tmpl.block,function(){EventDispatcher.DispatchEvent("onload.blockContent.tmpl")})}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("onload.blockContent.tmpl",function(){a.BaseLoad.Script("widgets/ContentViewModel-1.0.js",function(){a.BaseLoad.Blocks(Routing.GetActiveCategory(),function(b){if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"data block for sectionId = ["+Routing.GetActiveCategory()+"]",b)}a.CheckData(b)})})});EventDispatcher.AddEventListener("onload.content.tmpl",function(){a.BaseLoad.Script("widgets/ContentViewModel-1.0.js",function(){a.BaseLoad.Info(Routing.GetActiveCategory(),function(b){a.InsertContainer.EmptyBlockWidget();EventDispatcher.DispatchEvent("contentWidget.load.categoryInfo")})})});EventDispatcher.AddEventListener("contentWidget.load.categoryInfo",function(){var d=(Routing.GetCurrentPage()-1)*a.settings.paging.itemsPerPage;var c=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):a.settings.orderByContent;var b=d+"/"+a.settings.paging.itemsPerPage+"/"+c+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));a.BaseLoad.Content(Routing.params.category,b,function(e){a.Fill.Content(e)})});EventDispatcher.AddEventListener("contentWidget.fill.block",function(b){a.Render.Block(b);delete b});EventDispatcher.AddEventListener("contentWidget.fill.listContent",function(b){a.InsertContainer.List(b.typeView);a.Render.List(b)});EventDispatcher.AddEventListener("widget.change.route",function(b){a.CheckContentRouting()});EventDispatcher.AddEventListener("contentWidget.click.category",function(b){if($("script#contentTileTmpl").length<0){a.BaseLoad.Tmpl(a.settings.tmplForContent,function(){EventDispatcher.DispatchEvent("onload.content.tmpl")})}else{EventDispatcher.DispatchEvent("onload.content.tmpl")}})};a.CheckData=function(e){a.InsertContainer.EmptyBlockWidget();if(e.err||e==false){if(e.err=="categoriesNotCreated"){var f=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"categoriesNotCreated"});a.InsertContainer.Block(0,f.typeView);a.Render.NoResultsBlock(f)}else{var f=new EmptyViewBlock({titleBlock:Routing.GetTitle(),typeView:"no_results"});a.InsertContainer.Block(0,f.typeView);a.Render.NoResultsBlock(f)}}else{a.testBlock.count=0;a.testBlock.ready=0;a.Render.Animate.block=ko.observableArray();for(var c=0;c<=e.length-1;c++){if(e[c].count_goods>0){++a.testBlock.count;Parameters.cache.contentBlock[e[c].id]={sort:c,block:e[c]};a.InsertContainer.Block(c,e[c].type_view);var d="0/"+a.settings.countGoodsInBlock+"/name/";var b=e[c].id+EventDispatcher.HashCode(d);EventDispatcher.AddEventListener("contentWidget.onload.content%%"+b,function(g){a.Fill.Block(Parameters.cache.contentBlock[g.categoryId])});a.BaseLoad.Content(e[c].id,d,function(g){EventDispatcher.DispatchEvent("contentWidget.onload.content%%"+b,g)})}}}};a.InsertContainer={EmptyBlockWidget:function(){var b=$("#"+a.settings.blockContainerId.slider.widget).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.blockContainerId.slider.widget).empty().html(b);var b=$("#"+a.settings.blockContainerId.carousel.widget).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.blockContainerId.carousel.widget).empty().html(b);var b=$("#"+a.settings.blockContainerId.tile.widget).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.blockContainerId.tile.widget).empty().html(b)},Block:function(b,c){if(c=="slider"){$("#"+a.settings.blockContainerId.slider.widget).append($("script#"+a.GetTmplName("slider","block")).html()).children().hide();$("#"+a.settings.blockContainerId.slider.widget+" .promoBlocks:last").attr("id","block_sort_"+b)}if(c=="carousel"){$("#"+a.settings.blockContainerId.carousel.widget).append($("script#"+a.GetTmplName("carusel","block")).html()).children().hide();$("#"+a.settings.blockContainerId.carousel.widget+" .promoBlocks:last").attr("id","block_sort_"+b)}if(c=="tile"){$("#"+a.settings.blockContainerId.tile.widget).append($("script#"+a.GetTmplName("tile","block")).html()).children().hide();$("#"+a.settings.blockContainerId.tile.widget+" .promoBlocks:last").attr("id","block_sort_"+b)}if(c=="no_results"){$("#"+a.settings.blockContainerId.empty.widget).html($("script#"+a.GetTmplName("empty","block")).html()).children().hide()}if(c=="categoriesNotCreated"){$("#"+a.settings.blockContainerId.empty.widget).html('<p style="margin-top: 40px">'+Config.Content.message.categoriesNotCreated+"</p>").children().hide()}},EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},List:function(b){a.InsertContainer.EmptyWidget();if(b=="table"){$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("table","content")).html()).children().hide()}if(b=="list"){$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("list","content")).html()).children().hide()}if(b=="tile"){$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("tile","content")).html()).children().hide()}if(b=="no_results"){$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("empty","content")).html()).children().hide()}}};a.Fill={Block:function(b){var c=new BlockViewModel(b,a.settings);if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"data blockId = ["+c.id+"] typeView = ["+c.typeView+"]",c)}c.AddContent()},Content:function(c){if(c.content[0].count_goods!=0){var b=new ListContentViewModel(a.settings);b.AddCategoryInfo(c.categoryId);b.AddContent(c.content)}else{var b=new ListContentViewModel(a.settings);b.AddCategoryInfo(c.categoryId);if(b.filters.filterName()!=""){b.SetType("no_results");b.SetMessage(Config.Content.message.filter.replace(/%%filterName%%/g,b.filters.filterName()))}else{b.SetType("no_results");b.SetMessage(Config.Content.message.noGoods)}EventDispatcher.DispatchEvent("contentWidget.fill.listContent",b)}}};a.Render={Animate:{block:ko.observableArray(),Do:function(){if(Loader.IsReady()){var c=a.Render.Animate.block();$.each(c,function(b){if(typeof AnimateContent=="function"){new AnimateContent()}if(a.settings.animate.block){a.settings.animate.block()}})}else{setTimeout(function(){a.Render.Animate.Do()},100)}}},List:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateContent=="function"){new AnimateContent()}if(a.settings.animate.content){a.settings.animate.content()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName(b.typeView,"content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.List(b.typeView);a.Render.List(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}delete b},Block:function(b){if($("#"+b.cssBlock).length>0){try{ko.cleanNode($("#"+b.cssBlock)[0]);ko.applyBindings(b,$("#"+b.cssBlock)[0]);a.Render.Animate.block.push({type:b.typeView,data:b});a.testBlock.ready=a.testBlock.ready+1;if(a.testBlock.IsReady()){$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)});a.Render.Animate.Do()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName(b.typeView,"block")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Block(b.typeView);a.Render.Block(b)})}else{a.InsertContainer.EmptyWidget();$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)})}}}else{a.Exception("Ошибка. Не найден контейнер ["+b.cssBlock+"]");$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)})}delete b},NoResultsBlock:function(b){if($("#"+a.settings.blockContainerId.empty.widget).length>0){try{ko.cleanNode($("#"+a.settings.blockContainerId.empty.widget)[0]);ko.applyBindings(b,$("#"+a.settings.blockContainerId.empty.widget)[0]);$("#"+a.settings.blockContainerId.empty.widget).children().show();$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)});if(typeof AnimateContent=="function"){new AnimateContent()}if(a.settings.animate.block){a.settings.animate.block()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("empty","block")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Block(b.typeView);a.Render.Block(b)})}else{a.InsertContainer.EmptyWidget();$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)})}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.blockContainerId.empty.widget+"]");$.each(a.settings.blockContainerId,function(d){a.WidgetLoader(true,a.settings.blockContainerId[d].widget)})}},NoResults:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateContent=="function"){new AnimateContent()}if(a.settings.animate.content){a.settings.animate.content()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("empty","content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.List(b.typeView);a.Render.NoResults(b)})}else{a.InsertContainer.EmptyBlockWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleContent[b]){a.settings.styleContent[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.containerId).css(a.settings.styleContent)})}}};var EmptyViewBlock=function(b){var a=this;a.titleBlock=b.titleBlock;a.typeView=b.typeView};var BlockViewModel=function(c,b){var a=this;a.countGoodsInContent=b.countGoodsInBlock;a.id=c.block.id;a.sort=c.sort;a.titleBlock=c.block.name_category;a.typeView=c.block.type_view;a.countGoods=c.block.count_goods?c.block.count_goods:0;a.showCart=b.showCart;a.cssBlock="block_sort_"+c.sort;a.cssBlockContainer="sliderContainer_"+a.id;a.imageHref="#";a.contentBlock=ko.observableArray();a.AddContent=function(){var m="0/"+a.countGoodsInContent+"/name/";var e=a.id+EventDispatcher.HashCode(m);var k=Parameters.cache.content[e].content;if(k&&k.length>1){var h=k.shift();a.countGoods=h.count_goods;if(k.length<a.countGoodsInContent){a.countGoodsInContent=k.length}var l=0;for(var g=0;g<=a.countGoodsInContent-1;g++){if(a.typeView=="tile"){var n=new BlockTrForTableViewModel();for(var d=0;d<=2;d++){if(k[l]){n.AddStr(new ContentViewModel(k[l],l));l++}else{break}}if(n.str().length>0){a.contentBlock.push(n)}delete n}else{a.contentBlock.push(new ContentViewModel(k[g],g))}}k.unshift(h);EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}else{EventDispatcher.DispatchEvent("contentWidget.fill.block",a)}};a.ClickCategory=function(){Routing.SetHash("catalog",a.titleBlock,{category:c.block.id})}};var ListContentViewModel=function(b){var a=this;a.id=0;a.titleBlock="";a.typeView="tile";a.countGoods=0;a.message="";a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortContentListViewModel();c.AddContent(Config.Content.sortList);c.SetDefault(Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderByContent);return c};a.filters={typeView:a.typeView,filterName:ko.observable(Routing.GetMoreParameter("filterName")?Routing.GetMoreParameter("filterName"):b.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),sort:a.GetSort(),FilterNameGoods:function(c){b.filterName=a.filters.filterName($(c.text).val());Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ClickFilterNameGoods:function(){b.filterName=a.filters.filterName();Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("ContentWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.content[a.GetQueryHash()].content);EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}}};a.SetType=function(c){a.typeView=c};a.SetMessage=function(c){a.message=c};a.AddCategoryInfo=function(e){var d=Parameters.cache.infoCategory[e];a.id=d.id;a.titleBlock=d.name_category;if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}else{if(d.type_view){var c=d.type_view;if(d.type_view=="carousel"||d.type_view=="slider"){var c="tile"}a.typeView=c;a.filters.typeView=c}}};a.AddContent=function(h){a.content=ko.observableArray();if(h&&h.length>1){var e=h.shift();a.countGoods=e.count_goods;var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e);a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("contentWidget.fill.listContent",a)}};a.GetQueryHash=function(){var e=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var d=Routing.GetMoreParameter("orderBy")?Routing.GetMoreParameter("orderBy"):b.orderByContent;var c=e+"/"+b.paging.itemsPerPage+"/"+d+"/"+encodeURIComponent(Routing.GetMoreParameter("filterName"));return Routing.GetActiveCategory()+EventDispatcher.HashCode(c)};a.AddPages=function(){var c=function(){Loader.Indicator("ContentWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortContentItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("ContentWidget",false);Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortContentListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortContentItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestContent={Init:function(){if(typeof Widget=="function"){ContentWidget.prototype=new Widget();var a=new ContentWidget();a.Init(a)}else{setTimeout(function(){TestContent.Init()},100)}}};TestContent.Init();
var SearchWidget=function(){var a=this;a.widgetName="SearchWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,showCatalog:null,tmpl:{path:null,id:null},animate:null,inputParameters:{},style:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.search.widget;a.settings.customContainer=Config.Containers.search.customClass;a.settings.showCatalog=Config.Search.showCatalog;a.settings.tmpl=Config.Search.tmpl;a.settings.style=Config.Search.style;a.RegisterEvents();a.CheckRoute();a.SetInputParameters();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/SearchWidget/);if(b.search){c=b.search}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.search){c=WParameters.search}if(!$.isEmptyObject(c)){if(c.hasOwnProperty("showCatalog")){a.settings.showCatalog=c.showCatalog}if(c.tmpl){a.settings.tmplPath="search/"+c.tmpl+".html"}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.CheckRoute=function(){if(Routing.IsDefault()&&a.HasDefaultContent()){a.WidgetLoader(true,a.settings.containerId)}else{a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.Roots(function(){a.BaseLoad.Section(Routing.GetActiveCategory(),function(b){EventDispatcher.DispatchEvent("searchWidget.onload.section",b)})})})}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("searchWidget.onload.tmpl",function(b){a.CheckRoute()});EventDispatcher.AddEventListener("searchWidget.onload.section",function(b){a.BaseLoad.Info(Routing.GetActiveCategory(),function(c){EventDispatcher.DispatchEvent("searchWidget.onload.categoryInfo",c)})});EventDispatcher.AddEventListener("searchWidget.onload.categoryInfo",function(b){a.Fill(b)});EventDispatcher.AddEventListener("searchWidget.fill.listCategory",function(b){a.InsertContainer.Content();a.Render(b)});EventDispatcher.AddEventListener("widget.change.route",function(b){a.CheckRoute()})};a.Fill=function(c){SearchViewModel.prototype=new Widget();var b=new SearchViewModel(a.settings);b.AddListCategory(c)};a.Render=function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateSearch=="function"){new AnimateSearch()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.containerId).css(a.settings.style)})}}};var SearchCategoryItem=function(c,d,a){var b=this;b.id=c.id;b.title=Array(d).join(" - ")+c.name_category;b.typeCategory=c.type_category;b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchCategoryItemForTree=function(c,d,a){var b=this;b.id=c.id;b.title=c.name_category;b.typeCategory=c.type_category;b.children=ko.observableArray();b.isSelected=ko.computed(function(){if(a.selectedCatigoriesId()==b.id){a.selectedCatigory(b.title);return true}return false},this);b.ClickItem=function(){a.selectedCatigoriesId(b.id);a.selectedCatigory(b.title)}};var SearchViewModel=function(b){var a=this;a.text=ko.observable();if(Routing.route=="search"){a.text(Parameters.filter.keyWords)}a.cssSelectList="searchSelectList";a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.selectedCatigoriesId=ko.observable();if(Routing.route=="search"&&Parameters.filter.idSelectCategories&&Parameters.filter.idSelectCategories.length==1){a.selectedCatigoriesId(Parameters.filter.idSelectCategories[0])}a.selectedCatigory=ko.observable();a.idCategories=Parameters.filter.idCategories;a.typeCategories=[];a.cachData={};a.showCatalog=b.showCatalog;a.ClickAdvancedSearch=function(){EventDispatcher.DispatchEvent("searchResultWidget.show.form")};a.AddListCategory=function(f){if(Parameters.cache.childrenCategory[f.id]){var h=Parameters.cache.childrenCategory[f.id];a.categories=ko.observableArray();a.categoriesTree=ko.observableArray();a.childrenCategories=ko.observableArray();a.typeCategories=[];a.cachData=[{id:f.id,type_category:f.type_category,children:h}];a.typeCategories[f.id]=f.type_category;a.categories.push(new SearchCategoryItem(f,0,a));for(var e=0;e<=h.length-1;e++){a.categories.push(new SearchCategoryItem(h[e],1,a));a.typeCategories[h[e].id]=h[e].type_category;var g=new SearchCategoryItemForTree(h[e],e+1,a);var d=ko.observableArray();if(h[e].children){for(var c=0;c<=h[e].children.length-1;c++){a.categories.push(new SearchCategoryItem(h[e].children[c],2,a));a.typeCategories[h[e].id]=h[e].type_category;d.push(new SearchCategoryItemForTree(h[e].children[c],2,a))}g.children=d}a.childrenCategories.push(g)}var f=new SearchCategoryItemForTree(f,0,a);f.children=a.childrenCategories;a.categoriesTree.push(f)}EventDispatcher.DispatchEvent("searchWidget.fill.listCategory",a)};a.SubmitSearchForm=function(d){a.idCategories=[];var c=a.selectedCatigoriesId();var e=$(d.text).val();if(e){if(a.typeCategories[c]!="category"){a.FindSelectedSection(a.cachData,c)}else{a.idCategories.push(c)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[c];Parameters.filter.keyWords=e;if(a.idCategories.length==0){a.idCategories=[c]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);EventDispatcher.DispatchEvent("widget.route.change.breadCrumb",c)}else{a.ShowMessage(Config.Search.message.empty,false,false)}};a.ClickSearchForm=function(){a.idCategories=[];var c=a.selectedCatigoriesId();var d=a.text();if(d){if(a.typeCategories[c]!="category"){a.FindSelectedSection(a.cachData,c)}else{a.idCategories.push(c)}Parameters.SetDefaultFilterParameters();Parameters.filter.idSelectCategories=[c];Parameters.filter.keyWords=d;if(a.idCategories.length==0){a.idCategories=[c]}Parameters.filter.idCategories=a.idCategories;Routing.SetHash("search","Расширенный поиск",Parameters.filter);EventDispatcher.DispatchEvent("widget.route.change.breadCrumb",c)}else{a.ShowMessage(Config.Search.message.empty,false,false)}};a.FindSelectedSection=function(e,d){for(var c=0;c<=e.length-1;c++){if(e[c].id==d&&e[c].children){a.FindChildrenCategory(e[c].children);break}else{if(e[c].children){a.FindSelectedSection(e[c].children,d)}}}};a.FindChildrenCategory=function(d){for(var c=0;c<=d.length-1;c++){if(d[c].type_category=="category"){a.idCategories.push(d[c].id)}if(d[c].children){a.FindChildrenCategory(d[c].children)}}}};var TestSearch={Init:function(){if(typeof Widget=="function"){SearchWidget.prototype=new Widget();var a=new SearchWidget();a.Init(a)}else{setTimeout(function(){TestSearch.Init()},100)}}};TestSearch.Init();
var SearchResultWidget=function(){var a=this;a.widgetName="SearchResultWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerIdForSearchResult:null,containerIdForAdvancedSearch:null,customContainerForSearchResult:null,customContainerForAdvancedSearch:null,tmpl:{content:{path:{list:null},id:{table:null,list:null,tile:null,empty:null}},form:{path:null,id:null}},animate:{content:null,form:null},showCatalog:null,showCart:null,showForm:null,idAdvancedSearchForm:null,idTreeCategoriesForAdvancedSearchForm:"tree_categories_for_advanced_search",inputParameters:{},listPerPage:null,listTypeSearch:null,listTypeSeller:null,styleSearchResult:null,paging:null};a.InitWidget=function(){a.settings.containerIdForSearchResult=Config.Containers.searchResult.content.widget;a.settings.customContainerForSearchResult=Config.Containers.searchResult.content.customClass;a.settings.containerIdForAdvancedSearch=Config.Containers.searchResult.form.widget;a.settings.customContainerForAdvancedSearch=Config.Containers.searchResult.form.customClass;a.settings.tmpl=Config.SearchResult.tmpl;a.settings.idAdvancedSearchForm=Config.SearchResult.idAdvancedSearchForm;a.settings.listPerPage=Config.SearchResult.listPerPage;a.settings.listTypeSearch=Config.SearchResult.listTypeSearch;a.settings.listTypeSeller=Config.SearchResult.listTypeSeller;a.settings.styleSearchResult=Config.SearchResult.style;a.settings.showCatalog=Config.SearchResult.showCatalog;a.settings.showCart=Config.SearchResult.showCart;a.settings.showForm=Config.SearchResult.showForm;a.settings.paging=Config.Paging;a.RegisterEvents();a.SetInputParameters();a.CheckRoutingSearch();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/SearchResultWidget/);if(b.searchResult){c=b.searchResult}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.searchResult){c=WParameters.searchResult}if(!$.isEmptyObject(c)){if(c.content){if(c.content.hasOwnProperty("showCart")){a.settings.showCart=c.content.showCart}if(c.content.hasOwnProperty("defaultCount")){a.settings.paging.itemsPerPage=c.content.defaultCount}if(c.content.list){a.settings.listPerPage=c.content.list}if(c.content.tmpl){if(c.content.tmpl.path){a.settings.tmpl.content.path=c.content.tmpl.path}if(c.content.tmpl.id){a.settings.tmpl.content.id=c.content.tmpl.id}}if(c.content.animate){a.settings.animate.content=c.content.animate}}if(c.form){if(c.form.hasOwnProperty("showForm")){a.settings.showForm=c.form.showForm}if(c.form.hasOwnProperty("showCatalog")){a.settings.showCatalog=c.form.showCatalog}if(c.form.tmpl){if(c.form.tmpl.path){a.settings.tmpl.form.path=c.form.tmpl.path}if(c.form.tmpl.id){a.settings.tmpl.form.id=c.form.tmpl.id}}if(c.form.animate){a.settings.animate.form=c.form.animate}}}a.settings.inputParameters=c};a.CheckRoutingSearch=function(){if(Routing.route=="search"){for(var e in Routing.params){if(e=="idSelectCategories"){var b=[];var f=decodeURIComponent(Routing.params[e]).split(",");if(Routing.params[e]){var c=0;for(var d in f){var g=parseInt(f[d]);if(g&&!isNaN(g)){b[c++]=g}}Parameters.filter[e]=b;Parameters.filter.idCategories=b}}else{Parameters.filter[e]=decodeURIComponent(Routing.params[e])}}EventDispatcher.DispatchEvent("widget.change.route")}else{EventDispatcher.DispatchEvent("searchResultWidget.show.form")}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("searchResultWidget.show.form",function(){if(a.settings.showForm){$("#"+a.settings.containerIdForAdvancedSearch).html("");a.BaseLoad.Roots(function(){EventDispatcher.DispatchEvent("searchResultWidget.onload.roots.show.form")})}else{a.WidgetLoader(true,a.settings.containerIdForAdvancedSearch)}});EventDispatcher.AddEventListener("searchResultWidget.onload.roots.show.form",function(b){a.BaseLoad.Tmpl(a.settings.tmpl.form,function(){a.InsertContainer.AdvancedSearchForm();if(Routing.route!="search"){Parameters.SetDefaultFilterParameters()}a.Fill.AdvancedSearchForm();a.WidgetLoader(true,a.settings.containerIdForAdvancedSearch)})});EventDispatcher.AddEventListener("searchResultWidget.submit.form",function(f){var b=a.settings.paging;var h=(Routing.GetCurrentPage()-1)*b.itemsPerPage;var e=h+"/"+b.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var d=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var g=[];for(var c=0;c<=d.length-1;c++){if(Parameters.filter[d[c]]){g[c]=d[c]+"="+encodeURIComponent(Parameters.filter[d[c]])}}e=e+g.join("&");a.BaseLoad.SearchContent(Parameters.shopId,e,function(i){EventDispatcher.DispatchEvent("searchResultWidget.onload.searchResult",i)})});EventDispatcher.AddEventListener("searchResultWidget.onload.searchResult",function(b){EventDispatcher.DispatchEvent("onload.breadCrumb.tmpl");a.Fill.SearchResult(b)});EventDispatcher.AddEventListener("searchResultWidget.fill.searchResult",function(b){a.InsertContainer.SearchResult(b.typeView);a.Render.SearchResult(b)});EventDispatcher.AddEventListener("searchResultWidget.fill.categories",function(b){a.Render.AdvancedSearchForm(b)});EventDispatcher.AddEventListener("widget.change.route",function(b){if(Routing.route=="search"){a.BaseLoad.Tmpl(a.settings.tmpl.content,function(){EventDispatcher.DispatchEvent("searchResultWidget.submit.form")})}else{EventDispatcher.DispatchEvent("searchResultWidget.show.form")}})};a.InsertContainer={EmptyFormWidget:function(){var b=$("#"+a.settings.containerIdForAdvancedSearch).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerIdForAdvancedSearch).empty().html(b)},AdvancedSearchForm:function(){a.InsertContainer.EmptyFormWidget();$("#"+a.settings.containerIdForAdvancedSearch).append($("script#"+a.GetTmplName(false,"form")).html()).children().hide()},EmptyWidget:function(){var b=$("#"+a.settings.containerIdForSearchResult).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerIdForSearchResult).empty().html(b)},SearchResult:function(b){a.InsertContainer.EmptyWidget();if(b=="table"){$("#"+a.settings.containerIdForSearchResult).append($("script#"+a.GetTmplName("table","content")).html()).children().hide()}if(b=="list"){$("#"+a.settings.containerIdForSearchResult).append($("script#"+a.GetTmplName("list","content")).html()).children().hide()}if(b=="tile"){$("#"+a.settings.containerIdForSearchResult).append($("script#"+a.GetTmplName("tile","content")).html()).children().hide()}if(b=="error"){$("#"+a.settings.containerIdForSearchResult).append($("script#"+a.GetTmplName("empty","content")).html()).children().hide()}}};a.Fill={AdvancedSearchForm:function(){var b=new AdvancedSearchFormViewModel(a.settings);a.BaseLoad.Roots(function(c){b.AddCategories(c)})},SearchResult:function(c){var b=new ListSearchResultViewModel(a.settings);b.AddContent(c)}};a.Render={AdvancedSearchForm:function(b){if($("#"+a.settings.containerIdForAdvancedSearch).length){try{if(ko.global){ko.global.route=Routing.route}else{ko.global={route:Routing.route}}ko.cleanNode($("#"+a.settings.containerIdForAdvancedSearch)[0]);ko.applyBindings(b,$("#"+a.settings.containerIdForAdvancedSearch)[0]);a.WidgetLoader(true,a.settings.containerIdForAdvancedSearch);if(typeof AnimateSearchResult=="function"){new AnimateSearchResult()}if(a.settings.animate.form){a.settings.animate.form()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName(false,"form")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.AdvancedSearchForm();a.Render.AdvancedSearchForm(b)})}else{a.InsertContainer.EmptyFormWidget();a.WidgetLoader(true,a.settings.containerIdForAdvancedSearch)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerIdForAdvancedSearch+"]");a.WidgetLoader(true,a.settings.containerIdForAdvancedSearch)}},SearchResult:function(b){if($("#"+a.settings.containerIdForSearchResult).length>0){try{ko.cleanNode($("#"+a.settings.containerIdForSearchResult)[0]);ko.applyBindings(b,$("#"+a.settings.containerIdForSearchResult)[0]);a.WidgetLoader(true,a.settings.containerIdForSearchResult);EventDispatcher.DispatchEvent("searchResultWidget.show.form");if(typeof AnimateSearchResult=="function"){new AnimateSearchResult()}if(a.settings.animate.content){a.settings.animate.content()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName(false,"content")+"]");if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.SearchResult(b.typeView);a.Render.SearchResult(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerIdForSearchResult)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerIdForSearchResult+"]");a.WidgetLoader(true,a.settings.containerIdForSearchResult)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleSearchResult[b]){a.settings.styleSearchResult[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.containerIdForAdvancedSearch).css(a.settings.styleSearchResult)})}}};var AdvancedSearchFormViewModel=function(b){var a=this;a.keyWords=Parameters.filter.keyWords;a.idCategories=Parameters.filter.idCategories;a.typeSearch=ko.observable();a.typeSearch(Parameters.filter.typeSearch);a.startCost=Parameters.filter.startCost;a.endCost=Parameters.filter.endCost;a.exceptWords=Parameters.filter.exceptWords;a.typeSeller=ko.observable();a.typeSeller(Parameters.filter.typeSeller);a.showCatalog=b.showCatalog;a.categories=[];a.typesSearch=ko.observableArray();a.typesSellers=ko.observableArray();a.typeCategories=[];a.cssTypeSearch="advancedSearchTypeSearch";a.cssTypeSeller="advancedSearchTypeSeller";a.cachData={};a.FillTypeSearchSelectList=function(c,e){for(var d in c){e.push(new AdvancedSearchFormTypeSearchViewModel({key:d,title:c[d]},a))}};a.FillTypeSellerSelectList=function(c,e){for(var d in c){e.push(new AdvancedSearchFormTypeSellerViewModel({key:d,title:c[d]},a))}};a.FillTypeSearchSelectList(b.listTypeSearch,a.typesSearch);a.FillTypeSellerSelectList(b.listTypeSeller,a.typesSellers);a.AddCategories=function(c){a.cachData=c;if(a.idCategories&&a.idCategories.length==1){a.FindSelectedSection(c,a.idCategories)}a.categories=a.AddChildren(c).children;Parameters.cache.categories=a.categories;EventDispatcher.DispatchEvent("searchResultWidget.fill.categories",a)};a.AddChildren=function(h,c){var e=[];var i=false;for(var d=0;d<=h.length-1;d++){var g={};g.select=false;if($.inArray(h[d].id,Parameters.filter.idSelectCategories)>=0||c==true){g.select=true;i=true}if(h[d].children){var f=a.AddChildren(h[d].children,g.select);g.children=f.children;g.expand=f.active;g.isFolder=true}g.key=h[d].id;g.title=h[d].name_category;e.push(g);a.typeCategories[h[d].id]=h[d].type_category}return{children:e,active:i}};a.SubmitAdvancedSearchForm=function(c){Loader.Indicator("SearchResultWidget",false);a.keyWords=$(c.keyWords).val();a.startCost=$(c.startCost).val();a.endCost=$(c.endCost).val();a.exceptWords=$(c.exceptWords).val();Parameters.filter.idCategories=a.idCategories=[];a.FindSelectedSection(a.cachData,Parameters.filter.idSelectCategories);if(a.idCategories.length>0){Parameters.filter.idCategories=a.idCategories.join(",")}Parameters.filter.keyWords=a.keyWords;Parameters.filter.typeSearch=a.typeSearch();Parameters.filter.startCost=a.startCost;Parameters.filter.endCost=a.endCost;Parameters.filter.exceptWords=a.exceptWords;Parameters.filter.typeSeller=a.typeSeller();Parameters.filter.page=1;Routing.SetHash("search","Расширенный поиск",Parameters.filter)};a.FilterCategories=function(e){var f=[];var c=0;for(var d=0;d<=e.length-1;d++){if(a.typeCategories[e[d]]&&a.typeCategories[e[d]]=="category"){f[c]=e[d];c++}}return f};a.FindSelectedSection=function(f,e){for(var d=0;d<=f.length-1;d++){if(e){for(var c=0;c<=e.length;c++){if(f[d].id==e[c]&&f[d].children){a.FindChildrenCategory(f[d].children);break}else{if(f[d].children){a.FindSelectedSection(f[d].children,e)}else{if(f[d].id==e[c]){if($.inArray(f[d].id,a.idCategories)<0){a.idCategories.push(f[d].id)}}}}}}}};a.FindChildrenCategory=function(d){for(var c=0;c<=d.length-1;c++){if(d[c].type_category=="category"){if($.inArray(d[c].id,a.idCategories)<0){a.idCategories.push(d[c].id)}}if(d[c].children){a.FindChildrenCategory(d[c].children)}}}};var AdvancedSearchFormTypeSearchViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSearch(a.key)}};var AdvancedSearchFormTypeSellerViewModel=function(c,b){var a=this;a.title=c.title;a.key=c.key;a.ClickItem=function(){b.typeSeller(a.key)}};var ListSearchResultViewModel=function(b){var a=this;a.id=0;a.titleBlock="Расширенный поиск";a.typeView="tile";a.countGoods=0;a.showCart=b.showCart;a.content=ko.observableArray();a.paging=ko.observableArray();a.GetSort=function(){var c=new SortSearchResultListViewModel();c.AddContent(Config.SearchResult.sortList);c.SetDefault(Parameters.filter.orderBy);return c};a.filters={typeView:a.typeView,sort:a.GetSort(),filterName:ko.observable(Parameters.filter.filterName),itemsPerPage:b.paging.itemsPerPage,listPerPage:ko.observableArray(),countOptionList:ko.observable(b.listPerPage.length-1),FilterNameGoods:function(c){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=$(c.text).val();Routing.UpdateHash({page:1,filterName:$(c.text).val()})},ClickFilterNameGoods:function(){Loader.Indicator("SearchResultWidget",false);Parameters.filter.filterName=a.filters.filterName();Routing.UpdateMoreParameters({filterName:a.filters.filterName()});Routing.UpdateHash({page:1})},ViewSelectCount:function(){a.filters.listPerPage=ko.observableArray();for(var c in b.listPerPage){if(b.listPerPage[c]<a.countGoods){a.filters.listPerPage.push(b.listPerPage[c])}else{a.filters.listPerPage.push(b.listPerPage[c]);break}}if(a.filters.listPerPage().length==1){a.filters.listPerPage=ko.observableArray()}},SelectCount:function(c){Loader.Indicator("SearchResultWidget",false);a.filters.itemsPerPage=b.paging.itemsPerPage=c;Routing.UpdateHash({page:1})},selectTypeView:{ClickTile:function(){a.typeView="tile";a.filters.typeView="tile";Parameters.cache.typeView="tile";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("searchResultWidget.fill.searchResult",a)},ClickTable:function(){a.typeView="table";a.filters.typeView="table";Parameters.cache.typeView="table";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("searchResultWidget.fill.searchResult",a)},ClickList:function(){a.typeView="list";a.filters.typeView="list";Parameters.cache.typeView="list";a.AddContent(Parameters.cache.searchContent[a.GetQueryHash()]);EventDispatcher.DispatchEvent("searchResultWidget.fill.searchResult",a)}}};a.AddContent=function(h){a.content=ko.observableArray();if(Parameters.cache.typeView){a.typeView=Parameters.cache.typeView;a.filters.typeView=Parameters.cache.typeView}if(h&&h.length>1){var e=h.shift();a.countGoods=e.count_goods;var g=0;for(var d=0;d<=h.length-1;d++){if(a.typeView=="tile"){var k=new BlockTrForTableViewModel();for(var c=0;c<=3;c++){if(h[g]){k.AddStr(new ContentViewModel(h[g],g));g++}else{break}}if(k.str().length>0){a.content.push(k)}delete k}else{a.content.push(new ContentViewModel(h[d],d))}}a.AddPages();h.unshift(e)}if(a.countGoods==0){a.typeView="error"}a.filters.ViewSelectCount();EventDispatcher.DispatchEvent("searchResultWidget.fill.searchResult",a)};a.GetQueryHash=function(){var g=(Routing.GetCurrentPage()-1)*b.paging.itemsPerPage;var e=g+"/"+b.paging.itemsPerPage+"/"+Parameters.filter.orderBy+"/"+(Parameters.filter.filterName?encodeURIComponent(Parameters.filter.filterName):"")+"?";var d=["keyWords","typeSearch","idCategories","startCost","endCost","exceptWords","typeSeller"];var f=[];for(var c=0;c<=d.length-1;c++){if(Parameters.filter[d[c]]){f[c]=d[c]+"="+encodeURIComponent(Parameters.filter[d[c]])}}e=e+f.join("&");return Parameters.shopId+EventDispatcher.HashCode(e)};a.AddPages=function(){var c=function(){Loader.Indicator("SearchResultWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countGoods,b,c)}};var SortSearchResultItemViewModel=function(b,c){var a=this;a.name=b.name;a.title=b.title;a.isActive=false;a.ClickSort=function(){$.each(c.list(),function(d){c.list()[d].isActive=false});c.activeItem(a);a.isActive=true;Loader.Indicator("SearchResultWidget",false);Parameters.filter.orderBy=a.name;Routing.UpdateMoreParameters({orderBy:a.name});Routing.UpdateHash({page:1})}};var SortSearchResultListViewModel=function(){var a=this;a.activeItem=ko.observable();a.list=ko.observableArray();a.cssSortList="sort_search_result_list";a.AddContent=function(b){$.each(b,function(c){a.list.push(new SortSearchResultItemViewModel(b[c],a))})};a.SetDefault=function(b){$.each(a.list(),function(c){if(a.list()[c].name==b){a.activeItem(a.list()[c]);a.list()[c].isActive=true}else{a.list()[c].isActive=false}})}};var TestSearchResult={Init:function(){if(typeof Widget=="function"){SearchResultWidget.prototype=new Widget();var a=new SearchResultWidget();a.Init(a)}else{setTimeout(function(){TestSearchResult.Init()},100)}}};TestSearchResult.Init();
var GoodsWidget=function(){var a=this;a.widgetName="GoodsWidget";a.version=1.2;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.goods=null;a.hasButton=false;a.settings={containerId:null,tmpl:{path:null,id:null},animate:null,showBlocks:null,inputParameters:{},styleGoods:null,customContainer:null,infoBlock:1111111};a.InitWidget=function(){a.settings.containerId=Config.Containers.goods.widget;a.settings.customContainer=Config.Containers.goods.customClass;a.settings.tmpl=Config.Goods.tmpl;a.settings.showBlocks=Config.Goods.showBlocks;a.settings.styleGoods=Config.Goods.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteGoods();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/GoodsWidget/);if(b.goods){c=b.goods}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.goods){c=WParameters.goods}if(!$.isEmptyObject(c)){if(c.show){for(var d=0;d<=c.show.length-1;d++){if($.inArray(c.show[d],a.settings.showBlocks)<0){a.settings.showBlocks.push(c.show[d])}}}if(c.hide){for(var d=0;d<=c.hide.length-1;d++){var e=$.inArray(c.hide[d],a.settings.showBlocks);if(e>0){a.settings.showBlocks.splice(e,1)}}}if(c.infoBlock){a.settings.infoBlock=c.infoBlock}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteGoods=function(){if(Routing.route=="goods"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update()})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteGoods()});EventDispatcher.AddEventListener("GoodsWidget.onload.info",function(b){a.Fill.Content(b)})};a.Update=function(){a.BaseLoad.InfoFavorite("no",function(b){Parameters.cache.favorite=b;a.BaseLoad.GoodsInfo(Routing.params.id,a.settings.infoBlock,function(c){EventDispatcher.DispatchEvent("GoodsWidget.onload.info",c)})})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.Fill={Content:function(c){a.goods=new GoodsViewModel();for(var b in c){if(typeof a.Fill[b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()]=="function"){a.Fill[b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()](c[b])}else{a.Fill.Block(b,c[b])}}a.goods.blocks.main.sellerId=c.seller.id;a.goods.blocks.main.shopId=c.shop.id;a.goods.SetListMoreBlock();a.Render.Goods(a.goods)},Main:function(c){GoodsMainBlockViewModel.prototype=new Widget();a.goods.AddBlock("main",new GoodsMainBlockViewModel(c));var b="description";a.goods.AddBlock(b,c.description);if(c.description&&c.description.match(/data-bind/)){a.hasButton=b}},Gallery:function(d){var b=[];for(var c=0;c<=d.length-1;c++){b[c]=new GalleryBlockViewModel(d[c])}a.goods.AddBlock("gallery",b)},Seller:function(b){a.goods.sellerInfo.seller=b},Shop:function(b){a.goods.sellerInfo.shop=b},Operator:function(b){a.goods.sellerInfo.operator=b},Block:function(c,e){var f=new MoreBlockViewModel(c);if(c=="shipping"){var b=[];for(var d in e){b.push(new ShippingBlockViewModel(e[d]))}e=b}f.AddParams(e);a.goods.AddBlock(c,f)}};a.Render={Goods:function(b){if($("#"+a.settings.containerId).length>0){try{a.InsertContainer.Content();ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);if(a.hasButton){$.each(b.moreBlock,function(e){if(b.moreBlock[e].key==a.hasButton){var d=$("#"+b.moreBlock[e].idBlock+" [data-bind^=click]");$.each(d,function(f){if(b.blocks.main.showAddToCart()){if($(d[f]).attr("data-bind").match(/AddToCart/)){var h=new AddToCartButtonViewModel(b.blocks.main);ko.applyBindings(h,d[f])}}else{$(d[f]).hide()}if(b.blocks.main.showBuy()){if($(d[f]).attr("data-bind").match(/Buy/)){var g=new BuyButtonViewModel(b.blocks.main);ko.applyBindings(g,d[f])}}else{$(d[f]).hide()}})}})}if(typeof AnimateGoods=="function"){new AnimateGoods()}if(a.settings.animate){a.settings.animate()}a.AddGoodsInCookie(b);delete b;a.WidgetLoader(true,a.settings.containerId)}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Goods(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}};a.AddGoodsInCookie=function(d){var b=$.cookie(Config.Base.cookie.previously_viewed);if(!b){$.cookie(Config.Base.cookie.previously_viewed,d.id)}else{var c=b.split(",");var e=$.inArray(d.id,c);if(e>=0){c.splice(e,1);c.unshift(d.id)}else{c.unshift(d.id)}if(c.length>20){c.splice(20,1)}$.cookie(Config.Base.cookie.previously_viewed,c.join(","))}var b=$.cookie(Config.Base.cookie.previously_viewed)};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.styleGoods[b]){a.settings.styleGoods[b]=a.settings.inputParameters[b]}}$().ready(function(){$("#"+a.settings.containerId).css(a.settings.styleGoods)})}}};var GoodsViewModel=function(){var a=this;a.id=Routing.params.id;a.blocks={};a.sellerInfo={};a.cssBlockGallery=Config.Goods.galleryId;a.moreBlock=[];a.ShowGallery=function(){if($.inArray("gallery",Config.Goods.showBlocks)>=0&&a.blocks.gallery){return true}return false};a.AddBlock=function(b,c){this.blocks[b]=c};a.SetListMoreBlock=function(){for(var b in Config.Goods.moreBlocks){if($.inArray(b,Config.Goods.showBlocks)>0){a.moreBlock.push(new GoodsListMoreBlockViewModel(b,a.blocks[b]))}}}};var GoodsListMoreBlockViewModel=function(b,c){var a=this;a.key=b;a.title=Config.Goods.moreBlocks[b];a.content=c?c:null;a.classTabs="goodsTabs";a.classBlocks="goodsBlocks";a.idTab=b+"Tab";a.idBlock=b+"Block";a.templateName="goods"+a.key.charAt(0).toUpperCase()+a.key.substr(1).toLowerCase()+"BlockTmpl";a.ClickLinck=function(){$("."+a.classBlocks).hide();$("#"+a.idBlock).show();$("."+a.classTabs).removeClass("active");$("#"+a.idTab).addClass("active")}};var GoodsMainBlockViewModel=function(b){var a=this;a.id=b.id;a.sellerId=0;a.shopId=0;a.chortName=b.chort_name;a.fullName=b.full_name;a.description=b.description;a.weight=b.weight;a.count=b.count;if(b.count_reserve){if(b.count>b.count_reserve){a.count=b.count-b.count_reserve}else{a.count=0}}a.isEgoods=ko.computed(function(){if(b.is_egoods=="yes"){return true}return false},this);a.inStock=ko.computed(function(){if(a.isEgoods()&&!a.count&&a.count!=0){return"Есть"}else{if(a.count&&a.count!=0){if(a.count>1){return"Да"}}else{return"Нет"}}},this);a.sellCost=b.sell_cost;a.keyWords=b.key_words;a.ratingGoods=b.rating_goods;a.sellEndCost=b.sell_end_cost;a.discount=ko.computed(function(){var c=Math.floor((a.sellCost-a.sellEndCost)*100/a.sellCost);if(c>0){return c+"%"}else{return""}},this);a.routeImages=b.route_image;a.routeBigImages=b.route_big_image;a.idAuction=b.id_auction;a.auctionPrice=b.last_cost;a.nameGroupUser=ko.computed(function(){if(b.name_group_user){return b.name_group_user}return null},this);a.ordered=ko.observable(1);a.cart=ko.observable(Parameters.cache.cart);a.uniq=EventDispatcher.GetUUID();a.cssToCart="goodsToCart_"+a.uniq;a.cssTitleToCart="goodsTilteToCart_"+a.uniq;a.cssShareBlock="share";a.Login=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{})};a.Registration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("registration","Регистрация пользователя",{step:1})};a.showSelectionCount=ko.computed(function(){if($.inArray("selectionCount",Config.Goods.showBlocks)>=0&&a.count&&a.count!=0){return true}return false},this);a.ClickPlus=function(){if(a.ordered()<a.count){a.ordered(a.ordered()+1)}else{a.ShowMessage(Config.Goods.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1)}};a.showAddToCart=ko.computed(function(){if($.inArray("addToCart",Config.Goods.showBlocks)>=0&&a.count!=0){return true}return false},this);a.AddToCart=function(c){Parameters.cache.cart=a.ordered();a.cart(a.cart()+a.ordered());EventDispatcher.DispatchEvent("widgets.cart.addGoods",{goodsId:a.id,sellerId:a.shopId,count:a.ordered(),hash:a.uniq})};a.showBuy=ko.computed(function(){if($.inArray("buy",Config.Goods.showBlocks)>=0&&a.count!=0){return true}return false},this);a.Buy=function(){if(Parameters.cache.userInformation.err){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"directly",sellerId:a.shopId,goodsId:a.id,count:a.ordered()}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:a.shopId,goodsId:a.id,count:a.ordered()})}};a.ReportAvailability=function(){};a.ToCart=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("cart",Config.CartGoods.title,{})};a.BidOnAuction=function(){};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowError(Config.Authentication.message.pleaseLogIn,false,false)}};a.comment=ko.observable("");a.AddCommentForm=function(){a.comment(" ");this.ShowCommentForm(a.comment(),function(c){a.comment(c);EventDispatcher.DispatchEvent("widgets.favorites.add",{goodsId:a.id,comment:a.comment(),data:a})})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.Gift=function(){};a.Remove=function(){}};var GalleryBlockViewModel=function(b){var a=this;a.id=b.id;a.title=b.name_photo;a.thumb=b.route_photo;a.image=b.route_big_photo};var ShippingBlockViewModel=function(b){var a=this;a.id=b.id;a.nameMethodShipping=b.name_method_shipping;a.descMethodShipping=b.desc_method_shipping;a.costShipping=ko.computed(function(){if(b.cost_shipping){return b.cost_shipping}return null},this)};var MoreBlockViewModel=function(b){var a=this;a.key=b;a.params=[];a.AddParams=function(d){for(var c in d){a.params.push(d[c])}}};var BuyButtonViewModel=function(b){var a=this;a.showBuy=ko.computed(function(){if(b.showAddToCart()){return true}return false},this);a.Buy=function(){Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:b.shopId,goodsId:b.id,count:b.ordered()})}};var AddToCartButtonViewModel=function(b){var a=this;a.showAddToCart=ko.computed(function(){if(b.showBuy()){return true}return false},this);a.AddToCart=function(c){Parameters.cache.cart=b.ordered();b.cart(b.cart()+b.ordered());EventDispatcher.DispatchEvent("widgets.cart.addGoods",{goodsId:b.id,sellerId:b.sellerId,count:b.ordered(),hash:b.uniq})}};var TestGoodsCrumb={Init:function(){if(typeof Widget=="function"){GoodsWidget.prototype=new Widget();var a=new GoodsWidget();a.Init(a)}else{setTimeout(function(){TestGoodsCrumb.Init()},100)}}};TestGoodsCrumb.Init();
var UserInformationWidget=function(){var a=this;a.widgetName="UserInformationWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,tmpl:{path:null,id:{info:null,auth:null}},animate:null,inputParameters:{},showBlocks:null,style:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.userInformation.widget;a.settings.customContainer=Config.Containers.userInformation.customClass;a.settings.tmpl=Config.UserInformation.tmpl;a.settings.showBlocks=Config.UserInformation.showBlocks;a.settings.style=Config.UserInformation.style;a.RegisterEvents();a.SetInputParameters();a.LoadTmpl();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/UserInformationWidget/);if(b.userInformation){c=b.userInformation}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.userInformation){c=WParameters.userInformation}if(!$.isEmptyObject(c)){if(c.show){for(var d=0;d<=c.show.length-1;d++){if($.inArray(c.show[d],a.settings.showBlocks)<0){a.settings.showBlocks.push(c.show[d])}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.LoadTmpl=function(){a.BaseLoad.Tmpl(a.settings.tmpl,function(){EventDispatcher.DispatchEvent("onload.userInformation.tmpl")})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("onload.userInformation.tmpl",function(){a.BaseLoad.Login(false,false,false,function(b){a.CheckAuthorization(b)})});EventDispatcher.AddEventListener("widget.authentication.ok",function(b){a.CheckAuthorization(b.request)});EventDispatcher.AddEventListener("UserInformationWidget.click.logout",function(){a.BaseLoad.Logout(function(b){if(b.result=="ok"||b.result=="fail"){a.BaseLoad.LogoutForProxy();Routing.SetHash("default","Домашняя",{})}})});EventDispatcher.AddEventListener("widget.change.route",function(b){a.BaseLoad.Tmpl(a.settings.tmpl,function(){EventDispatcher.DispatchEvent("onload.userInformation.tmpl")})})};a.CheckAuthorization=function(b){if(Routing.IsDefault()&&a.HasDefaultContent()){a.WidgetLoader(true)}else{if(!b.err){a.InsertContainer.InfoBlock();a.Fill.InfoBlock(b)}else{a.InsertContainer.AuthBlock();a.Fill.AuthBlock()}}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},AuthBlock:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("auth")).html()).children().hide()},InfoBlock:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("info")).html()).children().hide()}};a.Fill={AuthBlock:function(){var b=new UserAuthorizationBlockViewModel();a.Render.AuthBlock(b)},InfoBlock:function(b){a.BaseLoad.MessageCountUnread(function(c){Parameters.cache.message.countNewMessage(parseInt(c.count_unread_topic));UserInformationBlockViewModel.prototype=new Widget();var d=new UserInformationBlockViewModel(b);a.Render.InfoBlock(d)})}};a.Render={AuthBlock:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateUserInformation=="function"){new AnimateUserInformation()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("auth")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.AuthBlock();a.Render.AuthBlock(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},InfoBlock:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateUserInformation=="function"){new AnimateUserInformation()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Error of the template ["+a.GetTmplName("info")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.InfoBlock();a.Render.InfoBlock(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var UserAuthorizationBlockViewModel=function(){var a=this;a.ClickLogin=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{})};a.ClickRegistration=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("registration","Регистрация пользователя",{step:1})}};var UserInformationBlockViewModel=function(b){var a=this;a.email=b.email;a.login=b.login;a.phone=b.phone;a.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);a.showIcon=function(){if(!b.route_icon_user||$.inArray("icon",Config.UserInformation.showBlocks)<0){return false}return true};a.iconUser=b.route_icon_user;a.background="background: url('"+a.iconUser+"')";a.backgroundImage="background-image: url('"+a.iconUser+"')";a.showRaiting=function(){if($.inArray("raiting",Config.UserInformation.showBlocks)<0){return false}return true};a.ratingUser=b.rating_user;a.showProfile=function(){if($.inArray("profile",Config.UserInformation.showBlocks)<0){return false}return true};a.ClickLogout=function(){a.Confirm(Config.Authentication.message.confirmLogOut,function(){Loader.Indicator("UserInformationWidget",false);EventDispatcher.DispatchEvent("UserInformationWidget.click.logout")},false)};a.ClickPrivateOffice=function(){Routing.SetHash("profile","Личный кабинет",{})};a.ClickMessages=function(){Routing.SetHash("messages","Сообщения",{})};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickPurchases=function(){Routing.SetHash("purchases","Мои покупки",{block:"list"})};a.ClickProfile=function(){Routing.SetHash("profile","Личный кабинет",{})}};var TestUserInformation={Init:function(){if(typeof Widget=="function"){UserInformationWidget.prototype=new Widget();var a=new UserInformationWidget();a.Init(a)}else{setTimeout(function(){TestUserInformation.Init()},100)}}};TestUserInformation.Init();
var CartWidget=function(){var a=this;a.widgetName="CartWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={title:null,tmpl:{path:null,id:null},animate:null,inputParameters:{},containerId:null,showBlocks:null,style:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.cart.widget;a.settings.customContainer=Config.Containers.cart.customClass;a.settings.title=Config.Cart.title;a.settings.tmpl=Config.Cart.tmpl;a.settings.style=Config.Cart.style;a.settings.showBlocks=Config.Cart.showBlocks;a.RegisterEvents();a.SetInputParameters();a.LoadTmpl();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/CartWidget/);if(b.cart){c=b.cart}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.cart){c=WParameters.cart}if(!$.isEmptyObject(c)){if(c.show){for(var d in c.show){a.settings.showBlocks[d]=c.show[d]}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Main:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.settings.tmpl.id).html()).children().hide()}};a.CheckRoute=function(){if(Routing.IsDefault()&&a.HasDefaultContent()){a.WidgetLoader(true)}else{a.BaseLoad.CartInfo("",function(b){if(a.settings.showBlocks.fullInfo){a.BaseLoad.CartGoods("",function(c){a.InsertContainer.Main();a.Fill({info:b,goods:c})})}else{a.InsertContainer.Main();a.Fill({info:b})}})}};a.LoadTmpl=function(){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.CheckRoute()})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.authentication.ok",function(){a.LoadTmpl()});EventDispatcher.AddEventListener("widget.change.route",function(b){a.LoadTmpl()});EventDispatcher.AddEventListener("widgets.cart.infoUpdate",function(b){a.LoadTmpl()});EventDispatcher.AddEventListener("widgets.cart.clear",function(c){var b=c.goodsId?c.goodsId:false;a.BaseLoad.ClearCart(c.sellerId,b,function(d){})})};a.Fill=function(b){var c=new CartViewModel();c.AddContent(b);a.Render(c)};a.Render=function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateCart=="function"){new AnimateCart()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Main();a.Render(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var CartViewModel=function(){var a=this;a.title=Config.Cart.title;a.goods=ko.observableArray();a.isAuthorized=ko.computed(function(){if(Parameters.cache.userInformation&&!Parameters.cache.userInformation.err){return true}return false},this);a.ShowTitle=ko.computed(function(){if(Config.Cart.showBlocks.title=="never"){return false}if(Config.Cart.showBlocks.title=="always"){return true}if(Config.Cart.showBlocks.title=="empty"){return true}return false},this);a.count=ko.observable(0);a.ShowCount=ko.computed(function(){if(Config.Cart.showBlocks.count&&a.count()>0){return true}return false},this);a.baseCost=ko.observable(0);a.ShowBaseCost=ko.computed(function(){if(Config.Cart.showBlocks.baseCost&&a.baseCost()>0&&a.baseCost()>a.finalCost()){return true}return false},this);a.finalCost=ko.observable(0);a.ShowFinalCost=ko.computed(function(){if(Config.Cart.showBlocks.finalCost&&a.finalCost()>0){return true}return false},this);a.AddContent=function(c){var d=c.info;var b=c.goods;if(!d.err){a.count(d.count);a.baseCost(d.base_cost);a.finalCost(d.final_cost)}if(b&&!b.err){$.each(b,function(e){$.each(b[e].goods,function(f){a.goods.push(new ShortBlockCartGoodsSellersViewModel(b[e].goods[f],a))})})}};a.ClickCart=function(){if(a.count()>0){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("cart",Config.CartGoods.title,{})}};a.ClickIssueOrder=function(){if(a.count()>0){Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}}};var ShortBlockCartGoodsSellersViewModel=function(b,c){var a=this;a.id=b.id;a.fullName=b.full_name;a.countReserv=b.count_reserv;a.count=b.count;a.sellCost=ko.observable(b.sell_cost);a.sellEndCost=ko.observable(b.sell_end_cost);a.routeImages=b.route_image;a.routeBigImages=b.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.CartItog=ko.computed(function(){var d=0;$.each(c.goods(),function(e){d=d+parseInt(c.goods()[e].endSum(),10)});c.finalCost(d);return d},this);a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);a.CartItog();c.count(c.count()+1)}};a.ClickMinus=function(){if(a.ordered()>1){a.ordered(a.ordered()-1);a.CartItog();c.count(c.count()-1)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){EventDispatcher.DispatchEvent("widgets.cart.clear",{goodsId:a.id,sellerId:false});c.goods;c.goods.remove(a);c.count(c.count()-a.ordered())}};var TestCart={Init:function(){if(typeof Widget=="function"){CartWidget.prototype=new Widget();var a=new CartWidget();a.Init(a)}else{setTimeout(function(){TestCart.Init()},100)}}};TestCart.Init();
var CartGoodsWidget=function(){var a=this;a.widgetName="CartGoodsWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.cart=null;a.settings={tmpl:{path:null,content:null,empty:null},animate:null,inputParameters:{},style:null,containerId:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.cartGoods.widget;a.settings.customContainer=Config.Containers.cartGoods.customClass;a.settings.tmpl=Config.CartGoods.tmpl;a.settings.style=Config.CartGoods.style;a.RegisterEvents();a.SetInputParameters();a.CheckCartGoodsRoute();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/CartGoodsWidget/);if(b.cartGoods){c=b.cartGoods}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.cartGoods){c=WParameters.cartGoods}if(!$.isEmptyObject(c)){if(c.show){for(var d=0;d<=c.show.length-1;d++){if($.inArray(c.show[d],a.settings.showBlocks)<0){a.settings.showBlocks.push(c.show[d])}}}if(c.hide){for(var d=0;d<=c.hide.length-1;d++){var e=$.inArray(c.hide[d],a.settings.showBlocks);if(e>0){a.settings.showBlocks.splice(e,1)}}}if(c.animate){a.settings.animate=c.animate}}};a.CheckCartGoodsRoute=function(){if(Routing.route=="cart"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update()})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckCartGoodsRoute()});EventDispatcher.AddEventListener("CartGoods.onload.info",function(b){if(!b.err){a.InsertContainer.Content();a.Fill.Content(b)}else{a.InsertContainer.EmptyCart();a.Render.EmptyCart()}});EventDispatcher.AddEventListener("CartGoods.change.count",function(b){a.BaseLoad.AddGoodsToCart(b.goodsId,b.sellerId,b.count,function(c){EventDispatcher.DispatchEvent("widgets.cart.infoUpdate",c);b.sellCost=c.sell_cost;b.sellEndCost=c.sell_end_cost})});EventDispatcher.AddEventListener("CartGoods.clear",function(c){var b=c.goodsId?c.goodsId:false;a.BaseLoad.ClearCart(c.sellerId,b,function(d){EventDispatcher.DispatchEvent("widgets.cart.infoUpdate",d)})});EventDispatcher.AddEventListener("CartGoods.empty.cart",function(){a.InsertContainer.EmptyCart();a.Render.EmptyCart()})};a.Update=function(){a.WidgetLoader(false);a.BaseLoad.InfoFavorite("no",function(b){Parameters.cache.favorite=b;a.BaseLoad.CartGoods("",function(c){EventDispatcher.DispatchEvent("CartGoods.onload.info",c)})})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("content")).html()).children().hide()},EmptyCart:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("empty")).html()).children().hide()}};a.Fill={Content:function(e){var d=new CartGoodsViewModel();for(var b in e){BlockGoodsForSellerViewModel.prototype=new Widget();a.cart=new BlockGoodsForSellerViewModel(d);for(var c in e[b]){if(typeof a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()]=="function"){a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()](e[b][c])}}d.AddContent(a.cart)}a.Render.Content(d)},Goods:function(b){a.cart.AddContent(b)},Seller:function(b){a.cart.sellerInfo.seller=b},Shop:function(b){a.cart.sellerInfo.shop=b},Operator:function(b){a.cart.sellerInfo.operator=b},Final_cost:function(b){a.cart.finalCost=b}};a.Render={Content:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateCartGoods=="function"){new AnimateCartGoods()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},EmptyCart:function(){a.WidgetLoader(true);if(a.settings.animate){a.settings.animate()}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockGoodsForSellerViewModel=function(b){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var d=0;if(a.goods().length>0){for(var c=0;c<=a.goods().length-1;c++){d=d+parseFloat(a.goods()[c].endSum())}}return d.toFixed(2)},this);a.totalSum=ko.computed(function(){var d=0;if(a.goods().length>0){for(var c=0;c<=a.goods().length-1;c++){d=d+parseFloat(a.goods()[c].sum())}}return d.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.AddContent=function(d){for(var c=0;c<=d.length-1;c++){BlockCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCartGoodsSellersViewModel(d[c],a,b))}a.finalCost=d.final_cost};a.comment=ko.observable();a.ClickButchFavorites=function(){var c=[];ko.utils.arrayForEach(a.goods(),function(d){if(d.isSelected()){c.push(d)}});a.AddCommentForm(c)};a.AddCommentForm=function(c){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){var d=[];$.each(c,function(e){d[e]=c[e].id});EventDispatcher.DispatchEvent("widgets.favorites.add",{goodsId:d.join(","),comment:a.comment(),data:c});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(Config.CartGoods.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var c=[];var d=[];var f=a.goods().length-1;for(var e=0;e<=f;e++){if(a.goods()[e].isSelected()){c.push(a.goods()[e].id);d.push(a.goods()[e])}}for(var e in d){a.goods.remove(d[e])}EventDispatcher.DispatchEvent("CartGoods.clear",{goodsId:c.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){b.sellerBlock.remove(a)}if(b.sellerBlock().length==0){EventDispatcher.DispatchEvent("CartGoods.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){var c=Parameters.cache.lastPage;if(c.route!="cart"){Routing.SetHash(c.route,c.title,c.data)}else{Routing.SetHash("default","Домашняя",{})}};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation.err){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(Config.CartGoods.message.confirmClearCart,function(){var e=a.goods().length-1;var c=[];for(var d=0;d<=e;d++){c.push(a.goods()[d])}for(var d in c){a.goods.remove(c[d])}b.sellerBlock.remove(a);EventDispatcher.DispatchEvent("CartGoods.clear",{sellerId:a.sellerInfo.shop.id});if(b.sellerBlock().length==0){EventDispatcher.DispatchEvent("CartGoods.empty.cart")}})};a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(c){ko.utils.arrayForEach(a.goods(),function(d){$("#"+d.cssCheckboxGoods())[0].checked=c;d.isSelected(c)})});a.ClickSelectAll=function(f){var d=$("#"+a.cssSelectAll);var c=d.is(":checked");var e;if(c){d[0].checked=false;e=false}else{d[0].checked=true;e=true}ko.utils.arrayForEach(a.goods(),function(g){$("#"+g.cssCheckboxGoods())[0].checked=e;g.isSelected(e)})};a.isDisabledButton=ko.computed(function(){var c=a.goods().length;var e=[];for(var d=0;d<=c-1;d++){if(a.goods()[d].isSelected()){e.push(a.goods()[d].id)}}if(e.length>0){return false}return true},this)};var BlockCartGoodsSellersViewModel=function(c,d,b){var a=this;a.sellerId=d.sellerInfo.seller.id;a.id=c.id;a.fullName=c.full_name;a.countReserv=c.count_reserv;a.count=c.count;a.sellCost=ko.observable(c.sell_cost);a.sellEndCost=ko.observable(c.sell_end_cost);a.routeImages=c.route_image;a.routeBigImages=c.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(f){var e=d.goods().length;var h=[];for(var g=0;g<=e-1;g++){if(d.goods()[g].isSelected()){h.push(d.goods()[g].id)}}if(h.length<e){$("#"+d.cssSelectAll)[0].checked=false}else{$("#"+d.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(e,g){var f=$("#"+e.cssCheckboxGoods());var h=f.is(":checked");if(h==false){f[0].checked=true;a.isSelected(true)}else{f[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var e=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(e>0){return e+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);EventDispatcher.DispatchEvent("CartGoods.change.count",{goodsId:a.id,sellerId:a.sellerId,count:a.ordered()},a)}else{a.ShowMessage(Config.Goods.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);EventDispatcher.DispatchEvent("CartGoods.change.count",{goodsId:a.id,sellerId:a.sellerId,count:a.ordered()},a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(Config.Authentication.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(Config.CartGoods.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){EventDispatcher.DispatchEvent("CartGoods.clear",{goodsId:a.id,sellerId:a.sellerId});d.goods.remove(a);if(d.goods().length==0){b.sellerBlock.remove(d);if(b.sellerBlock().length==0){EventDispatcher.DispatchEvent("CartGoods.empty.cart")}}};a.AddCommentForm=function(){d.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){EventDispatcher.DispatchEvent("widgets.favorites.add",{goodsId:a.id,comment:d.comment(),data:a});a.IsFavorite(true);$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}};var TestCartGoods={Init:function(){if(typeof Widget=="function"){CartGoodsWidget.prototype=new Widget();var a=new CartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCartGoods.Init()},100)}}};TestCartGoods.Init();
var ProfileWidget=function(){var a=this;a.widgetName="ProfileWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerFormId:null,tmpl:{path:null,id:{personal:null,delivery:null,deliveryForm:null,security:null}},animate:null,inputParameters:{},geoShop:0,style:null,customContainer:null};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.profile.widget;a.settings.customContainer=Config.Containers.profile.customClass;a.settings.tmpl=Config.Profile.tmpl;a.settings.style=Config.Profile.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteProfile();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/ProfileWidget/);if(b.profile){c=b.profile}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.profile){c=WParameters.profile}if(!$.isEmptyObject(c)){if(c.geoShop){a.settings.geoShop=c.geoShop}if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){for(var d in c.tmpl.id){a.settings.tmpl.id[d]=c.tmpl.id[d]}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteProfile=function(){if(Routing.route=="profile"){a.WidgetLoader(false);a.BaseLoad.Login(false,false,false,function(b){if(!b.err){Loader.Indicator("MenuPersonalCabinetWidget",false);a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(!Routing.params.info||Routing.params.info==Config.Profile.menu.personalInformation.prefix){a.Info.Personal()}if(Routing.params.info==Config.Profile.menu.deliveryAddress.prefix&&!Routing.params.form){a.Info.Delivery()}if(Routing.params.info==Config.Profile.menu.deliveryAddress.prefix&&Routing.params.form=="add"){a.Info.DeliveryForm()}if(Routing.params.info==Config.Profile.menu.security.prefix){a.Info.Security()}a.Info.Menu()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});a.WidgetLoader(true)}})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteProfile()});EventDispatcher.AddEventListener("ProfileWidget.personal.checking",function(d){var c=d.birthDayField().split(".");var b=c[2]+"-"+c[1]+"-"+c[0];d.birthDayHiddenField(b);a.BaseLoad.EditProfile($("form#"+d.cssRegistrationDataForm),function(e){if(e.result=="ok"){a.ShowMessage(Config.Profile.message.editProfile,function(){Parameters.cache.profile.personal={};Parameters.cache.userInformation=null;Parameters.cache.profile.info={};window.location.reload(true)},false)}else{if(!e.err){e.err=Config.Profile.message.failEditProfile}a.QueryError(e,function(){EventDispatcher.DispatchEvent("ProfileWidget.personal.checking",d)})}})});EventDispatcher.AddEventListener("ProfileWidget.postalAddress.checking",function(b){var c="?id_country="+encodeURIComponent($.trim(b.country().id));if(b.region()&&b.region().regioncode){c=c+"&code_region="+encodeURIComponent($.trim(b.region().regioncode))}else{c=c+"&name_region="+encodeURIComponent($.trim(b.customRegion()))}if(b.city()&&b.city().aoguid){c=c+"&code_city="+encodeURIComponent($.trim(b.city().aoguid))}else{c=c+"&name_city="+encodeURIComponent($.trim(b.customCity()))}c=c+"&address="+encodeURIComponent($.trim(b.customAddress()))+"&post_code="+encodeURIComponent($.trim(b.postIndex()));a.BaseLoad.EditAddress(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Profile.message.editProfile,function(){Parameters.cache.profile.personal={};b.countryText(b.country().name);b.regionText(b.customRegion());b.cityText(b.customCity());b.addressText(b.customAddress());b.postIndexText(b.postIndex());b.isEditBlock(0)},false)}else{if(!d.err){d.err=Config.Profile.message.failEditProfile}a.QueryError(d,function(){EventDispatcher.DispatchEvent("ProfileWidget.postalAddress.checking",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.send.token",function(b){a.BaseLoad.SendToken(b,function(c){if(c.result=="ok"){a.ShowMessage(Config.Profile.message.sendToken,false,false)}else{if(!c.err){c.err=Config.Profile.message.failSendToken}a.QueryError(c,function(){EventDispatcher.DispatchEvent("ProfileWidget.send.token",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.submit.token",function(c){var b=Parameters.cache.userInformation;var e=[];e.push("username="+encodeURIComponent(b.login));if(c.type=="mail"){e.push("mail_token="+c.value.emailToken())}if(c.type=="sms"){e.push("sms_token="+c.value.phoneToken())}var d="?"+e.join("&");a.BaseLoad.ActivateUser(d,function(f){Parameters.cache.profile.info={};var g=true;if(a.QueryError(f,function(){EventDispatcher.DispatchEvent("ProfileWidget.submit.token",c)})){if(a.Validate.MailToken(f,c.value)){c.value.emailIsConfirm(true)}if(a.Validate.PhoneToken(f,c.value)){c.value.phoneIsConfirm(true)}}})});EventDispatcher.AddEventListener("ProfileWidget.contacts.checking",function(b){var c="?";if(b.email()&&!b.emailIsConfirm()){c=c+"email="+encodeURIComponent(b.email())}if(b.phone()){c=c+"&phone="+encodeURIComponent(b.phone())}a.BaseLoad.EditContacts(c,function(d){if(d.result=="ok"){b.sentCode(true);setTimeout(function(){b.isExistPhone(true)},60000);b.sentEmailCode(true);setTimeout(function(){b.isExistMail(true)},60000);a.ShowMessage(Config.Profile.message.contactsEdit,false,false)}else{if(!d.err){d.err=Config.Profile.message.failContactsEdit}a.QueryError(d,function(){EventDispatcher.DispatchEvent("ProfileWidget.contacts.checking",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.password.change",function(b){a.BaseLoad.ChangePassword($("form#"+b.cssSequrityForm),function(c){if(c.result=="ok"){b.oldPassword(null);b.newPassword(null);b.confirmPassword(null);a.ShowMessage(Config.Profile.message.changePassword,false,false)}else{if(!c.err){c.err=Config.Profile.message.failChangePassord}a.QueryError(c,function(){EventDispatcher.DispatchEvent("ProfileWidget.password.change",b)},function(){b.oldPassword(null);b.newPassword(null);b.confirmPassword(null)})}})});EventDispatcher.AddEventListener("ProfileWidget.delivery.add",function(b){var c="?id_country="+encodeURIComponent($.trim(b.country().id));if(b.region()&&b.region().regioncode){c=c+"&code_region="+encodeURIComponent($.trim(b.region().regioncode))}else{c=c+"&name_region="+encodeURIComponent($.trim(b.customRegion()))}if(b.city()&&b.city().aoguid){c=c+"&code_city="+encodeURIComponent($.trim(b.city().aoguid))}else{c=c+"&name_city="+encodeURIComponent($.trim(b.customCity()))}c=c+"&address="+encodeURIComponent($.trim(b.customAddress()))+"&post_code="+encodeURIComponent($.trim(b.postIndex()))+"&addressee="+encodeURIComponent($.trim(b.addressee()))+"&contact_phone="+encodeURIComponent($.trim(b.contactPhone()))+"&is_default="+encodeURIComponent(b.isDefault()?"yes":"no");a.BaseLoad.AddDelivaryAddress(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Profile.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!d.err){d.err=Config.Profile.message.failAddAddressDelivery}a.QueryError(d,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.delivery.saveEdit",function(b){var c="?id_address="+b.id()+"&id_country="+encodeURIComponent($.trim(b.country().id));if(b.region()&&b.region().regioncode){c=c+"&code_region="+encodeURIComponent($.trim(b.region().regioncode))}else{c=c+"&name_region="+encodeURIComponent($.trim(b.customRegion()))}if(b.city()&&b.city().aoguid){c=c+"&code_city="+encodeURIComponent($.trim(b.city().aoguid))}else{c=c+"&name_city="+encodeURIComponent($.trim(b.customCity()))}c=c+"&address="+encodeURIComponent($.trim(b.customAddress()))+"&post_code="+encodeURIComponent($.trim(b.postIndex()))+"&addressee="+encodeURIComponent($.trim(b.addressee()))+"&contact_phone="+encodeURIComponent($.trim(b.contactPhone()))+"&is_default="+encodeURIComponent(b.isDefault()?"yes":"no");a.BaseLoad.EditDelivaryAddress(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Profile.message.addAddressDelivery,function(){Parameters.cache.delivery=null;Routing.SetHash("profile","Личный кабинет",{info:"delivery"})},false)}else{if(!d.err){d.err=Config.Profile.message.failAddAddressDelivery}a.QueryError(d,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.delivery.delete",function(b){a.BaseLoad.DeleteDeliveryAddress(b.address.id,function(c){if(c.result=="ok"){a.ShowMessage(Config.Profile.message.deleteAddressDelivery,function(){Parameters.cache.delivery=null;b.list.addressList.remove(b.address)},false)}else{if(!c.err){c.err=Config.Profile.message.failDeleteAddressDelivery}a.QueryError(c,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.delete",b)})}})});EventDispatcher.AddEventListener("ProfileWidget.delivery.edit",function(c){var b=new DeliveryAddressFormViewModel();b.AddContent(c);a.Fill.DeliveryForm(b)});EventDispatcher.AddEventListener("ProfileWidget.delivery.sedDefault",function(b){var c="?id_address="+b.id+"&is_default=yes";a.BaseLoad.SetDefaultDelivaryAddress(c,function(d){if(d.result=="ok"){}else{a.QueryError(d,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.sedDefault",b)})}})})};a.Validate={Username:function(c,b){var d=false;if(c.check_username){if(c.check_username=="on"||c.check_username=="ban"||c.check_username=="off"){b.errorUsername(Config.Registration.error.username.uniq)}if(c.check_username=="yes"){d=true}}return d},Phone:function(c,b){var d=false;if(c.check_phone){if(c.check_phone=="on"||c.check_phone=="ban"||c.check_phone=="off"){b.errorPhone(Config.Registration.error.phone.uniq)}if(c.check_phone=="yes"){d=true}}else{d=true}return d},Email:function(c,b){var d=false;if(c.check_email){if(c.check_email=="on"||c.check_email=="ban"||c.check_email=="off"){b.errorEmail(Config.Registration.error.email.uniq)}if(c.check_email=="yes"){d=true}}return d},MailToken:function(c,b){if(c.confirm_email){if(c.confirm_email=="no"){b.errorEmailConfirm(Config.Profile.error.emailToken.confirm);return false}}return true},PhoneToken:function(c,b){if(c.confirm_phone){if(c.confirm_phone=="no"){b.errorPhoneConfirm(Config.Profile.error.phoneToken.confirm);return false}}return true},Profile:function(c,b){if(c.err){b.errorAddress(c.err);return false}return true},Address:function(b,c){if(b.err){c.errorAddress(b.err);return false}return true}};a.Info={Menu:function(){a.BaseLoad.Script("widgets/MenuPersonalCabinetWidget-1.1.js",function(){if(!Routing.params.info){Routing.params.info=Config.Profile.menu.personalInformation.prefix}EventDispatcher.DispatchEvent("widget.onload.menuPersonalCabinet",{menu:Config.Profile.menu,active:Routing.params.info})})},Personal:function(){a.InsertContainer.Personal();a.BaseLoad.Script("widgets/ContentViewModel-1.0.js",function(){a.BaseLoad.Profile(function(b){a.BaseLoad.ProfileInfo(function(c){a.Fill.Personal(b,c)})})})},Delivery:function(){a.BaseLoad.DeliveryAddressList(function(b){a.InsertContainer.Delivery();a.Fill.Delivery(b)})},DeliveryForm:function(){a.BaseLoad.Script("widgets/ContentViewModel-1.0.js",function(){var b=new DeliveryAddressFormViewModel();a.Fill.DeliveryForm(b)})},Security:function(){a.InsertContainer.Security();a.Fill.Security()}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},Personal:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("personal")).html()).children().hide()},Delivery:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("delivery")).html()).children().hide()},DeliveryForm:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("deliveryForm")).html()).children().hide()},Security:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("security")).html()).children().hide()}};a.Fill={Personal:function(e,c){var b=new ProfilePersonalInformationViewModel();var d=Parameters.shopId;if(a.settings.geoShop==0){d=0}a.BaseLoad.Country(d,function(f){b.AddContent(e,c,f);a.Render.Personal(b)})},Delivery:function(b){var c=new ProfileDeliveryAddressViewModel();c.AddContent(b);a.Render.DeliveryList(c)},DeliveryForm:function(c){var b=Parameters.shopId;if(a.settings.geoShop==0){b=0}a.BaseLoad.Country(b,function(d){c.AddCountryList(d);a.InsertContainer.DeliveryForm();a.Render.DeliveryForm(c)})},Security:function(){var b=new ProfileSecurityViewModel();a.Render.Security(b)}};a.Render={Personal:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);$("#"+b.postalAddress.cssCountryList).change(function(){var d=$("#"+b.postalAddress.cssCountryList+" option:selected").val();$.grep(b.postalAddress.countryList(),function(e){if(e.id==d){b.postalAddress.country(e);b.postalAddress.customRegion(null);b.postalAddress.region(null);b.postalAddress.customCity(null);b.postalAddress.city(null);b.postalAddress.customAddress(null);b.postalAddress.address(null);b.postalAddress.postIndex(null)}})});$("#"+b.postalAddress.cssRegionList).autocomplete({source:function(e,d){a.BaseLoad.Region(b.postalAddress.country().id+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.formalname+" "+g.shortname),region:g}}))}else{$("#"+b.postalAddress.cssRegionList).autocomplete("close");return false}})},select:function(d,e){b.postalAddress.region(e.item.region);b.postalAddress.customRegion(e.item.value);if(e.item.region&&e.item.region.postalcode!=0){b.postalAddress.postIndex(e.item.region.postalcode)}else{b.postalAddress.postIndex(null)}}});$("#"+b.postalAddress.cssCityList).autocomplete({source:function(e,d){if(b.postalAddress.region()){a.BaseLoad.City(b.postalAddress.country().id+"/"+encodeURIComponent(b.postalAddress.region().regioncode)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),city:g}}))}else{$("#"+b.postalAddress.cssCityList).autocomplete("close");return false}})}},select:function(d,e){b.postalAddress.city(e.item.city);b.postalAddress.customCity(e.item.value);if(e.item.city&&e.item.city.postalcode!=0){b.postalAddress.postIndex(e.item.city.postalcode)}else{b.postalAddress.postIndex(null)}}});$("#"+b.postalAddress.cssAddress).autocomplete({source:function(e,d){if(b.postalAddress.region()){a.BaseLoad.Street(b.postalAddress.country().id+"/"+encodeURIComponent(b.postalAddress.region().regioncode)+"/"+encodeURIComponent(b.postalAddress.city().aoguid)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),street:g}}))}else{$("#"+b.postalAddress.cssAddress).autocomplete("close");return false}})}},select:function(d,e){b.postalAddress.address(e.item.street);b.postalAddress.customAddress(e.item.value);if(e.item.street&&e.item.street.postalcode!=0){b.postalAddress.postIndex(e.item.street.postalcode)}else{b.postalAddress.postIndex(null)}}});$("#"+b.postalAddress.cssRegionList).bind("textchange",function(e,d){b.postalAddress.customRegion($(this).val());b.postalAddress.customCity(null);b.postalAddress.city(null);b.postalAddress.customAddress(null);b.postalAddress.address(null);b.postalAddress.postIndex(null)});$("#"+b.postalAddress.cssCityList).bind("textchange",function(e,d){b.postalAddress.customCity($(this).val());b.postalAddress.customAddress(null);b.postalAddress.address(null);b.postalAddress.postIndex(null)});a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateProfile=="function"){new AnimateProfile()}if(a.settings.animate){a.settings.animate()}if(Routing.params.edit=="postal_address"){a.ScrollTop(b.postalAddress.cssPostAddressForm,700)}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("personal")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Personal();a.Render.Personal(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},DeliveryList:function(c){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(c,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateProfile=="function"){new AnimateProfile()}if(a.settings.animate){a.settings.animate()}}catch(b){a.Exception("Ошибка шаблона ["+a.GetTmplName("delivery")+"]",b);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Delivery();a.Render.DeliveryList(c)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},DeliveryForm:function(c){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(c,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);$("#"+c.cssRegionList).autocomplete({source:function(e,d){a.BaseLoad.Region(c.country().id+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.formalname+" "+g.shortname),region:g}}))}else{$("#"+c.cssRegionList).autocomplete("close");return false}})},select:function(d,e){c.region(e.item.region);c.customRegion(e.item.value);if(e.item.region&&e.item.region.postalcode!=0){c.postIndex(e.item.region.postalcode)}else{c.postIndex(null)}}});$("#"+c.cssCityList).autocomplete({source:function(e,d){if(c.region()){a.BaseLoad.City(c.country().id+"/"+encodeURIComponent(c.region().regioncode)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),city:g}}))}else{$("#"+c.cssCityList).autocomplete("close");return false}})}},select:function(d,e){c.city(e.item.city);c.customCity(e.item.value);if(e.item.city&&e.item.city.postalcode!=0){c.postIndex(e.item.city.postalcode)}else{c.postIndex(null)}}});$("#"+c.cssAddress).autocomplete({source:function(e,d){if(c.region()){a.BaseLoad.Street(c.country().id+"/"+encodeURIComponent(c.region().regioncode)+"/"+encodeURIComponent(c.city().aoguid)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),street:g}}))}else{$("#"+c.cssAddress).autocomplete("close");return false}})}},select:function(d,e){c.address(e.item.street);c.customAddress(e.item.value);if(e.item.street&&e.item.street.postalcode!=0){c.postIndex(e.item.street.postalcode)}else{c.postIndex(null)}}});$("#"+c.cssCountryList).change(function(){var d=$("#"+c.cssCountryList+" option:selected").val();$.grep(c.countryList(),function(e){if(e.id==d){c.country(e);c.customRegion(null);c.region(null);c.customCity(null);c.city(null);c.customAddress(null);c.address(null);c.postIndex(null)}})});$("#"+c.cssRegionList).bind("textchange",function(e,d){c.customRegion($(this).val());c.customCity(null);c.city(null);c.customAddress(null);c.address(null);c.postIndex(null)});$("#"+c.cssCityList).bind("textchange",function(e,d){c.customCity($(this).val());c.customAddress(null);c.address(null);c.postIndex(null)});if(typeof AnimateProfile=="function"){new AnimateProfile()}if(a.settings.animate){a.settings.animate()}}catch(b){a.Exception("Ошибка шаблона ["+a.GetTmplName("deliveryForm")+"]",b);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.DeliveryForm();a.Render.DeliveryForm(c)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Security:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateProfile=="function"){new AnimateProfile()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("security")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Security();a.Render.Security(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerFormId).length>0){$("#"+a.settings.containerFormId).css(a.settings.style)}})}}};var ProfilePersonalInformationViewModel=function(){var a=this;a.registrationData=null;a.postalAddress=null;a.contacts=null;a.AddContent=function(f,b,g){var e=new ProfileDataRegistrationViewModel();if(!f.err){e.AddContent(f)}e.dateRegistration(b.date_reg);a.registrationData=e;var d=new ProfilePostalAddressViewModel();d.AddCountryList(g);if(!f.err){d.AddContent(f)}a.postalAddress=d;a.contacts=new ProfileContactsViewModel();a.contacts.AddContent()}};var ProfileDataRegistrationViewModel=function(){var a=this;a.data=null;a.username=ko.observable();a.dateRegistration=ko.observable();a.gender=ko.observable();a.genderText=ko.computed(function(){if(a.gender()=="m"){return"мужской"}else{return"женский"}},this);a.errorGender=ko.observable(null);a.lastName=ko.observable();a.firstName=ko.observable();a.middleName=ko.observable();a.fullName=ko.computed(function(){var b="";if(a.lastName()){b=b+a.lastName()}if(a.firstName()){b=b+" "+a.firstName()}if(a.middleName()){b=b+" "+a.middleName()}return b},this);a.birthDay=ko.observable();a.cssBirthDay="birthDay";a.rating=ko.observable();a.checkInfo=ko.observable();a.lastNameField=ko.observable();a.firstNameField=ko.observable();a.middleNameField=ko.observable();a.birthDayField=ko.observable();a.birthDayHiddenField=ko.observable();a.errorLastName=ko.observable(null);a.errorFirstName=ko.observable(null);a.errorMiddleName=ko.observable(null);a.errorBirthDay=ko.observable(null);a.isEditBlock=ko.observable(0);a.iconUser=ko.observable();a.cssRegistrationDataForm="profile_registration_data_form";a.ValidationForm=function(){var b=true;if(!a.FirstNameValidation()){b=false}if(!a.LastNameValidation()){b=false}if(!a.MiddleNameValidation()){b=false}if(!a.BirthDayValidation()){b=false}return b};a.FirstNameValidation=function(){if(!a.firstNameField()){a.errorFirstName(Config.Profile.error.firstName.empty);return false}if(a.firstNameField().length<2){a.errorFirstName(Config.Profile.error.firstName.minLength);return false}if(a.firstNameField().length>20){a.errorFirstName(Config.Profile.error.firstName.maxLength);return false}if(!Config.Profile.regular.firstName.test(a.firstNameField())){a.errorFirstName(Config.Profile.error.firstName.regular);return false}a.errorFirstName(null);return true};a.LastNameValidation=function(){if(!a.lastNameField()){a.errorLastName(Config.Profile.error.lastName.empty);return false}if(a.lastNameField().length<2){a.errorLastName(Config.Profile.error.lastName.minLength);return false}if(a.lastNameField().length>20){a.errorLastName(Config.Profile.error.lastName.maxLength);return false}if(!Config.Profile.regular.lastName.test(a.lastNameField())){a.errorLastName(Config.Profile.error.lastName.regular);return false}a.errorLastName(null);return true};a.MiddleNameValidation=function(){if(a.middleNameField()){if(a.middleNameField().length<2){a.errorMiddleName(Config.Profile.error.middleName.minLength);return false}if(a.middleNameField().length>20){a.errorMiddleName(Config.Profile.error.middleName.maxLength);return false}if(!Config.Profile.regular.middleName.test(a.middleNameField())){a.errorMiddleName(Config.Profile.error.middleName.regular);return false}}a.errorMiddleName(null);return true};a.BirthDayValidation=function(){if(!a.birthDayField()){a.errorBirthDay(Config.Profile.error.birthDay.empty);return false}if(!Config.Profile.regular.birthDay.test(a.birthDayField())){a.errorBirthDay(Config.Profile.error.birthDay.regular);return false}var e=a.birthDayField().split(".");var c=new Date(e[2],e[1]-1,e[0]);var b=new Date();var d=new Date(b.getYear()-18,b.getMonth(),b.getDate());if(d<c){a.errorBirthDay(Config.Profile.error.birthDay.minDate);return false}var b=new Date();var f=new Date(b.getYear()-101,b.getMonth(),b.getDate());if(f>c){a.errorBirthDay(Config.Profile.error.birthDay.maxDate);return false}a.errorBirthDay(null);return true};a.AddContent=function(c){a.data=c;var b=Parameters.cache.profile.info;a.iconUser(b.route_icon_user);a.username(b.login);a.gender(c.gender);a.lastName(c.f_name);a.firstName(c.s_name);a.middleName(c.m_name);a.birthDay(c.birth_day);a.rating(b.rating_user);a.lastNameField(a.data.s_name);a.firstNameField(a.data.f_name);a.middleNameField(a.data.m_name);a.birthDayField(a.data.birth_day);a.checkInfo(c.check_info)};a.isNew=function(){if(data){return false}return true};a.Edit=function(){a.isEditBlock(1)};a.Back=function(){a.lastNameField(a.data.f_name);a.firstNameField(a.data.s_name);a.middleNameField(a.data.m_name);a.birthDayField(a.data.birth_day);a.isEditBlock(0)};a.Submit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.personal.checking",a)}};a.ClickItem=function(c,b){a.gender(c)}};var ProfilePostalAddressViewModel=function(){var a=this;a.data=null;a.cssPostAddressForm="profile_postal_address_form";a.countryText=ko.observable();a.idCountry=ko.observable();a.country=ko.observable();a.cssCountryList="country_list_profile";a.errorCountry=ko.observable(null);a.regionText=ko.observable();a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="region_list";a.errorRegion=ko.observable(null);a.cityText=ko.observable();a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="city_list";a.errorCity=ko.observable(null);a.addressText=ko.observable();a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="address";a.errorAddress=ko.observable(null);a.postIndexText=ko.observable();a.postIndex=ko.observable();a.cssPostIndex="post_index";a.errorPostIndex=ko.observable(null);a.checkInfo=ko.observable();a.countryList=ko.observableArray();a.isEditBlock=ko.observable(0);a.AddContent=function(b){a.data=b;a.idCountry(b.id_country);a.countryText(b.country);$.grep(a.countryList(),function(d){if(b.id_country==d.id){a.country(d)}});a.regionText(b.region);a.region({regioncode:b.code_region});a.customRegion(b.region);a.cityText(b.city);a.city({aoguid:b.code_city});a.customCity(b.city);a.addressText(b.address);a.address(b.address);a.customAddress(b.address);a.postIndexText(b.post_code);a.postIndex(b.post_code);a.checkInfo(b.check_info);if(Routing.params.edit=="postal_address"){a.isEditBlock(1)}};a.AddCountryList=function(c){if(c.length>0){for(var b=0;b<=c.length-1;b++){a.countryList.push(new CountryListViewModel(c[b]))}}};a.Edit=function(){a.isEditBlock(1)};a.Back=function(){a.idCountry(a.data.id_country);a.region({regioncode:a.data.code_region});a.customRegion(a.data.region);a.city({aoguid:a.data.code_city});a.customCity(a.data.city);a.address(a.data.address);a.customAddress(a.data.address);a.postIndexText(a.data.post_code);a.postIndex(a.data.post_code);a.checkInfo(a.data.check_info);a.isEditBlock(0)};a.Submit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.postalAddress.checking",a)}};a.ValidationForm=function(){var b=true;if(!a.CountryValidation()){b=false}if(!a.RegionValidation()){b=false}if(!a.CityValidation()){b=false}if(!a.AddressValidation()){b=false}if(!a.PostIndexValidation()){b=false}return b};a.CountryValidation=function(){if(!a.country()){a.errorCountry(Config.Profile.error.country.empty);return false}a.errorCountry(null);return true};a.RegionValidation=function(){if(!a.customRegion()){a.errorRegion(Config.Profile.error.region.empty);return false}a.errorRegion(null);return true};a.CityValidation=function(){if(!a.customCity()){a.errorCity(Config.Profile.error.city.empty);return false}a.errorCity(null);return true};a.AddressValidation=function(){if(!a.customAddress()){a.errorAddress(Config.Profile.error.address.empty);return false}a.errorAddress(null);return true};a.PostIndexValidation=function(){if(!a.postIndex()){a.errorPostIndex(Config.Profile.error.postIndex.empty);return false}if(a.postIndex().length!=6){a.errorPostIndex(Config.Profile.error.postIndex.length);return false}if(!Config.Profile.regular.postIndex.test(a.postIndex())){a.errorPostIndex(Config.Profile.error.postIndex.regular);return false}a.errorPostIndex(null);return true}};var ProfileContactsViewModel=function(){var a=this;a.email=ko.observable();a.isExistEmail=ko.observable();a.sentEmailCode=ko.observable();a.emailToken=ko.observable();a.errorEmail=ko.observable(null);a.errorEmailToken=ko.observable(null);a.emailIsConfirm=ko.observable(false);a.phone=ko.observable();a.cssPhone="phone_profile";a.isExistPhone=ko.observable();a.sentCode=ko.observable();a.phoneToken=ko.observable();a.errorPhone=ko.observable(null);a.errorPhoneToken=ko.observable(null);a.phoneIsConfirm=ko.observable(false);a.AddContent=function(){var b=Parameters.cache.profile.info;if(b.confirm_phone=="yes"){a.phoneIsConfirm(true)}if(b.confirm_email=="yes"){a.emailIsConfirm(true)}if(b.phone){a.phone(b.phone);a.isExistPhone(true)}if(b.email){a.email(b.email);a.isExistEmail(true)}};a.ValidationForm=function(){var b=true;if(!a.EmailValidation()){b=false}if(!a.PhoneValidation()){b=false}return b};a.EmailValidation=function(){if(!a.email()){a.errorEmail(Config.Profile.error.email.empty);return false}if(a.email().length>64){a.errorEmail(Config.Profile.error.email.maxLength);return false}if(!Config.Profile.regular.email.test(a.email())){a.errorEmail(Config.Profile.error.email.regular);return false}a.errorEmail(null);return true};a.PhoneValidation=function(){if(a.emailIsConfirm()){if(!a.phone()){a.errorPhone(Config.Profile.error.phone.empty);return false}}if(a.phone()){if(!Config.Profile.regular.phone.test($.trim(a.phone()))){a.errorPhone(Config.Profile.error.phone.regular);return false}}a.errorPhone(null);return true};a.EmailTokenValidation=function(){if(!a.emailToken()){a.errorEmailToken(Config.Profile.error.emailToken.empty);return false}a.errorEmailToken(null);return true};a.PhoneTokenValidation=function(){if(!a.phoneToken()){a.errorPhoneToken(Config.Profile.error.phoneToken.empty);return false}a.errorPhoneToken(null);return true};a.SendMailToken=function(){a.sentEmailCode(true);a.isExistEmail(false);setTimeout(function(){a.isExistEmail(true)},60000);EventDispatcher.DispatchEvent("ProfileWidget.send.token","mail")};a.SendPhoneToken=function(){a.sentCode(true);a.isExistPhone(false);setTimeout(function(){a.isExistPhone(true)},60000);EventDispatcher.DispatchEvent("ProfileWidget.send.token","sms")};a.SubmitMailToken=function(){if(a.EmailTokenValidation()){EventDispatcher.DispatchEvent("ProfileWidget.submit.token",{type:"mail",value:a})}};a.SubmitPhoneToken=function(){if(a.PhoneTokenValidation()){EventDispatcher.DispatchEvent("ProfileWidget.submit.token",{type:"sms",value:a})}};a.SubmitForm=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.contacts.checking",a)}}};var ProfileDeliveryAddressViewModel=function(){var a=this;a.addressList=ko.observableArray();a.cssAddressList="delivary_address_list";a.checked=ko.observable();a.ClickAddAddress=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery",form:"add"})};a.AddContent=function(c){for(var b in c){DeliveryAddressViewModel.prototype=new Widget();a.addressList.push(new DeliveryAddressViewModel(c[b],a))}}};var DeliveryAddressViewModel=function(c,b){var a=this;a.id=c.id;a.idCountry=c.id_country;a.country=c.country;a.codeRegion=c.code_region;a.region=c.region;a.codeCity=c.code_city;a.city=c.city;a.postIndex=c.post_code;a.address=c.address;a.addressee=c.addressee;a.list=b.addressList();if(c.is_default=="yes"){a.isDefault=ko.observable(true);a.cssIsDefault=ko.observable("delivery_address_is_default active");b.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.contactPhone=c.contact_phone;a.Edit=function(){if(a.id){EventDispatcher.DispatchEvent("ProfileWidget.delivery.edit",a)}else{Routing.SetHash("profile","Личный кабинет",{info:"personal",edit:"postal_address"})}};a.Delete=function(){a.Confirm(Config.Profile.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("ProfileWidget.delivery.delete",{address:a,list:b})},false)};a.ClickItem=function(){$.each(a.list,function(d){a.list[d].cssIsDefault("delivery_address_is_default");a.list[d].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);b.checked(a.id);EventDispatcher.DispatchEvent("ProfileWidget.delivery.sedDefault",a)}};var DeliveryAddressFormViewModel=function(b){var a=this;a.id=ko.observable();a.idCountry=ko.observable();a.country=ko.observable();a.cssCountryList="delivery_country_list";a.errorCountry=ko.observable(null);a.codeRegion=ko.observable();a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="delivery_region";a.errorRegion=ko.observable(null);a.codeCity=ko.observable();a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="delivery_city";a.errorCity=ko.observable(null);a.postIndex=ko.observable();a.cssPostCode="delivery_post_index";a.errorPostCode=ko.observable(null);a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="delivery_cssAddress";a.errorAddress=ko.observable(null);a.addressee=ko.observable();a.errorAddressee=ko.observable(null);a.contactPhone=ko.observable();a.cssContactPhone="delivery_contact_phone";a.errorContactPhone=ko.observable(null);a.isDefault=ko.observable();a.countryList=ko.observableArray();a.AddCountryList=function(d){if(d.length>0){for(var c=0;c<=d.length-1;c++){a.countryList.push(new CountryListViewModel(d[c]));if(d[c].id==a.idCountry()){a.country(d[c])}}}};a.AddContent=function(c){a.id(c.id);a.idCountry=ko.observable(c.idCountry);a.region({regioncode:c.codeRegion});a.customRegion(c.region);a.city({aoguid:c.codeCity});a.customCity(c.city);a.postIndex(c.postIndex);a.customAddress(c.address);a.addressee(c.addressee);a.isDefault(c.isDefault());a.contactPhone(c.contactPhone)};a.Submit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.delivery.add",a)}};a.Edit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.delivery.saveEdit",a)}};a.ValidationForm=function(){var c=true;if(!a.PhoneValidation()){c=false}if(!a.UsernameValidation()){c=false}if(!a.CountryValidation()){c=false}if(!a.RegionValidation()){c=false}if(!a.CityValidation()){c=false}if(!a.AddressValidation()){c=false}if(!a.PostIndexValidation()){c=false}return c};a.CountryValidation=function(){if(!a.country()){a.errorCountry(Config.Profile.error.country.empty);return false}a.errorCountry(null);return true};a.RegionValidation=function(){if(!a.customRegion()){a.errorRegion(Config.Profile.error.region.empty);return false}a.errorRegion(null);return true};a.CityValidation=function(){if(!a.customCity()){a.errorCity(Config.Profile.error.city.empty);return false}a.errorCity(null);return true};a.AddressValidation=function(){if(!a.customAddress()){a.errorAddress(Config.Profile.error.address.empty);return false}a.errorAddress(null);return true};a.PostIndexValidation=function(){if(!a.postIndex()){a.errorPostCode(Config.Profile.error.postIndex.empty);return false}a.errorPostCode(null);return true};a.UsernameValidation=function(){if(!a.addressee()){a.errorAddressee(Config.Profile.error.addressee.empty);return false}if(a.addressee().length<3){a.errorAddressee(Config.Profile.error.addressee.minLength);return false}if(a.addressee().length>40){a.errorAddressee(Config.Profile.error.addressee.maxLength);return false}if(!Config.Profile.regular.addressee.test(a.addressee())){a.errorAddressee(Config.Registration.error.addressee.regular);return false}a.errorAddressee(null);return true};a.PhoneValidation=function(){if(!a.contactPhone()){a.errorContactPhone(Config.Profile.error.phone.empty);return false}if(!Config.Profile.regular.phone.test($.trim(a.contactPhone()))){a.errorContactPhone(Config.Profile.error.phone.regular);return false}a.errorContactPhone(null);return true};a.Back=function(){Routing.SetHash("profile","Личный кабинет",{info:"delivery"})}};var ProfileSecurityViewModel=function(){var a=this;a.cssSequrityForm="profile_sequrity_form";a.oldPassword=ko.observable();a.cssOldPassword="profile_old_password";a.errorOldPassword=ko.observable(null);a.newPassword=ko.observable();a.cssNewPassword="profile_new_password";a.errorNewPassword=ko.observable(null);a.confirmPassword=ko.observable();a.cssConfirmPassword="profile_confirm_password";a.errorConfirmPassword=ko.observable(null);a.Submit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("ProfileWidget.password.change",a)}};a.ValidationForm=function(){var b=true;if(!a.OldPasswordValidation()){b=false}if(!a.NewPasswordValidation()){b=false}if(!a.ConfirmPasswordValidation()){b=false}return b};a.OldPasswordValidation=function(){a.oldPassword($("input#"+a.cssOldPassword).val());if(!a.oldPassword()){a.errorOldPassword(Config.Profile.error.password.empty);return false}if(a.oldPassword().length<6){a.errorOldPassword(Config.Profile.error.password.minLength);return false}if(a.oldPassword().length>64){a.errorOldPassword(Config.Profile.error.password.maxLength);return false}a.errorOldPassword(null);return true};a.NewPasswordValidation=function(){a.newPassword($("input#"+a.cssNewPassword).val());if(!a.newPassword()){a.errorNewPassword(Config.Profile.error.password.empty);return false}if(a.newPassword().length<6){a.errorNewPassword(Config.Profile.error.password.minLength);return false}if(a.newPassword().length>64){a.errorNewPassword(Config.Profile.error.password.maxLength);return false}a.errorNewPassword(null);return true};a.ConfirmPasswordValidation=function(){a.confirmPassword($("input#"+a.cssConfirmPassword).val());if(!a.confirmPassword()){a.errorConfirmPassword(Config.Profile.error.password.empty);return false}if(a.newPassword()!=a.confirmPassword()){a.errorConfirmPassword(Config.Profile.error.password.equal);return false}a.errorConfirmPassword(null);return true}};var TestProfile={Init:function(){if(typeof Widget=="function"){ProfileWidget.prototype=new Widget();var a=new ProfileWidget();a.Init(a)}else{setTimeout(function(){TestProfile.Init()},100)}}};TestProfile.Init();
var FavoritesWidget=function(){var a=this;a.widgetName="FavoritesWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.favorites=null;a.settings={tmpl:{path:null,id:{content:null,empty:null}},animate:null,showBlocks:null,inputParameters:{},style:null,containerId:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.favorites.widget;a.settings.customContainer=Config.Containers.favorites.customClass;a.settings.tmpl=Config.Favorites.tmpl;a.settings.showBlocks=Config.Favorites.showBlocks;a.settings.style=Config.Favorites.style;a.RegisterEvents();a.SetInputParameters();a.CheckRouteFavorites();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/FavoritesWidget/);if(b.favorites){c=b.favorites}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.favorites){c=WParameters.favorites}if(!$.isEmptyObject(c)){if(c.show){for(var d=0;d<=a.settings.showBlocks.length-1;d++){if($.inArray(a.settings.showBlocks[d],c.show)<0){a.settings.showBlocks.splice(a.settings.showBlocks.indexOf(a.settings.showBlocks[d]),1)}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteFavorites=function(){if(Routing.route=="favorites"){a.BaseLoad.Login(false,false,false,function(b){if(!b.err){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update.Menu();a.Update.Content()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});a.WidgetLoader(true)}})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteFavorites()});EventDispatcher.AddEventListener("Favorites.empty",function(){a.InsertContainer.EmptyFaforites();a.Render.EmptyFaforites()});EventDispatcher.AddEventListener("Favorites.clear.one",function(b){var c="?idGoods="+b.goods.id;a.BaseLoad.ClearFavorite(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Favorites.message.clearGoods,function(){b.block.goods.remove(b.goods);if(b.block.goods().length==0){b.content.content.remove(b.block);if(b.content.content().length==0){EventDispatcher.DispatchEvent("Favorites.empty")}}},false)}else{if(!d.err){d.err=Config.Favorites.message.failClearGoods}a.QueryError(d,function(){EventDispatcher.DispatchEvent("Favorites.clear.one",b)})}})});EventDispatcher.AddEventListener("Favorites.clear.all",function(b){var c="?idGoods="+b.ids;a.BaseLoad.ClearFavorite(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Favorites.message.clearGoods,function(){for(var e in b.goods){b.block.goods.remove(b.goods[e])}if(b.block.goods().length==0){b.content.content.remove(b.block)}if(b.content.content().length==0){EventDispatcher.DispatchEvent("Favorites.empty")}},false)}else{if(!d.err){d.err=Config.Favorites.message.failClearGoods}a.QueryError(d,function(){EventDispatcher.DispatchEvent("Favorites.clear.all",b)})}})})};a.Update={Content:function(){a.WidgetLoader(false);a.BaseLoad.InfoFavorite("yes",function(b){if(!b.err){a.InsertContainer.Content();a.Fill.Content(b)}else{a.InsertContainer.EmptyFaforites();a.Render.EmptyFaforites()}})},Menu:function(){a.BaseLoad.Script("widgets/MenuPersonalCabinetWidget-1.1.js",function(){EventDispatcher.DispatchEvent("widget.onload.menuPersonalCabinet",{menu:{},active:""})})}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("content")).html()).children().hide()},EmptyFaforites:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("empty")).html()).children().hide()}};a.Fill={Content:function(e){var d=new FavoritesViewModel();for(var b in e){BlockFavoritesForSellerViewModel.prototype=new Widget();a.favorites=new BlockFavoritesForSellerViewModel(d);for(var c in e[b]){if(typeof a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()]=="function"){a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()](e[b][c])}}d.AddContent(a.favorites)}a.Render.Content(d)},Goods:function(b){a.favorites.AddContent(b)},Seller:function(b){a.favorites.sellerInfo.seller=b},Shop:function(b){a.favorites.sellerInfo.shop=b},Operator:function(b){a.favorites.sellerInfo.operator=b},Final_cost:function(b){a.favorites.finalCost=b}};a.Render={Content:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateFavorite=="function"){new AnimateFavorite()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},EmptyFaforites:function(){a.WidgetLoader(true,a.settings.containerId);if(a.settings.animate){a.settings.animate()}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var FavoritesViewModel=function(){var a=this;a.content=ko.observableArray();a.AddContent=function(b){a.content.push(b)}};var BlockFavoritesForSellerViewModel=function(b){var a=this;a.sellerInfo={};a.showSellerInfo=ko.computed(function(){if($.inArray("infoShop",Config.Favorites.showBlocks)>=0){return true}return false},this);a.goods=ko.observableArray();a.uniq=EventDispatcher.GetUUID();a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(c){ko.utils.arrayForEach(a.goods(),function(d){$("#"+d.cssCheckboxGoods)[0].checked=c;d.isSelected(c)})});a.ClickSelectAll=function(){var d=$("#"+a.cssSelectAll);var c=d.is(":checked");var e;if(c){d[0].checked=false;e=false}else{d[0].checked=true;e=true}ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods)[0].checked=e;f.isSelected(e)})};a.AddContent=function(d){for(var c=0;c<=d.length-1;c++){BlockFavoritesGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockFavoritesGoodsSellersViewModel(d[c],a,b))}a.finalCost=d.final_cost};a.ClickButchRemove=function(){a.Confirm(Config.Favorites.message.confirmButchRemove,function(){var c=[];var d=[];var f=a.goods().length-1;for(var e=0;e<=f;e++){if(a.goods()[e].isSelected()){c.push(a.goods()[e].id);d.push(a.goods()[e])}}EventDispatcher.DispatchEvent("Favorites.clear.all",{ids:c,goods:d,content:b,block:a})})};a.ClickClearFavorites=function(){a.Confirm(Config.Favorites.message.confirmClearFavorites,function(){var g=a.goods().length-1;var d=[];var c=[];for(var e=0;e<=g;e++){d.push(a.goods()[e]);c.push(a.goods()[e].id)}var f=c.join(",");EventDispatcher.DispatchEvent("Favorites.clear.all",{ids:f,goods:d,content:b,block:a})})};a.DisabledButton=ko.computed(function(){var c=a.goods().length;var e=[];for(var d=0;d<=c-1;d++){if(a.goods()[d].isSelected()){e.push(a.goods()[d].id)}}if(e.length>0){return true}return false},this)};var BlockFavoritesGoodsSellersViewModel=function(c,d,b){var a=this;a.sellerId=d.sellerInfo.seller.id;a.uniq=EventDispatcher.HashCode(new Date().getTime().toString()+"-"+a.id);a.cssToCart="goodsToCart_"+a.uniq;a.cssTitleToCart="goodsTilteToCart_"+a.uniq;a.id=c.id;a.fullName=c.full_name;a.sellCost=ko.observable(c.sell_cost);a.sellEndCost=ko.observable(c.sell_end_cost);a.routeImages=c.route_image;a.routeBigImages=c.route_big_image;a.isSelected=ko.observable(false);a.isSelected.subscribe(function(f){var e=d.goods().length;var h=[];for(var g=0;g<=e-1;g++){if(d.goods()[g].isSelected()){h.push(d.goods()[g].id)}}if(h.length<e){$("#"+d.cssSelectAll)[0].checked=false}else{$("#"+d.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods="goods_"+a.id;a.ClickOrder=function(){var e=$("#"+a.cssCheckboxGoods);var f=e.is(":checked");if(f==false){e[0].checked=true;a.isSelected(true)}else{e[0].checked=false;a.isSelected(false)}};a.showAddToCart=ko.computed(function(){if($.inArray("addToCart",Config.Favorites.showBlocks)>=0){return true}return false},this);a.AddToCart=function(){EventDispatcher.DispatchEvent("widgets.cart.addGoods",{goodsId:a.id,hash:a.uniq})};a.showBuy=ko.computed(function(){if($.inArray("buy",Config.Favorites.showBlocks)>=0){return true}return false},this);a.Buy=function(){Routing.SetHash("order","Оформление заказа",{create:"directly",sellerId:a.sellerId,goodsId:a.id,count:1})};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.ClickRemove=function(){a.Confirm(Config.Favorites.message.confirmRemove,function(){EventDispatcher.DispatchEvent("Favorites.clear.one",{goods:a,block:d,content:b})})}};var TestFavorites={Init:function(){if(typeof Widget=="function"){FavoritesWidget.prototype=new Widget();var a=new FavoritesWidget();a.Init(a)}else{setTimeout(function(){TestFavorites.Init()},100)}}};TestFavorites.Init();
var CabinetCartGoodsWidget=function(){var a=this;a.widgetName="CabinetCartGoodsWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.cart=null;a.settings={tmpl:{path:null,id:{content:null,empty:null}},animate:null,inputParameters:{},style:null,containerId:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.cabinetCartGoods.widget;a.settings.customContainer=Config.Containers.cabinetCartGoods.customClass;a.settings.tmpl=Config.CabinetCartGoods.tmpl;a.settings.style=Config.CabinetCartGoods.style;a.RegisterEvents();a.SetInputParameters();a.CheckCabinetCartGoodsRoute();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/CabinetCartGoodsWidget/);if(b.cabinetCartGoods){c=b.cabinetCartGoods}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.cabinetCartGoods){c=WParameters.cabinetCartGoods}if(!$.isEmptyObject(c)){if(c.show){for(var d=0;d<=c.show.length-1;d++){if($.inArray(c.show[d],a.settings.showBlocks)<0){a.settings.showBlocks.push(c.show[d])}}}if(c.hide){for(var d=0;d<=c.hide.length-1;d++){var e=$.inArray(c.hide[d],a.settings.showBlocks);if(e>0){a.settings.showBlocks.splice(e,1)}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckCabinetCartGoodsRoute=function(){if(Routing.route=="cabinet_cart"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update.Content()})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckCabinetCartGoodsRoute()});EventDispatcher.AddEventListener("CabinetCartGoods.onload.info",function(b){if(!b.err){a.InsertContainer.Content();a.Fill.Content(b)}else{a.InsertContainer.EmptyCart();a.Render.EmptyCart()}});EventDispatcher.AddEventListener("CabinetCartGoods.change.count",function(b){a.BaseLoad.AddGoodsToCart(b.goodsId,b.sellerId,b.count,function(c){EventDispatcher.DispatchEvent("widgets.cart.infoUpdate",c);b.sellCost=c.sell_cost;b.sellEndCost=c.sell_end_cost})});EventDispatcher.AddEventListener("CabinetCartGoods.clear",function(c){var b=c.goodsId?c.goodsId:false;a.BaseLoad.ClearCart(c.sellerId,b,function(d){EventDispatcher.DispatchEvent("widgets.cart.infoUpdate",d)})});EventDispatcher.AddEventListener("CabinetCartGoods.empty.cart",function(){a.InsertContainer.EmptyCart();a.Render.EmptyCart()})};a.Update={Content:function(){a.WidgetLoader(false);a.BaseLoad.Login(false,false,false,function(b){if(!b.err){Loader.Indicator("MenuPersonalCabinetWidget",false);a.BaseLoad.InfoFavorite("no",function(c){Parameters.cache.favorite=c;a.BaseLoad.CartGoods("",function(d){EventDispatcher.DispatchEvent("CabinetCartGoods.onload.info",d)})});a.Update.Menu()}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});a.WidgetLoader(true)}})},Menu:function(){a.BaseLoad.Script("widgets/MenuPersonalCabinetWidget-1.1.js",function(){EventDispatcher.DispatchEvent("widget.onload.menuPersonalCabinet",{menu:{},active:""})})}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("content")).html()).children().hide()},EmptyCart:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("empty")).html()).children().hide()}};a.Fill={Content:function(e){var d=new CartGoodsViewModel();for(var b in e){BlockCabinetGoodsForSellerViewModel.prototype=new Widget();a.cart=new BlockCabinetGoodsForSellerViewModel(d);for(var c in e[b]){if(typeof a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()]=="function"){a.Fill[c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()](e[b][c])}}d.AddContent(a.cart)}a.Render.Content(d)},Goods:function(b){a.cart.AddContent(b)},Seller:function(b){a.cart.sellerInfo.seller=b},Shop:function(b){a.cart.sellerInfo.shop=b},Operator:function(b){a.cart.sellerInfo.operator=b},Final_cost:function(b){a.cart.finalCost=b}};a.Render={Content:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateCabinetCartGoods=="function"){new AnimateCabinetCartGoods()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},EmptyCart:function(){a.WidgetLoader(true)}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var CartGoodsViewModel=function(){var a=this;a.sellerBlock=ko.observableArray();a.AddContent=function(b){a.sellerBlock.push(b)}};var BlockCabinetGoodsForSellerViewModel=function(b){var a=this;a.sellerInfo={};a.goods=ko.observableArray();a.finalCost=0;a.tatalForPayment=ko.computed(function(){var d=0;if(a.goods().length>0){for(var c=0;c<=a.goods().length-1;c++){d=d+parseFloat(a.goods()[c].endSum())}}return d.toFixed(2)},this);a.totalSum=ko.computed(function(){var d=0;if(a.goods().length>0){for(var c=0;c<=a.goods().length-1;c++){d=d+parseFloat(a.goods()[c].sum())}}return d.toFixed(2)},this);a.tatalDiscount=ko.computed(function(){return(a.totalSum()-a.tatalForPayment()).toFixed(2)},this);a.uniq=EventDispatcher.HashCode(new Date().getTime().toString());a.cssSelectAll="cartGoodsSelectAll_"+a.uniq;a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(c){ko.utils.arrayForEach(a.goods(),function(d){$("#"+d.cssCheckboxGoods())[0].checked=c;d.isSelected(c)})});a.ClickSelectAll=function(){var d=$("#"+a.cssSelectAll);var c=d.is(":checked");var e;if(c){d[0].checked=false;e=false}else{d[0].checked=true;e=true}ko.utils.arrayForEach(a.goods(),function(f){$("#"+f.cssCheckboxGoods())[0].checked=e;f.isSelected(e)})};a.AddContent=function(d){for(var c=0;c<=d.length-1;c++){BlockCabinetCartGoodsSellersViewModel.prototype=new Widget();a.goods.push(new BlockCabinetCartGoodsSellersViewModel(d[c],a,b))}a.finalCost=d.final_cost};a.comment=ko.observable();a.ClickButchFavorites=function(){var c=[];ko.utils.arrayForEach(a.goods(),function(d){if(d.isSelected()){c.push(d.id);d.IsFavorite(true)}});a.AddCommentForm(c)};a.AddCommentForm=function(c){a.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){EventDispatcher.DispatchEvent("widgets.favorites.add",{goodsId:c.join(","),comment:a.comment(),data:a});$(this).dialog("close")}}})};a.ClickButchRemove=function(){a.Confirm(Config.CartGoods.message.confirmButchRemove,function(){a.Remove()})};a.Remove=function(){var c=[];var d=[];var f=a.goods().length-1;for(var e=0;e<=f;e++){if(a.goods()[e].isSelected()){c.push(a.goods()[e].id);d.push(a.goods()[e])}}for(var e in d){a.goods.remove(d[e])}EventDispatcher.DispatchEvent("CabinetCartGoods.clear",{goodsId:c.join(","),sellerId:a.sellerInfo.shop.id});if(a.goods().length==0){b.content.remove(a)}if(b.content().length==0){EventDispatcher.DispatchEvent("CabinetCartGoods.empty.cart")}};a.IsFavorite=function(){};a.ClickProceed=function(){Routing.SetHash("default","Домашняя",{})};a.ClickIssueOrder=function(){if(Parameters.cache.userInformation.err){Parameters.cache.lastPage={route:"order",title:"Оформление заказа",data:{create:"fromCart",sellerId:a.sellerInfo.shop.id}};Routing.SetHash("login","Авторизация пользователя",{})}else{Routing.SetHash("order","Оформление заказа",{create:"fromCart",sellerId:a.sellerInfo.shop.id})}};a.ClickClearCurt=function(){a.Confirm(Config.CabinetCartGoods.message.confirmClearCart,function(){var e=a.goods().length-1;var c=[];for(var d=0;d<=e;d++){c.push(a.goods()[d])}for(var d in c){a.goods.remove(c[d])}b.sellerBlock.remove(a);EventDispatcher.DispatchEvent("CabinetCartGoods.clear",{sellerId:a.sellerInfo.shop.id});if(b.sellerBlock().length==0){EventDispatcher.DispatchEvent("CabinetCartGoods.empty.cart")}})};a.isDisabledButton=ko.computed(function(){var c=a.goods().length;var e=[];for(var d=0;d<=c-1;d++){if(a.goods()[d].isSelected()){e.push(a.goods()[d].id)}}if(e.length>0){return false}return true},this)};var BlockCabinetCartGoodsSellersViewModel=function(c,d,b){var a=this;a.sellerId=d.sellerInfo.seller.id;a.id=c.id;a.fullName=c.full_name;a.countReserv=c.count_reserv;a.count=c.count;a.sellCost=ko.observable(c.sell_cost);a.sellEndCost=ko.observable(c.sell_end_cost);a.routeImages=c.route_image;a.routeBigImages=c.route_big_image;a.ordered=ko.observable(a.count);a.sum=ko.computed(function(){return(a.ordered()*a.sellCost()).toFixed(2)},this);a.endSum=ko.computed(function(){return(a.ordered()*a.sellEndCost()).toFixed(2)},this);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(f){var e=d.goods().length;var h=[];for(var g=0;g<=e-1;g++){if(d.goods()[g].isSelected()){h.push(d.goods()[g].id)}}if(h.length<e){$("#"+d.cssSelectAll)[0].checked=false}else{$("#"+d.cssSelectAll)[0].checked=true}});a.cssCheckboxGoods=ko.observable("goods_"+a.id);a.ClickOrder=function(e,g){var f=$("#"+e.cssCheckboxGoods());var h=f.is(":checked");if(h==false){f[0].checked=true;a.isSelected(true)}else{f[0].checked=false;a.isSelected(false)}};a.discount=ko.computed(function(){var e=100-Math.floor(a.sellEndCost()*100/a.sellCost());if(e>0){return e+"%"}else{return 0}},this);a.comment=ko.observable();a.ClickPlus=function(){if(a.ordered()<a.countReserv){a.ordered(a.ordered()+1);EventDispatcher.DispatchEvent("CabinetCartGoods.change.count",{goodsId:a.id,sellerId:a.sellerId,count:a.ordered()},a)}else{a.ShowMessage(Config.Goods.message.maxIsReached,false,false)}};a.ClickMinus=function(){if(a.ordered()>0){a.ordered(a.ordered()-1);EventDispatcher.DispatchEvent("CabinetCartGoods.change.count",{goodsId:a.id,sellerId:a.sellerId,count:a.ordered()},a)}};a.ClickGoods=function(){Routing.SetHash("goods",a.fullName,{id:a.id})};a.AddFavorites=function(){if(Parameters.cache.userInformation!=null&&!Parameters.cache.userInformation.err){a.AddCommentForm()}else{a.ShowMessage(Config.Authentication.message.pleaseLogIn,false,false)}};a.ClickFavorites=function(){Routing.SetHash("favorites","Избранное",{})};a.ClickRemove=function(){a.Confirm(Config.CartGoods.message.confirmRemove,function(){a.Remove()})};a.Remove=function(){EventDispatcher.DispatchEvent("CartGoods.clear",{goodsId:a.id,sellerId:a.sellerId});d.goods.remove(a);if(d.goods().length==0){b.content.remove(d);if(b.content().length==0){EventDispatcher.DispatchEvent("CartGoods.empty.cart")}}};a.AddCommentForm=function(){d.comment(" ");$("#dialog-form-batch").dialog({height:300,width:396,modal:true,buttons:{"Сохранить":function(){EventDispatcher.DispatchEvent("widgets.favorites.add",{goodsId:a.id,comment:d.comment(),data:a});$(this).dialog("close")}}})};a.IsFavorite=ko.observable();if($.inArray(a.id,Parameters.cache.favorite)>=0){a.IsFavorite(true)}else{a.IsFavorite(false)}};var TestCabinetCartGoods={Init:function(){if(typeof Widget=="function"){CabinetCartGoodsWidget.prototype=new Widget();var a=new CabinetCartGoodsWidget();a.Init(a)}else{setTimeout(function(){TestCabinetCartGoods.Init()},100)}}};TestCabinetCartGoods.Init();
var OrderWidget=function(){var a=this;a.widgetName="OrderWidget";a.version=1.1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerFormId:null,tmpl:{path:null,id:{step1:null,step1Confirm:null,step1Profile:null,step2:null,step2Form:null,step3:null,step4:null,step5:null}},animate:null,inputParameters:{},style:null,customContainer:null};a.order={type:null,id:null,sellerId:null,goodsId:null,count:null,content:null,delivery:{},shipping:{},payment:{}};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.order.widget;a.settings.customContainer=Config.Containers.order.customClass;a.settings.tmpl=Config.Order.tmpl;a.settings.style=Config.Order.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteOrder();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/OrderWidget/);if(b.order){c=b.order}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.order){c=WParameters.order}if(!$.isEmptyObject(c)){if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){for(var d in c.tmpl.id){a.settings.tmpl.id[d]=c.tmpl.id[d]}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteOrder=function(){if(Routing.route=="order"){a.WidgetLoader(false);if(Routing.params.sellerId){a.order.sellerId=Routing.params.sellerId}if(Routing.params.create){a.BaseLoad.Login(false,false,false,function(b){if(Routing.params.create=="fromCart"){if(b.err){a.order.type="cart";a.order.goodsId=null;a.order.count=null;setTimeout(function(){Parameters.cache.history.pop();var c=Parameters.cache.history.pop();if(c.route=="order"&&c.data.create){c=Parameters.cache.history.pop()}if(c.route=="login"){c=Parameters.cache.history.pop()}Routing.SetHash(c.route,c.title,c.data,true)},1000)}else{a.DataOrder.Create({create:"fromCart",sellerId:a.order.sellerId},function(){a.order.type="cart";a.DataOrder.Cart(function(){Routing.SetHash("order","Оформление заказа",{step:2})})})}}else{if(Routing.params.create=="directly"){if(b.err){a.order.type="directly";a.order.goodsId=Routing.params.goodsId;a.order.count=Routing.params.count;setTimeout(function(){Parameters.cache.history.pop();var c=Parameters.cache.history.pop();if(c.route=="order"&&c.data.create){c=Parameters.cache.history.pop()}if(c.route=="login"){c=Parameters.cache.history.pop()}Routing.SetHash(c.route,c.title,c.data,true)},1000)}else{a.DataOrder.Create({create:"directly",sellerId:a.order.sellerId,goodsId:Routing.params.goodsId,count:Routing.params.count},function(){a.order.type="directly";a.order.goodsId=Routing.params.goodsId;a.order.count=Routing.params.count;a.DataOrder.Directly(function(){Routing.SetHash("order","Оформление заказа",{step:2})})})}}else{Routing.SetHash("default","Домашняя",{})}}})}if(Routing.params.step){a.BaseLoad.Login(false,false,false,function(b){a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(Routing.params.id){a.order.id=Routing.params.id}if(Routing.params.step==1&&!Routing.params.block){if(b.err){a.Step.Step1()}else{Routing.SetHash("order","Оформление заказа",{step:2})}}else{if(Routing.params.step==1&&Routing.params.block=="confirm"){a.Step.Step1Confirm()}else{if(!b.err&&Routing.params.step==1&&Routing.params.block=="profile"&&a.order.id){a.Step.Step1Profile()}else{if(!b.err&&Routing.params.step==2&&!Routing.params.block&&a.order.id){a.Step.Step2()}else{if(!b.err&&Routing.params.step==2&&Routing.params.block=="add"&&a.order.id){a.Step.Step2Form()}else{if(!b.err&&Routing.params.step==3&&a.order.id){a.Step.Step3()}else{if(!b.err&&Routing.params.step==4&&a.order.id){a.Step.Step4()}else{if(Routing.params.step==5){a.Step.Step5()}else{Routing.SetHash("default","Домашняя",{})}}}}}}}}})})}}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteOrder()});EventDispatcher.AddEventListener("UserInformationWidget.click.logout",function(){Parameters.cache.order.step1.login={};Parameters.cache.order.step1.reg={};Parameters.cache.order.step1.confirm={};Parameters.cache.order.step1.profile={};Parameters.cache.order.step2={};Parameters.cache.order.step3={};Parameters.cache.order.step4={};Parameters.cache.order.step5={};Parameters.cache.payment=null;Parameters.cache.shipping=null;Parameters.cache.delivery=null;Parameters.cache.profile.personal={};a.order.type=null;a.order.id=null;a.order.sellerId=null;a.order.goodsId=null;a.order.count=null;a.order.content=null;a.order.delivery={};a.order.shipping={};a.order.payment={}});EventDispatcher.AddEventListener("OrderWidget.step1.authentication",function(b){a.BaseLoad.Login(b.username,b.password,b.rememberMe,function(c){if(c.err){Parameters.cache.order.step1.reg.loginForm.error("Ошибка в логине или пароле");Parameters.cache.order.step1.reg.loginForm.password=null;a.Render.Step1(Parameters.cache.order.step1.reg)}else{if(a.order.type=="directly"){a.DataOrder.Create({create:"directly",sellerId:a.order.sellerId,goodsId:a.order.goodsId,count:a.order.count},function(){a.DataOrder.Directly(function(){Routing.SetHash("order","Оформление заказа",{step:2})})})}if(a.order.type=="cart"){a.DataOrder.Create({create:"directly",sellerId:a.order.sellerId},function(){a.DataOrder.Cart(function(){Routing.SetHash("order","Оформление заказа",{step:2})})})}}})});EventDispatcher.AddEventListener("OrderWidget.step1.registration",function(b){a.WidgetLoader(false);var d=[];if(b.username()){d.push("username="+encodeURIComponent(b.username()))}if(b.phone()){d.push("phone="+b.phone().replace(/\s/g,""))}if(b.email()){d.push("email="+b.email())}if(d.length>0){var c="?"+d.join("&")}a.BaseLoad.UniqueUser(c,function(e){var h=true;if(a.QueryError(e,function(){EventDispatcher.DispatchEvent("OrderWidget.step1.registration",b)})){if(!a.Validate.Username(e,b)){h=false}if(!a.Validate.Email(e,b)){h=false}if(!a.Validate.Phone(e,b)){h=false}}else{h=false}if(h){var g=[];if(b.username()){g.push("username="+encodeURIComponent(b.username()))}if(b.phone()){g.push("phone="+b.phone().replace(/\s/g,""))}if(b.email()){g.push("email="+b.email())}if(b.firstPassword()){g.push("password="+encodeURIComponent(b.firstPassword()))}if(g.length>0){var f="?"+g.join("&")}a.BaseLoad.Registration(f,function(i){Parameters.cache.order.step1.reg=b;Routing.SetHash("order","Оформление заказа",{step:1,block:"confirm"})})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("OrderWidget.step1.confirm",function(b){a.WidgetLoader(false);var d=[];d.push("username="+encodeURIComponent(b.username));if(!b.mailConfirmLater()){d.push("mail_token="+b.mailToken())}if(!b.phoneConfirmLater()){d.push("sms_token="+b.phoneToken())}var c="?"+d.join("&");a.BaseLoad.ActivateUser(c,function(e){var f=true;if(a.QueryError(e,function(){EventDispatcher.DispatchEvent("OrderWidget.step1.confirm",b)})){if(!a.Validate.MailToken(e,b)){f=false}if(!a.Validate.PhoneToken(e,b)){f=false}}else{f=false}if(f){a.BaseLoad.Login(false,false,false,function(g){Parameters.cache.order.step1.confirm=b;if(!g.err){if(a.order.type=="directly"){a.DataOrder.Create({create:"directly",sellerId:a.order.sellerId,goodsId:a.order.goodsId,count:a.order.count},function(){a.DataOrder.Directly(function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})})})}if(a.order.type=="fromCart"){a.DataOrder.Create({create:"directly",sellerId:a.order.sellerId},function(){a.DataOrder.Cart(function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})})})}}})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("OrderWidget.step1.view1",function(){Routing.SetHash("order","Оформление заказа",{step:1})});EventDispatcher.AddEventListener("OrderWidget.step1.later",function(){Routing.SetHash("order","Оформление заказа",{step:2})});EventDispatcher.AddEventListener("OrderWidget.step1.profile",function(d){a.WidgetLoader(false);var c=d.birthDay().split(".");var b=c[2]+"-"+c[1]+"-"+c[0];d.birthDayHiddenField(b);a.BaseLoad.EditProfile($("form#"+d.cssRegistrationDataForm),function(e){var f=true;if(!a.QueryError(e,function(){EventDispatcher.DispatchEvent("OrderWidget.step1.profile",d)})){f=false}if(f){Parameters.cache.profile.personal={};Parameters.cache.order.step1.profile=d;Routing.SetHash("order","Оформление заказа",{step:2})}else{a.WidgetLoader(true,a.settings.containerFormId)}})});EventDispatcher.AddEventListener("OrderWidget.step3.change",function(b){a.BaseLoad.EditOrder(a.order.id+"/?id_method_shipping="+b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderWidget.step3.change",b)})){a.order.shipping=b.selected;b.fn()}})});EventDispatcher.AddEventListener("OrderWidget.step3.message",function(){a.ShowMessage(Config.Order.message.selectMethodShipping,false,false)});EventDispatcher.AddEventListener("OrderWidget.step2.add",function(b){var c="?id_country="+encodeURIComponent($.trim(b.country().id));if(b.region()){c=c+"&code_region="+encodeURIComponent($.trim(b.region().regioncode))}else{c=c+"&name_region="+encodeURIComponent($.trim(b.customRegion()))}if(b.city()){c=c+"&code_city="+encodeURIComponent($.trim(b.city().aoguid))}else{c=c+"&name_city="+encodeURIComponent($.trim(b.customCity()))}c=c+"&address="+encodeURIComponent($.trim(b.customAddress()))+"&post_code="+encodeURIComponent($.trim(b.postCode()))+"&addressee="+encodeURIComponent($.trim(b.addressee()))+"&contact_phone="+encodeURIComponent($.trim(b.contactPhone()))+"&is_default="+encodeURIComponent(b.isDefault()?"yes":"no");a.BaseLoad.AddDelivaryAddress(c,function(d){if(d.result=="ok"){a.ShowMessage(Config.Order.message.addAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;Routing.SetHash("order","Оформление заказа",{step:2})},false)}else{if(!d.err){d.err=Config.Order.message.failAddAddressDelivery}a.QueryError(d,function(){EventDispatcher.DispatchEvent("OrderWidget.step2.add",b)})}})});EventDispatcher.AddEventListener("OrderWidget.step2.change",function(b){a.BaseLoad.EditOrder(a.order.id+"/?id_shipping_address="+b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderWidget.step2.change",b)})){Parameters.cache.delivery=null;a.order.delivery=b.selected;b.fn()}})});EventDispatcher.AddEventListener("OrderWidget.step2.delete",function(b){a.BaseLoad.DeleteDeliveryAddress(b.address.id,function(c){if(c.result=="ok"){a.ShowMessage(Config.Order.message.deleteAddressDelivery,function(){Parameters.cache.order.step2={};Parameters.cache.delivery=null;b.list.remove(b.address)},false)}else{if(!c.err){c.err=Config.Order.message.failDeleteAddressDelivery}a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderWidget.step2.delete",b)})}})});EventDispatcher.AddEventListener("OrderWidget.step2.message",function(){a.ShowMessage(Config.Order.message.selectAddress,false,false)});EventDispatcher.AddEventListener("OrderWidget.step4.change",function(b){a.BaseLoad.EditOrder(a.order.id+"/?id_method_payment="+b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderWidget.step4.change",b)})){a.order.payment=b.selected;b.fn()}})});EventDispatcher.AddEventListener("OrderWidget.step4.message",function(){a.ShowMessage(Config.Order.message.selectMethodPayment,false,false)});EventDispatcher.AddEventListener("OrderWidget.step5.confirm",function(c){var b=a.order.id;if(c.comment){b=b+"?comment_buyer="+encodeURIComponent(c.comment)}a.BaseLoad.ConfirmOrder(b,function(d){if(a.QueryError(d,function(){EventDispatcher.DispatchEvent("OrderWidget.step5.confirm",c)})){a.ShowMessage(Config.Order.message.orderConfirm,function(){Routing.SetHash("purchases","Мои покупки",{block:"detail",id:a.order.id})},false)}})});EventDispatcher.AddEventListener("OrderWidget.step5.delete",function(){a.Confirm(Config.Order.message.confirmDeleteOrder,function(){a.BaseLoad.DeleteOrder(a.order.id+"/yes",function(b){if(a.QueryError(b,function(){EventDispatcher.DispatchEvent("OrderWidget.step5.delete")})){a.ShowMessage(Config.Order.message.deleteOrderConfirm,function(){Routing.SetHash("default","Домашняя",{})},false)}})})});EventDispatcher.AddEventListener("OrderWidget.send.token",function(b){a.BaseLoad.SendToken(b,function(c){if(c.result=="ok"){a.ShowMessage(Config.Order.message.sendToken,false,false)}else{if(!c.err){c.err=Config.Order.message.failSendToken}a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderWidget.send.token",b)})}})})};a.Validate={Username:function(c,b){var d=false;if(c.check_username){if(c.check_username=="on"||c.check_username=="ban"||c.check_username=="off"){b.errorUsername(Config.Order.error.username.uniq)}if(c.check_username=="yes"){d=true}}return d},Phone:function(c,b){var d=false;if(c.check_phone){if(c.check_phone=="on"||c.check_phone=="ban"||c.check_phone=="off"){b.errorPhone(Config.Order.error.phone.uniq)}if(c.check_phone=="yes"){d=true}}else{d=true}return d},Email:function(c,b){var d=false;if(c.check_email){if(c.check_email=="on"||c.check_email=="ban"||c.check_email=="off"){b.errorEmail(Config.Order.error.email.uniq)}if(c.check_email=="yes"){d=true}}return d},MailToken:function(c,b){if(c.confirm_email){if(c.confirm_email=="no"){b.errorEmailConfirm(Config.Order.error.emailToken.confirm);return false}}return true},PhoneToken:function(c,b){if(c.confirm_phone){if(c.confirm_phone=="no"){b.errorPhoneConfirm(Config.Order.error.phoneToken.confirm);return false}}return true},Profile:function(c,b){if(c.err){b.errorAddress(c.err);return false}return true},Address:function(b,c){if(b.err){c.errorAddress(b.err);return false}return true}};a.DataOrder={Create:function(c,d){var b=c.sellerId;if(c.goodsId){b=b+"/"+c.goodsId+"/"+c.count}a.BaseLoad.NewOrder(b,function(e){if(a.QueryError(e,function(){Routing.SetHash("order","Оформление заказа",c)},function(){var f=Parameters.cache.lastPage;Routing.SetHash(f.route,f.title,f.data)})){if(e.msg){a.ShowMessage(e.msg,function(){var f=Parameters.cache.lastPage;Routing.SetHash(f.route,f.title,f.data)},false)}else{a.order.id=e.id;if(d){d()}}}})},Cart:function(b){a.BaseLoad.CartGoods(a.order.sellerId,function(c){a.order.content=c;a.order.content.main=c[0].goods;if(b){b()}})},Directly:function(b){a.BaseLoad.GoodsInfo(a.order.goodsId,"1000000",function(c){a.order.content=c;a.order.content.main=[c.main];if(b){b()}})},IsRealGoods:function(){var c=false;var b=[];if(a.order.type=="cart"){b=a.order.content[0].goods}else{if(!$.isArray(a.order.content.main)){b[0]=a.order.content.main}else{b=a.order.content.main}}$.each(b,function(d){if(b[d].is_egoods!="yes"){c=true;return false}});return c}};a.Step={Step1:function(){a.InsertContainer.Step1();a.Fill.Step1()},Step1Confirm:function(){a.InsertContainer.Step1Confirm();a.Fill.Step1Confirm()},Step1Profile:function(){a.BaseLoad.Profile(function(b){a.InsertContainer.Step1Profile();a.Fill.Step1Profile(b)})},Step2:function(){if(Routing.params.id){a.BaseLoad.OrderInfo(a.order.id+"/yes",function(b){if(a.QueryError(b,function(){Routing.SetHash("order","Оформление заказа",Routing.params)},function(){var c=Parameters.cache.lastPage;Routing.SetHash(c.route,c.title,c.data)})){if(b.msg){a.ShowMessage(b.msg,function(){var c=Parameters.cache.lastPage;if(c){Routing.SetHash(c.route,c.title,c.data)}else{Routing.SetHash("default",Routing.defaultTitle,{})}},false)}else{a.order.content={};a.order.content.main=b.goods;a.Step.Step2Getdata()}}})}else{a.Step.Step2Getdata()}},Step2Getdata:function(){if(a.DataOrder.IsRealGoods()){a.BaseLoad.DeliveryAddressList(function(b){a.InsertContainer.Step2();a.Fill.Step2(b)})}else{Routing.SetHash("order","Оформление заказа",{step:4})}},Step2Form:function(){if(a.DataOrder.IsRealGoods()){var c=new OrderDeliveryFormStep2ViewModel();var b=Parameters.shopId;a.BaseLoad.Country(b,function(d){a.InsertContainer.Step2Form();a.Fill.Step2Form(c,d)})}else{Routing.SetHash("order","Оформление заказа",{step:4})}},Step3:function(){if(a.DataOrder.IsRealGoods()){a.BaseLoad.GoodsInfo(a.order.content.main[0].id,"1010000",function(b){a.order.sellerId=b.shop.id;a.BaseLoad.Shipping(a.order.sellerId+"/"+a.order.id+"/",function(c){a.InsertContainer.Step3();a.Fill.Step3(c)})})}else{Routing.SetHash("order","Оформление заказа",{step:4})}},Step4:function(){a.BaseLoad.GoodsInfo(a.order.content.main[0].id,"1010000",function(b){a.order.sellerId=b.shop.id;a.BaseLoad.Payment(a.order.sellerId+"/"+a.order.id,function(c){a.InsertContainer.Step4();a.Fill.Step4(c)})})},Step5:function(){a.BaseLoad.Script("widgets/OrderViewModel-1.0.js",function(){a.BaseLoad.OrderInfo(a.order.id+"/yes",function(b){a.InsertContainer.Step5();a.Fill.Step5(b)})})}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},Step1:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step1")).html()).children().hide()},Step1Confirm:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step1Confirm")).html()).children().hide()},Step1Profile:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step1Profile")).html()).children().hide()},Step2:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step2")).html()).children().hide()},Step2Form:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step2Form")).html()).children().hide()},Step3:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step3")).html()).children().hide()},Step4:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step4")).html()).children().hide()},Step5:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("step5")).html()).children().hide()}};a.Fill={Step1:function(){var b=Parameters.cache.order.step1.reg;if($.isEmptyObject(b)){a.BaseLoad.Script("widgets/RegistrationViewModel-1.0.js",function(){a.BaseLoad.Script("widgets/AuthenticationViewModel-1.1.js",function(){b=new OrderFormStep1ViewModel();Parameters.cache.order.step1.reg=b})})}a.Render.Step1(b)},Step1Confirm:function(){if(Routing.params.username&&Routing.params.mail_token){Parameters.cache.order.step1.reg.username(Routing.params.username)}RegistrationConfirmFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("OrderWidget.step1.view1")};var b=new RegistrationConfirmFormViewModel(Parameters.cache.order.step1.reg);b.submitEvent("OrderWidget.step1.confirm");b.ShowButtonSendToken();if(Routing.params.username&&Routing.params.mail_token){b.mailToken(Routing.params.mail_token);EventDispatcher.DispatchEvent("OrderWidget.step1.confirm",b)}a.Render.Step1Confirm(b)},Step1Profile:function(c){RegistrationProfileFormViewModel.prototype.Back=function(){EventDispatcher.DispatchEvent("OrderWidget.step1.view2")};RegistrationProfileFormViewModel.prototype.SpecifyLater=function(){EventDispatcher.DispatchEvent("OrderWidget.step1.later")};var b=new RegistrationProfileFormViewModel();b.submitEvent("OrderWidget.step1.profile");b.AddContent(c);a.Render.Step1Profile(b)},Step2:function(c){if(!c.err){var b=Parameters.cache.order.step2;if($.isEmptyObject(b)){b=new OrderFormStep2ViewModel()}b.AddContent(c,a.order);a.Render.Step2(b);Parameters.cache.order.step2=b}else{Routing.SetHash("order","Оформление заказа",{step:2,block:"add"})}},Step2Form:function(b,c){b.AddCountryList(c);if(b.idCountry()){$.grep(b.countryList(),function(d){if(d.id==b.idCountry()){b.country(d)}})}a.Render.Step2Form(b)},Step3:function(c){var b=Parameters.cache.order.step3;if($.isEmptyObject(b)){b=new OrderFormStep3ViewModel()}b.AddShipping(c);Parameters.cache.order.step3=b;a.Render.Step3(b)},Step4:function(c){var b=Parameters.cache.order.step4;if($.isEmptyObject(b)){b=new OrderFormStep4ViewModel()}b.AddPayment(c);Parameters.cache.order.step4=b;a.Render.Step4(b)},Step5:function(c){var b=Parameters.cache.order.step5;if($.isEmptyObject(b)){OrderViewModel.prototype.Back=function(){Routing.SetHash("order","Оформление заказа",{step:4})};OrderViewModel.prototype.ClickDelete=function(){EventDispatcher.DispatchEvent("OrderWidget.step5.delete")};OrderViewModel.prototype.ClickStep1=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})};OrderViewModel.prototype.ClickStep2=function(){Routing.SetHash("order","Оформление заказа",{step:2})};OrderViewModel.prototype.ClickStep3=function(){Routing.SetHash("order","Оформление заказа",{step:3})};OrderViewModel.prototype.ClickStep4=function(){Routing.SetHash("order","Оформление заказа",{step:4})};OrderViewModel.prototype.ClickAddAddress=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"add"})};b=new OrderViewModel();Parameters.cache.order.step5=b}b.AddContent(c);a.Render.Step5(b)}};a.Render={Step1:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}delete b;a.WidgetLoader(true,a.settings.containerFormId)}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step1")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step1();a.Render.Step1(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step1Confirm:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step1Confirm")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step1Confirm();a.Render.Step1Confirm(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step1Profile:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step1Profile")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step1Profile();a.Render.Step1Profile(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step2:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step2")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step2();a.Render.Step2(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step2Form:function(c){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(c,$("#"+a.settings.containerFormId)[0]);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}$("#"+c.cssRegionList).autocomplete({source:function(e,d){a.BaseLoad.Region(c.country().id+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.formalname+" "+g.shortname),region:g}}))}else{$("#"+c.cssRegionList).autocomplete("close");return false}})},select:function(d,e){c.region(e.item.region);c.customRegion(e.item.value);if(e.item.region&&e.item.region.postalcode!=0){c.postCode(e.item.region.postalcode)}else{c.postCode(null)}}});$("#"+c.cssCityList).autocomplete({source:function(e,d){if(c.region()){a.BaseLoad.City(c.country().id+"/"+encodeURIComponent(c.region().regioncode)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),city:g}}))}else{$("#"+c.cssCityList).autocomplete("close");return false}})}},select:function(d,e){c.city(e.item.city);c.customCity(e.item.value);if(e.item.city&&e.item.city.postalcode!=0){c.postCode(e.item.city.postalcode)}else{c.postCode(null)}}});$("#"+c.cssAddress).autocomplete({source:function(e,d){if(c.region()){a.BaseLoad.Street(c.country().id+"/"+encodeURIComponent(c.region().regioncode)+"/"+encodeURIComponent(c.city().aoguid)+"/"+encodeURIComponent(e.term),function(f){if(!f.err){d($.map(f,function(g){return{value:$.trim(g.shortname+". "+g.formalname),street:g}}))}else{$("#"+c.cssAddress).autocomplete("close");return false}})}},select:function(d,e){c.address(e.item.street);c.customAddress(e.item.value);if(e.item.street&&e.item.street.postalcode!=0){c.postCode(e.item.street.postalcode)}else{c.postCode(null)}}});$("#"+c.cssCountryList).change(function(){var d=$("#"+c.cssCountryList+" option:selected").val();$.grep(c.countryList(),function(e){if(e.id==d){c.country(e);c.customRegion(null);c.region(null);c.customCity(null);c.city(null);c.customAddress(null);c.address(null);c.postCode(null)}})});$("#"+c.cssRegionList).bind("textchange",function(e,d){c.customRegion($(this).val());c.customCity(null);c.city(null);c.customAddress(null);c.address(null);c.postCode(null)});$("#"+c.cssCityList).bind("textchange",function(e,d){c.customCity($(this).val());c.customAddress(null);c.address(null);c.postCode(null)});a.WidgetLoader(true,a.settings.containerFormId)}catch(b){a.Exception("Ошибка шаблона ["+a.GetTmplName("step2Form")+"]",b);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step2Form();a.Render.Step2Form(c)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step3:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step3")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step3();a.Render.Step3(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step4:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step4")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step4();a.Render.Step4(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},Step5:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrder=="function"){new AnimateOrder()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("step5")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Step5();a.Render.Step5(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=Config.Containers.registration.length-1;c++){$("#"+Config.Containers.registration[c]).css(a.settings.style)}})}}};var OrderFormStep1ViewModel=function(){var a=this;var b=new AuthenticationViewModel();b.subminEvent("OrderWidget.step1.authentication");a.loginForm=b;a.registrationForm=new RegistrationFormViewModel();a.registrationForm.submitEvent("OrderWidget.step1.registration")};var OrderFormStep2ViewModel=function(){var a=this;a.addressList=ko.observableArray();a.cssAddressList="delivary_address_list";a.checked=ko.observable();a.selectedItem=ko.observable();a.ClickAddAddress=function(){Routing.SetHash("order","Оформление заказа",{step:2,block:"add"})};a.AddContent=function(e,b){if(!e.err){for(var d in e){OrderItemFormStep2ViewModel.prototype=new Widget();var c=new OrderItemFormStep2ViewModel(e[d],a);a.addressList.push(c);if(e[d].is_default=="yes"){b.delivery=c}if(e.length==1){c.ClickItem()}}}};a.HasAddress=function(){var b=false;$.each(a.addressList(),function(c){if(a.addressList()[c].isDefault()){b=true;return false}});return b};a.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var c=Parameters.cache.history;for(var b=0;b<=c.length-1;b++){var d=c.pop();if(d.route!="order"){Routing.SetHash(d.route,d.title,d.data,true);return false}}}else{Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})}};a.Submit=function(){if(a.HasAddress()){EventDispatcher.DispatchEvent("OrderWidget.step2.change",{id:a.checked(),selected:a.selectedItem(),fn:function(){Routing.SetHash("order","Оформление заказа",{step:3})}})}else{EventDispatcher.DispatchEvent("OrderWidget.step2.message")}};a.ClickStep1=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})}};var OrderItemFormStep2ViewModel=function(c,b){var a=this;if(c.id){a.id=c.id}else{a.id=""}a.idCountry=c.id_country;a.country=c.country;a.codeRegion=c.code_region;a.region=c.region;a.codeCity=c.code_city;a.city=c.city;a.postCode=c.post_code;a.address=c.address;a.addressee=c.addressee;a.contactPhone=c.contact_phone;a.list=b.addressList();a.isDefault=ko.observable(true);if(c.is_default=="yes"){a.cssIsDefault=ko.observable("delivery_address_is_default active");Parameters.cache.order.delivery=a;b.checked(a.id)}else{a.isDefault=ko.observable(false);a.cssIsDefault=ko.observable("delivery_address_is_default")}a.Delete=function(){a.Confirm(Config.Order.message.confirmDeleteAddressDelivery,function(){EventDispatcher.DispatchEvent("OrderWidget.step2.delete",{address:a,list:b.addressList})},false)};a.ClickItem=function(){$.each(a.list,function(d){a.list[d].cssIsDefault("delivery_address_is_default");a.list[d].isDefault(false)});a.cssIsDefault("delivery_address_is_default active");a.isDefault(true);b.checked(a.id);b.selectedItem(a);Parameters.cache.order.delivery=a}};var OrderDeliveryFormStep2ViewModel=function(b){var a=this;a.id=ko.observable();a.idCountry=ko.observable();a.country=ko.observable();a.cssCountryList="delivery_country_list";a.errorCountry=ko.observable(null);a.codeRegion=ko.observable();a.region=ko.observable();a.customRegion=ko.observable();a.cssRegionList="delivery_region";a.errorRegion=ko.observable(null);a.codeCity=ko.observable();a.city=ko.observable();a.customCity=ko.observable();a.cssCityList="delivery_city";a.errorCity=ko.observable(null);a.postCode=ko.observable();a.cssPostCode="delivery_post_index";a.errorPostCode=ko.observable(null);a.address=ko.observable();a.customAddress=ko.observable();a.cssAddress="delivery_cssAddress";a.errorAddress=ko.observable(null);a.addressee=ko.observable();a.errorAddressee=ko.observable(null);a.contactPhone=ko.observable();a.cssContactPhone="delivery_contact_phone";a.errorContactPhone=ko.observable(null);a.isDefault=ko.observable();a.countryList=ko.observableArray();a.AddCountryList=function(d){if(d.length>0){for(var c=0;c<=d.length-1;c++){a.countryList.push(new CountryListViewModel(d[c]))}}};a.AddContent=function(c){a.id(c.id);a.idCountry(c.idCountry);a.region({regioncode:c.codeRegion});a.customRegion(c.region);a.city({aoguid:c.codeCity});a.customCity(c.city);a.postCode(c.postCode);a.customAddress(c.address);a.addressee(c.addressee);a.isDefault(c.isDefault());a.contactPhone(c.contactPhone)};a.Submit=function(){if(a.ValidationForm()){EventDispatcher.DispatchEvent("OrderWidget.step2.add",a)}};a.ValidationForm=function(){var c=true;if(!a.PhoneValidation()){c=false}if(!a.UsernameValidation()){c=false}if(!a.CountryValidation()){c=false}if(!a.RegionValidation()){c=false}if(!a.CityValidation()){c=false}if(!a.AddressValidation()){c=false}if(!a.PostIndexValidation()){c=false}return c};a.CountryValidation=function(){if(!a.country()){a.errorCountry(Config.Order.error.country.empty);return false}a.errorCountry(null);return true};a.RegionValidation=function(){if(!a.customRegion()){a.errorRegion(Config.Order.error.region.empty);return false}a.errorRegion(null);return true};a.CityValidation=function(){if(!a.customCity()){a.errorCity(Config.Order.error.city.empty);return false}a.errorCity(null);return true};a.AddressValidation=function(){if(!a.customAddress()){a.errorAddress(Config.Order.error.address.empty);return false}a.errorAddress(null);return true};a.PostIndexValidation=function(){if(!a.postCode()){a.errorPostCode(Config.Order.error.postIndex.empty);return false}a.errorPostCode(null);return true};a.UsernameValidation=function(){if(!a.addressee()){a.errorAddressee(Config.Order.error.addressee.empty);return false}if(a.addressee().length<3){a.errorAddressee(Config.Order.error.addressee.minLength);return false}if(a.addressee().length>40){a.errorAddressee(Config.Order.error.addressee.maxLength);return false}if(!Config.Order.regular.addressee.test(a.addressee())){a.errorAddressee(Config.Registration.error.addressee.regular);return false}a.errorAddressee(null);return true};a.PhoneValidation=function(){if(!a.contactPhone()){a.errorContactPhone(Config.Order.error.phone.empty);return false}if(!Config.Order.regular.phone.test($.trim(a.contactPhone()))){a.errorContactPhone(Config.Order.error.phone.regular);return false}a.errorContactPhone(null);return true};a.Back=function(){Routing.SetHash("order","Оформление заказа",{step:2})};a.ClickStep1=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})};a.ClickStep2=function(){Routing.SetHash("order","Оформление заказа",{step:2})}};var OrderFormStep3ViewModel=function(){var a=this;a.shipping=ko.observableArray();a.checked=ko.observable();a.selectedItem=ko.observable();a.AddShipping=function(d){a.shipping=ko.observableArray();for(var b=0;b<=d.length-1;b++){var c=new OrderItemFormStep3ViewModel(a);c.AddContent(d[b]);a.shipping.push(c);if(d.length==1){c.ClickItem()}}};a.HasShipping=function(){var b=false;$.each(a.shipping(),function(c){if(a.shipping()[c].isActive()){b=true;return false}});return b};a.Back=function(){Routing.SetHash("order","Оформление заказа",{step:2})};a.Submit=function(){if(a.HasShipping()){EventDispatcher.DispatchEvent("OrderWidget.step3.change",{id:a.checked(),selected:a.selectedItem(),fn:function(){Routing.SetHash("order","Оформление заказа",{step:4})}})}else{EventDispatcher.DispatchEvent("OrderWidget.step3.message")}};a.ClickStep1=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})};a.ClickStep2=function(){Routing.SetHash("order","Оформление заказа",{step:2})};a.ClickAddAddress=function(){Routing.SetHash("order","Оформление заказа",{step:2,block:"add"})}};var OrderItemFormStep3ViewModel=function(b){var a=this;a.nameShippingCompany=ko.observable();a.siteShippingCompany=ko.observable();a.logoShippingCompany=ko.observable();a.id=ko.observable();a.nameMethodShipping=ko.observable();a.descMethodShipping=ko.observable();a.costShipping=ko.observable();a.cssActive=ko.observable("shipping_row");a.isActive=ko.observable(false);a.AddContent=function(c){if(c.hasOwnProperty("name_shipping_company")){a.nameShippingCompany(c.name_shipping_company)}if(c.hasOwnProperty("site_shipping_company")){a.siteShippingCompany(c.site_shipping_company)}if(c.hasOwnProperty("logo_shipping_company")){a.logoShippingCompany(c.logo_shipping_company)}if(c.hasOwnProperty("id")){a.id(c.id)}if(c.hasOwnProperty("name_method_shipping")){a.nameMethodShipping(c.name_method_shipping)}if(c.hasOwnProperty("desc_method_shipping")){a.descMethodShipping(c.desc_method_shipping)}if(c.hasOwnProperty("cost_shipping")){a.costShipping(c.cost_shipping)}};a.ClickItem=function(){$.each(b.shipping(),function(c){b.shipping()[c].cssActive("shipping_row");b.shipping()[c].isActive(false)});a.cssActive("shipping_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var OrderFormStep4ViewModel=function(){var a=this;a.payment=ko.observableArray();a.checked=ko.observable();a.selectedItem=ko.observable();a.AddPayment=function(d){a.payment=ko.observableArray();for(var b=0;b<=d.length-1;b++){var c=new OrderItemFormStep4ViewModel(a);c.AddContent(d[b]);a.payment.push(c);if(d.length==1){c.ClickItem()}}};a.HasPayment=function(){var b=false;$.each(a.payment(),function(c){if(a.payment()[c].isActive()){b=true;return false}});return b};a.Back=function(){if($.isEmptyObject(Parameters.cache.order.step1.profile)){var c=Parameters.cache.history;for(var b=0;b<=c.length-1;b++){var d=c.pop();if(d.route!="order"){Routing.SetHash(d.route,d.title,d.data,true);return false}else{Routing.SetHash("order","Оформление заказа",{step:3})}}}else{Routing.SetHash("order","Оформление заказа",{step:3})}};a.Submit=function(){if(a.HasPayment()){EventDispatcher.DispatchEvent("OrderWidget.step4.change",{id:a.checked(),selected:a.selectedItem(),fn:function(){Routing.SetHash("order","Оформление заказа",{step:5})}})}else{EventDispatcher.DispatchEvent("OrderWidget.step4.message")}};a.ClickStep1=function(){Routing.SetHash("order","Оформление заказа",{step:1,block:"profile"})};a.ClickStep2=function(){Routing.SetHash("order","Оформление заказа",{step:2})};a.ClickStep3=function(){Routing.SetHash("order","Оформление заказа",{step:3})};a.ClickAddAddress=function(){Routing.SetHash("order","Оформление заказа",{step:2,block:"add"})}};var OrderItemFormStep4ViewModel=function(b){var a=this;a.id=ko.observable();a.logoPayment=ko.observable();a.descPayment=ko.observable();a.instrPayment=ko.observable();a.namePayment=ko.observable();a.costPayment=ko.observable();a.cssActive=ko.observable("payment_row");a.isActive=ko.observable(false);a.AddContent=function(d,c){a.id(d.id);if(d.hasOwnProperty("logo_payment")){a.logoPayment(d.logo_payment)}if(d.hasOwnProperty("desc_payment")){a.descPayment(d.desc_payment)}if(d.hasOwnProperty("instr_payment")){a.instrPayment(d.instr_payment)}if(d.hasOwnProperty("name_payment")){a.namePayment(d.name_payment)}if(d.hasOwnProperty("cost_payment")){a.costPayment(d.cost_payment)}};a.ClickItem=function(){$.each(b.payment(),function(c){b.payment()[c].cssActive("payment_row");b.payment()[c].isActive(false)});a.cssActive("payment_row active");a.isActive(true);b.checked(a.id());b.selectedItem(a)}};var TestOrder={Init:function(){if(typeof Widget=="function"){OrderWidget.prototype=new Widget();var a=new OrderWidget();a.Init(a)}else{setTimeout(function(){TestOrder.Init()},100)}}};TestOrder.Init();
var OrderListWidget=function(){var a=this;a.widgetName="OrderListWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.currentPage=1;a.settings={containerFormId:null,tmpl:{path:null,id:{list:null,empty:null,detail:null}},animate:null,inputParameters:{},style:null,customContainer:null};a.InitWidget=function(){a.settings.containerFormId=Config.Containers.orderList.widget;a.settings.customContainer=Config.Containers.orderList.customClass;a.settings.tmpl=Config.OrderList.tmpl;a.settings.style=Config.OrderList.style;a.SetInputParameters();a.RegisterEvents();a.CheckRouteListOrder();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/OrderListWidget/);if(b.order){c=b.order}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.order){c=WParameters.order}if(!$.isEmptyObject(c)){if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteListOrder=function(){if(Routing.route=="purchases"){a.WidgetLoader(false);a.BaseLoad.Login(false,false,false,function(b){if(!b.err){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update.Menu();a.Update.Content()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});a.WidgetLoader(true)}})}else{a.WidgetLoader(true)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteListOrder()});EventDispatcher.AddEventListener("OrderList.order.repeat",function(b){a.BaseLoad.RepeatOrder(b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderList.order.repeat",b)})){a.ShowMessage(Config.OrderList.message.orderRepeat,function(){Parameters.cache.orderList={};EventDispatcher.DispatchEvent("OrderList.order.edit",{id:c.id})},false)}})});EventDispatcher.AddEventListener("OrderList.order.return",function(b){a.BaseLoad.ReturnOrder(b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderList.order.return",b)})){a.ShowMessage(Config.OrderList.message.orderReturn,function(){Parameters.cache.orderList={};Routing.SetHash("cart","Моя корзина")},false)}})});EventDispatcher.AddEventListener("OrderList.order.cancel",function(b){a.Confirm(Config.OrderList.message.confirmCancelOrder,function(){a.BaseLoad.CancelOrder(b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderList.order.cancel",b)})){a.ShowMessage(Config.OrderList.message.orderCancel,function(){Parameters.cache.orderList={};b.fn()},false)}})})});EventDispatcher.AddEventListener("OrderList.order.check",function(b){a.BaseLoad.ConfirmOrder(b.id,function(c){if(c.err){a.ShowMessage(c.msg,function(){if(c.err=="Not defined Payment Method"){Routing.SetHash("order","Оформление заказа",{step:4,id:b.id})}else{Routing.SetHash("order","Оформление заказа",{step:2,id:b.id})}})}else{a.ShowMessage(Config.OrderList.message.orderConfirm,function(){Parameters.cache.orderList={};b.fn()})}})});EventDispatcher.AddEventListener("OrderList.order.delete",function(b){a.Confirm(Config.OrderList.message.confirmDeleteOrder,function(){a.BaseLoad.DeleteOrder(b.id,function(c){if(a.QueryError(c,function(){EventDispatcher.DispatchEvent("OrderList.order.delete",b)})){a.ShowMessage(Config.OrderList.message.orderDelete,function(){Parameters.cache.orderList={};b.fn()},false)}})})});EventDispatcher.AddEventListener("OrderList.order.edit",function(b){Routing.SetHash("order","Оформление заказа",{step:2,id:b.id})});EventDispatcher.AddEventListener("OrderList.order.pay",function(b){console.log("pay")})};a.Update={Content:function(){a.WidgetLoader(false);if(Routing.params.block=="list"){a.currentPage=Routing.GetCurrentPage();a.Fill.List()}else{if(Routing.params.block=="detail"&&Routing.params.id){a.BaseLoad.Script("widgets/OrderViewModel-1.0.js",function(){a.Fill.Detail(Routing.params.id)})}}},Menu:function(){a.BaseLoad.Script("widgets/MenuPersonalCabinetWidget-1.1.js",function(){EventDispatcher.DispatchEvent("widget.onload.menuPersonalCabinet",{menu:{},active:""})})}};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerFormId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerFormId).empty().html(b)},List:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("list")).html()).children().hide()},Detail:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("detail")).html()).children().hide()},EmptyList:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerFormId).append($("script#"+a.GetTmplName("empty")).html()).children().hide()}};a.Fill={List:function(){var c=Routing.GetCurrentPage()*Config.Paging.itemsPerPage-Config.Paging.itemsPerPage;var b="/"+c+"/"+Config.Paging.itemsPerPage;a.BaseLoad.OrderList(b,function(e){if(!e.err){a.InsertContainer.List();var d=new OrderListViewModel();d.AddContent(e);a.Render.List(d)}else{console.log("test3");a.InsertContainer.EmptyList();a.Render.EmptyList()}})},Detail:function(b){a.BaseLoad.OrderInfo(b+"/yes",function(d){if(!d.err){if(d.goods.length>0){a.InsertContainer.Detail();var c=Parameters.cache.order.info;if($.isEmptyObject(c)){OrderViewModel.prototype.Back=function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:Routing.GetLastPageNumber()})};OrderViewModel.prototype.ClickEdit=function(){EventDispatcher.DispatchEvent("OrderList.order.edit",{id:b})};OrderViewModel.prototype.ClickDelete=function(){EventDispatcher.DispatchEvent("OrderList.order.delete",{id:b,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:1})}})};OrderViewModel.prototype.ClickCancel=function(){EventDispatcher.DispatchEvent("OrderList.order.cancel",{id:b,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:1})}})};OrderViewModel.prototype.ClickPay=function(){EventDispatcher.DispatchEvent("OrderList.order.pay",{id:b,fn:function(){}})};OrderViewModel.prototype.ClickCheck=function(){EventDispatcher.DispatchEvent("OrderList.order.check",{id:b,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"detail",id:Routing.params.id})}})};OrderViewModel.prototype.ClickRepeat=function(){EventDispatcher.DispatchEvent("OrderList.order.repeat",{id:b})};OrderViewModel.prototype.ClickReturn=function(){EventDispatcher.DispatchEvent("OrderList.order.return",{id:b})};c=new OrderViewModel();Parameters.cache.order.info=c}c.AddContent(d);a.Render.Detail(c)}}else{a.WidgetLoader(true,a.settings.containerFormId);a.ShowMessage(d.msg,function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:1})})}})}};a.Render={List:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrderList=="function"){new AnimateOrderList()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("list")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.List();a.Render.List(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}},EmptyList:function(){a.WidgetLoader(true,a.settings.containerFormId);if(a.settings.animate){a.settings.animate()}},Detail:function(b){if($("#"+a.settings.containerFormId).length>0){try{ko.cleanNode($("#"+a.settings.containerFormId)[0]);ko.applyBindings(b,$("#"+a.settings.containerFormId)[0]);a.WidgetLoader(true,a.settings.containerFormId);if(typeof AnimateOrderList=="function"){new AnimateOrderList()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("detail")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Detail();a.Render.Detail(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerFormId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerFormId+"]");a.WidgetLoader(true,a.settings.containerFormId)}}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){for(var c=0;c<=Config.Containers.registration.length-1;c++){$("#"+Config.Containers.registration[c]).css(a.settings.style)}})}}};var OrderListViewModel=function(){var a=this;a.list=ko.observableArray();a.paging=ko.observableArray();a.count=0;a.AddContent=function(b){a.list=ko.observableArray();$.each(b,function(c){if(c=="count_order"){a.count=b[c]}else{a.list.push(new OrderListDetailViewModel(b[c]))}});a.AddPages()};a.AddPages=function(){var b=function(){Loader.Indicator("OrderListWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.count,{paging:Config.Paging},b)};a.ClickRefresh=function(){Parameters.cache.orderList={};Routing.SetHash("purchases","Мои покупки",{block:"list"})}};var OrderListDetailViewModel=function(b){var a=this;a.id=b.id;a.cssFloatPopup="order_item";a.dateCreate=b.date_create;a.commentBuyer=b.comment_buyer;a.commentOperator=b.comment_operator;a.nameShop=b.name_shop;a.costShipping=b.cost_shipping;a.costPayment=b.cost_payment;a.sellCost=b.sell_cost;a.finalCost=b.final_cost;a.GetNamePay=function(c){if(c=="wait_check"){return"На проверке"}if(c=="wait_pay"){return"Ожидает оплаты"}if(c=="paid"){return"Оплачен"}if(c=="cancel"){return"Отменена"}if(c=="back"){return"Возвращена"}return false};a.GetNameOrder=function(c){if(c=="init"){return"Формируется"}if(c=="new"){return"Новый"}if(c=="process"){return"В просессе обработки"}if(c=="send"){return"Отправлен"}if(c=="delivered"){return"Получен покупателем"}if(c=="cancel"){return"Отменен"}return false};a.statusPay=b.status_pay;a.statusPayName=a.GetNamePay(b.status_pay);a.statusOrder=b.status_order;a.statusOrderName=a.GetNameOrder(b.status_order);a.viewShow=ko.computed(function(){return true},this);a.ClickShow=function(){Routing.SetHash("purchases","Мои покупки",{block:"detail",id:a.id})};a.viewEdit=ko.computed(function(){var c=b.status_order;if(c=="init"){return true}return false},this);a.ClickEdit=function(){EventDispatcher.DispatchEvent("OrderList.order.edit",{id:a.id})};a.viewRepeat=ko.computed(function(){var c=b.status_order;if(c=="delivered"||c=="send"||c=="cancel"){return true}return false},this);a.ClickRepeat=function(){EventDispatcher.DispatchEvent("OrderList.order.repeat",{id:a.id})};a.viewReturn=ko.computed(function(){var c=b.status_order;if(c=="delivered"||c=="send"||c=="cancel"){return true}return false},this);a.ClickReturn=function(){EventDispatcher.DispatchEvent("OrderList.order.return",{id:a.id,fn:function(){Routing.SetHash("purchases","Мои покупки",{id:a.id})}})};a.viewCanсel=ko.computed(function(){var c=b.status_order;if((c=="init"||c=="new")&&b.status_pay!="paid"){return true}return false},this);a.ClickCancel=function(){EventDispatcher.DispatchEvent("OrderList.order.cancel",{id:a.id,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:Routing.GetCurrentPage()})}})};a.viewDelete=ko.computed(function(){var c=b.status_order;if(c=="init"||c=="cancel"){return true}return false},this);a.ClickDelete=function(){EventDispatcher.DispatchEvent("OrderList.order.delete",{id:a.id,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:Routing.GetCurrentPage()})}})};a.viewCheck=ko.computed(function(){var c=b.status_order;if(c=="init"){return true}return false},this);a.ClickCheck=function(){EventDispatcher.DispatchEvent("OrderList.order.check",{id:a.id,fn:function(){Routing.SetHash("purchases","Мои покупки",{block:"list",page:Routing.GetCurrentPage()})}})};a.viewPay=ko.computed(function(){var c=b.status_order;if(c=="new"){return true}return false},this);a.ClickPay=function(){EventDispatcher.DispatchEvent("OrderList.order.pay",{id:a.id,fn:function(){}})};a.emptyTd=ko.observableArray();a.countEmptyTd=function(){var d=0;if(a.viewShow()){d++}if(a.viewEdit()){d++}if(a.viewRepeat()){d++}if(a.viewReturn()){d++}if(a.viewCanсel()){d++}if(a.viewDelete()){d++}for(var c=1;c<=5-d;c++){a.emptyTd.push({id:c})}};a.countEmptyTd()};var TestOrderList={Init:function(){if(typeof Widget=="function"){OrderListWidget.prototype=new Widget();var a=new OrderListWidget();a.Init(a)}else{setTimeout(function(){TestOrderList.Init()},100)}}};TestOrderList.Init();
var MessageWidget=function(){var a=this;a.widgetName="MessageWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={tmpl:{path:null,id:{content:null,empty:null}},animate:null,inputParameters:{},paging:null,style:null,containerId:null,customContainer:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.message.widget;a.settings.customContainer=Config.Containers.message.customClass;a.settings.tmpl=Config.Message.tmpl;a.settings.paging=Config.Paging;a.settings.style=Config.Message.style;a.RegisterEvents();a.SetInputParameters();a.CheckRouteMessage();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/MessageWidget/);if(b.message){c=b.message}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.message){c=WParameters.message}if(!$.isEmptyObject(c)){if(c.defaultCount){a.settings.paging.itemsPerPage=c.defaultCount}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.CheckRouteMessage=function(){if(Routing.route=="messages"){a.BaseLoad.Login(false,false,false,function(b){if(!b.err){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.Update.Menu();a.Update.Content()})}else{Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("login","Авторизация пользователя",{});a.WidgetLoader(true)}})}else{a.WidgetLoader(true)}};a.Update={Content:function(){a.WidgetLoader(false);if(!Routing.params.block){Routing.params.block="topic"}if(Routing.params.block=="topic"){a.Fill.Topic();a.currentPage=Routing.GetCurrentPage()}else{if(Routing.params.block=="list"&&Routing.params.id){a.Fill.List(Routing.params.id)}}},Menu:function(){a.BaseLoad.Script("widgets/MenuPersonalCabinetWidget-1.1.js",function(){EventDispatcher.DispatchEvent("widget.onload.menuPersonalCabinet",{menu:{},active:""})})}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteMessage()});EventDispatcher.AddEventListener("MessageWidget.check.login",function(b){a.BaseLoad.UniqueUser("?username="+encodeURIComponent(b.dstUser()),function(c){if(c.check_username!="on"&&c.check_username!="off"){b.dstUserError(Config.Message.error.username.notFound)}else{b.dstUserError("")}})});EventDispatcher.AddEventListener("MessageWidget.search.message",function(b){a.Fill.Topic(b)});EventDispatcher.AddEventListener("MessageWidget.add.message",function(b){var c=b.modalForm();a.BaseLoad.UniqueUser("?username="+encodeURIComponent(c.dstUser()),function(d){if(d.check_username!="on"&&d.check_username!="off"){c.dstUserError(Config.Message.error.username.notFound)}else{c.dstUserError("");a.BaseLoad.MessageAdd($("form#"+c.cssFormMessage),function(e){if(!e.err){a.Fill.Topic()}else{a.QueryError(e,function(){EventDispatcher.DispatchEvent("MessageWidget.add.message",b)})}})}})});EventDispatcher.AddEventListener("MessageWidget.read.topic",function(c){for(var b=0;b<=c.length-1;b++){a.BaseLoad.TopicRead(c[b].idTopic(),function(d){if(d.result!="ok"){a.QueryError(d,function(){EventDispatcher.DispatchEvent("MessageWidget.read.topic",c)})}else{EventDispatcher.DispatchEvent("widget.change.countMessage")}})}});EventDispatcher.AddEventListener("MessageWidget.delete.topic",function(c){for(var b=0;b<=c.length-1;b++){a.BaseLoad.TopicDelete(c[b].idTopic(),function(d){if(d.result!="ok"){a.ShowMessage(Config.Message.message.error,function(){Routing.SetHash("messages","Сообщения",{})},false)}else{EventDispatcher.DispatchEvent("widget.change.countMessage")}})}});EventDispatcher.AddEventListener("MessageWidget.delete.oneTopic",function(b){a.Confirm(Config.Message.message.confirmDeleteTopic,function(){a.BaseLoad.TopicDelete(b,function(c){if(c.result!="ok"){a.ShowMessage(Config.Message.message.error,function(){},false)}else{EventDispatcher.DispatchEvent("widget.change.countMessage");Routing.SetHash("messages","Сообщения",{})}})})});EventDispatcher.AddEventListener("MessageWidget.read.message",function(c,b){a.BaseLoad.MessageSetRead(c.id(),function(d){if(d.result!="ok"){a.ShowMessage(Config.Message.message.error,function(){Routing.SetHash("messages",b.nameTopic(),{block:"list",id:b.topicId()})},false)}else{EventDispatcher.DispatchEvent("widget.change.countMessage")}})});EventDispatcher.AddEventListener("MessageWidget.unread.message",function(c,b){a.BaseLoad.MessageSetUnread(c.id(),function(d){if(d.result!="ok"){a.ShowMessage(Config.Message.message.error,function(){Routing.SetHash("messages",b.nameTopic(),{block:"list",id:b.topicId()})},false)}else{EventDispatcher.DispatchEvent("widget.change.countMessage")}})});EventDispatcher.AddEventListener("MessageWidget.reply.message",function(b){a.BaseLoad.MessageAdd($("form#"+b.cssFormMessage),function(d){if(!d.err){var c=new MessageViewModel(d,b.topic);b.topic.messages.push(c);c.ClickExpand();b.ClickCancel()}else{a.QueryError(d,function(){EventDispatcher.DispatchEvent("MessageWidget.reply.message",b)},function(){b.ClearForm()})}})});EventDispatcher.AddEventListener("MessageWidget.empty.topic",function(){a.Fill.Topic()})};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Topic:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("topic")).html()).children().hide()},List:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("list")).html()).children().hide()},EmptyList:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName("empty")).html()).children().hide()}};a.Fill={Topic:function(c){var d=(Routing.GetCurrentPage()-1)*a.settings.paging.itemsPerPage;var b=d+"/"+a.settings.paging.itemsPerPage;if(c){b=b+"/"+encodeURIComponent(c)}a.BaseLoad.TopicList(b,function(f){TopicMessageViewModel.prototype=new Widget();var e=new TopicMessageViewModel(a);if(!f.err){e.AddContent(f);if(c){e.searchMessage(c)}a.InsertContainer.Topic();a.Render.Topic(e)}else{var g=Config.Message.message.noResult;if(f.msg){g=f.msg}e.SetErrorMessage(g);if(c){e.searchMessage(c)}a.InsertContainer.EmptyList();a.Render.EmptyList(e)}})},List:function(c){var b="unread";if(Routing.params.info){b=Routing.params.info}a.BaseLoad.TopicInfo(c,b,function(e){var d=new ListMessageViewModel();d.AddContent(e);a.InsertContainer.List();a.Render.List(d)})}};a.Render={Topic:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateMessage=="function"){new AnimateMessage()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("topic")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Topic();a.Render.Topic(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},List:function(f){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(f,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateMessage=="function"){new AnimateMessage()}if(a.settings.animate){a.settings.animate()}var c=f.messages();var b=[];$.each(c,function(e){if(c[e].IsNew()&&!c[e].IsMy()){c[e].ClickExpand();b.push(c[e])}});if(c.length==b.length){$("."+c.cssExpandAll).hide();$("."+c.cssCollapseAll).show()}var d=0;$.each(b,function(e){setTimeout(function(){b[e].InitTimer()},d);d=d+b[e].timeout})}catch(g){a.Exception("Ошибка шаблона ["+a.GetTmplName("list")+"]");if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.List();a.Render.List(f)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},EmptyList:function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateMessage=="function"){new AnimateMessage()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("empty")+"]");if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.EmptyList();a.Render.EmptyList(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}},EmptyWidget:function(){a.WidgetLoader(true,a.settings.containerId)}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var TopicMessageViewModel=function(b){var a=this;a.messageError=ko.observable();a.messages=ko.observableArray();a.paging=null;a.countAll=ko.observable();a.countNewMessage=ko.computed(function(){return Parameters.cache.message.countNewMessage()},this);a.modalForm=ko.observable(new FormMessageViewModel(a));a.cssSelectAll="messagesSelectAll";a.isSelectedAll=ko.observable(false);a.isSelectedAll.subscribe(function(c){ko.utils.arrayForEach(a.messages(),function(d){$("#"+d.cssCheckboxMessage())[0].checked=c;d.isSelected(c)})});a.searchMessage=ko.observable();a.SetErrorMessage=function(c){a.messageError(c)};a.GetSelected=function(){var c=[];ko.utils.arrayForEach(a.messages(),function(d){if(d.isSelected()){c.push(d)}});return c};a.ClickSearch=function(){EventDispatcher.DispatchEvent("MessageWidget.search.message",a.searchMessage())};a.ClickRead=function(){var c=a.GetSelected();var d=[];$.each(c,function(e){if(!c[e].IsMy()&&c[e].IsNew()){c[e].SetStatus("read");d[e]=c[e]}c[e].isSelected(false)});if(d.length>0){EventDispatcher.DispatchEvent("MessageWidget.read.topic",d)}};a.ClickDelete=function(){a.Confirm(Config.Message.message.confirmDeleteSeveralTopic,function(){var c=a.GetSelected();$.each(c,function(d){a.messages.remove(c[d])});EventDispatcher.DispatchEvent("MessageWidget.delete.topic",c);if(a.messages().length==0){EventDispatcher.DispatchEvent("MessageWidget.empty.topic")}})};a.AddContent=function(d){var c=d.shift();a.countAll(c.count_topic);$.each(d,function(e){a.messages.push(a.NewTopic(d[e]))});a.AddPages()};a.AddNewInContent=function(c){a.messages.unshift(a.NewTopic(c))};a.NewTopic=function(c){TopicViewModel.prototype=new Widget();return new TopicViewModel(c,a)};a.AddPages=function(){var c=function(){Loader.Indicator("MessageWidget",false);Routing.UpdateHash({page:this.pageId})};a.paging=Paging.GetPaging(a.countAll(),b.settings,c)};a.ClickSelectAll=function(){var d=$("#"+a.cssSelectAll);var c=d.is(":checked");var e;if(c){d[0].checked=false;e=false}else{d[0].checked=true;e=true}ko.utils.arrayForEach(a.messages(),function(f){$("#"+f.cssCheckboxMessage())[0].checked=e;f.isSelected(e)})}};var TopicViewModel=function(c,b){var a=this;a.id=c.id;a.dateMessage=ko.observable(c.date_message);a.nameTopic=ko.observable(c.name_topic);a.idTopic=ko.observable(c.id_topic);a.srcUser=ko.observable(c.src_user);a.dstUser=ko.observable(c.dst_user);a.logoSrcUser=ko.observable(c.logo_src_user);a.logoDstUser=ko.observable(c.logo_dst_user);a.textMessage=ko.observable(c.text_message);a.status=ko.observable(c.status);a.countMessage=ko.observable(c.count_message);a.copyMail=ko.observable(c.copyMail);a.cssCheckboxMessage=ko.observable("message_item_"+a.id);a.isSelected=ko.observable(false);a.isSelected.subscribe(function(d){var g=b.messages().length;var f=[];for(var e=0;e<=g-1;e++){if(b.messages()[e].isSelected()){f.push(b.messages()[e].id)}}if(f.length<g){$("#"+b.cssSelectAll)[0].checked=false}else{$("#"+b.cssSelectAll)[0].checked=true}$("#"+a.cssCheckboxMessage())[0].checked=d});a.IsMy=ko.computed(function(){var d=Parameters.cache.userInformation;if(d.login==a.srcUser()){return true}return false},this);a.IsNew=ko.computed(function(){if(a.status()=="send"&&!a.IsMy()){return true}return false},this);a.SetStatus=function(d){a.status(d)};a.ClickTopic=function(){Routing.SetHash("messages",a.nameTopic(),{block:"list",id:a.idTopic()})};a.ClickCheckboxMessage=function(f,e){var d=$("#"+f.cssCheckboxMessage());var g=d.is(":checked");if(g==false){d[0].checked=true;a.isSelected(true)}else{d[0].checked=false;a.isSelected(false)}};a.ClickDelete=function(){a.Confirm(Config.Message.message.confirmDeleteSeveralTopic,function(){EventDispatcher.DispatchEvent("MessageWidget.delete.topic",[a]);b.messages.remove(a);if(b.messages().length==0){EventDispatcher.DispatchEvent("MessageWidget.empty.topic")}})};a.FormatDateMessage=function(){var j=a.dateMessage().split(" ");var e=j[0].split("-");var g=j[1].split(":");var f=new Date(e[2],e[1].replace(/^0+/,"")-1,e[0].replace(/^0+/,""),g[0].replace(/^0+/,""),g[1].replace(/^0+/,""),g[2].replace(/^0+/,""));var h=new Date();var i=(h-f)/1000/3600;if(i<24&&f.getDay()==h.getDay()){return f.getHours()+":"+a.PadPithZeroes(f.getMinutes(),2)}return f.getDate()+" "+Config.Base.toStringMonth[f.getMonth()]};a.PadPithZeroes=function(e,d){var f=""+e;while(f.length<d){f="0"+f}return f}};var FormMessageViewModel=function(b){var a=this;a.dstUser=ko.observable();a.dstUserError=ko.observable();a.topicName=ko.observable();a.topicNameError=ko.observable();a.text=ko.observable();a.textError=ko.observable();a.copyMail=ko.observable();a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(a.Validate()){EventDispatcher.DispatchEvent("MessageWidget.add.message",b)}};a.ClickCancel=function(){a.ClearForm()};a.ClearForm=function(){a.dstUser("");a.dstUserError("");a.topicName("");a.topicNameError("");a.text("");a.textError("");a.copyMail("")};a.OnBlurEvent=function(){EventDispatcher.DispatchEvent("MessageWidget.check.login",a)};a.Validate=function(){if(!a.dstUser()){a.dstUserError(Config.Message.error.username.empty)}else{a.dstUserError()}if(!a.topicName()){a.topicNameError(Config.Message.error.topic.empty)}else{a.topicNameError("")}if(!a.text()){a.textError(Config.Message.error.text.empty)}else{a.textError()}if(a.dstUserError()||a.topicNameError()||a.textError()){return false}return true}};var SimpleFormMessageViewModel=function(b){var a=this;a.text=ko.observable();a.textError=ko.observable();a.topic=b;a.copyMail=ko.observable(false);a.cssFormMessage="simple_form_message";a.ClickSend=function(){if(a.Validate()){EventDispatcher.DispatchEvent("MessageWidget.reply.message",a)}};a.ClickCancel=function(){$("#"+a.cssSimpleFormMessage).hide(200);a.ClearForm()};a.ClearForm=function(){a.text("");a.textError("");a.copyMail(false)};a.Validate=function(){if(!a.text()){a.textError(Config.Message.error.text.empty)}else{a.textError()}if(a.textError()){return false}return true}};var ListMessageViewModel=function(){var a=this;a.topicId=ko.observable();a.nameTopic=ko.observable();a.messages=ko.observableArray();a.simpleForm=new SimpleFormMessageViewModel(a);a.cssExpandAll="expand";a.cssCollapseAll="collapse";a.AddContent=function(b){a.topicId(b.id_topic);a.nameTopic(b.name_topic);$.each(b.messages,function(c){a.messages.push(new MessageViewModel(b.messages[c],a))})};a.ClickBack=function(){Routing.SetHash("messages","Сообщения",{block:"topic",page:Routing.GetLastPageNumber()})};a.ClickDelete=function(){EventDispatcher.DispatchEvent("MessageWidget.delete.oneTopic",a.topicId())};a.ClickExpand=function(){var b=[];if($("."+a.cssExpandAll)){$("."+a.cssExpandAll).hide()}if($("."+a.cssCollapseAll)){$("."+a.cssCollapseAll).show()}$.each(a.messages(),function(d){a.messages()[d].ClickExpand();if(a.messages()[d].status()=="send"&&!a.messages()[d].IsMy()){b.push(a.messages()[d])}});var c=0;$.each(b,function(d){setTimeout(function(){b[d].InitTimer()},c);c=c+b[d].timeout})};a.ClickCollapse=function(){$("."+a.cssExpandAll).show();$("."+a.cssCollapseAll).hide();$.each(a.messages(),function(b){a.messages()[b].ClickCollapse();if(a.messages()[b].status()=="send"&&!a.messages()[b].IsMy()){a.messages()[b].stopTime=true}})}};var MessageViewModel=function(c,b){var a=this;a.id=ko.observable(c.id);a.copyMail=ko.observable(c.copy_mail);a.dateMessage=ko.observable(c.date_message);a.dstUser=ko.observable(c.dst_user);a.logoDstUser=ko.observable(c.logo_dst_user);a.srcUser=ko.observable(c.src_user);a.logoSrcUser=ko.observable(c.logo_src_user);a.status=ko.observable(c.status);a.textMessage=ko.observable(c.text_message);a.time=0;a.timeout=c.text_message.length/250*Config.Message.timer;a.stopTime=false;a.IsNew=ko.computed(function(){if(a.status()=="send"){return true}return false},this);a.IsMy=ko.computed(function(){var d=Parameters.cache.userInformation;if(d.login==a.srcUser()){return true}return false},this);a.cssPrevieClear="previe_message_"+a.id();a.cssPrevie=ko.computed(function(){var d=a.cssPrevieClear;if(a.IsNew()){d=d+" new"}return d},this);a.cssFull="full_message_"+a.id();a.isExpand=ko.observable(false);a.SetStatus=function(d){a.status(d)};a.FormatDateMessage=function(){var j=a.dateMessage().split(" ");var e=j[0].split("-");var g=j[1].split(":");var f=new Date(e[2],e[1].replace(/^0+/,"")-1,e[0].replace(/^0+/,""),g[0].replace(/^0+/,""),g[1].replace(/^0+/,""),g[2].replace(/^0+/,""));var h=new Date();var i=(h-f)/1000/3600;if(i<24&&f.getDay()==h.getDay()){return f.getHours()+":"+a.PadPithZeroes(f.getMinutes(),2)}return f.getDate()+" "+Config.Base.toStringMonth[f.getMonth()]};a.PadPithZeroes=function(e,d){var f=""+e;while(f.length<d){f="0"+f}return f};a.ClickReply=function(){var d=b.simpleForm.cssSimpleFormMessage;$("#"+d).show(200);$("#"+d)[0].scrollIntoView(250)};a.ClickRead=function(){if(!a.IsMy()){EventDispatcher.DispatchEvent("MessageWidget.read.message",a,b);a.SetStatus("read")}};a.ClickUnread=function(){EventDispatcher.DispatchEvent("MessageWidget.unread.message",a,b);a.SetStatus("send")};a.ClickExpand=function(){a.isExpand(true);$("."+a.cssPrevieClear).hide();$("."+a.cssFull).show();if(a.status()=="send"){a.time=0;a.stopTime=false;a.InitTimer()}};a.ClickCollapse=function(){a.isExpand(false);$("."+a.cssPrevieClear).show();$("."+a.cssFull).hide();a.stopTime=true};a.InitTimer=function(){setTimeout(function(){if(!a.stopTime){a.time=a.time+1;if(a.time>=a.timeout){a.ClickRead();return true}else{a.InitTimer()}}},1000);return false}};var TestMessage={Init:function(){if(typeof Widget=="function"){MessageWidget.prototype=new Widget();var a=new MessageWidget();a.Init(a)}else{setTimeout(function(){TestMessage.Init()},100)}}};TestMessage.Init();
window.ButtonPaymentWidget=function(){var a=this;a.widgetName="ButtonPaymentWidget";a.version=1.1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={tmpl:{path:null,id:{content:null,skin:null}},animate:null,inputParameters:{},containerId:null,containerButton:null,title:null,skinFromMemory:false,uniq:null,source:null,sourceVal:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.buttonPayment.widget;a.settings.tmpl=Config.ButtonPayment.tmpl;a.settings.title=Config.ButtonPayment.title;a.SetInputParameters();a.RegisterEvents();a.CheckRouteButtonPayment()};a.Loader=function(){Loader.InsertContainer(a.settings.containerButton)};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/ButtonPaymentWidget/);if(b.buttonPayment){c=b.buttonPayment}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.buttonPayment){c=WParameters.buttonPayment}if(!$.isEmptyObject(c)){if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){for(var d in c.tmpl.id){a.settings.tmpl.id[d]=c.tmpl.id[d]}}}if(c.container){a.settings.containerId=c.container}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c};a.SetParameters=function(d){a.settings.containerButton=d.element;var b={};if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.buttonPayment){b=WParameters.buttonPayment}if(!$.isEmptyObject(b)){if(b.tmpl&&b.tmpl.id&&b.tmpl.id.skin){a.settings.skinFromMemory=true}if(b.title){a.settings.title=b.title}if(b.animate){a.settings.animate=b.animate}}a.settings.inputParameters=b;for(var c in d.options.params){switch(c){case"tmpl":if(d.options.params.tmpl){if(d.options.params.tmpl.path){a.settings.tmpl.path=d.options.params.tmpl.path}if(d.options.params.tmpl.id){for(var c in d.options.params.tmpl.id){a.settings.tmpl.id[c]=d.options.params.tmpl.id[c]}}}break;case"title":a.settings.title=d.options.params.title;break;case"uniq":a.settings.uniq=d.options.params.uniq;break;case"orderId":a.settings.source="order";a.settings.sourceVal=d.options.params.orderId;break;case"goodsId":a.settings.source="goods";a.settings.sourceVal=d.options.params.goodsId;break;case"amount":a.settings.source="amount";a.settings.sourceVal=d.options.params.amount;break;default:a.settings.inputParameters[c]=d.options.params[c]}}};a.CheckRouteButtonPayment=function(){if(Routing.route=="payment"){a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();if(Routing.params.orderId){a.GetData.Order(Routing.params.orderId)}if(Routing.params.goodsId){a.GetData.Goods(Routing.params.goodsId)}if(Routing.params.amount){a.GetData.Amount(Routing.params.amount)}})}else{a.WidgetLoader(true)}};a.LoadTmpl=function(){a.BaseLoad.Tmpl(a.settings.tmpl,function(){EventDispatcher.DispatchEvent("ButtonPayment.onload.tmpl_"+a.settings.uniq)})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("ButtonPayment.onload.tmpl_"+a.settings.uniq,function(b){a.InsertContainer.Button();a.Fill.Button()});EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteButtonPayment()});EventDispatcher.AddEventListener("widget.display.ready",function(){if(a.settings.containerButton!=null){a.Loader();a.LoadTmpl()}});EventDispatcher.AddEventListener("ButtonPaymentWidget.form.submit",function(c){a.InsertContainer.Content();var b=[];$.each(c.inData(),function(e){if(c.inData()[e].name()=="MOBILE_PHONE"){b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value().replace(/\s/g,"").replace(/-/g,"")))}else{b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value()))}});var d=b.join("&");if(Routing.params.orderId){d=Routing.params.orderId+"?"+d;a.GetData.Order(d)}if(Routing.params.goodsId){d=Routing.params.goodsId+"?"+d;a.GetData.Goods(d)}if(Routing.params.amount){d=Routing.params.amount+"/"+Parameters.shopId+"?"+d;a.GetData.Amount(d)}})};a.GetData={Order:function(b){a.BaseLoad.InvoicesOrder(b,function(c){if(a.QueryError(c,function(){a.GetData.Order(b)},function(){Routing.SetHash("default","Домашняя",{})})){a.Fill.Content(c)}})},Goods:function(b){a.BaseLoad.InvoicesGoods(b,function(c){a.Fill.Content(c)})},Amount:function(b){a.BaseLoad.InvoicesAmount(b+"/"+Parameters.shopId,function(c){a.Fill.Content(c)})}};a.InsertContainer={EmptyWidget:function(b){var c=$(b).find(a.SelectCustomContent().join(", ")).clone();$(b).empty().html(c)},Button:function(){a.InsertContainer.EmptyWidget(a.settings.containerButton);$(a.settings.containerButton).html($("script#"+a.GetTmplName("skin")).html())},Content:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.widget);$("#"+a.settings.containerId.widget).html($("script#"+a.GetTmplName("content")).html()).hide()}};a.Fill={Button:function(){var b=new ButtonPaymentViewModel(a.settings);a.Render.Button(b)},Content:function(d){var c=new PaymentViewModel();var e=[];var b=d.pay_form.hidden_field;$.each(b,function(f){e.push(b[f].name+"="+encodeURIComponent(b[f].value))});if(e){$.cookie(Config.Base.cookie.orderId,e.join("&"))}c.AddContent(d);a.Render.Content(c)}};a.Render={Button:function(b){try{ko.cleanNode($(a.settings.containerButton).children()[0]);ko.applyBindings(b,$(a.settings.containerButton).children()[0]);if(typeof AnimateButtonPayment=="function"){new AnimateButtonPayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("skin")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Button();a.Render.Button(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true)}}},Content:function(b){if($("#"+a.settings.containerId.widget).length>0){ko.cleanNode($("#"+a.settings.containerId.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.widget)[0]);$.each(b.inData(),function(c){if(b.inData()[c].mask()){$("#"+b.inData()[c].cssField()).mask(b.inData()[c].mask(),{placeholder:"_"})}});$("#"+a.settings.containerId.widget).show();a.WidgetLoader(true,a.settings.containerId.widget);if(typeof AnimateButtonPayment=="function"){new AnimateButtonPayment()}if(a.settings.animate){a.settings.animate()}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}}}};var ButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];if(b.source=="order"){Routing.SetHash("payment","Оплата заказа",{orderId:b.sourceVal})}if(b.source=="goods"){Routing.SetHash("payment","Оплата заказа",{goodsId:b.sourceVal})}if(b.source=="amount"){Routing.SetHash("payment","Оплата заказа",{amount:b.sourceVal})}}};var PaymentViewModel=function(){var a=this;a.instruction=ko.observable();a.cssInstruction="instructtion_print_block";a.outData=ko.observableArray();a.inData=ko.observableArray();a.isInData=ko.observable(false);a.cssInDataForm="in_data_block";a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm=ko.observable(false);a.urlInvoice=ko.observable();a.cssInvoice="invoice_print_block";a.Print=function(c){var b=window.open();b.document.write($("#"+c).html());b.print();b.close()};a.ClickPrintInstruction=function(){a.Print(a.cssInstruction)};a.ClickPrintInvoice=function(){a.Print(a.cssInvoice)};a.Back=function(){var b=Parameters.cache.lastPage;if(b.route=="payment"||!b.route){Routing.SetHash("purchases","Заказ № "+Routing.params.orderId,{block:"detail",id:697})}else{Routing.SetHash(b.route,b.title,b.data)}};a.ClickPay=function(){$("#"+a.payForm.cssPayForm).submit()};a.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};a.ClickSubmit=function(){if(a.ValidationFrom()){EventDispatcher.DispatchEvent("ButtonPaymentWidget.form.submit",a)}};a.ValidationFrom=function(){var b=true;$.each(a.inData(),function(c){if(!a.inData()[c].ValidateField()){b=false;return false}});return b};a.AddContent=function(b){a.instruction(null);if(b.hasOwnProperty("instruction")){a.instruction(b.instruction)}a.outData=ko.observableArray();if(b.hasOwnProperty("out_data")){$.each(b.out_data,function(c){a.outData.push(b.out_data[c])})}a.isPayForm(false);a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm(false);if(b.hasOwnProperty("pay_form")){a.isPayForm(true);a.payForm.action(b.pay_form.action);a.payForm.method(b.pay_form.method);if(b.pay_form.hasOwnProperty("new_window")&&b.pay_form.new_window=="yes"){a.payForm.target("_blank")}$.each(b.pay_form.hidden_field,function(c){var d=b.pay_form.hidden_field[c];if(!b.pay_form.hidden_field[c].hasOwnProperty("value")){d.value=""}a.payForm.field.push(b.pay_form.hidden_field[c])})}a.isInData(false);a.inData=ko.observableArray();if(b.hasOwnProperty("in_data")){a.isInData(true);$.each(b.in_data,function(c){var d=new PaymentFieldViewModel();d.AddContent(b.in_data[c]);a.inData.push(d)})}a.urlInvoice(null);if(b.hasOwnProperty("url_invoice")){a.urlInvoice(b.url_invoice)}}};var PaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var TestButtonPayment={Init:function(){if(typeof Widget=="function"){window.ButtonPaymentWidget.prototype=new Widget();var a=new window.ButtonPaymentWidget();a.settings.uniq=EventDispatcher.GetUUID();a.Init(a)}else{setTimeout(function(){TestButtonPayment.Init()},100)}}};TestButtonPayment.Init();
var StandalonePaymentWidget=function(){var a=this;a.widgetName="StandalonePaymentWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:{button:"",content:""},customContainer:null,tmpl:{path:null,id:{button:null,paymentList:null,content:null,error:null}},animate:null,inputParameters:{},containerButton:null,title:null,uniq:null,source:null,sourceVal:null,idGoods:null,goodsInfo:null,count:1,showCount:true,idShop:null,amount:null,showAmount:true,uid:null,idShopPartner:null,mailUser:null,idMethodPayment:null,paymentInfo:{},paymentList:false,description:"",showButton:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.standalonePayment;a.settings.tmpl=Config.StandalonePayment.tmpl;a.settings.title=Config.StandalonePayment.title;a.settings.showButton=Config.StandalonePayment.showButton;a.CheckRouteStandalonePayment()};a.SetParameters=function(e){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/StandalonePaymentWidget/);if(b.standalonePayment){c=b.standalonePayment}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.standalonePayment){c=WParameters.standalonePayment}if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Input parameters",c)}if(!$.isEmptyObject(c)){if(c.title){a.settings.title=c.title}if(c.idGoods){a.settings.idGoods=c.idGoods;a.settings.showAmount=false}else{if(Routing.params.idGoods){a.settings.idGoods=Routing.params.idGoods;a.settings.showAmount=false}else{a.settings.idShop=JSSettings.shopId;a.settings.showCount=false}}if(c.count){a.settings.count=c.count;a.settings.showCount=false}else{if(Routing.params.count){a.settings.count=Routing.params.count;a.settings.showCount=false}}if(c.amount){a.settings.amount=c.amount;a.settings.showAmount=false}else{if(Routing.params.amount){a.settings.amount=Routing.params.amount;a.settings.showAmount=false}}if(c.uid){a.settings.uid=c.uid}if(Routing.params.uid){a.settings.uid=Routing.params.uid}if(c.idShopPartner){a.settings.idShopPartner=c.idShopPartner}if(Routing.params.idShopPartner){a.settings.idShopPartner=Routing.params.idShopPartner}if(c.mailUser){a.settings.mailUser=c.mailUser}else{if(Routing.params.mailUser){a.settings.mailUser=Routing.params.mailUser}}if(c.idMethodPayment){a.settings.idMethodPayment=c.idMethodPayment}if(Routing.params.idMethodPayment){a.settings.idMethodPayment=Routing.params.idMethodPayment}if(c.description){a.settings.description=c.description}if(Routing.params.description){a.settings.description=Routing.params.description}if(c.showButton){a.settings.showButton=c.showButton}if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){for(var d in c.tmpl.id){a.settings.tmpl.id[d]=c.tmpl.id[d]}}}if(c.container){if(c.container){for(var d in c.container){a.settings.containerId[d]=c.container[d]}}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c;if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Result settings",a.settings)}};a.CheckRouteStandalonePayment=function(){a.SetParameters();a.RegisterEvents();a.BaseLoad.Tmpl(a.settings.tmpl,function(){if(Routing.route=="standalone_payment"){if(a.settings.idGoods!=null){a.BaseLoad.GoodsInfo(a.settings.idGoods,"1000000",function(b){a.settings.goodsInfo=b;if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}})}if(a.settings.idShop!=null){a.GetData.Service()}}else{if(a.settings.showButton&&Routing.route!="status_payment"){a.InsertContainer.Button();a.Fill.Button()}else{a.WidgetLoader(true)}}})};a.RegisterEvents=function(){EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.select",function(b){a.settings.idMethodPayment=b.idMethodPayment();a.settings.paymentInfo=b.paymentInfo;a.settings.mailUser=b.mailUser();if(a.settings.idGoods!=null){a.settings.count=b.count();if(a.settings.idShopPartner==null){a.GetData.Goods()}if(a.settings.idShopPartner!=null){a.GetData.PartnerGoods()}}if(a.settings.idShop!=null){a.settings.amount=b.amount();a.GetData.Service()}});EventDispatcher.AddEventListener("StandalonePaymentWidget.back",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("widget.change.route",function(){a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.clear",function(){a.settings.idMethodPayment=null;a.settings.mailUser=null;a.CheckRouteStandalonePayment()});EventDispatcher.AddEventListener("StandalonePaymentWidget.form.submit",function(c){a.InsertContainer.Content();var b=[];$.each(c.inData(),function(e){if(c.inData()[e].name()=="MOBILE_PHONE"){b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value().replace(/\s/g,"").replace(/-/g,"")))}else{b.push(c.inData()[e].name()+"="+encodeURIComponent(c.inData()[e].value()))}});var d=b.join("&");if(Routing.params.orderId){d=Routing.params.orderId+"?"+d;a.GetData.Order(d)}if(Routing.params.goodsId){d=Routing.params.goodsId+"?"+d;a.GetData.Goods(d)}if(Routing.params.amount){d=Routing.params.amount+"/"+Parameters.shopId+"?"+d;a.GetData.Amount(d)}})};a.GetData={Price:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})},Goods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesGoods(c,function(d){a.Fill.PaymentList(d)})},PartnerGoods:function(){var c=a.settings.idGoods+"/";if(a.settings.count){c=c+a.settings.count+"/"}if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesPartnerGoods(c,function(d){a.Fill.PaymentList(d)})},Service:function(){var c=a.settings.idShop+"/";if(a.settings.idShopPartner){c=c+a.settings.idShopPartner+"/"}var b=[];if(a.settings.amount){b.push("amount="+a.settings.amount)}if(a.settings.uid){b.push("uid="+a.settings.uid)}if(a.settings.mailUser){b.push("mailUser="+a.settings.mailUser)}if(a.settings.idMethodPayment){b.push("idMethodPayment="+a.settings.idMethodPayment)}b.push("description="+a.settings.description);if(b.length>0){c=c+"?"+b.join("&")}a.BaseLoad.InvoicesService(c,function(d){a.Fill.PaymentList(d)})}};a.InsertContainer={EmptyWidget:function(b){var c=$(b).find(a.SelectCustomContent().join(", ")).clone();$(b).empty().html(c)},Button:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);$("#"+a.settings.containerId.button.widget).html($("script#"+a.GetTmplName("button")).html())},PaymentList:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("paymentList")).html())},Content:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("content")).html()).hide()},Error:function(){a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);$("#"+a.settings.containerId.content.widget).html($("script#"+a.GetTmplName("error")).html()).hide()}};a.Fill={Button:function(){var b=new StandaloneButtonPaymentViewModel(a.settings);a.Render.Button(b)},PaymentList:function(c){if(c.hasOwnProperty("err")){a.InsertContainer.Error();a.Fill.Error(c)}else{if(!c.hasOwnProperty("pay_form")){var b=new StandalonePaymentListViewModel(a.settings);b.error.base("");b.show.errorBase(false);if(c){$.each(c,function(d){a.settings.paymentList=true;b.payments.push(new StandalonePaymentItemViewModel(c[d],b))})}a.InsertContainer.PaymentList();a.Render.PaymentList(b)}else{a.InsertContainer.Content();a.Fill.Content(c)}}},Content:function(e){var d=new StandalonePaymentViewModel(a.settings);var f=[];var c={};if(e.pay_form){c=e.pay_form.hidden_field}var b=null;$.each(c,function(g){f.push(c[g].name+"="+encodeURIComponent(c[g].value));if(c[g].name=="PKP_ID_ORDER"){b=c[g].value}});if(b){$.cookie(Config.Base.cookie.orderId,"PKP_ID_ORDER="+b)}else{if(f){$.cookie(Config.Base.cookie.orderId,f.join("&"))}}d.paymentInfo=a.settings.paymentInfo;d.AddContent(e);a.Render.Content(d)},Error:function(c){var b=new StandalonePaymentErrorViewModel(c,a.settings);a.Render.Error(b)}};a.Render={Button:function(b){if($("#"+a.settings.containerId.button.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.button.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.button.widget)[0]);a.WidgetLoader(true,a.settings.containerId.button.widget);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("button")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Button();a.Render.Button(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.button.widget);a.WidgetLoader(true,a.settings.containerId.button.widget)}}}else{a.WidgetLoader(true)}},PaymentList:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}$("#"+b.cssAmount).bind("textchange",function(e,d){var f=$(this).val();b.amount(f);a.settings.amount=f;setTimeout(function(){if(f==a.settings.amount){a.GetData.Price()}},500)});$("#"+b.cssCount).bind("textchange",function(e,d){b.count($(this).val())})}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("paymentList")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.PaymentList()();a.Render.PaymentList(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Content:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$.each(b.inData(),function(d){if(b.inData()[d].mask()){$("#"+b.inData()[d].cssField()).mask(b.inData()[d].mask(),{placeholder:"_"})}});$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("content")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}},Error:function(b){if($("#"+a.settings.containerId.content.widget).length>0){try{ko.cleanNode($("#"+a.settings.containerId.content.widget)[0]);ko.applyBindings(b,$("#"+a.settings.containerId.content.widget)[0]);$("#"+a.settings.containerId.content.widget).show();a.WidgetLoader(true);if(typeof AnimateStandalonePayment=="function"){new AnimateStandalonePayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName("error")+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render.Content(b)})}else{a.InsertContainer.EmptyWidget("#"+a.settings.containerId.content.widget);a.WidgetLoader(true,a.settings.containerId.content.widget)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId.content.widget+"]");a.WidgetLoader(true)}}}};var StandaloneButtonPaymentViewModel=function(b){var a=this;a.title=b.title;a.ClickPay=function(){Parameters.cache.lastPage=Parameters.cache.history[Parameters.cache.history.length-1];Routing.SetHash("standalone_payment","Оплата товара",{})}};var StandalonePaymentListViewModel=function(c){var b=this;b.isGoodsId=ko.observable();b.title=ko.observable();b.count=ko.observable();b.amount=ko.observable();b.formatAmount=ko.observable();b.cssAmount="pokupo_amount";b.cssCount="pokupo_count";if(c.idGoods){b.title(c.goodsInfo.main.chort_name);b.count(c.count);var d=c.count*parseInt(c.goodsInfo.main.sell_end_cost);b.amount(d);b.isGoodsId(true)}if(c.idShop){b.title(c.description);b.amount(c.amount);b.isGoodsId(false)}if(b.amount()){b.formatAmount=parseFloat(b.amount()).toFixed(2)}b.mailUser=ko.observable();b.idMethodPayment=ko.observable(c.idMethodPayment);b.payments=ko.observableArray();b.error={base:ko.observable(),email:ko.observable(),count:ko.observable(),amount:ko.observable()};b.show={errorBase:ko.observable(false),errorEmail:ko.observable(false),errorCount:ko.observable(false),errorAmount:ko.observable(false),showCount:ko.observable(c.showCount),showAmount:ko.observable(c.showAmount)};b.Cookie={Set:{UserEmail:function(e){$.cookie(Config.Base.cookie.userEmail,e)}},Get:{UserEmail:function(){return $.cookie(Config.Base.cookie.userEmail)}}};var a="";if(c.mailUser){a=c.mailUser}else{if(b.Cookie.Get.UserEmail()){a=b.Cookie.Get.UserEmail()}}b.mailUser(a);b.CountValidation=function(){if(!b.count()){b.error.count(Config.StandalonePayment.Error.count.empty);b.show.errorCount(true);return false}if(parseInt(b.count())!=b.count()){b.error.count(Config.StandalonePayment.Error.count.integer);b.show.errorCount(true);return false}b.error.count(null);b.show.errorCount(false);return true};b.AmountValidation=function(){if(!b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.empty);b.show.errorAmount(true);return false}if(isNaN(b.amount())){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}if(parseFloat(b.amount())!=b.amount()){b.error.amount(Config.StandalonePayment.Error.coast.integer);b.show.errorAmount(true);return false}b.error.amount(null);b.show.errorAmount(false);return true};b.EmailValidation=function(){if(!b.mailUser()){b.error.email(Config.StandalonePayment.Error.email.empty);b.show.errorEmail(true);return false}if(b.mailUser().length>64){b.error.email(Config.StandalonePayment.Error.email.maxLength);b.show.errorEmail(true);return false}if(!Config.StandalonePayment.regular.email.test(b.mailUser())){b.error.email(Config.StandalonePayment.Error.email.regular);b.show.errorEmail(true);return false}b.error.email(null);b.show.errorEmail(false);return true};EventDispatcher.AddEventListener("StandalonePaymentWidget.payment.validate",function(e){var f=true;if(!b.EmailValidation()){f=false}if(!b.CountValidation()&&b.isGoodsId()){f=false}if(!b.AmountValidation()&&!b.isGoodsId()){f=false}if(f){b.Cookie.Set.UserEmail(b.mailUser());e.callback()}})};var StandalonePaymentItemViewModel=function(c,b){var a=this;a.id=c.id;a.namePayment=c.name_payment;a.costPayment=c.cost_payment;a.descPayment=c.desc_payment;a.instrPayment=c.instr_payment;a.logoPayment=c.logo_payment;a.timePayment=c.time_payment;a.itog=ko.computed(function(){var d=(b.amount()?parseFloat(b.amount()):0)+(a.costPayment?parseFloat(a.costPayment):0);if(d==0||isNaN(d)){return 0}else{d=d.toFixed(2);return d}},this);a.errorEmail=ko.observable();a.Click={SelectPayment:function(){b.idMethodPayment(a.id);b.paymentInfo=a;EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.validate",{data:b,callback:function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.select",b)}})}}};var StandalonePaymentViewModel=function(b){var a=this;a.paymentInfo={};a.showPaymentInfo=false;a.instruction=ko.observable();a.cssInstruction="instructtion_print_block";a.idMethodPayment=b.idMethodPayment;a.outData=ko.observableArray();a.inData=ko.observableArray();a.isInData=ko.observable(false);a.cssInDataForm="in_data_block";a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm=ko.observable(false);a.urlInvoice=ko.observable();a.cssInvoice="invoice_print_block";a.Print=function(d){var c=window.open();c.document.write($("#"+d).html());c.print();c.close()};a.ClickPrintInstruction=function(){a.Print(a.cssInstruction)};a.ClickPrintInvoice=function(){a.Print(a.cssInvoice)};a.Back=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.back")};a.ClickPay=function(){$("#"+a.payForm.cssPayForm).submit()};a.ClickRefresh=function(){Routing.SetHash(Routing.route,Routing.title,Routing.params,true)};a.ClickSubmit=function(){if(a.ValidationFrom()){EventDispatcher.DispatchEvent("StandalonePaymentWidget.form.submit",a)}};a.ValidationFrom=function(){var c=true;$.each(a.inData(),function(d){if(!a.inData()[d].ValidateField()){c=false;return false}});return c};a.AddContent=function(c){a.instruction(null);if(c.hasOwnProperty("instruction")){a.instruction(c.instruction)}a.outData=ko.observableArray();if(c.hasOwnProperty("out_data")){$.each(c.out_data,function(d){a.outData.push(c.out_data[d])})}a.isPayForm(false);a.payForm={action:ko.observable(),method:ko.observable(),target:ko.observable("_self"),cssPayForm:"payform_block",field:ko.observableArray()};a.isPayForm(false);if(c.hasOwnProperty("pay_form")){a.isPayForm(true);a.payForm.action(c.pay_form.action);a.payForm.method(c.pay_form.method);if(c.pay_form.hasOwnProperty("new_window")&&c.pay_form.new_window=="yes"){a.payForm.target("_blank")}$.each(c.pay_form.hidden_field,function(d){var e={name:"",value:""};if(c.pay_form.hidden_field[d].name){e.name=c.pay_form.hidden_field[d].name}if(c.pay_form.hidden_field[d].value){e.value=c.pay_form.hidden_field[d].value}a.payForm.field.push(e)})}a.isInData(false);a.inData=ko.observableArray();if(c.hasOwnProperty("in_data")){a.isInData(true);$.each(c.in_data,function(d){var e=new StandalonePaymentFieldViewModel();e.AddContent(c.in_data[d]);a.inData.push(e)})}a.urlInvoice(null);if(c.hasOwnProperty("url_invoice")){a.urlInvoice(c.url_invoice)}if(!$.isEmptyObject(a.paymentInfo)){a.showPaymentInfo=true}}};var StandalonePaymentFieldViewModel=function(){var a=this;a.label=ko.observable();a.help=ko.observable();a.error=ko.observable();a.name=ko.observable();a.value=ko.observable();a.required=ko.observable(false);a.typeField=ko.observable();a.listSelect=ko.observableArray();a.regExp=ko.observable();a.mask=ko.observable();a.maxlength=ko.observable();a.cssField=ko.observable();a.AddContent=function(b){if(b.hasOwnProperty("label")){a.label(b.label)}if(b.hasOwnProperty("help")){a.help(b.help)}if(b.hasOwnProperty("error")){a.error(b.error)}if(b.hasOwnProperty("name")){a.name(b.name);a.cssField("field_"+b.name)}if(b.hasOwnProperty("value")){a.value(b.value)}if(b.hasOwnProperty("required")){if(b.required=="yes"){a.required(true)}}if(b.hasOwnProperty("type_field")){a.typeField(b.type_field)}if(b.hasOwnProperty("list_select")){$.each(b.list_select,function(c){a.listSelect.push(b.list_select[c])})}if(b.hasOwnProperty("reg_exp")){a.regExp(b.reg_exp)}if(b.hasOwnProperty("mask")){a.mask(b.mask)}if(b.hasOwnProperty("maxlength")){a.maxlength(b.maxlength)}};a.ValidateField=function(){if(a.required()){if(!a.value()){a.error(Config.ButtonPayment.Error.required);return false}}if(a.maxlength()){if(a.value().length>a.maxlength()){a.error(Config.ButtonPayment.Error.maxlength.replace("%s%",a.maxlength()));return false}}return true}};var StandalonePaymentErrorViewModel=function(c,b){var a=this;a.code=c.err;a.message=c.msg;a.hasPaymentList=b.paymentList;a.ClickClearPayment=function(){EventDispatcher.DispatchEvent("StandalonePaymentWidget.payment.clear")}};var TestStandalonePayment={Init:function(){if(typeof Widget=="function"){StandalonePaymentWidget.prototype=new Widget();var a=new StandalonePaymentWidget();a.Init(a)}else{setTimeout(function(){TestStandalonePayment.Init()},100)}}};TestStandalonePayment.Init();
var StatusPaymentWidget=function(){var a=this;a.widgetName="StatusPaymentWidget";a.version=1;a.minWidgetVersion=1;a.maxWidgetVersion=2;a.minTmplVersion=1;a.maxTmplVersion=2;a.settings={containerId:null,customContainer:null,tmpl:{path:null,id:null},inputParameters:{},style:null};a.InitWidget=function(){a.settings.containerId=Config.Containers.statusPayment.widget;a.settings.customContainer=Config.Containers.statusPayment.customClass;a.settings.tmpl=Config.StatusPayment.tmpl;a.settings.style=Config.StatusPayment.style;a.RegisterEvents();a.CheckRouteSearch();a.SetInputParameters();a.SetPosition()};a.SetInputParameters=function(){var c={};if(Config.Base.sourceParameters=="string"){var b=JSCore.ParserInputParameters(/StatusPaymentWidget/);if(b.statusPayment){c=b.statusPayment}}if(Config.Base.sourceParameters=="object"&&typeof WParameters!=="undefined"&&WParameters.statusPayment){c=WParameters.statusPayment}if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Input parameters",c)}if(!$.isEmptyObject(c)){if(c.tmpl){if(c.tmpl.path){a.settings.tmpl.path=c.tmpl.path}if(c.tmpl.id){a.settings.tmpl.id=c.tmpl.id}}if(c.animate){a.settings.animate=c.animate}}a.settings.inputParameters=c;if(JSSettings.dev){Logger.Console.VarDump(a.widgetName,"Result settings",a.settings)}a.settings.inputParameters=c};a.InsertContainer={EmptyWidget:function(){var b=$("#"+a.settings.containerId).find(a.SelectCustomContent().join(", ")).clone();$("#"+a.settings.containerId).empty().html(b)},Content:function(){a.InsertContainer.EmptyWidget();$("#"+a.settings.containerId).append($("script#"+a.GetTmplName()).html()).children().hide()}};a.CheckRouteSearch=function(){if(Routing.route=="status_payment"){var b=$.cookie(Config.Base.cookie.orderId);var d=$.cookie(Config.Base.cookie.userEmail);if(b){var c=Routing.params.name;var e=c+"/?"+b+"&mailUser="+d;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.BaseLoad.StatusPayment(e,function(f){a.Fill(f)})})}else{a.WidgetLoader(true,a.settings.containerId);alert("Нет параметров инициализации!")}}else{a.WidgetLoader(true,a.settings.containerId)}};a.RegisterEvents=function(){EventDispatcher.AddEventListener("widget.change.route",function(b){a.CheckRouteSearch()})};a.Fill=function(b){var c=new StatusPaymentViewModel(b);a.InsertContainer.Content();a.Render(c)};a.Render=function(b){if($("#"+a.settings.containerId).length>0){try{ko.cleanNode($("#"+a.settings.containerId)[0]);ko.applyBindings(b,$("#"+a.settings.containerId)[0]);a.WidgetLoader(true,a.settings.containerId);if(typeof AnimateStatusPayment=="function"){new AnimateStatusPayment()}if(a.settings.animate){a.settings.animate()}}catch(c){a.Exception("Ошибка шаблона ["+a.GetTmplName()+"]",c);if(a.settings.tmpl.custom){delete a.settings.tmpl.custom;a.BaseLoad.Tmpl(a.settings.tmpl,function(){a.InsertContainer.Content();a.Render(b)})}else{a.InsertContainer.EmptyWidget();a.WidgetLoader(true,a.settings.containerId)}}}else{a.Exception("Ошибка. Не найден контейнер ["+a.settings.containerId+"]");a.WidgetLoader(true,a.settings.containerId)}};a.SetPosition=function(){if(a.settings.inputParameters.position=="absolute"){for(var b in a.settings.inputParameters){if(a.settings.style[b]){a.settings.style[b]=a.settings.inputParameters[b]}}$().ready(function(){if($("#"+a.settings.containerId).length>0){$("#"+a.settings.containerId).css(a.settings.style)}})}}};var StatusPaymentViewModel=function(b){var a=this;a.orderId=b.id_order;a.instruction=b.instruction;a.cssOrder="order_print_block";a.status=b.status;a.isPaid=ko.observable(false);if(a.status=="paid"){a.isPaid(true)}a.isWait=ko.observable(false);if(a.status=="wait_pay"){a.isWait(true)}a.isCancel=ko.observable(false);if(a.status=="cancel"){a.isCancel(true)}a.isBack=ko.observable(false);if(a.status=="back"){a.isBack(true)}a.outData=ko.observableArray();$.each(b.out_data,function(c){a.outData.push(new StatusPaymentParametersViewModel(b.out_data[c]))});a.egoods=[];if(b.egoods){$.each(b.egoods,function(c){if(!b.egoods[c]["max_upload"]){b.egoods[c]["max_upload"]=false}if(!b.egoods[c]["expiration"]){b.egoods[c]["expiration"]=false}});a.egoods=b.egoods}a.Print=function(d){var c=window.open();c.document.write($("#"+d).html());c.print();c.close()};a.ClickPrintOrder=function(){a.Print(a.cssOrder)}};var StatusPaymentParametersViewModel=function(b){var a=this;a.label=ko.observable(b.label);a.value=ko.observable(b.value);a.help=ko.observable(b.help)};var TestStatusPayment={Init:function(){if(typeof Widget=="function"){StatusPaymentWidget.prototype=new Widget();var a=new StatusPaymentWidget();a.Init(a)}else{setTimeout(function(){TestStatusPayment.Init()},100)}}};TestStatusPayment.Init();